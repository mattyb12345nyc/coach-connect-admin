{"version":3,"file":"customgpt-widget.js","mappings":"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","sources":["webpack://CustomGPTWidget/webpack/universalModuleDefinition","webpack://CustomGPTWidget/webpack/runtime/chunk loaded","webpack://CustomGPTWidget/webpack/runtime/create fake namespace object","webpack://CustomGPTWidget/webpack/runtime/load script","webpack://CustomGPTWidget/./src/lib/logger.ts","webpack://CustomGPTWidget/./src/lib/streaming/handler.ts","webpack://CustomGPTWidget/./src/lib/analytics/usage-tracker.ts","webpack://CustomGPTWidget/./src/lib/voice/themes/PerformanceOptimizations.ts","webpack://CustomGPTWidget/./src/lib/voice/themes/BaseTheme.ts","webpack://CustomGPTWidget/./src/lib/voice/themes/IVoiceTheme.ts","webpack://CustomGPTWidget/./src/components/ui/button.tsx","webpack://CustomGPTWidget/./src/components/ui/avatar.tsx","webpack://CustomGPTWidget/./src/components/chat/CitationList.tsx","webpack://CustomGPTWidget/./src/components/chat/MessageDetails.tsx","webpack://CustomGPTWidget/./src/components/chat/Message.tsx","webpack://CustomGPTWidget/./src/contexts/DemoModeContext.tsx","webpack://CustomGPTWidget/./src/components/ui/loading.tsx","webpack://CustomGPTWidget/./src/components/ui/tooltip.tsx","webpack://CustomGPTWidget/./src/components/voice/SpeechToTextButton.tsx","webpack://CustomGPTWidget/./src/components/voice/AnimatedVoiceIcon.tsx","webpack://CustomGPTWidget/./src/components/ui/dropdown-menu.tsx","webpack://CustomGPTWidget/./src/components/chat/ChatInput.tsx","webpack://CustomGPTWidget/./src/components/chat/TypingIndicator.tsx","webpack://CustomGPTWidget/./src/components/chat/AgentSelector.tsx","webpack://CustomGPTWidget/./src/hooks/useMediaQuery.ts","webpack://CustomGPTWidget/./src/widget/isolated-toast.tsx","webpack://CustomGPTWidget/./src/widget/WidgetContext.tsx","webpack://CustomGPTWidget/./src/widget/debug-utils.ts","webpack://CustomGPTWidget/./src/store/widget-stores/messages.ts","webpack://CustomGPTWidget/./src/store/widget-stores/conversations.ts","webpack://CustomGPTWidget/./src/store/widget-stores/agents.ts","webpack://CustomGPTWidget/./src/widget/WidgetStoreContext.tsx","webpack://CustomGPTWidget/./src/components/chat/CitationDetailsModal.tsx","webpack://CustomGPTWidget/./src/components/chat/CitationFilePreview.tsx","webpack://CustomGPTWidget/./src/components/chat/MessageErrorDisplay.tsx","webpack://CustomGPTWidget/./src/hooks/useWidgetStore.ts","webpack://CustomGPTWidget/./src/lib/voice/themes/ThemeManager.ts","webpack://CustomGPTWidget/./src/components/voice/Canvas.tsx","webpack://CustomGPTWidget/./src/lib/utils/throttle.ts","webpack://CustomGPTWidget/./src/store/voice-settings.ts","webpack://CustomGPTWidget/./src/components/voice/VoiceSettings.tsx","webpack://CustomGPTWidget/./src/lib/voice/streaming-tts.ts","webpack://CustomGPTWidget/./src/lib/voice/speech-manager.ts","webpack://CustomGPTWidget/./src/lib/voice/utils.ts","webpack://CustomGPTWidget/./src/lib/crypto.ts","webpack://CustomGPTWidget/./src/store/demo.ts","webpack://CustomGPTWidget/./src/components/voice/VoiceModal.tsx","webpack://CustomGPTWidget/./src/components/ui/input.tsx","webpack://CustomGPTWidget/./src/components/ui/card.tsx","webpack://CustomGPTWidget/./src/components/demo/FreeTrialLimitModal.tsx","webpack://CustomGPTWidget/./src/components/chat/ChatContainer.tsx","webpack://CustomGPTWidget/./src/components/ui/select.tsx","webpack://CustomGPTWidget/./src/components/ui/simple-select.tsx","webpack://CustomGPTWidget/./src/components/chat/ConversationDetailsModal.tsx","webpack://CustomGPTWidget/./src/components/chat/DeleteConversationDialog.tsx","webpack://CustomGPTWidget/./src/components/chat/ConversationSidebar.tsx","webpack://CustomGPTWidget/./src/components/chat/ChatLayout.tsx","webpack://CustomGPTWidget/./src/widget/FloatingButton.tsx","webpack://CustomGPTWidget/./src/widget/index.tsx","webpack://CustomGPTWidget/./node_modules/onnxruntime-web/dist/ sync","webpack://CustomGPTWidget/./src/store/chat-settings.ts","webpack://CustomGPTWidget/./src/lib/constants/error-messages.ts","webpack://CustomGPTWidget/./src/lib/api/proxy-client.ts","webpack://CustomGPTWidget/./src/lib/api/direct-client.ts","webpack://CustomGPTWidget/./src/lib/api/client.ts","webpack://CustomGPTWidget/./src/lib/utils.ts","webpack://CustomGPTWidget/./src/lib/constants/demo-limits.ts","webpack://CustomGPTWidget/./src/store/agents.ts","webpack://CustomGPTWidget/./src/lib/voice/utils/math.ts","webpack://CustomGPTWidget/./src/lib/voice/themes/DefaultTheme.ts","webpack://CustomGPTWidget/./src/lib/voice/utils/performance.ts","webpack://CustomGPTWidget/./src/lib/theme.ts","webpack://CustomGPTWidget/./src/store/config.ts","webpack://CustomGPTWidget/./src/store/ui.ts","webpack://CustomGPTWidget/./src/store/analytics.ts","webpack://CustomGPTWidget/./src/store/pages.ts","webpack://CustomGPTWidget/./src/store/sources.ts","webpack://CustomGPTWidget/./src/store/profile.ts","webpack://CustomGPTWidget/./src/store/project-settings.ts","webpack://CustomGPTWidget/./src/store/licenses.ts","webpack://CustomGPTWidget/./src/store/index.ts","webpack://CustomGPTWidget/./src/store/messages.ts","webpack://CustomGPTWidget/./src/store/conversations.ts","webpack://CustomGPTWidget/webpack/bootstrap","webpack://CustomGPTWidget/webpack/runtime/compat get default export","webpack://CustomGPTWidget/webpack/runtime/define property getters","webpack://CustomGPTWidget/webpack/runtime/ensure chunk","webpack://CustomGPTWidget/webpack/runtime/get javascript chunk filename","webpack://CustomGPTWidget/webpack/runtime/get mini-css chunk filename","webpack://CustomGPTWidget/webpack/runtime/global","webpack://CustomGPTWidget/webpack/runtime/hasOwnProperty shorthand","webpack://CustomGPTWidget/webpack/runtime/make namespace object","webpack://CustomGPTWidget/webpack/runtime/publicPath","webpack://CustomGPTWidget/webpack/runtime/jsonp chunk loading","webpack://CustomGPTWidget/webpack/runtime/nonce","webpack://CustomGPTWidget/webpack/startup"],"sourcesContent":["(function webpackUniversalModuleDefinition(root, factory) {\n\tif(typeof exports === 'object' && typeof module === 'object')\n\t\tmodule.exports = factory();\n\telse if(typeof define === 'function' && define.amd)\n\t\tdefine(\"CustomGPTWidget\", [], factory);\n\telse if(typeof exports === 'object')\n\t\texports[\"CustomGPTWidget\"] = factory();\n\telse\n\t\troot[\"CustomGPTWidget\"] = factory();\n})(typeof self !== 'undefined' ? self : this, () => {\nreturn ","var deferred = [];\n__webpack_require__.O = (result, chunkIds, fn, priority) => {\n\tif(chunkIds) {\n\t\tpriority = priority || 0;\n\t\tfor(var i = deferred.length; i > 0 && deferred[i - 1][2] > priority; i--) deferred[i] = deferred[i - 1];\n\t\tdeferred[i] = [chunkIds, fn, priority];\n\t\treturn;\n\t}\n\tvar notFulfilled = Infinity;\n\tfor (var i = 0; i < deferred.length; i++) {\n\t\tvar [chunkIds, fn, priority] = deferred[i];\n\t\tvar fulfilled = true;\n\t\tfor (var j = 0; j < chunkIds.length; j++) {\n\t\t\tif ((priority & 1 === 0 || notFulfilled >= priority) && Object.keys(__webpack_require__.O).every((key) => (__webpack_require__.O[key](chunkIds[j])))) {\n\t\t\t\tchunkIds.splice(j--, 1);\n\t\t\t} else {\n\t\t\t\tfulfilled = false;\n\t\t\t\tif(priority < notFulfilled) notFulfilled = priority;\n\t\t\t}\n\t\t}\n\t\tif(fulfilled) {\n\t\t\tdeferred.splice(i--, 1)\n\t\t\tvar r = fn();\n\t\t\tif (r !== undefined) result = r;\n\t\t}\n\t}\n\treturn result;\n};","var getProto = Object.getPrototypeOf ? (obj) => (Object.getPrototypeOf(obj)) : (obj) => (obj.__proto__);\nvar leafPrototypes;\n// create a fake namespace object\n// mode & 1: value is a module id, require it\n// mode & 2: merge all properties of value into the ns\n// mode & 4: return value when already ns object\n// mode & 16: return value when it's Promise-like\n// mode & 8|1: behave like require\n__webpack_require__.t = function(value, mode) {\n\tif(mode & 1) value = this(value);\n\tif(mode & 8) return value;\n\tif(typeof value === 'object' && value) {\n\t\tif((mode & 4) && value.__esModule) return value;\n\t\tif((mode & 16) && typeof value.then === 'function') return value;\n\t}\n\tvar ns = Object.create(null);\n\t__webpack_require__.r(ns);\n\tvar def = {};\n\tleafPrototypes = leafPrototypes || [null, getProto({}), getProto([]), getProto(getProto)];\n\tfor(var current = mode & 2 && value; (typeof current == 'object' || typeof current == 'function') && !~leafPrototypes.indexOf(current); current = getProto(current)) {\n\t\tObject.getOwnPropertyNames(current).forEach((key) => (def[key] = () => (value[key])));\n\t}\n\tdef['default'] = () => (value);\n\t__webpack_require__.d(ns, def);\n\treturn ns;\n};","var inProgress = {};\nvar dataWebpackPrefix = \"CustomGPTWidget:\";\n// loadScript function to load a script via script tag\n__webpack_require__.l = (url, done, key, chunkId) => {\n\tif(inProgress[url]) { inProgress[url].push(done); return; }\n\tvar script, needAttach;\n\tif(key !== undefined) {\n\t\tvar scripts = document.getElementsByTagName(\"script\");\n\t\tfor(var i = 0; i < scripts.length; i++) {\n\t\t\tvar s = scripts[i];\n\t\t\tif(s.getAttribute(\"src\") == url || s.getAttribute(\"data-webpack\") == dataWebpackPrefix + key) { script = s; break; }\n\t\t}\n\t}\n\tif(!script) {\n\t\tneedAttach = true;\n\t\tscript = document.createElement('script');\n\n\t\tscript.charset = 'utf-8';\n\t\tif (__webpack_require__.nc) {\n\t\t\tscript.setAttribute(\"nonce\", __webpack_require__.nc);\n\t\t}\n\t\tscript.setAttribute(\"data-webpack\", dataWebpackPrefix + key);\n\n\t\tscript.src = url;\n\t}\n\tinProgress[url] = [done];\n\tvar onScriptComplete = (prev, event) => {\n\t\t// avoid mem leaks in IE.\n\t\tscript.onerror = script.onload = null;\n\t\tclearTimeout(timeout);\n\t\tvar doneFns = inProgress[url];\n\t\tdelete inProgress[url];\n\t\tscript.parentNode && script.parentNode.removeChild(script);\n\t\tdoneFns && doneFns.forEach((fn) => (fn(event)));\n\t\tif(prev) return prev(event);\n\t}\n\tvar timeout = setTimeout(onScriptComplete.bind(null, undefined, { type: 'timeout', target: script }), 120000);\n\tscript.onerror = onScriptComplete.bind(null, script.onerror);\n\tscript.onload = onScriptComplete.bind(null, script.onload);\n\tneedAttach && document.head.appendChild(script);\n};","export type LogLevel = 'info' | 'warn' | 'error';\n\nexport interface LogEntry {\n  timestamp: string;\n  level: LogLevel;\n  category: string;\n  message: string;\n  data?: any;\n  error?: any;\n  stack?: string;\n}\n\nclass Logger {\n  private static instance: Logger;\n  private isClient: boolean;\n  private logs: LogEntry[] = [];\n\n  private constructor() {\n    this.isClient = typeof window !== 'undefined';\n  }\n\n  static getInstance(): Logger {\n    if (!Logger.instance) {\n      Logger.instance = new Logger();\n    }\n    return Logger.instance;\n  }\n\n  private formatMessage(entry: LogEntry): string {\n    const { timestamp, level, category, message, data, error, stack } = entry;\n    let formatted = `[${timestamp}] [${level.toUpperCase()}] [${category}] ${message}`;\n    \n    if (data) {\n      formatted += `\\nData: ${JSON.stringify(data, null, 2)}`;\n    }\n    \n    if (error) {\n      formatted += `\\nError: ${error.message || error}`;\n      if (stack) {\n        formatted += `\\nStack: ${stack}`;\n      }\n    }\n    \n    return formatted;\n  }\n\n  private writeToFile(entry: LogEntry) {\n    // File writing is handled by the API route\n    // This method is kept for compatibility\n  }\n\n  private log(level: LogLevel, category: string, message: string, data?: any, error?: any) {\n    const entry: LogEntry = {\n      timestamp: new Date().toISOString(),\n      level,\n      category,\n      message,\n      data,\n      error: error ? { message: error.message, code: error.code, status: error.status } : undefined,\n      stack: error?.stack,\n    };\n\n    // Store in memory for client access\n    this.logs.push(entry);\n    if (this.logs.length > 1000) {\n      this.logs = this.logs.slice(-500); // Keep last 500 entries\n    }\n\n    // Console output with styling\n    const styles = {\n      info: 'color: #3B82F6; font-weight: normal;',\n      warn: 'color: #F59E0B; font-weight: bold;',\n      error: 'color: #EF4444; font-weight: bold;',\n    };\n\n    const prefix = `[${entry.timestamp.split('T')[1].split('.')[0]}] [${category}]`;\n    \n    if (this.isClient) {\n      console.log(`%c${prefix} ${message}`, styles[level]);\n      if (data) console.log('Data:', data);\n      if (error) console.error('Error:', error);\n    } else {\n      const colorCodes = {\n        info: '\\x1b[36m',\n        warn: '\\x1b[33m',\n        error: '\\x1b[31m',\n      };\n      const reset = '\\x1b[0m';\n      console.log(`${colorCodes[level]}${prefix}${reset} ${message}`);\n      if (data) console.log('Data:', data);\n      if (error) console.error('Error:', error);\n    }\n\n    // Server logging removed - all logs go to console only\n  }\n\n\n  info(category: string, message: string, data?: any) {\n    this.log('info', category, message, data);\n  }\n\n  warn(category: string, message: string, data?: any) {\n    this.log('warn', category, message, data);\n  }\n\n  error(category: string, message: string, error?: any, data?: any) {\n    this.log('error', category, message, data, error);\n  }\n\n  getLogs(): LogEntry[] {\n    return this.logs;\n  }\n\n  clearLogs() {\n    this.logs = [];\n  }\n\n  // API-specific logging helpers\n  apiRequest(endpoint: string, method: string, data?: any) {\n    this.info('API_REQUEST', `${method} ${endpoint}`, data);\n  }\n\n  apiResponse(endpoint: string, status: number, data?: any) {\n    const level = status >= 400 ? 'error' : 'info';\n    this.log(level, 'API_RESPONSE', `${endpoint} - Status: ${status}`, data);\n  }\n\n  apiError(endpoint: string, error: any) {\n    this.error('API_ERROR', `Failed request to ${endpoint}`, error);\n  }\n\n  // Auth-specific logging\n  authCheck(message: string, data?: any) {\n    this.info('AUTH', message, data);\n  }\n\n  authError(message: string, error?: any) {\n    this.error('AUTH_ERROR', message, error);\n  }\n\n  // Navigation logging\n  navigation(route: string, params?: any) {\n    this.info('NAVIGATION', `Navigating to ${route}`, params);\n  }\n\n  // Store operation logging\n  storeAction(store: string, action: string, data?: any) {\n    this.info('STORE', `${store}.${action}`, data);\n  }\n}\n\nexport const logger = Logger.getInstance();","import type { StreamChunk, Citation, StreamCallbacks, StreamHandlerConfig } from '@/types';\nimport { parseStreamChunk } from '@/lib/utils';\n\nexport interface StreamMessage {\n  id: string;\n  content: string;\n  citations: Citation[];\n  isComplete: boolean;\n}\n\nexport class StreamHandler {\n  private config: Required<StreamHandlerConfig>;\n  private abortController: AbortController | null = null;\n  private currentMessage: StreamMessage | null = null;\n\n  constructor(config: StreamHandlerConfig = {}) {\n    this.config = {\n      timeout: config.timeout || 60000,\n      retryAttempts: config.retryAttempts || 3,\n      retryDelay: config.retryDelay || 1000,\n    };\n  }\n\n  /**\n   * Process a streaming response\n   */\n  async processStream(\n    stream: ReadableStream,\n    callbacks: StreamCallbacks\n  ): Promise<StreamMessage> {\n    this.abortController = new AbortController();\n    this.currentMessage = {\n      id: this.generateId(),\n      content: '',\n      citations: [],\n      isComplete: false,\n    };\n\n    const reader = stream.getReader();\n    const decoder = new TextDecoder();\n    let buffer = '';\n\n    // Set timeout\n    const timeoutId = setTimeout(() => {\n      this.cancel();\n      callbacks.onError?.(new Error('Stream timeout'));\n    }, this.config.timeout);\n\n    try {\n      while (true) {\n        const { done, value } = await reader.read();\n\n        if (done) {\n          this.currentMessage.isComplete = true;\n          callbacks.onComplete?.();\n          break;\n        }\n\n        // Decode chunk and add to buffer\n        buffer += decoder.decode(value, { stream: true });\n        \n        // Process complete lines\n        const lines = buffer.split('\\n');\n        buffer = lines.pop() || ''; // Keep incomplete line in buffer\n\n        for (const line of lines) {\n          if (line.trim()) {\n            await this.processLine(line, callbacks);\n          }\n        }\n      }\n    } catch (error) {\n      if (error instanceof Error && error.name === 'AbortError') {\n        callbacks.onError?.(new Error('Stream cancelled'));\n      } else {\n        callbacks.onError?.(error instanceof Error ? error : new Error('Unknown streaming error'));\n      }\n    } finally {\n      clearTimeout(timeoutId);\n      reader.releaseLock();\n      this.abortController = null;\n    }\n\n    return this.currentMessage;\n  }\n\n  /**\n   * Process a single line from the stream\n   */\n  private async processLine(line: string, callbacks: StreamCallbacks): Promise<void> {\n    const chunk = parseStreamChunk(line);\n    \n    if (!chunk || !this.currentMessage) return;\n\n    switch (chunk.type) {\n      case 'content':\n        if (chunk.content) {\n          this.currentMessage.content += chunk.content;\n          callbacks.onChunk?.(chunk.content);\n        }\n        break;\n\n      case 'citation':\n        if (chunk.citations) {\n          this.currentMessage.citations.push(...chunk.citations);\n          chunk.citations.forEach((citation: Citation) => {\n            callbacks.onCitation?.(citation);\n          });\n        }\n        break;\n\n      case 'done':\n        this.currentMessage.isComplete = true;\n        callbacks.onComplete?.();\n        return;\n\n      case 'error':\n        callbacks.onError?.(new Error(chunk.error || 'Stream error'));\n        return;\n\n      default:\n        // Handle unknown chunk types gracefully\n        console.warn('Unknown stream chunk type:', chunk.type);\n    }\n  }\n\n  /**\n   * Cancel the current stream\n   */\n  cancel(): void {\n    if (this.abortController) {\n      this.abortController.abort();\n    }\n  }\n\n  /**\n   * Get current message state\n   */\n  getCurrentMessage(): StreamMessage | null {\n    return this.currentMessage;\n  }\n\n  /**\n   * Check if streaming is active\n   */\n  isStreaming(): boolean {\n    return this.abortController !== null && this.currentMessage !== null && !this.currentMessage.isComplete;\n  }\n\n  private generateId(): string {\n    return Math.random().toString(36).substring(2) + Date.now().toString(36);\n  }\n}\n\n/**\n * Utility class for managing multiple concurrent streams\n */\nexport class StreamManager {\n  private streams: Map<string, StreamHandler> = new Map();\n  private maxConcurrentStreams: number;\n\n  constructor(maxConcurrentStreams: number = 3) {\n    this.maxConcurrentStreams = maxConcurrentStreams;\n  }\n\n  /**\n   * Start a new stream\n   */\n  async startStream(\n    streamId: string,\n    stream: ReadableStream,\n    callbacks: StreamCallbacks,\n    config?: StreamHandlerConfig\n  ): Promise<StreamMessage> {\n    // Check if we're at the concurrent limit\n    if (this.streams.size >= this.maxConcurrentStreams) {\n      throw new Error(`Maximum concurrent streams (${this.maxConcurrentStreams}) reached`);\n    }\n\n    // Cancel existing stream with same ID if it exists\n    if (this.streams.has(streamId)) {\n      this.cancelStream(streamId);\n    }\n\n    const handler = new StreamHandler(config);\n    this.streams.set(streamId, handler);\n\n    try {\n      const result = await handler.processStream(stream, {\n        ...callbacks,\n        onComplete: () => {\n          this.streams.delete(streamId);\n          callbacks.onComplete?.();\n        },\n        onError: (error) => {\n          this.streams.delete(streamId);\n          callbacks.onError?.(error);\n        },\n      });\n\n      return result;\n    } catch (error) {\n      this.streams.delete(streamId);\n      throw error;\n    }\n  }\n\n  /**\n   * Cancel a specific stream\n   */\n  cancelStream(streamId: string): void {\n    const handler = this.streams.get(streamId);\n    if (handler) {\n      handler.cancel();\n      this.streams.delete(streamId);\n    }\n  }\n\n  /**\n   * Cancel all active streams\n   */\n  cancelAllStreams(): void {\n    this.streams.forEach(handler => handler.cancel());\n    this.streams.clear();\n  }\n\n  /**\n   * Get active stream IDs\n   */\n  getActiveStreams(): string[] {\n    return Array.from(this.streams.keys());\n  }\n\n  /**\n   * Get stream status\n   */\n  getStreamStatus(streamId: string): {\n    exists: boolean;\n    isStreaming: boolean;\n    message: StreamMessage | null;\n  } {\n    const handler = this.streams.get(streamId);\n    \n    if (!handler) {\n      return { exists: false, isStreaming: false, message: null };\n    }\n\n    return {\n      exists: true,\n      isStreaming: handler.isStreaming(),\n      message: handler.getCurrentMessage(),\n    };\n  }\n\n  /**\n   * Get number of active streams\n   */\n  getActiveStreamCount(): number {\n    return this.streams.size;\n  }\n}\n\n/**\n * Parse Server-Sent Events (SSE) data\n */\nexport function parseSSEData(data: string): any | null {\n  try {\n    if (data === '[DONE]') {\n      return { type: 'done' };\n    }\n    \n    const parsed = JSON.parse(data);\n    \n    // Handle different response formats\n    if (parsed.choices && parsed.choices[0]) {\n      const choice = parsed.choices[0];\n      \n      if (choice.delta && choice.delta.content) {\n        return {\n          type: 'content',\n          content: choice.delta.content,\n        };\n      }\n      \n      if (choice.message && choice.message.content) {\n        return {\n          type: 'content',\n          content: choice.message.content,\n        };\n      }\n    }\n    \n    // Handle CustomGPT format\n    if (parsed.content) {\n      return {\n        type: 'content',\n        content: parsed.content,\n        citations: parsed.citations || [],\n      };\n    }\n    \n    return parsed;\n  } catch (error) {\n    console.error('Failed to parse SSE data:', error);\n    return null;\n  }\n}\n\n\n/**\n * Validate stream format\n */\nexport function validateStreamChunk(chunk: any): boolean {\n  if (!chunk || typeof chunk !== 'object') {\n    return false;\n  }\n\n  // Must have a type\n  if (!chunk.type || typeof chunk.type !== 'string') {\n    return false;\n  }\n\n  // Validate specific types\n  switch (chunk.type) {\n    case 'content':\n      return typeof chunk.content === 'string';\n    \n    case 'citation':\n      return Array.isArray(chunk.citations);\n    \n    case 'done':\n    case 'error':\n      return true;\n    \n    default:\n      return false;\n  }\n}\n\n// Global stream manager instance\nexport const globalStreamManager = new StreamManager();","/**\n * Usage Analytics Tracker\n * \n * Tracks usage across different deployment modes and sends analytics\n * to your backend for monitoring and analysis.\n */\n\nimport { DEMO_STORAGE_KEYS } from '@/lib/constants/demo-limits';\n\nexport interface UsageEvent {\n  // Event identification\n  eventType: 'api_call' | 'session_start' | 'session_end' | 'limit_reached' | 'error';\n  eventName: string;\n  timestamp: number;\n  \n  // Deployment information\n  deploymentMode: 'production' | 'demo';\n  demoType?: 'free-trial' | 'user-api-key' | 'none';\n  \n  // Session information\n  sessionId?: string;\n  userId?: string; // If available from your auth system\n  \n  // Request details\n  endpoint?: string;\n  method?: string;\n  statusCode?: number;\n  \n  // Usage metrics\n  projectCount?: number;\n  conversationCount?: number;\n  messageCount?: number;\n  \n  // Client information\n  clientVersion?: string;\n  userAgent?: string;\n  referrer?: string;\n  \n  // Additional metadata\n  metadata?: Record<string, any>;\n}\n\nclass UsageTracker {\n  private static instance: UsageTracker;\n  private analyticsEndpoint: string = process.env.NEXT_PUBLIC_ANALYTICS_ENDPOINT || '/api/analytics';\n  private batchSize: number = 10;\n  private flushInterval: number = 30000; // 30 seconds\n  private eventQueue: UsageEvent[] = [];\n  private flushTimer: NodeJS.Timeout | null = null;\n\n  private constructor() {\n    // Start flush timer\n    this.startFlushTimer();\n  }\n\n  static getInstance(): UsageTracker {\n    if (!UsageTracker.instance) {\n      UsageTracker.instance = new UsageTracker();\n    }\n    return UsageTracker.instance;\n  }\n\n  /**\n   * Track a usage event\n   */\n  track(event: Partial<UsageEvent>): void {\n    const fullEvent: UsageEvent = {\n      eventType: event.eventType || 'api_call',\n      eventName: event.eventName || 'unknown',\n      timestamp: Date.now(),\n      deploymentMode: this.getDeploymentMode(),\n      demoType: this.getDemoType(),\n      sessionId: this.getSessionId(),\n      clientVersion: process.env.NEXT_PUBLIC_APP_VERSION || '1.0.0',\n      userAgent: typeof window !== 'undefined' ? window.navigator.userAgent : undefined,\n      referrer: typeof window !== 'undefined' ? document.referrer : undefined,\n      ...event\n    };\n\n    this.eventQueue.push(fullEvent);\n\n    // Flush if batch size reached\n    if (this.eventQueue.length >= this.batchSize) {\n      this.flush();\n    }\n  }\n\n  /**\n   * Track API call\n   */\n  trackApiCall(endpoint: string, method: string, statusCode?: number): void {\n    this.track({\n      eventType: 'api_call',\n      eventName: `${method} ${endpoint}`,\n      endpoint,\n      method,\n      statusCode\n    });\n  }\n\n  /**\n   * Track session start\n   */\n  trackSessionStart(): void {\n    this.track({\n      eventType: 'session_start',\n      eventName: 'session_started',\n      metadata: {\n        mode: this.getDemoType() || 'production'\n      }\n    });\n  }\n\n  /**\n   * Track session end\n   */\n  trackSessionEnd(reason?: string): void {\n    this.track({\n      eventType: 'session_end',\n      eventName: 'session_ended',\n      metadata: {\n        reason,\n        mode: this.getDemoType() || 'production'\n      }\n    });\n  }\n\n  /**\n   * Track limit reached\n   */\n  trackLimitReached(limitType: 'projects' | 'conversations' | 'messages'): void {\n    this.track({\n      eventType: 'limit_reached',\n      eventName: `${limitType}_limit_reached`,\n      metadata: {\n        limitType\n      }\n    });\n  }\n\n  /**\n   * Track error\n   */\n  trackError(error: string, context?: any): void {\n    this.track({\n      eventType: 'error',\n      eventName: 'error_occurred',\n      metadata: {\n        error,\n        context\n      }\n    });\n  }\n\n  /**\n   * Get deployment mode\n   */\n  private getDeploymentMode(): 'production' | 'demo' {\n    if (typeof window === 'undefined') return 'production';\n    \n    const mode = localStorage.getItem(DEMO_STORAGE_KEYS.DEPLOYMENT_MODE);\n    return mode === 'demo' ? 'demo' : 'production';\n  }\n\n  /**\n   * Get demo type\n   */\n  private getDemoType(): 'free-trial' | 'user-api-key' | 'none' {\n    if (typeof window === 'undefined') return 'none';\n    \n    const deploymentMode = localStorage.getItem(DEMO_STORAGE_KEYS.DEPLOYMENT_MODE);\n    if (deploymentMode !== 'demo') return 'none';\n    \n    const isFreeTrialMode = localStorage.getItem(DEMO_STORAGE_KEYS.FREE_TRIAL_MODE) === 'true';\n    return isFreeTrialMode ? 'free-trial' : 'user-api-key';\n  }\n\n  /**\n   * Get session ID\n   */\n  private getSessionId(): string | undefined {\n    if (typeof window === 'undefined') return undefined;\n    \n    // Try to get from session storage (for free trial)\n    const sessionData = sessionStorage.getItem(DEMO_STORAGE_KEYS.FREE_TRIAL_SESSION);\n    if (sessionData) {\n      try {\n        const session = JSON.parse(sessionData);\n        return session.sessionId;\n      } catch (e) {\n        // Ignore parse errors\n      }\n    }\n    \n    // Try to get from regular demo session\n    const demoSession = sessionStorage.getItem(DEMO_STORAGE_KEYS.DEMO_SESSION);\n    if (demoSession) {\n      try {\n        const session = JSON.parse(demoSession);\n        return session.sessionId;\n      } catch (e) {\n        // Ignore parse errors\n      }\n    }\n    \n    return undefined;\n  }\n\n  /**\n   * Start flush timer\n   */\n  private startFlushTimer(): void {\n    if (this.flushTimer) {\n      clearInterval(this.flushTimer);\n    }\n    \n    this.flushTimer = setInterval(() => {\n      if (this.eventQueue.length > 0) {\n        this.flush();\n      }\n    }, this.flushInterval);\n  }\n\n  /**\n   * Flush events to backend\n   */\n  private async flush(): Promise<void> {\n    if (this.eventQueue.length === 0) return;\n    \n    const events = [...this.eventQueue];\n    this.eventQueue = [];\n    \n    try {\n      // If you have a custom analytics endpoint, send the data there\n      if (process.env.NEXT_PUBLIC_ANALYTICS_ENDPOINT) {\n        await fetch(this.analyticsEndpoint, {\n          method: 'POST',\n          headers: {\n            'Content-Type': 'application/json',\n          },\n          body: JSON.stringify({ events }),\n        });\n      } else {\n        // Otherwise, just log to console for now\n        console.log('[UsageTracker] Analytics events:', events);\n      }\n    } catch (error) {\n      console.error('[UsageTracker] Failed to send analytics:', error);\n      // Re-queue events on failure\n      this.eventQueue.unshift(...events);\n    }\n  }\n\n  /**\n   * Force flush all pending events\n   */\n  async forceFlush(): Promise<void> {\n    await this.flush();\n  }\n}\n\n// Export singleton instance\nexport const usageTracker = UsageTracker.getInstance();\n\n// Add event listeners for automatic tracking\nif (typeof window !== 'undefined') {\n  // Track page visibility changes\n  document.addEventListener('visibilitychange', () => {\n    if (document.hidden) {\n      usageTracker.forceFlush();\n    }\n  });\n  \n  // Track before unload\n  window.addEventListener('beforeunload', () => {\n    usageTracker.forceFlush();\n  });\n}","/**\n * Performance Optimizations for Voice Themes\n * \n * Advanced performance optimizations including LOD system, render culling,\n * batch rendering, and memory management for maintaining 30+ FPS on all devices.\n */\n\nimport { PerformanceMetrics, DeviceCapabilities } from '../utils/performance';\n\nexport interface LODSettings {\n  level: 0 | 1 | 2; // 0 = high, 1 = medium, 2 = low\n  particleReduction: number; // 0-1, percentage reduction\n  effectsDisabled: boolean;\n  glowDisabled: boolean;\n  simplifiedRendering: boolean;\n  skipFrames: number; // Skip every N frames for heavy operations\n}\n\nexport interface CullingBounds {\n  left: number;\n  right: number;\n  top: number;\n  bottom: number;\n  near?: number;\n  far?: number;\n}\n\nexport interface RenderBatch {\n  color: string;\n  particles: Array<{ x: number; y: number; size: number; alpha: number }>;\n  glowEnabled: boolean;\n  effectsEnabled: boolean;\n}\n\n/**\n * Level-of-Detail Manager for Performance Scaling\n */\nexport class LODManager {\n  private currentLOD: LODSettings;\n  private frameCount = 0;\n  private lastPerformanceCheck = 0;\n  private performanceHistory: number[] = [];\n  \n  private lodProfiles: Record<number, LODSettings> = {\n    0: { // High quality\n      level: 0,\n      particleReduction: 0,\n      effectsDisabled: false,\n      glowDisabled: false,\n      simplifiedRendering: false,\n      skipFrames: 0\n    },\n    1: { // Medium quality\n      level: 1,\n      particleReduction: 0.3,\n      effectsDisabled: false,\n      glowDisabled: true,\n      simplifiedRendering: false,\n      skipFrames: 1\n    },\n    2: { // Low quality\n      level: 2,\n      particleReduction: 0.6,\n      effectsDisabled: true,\n      glowDisabled: true,\n      simplifiedRendering: true,\n      skipFrames: 2\n    }\n  };\n\n  constructor(initialLOD = 1) {\n    this.currentLOD = this.lodProfiles[initialLOD];\n  }\n\n  /**\n   * Update LOD based on performance metrics\n   */\n  updateLOD(metrics: PerformanceMetrics): LODSettings {\n    this.frameCount++;\n    \n    // Check performance every 30 frames (0.5 seconds at 60fps)\n    if (this.frameCount - this.lastPerformanceCheck >= 30) {\n      this.performanceHistory.push(metrics.fps);\n      \n      // Keep only last 5 measurements (2.5 seconds)\n      if (this.performanceHistory.length > 5) {\n        this.performanceHistory.shift();\n      }\n      \n      const avgFPS = this.performanceHistory.reduce((sum, fps) => sum + fps, 0) / this.performanceHistory.length;\n      this.adjustLODBasedOnFPS(avgFPS);\n      \n      this.lastPerformanceCheck = this.frameCount;\n    }\n    \n    return this.currentLOD;\n  }\n\n  private adjustLODBasedOnFPS(avgFPS: number): void {\n    const targetFPS = 30;\n    \n    if (avgFPS < targetFPS * 0.7 && this.currentLOD.level < 2) {\n      // Performance is poor, reduce quality\n      this.currentLOD = this.lodProfiles[Math.min(2, this.currentLOD.level + 1)];\n      console.log(`[LOD] Reducing quality to level ${this.currentLOD.level} (FPS: ${avgFPS.toFixed(1)})`);\n    } else if (avgFPS > targetFPS * 1.2 && this.currentLOD.level > 0) {\n      // Performance is good, can increase quality\n      this.currentLOD = this.lodProfiles[Math.max(0, this.currentLOD.level - 1)];\n      console.log(`[LOD] Increasing quality to level ${this.currentLOD.level} (FPS: ${avgFPS.toFixed(1)})`);\n    }\n  }\n\n  getCurrentLOD(): LODSettings {\n    return this.currentLOD;\n  }\n\n  shouldSkipFrame(): boolean {\n    return this.currentLOD.skipFrames > 0 && \n           this.frameCount % (this.currentLOD.skipFrames + 1) !== 0;\n  }\n}\n\n/**\n * Frustum Culling for Off-screen Particle Elimination\n */\nexport class FrustumCuller {\n  private bounds!: CullingBounds;\n  private margin = 50; // Extra margin to prevent pop-in\n  \n  constructor(width: number, height: number, margin = 50) {\n    this.margin = margin;\n    this.updateBounds(width, height);\n  }\n\n  updateBounds(width: number, height: number): void {\n    this.bounds = {\n      left: -this.margin,\n      right: width + this.margin,\n      top: -this.margin,\n      bottom: height + this.margin,\n      near: -200,\n      far: 200\n    };\n  }\n\n  /**\n   * Check if a particle is within visible bounds\n   */\n  isVisible(x: number, y: number, z = 0, size = 0): boolean {\n    return (\n      x + size >= this.bounds.left &&\n      x - size <= this.bounds.right &&\n      y + size >= this.bounds.top &&\n      y - size <= this.bounds.bottom &&\n      (this.bounds.near === undefined || z >= this.bounds.near) &&\n      (this.bounds.far === undefined || z <= this.bounds.far)\n    );\n  }\n\n  /**\n   * Filter array of particles to only visible ones\n   */\n  cullParticles<T extends { x: number; y: number; z?: number; size?: number }>(particles: T[]): T[] {\n    return particles.filter(particle => \n      this.isVisible(\n        particle.x, \n        particle.y, \n        particle.z || 0, \n        particle.size || 0\n      )\n    );\n  }\n\n  /**\n   * Get culling statistics\n   */\n  getCullingStats<T extends { x: number; y: number }>(particles: T[]): {\n    total: number;\n    visible: number;\n    culled: number;\n    cullingRatio: number;\n  } {\n    const visible = this.cullParticles(particles);\n    const culled = particles.length - visible.length;\n    \n    return {\n      total: particles.length,\n      visible: visible.length,\n      culled,\n      cullingRatio: particles.length > 0 ? culled / particles.length : 0\n    };\n  }\n}\n\n/**\n * Batch Renderer for Optimized Drawing\n */\nexport class BatchRenderer {\n  private batches: Map<string, RenderBatch> = new Map();\n  private maxBatchSize = 1000;\n  \n  /**\n   * Add particle to appropriate batch\n   */\n  addToBatch(\n    color: string, \n    x: number, \n    y: number, \n    size: number, \n    alpha: number,\n    glowEnabled = false,\n    effectsEnabled = false\n  ): void {\n    const batchKey = `${color}_${glowEnabled}_${effectsEnabled}`;\n    \n    if (!this.batches.has(batchKey)) {\n      this.batches.set(batchKey, {\n        color,\n        particles: [],\n        glowEnabled,\n        effectsEnabled\n      });\n    }\n    \n    const batch = this.batches.get(batchKey)!;\n    if (batch.particles.length < this.maxBatchSize) {\n      batch.particles.push({ x, y, size, alpha });\n    }\n  }\n\n  /**\n   * Render all batches efficiently\n   */\n  renderBatches(context: CanvasRenderingContext2D, lodSettings: LODSettings): void {\n    Array.from(this.batches.entries()).forEach(([batchKey, batch]) => {\n      if (batch.particles.length === 0) return;\n      \n      context.save();\n      context.fillStyle = batch.color;\n      \n      // Skip effects if disabled by LOD\n      const shouldRenderEffects = batch.effectsEnabled && !lodSettings.effectsDisabled;\n      const shouldRenderGlow = batch.glowEnabled && !lodSettings.glowDisabled;\n      \n      if (lodSettings.simplifiedRendering) {\n        // Simplified rendering: draw all particles as simple circles\n        this.renderSimplifiedBatch(context, batch);\n      } else {\n        // Full rendering: individual particles with effects\n        this.renderFullBatch(context, batch, shouldRenderEffects, shouldRenderGlow);\n      }\n      \n      context.restore();\n    });\n  }\n\n  private renderSimplifiedBatch(context: CanvasRenderingContext2D, batch: RenderBatch): void {\n    context.beginPath();\n    batch.particles.forEach(particle => {\n      context.globalAlpha = particle.alpha;\n      context.moveTo(particle.x + particle.size, particle.y);\n      context.arc(particle.x, particle.y, particle.size, 0, Math.PI * 2);\n    });\n    context.fill();\n  }\n\n  private renderFullBatch(\n    context: CanvasRenderingContext2D, \n    batch: RenderBatch,\n    renderEffects: boolean,\n    renderGlow: boolean\n  ): void {\n    batch.particles.forEach(particle => {\n      context.save();\n      context.globalAlpha = particle.alpha;\n      \n      // Render glow first if enabled\n      if (renderGlow && particle.alpha > 0.5) {\n        const glowGradient = context.createRadialGradient(\n          particle.x, particle.y, 0,\n          particle.x, particle.y, particle.size * 3\n        );\n        glowGradient.addColorStop(0, batch.color);\n        glowGradient.addColorStop(1, 'transparent');\n        \n        context.fillStyle = glowGradient;\n        context.globalAlpha = particle.alpha * 0.3;\n        context.beginPath();\n        context.arc(particle.x, particle.y, particle.size * 3, 0, Math.PI * 2);\n        context.fill();\n      }\n      \n      // Render main particle\n      context.globalAlpha = particle.alpha;\n      context.fillStyle = batch.color;\n      context.beginPath();\n      context.arc(particle.x, particle.y, particle.size, 0, Math.PI * 2);\n      context.fill();\n      \n      context.restore();\n    });\n  }\n\n  /**\n   * Clear all batches\n   */\n  clearBatches(): void {\n    Array.from(this.batches.values()).forEach(batch => {\n      batch.particles = [];\n    });\n  }\n\n  /**\n   * Get batch statistics\n   */\n  getBatchStats(): {\n    batchCount: number;\n    totalParticles: number;\n    avgBatchSize: number;\n    largestBatch: number;\n  } {\n    const batchCount = this.batches.size;\n    let totalParticles = 0;\n    let largestBatch = 0;\n    \n    Array.from(this.batches.values()).forEach(batch => {\n      totalParticles += batch.particles.length;\n      largestBatch = Math.max(largestBatch, batch.particles.length);\n    });\n    \n    return {\n      batchCount,\n      totalParticles,\n      avgBatchSize: batchCount > 0 ? totalParticles / batchCount : 0,\n      largestBatch\n    };\n  }\n}\n\n/**\n * Memory Usage Monitor and Optimizer\n */\nexport class MemoryOptimizer {\n  private lastGCTime = 0;\n  private gcInterval = 10000; // 10 seconds\n  private memoryPressureThreshold = 0.85; // 85% of heap limit\n  \n  /**\n   * Check memory usage and trigger cleanup if needed\n   */\n  checkMemoryPressure(): { pressure: number; shouldCleanup: boolean } {\n    const currentTime = performance.now();\n    let pressure = 0;\n    let shouldCleanup = false;\n    \n    // Check if memory API is available\n    if ('memory' in (performance as any)) {\n      const memInfo = (performance as any).memory;\n      pressure = memInfo.usedJSHeapSize / memInfo.jsHeapSizeLimit;\n      shouldCleanup = pressure > this.memoryPressureThreshold;\n    }\n    \n    // Force cleanup based on time interval\n    if (currentTime - this.lastGCTime > this.gcInterval) {\n      shouldCleanup = true;\n      this.lastGCTime = currentTime;\n    }\n    \n    return { pressure, shouldCleanup };\n  }\n\n  /**\n   * Suggest memory optimization actions\n   */\n  getOptimizationSuggestions(pressure: number): {\n    reduceParticles: boolean;\n    clearCaches: boolean;\n    disableEffects: boolean;\n    simplifyRendering: boolean;\n  } {\n    return {\n      reduceParticles: pressure > 0.7,\n      clearCaches: pressure > 0.8,\n      disableEffects: pressure > 0.75,\n      simplifyRendering: pressure > 0.85\n    };\n  }\n}\n\n/**\n * Animation Frame Controller for Battery Optimization\n */\nexport class AnimationController {\n  private isVisible = true;\n  private targetFPS = 30;\n  private actualInterval = 1000 / 30; // ~33ms\n  private lastFrameTime = 0;\n  private frameBudget = 16.67; // ~60fps budget, but we target lower\n  \n  constructor(targetFPS = 30) {\n    this.setTargetFPS(targetFPS);\n    this.setupVisibilityHandling();\n  }\n\n  /**\n   * Set target FPS and update timing\n   */\n  setTargetFPS(fps: number): void {\n    this.targetFPS = Math.max(10, Math.min(60, fps)); // Clamp between 10-60\n    this.actualInterval = 1000 / this.targetFPS;\n  }\n\n  /**\n   * Check if frame should be rendered\n   */\n  shouldRenderFrame(): boolean {\n    if (!this.isVisible) return false;\n    \n    const currentTime = performance.now();\n    const deltaTime = currentTime - this.lastFrameTime;\n    \n    if (deltaTime >= this.actualInterval) {\n      this.lastFrameTime = currentTime;\n      return true;\n    }\n    \n    return false;\n  }\n\n  /**\n   * Get frame timing info\n   */\n  getFrameTiming(): {\n    targetFPS: number;\n    interval: number;\n    isVisible: boolean;\n    shouldThrottle: boolean;\n  } {\n    return {\n      targetFPS: this.targetFPS,\n      interval: this.actualInterval,\n      isVisible: this.isVisible,\n      shouldThrottle: !this.isVisible || this.targetFPS < 30\n    };\n  }\n\n  private setupVisibilityHandling(): void {\n    // Handle page visibility for battery optimization\n    document.addEventListener('visibilitychange', () => {\n      this.isVisible = !document.hidden;\n      \n      // Reduce FPS when not visible\n      if (!this.isVisible) {\n        this.setTargetFPS(10); // Very low FPS when hidden\n      } else {\n        this.setTargetFPS(30); // Normal FPS when visible\n      }\n    });\n    \n    // Handle focus/blur for additional optimization\n    window.addEventListener('focus', () => {\n      this.isVisible = true;\n      this.setTargetFPS(30);\n    });\n    \n    window.addEventListener('blur', () => {\n      this.setTargetFPS(20); // Reduced but not hidden\n    });\n  }\n}\n\n/**\n * Complete Performance Optimization Suite\n */\nexport class ThemePerformanceManager {\n  private lodManager: LODManager;\n  private culler: FrustumCuller;\n  private batchRenderer: BatchRenderer;\n  private memoryOptimizer: MemoryOptimizer;\n  private animationController: AnimationController;\n  \n  constructor(canvasWidth: number, canvasHeight: number) {\n    this.lodManager = new LODManager();\n    this.culler = new FrustumCuller(canvasWidth, canvasHeight);\n    this.batchRenderer = new BatchRenderer();\n    this.memoryOptimizer = new MemoryOptimizer();\n    this.animationController = new AnimationController();\n  }\n\n  /**\n   * Update all performance systems\n   */\n  update(metrics: PerformanceMetrics, canvasWidth?: number, canvasHeight?: number): {\n    lodSettings: LODSettings;\n    shouldRender: boolean;\n    memoryPressure: number;\n    optimizationActive: boolean;\n  } {\n    // Update LOD based on performance\n    const lodSettings = this.lodManager.updateLOD(metrics);\n    \n    // Update culling bounds if canvas size changed\n    if (canvasWidth && canvasHeight) {\n      this.culler.updateBounds(canvasWidth, canvasHeight);\n    }\n    \n    // Check memory pressure\n    const { pressure, shouldCleanup } = this.memoryOptimizer.checkMemoryPressure();\n    \n    // Check if we should render this frame\n    const shouldRender = this.animationController.shouldRenderFrame() && !this.lodManager.shouldSkipFrame();\n    \n    return {\n      lodSettings,\n      shouldRender,\n      memoryPressure: pressure,\n      optimizationActive: lodSettings.level > 0 || pressure > 0.7 || !shouldRender\n    };\n  }\n\n  /**\n   * Get all performance managers for direct access\n   */\n  getManagers() {\n    return {\n      lod: this.lodManager,\n      culler: this.culler,\n      batchRenderer: this.batchRenderer,\n      memory: this.memoryOptimizer,\n      animation: this.animationController\n    };\n  }\n\n  /**\n   * Get comprehensive performance report\n   */\n  getPerformanceReport(): {\n    lod: LODSettings;\n    culling: any;\n    batching: any;\n    memory: { pressure: number; shouldCleanup: boolean };\n    animation: any;\n  } {\n    const { pressure, shouldCleanup } = this.memoryOptimizer.checkMemoryPressure();\n    \n    return {\n      lod: this.lodManager.getCurrentLOD(),\n      culling: {}, // Will be populated when particles are processed\n      batching: this.batchRenderer.getBatchStats(),\n      memory: { pressure, shouldCleanup },\n      animation: this.animationController.getFrameTiming()\n    };\n  }\n}","/**\n * Base Theme Class\n * \n * Provides common functionality and structure for all voice themes.\n * Themes can extend this class to inherit shared behavior.\n */\n\nimport { IVoiceTheme, VoiceState, PerformanceSettings } from './IVoiceTheme';\nimport { PerformanceMonitor, DeviceCapabilityDetector } from '../utils/performance';\nimport { ThemePerformanceManager, LODSettings } from './PerformanceOptimizations';\nimport { lerp, clamp } from '../utils/math';\n\nexport abstract class BaseTheme implements IVoiceTheme {\n  // Abstract properties that must be implemented\n  abstract readonly id: string;\n  abstract readonly name: string;\n  abstract readonly description: string;\n  abstract readonly category: 'particle' | 'geometric' | 'advanced' | 'artistic';\n  abstract readonly performanceProfile: 'light' | 'medium' | 'heavy';\n\n  // Common state management\n  protected currentState: VoiceState = VoiceState.IDLE;\n  protected targetState: VoiceState = VoiceState.IDLE;\n  protected stateTransition = 0;\n  protected stateTransitionSpeed = 0.1;\n\n  // Mouse/touch interaction\n  protected mouseX = 0;\n  protected mouseY = 0;\n  protected normalizedMouseX = 0; // -1 to 1\n  protected normalizedMouseY = 0; // -1 to 1\n  protected mouseInfluence = 0;\n  protected targetMouseInfluence = 0;\n  protected isHovering = false;\n\n  // Canvas context and dimensions\n  protected context: CanvasRenderingContext2D | null = null;\n  protected canvasWidth = 0;\n  protected canvasHeight = 0;\n  protected centerX = 0;\n  protected centerY = 0;\n\n  // Performance monitoring\n  protected performanceMonitor: PerformanceMonitor;\n  protected performanceManager: ThemePerformanceManager | null = null;\n  protected performanceSettings: PerformanceSettings;\n  protected currentLODSettings: LODSettings | null = null;\n  protected lastFrameTime = 0;\n\n  // Animation timing\n  protected animationTime = 0;\n  protected deltaTimeAccumulator = 0;\n\n  constructor() {\n    this.performanceMonitor = new PerformanceMonitor();\n    \n    // Default performance settings (will be overridden by capability detection)\n    this.performanceSettings = {\n      targetFPS: 30,\n      maxParticles: 100,\n      enableEffects: true,\n      enableGlow: false,\n      qualityLevel: 'medium'\n    };\n\n    this.initializePerformanceCallbacks();\n  }\n\n  /**\n   * Initialize the theme with canvas context and dimensions\n   */\n  init(context: CanvasRenderingContext2D, width: number, height: number): void {\n    this.context = context;\n    this.updateDimensions(width, height);\n    this.initializePerformanceManager();\n    this.setupPerformanceSettings();\n    this.onInit();\n  }\n\n  /**\n   * Update canvas dimensions\n   */\n  protected updateDimensions(width: number, height: number): void {\n    this.canvasWidth = width;\n    this.canvasHeight = height;\n    this.centerX = width / 2;\n    this.centerY = height / 2;\n    \n    // Update performance manager with new dimensions\n    if (this.performanceManager) {\n      this.performanceManager.getManagers().culler.updateBounds(width, height);\n    }\n  }\n\n  /**\n   * Main drawing function called every frame\n   */\n  draw(\n    context: CanvasRenderingContext2D,\n    displayWidth: number,\n    displayHeight: number,\n    projCenterX: number,\n    projCenterY: number,\n    deltaTime: number\n  ): void {\n    // Update performance monitoring\n    const metrics = this.performanceMonitor.update();\n    \n    // Update performance manager and check if we should render\n    if (this.performanceManager) {\n      const perfUpdate = this.performanceManager.update(metrics, displayWidth, displayHeight);\n      this.currentLODSettings = perfUpdate.lodSettings;\n      \n      // Skip rendering if performance manager suggests it\n      if (!perfUpdate.shouldRender) {\n        return;\n      }\n    }\n    \n    // Update dimensions if changed\n    if (this.canvasWidth !== displayWidth || this.canvasHeight !== displayHeight) {\n      this.updateDimensions(displayWidth, displayHeight);\n    }\n\n    // Update animation timing\n    this.updateTiming(deltaTime);\n\n    // Update state transitions\n    this.updateStateTransition();\n\n    // Update mouse influence\n    this.updateMouseInfluence();\n\n    // Clear canvas with theme-specific background\n    this.clearCanvas(context, displayWidth, displayHeight);\n\n    // Delegate to theme-specific drawing\n    this.onDraw(context, displayWidth, displayHeight, projCenterX, projCenterY, deltaTime);\n\n    // Draw performance overlay if enabled\n    if (this.shouldShowPerformanceOverlay()) {\n      this.drawPerformanceOverlay(context, metrics);\n    }\n  }\n\n  /**\n   * Handle state changes with smooth transitions\n   */\n  onUserSpeaking(): void {\n    this.setTargetState(VoiceState.USER_SPEAKING);\n    this.onStateChange(VoiceState.USER_SPEAKING);\n  }\n\n  onProcessing(): void {\n    this.setTargetState(VoiceState.PROCESSING);\n    this.onStateChange(VoiceState.PROCESSING);\n  }\n\n  onAiSpeaking(): void {\n    this.setTargetState(VoiceState.AI_SPEAKING);\n    this.onStateChange(VoiceState.AI_SPEAKING);\n  }\n\n  reset(): void {\n    this.setTargetState(VoiceState.IDLE);\n    this.onStateChange(VoiceState.IDLE);\n    this.onReset();\n  }\n\n  /**\n   * Handle mouse/touch position updates\n   */\n  setMousePosition(x: number, y: number, canvasWidth: number, canvasHeight: number): void {\n    this.mouseX = x;\n    this.mouseY = y;\n    this.normalizedMouseX = (x / canvasWidth) * 2 - 1; // -1 to 1\n    this.normalizedMouseY = (y / canvasHeight) * 2 - 1; // -1 to 1\n    this.targetMouseInfluence = this.isHovering ? 1 : 0.3;\n    this.onMouseMove(x, y, this.normalizedMouseX, this.normalizedMouseY);\n  }\n\n  /**\n   * Handle hover state changes\n   */\n  setHovering(hovering: boolean): void {\n    this.isHovering = hovering;\n    this.targetMouseInfluence = hovering ? 1 : 0;\n    this.onHoverChange(hovering);\n  }\n\n  /**\n   * Cleanup resources\n   */\n  dispose(): void {\n    this.onDispose();\n  }\n\n  /**\n   * Get performance metrics\n   */\n  getPerformanceMetrics() {\n    const baseMetrics = this.performanceMonitor.getCurrentMetrics();\n    const themeMetrics = this.getThemeSpecificMetrics();\n    return { ...baseMetrics, ...themeMetrics };\n  }\n\n  // Protected methods for subclasses to override\n\n  /**\n   * Theme-specific initialization\n   */\n  protected onInit(): void {}\n\n  /**\n   * Theme-specific drawing logic\n   */\n  protected abstract onDraw(\n    context: CanvasRenderingContext2D,\n    width: number,\n    height: number,\n    centerX: number,\n    centerY: number,\n    deltaTime: number\n  ): void;\n\n  /**\n   * Called when state changes\n   */\n  protected onStateChange(newState: VoiceState): void {}\n\n  /**\n   * Called when reset\n   */\n  protected onReset(): void {}\n\n  /**\n   * Called when mouse moves\n   */\n  protected onMouseMove(x: number, y: number, normalizedX: number, normalizedY: number): void {}\n\n  /**\n   * Called when hover state changes\n   */\n  protected onHoverChange(hovering: boolean): void {}\n\n  /**\n   * Called when disposing\n   */\n  protected onDispose(): void {}\n\n  /**\n   * Get theme-specific performance metrics\n   */\n  protected getThemeSpecificMetrics(): Record<string, any> {\n    return {};\n  }\n\n  /**\n   * Clear canvas with theme-specific background\n   */\n  protected clearCanvas(context: CanvasRenderingContext2D, width: number, height: number): void {\n    context.clearRect(0, 0, width, height);\n  }\n\n  // Private helper methods\n\n  private async setupPerformanceSettings(): Promise<void> {\n    try {\n      const detector = DeviceCapabilityDetector.getInstance();\n      const capabilities = await detector.detectCapabilities();\n      \n      // Adjust performance settings based on device capabilities\n      if (capabilities.performanceLevel === 'low' || capabilities.isLowPowerDevice) {\n        this.performanceSettings = {\n          targetFPS: 24,\n          maxParticles: this.getOptimalParticleCount('low'),\n          enableEffects: false,\n          enableGlow: false,\n          qualityLevel: 'low'\n        };\n      } else if (capabilities.performanceLevel === 'medium') {\n        this.performanceSettings = {\n          targetFPS: 30,\n          maxParticles: this.getOptimalParticleCount('medium'),\n          enableEffects: true,\n          enableGlow: false,\n          qualityLevel: 'medium'\n        };\n      } else {\n        this.performanceSettings = {\n          targetFPS: 60,\n          maxParticles: this.getOptimalParticleCount('high'),\n          enableEffects: true,\n          enableGlow: true,\n          qualityLevel: 'high'\n        };\n      }\n    } catch (error) {\n      console.warn('Failed to detect device capabilities, using default settings:', error);\n    }\n  }\n\n  private initializePerformanceManager(): void {\n    this.performanceManager = new ThemePerformanceManager(this.canvasWidth, this.canvasHeight);\n  }\n\n  private getOptimalParticleCount(quality: 'low' | 'medium' | 'high'): number {\n    const baseCount = {\n      light: { low: 30, medium: 80, high: 150 },\n      medium: { low: 50, medium: 120, high: 250 },\n      heavy: { low: 20, medium: 60, high: 120 }\n    };\n\n    return baseCount[this.performanceProfile][quality];\n  }\n\n  private initializePerformanceCallbacks(): void {\n    this.performanceMonitor.setCallbacks({\n      onPerformanceWarning: (metrics) => {\n        console.warn(`[${this.id}] Performance warning:`, metrics);\n        this.adjustPerformanceSettings(0.8);\n      },\n      onPerformanceCritical: (metrics) => {\n        console.error(`[${this.id}] Critical performance:`, metrics);\n        this.adjustPerformanceSettings(0.6);\n      }\n    });\n  }\n\n  private adjustPerformanceSettings(factor: number): void {\n    this.performanceSettings.maxParticles = Math.floor(this.performanceSettings.maxParticles * factor);\n    this.performanceSettings.enableEffects = false;\n    this.performanceSettings.enableGlow = false;\n  }\n\n  private setTargetState(state: VoiceState): void {\n    if (this.targetState !== state) {\n      this.targetState = state;\n      this.stateTransition = 0;\n    }\n  }\n\n  private updateStateTransition(): void {\n    if (this.currentState !== this.targetState) {\n      this.stateTransition += this.stateTransitionSpeed;\n      if (this.stateTransition >= 1) {\n        this.currentState = this.targetState;\n        this.stateTransition = 1;\n      }\n    }\n  }\n\n  private updateMouseInfluence(): void {\n    this.mouseInfluence = lerp(this.mouseInfluence, this.targetMouseInfluence, 0.1);\n  }\n\n  private updateTiming(deltaTime: number): void {\n    this.deltaTimeAccumulator += deltaTime;\n    this.animationTime += deltaTime;\n  }\n\n  private shouldShowPerformanceOverlay(): boolean {\n    // Only show in development or when explicitly enabled\n    return process.env.NODE_ENV === 'development' && \n           localStorage.getItem('voice-performance-overlay') === 'true';\n  }\n\n  private drawPerformanceOverlay(context: CanvasRenderingContext2D, metrics: any): void {\n    context.save();\n    context.fillStyle = 'rgba(0, 0, 0, 0.8)';\n    context.fillRect(10, 10, 200, 80);\n    context.fillStyle = 'white';\n    context.font = '12px monospace';\n    context.fillText(`Theme: ${this.name}`, 15, 25);\n    context.fillText(`FPS: ${Math.round(metrics.fps)}`, 15, 40);\n    context.fillText(`Frame: ${Math.round(metrics.frameTime)}ms`, 15, 55);\n    context.fillText(`State: ${this.currentState}`, 15, 70);\n    context.fillText(`Mouse: ${Math.round(this.mouseInfluence * 100)}%`, 15, 85);\n    context.restore();\n  }\n\n  // Protected utility methods for subclasses\n\n  /**\n   * Get color interpolated between states\n   */\n  protected getStateColor(idleColor: string, activeColor: string): string {\n    if (this.stateTransition === 0) return idleColor;\n    if (this.stateTransition === 1) return activeColor;\n    \n    // Simple color interpolation (for more complex colors, use Color class)\n    return activeColor; // Simplified for now\n  }\n\n  /**\n   * Get value interpolated by mouse influence\n   */\n  protected getMouseInfluencedValue(baseValue: number, influencedValue: number): number {\n    return lerp(baseValue, influencedValue, this.mouseInfluence);\n  }\n\n  /**\n   * Check if effects should be enabled based on performance settings\n   */\n  protected shouldEnableEffects(): boolean {\n    if (this.currentLODSettings) {\n      return !this.currentLODSettings.effectsDisabled;\n    }\n    return this.performanceSettings.enableEffects;\n  }\n\n  /**\n   * Check if glow effects should be enabled\n   */\n  protected shouldEnableGlow(): boolean {\n    if (this.currentLODSettings) {\n      return !this.currentLODSettings.glowDisabled;\n    }\n    return this.performanceSettings.enableGlow;\n  }\n\n  /**\n   * Get maximum particle count for performance\n   */\n  protected getMaxParticles(): number {\n    const baseMax = this.performanceSettings.maxParticles;\n    if (this.currentLODSettings) {\n      return Math.floor(baseMax * (1 - this.currentLODSettings.particleReduction));\n    }\n    return baseMax;\n  }\n\n  /**\n   * Get current LOD level for theme-specific optimizations\n   */\n  protected getCurrentLODLevel(): number {\n    return this.currentLODSettings?.level || 1;\n  }\n\n  /**\n   * Check if simplified rendering should be used\n   */\n  protected shouldUseSimplifiedRendering(): boolean {\n    return this.currentLODSettings?.simplifiedRendering || false;\n  }\n\n  /**\n   * Get performance managers for advanced optimizations\n   */\n  protected getPerformanceManagers() {\n    return this.performanceManager?.getManagers() || null;\n  }\n\n  /**\n   * Check if a particle is visible (for culling)\n   */\n  protected isParticleVisible(x: number, y: number, z = 0, size = 0): boolean {\n    const managers = this.getPerformanceManagers();\n    if (managers?.culler) {\n      return managers.culler.isVisible(x, y, z, size);\n    }\n    return true; // No culling available, assume visible\n  }\n\n  /**\n   * Filter particles to only visible ones\n   */\n  protected cullParticles<T extends { x: number; y: number; z?: number; size?: number }>(particles: T[]): T[] {\n    const managers = this.getPerformanceManagers();\n    if (managers?.culler) {\n      return managers.culler.cullParticles(particles);\n    }\n    return particles; // No culling available, return all\n  }\n\n  /**\n   * Add particle to batch renderer for optimized drawing\n   */\n  protected addToBatch(\n    color: string,\n    x: number,\n    y: number, \n    size: number,\n    alpha: number,\n    glowEnabled = false,\n    effectsEnabled = false\n  ): void {\n    const managers = this.getPerformanceManagers();\n    if (managers?.batchRenderer) {\n      managers.batchRenderer.addToBatch(color, x, y, size, alpha, glowEnabled, effectsEnabled);\n    }\n  }\n\n  /**\n   * Render all batches (call at end of draw)\n   */\n  protected renderBatches(context: CanvasRenderingContext2D): void {\n    const managers = this.getPerformanceManagers();\n    if (managers?.batchRenderer && this.currentLODSettings) {\n      managers.batchRenderer.renderBatches(context, this.currentLODSettings);\n      managers.batchRenderer.clearBatches();\n    }\n  }\n}","/**\n * Voice Theme Interface\n * \n * Defines the contract that all voice interaction themes must implement.\n * Each theme provides unique visual feedback for different voice states.\n */\n\nexport interface IVoiceTheme {\n  /**\n   * Unique identifier for the theme\n   */\n  readonly id: string;\n\n  /**\n   * Display name for the theme\n   */\n  readonly name: string;\n\n  /**\n   * Theme description\n   */\n  readonly description: string;\n\n  /**\n   * Theme category for UI organization\n   */\n  readonly category: 'particle' | 'geometric' | 'advanced' | 'artistic';\n\n  /**\n   * Performance profile for mobile optimization\n   */\n  readonly performanceProfile: 'light' | 'medium' | 'heavy';\n\n  /**\n   * Initialize the theme with canvas context and dimensions\n   */\n  init(context: CanvasRenderingContext2D, width: number, height: number): void;\n\n  /**\n   * Main drawing function called every frame\n   */\n  draw(\n    context: CanvasRenderingContext2D,\n    displayWidth: number,\n    displayHeight: number,\n    projCenterX: number,\n    projCenterY: number,\n    deltaTime: number\n  ): void;\n\n  /**\n   * User is speaking state\n   */\n  onUserSpeaking(): void;\n\n  /**\n   * Processing/analyzing speech state\n   */\n  onProcessing(): void;\n\n  /**\n   * AI is responding state\n   */\n  onAiSpeaking(): void;\n\n  /**\n   * Reset to idle state\n   */\n  reset(): void;\n\n  /**\n   * Handle mouse/touch position updates\n   */\n  setMousePosition(x: number, y: number, canvasWidth: number, canvasHeight: number): void;\n\n  /**\n   * Handle mouse/touch hover state\n   */\n  setHovering(hovering: boolean): void;\n\n  /**\n   * Cleanup resources when theme is deactivated\n   */\n  dispose(): void;\n\n  /**\n   * Get current performance metrics\n   */\n  getPerformanceMetrics(): {\n    particleCount?: number;\n    objectCount?: number;\n    memoryUsage?: number;\n    averageFPS?: number;\n  };\n}\n\n/**\n * Theme metadata for UI display\n */\nexport interface ThemeMetadata {\n  id: string;\n  name: string;\n  description: string;\n  category: string;\n  performanceProfile: string;\n  previewColors: string[];\n  previewDescription: string;\n}\n\n/**\n * Voice state enumeration\n */\nexport enum VoiceState {\n  IDLE = 'idle',\n  USER_SPEAKING = 'userSpeaking',\n  PROCESSING = 'processing',\n  AI_SPEAKING = 'aiSpeaking'\n}\n\n/**\n * Performance settings for different device types\n */\nexport interface PerformanceSettings {\n  targetFPS: number;\n  maxParticles: number;\n  enableEffects: boolean;\n  enableGlow: boolean;\n  qualityLevel: 'low' | 'medium' | 'high';\n}\n\n/**\n * Theme factory function type\n */\nexport type ThemeFactory = () => IVoiceTheme;","/**\n * Button Component\n * \n * Reusable button component with multiple variants and sizes.\n * Built with class-variance-authority for type-safe styling.\n * \n * Variants:\n * - default: Primary brand button with shadow\n * - destructive: Red danger button for destructive actions\n * - outline: Secondary button with border\n * - secondary: Gray background button\n * - ghost: Transparent button with hover state\n * - link: Text-only button styled as link\n * \n * Sizes:\n * - default: Standard size (h-10)\n * - sm: Small size (h-8)\n * - lg: Large size (h-12)\n * - icon: Square icon button (10x10)\n * \n * Features:\n * - Full keyboard accessibility\n * - Focus ring for keyboard navigation\n * - Disabled state handling\n * - Smooth transitions\n * - Responsive to all button HTML attributes\n * \n * Usage examples:\n * <Button>Click me</Button>\n * <Button variant=\"destructive\">Delete</Button>\n * <Button size=\"sm\" variant=\"outline\">Cancel</Button>\n * <Button size=\"icon\" variant=\"ghost\"><Icon /></Button>\n * \n * Features:\n * - Comprehensive variant system with brand-consistent styling\n * - Professional color schemes aligned with design guidelines\n * - Loading states with integrated spinner animations\n * - Button group functionality for complex interfaces\n * - Full icon support with flexible positioning options\n */\n\nimport * as React from 'react';\nimport { cva, type VariantProps } from 'class-variance-authority';\nimport { cn } from '@/lib/utils';\n\n/**\n * Button variant configuration using class-variance-authority\n * \n * Base classes apply to all buttons, then variant-specific\n * classes are added based on the variant and size props.\n */\nconst buttonVariants = cva(\n  // Enhanced base classes with premium feel\n  'relative inline-flex items-center justify-center font-medium transition-all duration-200 ease-out focus-visible:outline-none disabled:opacity-50 disabled:cursor-not-allowed disabled:pointer-events-none transform-gpu active:scale-[0.98]',\n  {\n    variants: {\n      variant: {\n        default: [\n          'bg-primary text-primary-foreground shadow-sm',\n          'hover:bg-primary-hover hover:shadow-md hover:scale-[1.02]',\n          'focus-visible:ring-2 focus-visible:ring-primary/50 focus-visible:ring-offset-2',\n          'active:bg-primary-active',\n          'transition-all duration-200',\n        ].join(' '),\n        destructive: [\n          'bg-destructive text-destructive-foreground shadow-sm',\n          'hover:bg-destructive/90 hover:shadow-md hover:scale-[1.02]',\n          'focus-visible:ring-2 focus-visible:ring-destructive/50 focus-visible:ring-offset-2',\n          'active:bg-destructive/80',\n        ].join(' '),\n        outline: [\n          'border border-input bg-background/50 backdrop-blur-sm',\n          'hover:bg-accent hover:text-accent-foreground hover:border-accent',\n          'focus-visible:ring-2 focus-visible:ring-accent/50 focus-visible:ring-offset-2',\n          'transition-all duration-200',\n        ].join(' '),\n        secondary: [\n          'bg-secondary text-secondary-foreground',\n          'hover:bg-secondary/80 hover:shadow-sm',\n          'focus-visible:ring-2 focus-visible:ring-secondary/50 focus-visible:ring-offset-2',\n        ].join(' '),\n        ghost: [\n          'hover:bg-accent hover:text-accent-foreground',\n          'focus-visible:ring-2 focus-visible:ring-accent/50 focus-visible:ring-offset-2',\n          'data-[state=open]:bg-accent data-[state=open]:text-accent-foreground',\n        ].join(' '),\n        link: [\n          'text-primary underline-offset-4 hover:underline',\n          'focus-visible:ring-2 focus-visible:ring-primary/50 focus-visible:ring-offset-2',\n          'hover:text-primary-hover',\n        ].join(' '),\n        premium: [\n          'bg-gradient-to-r from-primary to-primary-hover text-primary-foreground',\n          'shadow-md hover:shadow-lg hover:scale-[1.02]',\n          'focus-visible:ring-2 focus-visible:ring-primary/50 focus-visible:ring-offset-2',\n          'before:absolute before:inset-0 before:bg-white/20 before:opacity-0',\n          'hover:before:opacity-100 before:transition-opacity before:duration-200',\n          'overflow-hidden',\n        ].join(' '),\n      },\n      size: {\n        default: 'h-10 rounded-lg px-4 py-2 text-sm',\n        sm: 'h-8 rounded-md px-3 text-xs',\n        lg: 'h-12 rounded-lg px-8 text-base',\n        xl: 'h-14 rounded-xl px-10 text-lg',\n        icon: 'h-10 w-10 rounded-lg',\n        'icon-sm': 'h-8 w-8 rounded-md',\n        'icon-lg': 'h-12 w-12 rounded-lg',\n      },\n    },\n    defaultVariants: {\n      variant: 'default',\n      size: 'default',\n    },\n  }\n);\n\n/**\n * Button component props\n * \n * Extends standard HTML button attributes with variant props\n * @property variant - Visual style variant\n * @property size - Button size preset\n * @property asChild - Whether to render as child component (for composition)\n */\nexport interface ButtonProps\n  extends React.ButtonHTMLAttributes<HTMLButtonElement>,\n    VariantProps<typeof buttonVariants> {\n  asChild?: boolean;\n  loading?: boolean;\n  loadingText?: string;\n}\n\n/**\n * Button Component\n * \n * Forward ref component for proper ref handling in forms\n * and other use cases requiring direct DOM access.\n */\nconst Button = React.forwardRef<HTMLButtonElement, ButtonProps>(\n  ({ \n    className, \n    variant, \n    size, \n    asChild = false, \n    loading = false,\n    loadingText,\n    children,\n    disabled,\n    onClick,\n    ...props \n  }, ref) => {\n    const [ripples, setRipples] = React.useState<Array<{ x: number; y: number; id: number }>>([]);\n    \n    const handleClick = React.useCallback((e: React.MouseEvent<HTMLButtonElement>) => {\n      if (loading || disabled) return;\n      \n      // Add ripple effect\n      const button = e.currentTarget;\n      const rect = button.getBoundingClientRect();\n      const rippleX = e.clientX - rect.left;\n      const rippleY = e.clientY - rect.top;\n      const rippleId = Date.now();\n      \n      setRipples(prev => [...prev, { x: rippleX, y: rippleY, id: rippleId }]);\n      \n      // Remove ripple after animation\n      setTimeout(() => {\n        setRipples(prev => prev.filter(ripple => ripple.id !== rippleId));\n      }, 600);\n      \n      // Call original onClick\n      onClick?.(e);\n    }, [loading, disabled, onClick]);\n    \n    return (\n      <button\n        className={cn(\n          buttonVariants({ variant, size, className }),\n          'relative overflow-hidden',\n          loading && 'cursor-wait'\n        )}\n        ref={ref}\n        disabled={loading || disabled}\n        onClick={handleClick}\n        {...props}\n      >\n        {/* Ripple effects */}\n        {ripples.map(ripple => (\n          <span\n            key={ripple.id}\n            className=\"absolute pointer-events-none\"\n            style={{\n              left: ripple.x,\n              top: ripple.y,\n              transform: 'translate(-50%, -50%)',\n            }}\n          >\n            <span className=\"block animate-ripple rounded-full bg-white/30 dark:bg-white/20\" \n              style={{\n                width: 0,\n                height: 0,\n                animation: 'ripple-expand 0.6s ease-out forwards',\n              }}\n            />\n          </span>\n        ))}\n        \n        {/* Loading spinner */}\n        {loading && (\n          <span className=\"absolute inset-0 flex items-center justify-center bg-inherit\">\n            <svg\n              className=\"animate-spin h-4 w-4\"\n              xmlns=\"http://www.w3.org/2000/svg\"\n              fill=\"none\"\n              viewBox=\"0 0 24 24\"\n            >\n              <circle\n                className=\"opacity-25\"\n                cx=\"12\"\n                cy=\"12\"\n                r=\"10\"\n                stroke=\"currentColor\"\n                strokeWidth=\"4\"\n              />\n              <path\n                className=\"opacity-75\"\n                fill=\"currentColor\"\n                d=\"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z\"\n              />\n            </svg>\n          </span>\n        )}\n        \n        {/* Button content */}\n        <span className={cn(\n          'relative z-10 inline-flex items-center',\n          loading && 'opacity-0'\n        )}>\n          {children}\n        </span>\n        \n        {/* Loading text */}\n        {loading && loadingText && (\n          <span className=\"absolute inset-0 flex items-center justify-center\">\n            <span className=\"ml-6\">{loadingText}</span>\n          </span>\n        )}\n      </button>\n    );\n  }\n);\nButton.displayName = 'Button';\n\nexport { Button, buttonVariants };","/**\n * Avatar Component\n * \n * Reusable avatar component that displays agent avatars with fallback to default icons.\n * Supports different sizes, shapes, and fallback icons for various use cases.\n * \n * Features:\n * - Image loading with error handling\n * - Multiple size variants\n * - Customizable fallback icons\n * - Consistent styling across the application\n * - Accessibility support\n */\n\n'use client';\n\nimport React from 'react';\nimport { Bot, User } from 'lucide-react';\nimport { cn } from '@/lib/utils';\nimport type { Agent } from '@/types';\n\nexport interface AvatarProps {\n  /** Agent/project data containing avatar information */\n  agent?: Agent | null;\n  /** Avatar image URL (alternative to agent prop) */\n  src?: string;\n  /** Alt text for the image */\n  alt?: string;\n  /** Size variant */\n  size?: 'xs' | 'sm' | 'md' | 'lg' | 'xl';\n  /** Shape variant */\n  shape?: 'circle' | 'rounded' | 'square';\n  /** Fallback icon type */\n  fallback?: 'bot' | 'user' | 'none';\n  /** Whether this avatar represents a selected/active state */\n  isSelected?: boolean;\n  /** Additional CSS classes */\n  className?: string;\n}\n\n/**\n * Avatar size configurations\n */\nconst sizeVariants = {\n  xs: {\n    container: 'w-4 h-4',\n    icon: 'w-2 h-2'\n  },\n  sm: {\n    container: 'w-6 h-6', \n    icon: 'w-3 h-3'\n  },\n  md: {\n    container: 'w-8 h-8',\n    icon: 'w-4 h-4'\n  },\n  lg: {\n    container: 'w-10 h-10',\n    icon: 'w-5 h-5'\n  },\n  xl: {\n    container: 'w-12 h-12',\n    icon: 'w-6 h-6'\n  }\n};\n\n/**\n * Avatar shape configurations\n */\nconst shapeVariants = {\n  circle: 'rounded-full',\n  rounded: 'rounded-lg', \n  square: 'rounded-none'\n};\n\n/**\n * Avatar Component\n * \n * Displays agent avatar with proper fallbacks and error handling.\n * \n * @param agent - Agent object containing avatar settings\n * @param src - Direct image URL (overrides agent avatar)\n * @param alt - Alt text for accessibility\n * @param size - Size variant (xs, sm, md, lg, xl)\n * @param shape - Shape variant (circle, rounded, square)\n * @param fallback - Fallback icon type\n * @param isSelected - Whether avatar represents selected state\n * @param className - Additional CSS classes\n */\nexport const Avatar: React.FC<AvatarProps> = ({\n  agent,\n  src,\n  alt,\n  size = 'md',\n  shape = 'circle',\n  fallback = 'bot',\n  isSelected = false,\n  className\n}) => {\n  const [imageError, setImageError] = React.useState(false);\n  \n  // Determine the avatar URL from props or agent settings\n  const avatarUrl = src || agent?.settings?.chatbot_avatar;\n  \n  // Generate alt text if not provided\n  const altText = alt || (agent?.project_name ? `${agent.project_name} avatar` : 'Avatar');\n  \n  // Get size and shape classes\n  const sizeClasses = sizeVariants[size];\n  const shapeClass = shapeVariants[shape];\n  \n  // Determine background color based on state\n  const backgroundClass = isSelected \n    ? 'bg-primary shadow-md' \n    : 'bg-muted hover:bg-accent transition-all duration-200';\n  \n  // Handle image load error\n  const handleImageError = () => {\n    setImageError(true);\n  };\n  \n  // Reset error state when avatar URL changes\n  React.useEffect(() => {\n    setImageError(false);\n  }, [avatarUrl]);\n  \n  // Render fallback icon\n  const renderFallbackIcon = () => {\n    if (fallback === 'none') return null;\n    \n    const iconClass = cn(\n      sizeClasses.icon,\n      isSelected ? 'text-primary-foreground' : 'text-muted-foreground'\n    );\n    \n    switch (fallback) {\n      case 'user':\n        return <User className={iconClass} />;\n      case 'bot':\n      default:\n        return <Bot className={iconClass} />;\n    }\n  };\n  \n  return (\n    <div className={cn(\n      'relative flex items-center justify-center flex-shrink-0 overflow-hidden',\n      'ring-2 ring-transparent',\n      'hover:ring-primary/20 hover:scale-105',\n      'transition-all duration-200',\n      isSelected && 'ring-primary ring-offset-2 ring-offset-background',\n      sizeClasses.container,\n      shapeClass,\n      backgroundClass,\n      className\n    )}>\n      {avatarUrl && !imageError ? (\n        <img\n          src={avatarUrl}\n          alt={altText}\n          className=\"w-full h-full object-cover\"\n          onError={handleImageError}\n          loading=\"lazy\"\n        />\n      ) : (\n        renderFallbackIcon()\n      )}\n      {/* Online indicator (optional) */}\n      {isSelected && (\n        <div className=\"absolute -bottom-0.5 -right-0.5 h-3 w-3 rounded-full bg-success border-2 border-background\" />\n      )}\n    </div>\n  );\n};\n\n/**\n * Agent Avatar Component\n * \n * Specialized avatar component for agent/project displays.\n * Uses 'bot' fallback by default and extracts name for alt text.\n * \n * @param agent - Agent object\n * @param size - Size variant\n * @param isSelected - Selection state\n * @param className - Additional classes\n */\nexport const AgentAvatar: React.FC<{\n  agent?: Agent | null;\n  size?: AvatarProps['size'];\n  isSelected?: boolean;\n  className?: string;\n}> = ({ agent, size = 'md', isSelected = false, className }) => {\n  return (\n    <Avatar\n      agent={agent}\n      size={size}\n      shape=\"circle\"\n      fallback=\"bot\"\n      isSelected={isSelected}\n      alt={agent?.project_name ? `${agent.project_name} avatar` : 'Agent avatar'}\n      className={className}\n    />\n  );\n};\n\n/**\n * User Avatar Component\n * \n * Specialized avatar component for user displays.\n * Uses 'user' fallback by default.\n * \n * @param src - Avatar image URL\n * @param size - Size variant  \n * @param className - Additional classes\n */\nexport const UserAvatar: React.FC<{\n  src?: string;\n  size?: AvatarProps['size'];\n  className?: string;\n}> = ({ src, size = 'md', className }) => {\n  return (\n    <Avatar\n      src={src}\n      size={size}\n      shape=\"circle\"\n      fallback=\"user\"\n      alt=\"User avatar\"\n      className={className}\n    />\n  );\n};","/**\n * Citation List Component\n * \n * Displays a list of source citations from the AI's response.\n * Shows where the information came from with expandable details.\n * \n * Features:\n * - Expandable citation cards\n * - Confidence score visualization\n * - Direct source links\n * - Show more/less functionality\n * - Smooth expand/collapse animations\n * - Citation numbering\n * - View details modal integration\n * \n * UI/UX:\n * - Compact card design\n * - Progressive disclosure pattern\n * - Visual confidence indicators\n * - Hover states for interactivity\n * - Staggered animation on load\n * \n * Citation Display:\n * - Title and source URL\n * - Content preview\n * - Confidence percentage\n * - External link to source\n * - Details button for modal\n * \n * Features:\n * - Advanced citation filtering and intelligent search capabilities\n * - Professional export functionality for research workflows\n * - Enhanced confidence visualization with detailed analytics\n * - Smart citation grouping by domain and source type\n * - Interactive tooltips and one-click copy functionality\n */\n\n'use client';\n\nimport React, { useState } from 'react';\nimport { motion, AnimatePresence } from 'framer-motion';\nimport { \n  BookOpen, \n  ChevronDown, \n  ExternalLink,\n  FileText \n} from 'lucide-react';\n\nimport type { CitationProps, Citation } from '@/types';\nimport { cn } from '@/lib/utils';\nimport { Button } from '@/components/ui/button';\n\n/**\n * Props for individual citation card\n * \n * @property citation - Citation data object\n * @property index - Display index (1-based)\n * @property isExpanded - Whether card is expanded\n * @property onToggle - Toggle expansion callback\n * @property onClick - Optional click handler for details\n * @property onPreviewClick - Optional click handler for file preview\n */\ninterface CitationCardProps {\n  citation: Citation;\n  index: number;\n  isExpanded: boolean;\n  onToggle: () => void;\n  onClick?: (citation: Citation) => void;\n  onPreviewClick?: (citation: Citation) => void;\n}\n\n/**\n * Citation Card Component\n * \n * Individual citation with expandable details.\n * Shows title, source, content, and confidence score.\n */\nconst CitationCard: React.FC<CitationCardProps> = ({\n  citation,\n  index,\n  isExpanded,\n  onToggle,\n  onClick,\n  onPreviewClick,\n}) => {\n  return (\n    <div className=\"border border-border rounded-lg overflow-hidden transition-all hover:border-border/80\">\n      <button\n        onClick={onToggle}\n        className=\"w-full px-3 py-2 flex items-center gap-3 hover:bg-accent transition-colors text-left\"\n      >\n        {/* Citation Index */}\n        <div className=\"flex-shrink-0 w-6 h-6 rounded bg-brand-100 flex items-center justify-center\">\n          <span className=\"text-xs font-medium text-brand-700\">{index}</span>\n        </div>\n        \n        {/* Citation Info */}\n        <div className=\"flex-1 min-w-0\">\n          <div className=\"font-medium text-sm text-foreground line-clamp-1\">\n            {citation.title}\n          </div>\n          <div className=\"text-xs text-muted-foreground line-clamp-1\">\n            {citation.source || citation.url}\n          </div>\n        </div>\n        \n        {/* Expand Icon */}\n        <ChevronDown\n          className={cn(\n            'w-4 h-4 text-muted-foreground transition-transform flex-shrink-0',\n            isExpanded && 'rotate-180'\n          )}\n        />\n      </button>\n      \n      {/* Expanded Content */}\n      <AnimatePresence>\n        {isExpanded && (\n          <motion.div\n            initial={{ height: 0, opacity: 0 }}\n            animate={{ height: 'auto', opacity: 1 }}\n            exit={{ height: 0, opacity: 0 }}\n            transition={{ duration: 0.2 }}\n            className=\"overflow-hidden\"\n          >\n            <div className=\"px-3 py-2 border-t border-border bg-accent\">\n              <p className=\"text-sm text-foreground mb-2\">\n                {citation.content}\n              </p>\n              \n              \n              {/* Actions */}\n              <div className=\"flex items-center gap-2\">\n                {citation.url && (\n                  <a\n                    href={citation.url}\n                    target=\"_blank\"\n                    rel=\"noopener noreferrer\"\n                    className=\"inline-flex items-center gap-1 text-xs text-brand-600 hover:text-brand-700 transition-colors\"\n                  >\n                    View source\n                    <ExternalLink className=\"w-3 h-3\" />\n                  </a>\n                )}\n                \n                {onClick && (\n                  <Button\n                    size=\"sm\"\n                    variant=\"ghost\"\n                    onClick={() => onClick(citation)}\n                    className=\"h-6 px-2 text-xs\"\n                  >\n                    View details\n                  </Button>\n                )}\n                \n                {onPreviewClick && (\n                  <Button\n                    size=\"sm\"\n                    variant=\"ghost\"\n                    onClick={() => onPreviewClick(citation)}\n                    className=\"h-6 px-2 text-xs\"\n                  >\n                    <FileText className=\"w-3 h-3 mr-1\" />\n                    Preview file\n                  </Button>\n                )}\n              </div>\n            </div>\n          </motion.div>\n        )}\n      </AnimatePresence>\n    </div>\n  );\n};\n\n/**\n * Citation List Component\n * \n * Main component that renders a list of citations with progressive disclosure.\n * Handles expansion state and show more/less functionality.\n * \n * @param citations - Array of citation objects to display\n * @param onCitationClick - Optional handler for citation detail clicks\n * @param maxVisible - Maximum citations to show initially (default: 5)\n * @param className - Additional CSS classes\n */\nexport const CitationList: React.FC<CitationProps & { onPreviewClick?: (citation: Citation) => void }> = ({ \n  citations, \n  onCitationClick,\n  onPreviewClick,\n  maxVisible = 5,\n  className \n}) => {\n  // Track which citations are expanded\n  const [expanded, setExpanded] = useState<Set<string>>(new Set());\n  // Track whether to show all citations or just maxVisible\n  const [showAll, setShowAll] = useState(false);\n  \n  const visibleCitations = showAll ? citations : citations.slice(0, maxVisible);\n  const hasMore = citations.length > maxVisible;\n\n  /**\n   * Toggle citation expansion state\n   * \n   * Uses Set for efficient lookup and update of expanded citations\n   */\n  const toggleExpanded = (citationId: string) => {\n    const newExpanded = new Set(expanded);\n    if (expanded.has(citationId)) {\n      newExpanded.delete(citationId);\n    } else {\n      newExpanded.add(citationId);\n    }\n    setExpanded(newExpanded);\n  };\n\n  if (citations.length === 0) {\n    return null;\n  }\n\n  return (\n    <div className={cn('mt-4 space-y-2', className)}>\n      {/* Header */}\n      <div className=\"flex items-center gap-2 text-sm text-muted-foreground\">\n        <BookOpen className=\"w-4 h-4\" />\n        <span className=\"font-medium\">Sources</span>\n        <span className=\"text-muted-foreground\">({citations.length})</span>\n        \n        {hasMore && (\n          <Button\n            size=\"sm\"\n            variant=\"ghost\"\n            onClick={() => setShowAll(!showAll)}\n            className=\"ml-auto h-6 px-2 text-xs\"\n          >\n            {showAll ? 'Show less' : `Show all ${citations.length}`}\n          </Button>\n        )}\n      </div>\n      \n      {/* Citations */}\n      <div className=\"space-y-2\">\n        <AnimatePresence>\n          {visibleCitations.map((citation, idx) => (\n            <motion.div\n              key={citation.id}\n              initial={{ opacity: 0, y: 10 }}\n              animate={{ opacity: 1, y: 0 }}\n              exit={{ opacity: 0, y: -10 }}\n              transition={{ duration: 0.2, delay: idx * 0.05 }}\n            >\n              <CitationCard\n                citation={citation}\n                index={idx + 1}\n                isExpanded={expanded.has(citation.id)}\n                onToggle={() => toggleExpanded(citation.id)}\n                onClick={onCitationClick}\n                onPreviewClick={onPreviewClick}\n              />\n            </motion.div>\n          ))}\n        </AnimatePresence>\n      </div>\n      \n      {/* Load More Button */}\n      {hasMore && !showAll && (\n        <div className=\"pt-2\">\n          <Button\n            size=\"sm\"\n            variant=\"outline\"\n            onClick={() => setShowAll(true)}\n            className=\"w-full\"\n          >\n            Show {citations.length - maxVisible} more sources\n          </Button>\n        </div>\n      )}\n    </div>\n  );\n};","/**\n * Message Details Component\n * \n * Displays additional metadata and information about a message\n * that's not shown in the main UI. Includes user ID, conversation ID,\n * metadata, and timestamps.\n * \n * Features:\n * - Collapsible details section\n * - Formatted metadata display\n * - Copy functionality for technical details\n * - Responsive layout\n */\n\n'use client';\n\nimport React, { useState } from 'react';\nimport { ChevronDown, ChevronUp, Copy, Info } from 'lucide-react';\nimport { toast } from 'sonner';\nimport { motion, AnimatePresence } from 'framer-motion';\nimport { cn, copyToClipboard } from '@/lib/utils';\nimport { Button } from '@/components/ui/button';\nimport type { MessageDetails as MessageDetailsType } from '@/types';\n\ninterface MessageDetailsProps {\n  /** The message details to display */\n  details?: MessageDetailsType;\n  /** Additional CSS classes */\n  className?: string;\n}\n\n/**\n * Format a key name to be more readable\n */\nconst formatKey = (key: string): string => {\n  return key\n    .split('_')\n    .map(word => word.charAt(0).toUpperCase() + word.slice(1))\n    .join(' ');\n};\n\n/**\n * Format a value for display\n */\nconst formatValue = (value: any): string => {\n  if (value === null || value === undefined) {\n    return 'N/A';\n  }\n  if (typeof value === 'object') {\n    return JSON.stringify(value, null, 2);\n  }\n  return String(value);\n};\n\nexport const MessageDetails: React.FC<MessageDetailsProps> = ({ details, className }) => {\n  const [isExpanded, setIsExpanded] = useState(false);\n\n  if (!details) {\n    return null;\n  }\n\n  const handleCopyAll = async () => {\n    const detailsText = JSON.stringify(details, null, 2);\n    const success = await copyToClipboard(detailsText);\n    if (success) {\n      toast.success('Details copied to clipboard');\n    }\n  };\n\n  const handleCopyValue = async (value: string) => {\n    const success = await copyToClipboard(value);\n    if (success) {\n      toast.success('Value copied to clipboard');\n    }\n  };\n\n  return (\n    <div className={cn('mt-2', className)}>\n      <button\n        onClick={() => setIsExpanded(!isExpanded)}\n        className=\"flex items-center gap-1 text-xs text-muted-foreground hover:text-foreground transition-colors\"\n      >\n        <Info className=\"w-3 h-3\" />\n        <span>More Details</span>\n        {isExpanded ? (\n          <ChevronUp className=\"w-3 h-3\" />\n        ) : (\n          <ChevronDown className=\"w-3 h-3\" />\n        )}\n      </button>\n\n      <AnimatePresence>\n        {isExpanded && (\n          <motion.div\n            initial={{ opacity: 0, height: 0 }}\n            animate={{ opacity: 1, height: 'auto' }}\n            exit={{ opacity: 0, height: 0 }}\n            transition={{ duration: 0.2 }}\n            className=\"overflow-hidden\"\n          >\n            <div className=\"mt-2 p-3 bg-accent rounded-lg border border-border\">\n              <div className=\"flex items-center justify-between mb-2\">\n                <h4 className=\"text-xs font-semibold text-foreground\">Message Details</h4>\n                <Button\n                  size=\"sm\"\n                  variant=\"ghost\"\n                  onClick={handleCopyAll}\n                  className=\"h-6 px-2 text-xs\"\n                >\n                  <Copy className=\"w-3 h-3 mr-1\" />\n                  Copy All\n                </Button>\n              </div>\n\n              <div className=\"space-y-2\">\n                {/* Basic Details */}\n                {details.user_id !== undefined && (\n                  <DetailRow\n                    label=\"User ID\"\n                    value={String(details.user_id)}\n                    onCopy={handleCopyValue}\n                  />\n                )}\n                \n                {details.conversation_id !== undefined && (\n                  <DetailRow\n                    label=\"Conversation ID\"\n                    value={String(details.conversation_id)}\n                    onCopy={handleCopyValue}\n                  />\n                )}\n                \n                {details.updated_at && (\n                  <DetailRow\n                    label=\"Updated At\"\n                    value={new Date(details.updated_at).toLocaleString()}\n                    onCopy={handleCopyValue}\n                  />\n                )}\n\n                {/* Metadata Section */}\n                {details.metadata && (\n                  <div className=\"mt-3 pt-2 border-t border-border\">\n                    <h5 className=\"text-xs font-semibold text-muted-foreground mb-2\">Metadata</h5>\n                    \n                    {details.metadata.user_ip && (\n                      <DetailRow\n                        label=\"User IP\"\n                        value={details.metadata.user_ip}\n                        onCopy={handleCopyValue}\n                      />\n                    )}\n                    \n                    {details.metadata.user_agent && (\n                      <DetailRow\n                        label=\"User Agent\"\n                        value={details.metadata.user_agent}\n                        onCopy={handleCopyValue}\n                        truncate\n                      />\n                    )}\n                    \n                    {details.metadata.external_id && (\n                      <DetailRow\n                        label=\"External ID\"\n                        value={details.metadata.external_id}\n                        onCopy={handleCopyValue}\n                      />\n                    )}\n                    \n                    {details.metadata.request_source && (\n                      <DetailRow\n                        label=\"Request Source\"\n                        value={details.metadata.request_source}\n                        onCopy={handleCopyValue}\n                      />\n                    )}\n                  </div>\n                )}\n              </div>\n            </div>\n          </motion.div>\n        )}\n      </AnimatePresence>\n    </div>\n  );\n};\n\ninterface DetailRowProps {\n  label: string;\n  value: string;\n  onCopy: (value: string) => void;\n  truncate?: boolean;\n}\n\nconst DetailRow: React.FC<DetailRowProps> = ({ label, value, onCopy, truncate }) => {\n  return (\n    <div className=\"flex items-start justify-between gap-2 text-xs\">\n      <span className=\"text-muted-foreground font-medium whitespace-nowrap\">{label}:</span>\n      <div className=\"flex items-center gap-1 flex-1 min-w-0\">\n        <span \n          className={cn(\n            \"text-foreground break-all\",\n            truncate && \"truncate\"\n          )}\n          title={truncate ? value : undefined}\n        >\n          {value}\n        </span>\n        <button\n          onClick={() => onCopy(value)}\n          className=\"p-1 text-muted-foreground hover:text-foreground transition-colors flex-shrink-0\"\n          title=\"Copy value\"\n        >\n          <Copy className=\"w-3 h-3\" />\n        </button>\n      </div>\n    </div>\n  );\n};","/**\n * Message Component\n * \n * Displays individual chat messages with rich formatting support.\n * \n * Features:\n * - Markdown rendering with GitHub Flavored Markdown\n * - Syntax highlighting for code blocks\n * - Copy functionality for code and messages\n * - User feedback (thumbs up/down)\n * - Citation display and interaction\n * - Animated entrance and streaming cursor\n * - Different layouts for user vs assistant messages\n * \n * Customization:\n * - Modify avatar styles in the component\n * - Adjust markdown prose styles\n * - Customize code block themes (currently using oneDark)\n * - Change animation settings\n */\n\n'use client';\n\nimport React, { useState } from 'react';\nimport ReactMarkdown from 'react-markdown';\nimport remarkGfm from 'remark-gfm';\nimport { Prism as SyntaxHighlighterComponent } from 'react-syntax-highlighter';\nimport { oneDark } from 'react-syntax-highlighter/dist/esm/styles/prism';\n\n// Type assertion to work around TypeScript issue with react-syntax-highlighter\nconst SyntaxHighlighter = SyntaxHighlighterComponent as any;\nimport { motion } from 'framer-motion';\nimport { \n  Bot, \n  User, \n  Copy, \n  ThumbsUp, \n  ThumbsDown, \n  RotateCw,\n  ExternalLink \n} from 'lucide-react';\nimport { toast } from 'sonner';\n\nimport type { MessageProps, Citation, ChatMessage } from '@/types';\nimport { cn, copyToClipboard, formatTimestamp } from '@/lib/utils';\nimport { Button } from '@/components/ui/button';\nimport { AgentAvatar, UserAvatar } from '@/components/ui/avatar';\nimport { CitationList } from './CitationList';\nimport { MessageDetails } from './MessageDetails';\nimport { useMessageStore } from '@/store/messages';\nimport { useConversationStore } from '@/store/conversations';\n\ninterface CodeBlockProps {\n  /** Programming language for syntax highlighting */\n  language: string;\n  /** Code content to display */\n  value: string;\n}\n\n/**\n * CodeBlock Component\n * \n * Renders code with syntax highlighting and a copy button.\n * Uses react-syntax-highlighter with the oneDark theme.\n * Copy button appears on hover.\n */\nconst CodeBlock: React.FC<CodeBlockProps> = ({ language, value }) => {\n  const [copied, setCopied] = useState(false);\n  \n  const handleCopy = async () => {\n    const success = await copyToClipboard(value);\n    if (success) {\n      setCopied(true);\n      toast.success('Code copied to clipboard');\n      setTimeout(() => setCopied(false), 2000);\n    }\n  };\n\n  return (\n    <div className=\"relative group\">\n      <div className=\"absolute right-2 top-2 opacity-0 group-hover:opacity-100 transition-opacity\">\n        <Button\n          size=\"sm\"\n          variant=\"ghost\"\n          onClick={handleCopy}\n          className=\"h-6 px-2 text-xs bg-foreground text-background hover:bg-foreground/90\"\n        >\n          {copied ? 'Copied!' : 'Copy'}\n        </Button>\n      </div>\n      <SyntaxHighlighter\n        language={language}\n        style={oneDark}\n        customStyle={{\n          margin: 0,\n          borderRadius: '0.5rem',\n          fontSize: '0.875rem',\n        }}\n      >\n        {value}\n      </SyntaxHighlighter>\n    </div>\n  );\n};\n\n/**\n * StreamingCursor Component\n * \n * Animated blinking cursor shown at the end of streaming messages\n * to indicate the AI is still generating content\n */\nconst StreamingCursor: React.FC = () => (\n  <span className=\"inline-block w-0.5 h-4 bg-foreground animate-blink ml-0.5 align-middle\" />\n);\n\ninterface MessageContentProps {\n  /** Markdown content to render */\n  content: string;\n  /** Whether the message is currently being streamed */\n  isStreaming?: boolean;\n}\n\n/**\n * MessageContent Component\n * \n * Renders message content with full markdown support including:\n * - Headers, lists, tables (via GFM)\n * - Inline and block code with syntax highlighting\n * - Links that open in new tabs\n * - Streaming cursor when content is being generated\n */\nconst MessageContent: React.FC<MessageContentProps> = ({ content, isStreaming }) => {\n  // Remove <CONTEXT> and </CONTEXT> tags from the content\n  const cleanedContent = content.replace(/<CONTEXT>|<\\/CONTEXT>/g, '').trim();\n  \n  return (\n    <div className=\"prose prose-sm max-w-none text-foreground\">\n      <ReactMarkdown\n        remarkPlugins={[remarkGfm]}\n        components={{\n          code({ className, children, ...props }) {\n            const match = /language-(\\w+)/.exec(className || '');\n            const isInline = !match;\n            return !isInline && match ? (\n              <CodeBlock\n                language={match[1]}\n                value={String(children).replace(/\\n$/, '')}\n                {...props}\n              />\n            ) : (\n              <code className=\"px-1 py-0.5 rounded bg-muted text-sm font-medium\" {...props}>\n                {children}\n              </code>\n            );\n          },\n          a({ href, children }) {\n            return (\n              <a\n                href={href}\n                target=\"_blank\"\n                rel=\"noopener noreferrer\"\n                className=\"text-brand-600 hover:text-brand-700 no-underline hover:underline inline-flex items-center gap-1\"\n              >\n                {children}\n                <ExternalLink className=\"w-3 h-3\" />\n              </a>\n            );\n          },\n        }}\n      >\n        {cleanedContent}\n      </ReactMarkdown>\n      {isStreaming && <StreamingCursor />}\n    </div>\n  );\n};\n\ninterface MessageActionsProps {\n  /** The message object containing content and metadata */\n  message: ChatMessage;\n  /** Handler for user feedback */\n  onFeedback?: (feedback: 'like' | 'dislike') => void;\n  /** Whether this is the last assistant message */\n  isLastAssistant?: boolean;\n}\n\n/**\n * MessageActions Component\n * \n * Action buttons for assistant messages:\n * - Copy message content\n * - Thumbs up/down feedback\n * - Regenerate response (placeholder)\n * \n * Only visible on hover for cleaner UI\n */\nconst MessageActions: React.FC<MessageActionsProps> = ({ message, onFeedback, isLastAssistant = false }) => {\n  const [feedback, setFeedback] = useState<'like' | 'dislike' | null>(\n    message.feedback || null\n  );\n\n  const handleCopy = async () => {\n    const success = await copyToClipboard(message.content);\n    if (success) {\n      toast.success('Message copied to clipboard');\n    }\n  };\n\n  const handleFeedback = (type: 'like' | 'dislike') => {\n    setFeedback(type);\n    onFeedback?.(type);\n    toast.success('Thanks for your feedback!');\n  };\n\n  const regenerateLastResponse = useMessageStore(state => state.regenerateLastResponse);\n  \n  const handleRegenerate = async () => {\n    try {\n      await regenerateLastResponse();\n    } catch (error) {\n      // Error handling is done in the store, so we don't need to do anything here\n      console.error('Failed to regenerate response:', error);\n    }\n  };\n\n  return (\n    <div className=\"mt-3 flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity\">\n      <Button\n        size=\"icon\"\n        variant=\"ghost\"\n        onClick={handleCopy}\n        className=\"h-8 w-8 text-muted-foreground hover:text-foreground\"\n        title=\"Copy message\"\n      >\n        <Copy className=\"h-4 w-4\" />\n      </Button>\n      \n      <Button\n        size=\"icon\"\n        variant=\"ghost\"\n        onClick={() => handleFeedback('like')}\n        className={cn(\n          'h-8 w-8 text-muted-foreground hover:text-foreground',\n          feedback === 'like' && 'text-success hover:text-success/90'\n        )}\n        title=\"Good response\"\n      >\n        <ThumbsUp className=\"h-4 w-4\" />\n      </Button>\n      \n      <Button\n        size=\"icon\"\n        variant=\"ghost\"\n        onClick={() => handleFeedback('dislike')}\n        className={cn(\n          'h-8 w-8 text-muted-foreground hover:text-foreground',\n          feedback === 'dislike' && 'text-destructive hover:text-destructive/90'\n        )}\n        title=\"Bad response\"\n      >\n        <ThumbsDown className=\"h-4 w-4\" />\n      </Button>\n      \n      {isLastAssistant && (\n        <Button\n          size=\"icon\"\n          variant=\"ghost\"\n          onClick={handleRegenerate}\n          className=\"h-8 w-8 text-muted-foreground hover:text-foreground\"\n          title=\"Regenerate response\"\n        >\n          <RotateCw className=\"h-4 w-4\" />\n        </Button>\n      )}\n    </div>\n  );\n};\n\n/**\n * Message Component - Main Export\n * \n * Renders a complete message with avatar, content, citations, and actions.\n * \n * Layout:\n * - User messages: White background, user avatar, plain text\n * - Assistant messages: Gray background, bot avatar, markdown content\n * \n * Features:\n * - Smooth entrance animation with Framer Motion\n * - Hover effects for action visibility\n * - Status indicators (sending, error)\n * - Timestamp display\n * - Citation list integration\n * \n * @param message - The message data to display\n * @param isStreaming - Whether this message is being streamed\n * @param isLast - Whether this is the last message (affects scrolling)\n * @param onCitationClick - Handler for citation interactions\n * @param onFeedback - Handler for user feedback\n * @param className - Additional CSS classes\n */\nexport const Message: React.FC<MessageProps> = ({\n  message,\n  agent,\n  isStreaming = false,\n  isLast = false,\n  onCitationClick,\n  onPreviewClick,\n  onFeedback,\n  mode = 'standalone',\n  enableCitations,\n  className\n}) => {\n  const isUser = message.role === 'user';\n\n  // Determine if citations should be shown\n  // Priority: enableCitations prop > mode-based logic\n  const shouldShowCitations = enableCitations !== undefined\n    ? enableCitations\n    : mode === 'standalone';\n  \n  // Get messages from the conversation to check if this is the last assistant message\n  const messages = useMessageStore(state => {\n    const conversationStore = useConversationStore.getState();\n    const currentConversation = conversationStore.currentConversation;\n    if (!currentConversation) return [];\n    return state.getMessagesForConversation(currentConversation.id.toString());\n  });\n  \n  // Check if this is the last assistant message\n  const isLastAssistant = !isUser && messages.length > 0 && \n    messages[messages.length - 1].role === 'assistant' &&\n    messages[messages.length - 1].id === message.id;\n  \n  return (\n    <motion.div\n      initial={{ opacity: 0, y: 10 }}\n      animate={{ opacity: 1, y: 0 }}\n      transition={{ duration: 0.3 }}\n      className={cn(\n        'group relative px-4 py-6 transition-colors',\n        isUser ? 'bg-background' : 'bg-muted border-y border-border',\n        'hover:bg-opacity-80',\n        className\n      )}\n    >\n      <div className=\"max-w-3xl mx-auto flex gap-4\">\n        {/* Avatar */}\n        <div className=\"flex-shrink-0\">\n          {isUser ? (\n            <UserAvatar \n              size=\"md\" \n              className=\"bg-secondary\"\n            />\n          ) : (\n            <AgentAvatar \n              agent={agent}\n              size=\"md\"\n              className=\"bg-background border border-border\"\n            />\n          )}\n        </div>\n        \n        {/* Content */}\n        <div className=\"flex-1 overflow-hidden\">\n          {/* Message Status */}\n          {message.status && message.status !== 'sent' && (\n            <div className=\"mb-2 text-xs text-muted-foreground\">\n              {message.status === 'sending' && 'Sending...'}\n              {message.status === 'error' && (\n                <span className=\"text-red-500\">Failed to send</span>\n              )}\n            </div>\n          )}\n          \n          {/* Message Content */}\n          {isUser ? (\n            <p className=\"text-foreground whitespace-pre-wrap\">{message.content}</p>\n          ) : (\n            <MessageContent \n              content={message.content} \n              isStreaming={isStreaming}\n            />\n          )}\n          \n          {/* Citations - Shown based on enableCitations prop or mode */}\n          {shouldShowCitations && message.citations && message.citations.length > 0 && (\n            <CitationList\n              citations={message.citations}\n              onCitationClick={onCitationClick}\n              onPreviewClick={onPreviewClick}\n            />\n          )}\n          \n          {/* Timestamp */}\n          <div className=\"mt-2 text-xs text-muted-foreground\">\n            {formatTimestamp(message.timestamp)}\n          </div>\n          \n          {/* Message Details (hidden by default) */}\n          <MessageDetails details={message.details} />\n          \n          {/* Actions */}\n          {!isUser && !isStreaming && (\n            <MessageActions \n              message={message}\n              onFeedback={onFeedback}\n              isLastAssistant={isLastAssistant}\n            />\n          )}\n        </div>\n      </div>\n    </motion.div>\n  );\n};","/**\n * Demo Mode Context\n * \n * Provides runtime demo mode status throughout the app\n */\n\n'use client';\n\nimport React, { createContext, useContext, useEffect, useState } from 'react';\n\ninterface DemoModeContextType {\n  isRuntimeDemoMode: boolean;\n  deploymentMode: 'demo' | 'production' | null;\n  isInitialized: boolean;\n  isFreeTrialMode: boolean;\n}\n\nconst DemoModeContext = createContext<DemoModeContextType>({\n  isRuntimeDemoMode: false,\n  deploymentMode: null,\n  isInitialized: false,\n  isFreeTrialMode: false,\n});\n\nexport const useDemoModeContext = () => {\n  const context = useContext(DemoModeContext);\n  if (!context) {\n    throw new Error('useDemoModeContext must be used within DemoModeProvider');\n  }\n  return context;\n};\n\ninterface DemoModeContextProviderProps {\n  children: React.ReactNode;\n}\n\nexport function DemoModeContextProvider({ children }: DemoModeContextProviderProps) {\n  const [deploymentMode, setDeploymentMode] = useState<'demo' | 'production' | null>(null);\n  const [isInitialized, setIsInitialized] = useState(false);\n  const [isFreeTrialMode, setIsFreeTrialMode] = useState(false);\n\n  useEffect(() => {\n    // Get the runtime deployment mode from localStorage\n    const mode = localStorage.getItem('customgpt.deploymentMode') as 'demo' | 'production' | null;\n    const freeTrialFlag = localStorage.getItem('customgpt.freeTrialMode');\n    setDeploymentMode(mode);\n    setIsFreeTrialMode(freeTrialFlag === 'true');\n    setIsInitialized(true);\n\n    // Listen for storage changes\n    const handleStorageChange = () => {\n      const newMode = localStorage.getItem('customgpt.deploymentMode') as 'demo' | 'production' | null;\n      const newFreeTrialFlag = localStorage.getItem('customgpt.freeTrialMode');\n      setDeploymentMode(newMode);\n      setIsFreeTrialMode(newFreeTrialFlag === 'true');\n    };\n\n    window.addEventListener('storage', handleStorageChange);\n    \n    // Also listen for custom events for same-window updates\n    window.addEventListener('deploymentModeChanged', handleStorageChange);\n\n    return () => {\n      window.removeEventListener('storage', handleStorageChange);\n      window.removeEventListener('deploymentModeChanged', handleStorageChange);\n    };\n  }, []);\n\n  const value: DemoModeContextType = {\n    isRuntimeDemoMode: deploymentMode === 'demo',\n    deploymentMode,\n    isInitialized,\n    isFreeTrialMode,\n  };\n\n  return (\n    <DemoModeContext.Provider value={value}>\n      {children}\n    </DemoModeContext.Provider>\n  );\n}","/**\n * Loading Components\n * \n * Reusable loading indicators for consistent loading states across the app.\n * Includes spinner, skeleton loaders, and full-page loading states.\n */\n\nimport React from 'react';\nimport { cn } from '@/lib/utils';\nimport { Loader2 } from 'lucide-react';\n\ninterface SpinnerProps {\n  /** Size of the spinner */\n  size?: 'sm' | 'md' | 'lg' | 'xl';\n  /** Additional CSS classes */\n  className?: string;\n  /** Label for accessibility */\n  label?: string;\n}\n\n/**\n * Spinner Component\n * \n * Animated spinning loader for inline and overlay loading states\n */\nexport const Spinner: React.FC<SpinnerProps> = ({ \n  size = 'md', \n  className,\n  label = 'Loading...'\n}) => {\n  const sizeClasses = {\n    sm: 'h-4 w-4',\n    md: 'h-6 w-6',\n    lg: 'h-8 w-8',\n    xl: 'h-12 w-12'\n  };\n\n  return (\n    <div className=\"relative inline-flex\">\n      <Loader2 \n        className={cn(\n          'animate-spin text-primary transition-all duration-200',\n          sizeClasses[size],\n          className\n        )}\n        aria-label={label}\n      />\n      {/* Subtle glow effect */}\n      <div className={cn(\n        'absolute inset-0 animate-pulse rounded-full bg-primary/20 blur-xl',\n        sizeClasses[size]\n      )} />\n    </div>\n  );\n};\n\ninterface SkeletonProps {\n  /** Additional CSS classes */\n  className?: string;\n  /** Whether to animate the skeleton */\n  animate?: boolean;\n}\n\n/**\n * Skeleton Component\n * \n * Placeholder loading state for content\n */\nexport const Skeleton: React.FC<SkeletonProps> = ({ \n  className,\n  animate = true\n}) => {\n  return (\n    <div\n      className={cn(\n        'relative overflow-hidden rounded-lg bg-muted',\n        animate && 'shimmer',\n        className\n      )}\n    >\n      {animate && (\n        <div className=\"absolute inset-0 -translate-x-full animate-[shimmer_2s_infinite] bg-gradient-to-r from-transparent via-white/10 to-transparent\" />\n      )}\n    </div>\n  );\n};\n\ninterface LoadingDotsProps {\n  /** Size of the dots */\n  size?: 'sm' | 'md' | 'lg';\n  /** Additional CSS classes */\n  className?: string;\n}\n\n/**\n * LoadingDots Component\n * \n * Three animated dots for typing/processing indicators\n */\nexport const LoadingDots: React.FC<LoadingDotsProps> = ({ \n  size = 'md',\n  className \n}) => {\n  const sizeClasses = {\n    sm: 'h-1.5 w-1.5',\n    md: 'h-2 w-2',\n    lg: 'h-2.5 w-2.5'\n  };\n\n  return (\n    <div className={cn('flex items-center space-x-1.5', className)}>\n      {[0, 1, 2].map((index) => (\n        <div\n          key={index}\n          className={cn(\n            'rounded-full bg-primary/60',\n            'animate-[pulse_1.4s_ease-in-out_infinite]',\n            sizeClasses[size]\n          )}\n          style={{\n            animationDelay: `${index * 0.15}s`,\n            animationFillMode: 'both',\n          }}\n        />\n      ))}\n    </div>\n  );\n};\n\ninterface LoadingOverlayProps {\n  /** Whether the overlay is visible */\n  visible: boolean;\n  /** Loading message to display */\n  message?: string;\n  /** Whether to blur the background */\n  blur?: boolean;\n  /** Additional CSS classes */\n  className?: string;\n}\n\n/**\n * LoadingOverlay Component\n * \n * Full-screen or container overlay with loading indicator\n */\nexport const LoadingOverlay: React.FC<LoadingOverlayProps> = ({ \n  visible,\n  message,\n  blur = true,\n  className\n}) => {\n  if (!visible) return null;\n\n  return (\n    <div className={cn(\n      'absolute inset-0 z-50 flex items-center justify-center',\n      'bg-background/60 transition-all duration-300',\n      blur && 'backdrop-blur-md',\n      'animate-in fade-in-0 duration-200',\n      className\n    )}>\n      <div className={cn(\n        'flex flex-col items-center space-y-4 p-6',\n        'bg-background/90 backdrop-blur-sm',\n        'rounded-xl border border-border/50',\n        'shadow-xl',\n        'animate-in zoom-in-95 duration-300'\n      )}>\n        <Spinner size=\"lg\" />\n        {message && (\n          <p className=\"text-sm text-muted-foreground font-medium\">{message}</p>\n        )}\n      </div>\n    </div>\n  );\n};\n\ninterface MessageSkeletonProps {\n  /** Whether this represents an assistant message */\n  isAssistant?: boolean;\n  /** Number of lines to show */\n  lines?: number;\n}\n\n/**\n * MessageSkeleton Component\n * \n * Skeleton loader specifically for chat messages\n */\nexport const MessageSkeleton: React.FC<MessageSkeletonProps> = ({ \n  isAssistant = false,\n  lines = 3\n}) => {\n  return (\n    <div className={cn(\n      'flex gap-3 p-4',\n      isAssistant ? 'bg-muted' : 'bg-background'\n    )}>\n      {/* Avatar */}\n      <Skeleton className=\"h-8 w-8 rounded-full flex-shrink-0\" />\n      \n      {/* Message content */}\n      <div className=\"flex-1 space-y-2\">\n        {Array.from({ length: lines }).map((_, i) => (\n          <Skeleton \n            key={i}\n            className={cn(\n              'h-4',\n              i === lines - 1 ? 'w-3/4' : 'w-full'\n            )}\n          />\n        ))}\n      </div>\n    </div>\n  );\n};\n\ninterface ConversationSkeletonProps {\n  /** Number of conversation items to show */\n  count?: number;\n}\n\n/**\n * ConversationSkeleton Component\n * \n * Skeleton loader for conversation list items\n */\nexport const ConversationSkeleton: React.FC<ConversationSkeletonProps> = ({ \n  count = 3 \n}) => {\n  return (\n    <div className=\"space-y-2 p-2\">\n      {Array.from({ length: count }).map((_, i) => (\n        <div key={i} className=\"p-3 rounded-lg\">\n          <Skeleton className=\"h-4 w-3/4 mb-2\" />\n          <Skeleton className=\"h-3 w-1/2\" />\n        </div>\n      ))}\n    </div>\n  );\n};\n\ninterface LoadingButtonProps {\n  /** Whether the button is in loading state */\n  loading: boolean;\n  /** Button content when not loading */\n  children: React.ReactNode;\n  /** Loading text to display */\n  loadingText?: string;\n  /** Additional CSS classes */\n  className?: string;\n  /** Other button props */\n  [key: string]: any;\n}\n\n/**\n * LoadingButton Component\n * \n * Button with integrated loading state\n */\nexport const LoadingButton: React.FC<LoadingButtonProps> = ({ \n  loading,\n  children,\n  loadingText = 'Loading...',\n  className,\n  disabled,\n  ...props\n}) => {\n  return (\n    <button\n      className={cn(\n        'relative',\n        loading && 'cursor-not-allowed opacity-70',\n        className\n      )}\n      disabled={disabled || loading}\n      {...props}\n    >\n      {loading ? (\n        <span className=\"flex items-center justify-center gap-2\">\n          <Spinner size=\"sm\" />\n          <span>{loadingText}</span>\n        </span>\n      ) : (\n        children\n      )}\n    </button>\n  );\n};\n\ninterface ScreenLoadingProps {\n  /** Whether the screen loading is visible */\n  visible: boolean;\n  /** Loading message to display */\n  message?: string;\n  /** Optional icon to show with the loading message */\n  icon?: React.ReactNode;\n  /** Background opacity (0-100) */\n  opacity?: number;\n  /** Additional CSS classes */\n  className?: string;\n}\n\n/**\n * ScreenLoading Component\n * \n * Full-screen loading overlay for page/screen transitions\n * with customizable message and icon\n */\nexport const ScreenLoading: React.FC<ScreenLoadingProps> = ({\n  visible,\n  message = 'Loading...',\n  icon,\n  opacity = 95,\n  className\n}) => {\n  if (!visible) return null;\n\n  return (\n    <div className={cn(\n      'fixed inset-0 z-[100] flex items-center justify-center',\n      'bg-background/90 backdrop-blur-lg',\n      'transition-all duration-500',\n      'animate-in fade-in-0',\n      className\n    )}>\n      <div className={cn(\n        'flex flex-col items-center space-y-6 p-10',\n        'animate-in zoom-in-95 slide-in-from-bottom-4 duration-500'\n      )}>\n        <div className=\"relative\">\n          {icon ? (\n            <div className={cn(\n              'flex items-center justify-center w-20 h-20',\n              'bg-primary/10 rounded-2xl',\n              'shadow-lg shadow-primary/20',\n              'animate-pulse'\n            )}>\n              {icon}\n            </div>\n          ) : (\n            <Spinner size=\"xl\" />\n          )}\n        </div>\n        {message && (\n          <div className=\"text-center space-y-2\">\n            <p className=\"text-lg font-semibold text-foreground\">{message}</p>\n            <LoadingDots size=\"md\" />\n          </div>\n        )}\n      </div>\n    </div>\n  );\n};\n\ninterface PageLoadingProps {\n  /** Whether the page loading is visible */\n  visible: boolean;\n  /** Loading message to display */\n  message?: string;\n  /** Show skeleton content instead of spinner */\n  showSkeleton?: boolean;\n  /** Additional CSS classes */\n  className?: string;\n}\n\n/**\n * PageLoading Component\n * \n * In-page loading state for content areas\n * with optional skeleton loading\n */\nexport const PageLoading: React.FC<PageLoadingProps> = ({\n  visible,\n  message = 'Loading page...',\n  showSkeleton = false,\n  className\n}) => {\n  if (!visible) return null;\n\n  if (showSkeleton) {\n    return (\n      <div className={cn('space-y-4 p-6', className)}>\n        <div className=\"space-y-3\">\n          <Skeleton className=\"h-8 w-1/3\" />\n          <Skeleton className=\"h-4 w-2/3\" />\n          <Skeleton className=\"h-4 w-1/2\" />\n        </div>\n        <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4\">\n          {Array.from({ length: 6 }).map((_, i) => (\n            <div key={i} className=\"space-y-3\">\n              <Skeleton className=\"h-32 w-full rounded-lg\" />\n              <Skeleton className=\"h-4 w-3/4\" />\n              <Skeleton className=\"h-3 w-1/2\" />\n            </div>\n          ))}\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className={cn(\n      'flex flex-col items-center justify-center p-12',\n      className\n    )}>\n      <Spinner size=\"lg\" />\n      <p className=\"mt-4 text-gray-600\">{message}</p>\n    </div>\n  );\n};","\"use client\"\n\nimport * as React from \"react\"\nimport * as TooltipPrimitive from \"@radix-ui/react-tooltip\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst TooltipProvider = TooltipPrimitive.Provider\n\nconst Tooltip = TooltipPrimitive.Root\n\nconst TooltipTrigger = TooltipPrimitive.Trigger\n\nconst TooltipContent = React.forwardRef<\n  React.ElementRef<typeof TooltipPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof TooltipPrimitive.Content>\n>(({ className, sideOffset = 6, ...props }, ref) => (\n  <TooltipPrimitive.Portal>\n    <TooltipPrimitive.Content\n      ref={ref}\n      sideOffset={sideOffset}\n      className={cn(\n        \"z-50 overflow-hidden\",\n        \"rounded-lg px-3.5 py-2\",\n        \"bg-gray-900 dark:bg-gray-100 backdrop-blur-sm\",\n        \"text-xs font-medium text-white dark:text-gray-900\",\n        \"shadow-lg shadow-black/20\",\n        \"border border-gray-800 dark:border-gray-200\",\n        \"animate-in fade-in-0 zoom-in-95\",\n        \"data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=closed]:zoom-out-95\",\n        \"data-[side=bottom]:slide-in-from-top-2\",\n        \"data-[side=left]:slide-in-from-right-2\",\n        \"data-[side=right]:slide-in-from-left-2\",\n        \"data-[side=top]:slide-in-from-bottom-2\",\n        className\n      )}\n      {...props}\n    >\n      {props.children}\n      <TooltipPrimitive.Arrow \n        className=\"fill-gray-900 dark:fill-gray-100\"\n        width={8}\n        height={4}\n      />\n    </TooltipPrimitive.Content>\n  </TooltipPrimitive.Portal>\n))\nTooltipContent.displayName = TooltipPrimitive.Content.displayName\n\nexport { Tooltip, TooltipTrigger, TooltipContent, TooltipProvider }","'use client';\n\nimport React, { useState, useRef, useCallback } from 'react';\nimport { Mic, MicOff, Loader2 } from 'lucide-react';\nimport { toast } from 'sonner';\nimport { Button } from '@/components/ui/button';\nimport { cn } from '@/lib/utils';\nimport { Tooltip, TooltipContent, TooltipProvider, TooltipTrigger } from '@/components/ui/tooltip';\n\ninterface SpeechToTextButtonProps {\n  onTranscription: (text: string) => void;\n  onTranscriptionStart?: () => void;\n  onTranscriptionEnd?: () => void;\n  disabled?: boolean;\n  isMobile?: boolean;\n  className?: string;\n}\n\nexport function SpeechToTextButton({ \n  onTranscription, \n  onTranscriptionStart,\n  onTranscriptionEnd,\n  disabled = false, \n  isMobile = false,\n  className \n}: SpeechToTextButtonProps) {\n  const [isRecording, setIsRecording] = useState(false);\n  const [isProcessing, setIsProcessing] = useState(false);\n  const [recordingDuration, setRecordingDuration] = useState(0);\n  const mediaRecorderRef = useRef<MediaRecorder | null>(null);\n  const audioChunksRef = useRef<Blob[]>([]);\n  const recordingTimeoutRef = useRef<NodeJS.Timeout | null>(null);\n  const durationIntervalRef = useRef<NodeJS.Timeout | null>(null);\n\n  const stopRecording = useCallback(() => {\n    if (mediaRecorderRef.current && mediaRecorderRef.current.state === 'recording') {\n      mediaRecorderRef.current.stop();\n      setIsRecording(false);\n      // Don't call onTranscriptionEnd here - let processAudio handle it\n      \n      if (recordingTimeoutRef.current) {\n        clearTimeout(recordingTimeoutRef.current);\n        recordingTimeoutRef.current = null;\n      }\n      \n      if (durationIntervalRef.current) {\n        clearInterval(durationIntervalRef.current);\n        durationIntervalRef.current = null;\n      }\n      \n      setRecordingDuration(0);\n    }\n  }, []);\n\n  const startRecording = useCallback(async () => {\n    try {\n      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });\n      \n      const mimeType = MediaRecorder.isTypeSupported('audio/webm') \n        ? 'audio/webm' \n        : 'audio/mp4';\n      \n      const mediaRecorder = new MediaRecorder(stream, { mimeType });\n      mediaRecorderRef.current = mediaRecorder;\n      audioChunksRef.current = [];\n\n      mediaRecorder.ondataavailable = (event) => {\n        if (event.data.size > 0) {\n          audioChunksRef.current.push(event.data);\n        }\n      };\n\n      mediaRecorder.onstop = async () => {\n        const audioBlob = new Blob(audioChunksRef.current, { type: mimeType });\n        stream.getTracks().forEach(track => track.stop());\n        \n        // Process the audio\n        await processAudio(audioBlob);\n      };\n\n      mediaRecorder.start();\n      setIsRecording(true);\n      onTranscriptionStart?.();\n      \n      // Start duration timer\n      const startTime = Date.now();\n      durationIntervalRef.current = setInterval(() => {\n        const elapsed = Math.floor((Date.now() - startTime) / 1000);\n        setRecordingDuration(elapsed);\n      }, 100) as any;\n\n      // Auto-stop recording after 30 seconds\n      recordingTimeoutRef.current = setTimeout(() => {\n        stopRecording();\n        toast.info('Recording stopped after 30 seconds');\n      }, 30000);\n\n    } catch (error) {\n      console.error('Error accessing microphone:', error);\n      toast.error('Unable to access microphone. Please check your permissions.');\n      onTranscriptionEnd?.();\n    }\n  }, [stopRecording, onTranscriptionStart, onTranscriptionEnd]);\n\n  const processAudio = async (audioBlob: Blob) => {\n    setIsProcessing(true);\n\n    try {\n      // Convert blob to base64 for sending\n      const reader = new FileReader();\n      reader.readAsDataURL(audioBlob);\n      \n      reader.onloadend = async () => {\n        const base64Audio = reader.result as string;\n        const base64Data = base64Audio.split(',')[1];\n\n        // Check for demo mode and add appropriate headers\n        const headers: Record<string, string> = {\n          'Content-Type': 'application/json',\n        };\n        \n        // Add deployment mode header\n        const deploymentMode = localStorage.getItem('customgpt.deploymentMode') || 'production';\n        headers['X-Deployment-Mode'] = deploymentMode;\n        \n        // In demo mode, add OpenAI key from window object if available\n        if (deploymentMode === 'demo' && (window as any).__demoOpenAIKey) {\n          headers['X-OpenAI-API-Key'] = (window as any).__demoOpenAIKey;\n        }\n\n        const response = await fetch('/api/proxy/voice/transcribe', {\n          method: 'POST',\n          headers,\n          body: JSON.stringify({\n            audio: base64Data,\n            mimeType: audioBlob.type,\n          }),\n        });\n\n        if (!response.ok) {\n          const errorData = await response.json().catch(() => ({ error: 'Transcription failed' }));\n          \n          // Check if it's an OpenAI API key error\n          if (response.status === 500 && errorData.error && errorData.error.includes('OpenAI API key')) {\n            toast.error(errorData.error);\n            throw new Error('OpenAI API key not configured');\n          }\n          \n          throw new Error(errorData.error || 'Transcription failed');\n        }\n\n        const data = await response.json();\n        \n        if (data.text) {\n          onTranscription(data.text);\n          toast.success('Speech transcribed successfully');\n        } else {\n          throw new Error('No transcription received');\n        }\n      };\n\n      reader.onerror = () => {\n        throw new Error('Failed to process audio');\n      };\n\n    } catch (error) {\n      console.error('Transcription error:', error);\n      \n      // Don't show duplicate toast for OpenAI API key error\n      if (error instanceof Error && error.message === 'OpenAI API key not configured') {\n        // Toast already shown above\n      } else if (error instanceof Error && error.message) {\n        toast.error(error.message);\n      } else {\n        toast.error('Failed to transcribe speech. Please try again.');\n      }\n    } finally {\n      setIsProcessing(false);\n      onTranscriptionEnd?.();\n    }\n  };\n\n  const handleClick = () => {\n    if (isRecording) {\n      stopRecording();\n    } else {\n      startRecording();\n    }\n  };\n\n  const isActive = isRecording || isProcessing;\n\n  // Format duration as MM:SS\n  const formatDuration = (seconds: number) => {\n    const mins = Math.floor(seconds / 60);\n    const secs = seconds % 60;\n    return `${mins}:${secs.toString().padStart(2, '0')}`;\n  };\n\n  return (\n    <TooltipProvider>\n      <Tooltip>\n        <TooltipTrigger asChild>\n          <Button\n            type=\"button\"\n            size=\"icon\"\n            variant=\"ghost\"\n            onClick={handleClick}\n            disabled={disabled || isProcessing}\n            className={cn(\n              \"relative text-muted-foreground hover:text-foreground transition-all\",\n              isActive && \"text-red-600 hover:text-red-700\",\n              isRecording && \"animate-pulse bg-red-50 hover:bg-red-100\",\n              className\n            )}\n          >\n            {isProcessing ? (\n              <div className=\"relative\">\n                <Loader2 className={cn(\n                  \"animate-spin\",\n                  isMobile ? \"h-5 w-5\" : \"h-5 w-5\"\n                )} />\n                <span className=\"absolute -bottom-5 left-1/2 -translate-x-1/2 text-[10px] text-muted-foreground whitespace-nowrap\">\n                  Processing...\n                </span>\n              </div>\n            ) : isRecording ? (\n              <div className=\"relative\">\n                <div className=\"absolute inset-0 bg-red-500 rounded-full animate-ping opacity-25\" />\n                <MicOff className={cn(\n                  \"relative z-10\",\n                  isMobile ? \"h-5 w-5\" : \"h-5 w-5\"\n                )} />\n                {/* Recording duration */}\n                {recordingDuration > 0 && (\n                  <span className=\"absolute -bottom-5 left-1/2 -translate-x-1/2 text-[10px] text-red-600 font-medium whitespace-nowrap\">\n                    {formatDuration(recordingDuration)}\n                  </span>\n                )}\n              </div>\n            ) : (\n              <Mic className={cn(isMobile ? \"h-5 w-5\" : \"h-5 w-5\")} />\n            )}\n          </Button>\n        </TooltipTrigger>\n        <TooltipContent>\n          <p>\n            {isProcessing ? 'Processing your speech...' : isRecording ? `Recording... ${formatDuration(recordingDuration)}` : 'Click to start speech-to-text'}\n          </p>\n        </TooltipContent>\n      </Tooltip>\n    </TooltipProvider>\n  );\n}","'use client';\n\nimport { cn } from '@/lib/utils';\n\ninterface AnimatedVoiceIconProps {\n  className?: string;\n  isActive?: boolean;\n  size?: 'sm' | 'md' | 'lg';\n}\n\nexport function AnimatedVoiceIcon({ \n  className, \n  isActive = false,\n  size = 'md' \n}: AnimatedVoiceIconProps) {\n  const sizeClasses = {\n    sm: 'w-5 h-5',\n    md: 'w-6 h-6',\n    lg: 'w-7 h-7'\n  };\n\n  const barHeights = {\n    sm: ['h-2', 'h-3', 'h-2.5', 'h-3', 'h-2'],\n    md: ['h-3', 'h-4', 'h-3.5', 'h-4', 'h-3'],\n    lg: ['h-3.5', 'h-5', 'h-4.5', 'h-5', 'h-3.5']\n  };\n\n  const bars = size === 'sm' ? barHeights.sm : size === 'md' ? barHeights.md : barHeights.lg;\n\n  return (\n    <div className={cn(\n      'flex items-center justify-center',\n      sizeClasses[size],\n      className\n    )}\n    style={{ gap: '2px' }}>\n      {bars.map((height, index) => (\n        <div\n          key={index}\n          className={cn(\n            'rounded-full transition-all duration-300',\n            height,\n            isActive && 'animate-voice-pulse'\n          )}\n          style={{\n            width: size === 'lg' ? '3px' : size === 'md' ? '2.5px' : '2px',\n            animationDelay: isActive ? `${index * 100}ms` : '0ms',\n            background: isActive \n              ? `linear-gradient(to top, \n                  hsl(${260 + index * 20}, 85%, 55%), \n                  hsl(${320 + index * 20}, 85%, 65%))` \n              : `linear-gradient(to top,\n                  hsl(${260 + index * 15}, 80%, 55%),\n                  hsl(${280 + index * 15}, 80%, 65%))`\n          }}\n        />\n      ))}\n    </div>\n  );\n}","\"use client\"\n\nimport * as React from \"react\"\nimport * as DropdownMenuPrimitive from \"@radix-ui/react-dropdown-menu\"\nimport { Check, ChevronRight, Circle } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst DropdownMenu = DropdownMenuPrimitive.Root\n\nconst DropdownMenuTrigger = DropdownMenuPrimitive.Trigger\n\nconst DropdownMenuGroup = DropdownMenuPrimitive.Group\n\nconst DropdownMenuPortal = DropdownMenuPrimitive.Portal\n\nconst DropdownMenuSub = DropdownMenuPrimitive.Sub\n\nconst DropdownMenuRadioGroup = DropdownMenuPrimitive.RadioGroup\n\nconst DropdownMenuSubTrigger = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.SubTrigger>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.SubTrigger> & {\n    inset?: boolean\n  }\n>(({ className, inset, children, ...props }, ref) => (\n  <DropdownMenuPrimitive.SubTrigger\n    ref={ref}\n    className={cn(\n      \"flex cursor-pointer select-none items-center\",\n      \"rounded-md px-3 py-2 text-sm outline-none\",\n      \"transition-all duration-200\",\n      \"hover:bg-accent/80 hover:text-accent-foreground\",\n      \"focus:bg-accent focus:text-accent-foreground\",\n      \"data-[state=open]:bg-accent data-[state=open]:text-accent-foreground\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <ChevronRight className=\"ml-auto h-4 w-4 transition-transform duration-200 data-[state=open]:rotate-90\" />\n  </DropdownMenuPrimitive.SubTrigger>\n))\nDropdownMenuSubTrigger.displayName =\n  DropdownMenuPrimitive.SubTrigger.displayName\n\nconst DropdownMenuSubContent = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.SubContent>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.SubContent>\n>(({ className, ...props }, ref) => (\n  <DropdownMenuPrimitive.SubContent\n    ref={ref}\n    className={cn(\n      \"z-50 min-w-[8rem] overflow-hidden\",\n      \"rounded-lg border border-gray-200/50 dark:border-gray-800/30\",\n      \"bg-background/95 backdrop-blur-md\",\n      \"p-1.5 text-foreground\",\n      \"shadow-lg shadow-black/10\",\n      \"data-[state=open]:animate-in data-[state=closed]:animate-out\",\n      \"data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0\",\n      \"data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95\",\n      \"data-[side=bottom]:slide-in-from-top-2\",\n      \"data-[side=left]:slide-in-from-right-2\",\n      \"data-[side=right]:slide-in-from-left-2\",\n      \"data-[side=top]:slide-in-from-bottom-2\",\n      className\n    )}\n    {...props}\n  />\n))\nDropdownMenuSubContent.displayName =\n  DropdownMenuPrimitive.SubContent.displayName\n\nconst DropdownMenuContent = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Content>\n>(({ className, sideOffset = 6, ...props }, ref) => (\n  <DropdownMenuPrimitive.Portal>\n    <DropdownMenuPrimitive.Content\n      ref={ref}\n      sideOffset={sideOffset}\n      className={cn(\n        \"z-50 min-w-[8rem] overflow-hidden\",\n        \"rounded-lg border border-gray-200/50 dark:border-gray-800/30\",\n        \"bg-background/95 backdrop-blur-md\",\n        \"p-1.5 text-foreground\",\n        \"shadow-lg shadow-black/10\",\n        \"data-[state=open]:animate-in data-[state=closed]:animate-out\",\n        \"data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0\",\n        \"data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95\",\n        \"data-[side=bottom]:slide-in-from-top-2\",\n        \"data-[side=left]:slide-in-from-right-2\",\n        \"data-[side=right]:slide-in-from-left-2\",\n        \"data-[side=top]:slide-in-from-bottom-2\",\n        className\n      )}\n      {...props}\n    />\n  </DropdownMenuPrimitive.Portal>\n))\nDropdownMenuContent.displayName = DropdownMenuPrimitive.Content.displayName\n\nconst DropdownMenuItem = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Item> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <DropdownMenuPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-pointer select-none items-center\",\n      \"rounded-md px-3 py-2 text-sm outline-none\",\n      \"transition-all duration-200\",\n      \"hover:bg-accent/80 hover:text-accent-foreground hover:scale-[0.98]\",\n      \"focus:bg-accent focus:text-accent-foreground\",\n      \"data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      \"active:scale-[0.96]\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nDropdownMenuItem.displayName = DropdownMenuPrimitive.Item.displayName\n\nconst DropdownMenuCheckboxItem = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.CheckboxItem>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.CheckboxItem>\n>(({ className, children, checked, ...props }, ref) => (\n  <DropdownMenuPrimitive.CheckboxItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-pointer select-none items-center\",\n      \"rounded-md py-2 pl-8 pr-3 text-sm outline-none\",\n      \"transition-all duration-200\",\n      \"hover:bg-accent/80 hover:text-accent-foreground\",\n      \"focus:bg-accent focus:text-accent-foreground\",\n      \"data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    checked={checked}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-4 w-4 items-center justify-center\">\n      <DropdownMenuPrimitive.ItemIndicator>\n        <Check className=\"h-3.5 w-3.5 animate-in zoom-in-0 duration-200\" />\n      </DropdownMenuPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </DropdownMenuPrimitive.CheckboxItem>\n))\nDropdownMenuCheckboxItem.displayName =\n  DropdownMenuPrimitive.CheckboxItem.displayName\n\nconst DropdownMenuRadioItem = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.RadioItem>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.RadioItem>\n>(({ className, children, ...props }, ref) => (\n  <DropdownMenuPrimitive.RadioItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-pointer select-none items-center\",\n      \"rounded-md py-2 pl-8 pr-3 text-sm outline-none\",\n      \"transition-all duration-200\",\n      \"hover:bg-accent/80 hover:text-accent-foreground\",\n      \"focus:bg-accent focus:text-accent-foreground\",\n      \"data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-4 w-4 items-center justify-center\">\n      <DropdownMenuPrimitive.ItemIndicator>\n        <Circle className=\"h-2.5 w-2.5 fill-current animate-in zoom-in-0 duration-200\" />\n      </DropdownMenuPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </DropdownMenuPrimitive.RadioItem>\n))\nDropdownMenuRadioItem.displayName = DropdownMenuPrimitive.RadioItem.displayName\n\nconst DropdownMenuLabel = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.Label>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Label> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <DropdownMenuPrimitive.Label\n    ref={ref}\n    className={cn(\n      \"px-3 py-2 text-xs font-semibold\",\n      \"text-muted-foreground uppercase tracking-wider\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nDropdownMenuLabel.displayName = DropdownMenuPrimitive.Label.displayName\n\nconst DropdownMenuSeparator = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <DropdownMenuPrimitive.Separator\n    ref={ref}\n    className={cn(\n      \"-mx-1.5 my-1.5 h-px\",\n      \"bg-gradient-to-r from-transparent via-gray-200/50 dark:via-gray-800/20 to-transparent\",\n      className\n    )}\n    {...props}\n  />\n))\nDropdownMenuSeparator.displayName = DropdownMenuPrimitive.Separator.displayName\n\nconst DropdownMenuShortcut = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLSpanElement>) => {\n  return (\n    <span\n      className={cn(\n        \"ml-auto text-[10px] tracking-widest\",\n        \"text-muted-foreground/70\",\n        \"font-medium uppercase\",\n        \"px-1.5 py-0.5 rounded\",\n        \"bg-muted/50\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\nDropdownMenuShortcut.displayName = \"DropdownMenuShortcut\"\n\nexport {\n  DropdownMenu,\n  DropdownMenuTrigger,\n  DropdownMenuContent,\n  DropdownMenuItem,\n  DropdownMenuCheckboxItem,\n  DropdownMenuRadioItem,\n  DropdownMenuLabel,\n  DropdownMenuSeparator,\n  DropdownMenuShortcut,\n  DropdownMenuGroup,\n  DropdownMenuPortal,\n  DropdownMenuSub,\n  DropdownMenuSubContent,\n  DropdownMenuSubTrigger,\n  DropdownMenuRadioGroup,\n}","/**\n * ChatInput Component\n * \n * Rich input field for sending messages and uploading files.\n * \n * Features:\n * - Auto-expanding textarea (up to 200px height)\n * - File upload with drag-and-drop support\n * - Speech-to-text transcription using OpenAI Whisper\n * - File type and size validation\n * - Progress tracking for uploads\n * - Character count display\n * - Keyboard shortcuts (Enter to send, Shift+Enter for newline)\n * - Animated file chips and drag overlay\n * \n * Customization:\n * - Modify CONSTANTS in utils for file limits\n * - Adjust max textarea height (line 144)\n * - Customize accepted file types\n * - Style the drag overlay and file chips\n */\n\n'use client';\n\nimport React, { useState, useRef, useCallback, KeyboardEvent, FormEvent, useEffect } from 'react';\nimport { useDropzone } from 'react-dropzone';\nimport { motion, AnimatePresence } from 'framer-motion';\nimport { \n  Send, \n  Paperclip, \n  X,\n  Upload,\n  AlertCircle,\n  ChevronDown,\n  Settings,\n  Sparkles,\n  Brain,\n  Zap,\n  MessageSquare,\n  User,\n  Bot,\n  SlidersHorizontal\n} from 'lucide-react';\nimport { toast } from 'sonner';\n\nimport type { InputProps, FileUpload, AgentSettings } from '@/types';\nimport { useDemoModeContext } from '@/contexts/DemoModeContext';\nimport { cn, formatFileSize, getFileIcon, isFileTypeAllowed, generateId, CONSTANTS } from '@/lib/utils';\nimport { Button } from '@/components/ui/button';\nimport { Spinner } from '@/components/ui/loading';\nimport { SpeechToTextButton } from '@/components/voice/SpeechToTextButton';\nimport { AnimatedVoiceIcon } from '@/components/voice/AnimatedVoiceIcon';\nimport {\n  DropdownMenu,\n  DropdownMenuContent,\n  DropdownMenuItem,\n  DropdownMenuTrigger,\n  DropdownMenuSeparator,\n  DropdownMenuLabel,\n} from '@/components/ui/dropdown-menu';\nimport { useAgentStore } from '@/store/agents';\nimport { useChatSettingsStore } from '@/store/chat-settings';\nimport { getClient } from '@/lib/api/client';\n\ninterface FileChipProps {\n  /** File upload object with metadata */\n  file: FileUpload;\n  /** Handler to remove this file */\n  onRemove: () => void;\n}\n\n/**\n * FileChip Component\n * \n * Displays an uploaded or uploading file with:\n * - File icon based on type\n * - Name and size\n * - Upload progress bar\n * - Remove button\n * - Error state indication\n */\nconst FileChip: React.FC<FileChipProps> = ({ file, onRemove }) => {\n  const fileIcon = getFileIcon(file.type);\n  \n  return (\n    <motion.div\n      initial={{ opacity: 0, scale: 0.9 }}\n      animate={{ opacity: 1, scale: 1 }}\n      exit={{ opacity: 0, scale: 0.9 }}\n      className=\"flex items-center gap-2 px-3 py-1.5 bg-muted hover:bg-accent rounded-lg transition-colors\"\n    >\n      <div className=\"text-muted-foreground\">{fileIcon}</div>\n      <div className=\"flex-1 min-w-0\">\n        <div className=\"text-sm font-medium text-foreground truncate\">\n          {file.name}\n        </div>\n        <div className=\"text-xs text-muted-foreground flex items-center gap-2\">\n          <span>{formatFileSize(file.size)}</span>\n          {file.status === 'uploading' && (\n            <>\n              <span></span>\n              <span>{file.progress}%</span>\n            </>\n          )}\n          {file.status === 'error' && (\n            <>\n              <span></span>\n              <span className=\"text-destructive flex items-center gap-1\">\n                <AlertCircle className=\"w-3 h-3\" />\n                Error\n              </span>\n            </>\n          )}\n        </div>\n      </div>\n      \n      {/* Progress Bar */}\n      {file.status === 'uploading' && (\n        <div className=\"absolute bottom-0 left-0 right-0 h-0.5 bg-muted rounded-b\">\n          <div \n            className=\"h-full bg-brand-500 rounded-b transition-all duration-300\"\n            style={{ width: `${file.progress}%` }}\n          />\n        </div>\n      )}\n      \n      <button\n        onClick={onRemove}\n        className=\"p-0.5 rounded hover:bg-accent-foreground/20 transition-colors\"\n        disabled={file.status === 'uploading'}\n      >\n        <X className=\"w-3 h-3 text-muted-foreground\" />\n      </button>\n    </motion.div>\n  );\n};\n\n\n/**\n * FileUploadButton Component\n * \n * Hidden file input with visible button trigger.\n * Accepts multiple files based on ACCEPTED_FILE_TYPES.\n */\ninterface FileUploadButtonProps {\n  /** Handler called when files are selected */\n  onUpload: (files: File[]) => void;\n  /** Whether the button is disabled */\n  disabled?: boolean;\n  /** Mobile optimization mode */\n  isMobile?: boolean;\n}\n\nconst FileUploadButton: React.FC<FileUploadButtonProps> = ({ onUpload, disabled, isMobile = false }) => {\n  const fileInputRef = useRef<HTMLInputElement>(null);\n  \n  const handleClick = () => {\n    fileInputRef.current?.click();\n  };\n  \n  const handleChange = (e: React.ChangeEvent<HTMLInputElement>) => {\n    const files = Array.from(e.target.files || []);\n    if (files.length > 0) {\n      onUpload(files);\n      e.target.value = '';\n    }\n  };\n  \n  return (\n    <>\n      <input\n        ref={fileInputRef}\n        type=\"file\"\n        multiple\n        accept={CONSTANTS.ACCEPTED_FILE_TYPES.join(',')}\n        onChange={handleChange}\n        className=\"hidden\"\n      />\n      <Button\n        type=\"button\"\n        size=\"icon\"\n        variant=\"ghost\"\n        onClick={handleClick}\n        disabled={disabled}\n        className={cn(\n          \"text-muted-foreground hover:text-foreground relative z-10\",\n          isMobile ? \"h-10 w-10 min-w-[40px]\" : \"h-9 w-9\"\n        )}\n        title=\"Upload files\"\n      >\n        <Paperclip className={cn(isMobile ? \"h-5 w-5\" : \"h-4 w-4\")} />\n      </Button>\n    </>\n  );\n};\n\n// Configuration options\nconst RESPONSE_SOURCES = [\n  { value: 'own_content', label: 'Content', description: 'Uses only your uploaded content', icon: MessageSquare },\n  { value: 'openai_content', label: 'AI + Content', description: 'Combines AI knowledge with your content', icon: Brain },\n  { value: 'default', label: 'Default', description: 'Uses the default agent setting', icon: Settings },\n] as const;\n\nconst CHATBOT_MODELS = [\n  { value: 'gpt-4-o', label: 'GPT-4', description: 'Most capable model', icon: Brain, capabilities: ['optimal-choice', 'advanced-reasoning', 'complex-tasks'] },\n  { value: 'gpt-4-1', label: 'GPT-4.1', description: 'Latest GPT-4 version', icon: Sparkles, capabilities: ['optimal-choice', 'advanced-reasoning', 'complex-tasks'] },\n  { value: 'gpt-4o-mini', label: 'GPT-4 Mini', description: 'Faster, good for most tasks', icon: Zap, capabilities: ['fastest-responses', 'optimal-choice'] },\n  { value: 'gpt-4-1-mini', label: 'GPT-4.1 Mini', description: 'Fast and efficient', icon: Zap, capabilities: ['fastest-responses', 'optimal-choice'] },\n  { value: 'claude-3-sonnet', label: 'Claude 3', description: 'Balanced performance', icon: Brain, capabilities: ['optimal-choice', 'advanced-reasoning'] },\n  { value: 'claude-3.5-sonnet', label: 'Claude 3.5', description: 'Advanced reasoning', icon: Sparkles, capabilities: ['optimal-choice', 'advanced-reasoning', 'complex-tasks'] },\n] as const;\n\nconst COMMON_PERSONAS = [\n  { value: 'professional', label: 'Professional', description: 'Formal responses', icon: Bot },\n  { value: 'friendly', label: 'Friendly', description: 'Conversational tone', icon: User },\n  { value: 'technical', label: 'Technical', description: 'Technical explanations', icon: Brain },\n  { value: 'creative', label: 'Creative', description: 'Imaginative responses', icon: Sparkles },\n  { value: 'educator', label: 'Teacher', description: 'Step-by-step guidance', icon: Bot },\n  { value: 'custom', label: 'Custom', description: 'Your own instructions', icon: Settings },\n] as const;\n\nconst AGENT_CAPABILITIES = [\n  { value: 'fastest-responses', label: 'Fastest', description: 'Quick answers', icon: Zap, enterprise: true },\n  { value: 'optimal-choice', label: 'Optimal', description: 'Balanced', icon: Settings, enterprise: false },\n  { value: 'advanced-reasoning', label: 'Advanced', description: 'Complex tasks', icon: Brain, enterprise: true },\n  { value: 'complex-tasks', label: 'Complex Reasoning', description: 'Highest quality', icon: Sparkles, enterprise: true },\n] as const;\n\n/**\n * ChatInput Component - Main Export\n * \n * Complete chat input with message composition and file upload.\n * \n * Props:\n * @param onSend - Handler called with message content and files\n * @param disabled - Disables input during message sending\n * @param placeholder - Placeholder text for the textarea\n * @param maxLength - Maximum message length (default from CONSTANTS)\n * @param className - Additional CSS classes\n * @param onVoiceClick - Handler for voice mode button click\n * \n * State Management:\n * - input: Current message text\n * - files: Array of uploaded/uploading files\n * - isDragOver: Drag-and-drop state\n * \n * @example\n * <ChatInput \n *   onSend={(message, files) => handleSend(message, files)}\n *   disabled={isLoading}\n *   onVoiceClick={() => setVoiceModalOpen(true)}\n * />\n */\nexport const ChatInput: React.FC<InputProps> = ({ \n  onSend,\n  disabled = false,\n  placeholder = \"Send a message...\",\n  maxLength = CONSTANTS.MAX_MESSAGE_LENGTH,\n  className,\n  onVoiceClick,\n  isMobile = false,\n  mode = 'standalone'\n}) => {\n  const [input, setInput] = useState('');\n  const [files, setFiles] = useState<FileUpload[]>([]);\n  const [isTranscribing, setIsTranscribing] = useState(false);\n  const [isLoadingSettings, setIsLoadingSettings] = useState(false);\n  const [showSettings, setShowSettings] = useState(false);\n  const textareaRef = useRef<HTMLTextAreaElement>(null);\n  \n  // Get free trial mode status\n  const { isFreeTrialMode } = useDemoModeContext();\n  \n  // Get stores\n  const { currentAgent } = useAgentStore();\n  const { getSettings, updateSettings: updateLocalSettings } = useChatSettingsStore();\n  \n  // Get settings for current agent\n  const settings = currentAgent?.id ? getSettings(currentAgent.id) : {\n    response_source: 'own_content',\n    chatbot_model: 'gpt-4-o',\n    custom_persona: 'professional',\n    agent_capability: 'optimal-choice',\n  };\n  \n  const loadAgentSettings = useCallback(async () => {\n    if (!currentAgent?.id) return;\n\n    try {\n      const client = getClient();\n      const response = await client.getAgentSettings(currentAgent.id);\n      \n      if (response?.data) {\n        const loadedSettings = {\n          response_source: response.data.response_source || 'own_content',\n          chatbot_model: response.data.chatbot_model || 'gpt-4-o',\n          custom_persona: response.data.custom_persona || 'professional',\n          agent_capability: response.data.agent_capability || 'optimal-choice',\n        };\n        updateLocalSettings(currentAgent.id, loadedSettings);\n      }\n    } catch (error) {\n      console.error('Failed to load agent settings:', error);\n    }\n  }, [currentAgent?.id, updateLocalSettings]);\n\n  // Load settings when agent changes\n  useEffect(() => {\n    if (currentAgent?.id) {\n      loadAgentSettings();\n    }\n  }, [currentAgent?.id, loadAgentSettings]);\n\n  const updateSetting = async (key: keyof AgentSettings, value: string) => {\n    if (!currentAgent?.id) return;\n\n    setIsLoadingSettings(true);\n    try {\n      const client = getClient();\n      let updates: Partial<AgentSettings> = { [key]: value };\n      \n      // If changing capability, check if current model is still valid\n      if (key === 'agent_capability') {\n        const validModels = CHATBOT_MODELS.filter(m => m.capabilities.includes(value as any));\n        const currentModelValid = validModels.some(m => m.value === settings.chatbot_model);\n        \n        if (!currentModelValid && validModels.length > 0) {\n          // Switch to first available model for new capability\n          updates.chatbot_model = validModels[0].value;\n          toast.info(`Model changed to ${validModels[0].label} for ${AGENT_CAPABILITIES.find(c => c.value === value)?.label} mode`);\n        }\n      }\n      \n      await client.updateAgentSettings(currentAgent.id, updates);\n      updateLocalSettings(currentAgent.id, updates);\n      toast.success('Setting updated successfully');\n    } catch (error) {\n      console.error('Failed to update setting:', error);\n      toast.error('Failed to update setting');\n    } finally {\n      setIsLoadingSettings(false);\n    }\n  };\n  \n  /**\n   * Auto-resize textarea based on content\n   * Grows up to maxHeight (200px) then scrolls\n   */\n  const adjustTextareaHeight = useCallback(() => {\n    const textarea = textareaRef.current;\n    if (textarea) {\n      textarea.style.height = 'auto';\n      const scrollHeight = textarea.scrollHeight;\n      const maxHeight = 200; // Max height in pixels - customize as needed\n      textarea.style.height = `${Math.min(scrollHeight, maxHeight)}px`;\n    }\n  }, []);\n  \n  // Handle text input changes\n  const handleInputChange = (e: React.ChangeEvent<HTMLTextAreaElement>) => {\n    const value = e.target.value;\n    if (value.length <= maxLength) {\n      setInput(value);\n      adjustTextareaHeight();\n    }\n  };\n  \n  // Handle key presses\n  const handleKeyDown = (e: KeyboardEvent<HTMLTextAreaElement>) => {\n    if (e.key === 'Enter' && !e.shiftKey) {\n      e.preventDefault();\n      handleSubmit(e as any);\n    }\n  };\n  \n  // Handle form submission\n  const handleSubmit = (e: FormEvent) => {\n    e.preventDefault();\n    \n    if (disabled) return;\n    if (!input.trim() && files.length === 0) return;\n    \n    // Convert FileUpload objects to File objects\n    const fileObjects = files\n      .filter(f => f.status === 'uploaded')\n      .map(f => f.file); // Use the actual File object\n    \n    onSend(input.trim(), fileObjects);\n    \n    // Reset form\n    setInput('');\n    setFiles([]);\n    \n    // Reset textarea height\n    if (textareaRef.current) {\n      textareaRef.current.style.height = 'auto';\n    }\n    \n    // Focus textarea\n    setTimeout(() => {\n      textareaRef.current?.focus();\n    }, 0);\n  };\n  \n  /**\n   * Handle file uploads with validation\n   * Checks file size and type before accepting\n   * Shows toast notifications for validation errors\n   */\n  const handleFileUpload = useCallback((newFiles: File[]) => {\n    const validFiles = newFiles.filter(file => {\n      // Check file size against MAX_FILE_SIZE constant\n      if (file.size > CONSTANTS.MAX_FILE_SIZE) {\n        toast.error(`File \"${file.name}\" is too large. Maximum size is ${formatFileSize(CONSTANTS.MAX_FILE_SIZE)}`);\n        return false;\n      }\n      \n      // Check file type against ACCEPTED_FILE_TYPES\n      if (!isFileTypeAllowed(file.type, CONSTANTS.ACCEPTED_FILE_TYPES)) {\n        toast.error(`File type \"${file.type}\" is not supported`);\n        return false;\n      }\n      \n      return true;\n    });\n    \n    const uploadFiles: FileUpload[] = validFiles.map(file => ({\n      id: generateId(),\n      name: file.name,\n      size: file.size,\n      type: file.type,\n      status: 'uploading',\n      progress: 0,\n      file: file, // Store the actual File object\n    }));\n    \n    setFiles(prev => [...prev, ...uploadFiles]);\n    \n    // Simulate file upload\n    uploadFiles.forEach(uploadFile => {\n      simulateUpload(uploadFile);\n    });\n    \n  }, []);\n  \n  /**\n   * Simulate file upload progress\n   * In production, replace with actual upload logic\n   * Updates progress in 100ms intervals\n   */\n  const simulateUpload = (uploadFile: FileUpload) => {\n    let progress = 0;\n    const interval = setInterval(() => {\n      progress += Math.random() * 20;\n      \n      if (progress >= 100) {\n        progress = 100;\n        clearInterval(interval);\n        \n        // Mark file as uploaded\n        setFiles(prev => prev.map(f => \n          f.id === uploadFile.id \n            ? { ...f, status: 'uploaded' as const, progress: 100 }\n            : f\n        ));\n      } else {\n        // Update progress\n        setFiles(prev => prev.map(f => \n          f.id === uploadFile.id \n            ? { ...f, progress: Math.round(progress) }\n            : f\n        ));\n      }\n    }, 100);\n  };\n  \n  // Remove file\n  const removeFile = (fileId: string) => {\n    setFiles(prev => prev.filter(f => f.id !== fileId));\n  };\n  \n  /**\n   * Dropzone configuration for drag-and-drop\n   * - Accepts files based on ACCEPTED_FILE_TYPES\n   * - Validates file size\n   * - Shows overlay on drag\n   * - Disabled click/keyboard to use custom button\n   */\n  const { getRootProps, getInputProps, isDragActive } = useDropzone({\n    onDrop: handleFileUpload,\n    noClick: true, // Use custom button instead\n    noKeyboard: true,\n    accept: CONSTANTS.ACCEPTED_FILE_TYPES.reduce((acc, type) => {\n      acc[type] = [];\n      return acc;\n    }, {} as Record<string, string[]>),\n    maxSize: CONSTANTS.MAX_FILE_SIZE,\n  });\n  \n  const canSend = !disabled && (input.trim() || files.some(f => f.status === 'uploaded'));\n  \n  // Handle speech-to-text transcription\n  const handleTranscription = useCallback((text: string) => {\n    setInput(prevInput => {\n      const newInput = prevInput ? `${prevInput} ${text}` : text;\n      return newInput.length <= maxLength ? newInput : prevInput;\n    });\n    \n    // Adjust textarea height after updating text\n    setTimeout(() => {\n      adjustTextareaHeight();\n    }, 0);\n  }, [maxLength, adjustTextareaHeight]);\n  \n  // Handle transcription start\n  const handleTranscriptionStart = useCallback(() => {\n    setIsTranscribing(true);\n  }, []);\n  \n  // Handle transcription end\n  const handleTranscriptionEnd = useCallback(() => {\n    setIsTranscribing(false);\n  }, []);\n  \n  return (\n    <div \n      {...getRootProps()}\n      className={cn(\n        'relative',\n        isDragActive && 'bg-brand-50',\n        className\n      )}\n    >\n      <input {...getInputProps()} />\n      \n      {/* Drag Overlay */}\n      <AnimatePresence>\n        {isDragActive && (\n          <motion.div\n            initial={{ opacity: 0 }}\n            animate={{ opacity: 1 }}\n            exit={{ opacity: 0 }}\n            className=\"absolute inset-0 bg-brand-50 border-2 border-dashed border-brand-300 rounded-lg flex items-center justify-center z-10\"\n          >\n            <div className=\"text-center\">\n              <Upload className=\"w-8 h-8 text-brand-600 mx-auto mb-2\" />\n              <p className=\"text-brand-700 font-medium\">Drop files here to upload</p>\n              <p className=\"text-brand-600 text-sm\">\n                Supports PDF, DOC, TXT, and more\n              </p>\n            </div>\n          </motion.div>\n        )}\n      </AnimatePresence>\n      \n      {/* File Preview */}\n      <AnimatePresence>\n        {files.length > 0 && (\n          <motion.div\n            initial={{ opacity: 0, height: 0 }}\n            animate={{ opacity: 1, height: 'auto' }}\n            exit={{ opacity: 0, height: 0 }}\n            className=\"px-4 pt-3 pb-2 flex flex-wrap gap-2\"\n          >\n            {files.map((file) => (\n              <FileChip\n                key={file.id}\n                file={file}\n                onRemove={() => removeFile(file.id)}\n              />\n            ))}\n          </motion.div>\n        )}\n      </AnimatePresence>\n      \n      {/* Main Input Container */}\n      <div className={cn(\n        \"mx-4 my-3 bg-background border border-border rounded-2xl shadow-sm\",\n        \"focus-within:ring-2 focus-within:ring-brand-500 focus-within:border-transparent transition-all\"\n      )}>\n        {/* Text Input Area */}\n        <form onSubmit={handleSubmit} className=\"relative\">\n          <div className=\"flex items-center p-3 pb-1\">\n            {/* File Upload Button - Hidden in free trial mode and widget/floating modes */}\n            {!isFreeTrialMode && mode === 'standalone' && (\n              <FileUploadButton\n                onUpload={handleFileUpload}\n                disabled={disabled}\n                isMobile={isMobile}\n              />\n            )}\n            \n            {/* Speech to Text Button - Hidden in widget/floating modes */}\n            {mode === 'standalone' && (\n              <SpeechToTextButton\n                onTranscription={handleTranscription}\n                onTranscriptionStart={handleTranscriptionStart}\n                onTranscriptionEnd={handleTranscriptionEnd}\n                disabled={disabled}\n                isMobile={isMobile}\n                className={cn(\n                  \"!h-8 !w-8 !min-w-0 mr-2\",\n                  isMobile && \"!h-9 !w-9\"\n                )}\n              />\n            )}\n            \n            {/* Textarea */}\n            <div className=\"flex-1 relative\">\n              <textarea\n                ref={textareaRef}\n                value={input}\n                onChange={handleInputChange}\n                onKeyDown={handleKeyDown}\n                placeholder={isTranscribing ? '' : placeholder}\n                disabled={disabled}\n                rows={1}\n                className={cn(\n                  'w-full resize-none bg-transparent border-0',\n                  'focus:outline-none focus:ring-0',\n                  'disabled:opacity-50 disabled:cursor-not-allowed',\n                  'placeholder:text-muted-foreground text-foreground',\n                  isMobile \n                    ? 'text-base min-h-[24px] max-h-[120px] placeholder:text-sm' \n                    : 'text-sm min-h-[20px] max-h-[200px]'\n                )}\n                style={{\n                  height: 'auto',\n                  overflowY: input.split('\\n').length > 5 ? 'auto' : 'hidden',\n                }}\n              />\n              \n              {/* Transcribing Animation */}\n              {isTranscribing && !input && (\n                <div className=\"absolute top-0 left-0 right-0 bottom-0 flex items-center pointer-events-none\">\n                  <span className={cn(\n                    \"text-muted-foreground animate-pulse\",\n                    isMobile ? \"text-base\" : \"text-sm\"\n                  )}>\n                    Transcribing\n                    <span className=\"inline-flex\">\n                      <span className=\"animate-bounce\" style={{ animationDelay: '0ms' }}>.</span>\n                      <span className=\"animate-bounce\" style={{ animationDelay: '150ms' }}>.</span>\n                      <span className=\"animate-bounce\" style={{ animationDelay: '300ms' }}>.</span>\n                    </span>\n                  </span>\n                </div>\n              )}\n            </div>\n            \n            {/* Character Count */}\n            {input.length > 0 && (\n              <div className={cn(\n                \"text-xs text-muted-foreground mr-2\",\n                isMobile ? \"text-xs\" : \"text-xs\"\n              )}>\n                {input.length}/{maxLength}\n              </div>\n            )}\n            \n            {/* Action Buttons */}\n            <div className=\"flex items-center gap-1\">\n              {/* Voice Button - Hidden in widget/floating modes */}\n              {onVoiceClick && mode === 'standalone' && (\n                <Button\n                  type=\"button\"\n                  size=\"icon\"\n                  variant=\"ghost\"\n                  onClick={onVoiceClick}\n                  disabled={disabled}\n                  className={cn(\n                    'relative group transition-all duration-200',\n                    'bg-gradient-to-br from-purple-500/10 to-pink-500/10',\n                    'hover:from-purple-500/20 hover:to-pink-500/20',\n                    'border border-purple-500/20 hover:border-purple-500/40',\n                    'shadow-sm hover:shadow-md',\n                    isMobile ? 'h-10 w-10' : 'h-9 w-9'\n                  )}\n                  title=\"Voice mode\"\n                >\n                  <div className=\"absolute inset-0 rounded-md bg-gradient-to-br from-purple-600/5 to-pink-600/5 opacity-0 group-hover:opacity-100 transition-opacity\" />\n                  <AnimatedVoiceIcon \n                    size={isMobile ? 'lg' : 'md'} \n                    isActive={false}\n                    className=\"relative z-10\"\n                  />\n                </Button>\n              )}\n              \n              {/* Send Button */}\n              <Button\n                type=\"submit\"\n                size=\"icon\"\n                disabled={!canSend}\n                className={cn(\n                  'transition-all duration-200 group',\n                  'bg-brand-500 hover:bg-brand-600 active:bg-brand-700',\n                  'text-white shadow-sm hover:shadow-md',\n                  'disabled:opacity-50 disabled:cursor-not-allowed',\n                  'disabled:hover:bg-brand-500 disabled:hover:shadow-sm',\n                  isMobile ? 'h-10 w-10' : 'h-9 w-9'\n                )}\n                title={disabled ? 'Sending message...' : 'Send message'}\n              >\n                {disabled ? (\n                  <Spinner size=\"sm\" className=\"text-white\" />\n                ) : (\n                  <Send className={cn(\n                    \"transition-transform duration-200 group-hover:translate-x-0.5 group-hover:-translate-y-0.5\",\n                    isMobile ? \"h-5 w-5\" : \"h-4 w-4\"\n                  )} />\n                )}\n              </Button>\n            </div>\n          </div>\n        </form>\n        \n        {/* Settings Toggle Button - Hidden in widget/floating modes */}\n        {mode === 'standalone' && (\n          <div className=\"border-t border-gray-200/50 dark:border-gray-800/30\">\n            <Button\n              variant=\"ghost\"\n              size=\"sm\"\n              onClick={() => setShowSettings(!showSettings)}\n              className={cn(\n                \"flex items-center gap-2 text-xs\",\n                isMobile ? \"w-full justify-center h-9 px-3 py-2\" : \"w-auto justify-start h-8 px-3 py-1.5\",\n                \"hover:bg-accent/50 transition-all duration-200\",\n                showSettings && \"bg-accent/30\"\n              )}\n              title=\"Customize chat settings including response source, AI model, and persona\"\n            >\n              <SlidersHorizontal className={cn(\n                \"transition-colors\",\n                showSettings ? \"text-brand-500\" : \"text-muted-foreground\",\n                isMobile ? \"h-4 w-4\" : \"h-3.5 w-3.5\"\n              )} />\n              <span className={cn(\n                \"font-medium text-muted-foreground\",\n                showSettings && \"text-brand-600\"\n              )}>Customize Chat</span>\n              <ChevronDown className={cn(\n                \"h-3 w-3 opacity-50 transition-transform duration-200\",\n                showSettings && \"rotate-180\"\n              )} />\n            </Button>\n          \n          {/* Expandable Settings Panel */}\n          <AnimatePresence>\n            {showSettings && (\n              <motion.div\n                initial={{ height: 0, opacity: 0 }}\n                animate={{ height: \"auto\", opacity: 1 }}\n                exit={{ height: 0, opacity: 0 }}\n                transition={{ duration: 0.2 }}\n                className=\"overflow-hidden bg-accent/20\"\n              >\n                <div className={cn(\n                  \"flex items-center border-t border-gray-200/50 dark:border-gray-800/30\",\n                  isMobile \n                    ? \"justify-between px-2 pb-2 pt-2\" \n                    : \"gap-2 px-3 pb-2.5 pt-2.5\"\n                )}>\n                  {/* Response Source */}\n                  <DropdownMenu>\n          <DropdownMenuTrigger asChild>\n            <Button\n              variant=\"ghost\"\n              size=\"sm\"\n              className={cn(\n                \"text-xs flex items-center justify-center\",\n                isMobile ? \"h-8 flex-1 gap-4 px-1\" : \"h-7 px-2.5 gap-1.5\"\n              )}\n              disabled={isLoadingSettings}\n            >\n              <MessageSquare className={cn(\"text-muted-foreground\", isMobile ? \"h-3 w-3\" : \"h-3.5 w-3.5\")} />\n              <span className=\"font-medium text-muted-foreground\">Source</span>\n              {!isMobile && <ChevronDown className=\"h-3 w-3 opacity-50\" />}\n            </Button>\n          </DropdownMenuTrigger>\n          <DropdownMenuContent align=\"start\" className=\"w-64\">\n            <DropdownMenuLabel className=\"text-xs\">RESPONSE SOURCE</DropdownMenuLabel>\n            <DropdownMenuSeparator />\n            {RESPONSE_SOURCES.map((source) => {\n              const Icon = source.icon;\n              return (\n                <DropdownMenuItem\n                  key={source.value}\n                  onClick={() => updateSetting('response_source', source.value)}\n                  className=\"flex flex-col items-start py-1.5\"\n                >\n                  <div className=\"flex items-center gap-2\">\n                    <Icon className=\"h-3.5 w-3.5\" />\n                    <span className=\"text-sm font-medium\">{source.label}</span>\n                    {settings.response_source === source.value && (\n                      <span className=\"text-xs text-brand-600\"></span>\n                    )}\n                  </div>\n                  <span className=\"text-xs text-muted-foreground ml-5\">{source.description}</span>\n                </DropdownMenuItem>\n              );\n            })}\n          </DropdownMenuContent>\n        </DropdownMenu>\n\n        {/* Model Selection */}\n        <DropdownMenu>\n          <DropdownMenuTrigger asChild>\n            <Button\n              variant=\"ghost\"\n              size=\"sm\"\n              className={cn(\n                \"text-xs flex items-center justify-center\",\n                isMobile ? \"h-8 flex-1 gap-2 px-1\" : \"h-7 px-2.5 gap-1.5\"\n              )}\n              disabled={isLoadingSettings}\n            >\n              <Brain className={cn(\"text-muted-foreground\", isMobile ? \"h-3 w-3\" : \"h-3.5 w-3.5\")} />\n              <span className=\"font-medium text-muted-foreground\">Model</span>\n              {!isMobile && <ChevronDown className=\"h-3 w-3 opacity-50\" />}\n            </Button>\n          </DropdownMenuTrigger>\n          <DropdownMenuContent align=\"center\" className=\"w-72\">\n            <DropdownMenuLabel className=\"text-xs\">AI MODEL</DropdownMenuLabel>\n            <DropdownMenuSeparator />\n            {CHATBOT_MODELS\n              .filter((model) => settings.agent_capability && model.capabilities.includes(settings.agent_capability as any))\n              .map((model) => {\n                const Icon = model.icon;\n                return (\n                  <DropdownMenuItem\n                    key={model.value}\n                    onClick={() => updateSetting('chatbot_model', model.value)}\n                    className=\"flex flex-col items-start py-1.5\"\n                  >\n                    <div className=\"flex items-center gap-2\">\n                      <Icon className=\"h-3.5 w-3.5\" />\n                      <span className=\"text-sm font-medium\">{model.label}</span>\n                      {settings.chatbot_model === model.value && (\n                        <span className=\"text-xs text-brand-600\"></span>\n                      )}\n                    </div>\n                    <span className=\"text-xs text-muted-foreground ml-5\">{model.description}</span>\n                  </DropdownMenuItem>\n                );\n              })}\n          </DropdownMenuContent>\n        </DropdownMenu>\n\n        {/* Persona Selection */}\n        <DropdownMenu>\n          <DropdownMenuTrigger asChild>\n            <Button\n              variant=\"ghost\"\n              size=\"sm\"\n              className={cn(\n                \"text-xs flex items-center justify-center\",\n                isMobile ? \"h-8 flex-1 gap-2 px-1\" : \"h-7 px-2.5 gap-1.5\"\n              )}\n              disabled={isLoadingSettings}\n            >\n              <User className={cn(\"text-muted-foreground\", isMobile ? \"h-3 w-3\" : \"h-3.5 w-3.5\")} />\n              <span className=\"font-medium text-muted-foreground\">Persona</span>\n              {!isMobile && <ChevronDown className=\"h-3 w-3 opacity-50\" />}\n            </Button>\n          </DropdownMenuTrigger>\n          <DropdownMenuContent align=\"center\" className=\"w-64\">\n            <DropdownMenuLabel className=\"text-xs\">ASSISTANT PERSONA</DropdownMenuLabel>\n            <DropdownMenuSeparator />\n            {COMMON_PERSONAS.map((persona) => {\n              const Icon = persona.icon;\n              return (\n                <DropdownMenuItem\n                  key={persona.value}\n                  onClick={() => updateSetting('custom_persona', persona.value)}\n                  className=\"flex flex-col items-start py-1.5\"\n                >\n                  <div className=\"flex items-center gap-2\">\n                    <Icon className=\"h-3.5 w-3.5\" />\n                    <span className=\"text-sm font-medium\">{persona.label}</span>\n                    {settings.custom_persona === persona.value && (\n                      <span className=\"text-xs text-brand-600\"></span>\n                    )}\n                  </div>\n                  <span className=\"text-xs text-muted-foreground ml-5\">{persona.description}</span>\n                </DropdownMenuItem>\n              );\n            })}\n          </DropdownMenuContent>\n        </DropdownMenu>\n\n        {/* Agent Capability */}\n        <DropdownMenu>\n          <DropdownMenuTrigger asChild>\n            <Button\n              variant=\"ghost\"\n              size=\"sm\"\n              className={cn(\n                \"text-xs flex items-center justify-center\",\n                isMobile ? \"h-8 flex-1 gap-2 px-1\" : \"h-7 px-2.5 gap-1.5\"\n              )}\n              disabled={isLoadingSettings}\n            >\n              <Settings className={cn(\"text-muted-foreground\", isMobile ? \"h-3 w-3\" : \"h-3.5 w-3.5\")} />\n              <span className=\"font-medium text-muted-foreground\">Mode</span>\n              {!isMobile && <ChevronDown className=\"h-3 w-3 opacity-50\" />}\n            </Button>\n          </DropdownMenuTrigger>\n          <DropdownMenuContent align=\"end\" className=\"w-72\">\n            <DropdownMenuLabel className=\"text-xs\">RESPONSE MODE</DropdownMenuLabel>\n            <DropdownMenuSeparator />\n            {AGENT_CAPABILITIES.map((capability) => {\n              const Icon = capability.icon;\n              return (\n                <DropdownMenuItem\n                  key={capability.value}\n                  onClick={() => updateSetting('agent_capability', capability.value)}\n                  className=\"flex flex-col items-start py-1.5\"\n                >\n                  <div className=\"flex items-center gap-2\">\n                    <Icon className=\"h-3.5 w-3.5\" />\n                    <span className=\"text-sm font-medium\">{capability.label}</span>\n                    {capability.enterprise && (\n                      <span className=\"text-[10px] bg-muted text-muted-foreground px-1 py-0.5 rounded\">Enterprise only</span>\n                    )}\n                    {settings.agent_capability === capability.value && (\n                      <span className=\"text-xs text-brand-600\"></span>\n                    )}\n                  </div>\n                  <span className=\"text-xs text-muted-foreground ml-5\">{capability.description}</span>\n                </DropdownMenuItem>\n              );\n            })}\n          </DropdownMenuContent>\n        </DropdownMenu>\n                </div>\n              </motion.div>\n            )}\n          </AnimatePresence>\n        </div>\n        )}\n      </div>\n      \n      {/* Input Hints - Below configuration options */}\n      {!isMobile && (\n        <div className=\"px-4 pb-3 text-xs text-muted-foreground\">\n          <span>Press Enter to send, Shift+Enter for new line</span>\n        </div>\n      )}\n    </div>\n  );\n};","/**\n * Typing Indicator Component\n * \n * Shows animated typing indicator when AI is generating a response.\n * Provides visual feedback that the system is processing.\n * \n * Features:\n * - Three-dot bouncing animation\n * - AI avatar display\n * - Staggered animation delays\n * - Consistent styling with messages\n * - Subtle bounce effect\n * \n * Animation:\n * - Uses CSS animations defined in globals.css\n * - animate-bounce-subtle class for smooth motion\n * - Staggered delays (0ms, 100ms, 200ms)\n * - Creates wave-like effect\n * \n * Design:\n * - Matches message component layout\n * - Gray background for distinction\n * - Centered in chat container\n * - Responsive max-width\n * \n * Features:\n * - Multiple animation styles for enhanced visual feedback\n * - Contextual status messages for different AI processing states\n * - Progress indicators with time estimation for long operations\n * - Professional avatar customization with brand consistency\n * - Advanced loading patterns including skeleton alternatives\n */\n\n'use client';\n\nimport React from 'react';\nimport { Bot } from 'lucide-react';\nimport { cn } from '@/lib/utils';\n\n/**\n * Props for TypingIndicator\n * \n * @property className - Additional CSS classes for styling\n */\ninterface TypingIndicatorProps {\n  className?: string;\n}\n\n/**\n * Typing Indicator Component\n * \n * Displays animated dots to indicate AI is typing/processing.\n * Maintains visual consistency with message components.\n */\nexport const TypingIndicator: React.FC<TypingIndicatorProps> = ({ className }) => {\n  return (\n    <div className={cn(\n      'px-4 py-6 bg-muted border-y border-border',\n      className\n    )}>\n      <div className=\"max-w-3xl mx-auto flex gap-4\">\n        {/* Avatar */}\n        <div className=\"w-8 h-8 rounded-full bg-background border border-border flex items-center justify-center flex-shrink-0\">\n          <Bot className=\"w-4 h-4 text-brand-600\" />\n        </div>\n        \n        {/* Typing Animation */}\n        <div className=\"flex items-center gap-1 py-2\">\n          <div className=\"w-2 h-2 bg-muted-foreground rounded-full animate-bounce-subtle\" />\n          <div className=\"w-2 h-2 bg-muted-foreground rounded-full animate-bounce-subtle delay-100\" />\n          <div className=\"w-2 h-2 bg-muted-foreground rounded-full animate-bounce-subtle delay-200\" />\n        </div>\n      </div>\n    </div>\n  );\n};","/**\n * Agent Selector Component\n * \n * Dropdown selector for switching between different CustomGPT agents.\n * Displays the current agent and allows users to select from available agents.\n * \n * Features:\n * - Current agent display with avatar\n * - Dropdown list of all available agents\n * - Agent metadata display (model, status)\n * - Quick settings access per agent\n * - Refresh agents functionality\n * - Loading and error states\n * - Click-outside-to-close behavior\n * - Smooth animations\n * \n * State Management:\n * - Uses agentStore for agent data\n * - Local state for dropdown open/close\n * - Automatic agent fetching on dropdown open\n * \n * UI/UX:\n * - Visual selection indicator (checkmark)\n * - Hover states for better interactivity\n * - Loading skeleton for initial load\n * - Error state with retry option\n * - Empty state guidance\n * \n * Features:\n * - Comprehensive agent selection with real-time filtering\n * - Intelligent agent management with favorites and categories\n * - Quick agent creation workflow integration\n * - Professional avatar display with status indicators\n * - Full keyboard navigation and accessibility support\n */\n\n'use client';\n\nimport React, { useState, useRef, useEffect } from 'react';\nimport { motion, AnimatePresence } from 'framer-motion';\nimport { \n  Bot, \n  ChevronDown, \n  Settings, \n  RefreshCw,\n  AlertCircle,\n  Check,\n  BarChart3,\n  User\n} from 'lucide-react';\nimport { toast } from 'sonner';\n\nimport type { Agent } from '@/types';\nimport { cn } from '@/lib/utils';\nimport { Button } from '@/components/ui/button';\nimport { useAgentStore } from '@/store';\nimport { Spinner } from '@/components/ui/loading';\nimport { getClient } from '@/lib/api/client';\n\n/**\n * Props for AgentSelector component\n * \n * @property className - Additional CSS classes\n * @property showSettings - Whether to show settings button for each agent\n * @property onSettingsClick - Callback when settings button is clicked\n */\ninterface AgentSelectorProps {\n  className?: string;\n  showSettings?: boolean;\n  onSettingsClick?: (agent: Agent) => void;\n}\n\n/**\n * Props for agent avatar component\n */\ninterface AgentAvatarProps {\n  agent: Agent | null;\n  size?: 'sm' | 'md';\n  isSelected?: boolean;\n  className?: string;\n}\n\n/**\n * Props for individual agent item in dropdown\n * \n * @property agent - Agent data object\n * @property isSelected - Whether this agent is currently selected\n * @property onSelect - Callback when agent is selected\n * @property onSettingsClick - Optional callback for settings button\n */\ninterface AgentItemProps {\n  agent: Agent;\n  isSelected: boolean;\n  onSelect: (agent: Agent) => void;\n  onSettingsClick?: (agent: Agent) => void;\n}\n\n/**\n * Agent Avatar Component\n * \n * Displays agent avatar with fallback to default icon\n */\nconst AgentAvatar: React.FC<AgentAvatarProps> = ({ \n  agent, \n  size = 'md', \n  isSelected = false, \n  className \n}) => {\n  const sizeClasses = {\n    sm: 'w-6 h-6',\n    md: 'w-8 h-8'\n  };\n  \n  const iconSizeClasses = {\n    sm: 'w-3 h-3',\n    md: 'w-4 h-4'\n  };\n\n  const avatarUrl = agent?.settings?.chatbot_avatar;\n\n  return (\n    <div className={cn(\n      'rounded-full flex items-center justify-center flex-shrink-0 overflow-hidden',\n      sizeClasses[size],\n      isSelected ? 'bg-brand-600' : 'bg-accent',\n      className\n    )}>\n      {avatarUrl ? (\n        <img\n          src={avatarUrl}\n          alt={`${agent?.project_name} avatar`}\n          className=\"w-full h-full object-cover\"\n          onError={(e) => {\n            // Fallback to icon if image fails to load\n            const target = e.target as HTMLImageElement;\n            target.style.display = 'none';\n            const parent = target.parentElement;\n            if (parent) {\n              const icon = document.createElement('div');\n              icon.className = `w-full h-full flex items-center justify-center`;\n              icon.innerHTML = `<svg class=\"${iconSizeClasses[size]} ${isSelected ? 'text-white' : 'text-gray-600'}\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\"><path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z\"></path></svg>`;\n              parent.appendChild(icon);\n            }\n          }}\n        />\n      ) : (\n        <User className={cn(\n          iconSizeClasses[size],\n          isSelected ? 'text-white' : 'text-muted-foreground'\n        )} />\n      )}\n    </div>\n  );\n};\n\n/**\n * Individual Agent Item Component\n * \n * Renders a single agent in the dropdown list with:\n * - Agent avatar and name\n * - Selection indicator\n * - Metadata (model, status)\n * - Settings button (optional)\n */\nconst AgentItem: React.FC<AgentItemProps> = ({ \n  agent, \n  isSelected, \n  onSelect, \n  onSettingsClick \n}) => {\n  return (\n    <div\n      className={cn(\n        'flex items-center justify-between p-3 rounded-lg cursor-pointer transition-colors group',\n        'hover:bg-accent',\n        isSelected && 'bg-brand-50 hover:bg-brand-100'\n      )}\n      onClick={() => onSelect(agent)}\n    >\n      <div className=\"flex items-center gap-3 flex-1 min-w-0\">\n        {/* Avatar */}\n        <AgentAvatar \n          agent={agent}\n          size=\"md\"\n          isSelected={isSelected}\n        />\n        \n        {/* Agent Info */}\n        <div className=\"flex-1 min-w-0\">\n          <div className=\"flex items-center gap-2\">\n            <h3 className=\"font-medium text-foreground truncate\">\n              {agent.project_name}\n            </h3>\n            {isSelected && (\n              <Check className=\"w-4 h-4 text-brand-600 flex-shrink-0\" />\n            )}\n          </div>\n          \n          {/* Status */}\n          <div className=\"mt-1 text-xs text-muted-foreground\">\n            <span>Status: {agent.is_chat_active ? 'Active' : 'Inactive'}</span>\n          </div>\n        </div>\n      </div>\n      \n      {/* Settings Button */}\n      {onSettingsClick && (\n        <Button\n          size=\"icon\"\n          variant=\"ghost\"\n          onClick={(e) => {\n            e.stopPropagation();\n            onSettingsClick(agent);\n          }}\n          className=\"opacity-0 group-hover:opacity-100 transition-opacity h-6 w-6 text-muted-foreground hover:text-foreground\"\n          title=\"Agent Settings\"\n        >\n          <Settings className=\"h-3 w-3\" />\n        </Button>\n      )}\n    </div>\n  );\n};\n\n/**\n * Agent Selector Component\n * \n * Main component that provides agent switching functionality.\n * Manages dropdown state and handles agent selection.\n * \n * @param className - Additional CSS classes for styling\n * @param showSettings - Whether to show settings buttons (default: true)\n * @param onSettingsClick - Handler for agent settings clicks\n */\nexport const AgentSelector: React.FC<AgentSelectorProps> = ({ \n  className,\n  showSettings = true,\n  onSettingsClick\n}) => {\n  const [isOpen, setIsOpen] = useState(false);\n  const [isSelectingAgent, setIsSelectingAgent] = useState(false);\n  const [loadingSettings, setLoadingSettings] = useState<Set<number>>(new Set());\n  const dropdownRef = useRef<HTMLDivElement>(null);\n  \n  const { \n    agents, \n    currentAgent, \n    loading, \n    error, \n    fetchAgents, \n    loadMoreAgents,\n    selectAgent,\n    setAgents,\n    paginationMeta\n  } = useAgentStore();\n\n  /**\n   * Fetch settings for agents that don't have them loaded\n   */\n  const fetchAgentSettings = async (agentsToLoad: Agent[]) => {\n    const agentsNeedingSettings = agentsToLoad.filter(agent => \n      !agent.settings && !loadingSettings.has(agent.id)\n    );\n\n    if (agentsNeedingSettings.length === 0) return;\n\n    // Mark agents as loading\n    setLoadingSettings(prev => {\n      const newSet = new Set(prev);\n      agentsNeedingSettings.forEach(agent => newSet.add(agent.id));\n      return newSet;\n    });\n\n    try {\n      const client = getClient();\n      const settingsPromises = agentsNeedingSettings.map(async (agent) => {\n        try {\n          const response = await client.getAgentSettings(agent.id);\n          return {\n            agentId: agent.id,\n            settings: response.data || response\n          };\n        } catch (error) {\n          console.warn(`Failed to load settings for agent ${agent.id}:`, error);\n          return {\n            agentId: agent.id,\n            settings: null\n          };\n        }\n      });\n\n      const results = await Promise.all(settingsPromises);\n      \n      // Update agents with their settings\n      const updatedAgents = agents.map(agent => {\n        const result = results.find(r => r.agentId === agent.id);\n        if (result && result.settings) {\n          return { ...agent, settings: result.settings };\n        }\n        return agent;\n      });\n\n      setAgents(updatedAgents);\n\n    } catch (error) {\n      console.error('Failed to fetch agent settings:', error);\n    } finally {\n      // Clear loading state\n      setLoadingSettings(prev => {\n        const newSet = new Set(prev);\n        agentsNeedingSettings.forEach(agent => newSet.delete(agent.id));\n        return newSet;\n      });\n    }\n  };\n\n  /**\n   * Close dropdown when clicking outside\n   * \n   * Uses mousedown event for better UX (closes before click completes)\n   */\n  useEffect(() => {\n    const handleClickOutside = (event: MouseEvent) => {\n      if (dropdownRef.current && !dropdownRef.current.contains(event.target as Node)) {\n        setIsOpen(false);\n      }\n    };\n\n    if (isOpen) {\n      document.addEventListener('mousedown', handleClickOutside);\n      return () => document.removeEventListener('mousedown', handleClickOutside);\n    }\n  }, [isOpen]);\n\n  /**\n   * Refresh agents list\n   * \n   * Fetches latest agents from the API and shows toast feedback.\n   * This will temporarily cause avatars to flicker as settings are reloaded.\n   */\n  const handleRefresh = async () => {\n    try {\n      await fetchAgents();\n      toast.success('Agents refreshed');\n    } catch (error) {\n      toast.error('Failed to refresh agents');\n    }\n  };\n\n  /**\n   * Handle agent selection\n   * \n   * Updates the current agent, closes dropdown, and shows confirmation\n   */\n  const handleSelectAgent = async (agent: Agent) => {\n    if (isSelectingAgent) return; // Prevent multiple selections\n    \n    setIsSelectingAgent(true);\n    try {\n      await selectAgent(agent);\n      setIsOpen(false);\n      toast.success(`Switched to ${agent.project_name}`);\n    } catch (error) {\n      toast.error('Failed to switch agent');\n    } finally {\n      // Add a small delay to show the loading state briefly\n      setTimeout(() => {\n        setIsSelectingAgent(false);\n      }, 300);\n    }\n  };\n\n  /**\n   * Fetch settings when agents are loaded and dropdown is open\n   * Only runs when needed to prevent unnecessary API calls\n   */\n  useEffect(() => {\n    if (isOpen && agents.length > 0) {\n      // Only fetch if there are agents without settings\n      const agentsNeedingSettings = agents.some(agent => !agent.settings);\n      if (agentsNeedingSettings) {\n        fetchAgentSettings(agents);\n      }\n    }\n  }, [isOpen, agents.length, agents, fetchAgentSettings]);\n\n  /**\n   * Toggle dropdown and conditionally fetch agents\n   * \n   * Only fetches agents if the array is empty to prevent flickering.\n   * Settings are fetched via useEffect when agents are loaded.\n   */\n  const handleToggleDropdown = async () => {\n    const willOpen = !isOpen;\n    setIsOpen(willOpen);\n    \n    // Only fetch agents if we don't have any yet\n    // This prevents flickering caused by replacing agents that have settings\n    // with fresh agents that don't have settings loaded\n    if (willOpen && agents.length === 0) {\n      try {\n        await fetchAgents();\n      } catch (error) {\n        // Don't show error toast here as it might be annoying\n      }\n    }\n  };\n\n  if (loading && agents.length === 0) {\n    return (\n      <div className={cn('p-3 bg-background border border-border rounded-lg', className)}>\n        <div className=\"flex items-center gap-3\">\n          <div className=\"w-8 h-8 rounded-full bg-muted animate-pulse\" />\n          <div className=\"flex-1\">\n            <div className=\"h-4 bg-muted rounded animate-pulse mb-2\" />\n            <div className=\"h-3 bg-muted/50 rounded animate-pulse w-3/4\" />\n          </div>\n        </div>\n      </div>\n    );\n  }\n\n  if (error && agents.length === 0) {\n    return (\n      <div className={cn('p-3 bg-background border border-border rounded-lg', className)}>\n        <div className=\"flex items-center gap-3\">\n          <div className=\"w-8 h-8 rounded-full bg-red-100 flex items-center justify-center flex-shrink-0\">\n            <AlertCircle className=\"w-4 h-4 text-red-600\" />\n          </div>\n          <div className=\"flex-1\">\n            <p className=\"text-sm text-red-600 font-medium\">Failed to load agents</p>\n            <p className=\"text-xs text-red-500\">{error}</p>\n          </div>\n          <Button\n            size=\"sm\"\n            variant=\"ghost\"\n            onClick={handleRefresh}\n            className=\"text-red-600 hover:text-red-700\"\n          >\n            <RefreshCw className=\"w-4 h-4\" />\n          </Button>\n        </div>\n      </div>\n    );\n  }\n\n  if (!currentAgent && agents.length === 0) {\n    return (\n      <div className={cn('p-3 bg-background border border-border rounded-lg', className)}>\n        <div className=\"flex items-center gap-3\">\n          <div className=\"w-8 h-8 rounded-full bg-accent flex items-center justify-center flex-shrink-0\">\n            <Bot className=\"w-4 h-4 text-muted-foreground\" />\n          </div>\n          <div className=\"flex-1\">\n            <p className=\"text-sm text-muted-foreground font-medium\">No agents available</p>\n            <p className=\"text-xs text-muted-foreground\">Check your API configuration</p>\n          </div>\n          <Button\n            size=\"sm\"\n            variant=\"ghost\"\n            onClick={handleRefresh}\n            disabled={loading}\n          >\n            <RefreshCw className={cn('w-4 h-4', loading && 'animate-spin')} />\n          </Button>\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className={cn('relative', className)} ref={dropdownRef}>\n      {/* Loading overlay when selecting agent */}\n      {isSelectingAgent && (\n        <div className=\"absolute inset-0 bg-background/80 backdrop-blur-sm rounded-lg flex items-center justify-center z-50\">\n          <div className=\"flex items-center gap-2 text-sm text-muted-foreground\">\n            <Spinner size=\"sm\" />\n            <span className=\"text-foreground\">Switching agent...</span>\n          </div>\n        </div>\n      )}\n      {/* Selected Agent Display */}\n      <button\n        onClick={handleToggleDropdown}\n        className={cn(\n          'w-full p-3 bg-background border border-border rounded-lg text-left transition-colors',\n          'hover:bg-accent focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent',\n          isOpen && 'ring-2 ring-ring border-transparent'\n        )}\n      >\n        <div className=\"flex items-center justify-between\">\n          <div className=\"flex items-center gap-3 flex-1 min-w-0\">\n            {/* Avatar */}\n            <AgentAvatar \n              agent={currentAgent}\n              size=\"md\"\n              isSelected={true}\n            />\n            \n            {/* Agent Info */}\n            <div className=\"flex-1 min-w-0\">\n              <h3 className=\"font-medium text-foreground truncate\">\n                {currentAgent?.project_name || 'Select Agent'}\n              </h3>\n            </div>\n          </div>\n          \n          <div className=\"flex items-center gap-2\">\n            {/* Analytics Button */}\n            {currentAgent && (\n              <Button\n                size=\"icon\"\n                variant=\"ghost\"\n                onClick={(e) => {\n                  e.stopPropagation();\n                  // Navigate to projects page with analytics tab\n                  window.location.href = `/projects?id=${currentAgent.id}&tab=analytics`;\n                }}\n                title=\"View Analytics\"\n                className=\"text-muted-foreground hover:text-foreground\"\n              >\n                <BarChart3 className=\"w-4 h-4\" />\n              </Button>\n            )}\n            \n            {/* Refresh Button */}\n            <Button\n              size=\"icon\"\n              variant=\"ghost\"\n              onClick={(e) => {\n                e.stopPropagation();\n                handleRefresh();\n              }}\n              disabled={loading}\n              className=\"h-6 w-6 text-muted-foreground hover:text-foreground\"\n              title=\"Refresh Agents\"\n            >\n              <RefreshCw className={cn('h-3 w-3', loading && 'animate-spin')} />\n            </Button>\n            \n            {/* Dropdown Arrow */}\n            <ChevronDown className={cn(\n              'w-4 h-4 text-muted-foreground transition-transform',\n              isOpen && 'rotate-180'\n            )} />\n          </div>\n        </div>\n      </button>\n\n      {/* Dropdown */}\n      <AnimatePresence>\n        {isOpen && (\n          <motion.div\n            initial={{ opacity: 0, y: -10 }}\n            animate={{ opacity: 1, y: 0 }}\n            exit={{ opacity: 0, y: -10 }}\n            transition={{ duration: 0.2 }}\n            className=\"absolute top-full left-0 right-0 mt-2 bg-background border border-border rounded-lg shadow-lg z-50 max-h-80 overflow-y-auto\"\n          >\n            <div className=\"p-2\">\n              {/* Header */}\n              <div className=\"px-2 py-1 mb-2\">\n                <h4 className=\"text-xs font-medium text-muted-foreground uppercase tracking-wide\">\n                  Available Agents ({Array.isArray(agents) ? agents.length : 0}\n                  {paginationMeta?.totalCount && paginationMeta.totalCount !== agents.length && (\n                    <span> of {paginationMeta.totalCount}</span>\n                  )})\n                </h4>\n              </div>\n              \n              {/* Agent List */}\n              <div className=\"space-y-1\">\n                {Array.isArray(agents) && agents.length > 0 ? (\n                  agents.map((agent) => (\n                    <AgentItem\n                      key={agent.id}\n                      agent={agent}\n                      isSelected={currentAgent?.id === agent.id}\n                      onSelect={handleSelectAgent}\n                      onSettingsClick={showSettings ? onSettingsClick : undefined}\n                    />\n                  ))\n                ) : (\n                  <div className=\"px-2 py-4 text-center\">\n                    <p className=\"text-sm text-muted-foreground\">No agents found</p>\n                    <Button\n                      size=\"sm\"\n                      variant=\"ghost\"\n                      onClick={handleRefresh}\n                      className=\"mt-2\"\n                    >\n                      <RefreshCw className=\"w-4 h-4 mr-2\" />\n                      Refresh\n                    </Button>\n                  </div>\n                )}\n              </div>\n              \n              {/* Load More Button */}\n              {Array.isArray(agents) && agents.length > 0 && paginationMeta?.hasMore && (\n                <div className=\"px-2 py-2 border-t\">\n                  <Button\n                    size=\"sm\"\n                    variant=\"ghost\"\n                    onClick={async () => {\n                      try {\n                        await loadMoreAgents();\n                      } catch (error) {\n                        console.error('Failed to load more agents:', error);\n                      }\n                    }}\n                    disabled={loading}\n                    className=\"w-full\"\n                  >\n                    {loading ? (\n                      <>\n                        <RefreshCw className=\"w-4 h-4 mr-2 animate-spin\" />\n                        Loading...\n                      </>\n                    ) : (\n                      <>\n                        <ChevronDown className=\"w-4 h-4 mr-2\" />\n                        Load More Agents\n                      </>\n                    )}\n                  </Button>\n                </div>\n              )}\n              \n            </div>\n          </motion.div>\n        )}\n      </AnimatePresence>\n    </div>\n  );\n};","'use client';\n\nimport { useState, useEffect } from 'react';\n\n/**\n * Custom hook for responsive design based on media queries\n * Provides mobile-first breakpoint detection\n */\nexport const useMediaQuery = (query: string): boolean => {\n  const [matches, setMatches] = useState(false);\n\n  useEffect(() => {\n    // Handle server-side rendering\n    if (typeof window === 'undefined') {\n      return;\n    }\n\n    const media = window.matchMedia(query);\n    \n    // Set initial value\n    setMatches(media.matches);\n\n    // Create event listener\n    const listener = (event: MediaQueryListEvent) => {\n      setMatches(event.matches);\n    };\n\n    // Add listener\n    media.addEventListener('change', listener);\n\n    // Cleanup\n    return () => media.removeEventListener('change', listener);\n  }, [query]);\n\n  return matches;\n};\n\n/**\n * Predefined breakpoint hooks for common use cases\n */\nexport const useBreakpoint = () => {\n  const isMobile = useMediaQuery('(max-width: 767px)');\n  const isTablet = useMediaQuery('(min-width: 768px) and (max-width: 1023px)');\n  const isDesktop = useMediaQuery('(min-width: 1024px)');\n  const isLargeScreen = useMediaQuery('(min-width: 1280px)');\n  \n  // Touch device detection\n  const isTouchDevice = useMediaQuery('(pointer: coarse)');\n  \n  return {\n    isMobile,\n    isTablet,\n    isDesktop,\n    isLargeScreen,\n    isTouchDevice,\n    // Helper computed values\n    isMobileOrTablet: isMobile || isTablet,\n    isTabletOrDesktop: isTablet || isDesktop\n  };\n};\n\n/**\n * Hook for getting current screen size category\n */\nexport const useScreenSize = () => {\n  const { isMobile, isTablet, isDesktop, isLargeScreen } = useBreakpoint();\n  \n  if (isMobile) return 'mobile';\n  if (isTablet) return 'tablet';\n  if (isLargeScreen) return 'large';\n  if (isDesktop) return 'desktop';\n  return 'desktop'; // fallback\n};","import React from 'react';\nimport { toast as globalToast, Toaster } from 'sonner';\n\n/**\n * Isolated toast implementation for widgets\n * \n * Creates widget-specific toast notifications that don't interfere\n * with other widget instances or the main application.\n */\n\n// Store widget-specific toast queues\nconst widgetToastQueues = new Map<string, Array<any>>();\n\n/**\n * Widget-specific Toaster component\n * This component only shows toasts for its specific widget session\n */\nexport const WidgetToaster: React.FC<{ sessionId: string }> = ({ sessionId }) => {\n  // Create a filter function that only shows toasts for this widget\n  return (\n    <Toaster \n      position=\"top-center\"\n      closeButton\n      gap={8}\n      toastOptions={{\n        style: { \n          zIndex: 10000,\n          marginTop: '8px'\n        },\n        // Custom class to identify widget-specific toasts\n        className: `widget-toast-${sessionId}`,\n      }}\n      // Filter toasts to only show those for this widget\n      richColors\n      theme=\"light\"\n    />\n  );\n};\n\n/**\n * Get or create a widget-specific toast instance\n */\nexport function getWidgetToast(sessionId: string) {\n  // Initialize queue if not exists\n  if (!widgetToastQueues.has(sessionId)) {\n    widgetToastQueues.set(sessionId, []);\n  }\n  \n  return {\n    success: (message: string, options?: any) => {\n      // Use data attribute to mark widget-specific toasts\n      globalToast.success(message, {\n        ...options,\n        id: `${sessionId}-${Date.now()}-${Math.random()}`,\n        duration: 3000,\n        className: `widget-toast-${sessionId}`,\n        data: {\n          widgetSessionId: sessionId\n        }\n      });\n    },\n    error: (message: string, options?: any) => {\n      globalToast.error(message, {\n        ...options,\n        id: `${sessionId}-${Date.now()}-${Math.random()}`,\n        duration: 4000,\n        className: `widget-toast-${sessionId}`,\n        data: {\n          widgetSessionId: sessionId\n        }\n      });\n    },\n    info: (message: string, options?: any) => {\n      globalToast.info(message, {\n        ...options,\n        id: `${sessionId}-${Date.now()}-${Math.random()}`,\n        duration: 3000,\n        className: `widget-toast-${sessionId}`,\n        data: {\n          widgetSessionId: sessionId\n        }\n      });\n    },\n    warning: (message: string, options?: any) => {\n      globalToast.warning(message, {\n        ...options,\n        id: `${sessionId}-${Date.now()}-${Math.random()}`,\n        duration: 3500,\n        className: `widget-toast-${sessionId}`,\n        data: {\n          widgetSessionId: sessionId\n        }\n      });\n    },\n    loading: (message: string, options?: any) => {\n      return globalToast.loading(message, {\n        ...options,\n        id: `${sessionId}-${Date.now()}-${Math.random()}`,\n        className: `widget-toast-${sessionId}`,\n        data: {\n          widgetSessionId: sessionId\n        }\n      });\n    },\n    dismiss: (id?: string) => {\n      if (id) {\n        globalToast.dismiss(id);\n      }\n    }\n  };\n}\n\n/**\n * Hook to use widget-specific toast in components\n */\nexport function useWidgetToast(sessionId: string) {\n  return getWidgetToast(sessionId);\n}","import React, { createContext, useContext, useMemo } from 'react';\nimport { getWidgetToast } from './isolated-toast';\n\n// Widget instance type - we'll define the actual widget interface based on what we need\ninterface WidgetInstance {\n  sessionId: string;\n  createConversation: (title?: string) => any;\n  switchConversation: (conversationId: string) => void;\n  getConversations: () => any[];\n  updateConversationTitle: (conversationId: string, newTitle: string) => void;\n  deleteConversation: (conversationId: string) => void;\n  configuration?: any;\n}\n\n// Extended context that includes both widget instance and toast\ninterface WidgetContextValue {\n  widget: WidgetInstance;\n  toast: ReturnType<typeof getWidgetToast>;\n}\n\n// Create the context with undefined default\nconst WidgetContext = createContext<WidgetContextValue | undefined>(undefined);\n\n// Provider component props\ninterface WidgetProviderProps {\n  widgetInstance: WidgetInstance;\n  children: React.ReactNode;\n}\n\n// Provider component that will wrap the widget's React tree\nexport const WidgetProvider: React.FC<WidgetProviderProps> = ({ widgetInstance, children }) => {\n  // Create isolated toast instance for this widget\n  const toast = useMemo(() => getWidgetToast(widgetInstance.sessionId), [widgetInstance.sessionId]);\n  \n  const value = useMemo(() => ({\n    widget: widgetInstance,\n    toast\n  }), [widgetInstance, toast]);\n  \n  return (\n    <WidgetContext.Provider value={value}>\n      {children}\n    </WidgetContext.Provider>\n  );\n};\n\n// Custom hook to use the widget instance from any component\nexport const useWidget = (): WidgetInstance => {\n  const context = useContext(WidgetContext);\n  if (!context) {\n    throw new Error('useWidget must be used within a WidgetProvider');\n  }\n  return context.widget;\n};\n\n// Optional: Hook that returns null instead of throwing if no widget context\nexport const useWidgetSafe = (): WidgetInstance | null => {\n  const context = useContext(WidgetContext);\n  return context?.widget || null;\n};\n\n// Hook to use the widget-specific toast\nexport const useWidgetToast = () => {\n  const context = useContext(WidgetContext);\n  if (!context) {\n    throw new Error('useWidgetToast must be used within a WidgetProvider');\n  }\n  return context.toast;\n};","/**\n * Debug utilities for CustomGPT Widget\n * \n * Provides comprehensive debugging tools for diagnosing widget issues,\n * especially around message persistence and conversation management.\n */\n\ninterface DebugInfo {\n  timestamp: string;\n  sessionId: string;\n  widgetInstance: any;\n  conversations: any[];\n  currentConversationId: string | null;\n  messageStore: any;\n  localStorage: {\n    keys: string[];\n    messageKeys: string[];\n    conversationKeys: string[];\n    contents: Record<string, any>;\n  };\n  widgetStores: any;\n}\n\nexport class WidgetDebugger {\n  private static instance: WidgetDebugger;\n  private debugEnabled: boolean = true;\n  private logHistory: any[] = [];\n\n  static getInstance(): WidgetDebugger {\n    if (!WidgetDebugger.instance) {\n      WidgetDebugger.instance = new WidgetDebugger();\n    }\n    return WidgetDebugger.instance;\n  }\n\n  /**\n   * Enhanced console log with color coding and grouping\n   */\n  log(category: string, message: string, data?: any, level: 'info' | 'warn' | 'error' | 'debug' = 'info') {\n    if (!this.debugEnabled) return;\n\n    const timestamp = new Date().toISOString();\n    const logEntry = { timestamp, category, message, data, level };\n    this.logHistory.push(logEntry);\n\n    // Color coding for different categories\n    const colors: Record<string, string> = {\n      MESSAGES: 'color: #2196F3; font-weight: bold',\n      CONVERSATIONS: 'color: #4CAF50; font-weight: bold',\n      STORAGE: 'color: #FF9800; font-weight: bold',\n      WIDGET: 'color: #9C27B0; font-weight: bold',\n      API: 'color: #F44336; font-weight: bold',\n      DEBUG: 'color: #607D8B; font-weight: bold'\n    };\n\n    const color = colors[category] || 'color: #000; font-weight: bold';\n\n    console.group(`%c[${category}] ${message}`, color);\n    console.log('Timestamp:', timestamp);\n    if (data) {\n      console.log('Data:', data);\n    }\n    console.groupEnd();\n  }\n\n  /**\n   * Inspect localStorage for widget-related keys\n   */\n  inspectLocalStorage(sessionId?: string): any {\n    const allKeys = Object.keys(localStorage);\n    const widgetKeys = allKeys.filter(key => \n      key.includes('customgpt') || \n      key.includes('widget') || \n      (sessionId && key.includes(sessionId))\n    );\n\n    const messageKeys = widgetKeys.filter(key => key.includes('messages'));\n    const conversationKeys = widgetKeys.filter(key => key.includes('conversation'));\n\n    const contents: Record<string, any> = {};\n    widgetKeys.forEach(key => {\n      try {\n        const value = localStorage.getItem(key);\n        contents[key] = value ? JSON.parse(value) : null;\n      } catch (e) {\n        contents[key] = localStorage.getItem(key);\n      }\n    });\n\n    return {\n      allKeysCount: allKeys.length,\n      widgetKeysCount: widgetKeys.length,\n      keys: widgetKeys,\n      messageKeys,\n      conversationKeys,\n      contents\n    };\n  }\n\n  /**\n   * Get comprehensive debug information for a widget instance\n   */\n  getDebugInfo(widgetInstance: any): DebugInfo {\n    const sessionId = widgetInstance?.sessionId || 'unknown';\n    const conversations = widgetInstance?.getConversations() || [];\n    const currentConversationId = widgetInstance?.currentConversationId;\n    \n    // Get widget stores\n    const widgetStores = (window as any).__customgpt_widget_stores?.[sessionId];\n    const messageStore = widgetStores?.messageStore?.getState();\n    \n    return {\n      timestamp: new Date().toISOString(),\n      sessionId,\n      widgetInstance: {\n        sessionId: widgetInstance?.sessionId,\n        currentConversationId: widgetInstance?.currentConversationId,\n        config: widgetInstance?.config,\n        conversationCount: conversations.length\n      },\n      conversations,\n      currentConversationId,\n      messageStore: messageStore ? {\n        messagesMapSize: messageStore.messages?.size,\n        messagesMapKeys: Array.from(messageStore.messages?.keys() || []),\n        isStreaming: messageStore.isStreaming,\n        loading: messageStore.loading,\n        error: messageStore.error\n      } : null,\n      localStorage: this.inspectLocalStorage(sessionId),\n      widgetStores: widgetStores ? {\n        hasMessageStore: !!widgetStores.messageStore,\n        hasConversationStore: !!widgetStores.conversationStore,\n        hasAgentStore: !!widgetStores.agentStore\n      } : null\n    };\n  }\n\n  /**\n   * Debug a specific conversation's messages\n   */\n  debugConversation(widgetInstance: any, conversationId: string) {\n    const debugInfo = this.getDebugInfo(widgetInstance);\n    const sessionId = widgetInstance?.sessionId;\n\n    console.group(`%c[DEBUG] Conversation ${conversationId}`, 'color: #E91E63; font-weight: bold');\n    \n    // Check message store\n    const messageStore = (window as any).__customgpt_widget_stores?.[sessionId]?.messageStore?.getState();\n    if (messageStore) {\n      const messages = messageStore.messages.get(conversationId);\n      console.log('Messages in store:', messages);\n      console.log('Message count:', messages?.length || 0);\n    }\n\n    // Check localStorage directly\n    const storageKeys = [\n      `customgpt-messages-cache-${sessionId}`,\n      `customgpt-messages-cache-${sessionId}-${conversationId}`,\n      `customgpt-messages-${sessionId}-${conversationId}`\n    ];\n\n    console.log('Checking localStorage keys:');\n    storageKeys.forEach(key => {\n      const value = localStorage.getItem(key);\n      if (value) {\n        try {\n          const parsed = JSON.parse(value);\n          console.log(` Found ${key}:`, parsed);\n        } catch (e) {\n          console.log(` Found ${key} (raw):`, value);\n        }\n      } else {\n        console.log(` Not found: ${key}`);\n      }\n    });\n\n    console.groupEnd();\n  }\n\n  /**\n   * Trace message flow for debugging\n   */\n  traceMessageFlow(action: string, data: any) {\n    const trace = {\n      action,\n      timestamp: new Date().toISOString(),\n      ...data\n    };\n\n    console.group(`%c[TRACE] ${action}`, 'color: #795548; font-weight: bold');\n    console.table(trace);\n    console.groupEnd();\n  }\n\n  /**\n   * Export debug log history\n   */\n  exportLogs(): string {\n    return JSON.stringify(this.logHistory, null, 2);\n  }\n\n  /**\n   * Clear debug log history\n   */\n  clearLogs() {\n    this.logHistory = [];\n  }\n\n  /**\n   * Toggle debug mode\n   */\n  setDebugEnabled(enabled: boolean) {\n    this.debugEnabled = enabled;\n    console.log(`Widget debugging ${enabled ? 'enabled' : 'disabled'}`);\n  }\n}\n\n// Create global debug function for easy console access\nif (typeof window !== 'undefined') {\n  (window as any).__customgpt_debug = (conversationId?: string) => {\n    const instances = (window as any).__customgpt_widget_instances;\n    if (!instances) {\n      console.error('No widget instances found');\n      return;\n    }\n\n    const instanceKeys = Object.keys(instances);\n    if (instanceKeys.length === 0) {\n      console.error('No widget instances found');\n      return;\n    }\n\n    const widgetDebugger = WidgetDebugger.getInstance();\n    \n    instanceKeys.forEach(key => {\n      const instance = instances[key];\n      console.group(`%c[Widget Instance: ${key}]`, 'color: #3F51B5; font-weight: bold; font-size: 14px');\n      \n      const debugInfo = widgetDebugger.getDebugInfo(instance);\n      console.log('Debug Info:', debugInfo);\n      \n      if (conversationId) {\n        widgetDebugger.debugConversation(instance, conversationId);\n      }\n      \n      console.groupEnd();\n    });\n\n    console.log(`\n%c Debug Helper Functions:\n%c- __customgpt_debug() - Show all widget debug info\n- __customgpt_debug('conversationId') - Debug specific conversation\n- __customgpt_debug_trace() - Show message flow trace\n- __customgpt_debug_storage() - Inspect localStorage\n- __customgpt_debug_clear() - Clear localStorage (use with caution!)\n`, 'color: #4CAF50; font-weight: bold', 'color: #666');\n  };\n\n  // Additional debug helpers\n  (window as any).__customgpt_debug_trace = () => {\n    const widgetDebugger = WidgetDebugger.getInstance();\n    console.log(widgetDebugger.exportLogs());\n  };\n\n  (window as any).__customgpt_debug_storage = () => {\n    const widgetDebugger = WidgetDebugger.getInstance();\n    const storage = widgetDebugger.inspectLocalStorage();\n    console.table(storage.contents);\n  };\n\n  (window as any).__customgpt_debug_clear = () => {\n    if (confirm('This will clear all CustomGPT widget data from localStorage. Are you sure?')) {\n      const keys = Object.keys(localStorage).filter(key => \n        key.includes('customgpt') || key.includes('widget')\n      );\n      keys.forEach(key => localStorage.removeItem(key));\n      console.log(`Cleared ${keys.length} keys from localStorage`);\n    }\n  };\n}\n\nexport const widgetDebugger = WidgetDebugger.getInstance();","/**\n * Widget-specific Message Store Factory\n * \n * Creates an isolated message store instance for each widget.\n * This ensures messages are not shared between different widget instances.\n */\n\nimport { create, StoreApi } from 'zustand';\nimport type { ChatMessage, Citation, FeedbackType } from '@/types';\nimport { getClient } from '@/lib/api/client';\nimport { generateId } from '@/lib/utils';\nimport { globalStreamManager } from '@/lib/streaming/handler';\nimport { logger } from '@/lib/logger';\nimport { widgetDebugger } from '@/widget/debug-utils';\nimport type { AgentStore } from './agents';\nimport type { ConversationStore } from './conversations';\n\n/**\n * Remove citation references from content\n * Removes patterns like :cit[xxx/xxx] from the message text\n */\nfunction removeCitationReferences(content: string): string {\n  // Remove citation references and any extra spaces they might leave\n  return content.replace(/\\s*:cit\\[\\d+\\/\\d+\\]\\s*/g, ' ').trim();\n}\n\n// Message Store interface - copied from original to maintain compatibility\nexport interface MessageStore {\n  messages: Map<string, ChatMessage[]>;\n  streamingMessage: ChatMessage | null;\n  isStreaming: boolean;\n  loading: boolean;\n  error: string | null;\n  \n  sendMessage: (content: string, files?: File[]) => Promise<void>;\n  loadMessages: (conversationId: string) => Promise<void>;\n  addMessage: (conversationId: string, message: ChatMessage) => void;\n  updateStreamingMessage: (content: string, citations?: Citation[]) => void;\n  clearMessages: (conversationId?: string) => void;\n  updateMessageFeedback: (messageId: string, feedback: FeedbackType) => void;\n  cancelStreaming: () => void;\n  getMessagesForConversation: (conversationId: string) => ChatMessage[];\n  reset: () => void;\n  clearError: () => void;\n  setMessagesForConversation: (conversationId: string, messages: ChatMessage[]) => void;\n}\n\n/**\n * Create a message store instance for a specific widget\n * @param sessionId - The widget's session ID for isolation\n * @param agentStore - Reference to the agent store\n * @param conversationStore - Reference to the conversation store\n */\nexport function createMessageStore(\n  sessionId: string,\n  agentStore?: StoreApi<AgentStore>,\n  conversationStore?: StoreApi<ConversationStore>\n): StoreApi<MessageStore> {\n  const MESSAGES_STORAGE_KEY = `customgpt-messages-cache-${sessionId}`;\n  \n  // Local storage helpers scoped to this instance\n  function saveMessagesToStorage(conversationId: string, messages: ChatMessage[]) {\n    try {\n      // Use a consistent storage key that includes both session ID and conversation ID\n      const storageKey = `${MESSAGES_STORAGE_KEY}-${conversationId}`;\n      localStorage.setItem(storageKey, JSON.stringify(messages));\n      \n      // Also update the main cache storage\n      const stored = localStorage.getItem(MESSAGES_STORAGE_KEY);\n      const cache = stored ? JSON.parse(stored) : {};\n      cache[conversationId] = messages;\n      localStorage.setItem(MESSAGES_STORAGE_KEY, JSON.stringify(cache));\n      \n      // Enhanced debugging\n      widgetDebugger.log('STORAGE', 'Saved messages to localStorage', {\n        conversationId,\n        messageCount: messages.length,\n        storageKey,\n        cacheKey: MESSAGES_STORAGE_KEY,\n        sessionId,\n        actualKeys: [storageKey, MESSAGES_STORAGE_KEY],\n        messageIds: messages.map(m => ({ id: m.id, role: m.role }))\n      });\n      \n      widgetDebugger.traceMessageFlow('SAVE_MESSAGES', {\n        conversationId,\n        messageCount: messages.length,\n        sessionId,\n        storageKeys: [storageKey, MESSAGES_STORAGE_KEY]\n      });\n    } catch (error) {\n      console.error('Failed to save messages to local storage:', error);\n      widgetDebugger.log('STORAGE', 'Failed to save messages', { \n        conversationId, \n        error,\n        sessionId \n      }, 'error');\n    }\n  }\n\n  function loadMessagesFromStorage(conversationId: string): ChatMessage[] | null {\n    try {\n      // First try the session-specific storage key\n      const sessionStorageKey = `${MESSAGES_STORAGE_KEY}-${conversationId}`;\n      const sessionStored = localStorage.getItem(sessionStorageKey);\n      \n      widgetDebugger.log('STORAGE', 'Attempting to load messages', {\n        conversationId,\n        sessionId,\n        sessionStorageKey,\n        hasSessionStored: !!sessionStored,\n        sessionStoredLength: sessionStored?.length\n      });\n      \n      if (sessionStored) {\n        try {\n          const messages = JSON.parse(sessionStored);\n          widgetDebugger.log('STORAGE', 'Successfully loaded from session storage', {\n            conversationId,\n            messageCount: messages.length,\n            sessionId,\n            messageIds: messages.map((m: ChatMessage) => ({ id: m.id, role: m.role }))\n          });\n          \n          widgetDebugger.traceMessageFlow('LOAD_SUCCESS_SESSION', {\n            conversationId,\n            messageCount: messages.length,\n            fromKey: sessionStorageKey\n          });\n          \n          return messages;\n        } catch (e) {\n          widgetDebugger.log('STORAGE', 'Failed to parse session storage', { error: e }, 'error');\n        }\n      }\n      \n      // Then try the main cache\n      const stored = localStorage.getItem(MESSAGES_STORAGE_KEY);\n      widgetDebugger.log('STORAGE', 'Checking main cache', {\n        cacheKey: MESSAGES_STORAGE_KEY,\n        hasCache: !!stored,\n        cacheSize: stored?.length\n      });\n      \n      if (stored) {\n        try {\n          const cache = JSON.parse(stored);\n          const messages = cache[conversationId];\n          \n          widgetDebugger.log('STORAGE', 'Cache lookup result', {\n            conversationId,\n            foundMessages: !!messages,\n            messageCount: messages?.length || 0,\n            cacheKeys: Object.keys(cache),\n            conversationIdType: typeof conversationId,\n            cacheKeyTypes: Object.keys(cache).map(k => ({ key: k, type: typeof k }))\n          });\n          \n          if (messages) {\n            widgetDebugger.traceMessageFlow('LOAD_SUCCESS_CACHE', {\n              conversationId,\n              messageCount: messages.length,\n              fromKey: MESSAGES_STORAGE_KEY\n            });\n          }\n          \n          return messages || null;\n        } catch (e) {\n          widgetDebugger.log('STORAGE', 'Failed to parse cache storage', { error: e }, 'error');\n        }\n      }\n      \n      widgetDebugger.log('STORAGE', 'No messages found in any storage', {\n        conversationId,\n        sessionId,\n        checkedKeys: [sessionStorageKey, MESSAGES_STORAGE_KEY],\n        allLocalStorageKeys: Object.keys(localStorage).filter(k => k.includes('customgpt'))\n      }, 'warn');\n      \n      widgetDebugger.traceMessageFlow('LOAD_EMPTY', {\n        conversationId,\n        sessionId,\n        reason: 'No messages found in storage'\n      });\n      \n      return null;\n    } catch (error) {\n      widgetDebugger.log('STORAGE', 'Exception loading messages', {\n        conversationId,\n        error,\n        sessionId\n      }, 'error');\n      return null;\n    }\n  }\n\n  return create<MessageStore>((set, get) => ({\n    messages: new Map(),\n    streamingMessage: null,\n    isStreaming: false,\n    loading: false,\n    error: null,\n\n    sendMessage: async (content: string, files?: File[]) => {\n      const isDemoMode = typeof window !== 'undefined' && (window as any).__customgpt_demo_mode;\n      \n      // Use the passed store references\n      if (!agentStore || !conversationStore) {\n        logger.error('MESSAGES', 'Store references not provided');\n        throw new Error('Store references not provided');\n      }\n      \n      const currentAgent = agentStore.getState().currentAgent;\n      if (!currentAgent) {\n        logger.error('MESSAGES', 'No agent selected');\n        throw new Error('No agent selected');\n      }\n\n      logger.info('MESSAGES', 'Sending message from widget store', {\n        sessionId,\n        agentId: currentAgent.id,\n        agentName: currentAgent.project_name,\n        messageLength: content.length,\n        hasFiles: files && files.length > 0\n      });\n\n      // Ensure we have a conversation\n      const conversation = await conversationStore.getState().ensureConversation(\n        typeof currentAgent.id === 'string' ? parseInt(currentAgent.id) : currentAgent.id,\n        content\n      );\n\n      logger.info('MESSAGES', 'Conversation ensured', {\n        conversationId: conversation.id,\n        sessionId: conversation.session_id,\n        hasSessionId: !!conversation.session_id,\n        isNew: !conversation.message_count || conversation.message_count === 0\n      });\n\n      if (!conversation.session_id) {\n        logger.error('MESSAGES', 'Conversation missing session_id', { conversation });\n        throw new Error('Conversation missing session_id');\n      }\n\n      set({ loading: true, error: null });\n\n      const conversationId = conversation.id.toString();\n\n      // Create user message\n      const userMessage: ChatMessage = {\n        id: generateId(),\n        role: 'user',\n        content,\n        timestamp: new Date().toISOString(),\n        status: 'sending',\n      };\n\n      widgetDebugger.log('MESSAGES', 'Adding user message', {\n        conversationId,\n        conversationIdType: typeof conversationId,\n        messageId: userMessage.id,\n        currentMapKeys: Array.from(get().messages.keys()),\n        sessionId\n      });\n      \n      widgetDebugger.traceMessageFlow('ADD_USER_MESSAGE', {\n        conversationId,\n        messageId: userMessage.id,\n        sessionId,\n        content: content.substring(0, 50) + '...'\n      });\n\n      // Add user message to store\n      get().addMessage(conversationId, userMessage);\n\n      // Create assistant message placeholder\n      const assistantMessage: ChatMessage = {\n        id: generateId(),\n        role: 'assistant',\n        content: '',\n        timestamp: new Date().toISOString(),\n        citations: [],\n      };\n\n      set({ \n        streamingMessage: assistantMessage,\n        isStreaming: true,\n        loading: false,\n      });\n\n      try {\n        // Handle file uploads if present\n        if (files && files.length > 0) {\n          const client = getClient();\n          await Promise.all(\n            files.map(file => client.uploadFile(currentAgent.id, file))\n          );\n        }\n\n        // Update user message status\n        userMessage.status = 'sent';\n        get().addMessage(conversationId, userMessage);\n\n        // Start streaming with correct parameters\n        const client = getClient();\n        \n        logger.info('MESSAGES', 'Starting message stream', {\n          agentId: currentAgent.id,\n          sessionId: conversation.session_id,\n          messageContent: content.substring(0, 50)\n        });\n        \n        if (isDemoMode) {\n          // Demo mode - simulate streaming response\n          await new Promise(resolve => setTimeout(resolve, 1000));\n          \n          const demoResponse = `This is a demo response to: \"${content}\"`;\n          get().updateStreamingMessage(demoResponse);\n          \n          await new Promise(resolve => setTimeout(resolve, 500));\n          \n          const finalMessage = get().streamingMessage;\n          if (finalMessage) {\n            finalMessage.status = 'sent';\n            get().addMessage(conversationId, finalMessage);\n          }\n          \n          set({ \n            streamingMessage: null,\n            isStreaming: false,\n          });\n          return;\n        }\n        \n        // Real API streaming\n        try {\n          await client.sendMessageStream(\n            currentAgent.id,\n            conversation.session_id,\n            { \n              prompt: content\n            },\n            (chunk) => {\n                logger.info('MESSAGES', 'Received stream chunk', { \n                  type: chunk.type, \n                  hasContent: !!chunk.content,\n                  contentLength: chunk.content?.length,\n                  contentPreview: chunk.content?.substring(0, 50)\n                });\n                \n                if (chunk.type === 'content' && chunk.content) {\n                  get().updateStreamingMessage(chunk.content, chunk.citations);\n                } else if (chunk.type === 'citation' && chunk.citations) {\n                  // Handle citation-only chunks\n                  const current = get().streamingMessage;\n                  if (current) {\n                    set({\n                      streamingMessage: {\n                        ...current,\n                        citations: chunk.citations\n                      }\n                    });\n                  }\n                }\n              },\n            async (streamError) => {\n                logger.error('MESSAGES', 'Streaming failed, attempting fallback to non-streaming', streamError);\n                \n                // Try fallback to non-streaming API\n                try {\n                  const response = await client.sendMessage(\n                    currentAgent.id,\n                    conversation.session_id,\n                    { \n                      prompt: content,\n                      stream: false\n                    }\n                  );\n                  \n                  // Update streaming message with the complete response\n                  const finalMessage = get().streamingMessage;\n                  if (finalMessage && response) {\n                    let messageData: any;\n                    if (response.data) {\n                      messageData = response.data;\n                    } else {\n                      messageData = response as any;\n                    }\n                    \n                    // Clean citation references from the response content\n                    const rawContent = messageData?.openai_response || messageData?.content || 'No response received';\n                    finalMessage.content = removeCitationReferences(rawContent);\n                    finalMessage.citations = messageData?.citations || [];\n                    finalMessage.status = 'sent';\n                    get().addMessage(conversationId, finalMessage);\n                  }\n                  \n                  set({ \n                    streamingMessage: null,\n                    isStreaming: false,\n                  });\n                  \n                } catch (fallbackError) {\n                  logger.error('MESSAGES', 'Both streaming and non-streaming failed', fallbackError);\n                  throw fallbackError;\n                }\n              },\n            () => {\n                // onComplete callback\n                const finalMessage = get().streamingMessage;\n                if (finalMessage) {\n                  // Clean citation references from the final message content\n                  finalMessage.content = removeCitationReferences(finalMessage.content);\n                  finalMessage.status = 'sent';\n                  get().addMessage(conversationId, finalMessage);\n                }\n                \n                set({ \n                  streamingMessage: null,\n                  isStreaming: false,\n                });\n                \n                // Update conversation message count\n                conversationStore.getState().updateConversation(\n                  conversation.id,\n                  conversation.session_id,\n                  { name: conversation.name }\n                );\n              }\n          );\n        } catch (error) {\n          logger.error('MESSAGES', 'Failed to send message', error);\n          \n          // Remove assistant message placeholder on error\n          set({ \n            streamingMessage: null,\n            isStreaming: false,\n            error: error instanceof Error ? error.message : 'Failed to send message'\n          });\n          \n          throw error;\n        }\n      } catch (error) {\n        logger.error('MESSAGES', 'Error in sendMessage', error);\n        set({ \n          error: error instanceof Error ? error.message : 'Failed to send message',\n          streamingMessage: null,\n          isStreaming: false,\n          loading: false,\n        });\n        throw error;\n      }\n    },\n\n    loadMessages: async (conversationId: string) => {\n      widgetDebugger.log('MESSAGES', 'loadMessages called', {\n        conversationId,\n        conversationIdType: typeof conversationId,\n        sessionId,\n        storageKey: MESSAGES_STORAGE_KEY,\n        currentMapSize: get().messages.size,\n        currentMapKeys: Array.from(get().messages.keys())\n      });\n      \n      widgetDebugger.traceMessageFlow('LOAD_MESSAGES_START', {\n        conversationId,\n        sessionId\n      });\n      \n      set({ loading: true, error: null });\n\n      try {\n        // Try to load from storage first\n        const cachedMessages = loadMessagesFromStorage(conversationId);\n        \n        widgetDebugger.log('MESSAGES', 'Storage load result', {\n          conversationId,\n          messageCount: cachedMessages?.length || 0,\n          hasMessages: !!cachedMessages,\n          firstMessage: cachedMessages?.[0] ? {\n            id: cachedMessages[0].id,\n            role: cachedMessages[0].role,\n            contentPreview: cachedMessages[0].content.substring(0, 50)\n          } : null\n        });\n        \n        if (cachedMessages && cachedMessages.length > 0) {\n          set(state => {\n            const newMap = new Map(state.messages);\n            newMap.set(conversationId, cachedMessages);\n            \n            widgetDebugger.log('MESSAGES', 'Updated message map', {\n              conversationId,\n              messageCount: cachedMessages.length,\n              newMapSize: newMap.size,\n              newMapKeys: Array.from(newMap.keys()),\n              mapNowHasConversation: newMap.has(conversationId)\n            });\n            \n            widgetDebugger.traceMessageFlow('LOAD_MESSAGES_SUCCESS', {\n              conversationId,\n              messageCount: cachedMessages.length,\n              sessionId\n            });\n            \n            return {\n              messages: newMap,\n              loading: false,\n            };\n          });\n          return;\n        }\n\n        // No messages found in storage\n        widgetDebugger.log('MESSAGES', 'No messages in storage, setting empty array', {\n          conversationId,\n          sessionId\n        }, 'warn');\n        \n        set(state => {\n          const newMap = new Map(state.messages);\n          newMap.set(conversationId, []);\n          \n          widgetDebugger.traceMessageFlow('LOAD_MESSAGES_EMPTY', {\n            conversationId,\n            reason: 'No messages found',\n            sessionId\n          });\n          \n          return {\n            messages: newMap,\n            loading: false,\n          };\n        });\n      } catch (error) {\n        widgetDebugger.log('MESSAGES', 'Exception in loadMessages', {\n          conversationId,\n          error,\n          sessionId\n        }, 'error');\n        \n        set({ \n          error: error instanceof Error ? error.message : 'Failed to load messages',\n          loading: false \n        });\n      }\n    },\n\n    addMessage: (conversationId: string, message: ChatMessage) => {\n      widgetDebugger.log('MESSAGES', 'addMessage called', {\n        conversationId,\n        conversationIdType: typeof conversationId,\n        messageId: message.id,\n        messageRole: message.role,\n        sessionId\n      });\n      \n      set(state => {\n        const newMessages = new Map(state.messages);\n        const messages = newMessages.get(conversationId) || [];\n        \n        widgetDebugger.log('MESSAGES', 'Current messages for conversation', {\n          conversationId,\n          existingMessageCount: messages.length,\n          mapHasConversation: state.messages.has(conversationId)\n        });\n        \n        // Check if message already exists\n        const existingIndex = messages.findIndex(m => m.id === message.id);\n        if (existingIndex >= 0) {\n          messages[existingIndex] = message;\n          widgetDebugger.log('MESSAGES', 'Updated existing message', { messageId: message.id });\n        } else {\n          messages.push(message);\n          widgetDebugger.log('MESSAGES', 'Added new message', { \n            messageId: message.id,\n            newMessageCount: messages.length \n          });\n        }\n        \n        newMessages.set(conversationId, messages);\n        \n        // Save to storage\n        saveMessagesToStorage(conversationId, messages);\n        \n        widgetDebugger.traceMessageFlow('MESSAGE_ADDED', {\n          conversationId,\n          messageId: message.id,\n          messageCount: messages.length,\n          role: message.role\n        });\n        \n        return { messages: newMessages };\n      });\n    },\n\n    updateStreamingMessage: (content: string, citations?: Citation[]) => {\n      set(state => {\n        if (!state.streamingMessage) return state;\n        \n        return {\n          streamingMessage: {\n            ...state.streamingMessage,\n            content: state.streamingMessage.content + content, // Append content as-is during streaming\n            citations: citations || state.streamingMessage.citations,\n          },\n        };\n      });\n    },\n\n    clearMessages: (conversationId?: string) => {\n      if (conversationId) {\n        set(state => {\n          const newMessages = new Map(state.messages);\n          newMessages.delete(conversationId);\n          return { messages: newMessages };\n        });\n        \n        // Clear from storage\n        try {\n          const stored = localStorage.getItem(MESSAGES_STORAGE_KEY);\n          if (stored) {\n            const cache = JSON.parse(stored);\n            delete cache[conversationId];\n            localStorage.setItem(MESSAGES_STORAGE_KEY, JSON.stringify(cache));\n          }\n        } catch (error) {\n          console.error('Failed to clear messages from storage:', error);\n        }\n      } else {\n        // Clear all messages\n        set({ messages: new Map() });\n        \n        // Clear all from storage\n        try {\n          localStorage.removeItem(MESSAGES_STORAGE_KEY);\n        } catch (error) {\n          console.error('Failed to clear all messages from storage:', error);\n        }\n      }\n    },\n\n    cancelStreaming: () => {\n      globalStreamManager.cancelAllStreams();\n      set({ isStreaming: false, streamingMessage: null });\n    },\n\n    getMessagesForConversation: (conversationId: string): ChatMessage[] => {\n      return get().messages.get(conversationId) || [];\n    },\n\n    updateMessageFeedback: (messageId: string, feedback: FeedbackType) => {\n      set(state => {\n        const newMessages = new Map(state.messages);\n        \n        for (const [convId, messages] of newMessages) {\n          const messageIndex = messages.findIndex(m => m.id === messageId);\n          if (messageIndex !== -1) {\n            const updatedMessages = [...messages];\n            updatedMessages[messageIndex] = {\n              ...updatedMessages[messageIndex],\n              feedback,\n            };\n            newMessages.set(convId, updatedMessages);\n            saveMessagesToStorage(convId, updatedMessages);\n            break;\n          }\n        }\n        \n        return { messages: newMessages };\n      });\n    },\n\n    reset: () => {\n      set({\n        messages: new Map(),\n        streamingMessage: null,\n        isStreaming: false,\n        loading: false,\n        error: null,\n      });\n    },\n    \n    clearError: () => {\n      set({ error: null });\n    },\n    \n    setMessagesForConversation: (conversationId: string, messages: ChatMessage[]) => {\n      set(state => {\n        const newMessages = new Map(state.messages);\n        newMessages.set(conversationId, messages);\n        return { messages: newMessages };\n      });\n    },\n  }));\n}","/**\n * Widget-specific Conversation Store Factory\n * \n * Creates an isolated conversation store instance for each widget.\n * This ensures conversations are not shared between different widget instances.\n */\n\nimport { create, StoreApi } from 'zustand';\nimport type { Conversation } from '@/types';\nimport { getClient } from '@/lib/api/client';\nimport { generateId } from '@/lib/utils';\nimport { logger } from '@/lib/logger';\n\n// Conversation Store interface - widget-specific version\nexport interface ConversationStore {\n  conversations: Conversation[];\n  allConversations: Conversation[];\n  currentConversation: Conversation | null;\n  loading: boolean;\n  error: string | null;\n  lastConversationActivity: Record<string, string>;\n  \n  // Pagination state\n  currentPage: number;\n  totalPages: number;\n  totalConversations: number;\n  perPage: number;\n  \n  // Sorting and filtering state\n  sortOrder: 'asc' | 'desc';\n  sortBy: string;\n  userFilter: 'all' | 'me' | string;\n  \n  // Client-side filtering state\n  searchQuery: string;\n  searchMode: 'name' | 'id' | 'session';\n  dateFilter: 'all' | 'today' | 'week' | 'month';\n  \n  fetchConversations: (projectId: number, params?: {\n    page?: number;\n    per_page?: number;\n    order?: 'asc' | 'desc';\n    orderBy?: string;\n    userFilter?: 'all' | 'me' | string;\n  }) => Promise<void>;\n  loadConversations: (agentId: string) => Promise<void>; // Keep for compatibility\n  createConversation: (projectId: number, name?: string) => Promise<void>;\n  updateConversation: (conversationId: number, sessionId: string, data: { name: string }) => Promise<void>;\n  deleteConversation: (conversationId: string | number) => Promise<void>;\n  selectConversation: (conversation: Conversation) => void;\n  ensureConversation: (projectId: number, firstMessage?: string) => Promise<Conversation>;\n  \n  // Client-side filtering methods\n  applyFilters: () => void;\n  setSearchQuery: (query: string) => void;\n  setSearchMode: (mode: 'name' | 'id' | 'session') => void;\n  setDateFilter: (filter: 'all' | 'today' | 'week' | 'month') => void;\n  \n  reset: () => void;\n}\n\n/**\n * Create a conversation store instance for a specific widget\n * @param sessionId - The widget's session ID for isolation\n */\nexport function createConversationStore(sessionId: string): StoreApi<ConversationStore> {\n  const CONVERSATIONS_STORAGE_KEY = `customgpt-conversations-cache-${sessionId}`;\n  const ACTIVITY_STORAGE_KEY = `customgpt-conversation-activity-${sessionId}`;\n  \n  // Local storage helpers scoped to this instance\n  function saveConversationsToStorage(agentId: string, conversations: Conversation[]) {\n    try {\n      const stored = localStorage.getItem(CONVERSATIONS_STORAGE_KEY);\n      const cache = stored ? JSON.parse(stored) : {};\n      cache[agentId] = conversations;\n      localStorage.setItem(CONVERSATIONS_STORAGE_KEY, JSON.stringify(cache));\n    } catch (error) {\n      console.error('Failed to save conversations to storage:', error);\n    }\n  }\n\n  function loadConversationsFromStorage(agentId: string): Conversation[] | null {\n    try {\n      const stored = localStorage.getItem(CONVERSATIONS_STORAGE_KEY);\n      if (!stored) return null;\n      const cache = JSON.parse(stored);\n      return cache[agentId] || null;\n    } catch (error) {\n      console.error('Failed to load conversations from storage:', error);\n      return null;\n    }\n  }\n\n  function saveActivityToStorage(activity: Record<string, string>) {\n    try {\n      localStorage.setItem(ACTIVITY_STORAGE_KEY, JSON.stringify(activity));\n    } catch (error) {\n      console.error('Failed to save activity to storage:', error);\n    }\n  }\n\n  function loadActivityFromStorage(): Record<string, string> {\n    try {\n      const stored = localStorage.getItem(ACTIVITY_STORAGE_KEY);\n      return stored ? JSON.parse(stored) : {};\n    } catch (error) {\n      console.error('Failed to load activity from storage:', error);\n      return {};\n    }\n  }\n\n  return create<ConversationStore>((set, get) => ({\n    conversations: [],\n    allConversations: [],\n    currentConversation: null,\n    loading: false,\n    error: null,\n    lastConversationActivity: loadActivityFromStorage(),\n    // Pagination state\n    currentPage: 1,\n    totalPages: 1,\n    totalConversations: 0,\n    perPage: 20,\n    // Sorting and filtering state\n    sortOrder: 'desc' as const,\n    sortBy: 'id',\n    userFilter: 'all' as const,\n    // Client-side filtering state\n    searchQuery: '',\n    searchMode: 'name' as const,\n    dateFilter: 'all' as const,\n\n    fetchConversations: async (projectId: number, params?: {\n      page?: number;\n      per_page?: number;\n      order?: 'asc' | 'desc';\n      orderBy?: string;\n      userFilter?: 'all' | 'me' | string;\n    }) => {\n      // For widgets, we load conversations differently\n      const isDemoMode = typeof window !== 'undefined' && (window as any).__customgpt_demo_mode;\n      \n      logger.info('CONVERSATIONS', 'Fetching conversations for widget', {\n        sessionId,\n        projectId,\n        isDemoMode\n      });\n\n      set({ loading: true, error: null });\n\n      try {\n        if (isDemoMode) {\n          // In demo mode, just load from local storage\n          return get().loadConversations(projectId.toString());\n        }\n        \n        // Get the list of conversation IDs that belong to this widget session\n        const widgetConvKey = `widget_conversations_${sessionId}`;\n        const widgetConvIds = JSON.parse(localStorage.getItem(widgetConvKey) || '[]');\n        \n        if (widgetConvIds.length === 0) {\n          // No conversations created yet in this widget session\n          set({\n            conversations: [],\n            loading: false,\n          });\n          return;\n        }\n        \n        // Fetch conversations from API but only keep ones created in this widget session\n        const client = getClient();\n        \n        // Merge params with current state\n        const queryParams = {\n          page: params?.page ?? get().currentPage,\n          per_page: params?.per_page ?? get().perPage,\n          order: params?.order ?? get().sortOrder,\n          orderBy: params?.orderBy ?? get().sortBy,\n          userFilter: params?.userFilter ?? get().userFilter,\n        };\n        \n        const response = await client.getConversations(projectId, queryParams);\n        \n        // Handle different response formats\n        let allConversations = [];\n        let paginationData = null;\n        \n        if (response && typeof response === 'object') {\n          // Standard paginated response format\n          if ((response as any).data && (response as any).data.data) {\n            allConversations = (response as any).data.data;\n            paginationData = (response as any).data;\n          } else if (Array.isArray((response as any).data)) {\n            allConversations = (response as any).data;\n          } else if (Array.isArray(response)) {\n            allConversations = response;\n          }\n        }\n        \n        // Filter to only include conversations created in this widget session\n        const widgetConversations = allConversations.filter((conv: Conversation) => \n          widgetConvIds.includes(conv.id)\n        );\n        \n        logger.info('CONVERSATIONS', 'Filtered widget conversations', {\n          totalFromAPI: allConversations.length,\n          widgetSpecific: widgetConversations.length,\n          widgetConvIds,\n          paginationData\n        });\n        \n        // Update state with conversations and pagination data\n        set({ \n          allConversations: widgetConversations, // Store raw conversations\n          loading: false,\n          // Update pagination state if available\n          currentPage: paginationData?.current_page ?? 1,\n          totalPages: paginationData?.last_page ?? 1,\n          totalConversations: widgetConvIds.length, // Total widget conversations, not API total\n          // Update sorting/filtering if params were provided\n          ...(params?.order && { sortOrder: params.order }),\n          ...(params?.orderBy && { sortBy: params.orderBy }),\n          ...(params?.userFilter && { userFilter: params.userFilter }),\n        });\n        \n        // Apply client-side filters\n        get().applyFilters();\n        \n        // Save to local storage\n        saveConversationsToStorage(projectId.toString(), widgetConversations);\n      } catch (error) {\n        logger.error('CONVERSATIONS', 'Failed to fetch conversations', error);\n        // On error, try to load from local storage\n        const cached = loadConversationsFromStorage(projectId.toString());\n        set({ \n          conversations: cached || [],\n          error: error instanceof Error ? error.message : 'Failed to fetch conversations',\n          loading: false,\n        });\n      }\n    },\n\n    loadConversations: async (agentId: string) => {\n      const isDemoMode = typeof window !== 'undefined' && (window as any).__customgpt_demo_mode;\n      \n      logger.info('CONVERSATIONS', 'Loading conversations for widget store', {\n        sessionId,\n        agentId,\n        isDemoMode\n      });\n\n      set({ loading: true, error: null });\n\n      try {\n        // For widgets, we only load conversations from local storage that were created in this session\n        // We do NOT fetch from the API to ensure complete isolation\n        const cachedConversations = loadConversationsFromStorage(agentId);\n        \n        if (cachedConversations) {\n          // Filter to only include conversations created in this widget session\n          const sessionConversations = cachedConversations.filter(conv => \n            conv.session_id && conv.session_id.includes(sessionId)\n          );\n          \n          set({\n            allConversations: sessionConversations,\n            loading: false,\n          });\n          \n          // Apply client-side filters\n          get().applyFilters();\n          \n          logger.info('CONVERSATIONS', 'Loaded session-specific conversations', {\n            totalCached: cachedConversations.length,\n            sessionSpecific: sessionConversations.length,\n            sessionId\n          });\n        } else {\n          // No conversations yet - start with empty array\n          set({\n            allConversations: [],\n            conversations: [],\n            loading: false,\n          });\n        }\n      } catch (error) {\n        logger.error('CONVERSATIONS', 'Failed to load conversations', error);\n        set({\n          error: error instanceof Error ? error.message : 'Failed to load conversations',\n          loading: false,\n          allConversations: [],\n          conversations: [] // Start with empty on error\n        });\n      }\n    },\n\n    createConversation: async (projectId: number, name?: string): Promise<void> => {\n      const isDemoMode = typeof window !== 'undefined' && (window as any).__customgpt_demo_mode;\n      \n      logger.info('CONVERSATIONS', 'Creating conversation in widget store', {\n        sessionId,\n        projectId,\n        name\n      });\n\n      set({ loading: true, error: null });\n\n      try {\n        // Use the API to create the conversation\n        const client = getClient();\n        \n        if (isDemoMode) {\n          // Demo mode - create locally only\n          const timestamp = Date.now();\n          const random = Math.floor(Math.random() * 1000000);\n          const sessionIdForConv = `demo_session_${timestamp}_${random}_${sessionId}`;\n\n          const newConversation: Conversation = {\n            id: Math.floor(Math.random() * 1000000),\n            session_id: sessionIdForConv,\n            project_id: projectId,\n            name: name || 'New Conversation',\n            message_count: 0,\n            created_at: new Date().toISOString(),\n            updated_at: new Date().toISOString(),\n            deleted_at: null,\n          };\n\n          set(state => ({\n            allConversations: [...state.allConversations, newConversation],\n            currentConversation: newConversation,\n            loading: false,\n          }));\n          \n          // Apply client-side filters\n          get().applyFilters();\n          \n          saveConversationsToStorage(projectId.toString(), [...get().conversations]);\n          return;\n        }\n        \n        // Create conversation via API\n        const response = await client.createConversation(projectId, name ? { name } : undefined);\n        const newConversation = response.data;\n        \n        // Ensure the conversation has our widget session ID in it for filtering\n        // Store the widget session ID in localStorage to track which conversations belong to this widget\n        const widgetConvKey = `widget_conversations_${sessionId}`;\n        const existingConvIds = JSON.parse(localStorage.getItem(widgetConvKey) || '[]');\n        existingConvIds.push(newConversation.id);\n        localStorage.setItem(widgetConvKey, JSON.stringify(existingConvIds));\n        \n        logger.info('CONVERSATIONS', 'Created conversation via API', {\n          conversationId: newConversation.id,\n          sessionId: newConversation.session_id,\n          projectId: newConversation.project_id,\n          widgetSessionId: sessionId\n        });\n        \n        set(state => ({ \n          allConversations: [...state.allConversations, newConversation],\n          currentConversation: newConversation,\n          loading: false,\n        }));\n        \n        // Apply client-side filters\n        get().applyFilters();\n        \n        // Save to local storage for this widget session\n        saveConversationsToStorage(projectId.toString(), get().conversations);\n      } catch (error) {\n        logger.error('CONVERSATIONS', 'Failed to create conversation', error);\n        set({ \n          error: error instanceof Error ? error.message : 'Failed to create conversation',\n          loading: false \n        });\n        throw error;\n      }\n    },\n\n    updateConversation: async (conversationId: number, sessionId: string, data: { name: string }) => {\n      logger.info('CONVERSATIONS', 'Updating conversation in widget store', {\n        sessionId: sessionId,\n        conversationId,\n        data\n      });\n\n      set(state => ({\n        allConversations: state.allConversations.map(conv =>\n          conv.id.toString() === conversationId.toString()\n            ? { ...conv, name: data.name, updated_at: new Date().toISOString() }\n            : conv\n        ),\n      }));\n      \n      // Apply client-side filters\n      get().applyFilters();\n\n      // Update current conversation if it's the one being updated\n      const current = get().currentConversation;\n      if (current && current.id.toString() === conversationId.toString()) {\n        set({\n          currentConversation: { ...current, name: data.name, updated_at: new Date().toISOString() },\n        });\n      }\n\n      // Save to storage\n      const projectId = get().conversations.find(c => c.id.toString() === conversationId.toString())?.project_id;\n      if (projectId) {\n        saveConversationsToStorage(projectId.toString(), get().conversations);\n      }\n    },\n\n    deleteConversation: async (conversationId: string | number) => {\n      logger.info('CONVERSATIONS', 'Deleting conversation from widget store', {\n        sessionId,\n        conversationId\n      });\n\n      const conversation = get().allConversations.find(c => c.id.toString() === conversationId);\n      if (!conversation) return;\n\n      set(state => ({\n        allConversations: state.allConversations.filter(conv => conv.id.toString() !== conversationId),\n        currentConversation: state.currentConversation?.id.toString() === conversationId\n          ? null\n          : state.currentConversation,\n      }));\n      \n      // Apply client-side filters\n      get().applyFilters();\n\n      // Save to storage\n      saveConversationsToStorage(conversation.project_id.toString(), get().conversations);\n    },\n\n    selectConversation: (conversation: Conversation) => {\n      logger.info('CONVERSATIONS', 'Selecting conversation in widget store', {\n        sessionId,\n        conversationId: conversation?.id\n      });\n\n      set({ currentConversation: conversation });\n\n      // Update activity tracking\n      if (conversation) {\n        const activity = { ...get().lastConversationActivity };\n        activity[conversation.project_id.toString()] = conversation.id.toString();\n        set({ lastConversationActivity: activity });\n        saveActivityToStorage(activity);\n      }\n    },\n\n    ensureConversation: async (projectId: number, firstMessage?: string) => {\n      const { currentConversation, allConversations } = get();\n      \n      // If we have a current conversation for this agent, use it\n      if (currentConversation && currentConversation.project_id === projectId) {\n        return currentConversation;\n      }\n\n      // Check if we have any existing conversations for this project\n      // This helps when the widget is reloading and currentConversation isn't set yet\n      const existingConversation = allConversations.find(c => c.project_id === projectId);\n      if (existingConversation) {\n        set({ currentConversation: existingConversation });\n        return existingConversation;\n      }\n\n      // If no current conversation, always create a new one\n      // This ensures that seeing the welcome screen (currentConversation = null) \n      // always results in starting a fresh conversation\n      const title = firstMessage\n        ? firstMessage.substring(0, 50) + (firstMessage.length > 50 ? '...' : '')\n        : 'New Conversation';\n      \n      await get().createConversation(projectId, title);\n      \n      // Get the newly created conversation\n      const newConversation = get().conversations[get().conversations.length - 1];\n      set({ currentConversation: newConversation });\n      \n      return newConversation;\n    },\n\n    // Client-side filtering methods\n    applyFilters: () => {\n      const state = get();\n      let filtered = [...state.allConversations];\n      \n      // Apply search filter\n      if (state.searchQuery.trim()) {\n        const query = state.searchQuery.toLowerCase().trim();\n        filtered = filtered.filter(conv => {\n          switch (state.searchMode) {\n            case 'name':\n              return conv.name.toLowerCase().includes(query);\n            case 'id':\n              return conv.id.toString().includes(query);\n            case 'session':\n              return conv.session_id.toLowerCase().includes(query);\n            default:\n              return conv.name.toLowerCase().includes(query);\n          }\n        });\n      }\n      \n      // Apply date filter\n      if (state.dateFilter !== 'all') {\n        const now = new Date();\n        const filterDate = new Date();\n        \n        switch (state.dateFilter) {\n          case 'today':\n            filterDate.setHours(0, 0, 0, 0);\n            break;\n          case 'week':\n            filterDate.setDate(now.getDate() - 7);\n            break;\n          case 'month':\n            filterDate.setDate(now.getDate() - 30);\n            break;\n        }\n        \n        filtered = filtered.filter(conv => {\n          const convDate = new Date(conv.updated_at);\n          return convDate >= filterDate;\n        });\n      }\n      \n      // Note: User filter and sorting are handled server-side by the API\n      // We don't apply them client-side to avoid conflicts\n      \n      set({ conversations: filtered });\n    },\n\n    setSearchQuery: (query: string) => {\n      set({ searchQuery: query });\n      get().applyFilters();\n    },\n\n    setSearchMode: (mode: 'name' | 'id' | 'session') => {\n      set({ searchMode: mode });\n      get().applyFilters();\n    },\n\n    setDateFilter: (filter: 'all' | 'today' | 'week' | 'month') => {\n      set({ dateFilter: filter });\n      get().applyFilters();\n    },\n\n    reset: () => {\n      set({\n        conversations: [],\n        allConversations: [],\n        currentConversation: null,\n        loading: false,\n        error: null,\n        lastConversationActivity: {},\n        searchQuery: '',\n        searchMode: 'name' as const,\n        dateFilter: 'all' as const,\n      });\n    },\n  }));\n}","/**\n * Widget-specific Agent Store Factory\n * \n * Creates an isolated agent store instance for each widget.\n * This ensures agent selection is not shared between different widget instances.\n */\n\nimport { create, StoreApi } from 'zustand';\nimport type { Agent } from '@/types';\nimport { getClient } from '@/lib/api/client';\nimport { logger } from '@/lib/logger';\n\n// Agent Store interface - widget-specific version with minimal methods\nexport interface AgentStore {\n  agents: Agent[];\n  currentAgent: Agent | null;\n  loading: boolean;\n  error: string | null;\n  \n  loadAgents: () => Promise<void>;\n  fetchAgents: () => Promise<void>; // Alias for compatibility\n  selectAgent: (agent: Agent) => void;\n  setAgents: (agents: Agent[]) => void;\n  updateAgent: (id: number, data: { are_licenses_allowed?: boolean }) => Promise<Agent>;\n  deleteAgent: (id: number) => Promise<void>;\n  createAgent: (data: any) => Promise<Agent>;\n  replicateAgent: (id: number) => Promise<Agent>;\n  getAgentStats: (id: number) => Promise<any>;\n  reset: () => void;\n}\n\n/**\n * Create an agent store instance for a specific widget\n * @param sessionId - The widget's session ID for isolation\n */\nexport function createAgentStore(sessionId: string): StoreApi<AgentStore> {\n  const AGENTS_STORAGE_KEY = `customgpt-agents-cache-${sessionId}`;\n  const SELECTED_AGENT_KEY = `customgpt-selected-agent-${sessionId}`;\n  \n  // Local storage helpers scoped to this instance\n  function saveAgentsToStorage(agents: Agent[]) {\n    try {\n      localStorage.setItem(AGENTS_STORAGE_KEY, JSON.stringify(agents));\n    } catch (error) {\n      console.error('Failed to save agents to storage:', error);\n    }\n  }\n\n  function loadAgentsFromStorage(): Agent[] | null {\n    try {\n      const stored = localStorage.getItem(AGENTS_STORAGE_KEY);\n      return stored ? JSON.parse(stored) : null;\n    } catch (error) {\n      console.error('Failed to load agents from storage:', error);\n      return null;\n    }\n  }\n\n  function saveSelectedAgentToStorage(agentId: string | null) {\n    try {\n      if (agentId) {\n        localStorage.setItem(SELECTED_AGENT_KEY, agentId);\n      } else {\n        localStorage.removeItem(SELECTED_AGENT_KEY);\n      }\n    } catch (error) {\n      console.error('Failed to save selected agent to storage:', error);\n    }\n  }\n\n  function loadSelectedAgentFromStorage(): string | null {\n    try {\n      return localStorage.getItem(SELECTED_AGENT_KEY);\n    } catch (error) {\n      console.error('Failed to load selected agent from storage:', error);\n      return null;\n    }\n  }\n\n  return create<AgentStore>((set, get) => ({\n    agents: [],\n    currentAgent: null,\n    loading: false,\n    error: null,\n\n    fetchAgents: async () => {\n      // Alias for loadAgents for compatibility\n      return get().loadAgents();\n    },\n\n    loadAgents: async () => {\n      const isDemoMode = typeof window !== 'undefined' && (window as any).__customgpt_demo_mode;\n      \n      // Get widget instance from window using session ID\n      let widget = null;\n      if (typeof window !== 'undefined') {\n        // Try multiple possible keys where widget might be stored\n        const widgetKey = `__customgpt_widget_${sessionId}`;\n        widget = (window as any)[widgetKey];\n        \n        // Fallback to check the instances object\n        if (!widget) {\n          const instances = (window as any).__customgpt_widget_instances;\n          widget = instances?.[sessionId];\n        }\n        \n        // Fallback to the main instance for backward compatibility\n        if (!widget) {\n          widget = (window as any).__customgpt_widget_instance;\n        }\n      }\n      \n      logger.info('AGENTS', 'Loading agents for widget store', {\n        sessionId,\n        isDemoMode,\n        hasWidget: !!widget,\n        configuredAgentId: widget?.config?.agentId\n      });\n\n      set({ loading: true, error: null });\n\n      try {\n        // If widget has a configured agentId, create the agent directly\n        if (widget?.config?.agentId) {\n          const agentId = typeof widget.config.agentId === 'string' ? parseInt(widget.config.agentId) : widget.config.agentId;\n          \n          // Create fallback agent immediately to ensure widget works\n          const fallbackAgent: Agent = {\n            id: agentId,\n            project_name: widget.config.agentName || widget.config.name || `Agent ${agentId}`,\n            type: 'WIDGET',\n            created_at: new Date().toISOString(),\n            updated_at: new Date().toISOString(),\n            is_chat_active: true,\n            is_shared: false,\n            user_id: 0,\n            team_id: 0,\n            settings: {\n              chatbot_avatar: './logo.png'\n            }\n          };\n          \n          logger.info('AGENTS', 'Creating fallback agent for widget', {\n            agentId,\n            agentName: fallbackAgent.project_name,\n            isDemoMode\n          });\n          \n          set({\n            agents: [fallbackAgent],\n            currentAgent: fallbackAgent,\n            loading: false,\n          });\n          \n          saveAgentsToStorage([fallbackAgent]);\n          saveSelectedAgentToStorage(fallbackAgent.id.toString());\n          \n          // Try to fetch the actual agent details in the background\n          if (!isDemoMode) {\n            try {\n              const client = getClient();\n              const response = await client.getAgent(agentId);\n              const agent = response.data || response;\n              \n              // Fetch agent settings to get chatbot_avatar and other settings\n              try {\n                const settingsResponse = await client.getAgentSettings(agentId);\n                const settings = settingsResponse.data || settingsResponse;\n                \n                // Merge settings into agent object\n                agent.settings = settings;\n                \n                logger.info('AGENTS', 'Fetched agent settings', {\n                  agentId: agent.id,\n                  hasAvatar: !!settings?.chatbot_avatar,\n                  avatarUrl: settings?.chatbot_avatar\n                });\n              } catch (settingsError) {\n                logger.warn('AGENTS', 'Failed to fetch agent settings', settingsError);\n                // Use default settings with logo\n                agent.settings = {\n                  chatbot_avatar: './logo.png'\n                };\n              }\n              \n              // Apply custom name if provided\n              if (widget.config.agentName) {\n                agent.project_name = widget.config.agentName;\n              }\n              \n              logger.info('AGENTS', 'Updated agent with API data', {\n                agentId: agent.id,\n                agentName: agent.project_name,\n                hasSettings: !!agent.settings,\n                avatarUrl: agent.settings?.chatbot_avatar\n              });\n              \n              // Update the store with the actual agent data\n              set({\n                agents: [agent],\n                currentAgent: agent,\n                loading: false,\n              });\n              \n              saveAgentsToStorage([agent]);\n              saveSelectedAgentToStorage(agent.id.toString());\n            } catch (error) {\n              logger.warn('AGENTS', 'Failed to fetch agent from API, using fallback', error);\n              // Keep the fallback agent that was already set\n            }\n          }\n          \n          return;\n        }\n        \n        // If no widget configuration found, create a basic demo agent\n        if (!widget) {\n          logger.warn('AGENTS', 'No widget configuration found, creating demo agent');\n          const demoAgent: Agent = {\n            id: 1,\n            project_name: 'Demo Assistant',\n            type: 'DEMO',\n            created_at: new Date().toISOString(),\n            updated_at: new Date().toISOString(),\n            is_chat_active: true,\n            is_shared: false,\n            user_id: 0,\n            team_id: 0,\n            settings: {\n              chatbot_avatar: './logo.png'\n            }\n          };\n          \n          set({\n            agents: [demoAgent],\n            currentAgent: demoAgent,\n            loading: false,\n          });\n          \n          saveAgentsToStorage([demoAgent]);\n          saveSelectedAgentToStorage(demoAgent.id.toString());\n          return;\n        }\n\n        // No specific agent ID - fetch agents from API with enterprise-scale pagination\n        if (!isDemoMode) {\n          const client = getClient();\n          // Load first batch with larger page size for better widget performance\n          const response = await client.getAgents({ page: 1, per_page: 100 });\n          \n          // Handle different response formats\n          let agents: Agent[] = [];\n          if (response && typeof response === 'object') {\n            if ('data' in response && 'total' in response) {\n              // Paginated response format\n              agents = (response as { data: Agent[] }).data;\n            } else if (Array.isArray((response as any).data)) {\n              // Legacy format: { data: [...] }\n              agents = (response as any).data;\n            } else if (Array.isArray(response)) {\n              // Legacy format: [...]\n              agents = response as Agent[];\n            }\n          }\n          \n          logger.info('AGENTS', 'Fetched agents from API (first page)', {\n            count: agents.length,\n            total: (response as any)?.total || agents.length\n          });\n          \n          // Select first agent or previously selected\n          const selectedAgentId = loadSelectedAgentFromStorage();\n          const selectedAgent = selectedAgentId \n            ? agents.find(a => a.id.toString() === selectedAgentId) || agents[0]\n            : agents[0];\n          \n          set({\n            agents,\n            currentAgent: selectedAgent || null,\n            loading: false,\n          });\n          \n          saveAgentsToStorage(agents);\n          if (selectedAgent) {\n            saveSelectedAgentToStorage(selectedAgent.id.toString());\n          }\n          return;\n        }\n\n        // Demo mode without specific agent ID\n        if (isDemoMode) {\n          // Create demo agents\n          const demoAgents: Agent[] = [\n            {\n              id: 1,\n              project_name: 'Demo Assistant',\n              type: 'DEMO',\n              created_at: new Date().toISOString(),\n              updated_at: new Date().toISOString(),\n              is_chat_active: true,\n              is_shared: false,\n              user_id: 0,\n              team_id: 0,\n              settings: {\n                chatbot_avatar: '/logo.png'\n              }\n            },\n          ];\n          \n          set({\n            agents: demoAgents,\n            currentAgent: demoAgents[0],\n            loading: false,\n          });\n          \n          saveAgentsToStorage(demoAgents);\n          saveSelectedAgentToStorage(demoAgents[0].id.toString());\n          return;\n        }\n\n        // Should not reach here\n        set({\n          agents: [],\n          currentAgent: null,\n          loading: false,\n        });\n      } catch (error) {\n        logger.error('AGENTS', 'Failed to load agents', error);\n        set({\n          error: error instanceof Error ? error.message : 'Failed to load agents',\n          loading: false,\n        });\n      }\n    },\n\n    selectAgent: (agent: Agent) => {\n      logger.info('AGENTS', 'Selecting agent in widget store', {\n        sessionId,\n        agentId: agent?.id,\n        agentName: agent?.project_name\n      });\n\n      set({ currentAgent: agent });\n      saveSelectedAgentToStorage(agent?.id.toString() || null);\n\n      // Update widget instance if available\n      const widgetKey = `__customgpt_widget_${sessionId}`;\n      const widget = typeof window !== 'undefined' ? (window as any)[widgetKey] : null;\n      \n      if (widget && agent) {\n        widget.config.agentId = agent.id;\n        widget.config.name = agent.project_name;\n      }\n    },\n\n    setAgents: (agents: Agent[]) => {\n      set({ agents });\n      saveAgentsToStorage(agents);\n    },\n\n    updateAgent: async (id: number, data: { project_name?: string; are_licenses_allowed?: boolean; is_shared?: boolean; sitemap_path?: string }) => {\n      logger.info('AGENTS', 'Updating agent in widget store', {\n        sessionId,\n        agentId: id,\n        data\n      });\n\n      const agent = get().agents.find(a => a.id === id);\n      if (!agent) {\n        throw new Error('Agent not found');\n      }\n\n      const updatedAgent = { ...agent, ...data };\n      \n      set(state => ({\n        agents: state.agents.map(a =>\n          a.id === id ? updatedAgent : a\n        ),\n        currentAgent: state.currentAgent?.id === id\n          ? updatedAgent\n          : state.currentAgent,\n      }));\n\n      // Save to storage\n      saveAgentsToStorage(get().agents);\n      \n      return updatedAgent;\n    },\n\n    deleteAgent: async (id: number) => {\n      logger.info('AGENTS', 'Deleting agent from widget store', {\n        sessionId,\n        agentId: id\n      });\n\n      set(state => ({\n        agents: state.agents.filter(a => a.id !== id),\n        currentAgent: state.currentAgent?.id === id ? null : state.currentAgent,\n      }));\n\n      // Save to storage\n      saveAgentsToStorage(get().agents);\n    },\n\n    createAgent: async (data: any) => {\n      // Widgets typically don't create agents, but we need this for compatibility\n      throw new Error('Creating agents is not supported in widget mode');\n    },\n\n    replicateAgent: async (id: number) => {\n      // Widgets typically don't replicate agents\n      throw new Error('Replicating agents is not supported in widget mode');\n    },\n\n    getAgentStats: async (id: number) => {\n      // Return empty stats for widget mode\n      return {\n        messages_sent: 0,\n        users_interacted: 0,\n        last_message_at: null\n      };\n    },\n\n    reset: () => {\n      set({\n        agents: [],\n        currentAgent: null,\n        loading: false,\n        error: null,\n      });\n      \n      // Clear storage\n      try {\n        localStorage.removeItem(AGENTS_STORAGE_KEY);\n        localStorage.removeItem(SELECTED_AGENT_KEY);\n      } catch (error) {\n        console.error('Failed to clear agent storage:', error);\n      }\n    },\n  }));\n}","import React, { createContext, useContext, useRef, ReactNode } from 'react';\nimport { StoreApi } from 'zustand';\nimport { createMessageStore, MessageStore } from '../store/widget-stores/messages';\nimport { createConversationStore, ConversationStore } from '../store/widget-stores/conversations';\nimport { createAgentStore, AgentStore } from '../store/widget-stores/agents';\n\n/**\n * Widget Store Context\n * \n * Provides instance-specific Zustand stores for each widget.\n * This ensures complete data isolation between multiple widgets.\n * \n * Each widget instance gets its own:\n * - Message store (for chat messages)\n * - Conversation store (for conversation management)\n * - Agent store (for agent selection)\n * \n * The config store remains global as API configuration should be shared.\n */\n\ninterface WidgetStores {\n  messageStore: StoreApi<MessageStore>;\n  conversationStore: StoreApi<ConversationStore>;\n  agentStore: StoreApi<AgentStore>;\n}\n\ninterface WidgetStoreContextValue {\n  stores: WidgetStores;\n}\n\nexport const WidgetStoreContext = createContext<WidgetStoreContextValue | null>(null);\n\ninterface WidgetStoreProviderProps {\n  children: ReactNode;\n  sessionId: string;\n}\n\n/**\n * Widget Store Provider\n * \n * Creates and provides instance-specific stores for a widget.\n * Stores are created once per widget instance and reused.\n */\nexport const WidgetStoreProvider: React.FC<WidgetStoreProviderProps> = ({ \n  children, \n  sessionId \n}) => {\n  // Use ref to ensure stores are only created once per widget instance\n  const storesRef = useRef<WidgetStores | null>(null);\n  \n  if (!storesRef.current) {\n    // Create stores in the correct order, passing references to dependent stores\n    const agentStore = createAgentStore(sessionId);\n    const conversationStore = createConversationStore(sessionId);\n    const messageStore = createMessageStore(sessionId, agentStore, conversationStore);\n    \n    storesRef.current = {\n      messageStore,\n      conversationStore,\n      agentStore,\n    };\n    \n    // Store the widget stores globally for access by the widget instance\n    if (typeof window !== 'undefined') {\n      if (!(window as any).__customgpt_widget_stores) {\n        (window as any).__customgpt_widget_stores = {};\n      }\n      (window as any).__customgpt_widget_stores[sessionId] = storesRef.current;\n    }\n  }\n  \n  return (\n    <WidgetStoreContext.Provider value={{ stores: storesRef.current }}>\n      {children}\n    </WidgetStoreContext.Provider>\n  );\n};\n\n/**\n * Hook to access widget-specific stores\n */\nexport const useWidgetStores = (): WidgetStores => {\n  const context = useContext(WidgetStoreContext);\n  if (!context) {\n    throw new Error('useWidgetStores must be used within WidgetStoreProvider');\n  }\n  return context.stores;\n};\n\n/**\n * Individual store hooks for easier access\n */\nexport const useWidgetMessageStore = () => {\n  const { messageStore } = useWidgetStores();\n  return messageStore;\n};\n\nexport const useWidgetConversationStore = () => {\n  const { conversationStore } = useWidgetStores();\n  return conversationStore;\n};\n\nexport const useWidgetAgentStore = () => {\n  const { agentStore } = useWidgetStores();\n  return agentStore;\n};","/**\n * Citation Details Modal Component\n * \n * Modal dialog that displays detailed information about a citation,\n * including Open Graph data fetched from the cited source.\n * \n * Features:\n * - Open Graph data display (title, description, image)\n * - Loading and error states\n * - Responsive modal design\n * - Image preview with error handling\n * - Direct link to source\n * - Citation metadata display\n * - Smooth animations\n * \n * API Integration:\n * - Fetches citation details via getCitation API\n * - Handles Open Graph data response\n * - Graceful error handling\n * - Automatic retry on prop changes\n * \n * UI/UX:\n * - Backdrop click to close\n * - Escape key support (via close button)\n * - Loading spinner during fetch\n * - Error message display\n * - Image fallback on load error\n * \n * Features:\n * - Advanced citation caching for improved performance\n * - Professional sharing and bookmarking functionality\n * - Enhanced image preview with zoom and gallery modes\n * - Citation analytics and usage tracking\n * - Comprehensive export options and related citation discovery\n */\n\n'use client';\n\nimport React, { useState, useEffect, useCallback } from 'react';\nimport { motion, AnimatePresence } from 'framer-motion';\nimport { \n  X, \n  ExternalLink,\n  Loader,\n  AlertCircle,\n  Globe,\n  Image as ImageIcon\n} from 'lucide-react';\n\nimport { Button } from '@/components/ui/button';\nimport { cn } from '@/lib/utils';\nimport { getClient } from '@/lib/api/client';\nimport { logger } from '@/lib/logger';\nimport { useAgentStore } from '@/store/agents';\nimport { useBreakpoint } from '@/hooks/useMediaQuery';\nimport { useWidgetSafe } from '@/widget/WidgetContext';\nimport { useContext } from 'react';\nimport { WidgetStoreContext } from '@/widget/WidgetStoreContext';\n\n/**\n * Open Graph data structure for citations\n * \n * @property id - Citation ID\n * @property url - Source URL\n * @property title - Page title from Open Graph\n * @property description - Page description\n * @property image - Optional preview image URL\n */\ninterface CitationOpenGraphData {\n  id: number;\n  url: string;\n  title: string;\n  description: string;\n  image?: string;\n}\n\n/**\n * Props for CitationDetailsModal\n * \n * @property isOpen - Whether modal is visible\n * @property onClose - Callback to close modal\n * @property citationId - ID of citation to display\n * @property projectId - Optional project ID (uses current agent if not provided)\n */\ninterface CitationDetailsModalProps {\n  isOpen: boolean;\n  onClose: () => void;\n  citationId: number | string;\n  projectId?: number;\n}\n\n/**\n * Citation Details Modal Component\n * \n * Displays rich preview of citation with Open Graph data.\n * Fetches citation details from API when opened.\n */\nexport const CitationDetailsModal: React.FC<CitationDetailsModalProps> = ({\n  isOpen,\n  onClose,\n  citationId,\n  projectId\n}) => {\n  const [loading, setLoading] = useState(false);\n  const [error, setError] = useState<string | null>(null);\n  const [citationData, setCitationData] = useState<CitationOpenGraphData | null>(null);\n  const [imageError, setImageError] = useState(false);\n  \n  const { isMobile } = useBreakpoint();\n  const widgetInstance = useWidgetSafe();\n  \n  // Always call the global store hook\n  const globalStore = useAgentStore();\n  \n  // Check if widget store context is available\n  const widgetStoreContext = useContext(WidgetStoreContext);\n  \n  // Use widget store if available and we're in widget mode\n  const currentAgent = widgetInstance && widgetStoreContext \n    ? widgetStoreContext.stores.agentStore.getState().currentAgent\n    : globalStore.currentAgent;\n  \n  const effectiveProjectId = projectId || currentAgent?.id;\n\n  /**\n   * Fetch citation Open Graph data from API\n   * \n   * Handles:\n   * - Parameter validation\n   * - API call with proper typing\n   * - Error handling with user-friendly messages\n   * - Loading state management\n   * - Logging for debugging\n   */\n  const fetchCitationDetails = useCallback(async () => {\n    if (!effectiveProjectId || !citationId) {\n      setError('Missing project or citation information');\n      return;\n    }\n\n    setLoading(true);\n    setError(null);\n    setImageError(false);\n\n    try {\n      const client = getClient();\n      const response = await client.getCitation(\n        effectiveProjectId, \n        typeof citationId === 'string' ? parseInt(citationId, 10) : citationId\n      );\n      \n      if (response.data) {\n        setCitationData(response.data as unknown as CitationOpenGraphData);\n        logger.info('CITATION', 'Citation details fetched', {\n          citationId,\n          projectId: effectiveProjectId,\n          hasImage: !!response.data.image\n        });\n      }\n    } catch (err) {\n      const errorMessage = err instanceof Error ? err.message : 'Failed to fetch citation details';\n      setError(errorMessage);\n      logger.error('CITATION', 'Failed to fetch citation details', {\n        error: err,\n        citationId,\n        projectId: effectiveProjectId\n      });\n    } finally {\n      setLoading(false);\n    }\n  }, [effectiveProjectId, citationId]);\n\n  /**\n   * Fetch citation details when modal opens\n   * \n   * Triggers API call when modal becomes visible and required data is available\n   */\n  useEffect(() => {\n    if (isOpen && effectiveProjectId && citationId) {\n      fetchCitationDetails();\n    }\n  }, [isOpen, effectiveProjectId, citationId, fetchCitationDetails]);\n\n  if (!isOpen) return null;\n\n  return (\n    <AnimatePresence>\n      {isOpen && (\n        <>\n          {/* Backdrop */}\n          <motion.div\n            initial={{ opacity: 0 }}\n            animate={{ opacity: 1 }}\n            exit={{ opacity: 0 }}\n            onClick={onClose}\n            className=\"fixed inset-0 bg-black/50 z-50\"\n          />\n\n          {/* Modal */}\n          <motion.div\n            initial={{ opacity: 0, scale: 0.95, y: isMobile ? '100%' : 0 }}\n            animate={{ opacity: 1, scale: 1, y: 0 }}\n            exit={{ opacity: 0, scale: 0.95, y: isMobile ? '100%' : 0 }}\n            className={cn(\n              \"fixed bg-background shadow-xl z-50\",\n              isMobile \n                ? \"inset-x-0 bottom-0 top-20 rounded-t-xl flex flex-col\" \n                : \"inset-x-0 top-[10%] mx-auto max-w-2xl rounded-lg max-h-[90vh] overflow-hidden\"\n            )}\n          >\n          {/* Header */}\n          <div className={cn(\n            \"flex items-center justify-between border-b border-border bg-background/95 backdrop-blur-sm flex-shrink-0\",\n            isMobile ? \"px-4 py-4\" : \"p-4\"\n          )}>\n            <h2 className={cn(\n              \"font-semibold text-foreground\",\n              isMobile ? \"text-lg\" : \"text-lg\"\n            )}>\n              Citation Details\n            </h2>\n            <Button\n              variant=\"ghost\"\n              size=\"icon\"\n              onClick={onClose}\n              className={cn(\n                isMobile ? \"h-9 w-9 touch-target\" : \"h-8 w-8\"\n              )}\n            >\n              <X className={cn(\n                isMobile ? \"h-5 w-5\" : \"h-4 w-4\"\n              )} />\n            </Button>\n          </div>\n\n          {/* Content */}\n          <div className={cn(\n            \"overflow-y-auto\",\n            isMobile \n              ? \"flex-1 px-4 py-4 pb-6 safe-area-pb\" \n              : \"p-4 max-h-[calc(90vh-120px)]\"\n          )}>\n            {loading ? (\n              <div className=\"flex items-center justify-center py-12\">\n                <Loader className=\"h-8 w-8 animate-spin text-muted-foreground\" />\n              </div>\n            ) : error ? (\n              <div className={cn(\n                \"flex items-center gap-3 p-4 bg-red-50 dark:bg-red-950/20 rounded-lg\",\n                isMobile && \"mx-0\"\n              )}>\n                <AlertCircle className={cn(\n                  \"text-red-600 flex-shrink-0\",\n                  isMobile ? \"h-5 w-5\" : \"h-5 w-5\"\n                )} />\n                <div className=\"flex-1\">\n                  <p className={cn(\n                    \"font-medium text-red-900 dark:text-red-200\",\n                    isMobile ? \"text-sm\" : \"text-sm\"\n                  )}>Error loading citation</p>\n                  <p className={cn(\n                    \"text-red-700 dark:text-red-300 mt-1\",\n                    isMobile ? \"text-xs\" : \"text-sm\"\n                  )}>{error}</p>\n                </div>\n              </div>\n            ) : citationData ? (\n              <div className={cn(\n                \"space-y-4\",\n                isMobile && \"space-y-5\"\n              )}>\n                {/* Open Graph Image */}\n                {citationData.image && !imageError && (\n                  <div className={cn(\n                    \"relative rounded-lg overflow-hidden bg-muted\",\n                    isMobile && \"-mx-4 rounded-none\"\n                  )}>\n                    <img\n                      src={citationData.image}\n                      alt={citationData.title}\n                      className=\"w-full h-auto\"\n                      onError={() => setImageError(true)}\n                    />\n                    {isMobile && (\n                      <div className=\"absolute inset-0 bg-gradient-to-t from-black/20 to-transparent pointer-events-none\" />\n                    )}\n                  </div>\n                )}\n\n                {/* Title */}\n                <div>\n                  <h3 className={cn(\n                    \"font-semibold text-foreground\",\n                    isMobile ? \"text-lg leading-tight\" : \"text-xl\"\n                  )}>\n                    {citationData.title}\n                  </h3>\n                </div>\n\n                {/* URL */}\n                <div className={cn(\n                  \"flex items-center gap-2 text-muted-foreground\",\n                  isMobile ? \"text-sm\" : \"text-sm\"\n                )}>\n                  <Globe className={cn(\n                    \"flex-shrink-0\",\n                    isMobile ? \"h-4 w-4\" : \"h-4 w-4\"\n                  )} />\n                  <a\n                    href={citationData.url}\n                    target=\"_blank\"\n                    rel=\"noopener noreferrer\"\n                    className={cn(\n                      \"hover:text-brand-600 transition-colors\",\n                      isMobile ? \"break-all\" : \"truncate\"\n                    )}\n                  >\n                    {citationData.url}\n                  </a>\n                </div>\n\n                {/* Description */}\n                {citationData.description && (\n                  <div className=\"prose prose-gray dark:prose-invert max-w-none\">\n                    <p className={cn(\n                      \"text-foreground\",\n                      isMobile ? \"text-sm leading-relaxed\" : \"\"\n                    )}>{citationData.description}</p>\n                  </div>\n                )}\n\n                {/* Metadata */}\n                <div className={cn(\n                  \"pt-4 border-t border-border space-y-3\",\n                  isMobile && \"space-y-3\"\n                )}>\n                  <div className={cn(\n                    \"flex items-center justify-between\",\n                    isMobile ? \"text-sm\" : \"text-sm\"\n                  )}>\n                    <span className=\"text-muted-foreground\">Citation ID</span>\n                    <span className={cn(\n                      \"font-mono text-foreground\",\n                      isMobile ? \"text-base\" : \"\"\n                    )}>#{citationData.id}</span>\n                  </div>\n                  {citationData.image && (\n                    <div className={cn(\n                      \"flex items-center justify-between\",\n                      isMobile ? \"text-sm\" : \"text-sm\"\n                    )}>\n                      <span className=\"text-muted-foreground\">Has preview image</span>\n                      <ImageIcon className={cn(\n                        \"text-muted-foreground\",\n                        isMobile ? \"h-4 w-4\" : \"h-4 w-4\"\n                      )} />\n                    </div>\n                  )}\n                </div>\n              </div>\n            ) : null}\n          </div>\n\n          {/* Footer */}\n          <div className={cn(\n            \"border-t bg-muted flex-shrink-0\",\n            isMobile ? \"p-4 safe-area-pb\" : \"p-4\"\n          )}>\n            <div className={cn(\n              \"flex items-center\",\n              isMobile ? \"flex-col gap-3\" : \"justify-between\"\n            )}>\n              <div className={cn(\n                \"text-muted-foreground\",\n                isMobile ? \"text-xs text-center\" : \"text-xs\"\n              )}>\n                Open Graph data from cited source\n              </div>\n              {citationData && (\n                <a\n                  href={citationData.url}\n                  target=\"_blank\"\n                  rel=\"noopener noreferrer\"\n                  className={cn(\n                    \"inline-flex items-center gap-2 font-medium text-brand-600 hover:text-brand-700 transition-colors\",\n                    isMobile \n                      ? \"w-full justify-center bg-brand-600 text-white hover:bg-brand-700 hover:text-white rounded-lg px-4 py-3 text-base touch-target\" \n                      : \"px-3 py-1.5 text-sm\"\n                  )}\n                >\n                  Visit source\n                  <ExternalLink className={cn(\n                    isMobile ? \"h-4 w-4\" : \"h-3.5 w-3.5\"\n                  )} />\n                </a>\n              )}\n            </div>\n          </div>\n          </motion.div>\n        </>\n      )}\n    </AnimatePresence>\n  );\n};","'use client';\n\nimport React, { useState, useEffect, useCallback } from 'react';\nimport { motion, AnimatePresence } from 'framer-motion';\nimport { \n  X, \n  FileText,\n  Download,\n  Loader,\n  AlertCircle,\n  Copy,\n  Check\n} from 'lucide-react';\n\nimport { Button } from '@/components/ui/button';\nimport { cn } from '@/lib/utils';\nimport { getClient } from '@/lib/api/client';\nimport { logger } from '@/lib/logger';\nimport { toast } from 'sonner';\n\ninterface CitationFilePreviewProps {\n  isOpen: boolean;\n  onClose: () => void;\n  citationId: string;\n  fileName?: string;\n}\n\nexport const CitationFilePreview: React.FC<CitationFilePreviewProps> = ({\n  isOpen,\n  onClose,\n  citationId,\n  fileName = 'Citation File'\n}) => {\n  const [loading, setLoading] = useState(false);\n  const [error, setError] = useState<string | null>(null);\n  const [fileContent, setFileContent] = useState<string | null>(null);\n  const [contentType, setContentType] = useState<string>('text/plain');\n  const [copied, setCopied] = useState(false);\n\n  const fetchFilePreview = useCallback(async () => {\n    setLoading(true);\n    setError(null);\n\n    try {\n      const client = getClient();\n      const response = await client.previewCitationFile(citationId);\n      \n      // Handle different response formats\n      if (typeof response === 'string') {\n        setFileContent(response);\n        setContentType('text/plain');\n      } else if (response.data) {\n        setFileContent(response.data.content || response.data);\n        setContentType(response.data.content_type || 'text/plain');\n      } else {\n        setFileContent(JSON.stringify(response, null, 2));\n        setContentType('application/json');\n      }\n      \n      logger.info('CITATION_PREVIEW', 'File preview fetched', {\n        citationId,\n        contentLength: fileContent?.length\n      });\n    } catch (err: any) {\n      logger.error('CITATION_PREVIEW', 'Failed to fetch file preview', {\n        error: err,\n        citationId\n      });\n      \n      if (err.status === 400) {\n        setError('Invalid citation ID.');\n      } else if (err.status === 401) {\n        setError('Authentication failed. Please log in again.');\n      } else if (err.status === 403) {\n        setError('Access denied. You do not have permission to view this file.');\n      } else if (err.status === 404) {\n        setError('Citation file not found.');\n      } else if (err.status === 500) {\n        setError('Server error. Please try again later.');\n      } else {\n        setError('Failed to load file preview.');\n      }\n    } finally {\n      setLoading(false);\n    }\n  }, [citationId]);\n\n  useEffect(() => {\n    if (isOpen && citationId) {\n      fetchFilePreview();\n    }\n  }, [isOpen, citationId, fetchFilePreview]);\n\n  const handleCopy = async () => {\n    if (!fileContent) return;\n    \n    try {\n      await navigator.clipboard.writeText(fileContent);\n      setCopied(true);\n      toast.success('Content copied to clipboard');\n      setTimeout(() => setCopied(false), 2000);\n    } catch (err) {\n      toast.error('Failed to copy content');\n    }\n  };\n\n  const handleDownload = () => {\n    if (!fileContent) return;\n    \n    const blob = new Blob([fileContent], { type: contentType });\n    const url = URL.createObjectURL(blob);\n    const a = document.createElement('a');\n    a.href = url;\n    a.download = fileName;\n    document.body.appendChild(a);\n    a.click();\n    document.body.removeChild(a);\n    URL.revokeObjectURL(url);\n    \n    toast.success('File downloaded');\n  };\n\n  if (!isOpen) return null;\n\n  return (\n    <AnimatePresence>\n      <div className=\"fixed inset-0 z-50 flex items-center justify-center p-4\">\n        {/* Backdrop */}\n        <motion.div\n          initial={{ opacity: 0 }}\n          animate={{ opacity: 1 }}\n          exit={{ opacity: 0 }}\n          onClick={onClose}\n          className=\"absolute inset-0 bg-black/50\"\n        />\n\n        {/* Modal */}\n        <motion.div\n          initial={{ opacity: 0, scale: 0.95 }}\n          animate={{ opacity: 1, scale: 1 }}\n          exit={{ opacity: 0, scale: 0.95 }}\n          className=\"relative bg-background rounded-lg shadow-xl max-w-4xl w-full max-h-[90vh] overflow-hidden\"\n        >\n          {/* Header */}\n          <div className=\"flex items-center justify-between p-4 border-b border-border\">\n            <div className=\"flex items-center gap-3\">\n              <FileText className=\"h-5 w-5 text-muted-foreground\" />\n              <h2 className=\"text-lg font-semibold text-foreground\">\n                {fileName}\n              </h2>\n            </div>\n            <div className=\"flex items-center gap-2\">\n              <Button\n                variant=\"outline\"\n                size=\"sm\"\n                onClick={handleCopy}\n                disabled={!fileContent}\n              >\n                {copied ? (\n                  <>\n                    <Check className=\"h-4 w-4 mr-2\" />\n                    Copied\n                  </>\n                ) : (\n                  <>\n                    <Copy className=\"h-4 w-4 mr-2\" />\n                    Copy\n                  </>\n                )}\n              </Button>\n              <Button\n                variant=\"outline\"\n                size=\"sm\"\n                onClick={handleDownload}\n                disabled={!fileContent}\n              >\n                <Download className=\"h-4 w-4 mr-2\" />\n                Download\n              </Button>\n              <Button\n                variant=\"ghost\"\n                size=\"icon\"\n                onClick={onClose}\n                className=\"h-8 w-8\"\n              >\n                <X className=\"h-4 w-4\" />\n              </Button>\n            </div>\n          </div>\n\n          {/* Content */}\n          <div className=\"p-4 overflow-y-auto max-h-[calc(90vh-120px)]\">\n            {loading ? (\n              <div className=\"flex items-center justify-center py-12\">\n                <Loader className=\"h-8 w-8 animate-spin text-muted-foreground\" />\n              </div>\n            ) : error ? (\n              <div className=\"flex items-center gap-3 p-4 bg-red-50 rounded-lg\">\n                <AlertCircle className=\"h-5 w-5 text-red-600 flex-shrink-0\" />\n                <div className=\"flex-1\">\n                  <p className=\"text-sm font-medium text-destructive\">Error loading file</p>\n                  <p className=\"text-sm text-destructive/90 mt-1\">{error}</p>\n                </div>\n              </div>\n            ) : fileContent ? (\n              <div className=\"font-mono text-sm bg-accent rounded-lg p-4 text-foreground\">\n                <pre className=\"whitespace-pre-wrap break-words\">\n                  {fileContent}\n                </pre>\n              </div>\n            ) : null}\n          </div>\n\n          {/* Footer */}\n          <div className=\"p-4 border-t border-border bg-accent\">\n            <div className=\"flex items-center justify-between\">\n              <div className=\"text-xs text-muted-foreground\">\n                Citation ID: {citationId}\n              </div>\n              <div className=\"text-xs text-muted-foreground\">\n                {contentType}\n              </div>\n            </div>\n          </div>\n        </motion.div>\n      </div>\n    </AnimatePresence>\n  );\n};","/**\n * Message Error Display Component\n * \n * Displays error messages with appropriate styling and context based on HTTP status codes.\n * Provides user-friendly error messages and actionable guidance.\n */\n\nimport React from 'react';\nimport { AlertCircle, XCircle, CreditCard, UserX, Search, ServerCrash } from 'lucide-react';\nimport { Button } from '@/components/ui/button';\nimport { cn } from '@/lib/utils';\n\ninterface MessageErrorDisplayProps {\n  error: string | Error;\n  statusCode?: number;\n  onRetry?: () => void;\n  className?: string;\n}\n\n/**\n * Parse error to extract status code and message\n */\nconst parseError = (error: string | Error): { statusCode?: number; message: string } => {\n  if (typeof error === 'string') {\n    // Try to extract status code from error message\n    const statusMatch = error.match(/(\\d{3})/);\n    const statusCode = statusMatch ? parseInt(statusMatch[1]) : undefined;\n    return { statusCode, message: error };\n  }\n  \n  return { \n    statusCode: (error as any).status || (error as any).statusCode,\n    message: error.message \n  };\n};\n\n/**\n * Get error details based on status code\n */\nconst getErrorDetails = (statusCode?: number, message?: string) => {\n  switch (statusCode) {\n    case 400:\n      return {\n        icon: AlertCircle,\n        title: 'Invalid Request',\n        description: 'The request format is invalid. Please check your input and try again.',\n        className: 'border-orange-200 bg-orange-50',\n        iconClassName: 'text-orange-600',\n        textClassName: 'text-orange-800',\n      };\n      \n    case 401:\n      return {\n        icon: UserX,\n        title: 'Authentication Failed',\n        description: 'Your API key is either missing or invalid. Please check your API key configuration.',\n        className: 'border-red-200 bg-red-50',\n        iconClassName: 'text-red-600',\n        textClassName: 'text-red-800',\n        showSupport: true,\n      };\n      \n    case 403:\n      // Check if this is an inactive agent error\n      const isInactiveAgent = message && (\n        message.toLowerCase().includes('inactive') ||\n        message.toLowerCase().includes('no documents') ||\n        message.toLowerCase().includes('agent is not active') ||\n        message.toLowerCase().includes('project is not active') ||\n        message.toLowerCase().includes('no documents uploaded')\n      );\n      \n      if (isInactiveAgent) {\n        return {\n          icon: AlertCircle,\n          title: 'Agent Inactive',\n          description: 'This agent is inactive. Please add documents to activate it before starting a conversation.',\n          className: 'border-orange-200 bg-orange-50',\n          iconClassName: 'text-orange-600',\n          textClassName: 'text-orange-800',\n        };\n      }\n      \n      return {\n        icon: UserX,\n        title: 'Access Denied',\n        description: 'You don\\'t have permission to access this resource. Please check your API key permissions.',\n        className: 'border-red-200 bg-red-50',\n        iconClassName: 'text-red-600',\n        textClassName: 'text-red-800',\n        showSupport: true,\n      };\n      \n    case 404:\n      return {\n        icon: Search,\n        title: 'Not Found',\n        description: 'The requested agent or conversation was not found. It may have been deleted or you may not have access.',\n        className: 'border-border bg-accent',\n        iconClassName: 'text-muted-foreground',\n        textClassName: 'text-foreground',\n      };\n      \n    case 429:\n      return {\n        icon: CreditCard,\n        title: 'Query Credits Exhausted',\n        description: 'You have exhausted your current query credits. Please contact customer service for assistance.',\n        className: 'border-yellow-200 bg-yellow-50',\n        iconClassName: 'text-yellow-600',\n        textClassName: 'text-yellow-800',\n        showSupport: true,\n        supportUrl: 'https://customgpt.freshdesk.com/support/home',\n      };\n      \n    case 500:\n    case 502:\n    case 503:\n    case 504:\n      return {\n        icon: ServerCrash,\n        title: 'Server Error',\n        description: 'An internal server error occurred. Please try again later or contact support if the issue persists.',\n        className: 'border-red-200 bg-red-50',\n        iconClassName: 'text-red-600',\n        textClassName: 'text-red-800',\n        showRetry: true,\n      };\n      \n    default:\n      return {\n        icon: XCircle,\n        title: 'Error',\n        description: message || 'An unexpected error occurred. Please try again.',\n        className: 'border-red-200 bg-red-50',\n        iconClassName: 'text-red-600',\n        textClassName: 'text-red-800',\n        showRetry: true,\n      };\n  }\n};\n\nexport const MessageErrorDisplay: React.FC<MessageErrorDisplayProps> = ({\n  error,\n  statusCode: propStatusCode,\n  onRetry,\n  className,\n}) => {\n  const { statusCode: parsedStatusCode, message } = parseError(error);\n  const finalStatusCode = propStatusCode || parsedStatusCode;\n  \n  const errorDetails = getErrorDetails(finalStatusCode, message);\n  const Icon = errorDetails.icon;\n  \n  return (\n    <div\n      className={cn(\n        'p-4 rounded-lg border',\n        errorDetails.className,\n        className\n      )}\n    >\n      <div className=\"flex items-start gap-3\">\n        <Icon className={cn('w-5 h-5 mt-0.5 flex-shrink-0', errorDetails.iconClassName)} />\n        \n        <div className=\"flex-1 space-y-2\">\n          <div>\n            <h3 className={cn('font-medium', errorDetails.textClassName)}>\n              {errorDetails.title}\n              {finalStatusCode && ` (${finalStatusCode})`}\n            </h3>\n            <p className={cn('text-sm mt-1', errorDetails.textClassName, 'opacity-90')}>\n              {errorDetails.description}\n            </p>\n          </div>\n          \n          {/* Action Buttons */}\n          <div className=\"flex items-center gap-2 mt-3\">\n            {errorDetails.showRetry && onRetry && (\n              <Button\n                size=\"sm\"\n                variant=\"outline\"\n                onClick={onRetry}\n                className=\"text-xs\"\n              >\n                Try Again\n              </Button>\n            )}\n            \n            {errorDetails.showSupport && (\n              <a\n                href={errorDetails.supportUrl || 'https://customgpt.freshdesk.com/support/home'}\n                target=\"_blank\"\n                rel=\"noopener noreferrer\"\n                className=\"text-xs underline hover:no-underline\"\n              >\n                Contact Support\n              </a>\n            )}\n          </div>\n          \n          {/* Technical Details (collapsed by default) */}\n          {message && message !== errorDetails.description && (\n            <details className=\"mt-3\">\n              <summary className={cn('text-xs cursor-pointer', errorDetails.textClassName, 'opacity-70')}>\n                Technical Details\n              </summary>\n              <pre className={cn(\n                'mt-2 p-2 text-xs rounded bg-background bg-opacity-50 overflow-x-auto',\n                errorDetails.textClassName,\n                'opacity-80'\n              )}>\n                {message}\n              </pre>\n            </details>\n          )}\n        </div>\n      </div>\n    </div>\n  );\n};","/**\n * Widget Store Hooks\n * \n * These hooks automatically select between global and widget-specific stores\n * based on whether the component is rendered inside a widget context.\n */\n\nimport { useContext } from 'react';\nimport { useStore } from 'zustand';\nimport { WidgetStoreContext } from '../widget/WidgetStoreContext';\nimport { useMessageStore as useGlobalMessageStore } from '../store';\nimport { useConversationStore as useGlobalConversationStore } from '../store';\nimport { useAgentStore as useGlobalAgentStore } from '../store';\nimport type { MessageStore } from '../store/widget-stores/messages';\nimport type { ConversationStore } from '../store/widget-stores/conversations';\nimport type { AgentStore } from '../store/widget-stores/agents';\n\n/**\n * Check if we're inside a widget context\n */\nfunction useIsInWidgetContext(): boolean {\n  try {\n    const context = useContext(WidgetStoreContext);\n    return context !== null;\n  } catch {\n    return false;\n  }\n}\n\n/**\n * Get widget stores if inside widget context\n */\nfunction useWidgetStores() {\n  const context = useContext(WidgetStoreContext);\n  return context?.stores;\n}\n\n/**\n * Message store hook that automatically selects the correct store\n */\nexport function useMessageStore() {\n  const isInWidget = useIsInWidgetContext();\n  const widgetStores = useWidgetStores();\n  const globalStore = useGlobalMessageStore();\n  const widgetStore = useStore(\n    widgetStores?.messageStore || useGlobalMessageStore,\n    (state) => state\n  );\n  \n  return isInWidget && widgetStores ? widgetStore : globalStore;\n}\n\n/**\n * Conversation store hook that automatically selects the correct store\n */\nexport function useConversationStore() {\n  const isInWidget = useIsInWidgetContext();\n  const widgetStores = useWidgetStores();\n  const globalStore = useGlobalConversationStore();\n  const widgetStore = useStore(\n    widgetStores?.conversationStore || useGlobalConversationStore,\n    (state) => state\n  );\n  \n  return isInWidget && widgetStores ? widgetStore : globalStore;\n}\n\n/**\n * Agent store hook that automatically selects the correct store\n */\nexport function useAgentStore() {\n  const isInWidget = useIsInWidgetContext();\n  const widgetStores = useWidgetStores();\n  const globalStore = useGlobalAgentStore();\n  const widgetStore = useStore(\n    widgetStores?.agentStore || useGlobalAgentStore,\n    (state) => state\n  );\n  \n  return isInWidget && widgetStores ? widgetStore : globalStore;\n}\n\n/**\n * Export convenience functions to check store source\n */\nexport function useIsUsingWidgetStore(): boolean {\n  return useIsInWidgetContext();\n}\n\n/**\n * Get the current session ID if in widget context\n */\nexport function useWidgetSessionId(): string | null {\n  const context = useContext(WidgetStoreContext);\n  if (!context) return null;\n  \n  // Extract session ID from the store's localStorage key\n  const messageStore = context.stores.messageStore;\n  const state = messageStore.getState();\n  \n  // Session ID would need to be added to context for retrieval\n  return null;\n}","/**\n * Theme Manager\n * \n * Orchestrates theme switching, loading, and lifecycle management.\n * Provides centralized access to all available voice themes.\n */\n\nimport { IVoiceTheme, ThemeMetadata, ThemeFactory, VoiceState } from './IVoiceTheme';\n\nexport interface ThemeTransitionOptions {\n  duration: number;\n  easing: 'linear' | 'ease-in' | 'ease-out' | 'ease-in-out';\n  crossfade: boolean;\n}\n\nexport interface ThemeRegistration {\n  id: string;\n  factory: ThemeFactory;\n  metadata: ThemeMetadata;\n}\n\n/**\n * Theme Manager - Singleton class for managing voice themes\n */\nexport class ThemeManager {\n  private static instance: ThemeManager;\n  private registeredThemes: Map<string, ThemeRegistration> = new Map();\n  private currentTheme: IVoiceTheme | null = null;\n  private canvas: HTMLCanvasElement | null = null;\n  private context: CanvasRenderingContext2D | null = null;\n  \n  // Transition state\n  private isTransitioning = false;\n  private transitionTheme: IVoiceTheme | null = null;\n  private transitionProgress = 0;\n  private transitionOptions: ThemeTransitionOptions = {\n    duration: 1000,\n    easing: 'ease-in-out',\n    crossfade: true\n  };\n\n  // Event callbacks\n  private callbacks: {\n    onThemeChange?: (oldTheme: string | null, newTheme: string) => void;\n    onTransitionStart?: (from: string | null, to: string) => void;\n    onTransitionComplete?: (themeId: string) => void;\n    onThemeError?: (error: Error, themeId: string) => void;\n  } = {};\n\n  private constructor() {\n    this.registerBuiltInThemes();\n  }\n\n  /**\n   * Get singleton instance\n   */\n  static getInstance(): ThemeManager {\n    if (!ThemeManager.instance) {\n      ThemeManager.instance = new ThemeManager();\n    }\n    return ThemeManager.instance;\n  }\n\n  /**\n   * Initialize with canvas context\n   */\n  initialize(canvas: HTMLCanvasElement, context: CanvasRenderingContext2D): void {\n    this.canvas = canvas;\n    this.context = context;\n    \n    // Initialize current theme if one is set\n    if (this.currentTheme && this.context) {\n      this.currentTheme.init(this.context, canvas.width, canvas.height);\n    }\n  }\n\n  /**\n   * Register a new theme\n   */\n  registerTheme(registration: ThemeRegistration): void {\n    if (this.registeredThemes.has(registration.id)) {\n      console.warn(`Theme ${registration.id} is already registered. Overwriting.`);\n    }\n    \n    this.registeredThemes.set(registration.id, registration);\n    console.log(`Registered theme: ${registration.id}`);\n  }\n\n  /**\n   * Unregister a theme\n   */\n  unregisterTheme(themeId: string): boolean {\n    if (this.currentTheme?.id === themeId) {\n      console.warn(`Cannot unregister active theme: ${themeId}`);\n      return false;\n    }\n    \n    return this.registeredThemes.delete(themeId);\n  }\n\n  /**\n   * Get all available themes metadata\n   */\n  getAvailableThemes(): ThemeMetadata[] {\n    return Array.from(this.registeredThemes.values()).map(reg => reg.metadata);\n  }\n\n  /**\n   * Get theme metadata by ID\n   */\n  getThemeMetadata(themeId: string): ThemeMetadata | null {\n    const registration = this.registeredThemes.get(themeId);\n    return registration ? registration.metadata : null;\n  }\n\n  /**\n   * Switch to a new theme\n   */\n  async switchTheme(themeId: string, transitionOptions?: Partial<ThemeTransitionOptions>): Promise<boolean> {\n    if (this.isTransitioning) {\n      console.warn('Theme transition already in progress');\n      return false;\n    }\n\n    const registration = this.registeredThemes.get(themeId);\n    if (!registration) {\n      const error = new Error(`Theme not found: ${themeId}`);\n      this.callbacks.onThemeError?.(error, themeId);\n      return false;\n    }\n\n    // If this is the current theme, no need to switch\n    if (this.currentTheme?.id === themeId) {\n      return true;\n    }\n\n    try {\n      // Update transition options\n      this.transitionOptions = { ...this.transitionOptions, ...transitionOptions };\n\n      // Create new theme instance\n      const newTheme = registration.factory();\n      \n      // Initialize with current context if available\n      if (this.context && this.canvas) {\n        newTheme.init(this.context, this.canvas.width, this.canvas.height);\n      }\n\n      // Start transition\n      await this.performThemeTransition(newTheme);\n      \n      return true;\n    } catch (error) {\n      console.error(`Failed to switch to theme ${themeId}:`, error);\n      this.callbacks.onThemeError?.(error as Error, themeId);\n      return false;\n    }\n  }\n\n  /**\n   * Get current active theme\n   */\n  getCurrentTheme(): IVoiceTheme | null {\n    return this.currentTheme;\n  }\n\n  /**\n   * Get current theme ID\n   */\n  getCurrentThemeId(): string | null {\n    return this.currentTheme?.id || null;\n  }\n\n  /**\n   * Set event callbacks\n   */\n  setCallbacks(callbacks: Partial<typeof this.callbacks>): void {\n    this.callbacks = { ...this.callbacks, ...callbacks };\n  }\n\n  /**\n   * Draw current theme (delegated from Canvas component)\n   */\n  draw(\n    context: CanvasRenderingContext2D,\n    displayWidth: number,\n    displayHeight: number,\n    projCenterX: number,\n    projCenterY: number,\n    deltaTime: number\n  ): void {\n    if (this.isTransitioning && this.transitionOptions.crossfade) {\n      this.drawTransition(context, displayWidth, displayHeight, projCenterX, projCenterY, deltaTime);\n    } else if (this.currentTheme) {\n      this.currentTheme.draw(context, displayWidth, displayHeight, projCenterX, projCenterY, deltaTime);\n    }\n  }\n\n  /**\n   * Forward state changes to current theme\n   */\n  onUserSpeaking(): void {\n    this.currentTheme?.onUserSpeaking();\n    this.transitionTheme?.onUserSpeaking();\n  }\n\n  onProcessing(): void {\n    this.currentTheme?.onProcessing();\n    this.transitionTheme?.onProcessing();\n  }\n\n  onAiSpeaking(): void {\n    this.currentTheme?.onAiSpeaking();\n    this.transitionTheme?.onAiSpeaking();\n  }\n\n  reset(): void {\n    this.currentTheme?.reset();\n    this.transitionTheme?.reset();\n  }\n\n  /**\n   * Forward mouse events to current theme\n   */\n  setMousePosition(x: number, y: number, canvasWidth: number, canvasHeight: number): void {\n    this.currentTheme?.setMousePosition(x, y, canvasWidth, canvasHeight);\n    this.transitionTheme?.setMousePosition(x, y, canvasWidth, canvasHeight);\n  }\n\n  setHovering(hovering: boolean): void {\n    this.currentTheme?.setHovering(hovering);\n    this.transitionTheme?.setHovering(hovering);\n  }\n\n  /**\n   * Get performance metrics from current theme\n   */\n  getPerformanceMetrics() {\n    return this.currentTheme?.getPerformanceMetrics() || {};\n  }\n\n  /**\n   * Dispose of all resources\n   */\n  dispose(): void {\n    this.currentTheme?.dispose();\n    this.transitionTheme?.dispose();\n    this.currentTheme = null;\n    this.transitionTheme = null;\n    this.isTransitioning = false;\n  }\n\n  // Private methods\n\n  /**\n   * Register built-in themes\n   */\n  private registerBuiltInThemes(): void {\n    // Import themes dynamically to avoid circular dependencies\n    import('./DefaultTheme').then(({ DefaultTheme }) => {\n      this.registerTheme({\n        id: 'default',\n        factory: () => new DefaultTheme(),\n        metadata: {\n          id: 'default',\n          name: 'Classic Sphere',\n          description: 'The original 3D particle sphere with smooth color transitions',\n          category: 'particle',\n          performanceProfile: 'medium',\n          previewColors: ['#4285F4', '#34A853', '#EA4335'],\n          previewDescription: 'Rotating particle sphere with dynamic colors'\n        }\n      });\n    });\n\n    import('./StarfieldTheme').then(({ StarfieldTheme }) => {\n      this.registerTheme({\n        id: 'starfield',\n        factory: () => new StarfieldTheme(),\n        metadata: {\n          id: 'starfield',\n          name: 'Cosmic Starfield',\n          description: 'Twinkling stars, dynamic constellations, and flowing nebula clouds',\n          category: 'particle',\n          performanceProfile: 'medium',\n          previewColors: ['#FFFFFF', '#ADD8E6', '#FFD700', '#FFC0CB'],\n          previewDescription: 'Immersive space environment with stars and constellations'\n        }\n      });\n    });\n\n    import('./JarvisTheme').then(({ JarvisTheme }) => {\n      this.registerTheme({\n        id: 'jarvis',\n        factory: () => new JarvisTheme(),\n        metadata: {\n          id: 'jarvis',\n          name: 'J.A.R.V.I.S.',\n          description: 'Advanced AI interface with arc reactor, HUD elements, and energy particles',\n          category: 'advanced',\n          performanceProfile: 'heavy',\n          previewColors: ['#00A2E8', '#00FFFF', '#FF6500', '#FF00FF'],\n          previewDescription: 'Iron Man-inspired technological interface with arc reactor'\n        }\n      });\n    });\n\n    import('./LegoTheme').then(({ LegoTheme }) => {\n      this.registerTheme({\n        id: 'lego',\n        factory: () => new LegoTheme(),\n        metadata: {\n          id: 'lego',\n          name: 'LEGO Blocks',\n          description: '3D building blocks that construct and deconstruct with satisfying physics',\n          category: 'artistic',\n          performanceProfile: 'medium',\n          previewColors: ['#C4281C', '#0D69AB', '#12852B', '#F5CD2F'],\n          previewDescription: 'Interactive LEGO blocks building structures with authentic colors'\n        }\n      });\n    });\n\n    import('./StarWarsTheme').then(({ StarWarsTheme }) => {\n      this.registerTheme({\n        id: 'starwars',\n        factory: () => new StarWarsTheme(),\n        metadata: {\n          id: 'starwars',\n          name: 'Star Wars',\n          description: 'Lightsabers, holograms, and the Force in a galaxy far, far away',\n          category: 'advanced',\n          performanceProfile: 'heavy',\n          previewColors: ['#00A2FF', '#FF0000', '#00FF00', '#9333EA'],\n          previewDescription: 'Epic Star Wars experience with lightsabers and hologram effects'\n        }\n      });\n    });\n\n    import('./OceanWaveTheme').then(({ OceanWaveTheme }) => {\n      this.registerTheme({\n        id: 'ocean',\n        factory: () => new OceanWaveTheme(),\n        metadata: {\n          id: 'ocean',\n          name: 'Ocean Waves',\n          description: 'Calming underwater environment with waves, bubbles, and marine life',\n          category: 'particle',\n          performanceProfile: 'medium',\n          previewColors: ['#0077BE', '#00BCF2', '#C8E6FF', '#98CB3B'],\n          previewDescription: 'Serene ocean experience with realistic wave physics and bubbles'\n        }\n      });\n    });\n\n    import('./NFTTheme').then(({ NFTTheme }) => {\n      this.registerTheme({\n        id: 'nft',\n        factory: () => new NFTTheme(),\n        metadata: {\n          id: 'nft',\n          name: 'NFT Art',\n          description: 'Vibrant digital art with morphing shapes, dynamic gradients, and artistic trails',\n          category: 'artistic',\n          performanceProfile: 'heavy',\n          previewColors: ['#FF00FF', '#00FFFF', '#FFFF00', '#8000FF', '#FF0080'],\n          previewDescription: 'Bold NFT-style aesthetics with morphing geometric shapes'\n        }\n      });\n    });\n\n    import('./NothingPhoneTheme').then(({ NothingPhoneTheme }) => {\n      this.registerTheme({\n        id: 'nothing',\n        factory: () => new NothingPhoneTheme(),\n        metadata: {\n          id: 'nothing',\n          name: 'Nothing Phone',\n          description: 'Minimalist design inspired by Nothing Phone with clean dots and typography',\n          category: 'artistic',\n          performanceProfile: 'light',\n          previewColors: ['#FFFFFF', '#F5F5F5', '#C8C8C8', '#808080', '#000000'],\n          previewDescription: 'Clean minimalist interface with Glyph-inspired dot patterns'\n        }\n      });\n    });\n\n    import('./MinecraftTheme').then(({ MinecraftTheme }) => {\n      this.registerTheme({\n        id: 'minecraft',\n        factory: () => new MinecraftTheme(),\n        metadata: {\n          id: 'minecraft',\n          name: 'Minecraft',\n          description: 'Blocky voxel world with building, breaking, and crafting animations',\n          category: 'artistic',\n          performanceProfile: 'medium',\n          previewColors: ['#7CBD52', '#FEF63F', '#A28A4E', '#63EDE5', '#888888'],\n          previewDescription: 'Interactive voxel blocks with authentic Minecraft aesthetics'\n        }\n      });\n    });\n\n    import('./FuturisticTheme').then(({ FuturisticTheme }) => {\n      this.registerTheme({\n        id: 'futuristic',\n        factory: () => new FuturisticTheme(),\n        metadata: {\n          id: 'futuristic',\n          name: 'Futuristic',\n          description: 'High-tech cyberpunk interface with holograms, wireframes, and data streams',\n          category: 'advanced',\n          performanceProfile: 'heavy',\n          previewColors: ['#00FFFF', '#FF00FF', '#FFFF00', '#00FF00', '#0096FF'],\n          previewDescription: 'Cyberpunk-inspired holographic displays and wireframe models'\n        }\n      });\n    });\n\n    import('./VintageModernTheme').then(({ VintageModernTheme }) => {\n      this.registerTheme({\n        id: 'vintage-modern',\n        factory: () => new VintageModernTheme(),\n        metadata: {\n          id: 'vintage-modern',\n          name: 'Vintage Modern',\n          description: 'Retro aesthetics meets modern design with film grain and neon glow',\n          category: 'artistic',\n          performanceProfile: 'medium',\n          previewColors: ['#FF6F91', '#FF9A00', '#ED75FF', '#5FE1FA', '#FFF176'],\n          previewDescription: 'Nostalgic blend of retro TV effects with modern animations'\n        }\n      });\n    });\n\n    import('./AuroraTheme').then(({ AuroraTheme }) => {\n      this.registerTheme({\n        id: 'aurora',\n        factory: () => new AuroraTheme(),\n        metadata: {\n          id: 'aurora',\n          name: 'Aurora Borealis',\n          description: 'Ethereal northern lights with flowing ribbons and magnetic fields',\n          category: 'particle',\n          performanceProfile: 'heavy',\n          previewColors: ['#00FF00', '#0064FF', '#9300D3', '#FF0064', '#5FE1FA'],\n          previewDescription: 'Mesmerizing aurora borealis with realistic light bands'\n        }\n      });\n    });\n\n    console.log('ThemeManager: Built-in themes registered');\n  }\n\n  /**\n   * Perform theme transition\n   */\n  private async performThemeTransition(newTheme: IVoiceTheme): Promise<void> {\n    const oldTheme = this.currentTheme;\n    const oldThemeId = oldTheme?.id || null;\n    \n    this.isTransitioning = true;\n    this.transitionTheme = newTheme;\n    this.transitionProgress = 0;\n\n    // Notify callbacks\n    this.callbacks.onTransitionStart?.(oldThemeId, newTheme.id);\n\n    // If crossfade is disabled, immediately switch\n    if (!this.transitionOptions.crossfade) {\n      this.completeTransition(newTheme, oldTheme);\n      return;\n    }\n\n    // Animate transition\n    return new Promise((resolve) => {\n      const startTime = performance.now();\n      const { duration, easing } = this.transitionOptions;\n\n      const animate = (currentTime: number) => {\n        const elapsed = currentTime - startTime;\n        let progress = Math.min(elapsed / duration, 1);\n\n        // Apply easing\n        progress = this.applyEasing(progress, easing);\n        this.transitionProgress = progress;\n\n        if (progress >= 1) {\n          this.completeTransition(newTheme, oldTheme);\n          resolve();\n        } else {\n          requestAnimationFrame(animate);\n        }\n      };\n\n      requestAnimationFrame(animate);\n    });\n  }\n\n  /**\n   * Complete theme transition\n   */\n  private completeTransition(newTheme: IVoiceTheme, oldTheme: IVoiceTheme | null): void {\n    // Clean up old theme\n    oldTheme?.dispose();\n\n    // Set new theme as current\n    this.currentTheme = newTheme;\n    this.transitionTheme = null;\n    this.isTransitioning = false;\n    this.transitionProgress = 0;\n\n    // Notify callbacks\n    this.callbacks.onThemeChange?.(oldTheme?.id || null, newTheme.id);\n    this.callbacks.onTransitionComplete?.(newTheme.id);\n\n    console.log(`Theme switched to: ${newTheme.id}`);\n  }\n\n  /**\n   * Draw crossfade transition between themes\n   */\n  private drawTransition(\n    context: CanvasRenderingContext2D,\n    displayWidth: number,\n    displayHeight: number,\n    projCenterX: number,\n    projCenterY: number,\n    deltaTime: number\n  ): void {\n    // Create temporary canvases for each theme\n    const tempCanvas1 = document.createElement('canvas');\n    const tempCanvas2 = document.createElement('canvas');\n    tempCanvas1.width = tempCanvas2.width = displayWidth;\n    tempCanvas1.height = tempCanvas2.height = displayHeight;\n    \n    const tempCtx1 = tempCanvas1.getContext('2d');\n    const tempCtx2 = tempCanvas2.getContext('2d');\n\n    if (!tempCtx1 || !tempCtx2) return;\n\n    // Draw old theme to first canvas\n    if (this.currentTheme) {\n      this.currentTheme.draw(tempCtx1, displayWidth, displayHeight, projCenterX, projCenterY, deltaTime);\n    }\n\n    // Draw new theme to second canvas\n    if (this.transitionTheme) {\n      this.transitionTheme.draw(tempCtx2, displayWidth, displayHeight, projCenterX, projCenterY, deltaTime);\n    }\n\n    // Clear main canvas\n    context.clearRect(0, 0, displayWidth, displayHeight);\n\n    // Draw old theme with fading alpha\n    context.globalAlpha = 1 - this.transitionProgress;\n    context.drawImage(tempCanvas1, 0, 0);\n\n    // Draw new theme with increasing alpha\n    context.globalAlpha = this.transitionProgress;\n    context.drawImage(tempCanvas2, 0, 0);\n\n    // Reset alpha\n    context.globalAlpha = 1;\n  }\n\n  /**\n   * Apply easing function to transition progress\n   */\n  private applyEasing(t: number, easing: string): number {\n    switch (easing) {\n      case 'linear':\n        return t;\n      case 'ease-in':\n        return t * t;\n      case 'ease-out':\n        return t * (2 - t);\n      case 'ease-in-out':\n        return t < 0.5 ? 2 * t * t : -1 + (4 - 2 * t) * t;\n      default:\n        return t;\n    }\n  }\n}\n\n/**\n * Convenience function to get theme manager instance\n */\nexport const getThemeManager = () => ThemeManager.getInstance();","import { useEffect, useRef, forwardRef } from \"react\";\nimport { getThemeManager } from '@/lib/voice/themes/ThemeManager';\nimport { DefaultTheme } from '@/lib/voice/themes/DefaultTheme';\nimport { throttle, debounce } from '@/lib/utils/throttle';\n\ninterface CanvasProps {\n  // Classic theme only - no theme switching\n}\n\nconst Canvas = forwardRef<HTMLCanvasElement, CanvasProps>(({}, ref) => {\n  const internalRef = useRef<HTMLCanvasElement>(null);\n  const canvasRef = (ref as any) || internalRef;\n  const themeManagerRef = useRef(getThemeManager());\n  const isInitializedRef = useRef(false);\n\n  useEffect(() => {\n    const canvas = canvasRef.current;\n    if (!canvas) return;\n\n    const context = canvas.getContext('2d');\n    if (!context) return;\n\n    const themeManager = themeManagerRef.current;\n\n    const resizeCanvas = () => {\n      canvas.width = window.innerWidth;\n      canvas.height = window.innerHeight;\n    };\n    \n    // Debounce resize to prevent excessive updates\n    const debouncedResize = debounce(resizeCanvas, 250);\n\n    resizeCanvas();\n    window.addEventListener('resize', debouncedResize);\n\n    // Initialize theme manager with canvas context\n    if (!isInitializedRef.current) {\n      themeManager.initialize(canvas, context);\n      \n      // Register default theme if not already registered\n      if (!themeManager.getThemeMetadata('default')) {\n        themeManager.registerTheme({\n          id: 'default',\n          factory: () => new DefaultTheme(),\n          metadata: {\n            id: 'default',\n            name: 'Classic Sphere',\n            description: 'The original 3D particle sphere with smooth color transitions',\n            category: 'particle',\n            performanceProfile: 'medium',\n            previewColors: ['#4285F4', '#34A853', '#EA4335'],\n            previewDescription: 'Rotating particle sphere with dynamic colors'\n          }\n        });\n      }\n\n      // Use default theme only\n      themeManager.switchTheme('default');\n      isInitializedRef.current = true;\n    }\n\n    // Throttled mouse move handler for better performance\n    const handleMouseMove = throttle((event: MouseEvent) => {\n      const rect = canvas.getBoundingClientRect();\n      const x = event.clientX - rect.left;\n      const y = event.clientY - rect.top;\n      themeManager.setMousePosition(x, y, canvas.width, canvas.height);\n    }, 16); // ~60fps for mouse movements\n\n    const handleMouseEnter = () => {\n      themeManager.setHovering(true);\n    };\n\n    const handleMouseLeave = () => {\n      themeManager.setHovering(false);\n    };\n\n    // Add mouse event listeners\n    canvas.addEventListener('mousemove', handleMouseMove);\n    canvas.addEventListener('mouseenter', handleMouseEnter);\n    canvas.addEventListener('mouseleave', handleMouseLeave);\n\n    let animationFrameId: number;\n    let lastTime = 0;\n    const targetFPS = 30; // Target 30 FPS for better performance\n    const frameInterval = 1000 / targetFPS;\n    \n    // Performance monitoring\n    let frameCount = 0;\n    let fpsTime = performance.now();\n    let currentFPS = targetFPS;\n\n    const render = (currentTime: number) => {\n      const deltaTime = currentTime - lastTime;\n      \n      // Only render if enough time has passed for target FPS\n      if (deltaTime >= frameInterval) {\n        // Update lastTime, adjusting for any time drift\n        lastTime = currentTime - (deltaTime % frameInterval);\n        \n        // Get current canvas dimensions\n        const currentWidth = canvas.width;\n        const currentHeight = canvas.height;\n        const currentProjCenterX = currentWidth / 2;\n        const currentProjCenterY = currentHeight / 2;\n        \n        // Delegate drawing to theme manager\n        themeManager.draw(context, currentWidth, currentHeight, currentProjCenterX, currentProjCenterY, deltaTime);\n        \n        // Performance monitoring\n        frameCount++;\n        const now = performance.now();\n        if (now - fpsTime >= 1000) {\n          currentFPS = frameCount;\n          frameCount = 0;\n          fpsTime = now;\n          \n          // Log performance warnings\n          if (currentFPS < targetFPS * 0.8) {\n            console.warn(`[VOICE-CANVAS] Low FPS detected: ${currentFPS}/${targetFPS}`);\n          }\n        }\n      }\n      \n      animationFrameId = window.requestAnimationFrame(render);\n    };\n    \n    // Start the animation loop\n    animationFrameId = window.requestAnimationFrame(render);\n\n    return () => {\n      window.cancelAnimationFrame(animationFrameId);\n      window.removeEventListener('resize', debouncedResize);\n      canvas.removeEventListener('mousemove', handleMouseMove);\n      canvas.removeEventListener('mouseenter', handleMouseEnter);\n      canvas.removeEventListener('mouseleave', handleMouseLeave);\n    };\n  }, []);\n\n  // Expose theme actions for parent component to call\n  (Canvas as any).getThemeManager = () => themeManagerRef.current;\n  (Canvas as any).onUserSpeaking = () => themeManagerRef.current.onUserSpeaking();\n  (Canvas as any).onProcessing = () => themeManagerRef.current.onProcessing();\n  (Canvas as any).onAiSpeaking = () => themeManagerRef.current.onAiSpeaking();\n  (Canvas as any).reset = () => themeManagerRef.current.reset();\n\n  return (\n    <canvas\n      ref={canvasRef}\n      className=\"absolute inset-0 w-full h-full\"\n      style={{ background: 'transparent' }}\n    />\n  );\n});\n\nCanvas.displayName = 'Canvas';\n\nexport default Canvas;","/**\n * Throttle function that limits how often a function can be called\n * @param func Function to throttle\n * @param delay Minimum time between calls in milliseconds\n * @returns Throttled function\n */\nexport function throttle<T extends (...args: any[]) => any>(\n  func: T,\n  delay: number\n): (...args: Parameters<T>) => void {\n  let lastCall = 0;\n  let timeoutId: NodeJS.Timeout | null = null;\n\n  return (...args: Parameters<T>) => {\n    const now = Date.now();\n    const timeSinceLastCall = now - lastCall;\n\n    if (timeSinceLastCall >= delay) {\n      lastCall = now;\n      func(...args);\n    } else {\n      // Schedule a call for the remaining time\n      if (timeoutId) {\n        clearTimeout(timeoutId);\n      }\n      \n      const remainingTime = delay - timeSinceLastCall;\n      timeoutId = setTimeout(() => {\n        lastCall = Date.now();\n        func(...args);\n        timeoutId = null;\n      }, remainingTime);\n    }\n  };\n}\n\n/**\n * Debounce function that delays executing a function until after a specified time has elapsed\n * @param func Function to debounce\n * @param delay Time to wait in milliseconds\n * @returns Debounced function\n */\nexport function debounce<T extends (...args: any[]) => any>(\n  func: T,\n  delay: number\n): (...args: Parameters<T>) => void {\n  let timeoutId: NodeJS.Timeout | null = null;\n\n  return (...args: Parameters<T>) => {\n    if (timeoutId) {\n      clearTimeout(timeoutId);\n    }\n    \n    timeoutId = setTimeout(() => {\n      func(...args);\n      timeoutId = null;\n    }, delay);\n  };\n}","import { create } from 'zustand';\nimport { persist } from 'zustand/middleware';\n\nexport type VoiceOption = 'alloy' | 'echo' | 'fable' | 'onyx' | 'nova' | 'shimmer';\nexport type PersonaOption = 'assistant' | 'creative' | 'analytical' | 'casual' | 'professional';\n\ninterface VoiceSettings {\n  selectedVoice: VoiceOption;\n  selectedPersona: PersonaOption;\n  isVoiceModalOpen: boolean;\n}\n\ninterface VoiceSettingsActions {\n  setVoice: (voice: VoiceOption) => void;\n  setPersona: (persona: PersonaOption) => void;\n  setVoiceModalOpen: (isOpen: boolean) => void;\n  getSettings: () => Omit<VoiceSettings, 'isVoiceModalOpen'>;\n}\n\nexport type VoiceSettingsStore = VoiceSettings & VoiceSettingsActions;\n\n/**\n * Voice Settings Store\n * \n * Persists user's voice preferences including:\n * - Voice selection (OpenAI TTS voices)\n * - Persona selection (conversation style)\n */\nexport const useVoiceSettingsStore = create<VoiceSettingsStore>()(\n  persist(\n    (set, get) => ({\n      // Default settings\n      selectedVoice: 'alloy',\n      selectedPersona: 'assistant',\n      isVoiceModalOpen: false,\n\n      setVoice: (voice: VoiceOption) => {\n        set({ selectedVoice: voice });\n      },\n\n      setPersona: (persona: PersonaOption) => {\n        set({ selectedPersona: persona });\n      },\n\n      setVoiceModalOpen: (isOpen: boolean) => {\n        set({ isVoiceModalOpen: isOpen });\n      },\n\n      getSettings: () => {\n        const state = get();\n        return {\n          selectedVoice: state.selectedVoice,\n          selectedPersona: state.selectedPersona,\n        };\n      },\n    }),\n    {\n      name: 'customgpt-voice-settings',\n      // Persist all voice settings except modal state\n      partialize: (state) => ({\n        selectedVoice: state.selectedVoice,\n        selectedPersona: state.selectedPersona,\n        // Don't persist isVoiceModalOpen - always start as false\n      }),\n    }\n  )\n);\n\n// Export helper to get persona system prompts\nexport const getPersonaSystemPrompt = (persona: PersonaOption): string => {\n  const prompts: Record<PersonaOption, string> = {\n    assistant: 'You are a helpful assistant with a voice interface. Keep your responses concise and informative, limited to 1-2 sentences since the user is interacting through voice.',\n    creative: 'You are a creative and imaginative assistant with a voice interface. Be playful and artistic in your responses while keeping them brief (1-2 sentences) for voice interaction.',\n    analytical: 'You are a logical and precise assistant with a voice interface. Provide clear, data-driven responses in 1-2 concise sentences suitable for voice interaction.',\n    casual: 'You are a relaxed and conversational assistant with a voice interface. Keep responses friendly and informal, limited to 1-2 sentences for natural voice interaction.',\n    professional: 'You are a formal and business-focused assistant with a voice interface. Maintain a professional tone while keeping responses brief (1-2 sentences) for voice interaction.',\n  };\n  \n  return prompts[persona];\n};","'use client';\n\nimport { useState, useRef, useEffect } from 'react';\nimport { Settings, Mic, User, X, ExternalLink } from 'lucide-react';\nimport { useRouter } from 'next/navigation';\nimport { useAgentStore } from '@/store/agents';\nimport { useVoiceSettingsStore } from '@/store/voice-settings';\n\ninterface VoiceSettingsProps {\n  isOpen: boolean;\n  onClose: () => void;\n  projectId?: string;\n}\n\nexport function VoiceSettings({ isOpen, onClose, projectId }: VoiceSettingsProps) {\n  console.log(' VoiceSettings render - isOpen:', isOpen);\n  \n  // Use persisted settings from store\n  const { selectedVoice, selectedPersona, setVoice, setPersona } = useVoiceSettingsStore();\n  const router = useRouter();\n  const { currentAgent, updateSettings } = useAgentStore();\n  \n  // Local state for preview before saving\n  const [previewVoice, setPreviewVoice] = useState(selectedVoice);\n  const [previewPersona, setPreviewPersona] = useState(selectedPersona);\n  const [previewModel, setPreviewModel] = useState(currentAgent?.settings?.chatbot_model || 'gpt-3.5-turbo');\n  \n  // Reset preview to saved values when modal opens\n  useEffect(() => {\n    if (isOpen) {\n      setPreviewVoice(selectedVoice);\n      setPreviewPersona(selectedPersona);\n      setPreviewModel(currentAgent?.settings?.chatbot_model || 'gpt-3.5-turbo');\n    }\n  }, [isOpen, selectedVoice, selectedPersona, currentAgent]);\n\n  const voices = [\n    { id: 'alloy', name: 'Alloy', desc: 'Neutral' },\n    { id: 'echo', name: 'Echo', desc: 'Clear' },\n    { id: 'fable', name: 'Fable', desc: 'Warm' },\n    { id: 'onyx', name: 'Onyx', desc: 'Deep' },\n    { id: 'nova', name: 'Nova', desc: 'Bright' },\n    { id: 'shimmer', name: 'Shimmer', desc: 'Smooth' }\n  ];\n\n  const personas = [\n    { id: 'assistant', name: 'Assistant', desc: 'Helpful' },\n    { id: 'creative', name: 'Creative', desc: 'Artistic' },\n    { id: 'analytical', name: 'Analytical', desc: 'Logical' },\n    { id: 'casual', name: 'Casual', desc: 'Relaxed' },\n    { id: 'professional', name: 'Professional', desc: 'Formal' }\n  ];\n  \n  const handleOpenProjectSettings = () => {\n    if (projectId) {\n      onClose();\n      router.push(`/projects?id=${projectId}`);\n    }\n  };\n\n  if (!isOpen) return null;\n\n  return (\n    <div className=\"fixed inset-0 z-[10001] bg-black/50 backdrop-blur-sm flex items-center justify-center p-4\">\n      <div className=\"bg-gray-900 rounded-2xl border border-gray-700 w-full max-w-2xl max-h-[70vh] flex flex-col\">\n        {/* Header */}\n        <div className=\"p-4 border-b border-gray-700 flex items-center justify-between flex-shrink-0\">\n          <div className=\"flex items-center gap-3\">\n            <Settings className=\"w-5 h-5 text-white\" />\n            <h2 className=\"text-lg font-semibold text-white\">Voice Settings</h2>\n          </div>\n          <button\n            onClick={onClose}\n            className=\"w-8 h-8 rounded-full bg-gray-700 hover:bg-gray-600 flex items-center justify-center transition-colors\"\n          >\n            <X className=\"w-4 h-4 text-white\" />\n          </button>\n        </div>\n\n        {/* Main Content */}\n        <div className=\"flex-1 overflow-y-auto p-6 space-y-6\">\n          {/* Settings Grid */}\n          <div className=\"grid grid-cols-1 gap-6\">\n            {/* Voice Selection */}\n            <div>\n              <div className=\"flex items-center gap-2 mb-3\">\n                <Mic className=\"w-4 h-4 text-white\" />\n                <h3 className=\"text-sm font-semibold text-white uppercase tracking-wider\">Voice</h3>\n              </div>\n              <div className=\"grid grid-cols-3 gap-2\">\n                {voices.map((voice) => (\n                  <button\n                    key={voice.id}\n                    onClick={() => setPreviewVoice(voice.id as any)}\n                    className={`p-3 rounded-lg border transition-all text-left ${\n                      previewVoice === voice.id\n                        ? 'border-blue-500 bg-blue-500/10'\n                        : 'border-gray-600 bg-gray-800/50 hover:bg-gray-700/50'\n                    }`}\n                  >\n                    <div className=\"text-sm font-medium text-white\">{voice.name}</div>\n                    <div className=\"text-xs text-gray-400\">{voice.desc}</div>\n                  </button>\n                ))}\n              </div>\n            </div>\n\n            {/* Persona Selection */}\n            <div>\n              <div className=\"flex items-center gap-2 mb-3\">\n                <User className=\"w-4 h-4 text-white\" />\n                <h3 className=\"text-sm font-semibold text-white uppercase tracking-wider\">Persona</h3>\n              </div>\n              <div className=\"grid grid-cols-3 gap-2\">\n                {personas.map((persona) => (\n                  <button\n                    key={persona.id}\n                    onClick={() => setPreviewPersona(persona.id as any)}\n                    className={`p-3 rounded-lg border transition-all text-left ${\n                      previewPersona === persona.id\n                        ? 'border-purple-500 bg-purple-500/10'\n                        : 'border-gray-600 bg-gray-800/50 hover:bg-gray-700/50'\n                    }`}\n                  >\n                    <div className=\"text-sm font-medium text-white\">{persona.name}</div>\n                    <div className=\"text-xs text-gray-400\">{persona.desc}</div>\n                  </button>\n                ))}\n              </div>\n            </div>\n\n            {/* Model Selection */}\n            {projectId && currentAgent && (\n              <div>\n                <div className=\"flex items-center gap-2 mb-3\">\n                  <Settings className=\"w-4 h-4 text-white\" />\n                  <h3 className=\"text-sm font-semibold text-white uppercase tracking-wider\">Model</h3>\n                </div>\n                <div className=\"grid grid-cols-3 gap-2\">\n                  <button\n                    onClick={() => setPreviewModel('gpt-3.5-turbo')}\n                    className={`p-3 rounded-lg border transition-all text-left ${\n                      previewModel === 'gpt-3.5-turbo'\n                        ? 'border-green-500 bg-green-500/10'\n                        : 'border-gray-600 bg-gray-800/50 hover:bg-gray-700/50'\n                    }`}\n                  >\n                    <div className=\"text-sm font-medium text-white\">GPT-3.5</div>\n                    <div className=\"text-xs text-gray-400\">Fast</div>\n                  </button>\n                  <button\n                    onClick={() => setPreviewModel('gpt-4')}\n                    className={`p-3 rounded-lg border transition-all text-left ${\n                      previewModel === 'gpt-4'\n                        ? 'border-green-500 bg-green-500/10'\n                        : 'border-gray-600 bg-gray-800/50 hover:bg-gray-700/50'\n                    }`}\n                  >\n                    <div className=\"text-sm font-medium text-white\">GPT-4</div>\n                    <div className=\"text-xs text-gray-400\">Powerful</div>\n                  </button>\n                  <button\n                    onClick={() => setPreviewModel('gpt-4-o')}\n                    className={`p-3 rounded-lg border transition-all text-left ${\n                      previewModel === 'gpt-4-o'\n                        ? 'border-green-500 bg-green-500/10'\n                        : 'border-gray-600 bg-gray-800/50 hover:bg-gray-700/50'\n                    }`}\n                  >\n                    <div className=\"text-sm font-medium text-white\">GPT-4o</div>\n                    <div className=\"text-xs text-gray-400\">Optimized</div>\n                  </button>\n                  <button\n                    onClick={() => setPreviewModel('claude-3-opus')}\n                    className={`p-3 rounded-lg border transition-all text-left ${\n                      previewModel === 'claude-3-opus'\n                        ? 'border-green-500 bg-green-500/10'\n                        : 'border-gray-600 bg-gray-800/50 hover:bg-gray-700/50'\n                    }`}\n                  >\n                    <div className=\"text-sm font-medium text-white\">Claude 3 Opus</div>\n                    <div className=\"text-xs text-gray-400\">Powerful</div>\n                  </button>\n                  <button\n                    onClick={() => setPreviewModel('claude-3-sonnet')}\n                    className={`p-3 rounded-lg border transition-all text-left ${\n                      previewModel === 'claude-3-sonnet'\n                        ? 'border-green-500 bg-green-500/10'\n                        : 'border-gray-600 bg-gray-800/50 hover:bg-gray-700/50'\n                    }`}\n                  >\n                    <div className=\"text-sm font-medium text-white\">Claude 3 Sonnet</div>\n                    <div className=\"text-xs text-gray-400\">Balanced</div>\n                  </button>\n                  <button\n                    onClick={() => setPreviewModel('claude-3-haiku')}\n                    className={`p-3 rounded-lg border transition-all text-left ${\n                      previewModel === 'claude-3-haiku'\n                        ? 'border-green-500 bg-green-500/10'\n                        : 'border-gray-600 bg-gray-800/50 hover:bg-gray-700/50'\n                    }`}\n                  >\n                    <div className=\"text-sm font-medium text-white\">Claude 3 Haiku</div>\n                    <div className=\"text-xs text-gray-400\">Fast</div>\n                  </button>\n                </div>\n                <p className=\"text-xs text-gray-400 mt-2\">\n                  Recommended for voice: Mini models provide faster responses\n                </p>\n              </div>\n            )}\n          </div>\n        </div>\n\n        {/* Footer */}\n        <div className=\"p-4 border-t border-gray-700 flex justify-end gap-3 flex-shrink-0\">\n          <button\n            onClick={() => {\n              setPreviewVoice(selectedVoice);\n              setPreviewPersona(selectedPersona);\n              setPreviewModel(currentAgent?.settings?.chatbot_model || 'gpt-3.5-turbo');\n              onClose();\n            }}\n            className=\"px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg text-white text-sm transition-colors\"\n          >\n            Cancel\n          </button>\n          <button\n            onClick={async () => {\n              // Save voice and persona settings\n              setVoice(previewVoice as any);\n              setPersona(previewPersona as any);\n              \n              // Update agent's model setting if it changed\n              if (currentAgent && previewModel !== currentAgent.settings?.chatbot_model) {\n                try {\n                  await updateSettings(currentAgent.id, {\n                    chatbot_model: previewModel\n                  });\n                } catch (error) {\n                  console.error('Failed to update model setting:', error);\n                  // Continue with closing the modal even if model update fails\n                }\n              }\n              \n              onClose();\n            }}\n            className=\"px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg text-white text-sm transition-colors\"\n          >\n            Save Settings\n          </button>\n        </div>\n      </div>\n    </div>\n  );\n}","/**\n * Streaming TTS Manager\n * \n * Handles chunked text-to-speech for faster voice responses\n */\n\nexport class StreamingTTSManager {\n  private audioQueue: AudioBuffer[] = [];\n  private pendingChunks: Map<number, AudioBuffer> = new Map(); // Store chunks by ID\n  private nextExpectedChunkId = 0; // Track which chunk should play next\n  private isPlaying = false;\n  private audioContext: AudioContext | null = null;\n  private currentSource: AudioBufferSourceNode | null = null;\n  private onPlaybackComplete?: () => void;\n  private onError?: (error: string) => void;\n\n  constructor() {\n    this.initAudioContext();\n  }\n\n  private async initAudioContext() {\n    try {\n      this.audioContext = new (window.AudioContext || (window as any).webkitAudioContext)();\n      \n      // Resume context if suspended (required for mobile)\n      if (this.audioContext.state === 'suspended') {\n        await this.audioContext.resume();\n      }\n    } catch (error) {\n      console.error('Failed to initialize AudioContext:', error);\n    }\n  }\n\n  /**\n   * Add a text chunk to be converted to speech and queued\n   */\n  async addTextChunk(text: string, voice: string = 'alloy') {\n    try {\n      // Convert text to speech\n      const audioBuffer = await this.textToSpeech(text, voice);\n      \n      // Add to queue\n      this.audioQueue.push(audioBuffer);\n      \n      // Start playing if not already playing\n      if (!this.isPlaying) {\n        this.playNextChunk();\n      }\n    } catch (error) {\n      console.error('Failed to add text chunk:', error);\n      this.onError?.('Failed to generate speech for chunk');\n    }\n  }\n\n  /**\n   * Add a pre-generated audio buffer directly to the queue\n   * Used for streaming responses that provide ready audio chunks\n   */\n  async addAudioBuffer(audioBuffer: AudioBuffer) {\n    try {\n      // Add to queue - for backward compatibility without chunk ID\n      this.audioQueue.push(audioBuffer);\n      \n      // Start playing if not already playing\n      if (!this.isPlaying) {\n        this.playNextChunk();\n      }\n    } catch (error) {\n      console.error('Failed to add audio buffer:', error);\n      this.onError?.('Failed to queue audio buffer');\n    }\n  }\n\n  /**\n   * Add an audio buffer with a specific chunk ID to ensure ordered playback\n   */\n  async addAudioBufferWithId(audioBuffer: AudioBuffer, chunkId: number) {\n    try {\n      console.log(`[StreamingTTS] Adding chunk ${chunkId}, expecting ${this.nextExpectedChunkId}`);\n      \n      // Store the chunk\n      this.pendingChunks.set(chunkId, audioBuffer);\n      \n      // Check if we can queue any pending chunks in order\n      while (this.pendingChunks.has(this.nextExpectedChunkId)) {\n        const chunk = this.pendingChunks.get(this.nextExpectedChunkId)!;\n        this.pendingChunks.delete(this.nextExpectedChunkId);\n        \n        console.log(`[StreamingTTS] Queuing chunk ${this.nextExpectedChunkId} in order`);\n        this.audioQueue.push(chunk);\n        this.nextExpectedChunkId++;\n        \n        // Start playing if not already playing\n        if (!this.isPlaying) {\n          this.playNextChunk();\n        }\n      }\n      \n      console.log(`[StreamingTTS] Pending chunks: ${Array.from(this.pendingChunks.keys()).sort().join(', ')}`);\n    } catch (error) {\n      console.error('Failed to add audio buffer with ID:', error);\n      this.onError?.('Failed to queue audio buffer');\n    }\n  }\n\n  /**\n   * Convert text to speech using OpenAI TTS API\n   */\n  private async textToSpeech(text: string, voice: string): Promise<AudioBuffer> {\n    if (!text.trim()) {\n      throw new Error('Empty text provided');\n    }\n\n    // Call TTS API\n    const response = await fetch('/api/proxy/tts/stream', {\n      method: 'POST',\n      headers: {\n        'Content-Type': 'application/json',\n      },\n      body: JSON.stringify({\n        model: 'tts-1', // Use faster model for streaming\n        input: text,\n        voice: voice,\n        response_format: 'mp3'\n      })\n    });\n\n    if (!response.ok) {\n      throw new Error(`TTS API error: ${response.status}`);\n    }\n\n    const audioBlob = await response.blob();\n    const arrayBuffer = await audioBlob.arrayBuffer();\n\n    if (!this.audioContext) {\n      throw new Error('AudioContext not initialized');\n    }\n\n    return await this.audioContext.decodeAudioData(arrayBuffer);\n  }\n\n  /**\n   * Play the next audio chunk in the queue\n   */\n  private async playNextChunk() {\n    if (this.audioQueue.length === 0) {\n      this.isPlaying = false;\n      this.onPlaybackComplete?.();\n      return;\n    }\n\n    if (!this.audioContext) {\n      console.error('AudioContext not available');\n      return;\n    }\n\n    this.isPlaying = true;\n    const audioBuffer = this.audioQueue.shift();\n\n    if (!audioBuffer) return;\n\n    try {\n      // Create and configure audio source\n      this.currentSource = this.audioContext.createBufferSource();\n      this.currentSource.buffer = audioBuffer;\n      this.currentSource.connect(this.audioContext.destination);\n\n      // Set up completion handler\n      this.currentSource.onended = () => {\n        this.currentSource = null;\n        // Add a small delay between chunks for smoother playback\n        setTimeout(() => {\n          this.playNextChunk(); // Play next chunk\n        }, 50);\n      };\n\n      // Start playback\n      this.currentSource.start(0);\n      \n    } catch (error) {\n      console.error('Failed to play audio chunk:', error);\n      // Try to continue with the next chunk\n      setTimeout(() => {\n        this.playNextChunk();\n      }, 100);\n    }\n  }\n\n  /**\n   * Stop all playback and clear queue\n   */\n  stopPlayback() {\n    // Stop current audio\n    if (this.currentSource) {\n      try {\n        this.currentSource.stop();\n      } catch (error) {\n        // Ignore errors from stopping already stopped sources\n      }\n      this.currentSource = null;\n    }\n\n    // Clear queue and pending chunks\n    this.audioQueue = [];\n    this.pendingChunks.clear();\n    this.nextExpectedChunkId = 0;\n    this.isPlaying = false;\n  }\n\n  /**\n   * Reset the chunk ID counter for a new streaming session\n   */\n  resetChunkCounter() {\n    this.nextExpectedChunkId = 0;\n    this.pendingChunks.clear();\n    console.log('[StreamingTTS] Chunk counter reset for new session');\n  }\n\n  /**\n   * Check if audio is currently playing\n   */\n  isCurrentlyPlaying(): boolean {\n    return this.isPlaying;\n  }\n\n  /**\n   * Get number of chunks in queue\n   */\n  getQueueLength(): number {\n    return this.audioQueue.length;\n  }\n\n  /**\n   * Set callback for when all queued audio finishes playing\n   */\n  onPlaybackCompleted(callback: () => void) {\n    this.onPlaybackComplete = callback;\n  }\n\n  /**\n   * Set callback for errors\n   */\n  onStreamingError(callback: (error: string) => void) {\n    this.onError = callback;\n  }\n\n  /**\n   * Clean up resources\n   */\n  destroy() {\n    this.stopPlayback();\n    this.pendingChunks.clear();\n    this.nextExpectedChunkId = 0;\n    if (this.audioContext) {\n      this.audioContext.close();\n      this.audioContext = null;\n    }\n  }\n}\n\n/**\n * Text chunking utilities for optimal TTS streaming\n */\nexport class TextChunker {\n  /**\n   * Split text into optimal chunks for TTS\n   * Aims for natural speech breaks while keeping chunks reasonably sized\n   */\n  static chunkText(text: string, maxChunkSize: number = 200): string[] {\n    const chunks: string[] = [];\n    \n    // Split by sentences first\n    const sentences = text.split(/[.!?]+/).filter(s => s.trim());\n    \n    let currentChunk = '';\n    \n    for (const sentence of sentences) {\n      const trimmedSentence = sentence.trim();\n      if (!trimmedSentence) continue;\n      \n      // If adding this sentence would exceed max size and we have content, finalize chunk\n      if (currentChunk && (currentChunk.length + trimmedSentence.length + 2) > maxChunkSize) {\n        chunks.push(currentChunk.trim() + '.');\n        currentChunk = trimmedSentence;\n      } else {\n        currentChunk += (currentChunk ? '. ' : '') + trimmedSentence;\n      }\n    }\n    \n    // Add final chunk\n    if (currentChunk.trim()) {\n      chunks.push(currentChunk.trim() + (currentChunk.endsWith('.') ? '' : '.'));\n    }\n    \n    return chunks;\n  }\n\n  /**\n   * Smart chunking that considers punctuation and natural breaks\n   */\n  static smartChunk(text: string, targetChunkSize: number = 150): string[] {\n    const chunks: string[] = [];\n    \n    // Priority order for splitting: sentences, clauses, phrases, words\n    const breakPoints = [\n      /[.!?]+\\s+/g,  // Sentence endings\n      /[,;:]\\s+/g,   // Clause breaks\n      /\\s+(?=and|but|or|so|yet|for|nor)\\s+/g, // Conjunctions\n      /\\s+/g         // Word breaks (fallback)\n    ];\n    \n    let remainingText = text;\n    \n    while (remainingText.length > targetChunkSize) {\n      let bestSplit = -1;\n      \n      // Try each break point type in order of preference\n      for (const breakRegex of breakPoints) {\n        const matches = Array.from(remainingText.matchAll(breakRegex));\n        \n        // Find the best split point (closest to target size without going over)\n        for (const match of matches) {\n          const splitIndex = match.index! + match[0].length;\n          if (splitIndex <= targetChunkSize && splitIndex > bestSplit) {\n            bestSplit = splitIndex;\n          }\n        }\n        \n        if (bestSplit > 0) break; // Found a good split\n      }\n      \n      // If no good split found, split at target size\n      if (bestSplit <= 0) {\n        bestSplit = targetChunkSize;\n      }\n      \n      chunks.push(remainingText.slice(0, bestSplit).trim());\n      remainingText = remainingText.slice(bestSplit).trim();\n    }\n    \n    // Add final chunk\n    if (remainingText) {\n      chunks.push(remainingText);\n    }\n    \n    return chunks.filter(chunk => chunk.length > 0);\n  }\n}","import { utils } from \"@ricky0123/vad-react\";\nimport type { VoiceOption, PersonaOption } from '@/store/voice-settings';\nimport { StreamingTTSManager } from './streaming-tts';\n\nexport interface VoiceCallbacks {\n  onUserSpeaking?: () => void;\n  onProcessing?: () => void;\n  onAiSpeaking?: () => void;\n  onReset?: () => void;\n  onError?: (error: string) => void;\n  onDebug?: (message: string, data?: any) => void;\n  // New callbacks for message store integration\n  onTranscriptReceived?: (transcript: string) => void;\n  onResponseReceived?: (response: string) => void;\n  // Streaming callbacks\n  onStreamingTextChunk?: (textChunk: string) => void;\n  onStreamingAudioReady?: (audioUrl: string, chunkId: string) => void;\n  onStreamingComplete?: (fullResponse: string, transcript: string) => void;\n}\n\nclass SpeechManager {\n  private source: AudioBufferSourceNode | null = null;\n  private sourceIsStarted = false;\n  private conversationThusFar: any[] = [];\n  private callbacks: VoiceCallbacks = {};\n  private projectId: string | null = null;\n  private sessionId: string | null = null;\n  private voiceSettings: { voice: VoiceOption; persona: PersonaOption } | null = null;\n  private streamingTTS: StreamingTTSManager | null = null;\n  private chatbotModel: string = 'gpt-3.5-turbo'; // Default to fast model for voice if not specified by agent\n  // Streaming is always enabled for optimal performance\n\n  setCallbacks(callbacks: VoiceCallbacks) {\n    this.callbacks = callbacks;\n    this.debug(\"Callbacks set\", { hasCallbacks: Object.keys(callbacks) });\n  }\n\n  setProjectId(projectId: string) {\n    this.projectId = projectId;\n    this.debug(\"Project ID set\", { projectId });\n  }\n\n  setSessionId(sessionId: string | null) {\n    this.sessionId = sessionId;\n    this.debug(\"Session ID set\", { sessionId });\n  }\n\n  setVoiceSettings(voice: VoiceOption, persona: PersonaOption) {\n    this.voiceSettings = { voice, persona };\n    this.debug(\"Voice settings set\", { voice, persona });\n  }\n\n  setChatbotModel(model: string) {\n    this.chatbotModel = model;\n    this.debug(\"Chatbot model set\", { model });\n  }\n\n  private debug(message: string, data?: any) {\n    // Production: Debug logging disabled\n    // Uncomment for development debugging:\n    // const timestamp = new Date().toISOString();\n    // console.log(` [SPEECH-MANAGER ${timestamp}] ${message}`, data || '');\n    this.callbacks.onDebug?.(message, data);\n  }\n\n  private error(message: string, error?: any) {\n    const timestamp = new Date().toISOString();\n    console.error(` [SPEECH-MANAGER ${timestamp}] ${message}`, error || '');\n    this.callbacks.onError?.(message);\n  }\n\n  onSpeechStart = () => {\n    this.debug(\"Speech started - user is speaking\");\n    this.callbacks.onUserSpeaking?.();\n    this.stopSourceIfNeeded();\n  };\n\n  onSpeechEnd = async (audio: Float32Array) => {\n    this.debug(\"Speech ended\", { \n      audioLength: audio.length,\n      audioDuration: `${audio.length / 16000}s` // Assuming 16kHz sample rate\n    });\n    await this.processAudio(audio);\n  };\n\n  onMisfire = () => {\n    this.debug(\"VAD misfire - noise detected but not speech\");\n    this.callbacks.onReset?.();\n  };\n\n  private stopSourceIfNeeded = () => {\n    if (this.source && this.sourceIsStarted) {\n      this.debug(\"Stopping current audio playback\");\n      this.source.stop(0);\n      this.sourceIsStarted = false;\n    }\n  };\n\n  // Public method to stop audio playback\n  public stopAudio = () => {\n    this.stopSourceIfNeeded();\n    \n    // Also stop streaming TTS if active\n    if (this.streamingTTS) {\n      this.streamingTTS.stopPlayback();\n      this.debug(\" Streaming TTS stopped\");\n    }\n    \n    this.callbacks.onReset?.();\n    this.debug(\"Audio stopped by user\");\n  };\n\n  // Public method to process manually recorded audio\n  public processManualAudio = async (audioBlob: Blob) => {\n    this.debug(\"Processing manual audio\", { \n      size: `${(audioBlob.size / 1024).toFixed(2)}KB`,\n      type: audioBlob.type\n    });\n    this.callbacks.onProcessing?.();\n    \n    try {\n      await this.validate(audioBlob);\n      await this.sendData(audioBlob);\n    } catch (error) {\n      this.error('Error processing manual audio', error);\n      this.callbacks.onReset?.();\n    }\n  };\n\n  private processAudio = async (audio: Float32Array) => {\n    this.debug(\"Processing audio started\");\n    this.callbacks.onProcessing?.();\n    \n    try {\n      const blob = this.createAudioBlob(audio);\n      await this.validate(blob);\n      await this.sendData(blob);\n    } catch (error) {\n      this.error('Error processing audio', error);\n      this.callbacks.onReset?.();\n    }\n  };\n\n  private createAudioBlob = (audio: Float32Array): Blob => {\n    const wavBuffer = utils.encodeWAV(audio);\n    const blob = new Blob([wavBuffer], { type: 'audio/wav' });\n    this.debug(\"Created audio blob\", { \n      size: `${(blob.size / 1024).toFixed(2)}KB`,\n      type: blob.type,\n      samples: audio.length,\n      duration: `${audio.length / 16000}s` // Assuming 16kHz from VAD\n    });\n    return blob;\n  };\n\n  private sendData = async (blob: Blob) => {\n    // Always use streaming mode\n    await this.sendStreamingData(blob);\n  };\n\n  private sendStreamingData = async (blob: Blob) => {\n    this.debug(\" Sending audio data to streaming API\");\n    \n    if (!this.projectId) {\n      this.error('No project ID set - cannot send audio');\n      this.callbacks.onReset?.();\n      return;\n    }\n\n    // Initialize streaming TTS manager\n    if (!this.streamingTTS) {\n      this.streamingTTS = new StreamingTTSManager();\n      this.streamingTTS.onPlaybackCompleted(() => {\n        this.debug(\" Streaming playback completed\");\n        this.callbacks.onReset?.();\n      });\n      this.streamingTTS.onStreamingError((error) => {\n        this.error(' Streaming TTS error', error);\n      });\n    } else {\n      // Reset chunk counter for new streaming session\n      this.streamingTTS.resetChunkCounter();\n    }\n\n    const formData = new FormData();\n    formData.append(\"audio\", blob, \"audio.wav\");\n    console.log(' [SPEECH-MANAGER] Sending project_id:', this.projectId);\n    formData.append(\"project_id\", this.projectId);\n    if (this.sessionId) {\n      console.log(' [SPEECH-MANAGER] Sending session_id:', this.sessionId);\n      formData.append(\"session_id\", this.sessionId);\n    }\n    \n    // Add voice settings to the request\n    if (this.voiceSettings) {\n      formData.append(\"voice\", this.voiceSettings.voice);\n      formData.append(\"persona\", this.voiceSettings.persona);\n    }\n    \n    // Note: chatbot_model is not sent to voice API\n    // The agent's configured model will be used automatically\n\n    this.debug(\" Starting streaming voice request\", {\n      projectId: this.projectId,\n      sessionId: this.sessionId,\n      conversationLength: this.conversationThusFar.length,\n      audioSize: `${(blob.size / 1024).toFixed(2)}KB`,\n      voice: this.voiceSettings?.voice,\n      persona: this.voiceSettings?.persona,\n      lastMessages: this.conversationThusFar.slice(-2).map(m => ({ role: m.role, preview: m.content.slice(0, 50) }))\n    });\n\n    try {\n      // Check for demo mode OpenAI key\n      const headers: Record<string, string> = {\n        'conversation': this.base64Encode(JSON.stringify(this.conversationThusFar))\n      };\n      \n      // Add deployment mode header\n      const deploymentMode = localStorage.getItem('customgpt.deploymentMode') || 'production';\n      headers['X-Deployment-Mode'] = deploymentMode;\n      \n      console.log(' [SPEECH-MANAGER] Deployment mode from localStorage:', deploymentMode);\n      console.log(' [SPEECH-MANAGER] localStorage value:', localStorage.getItem('customgpt.deploymentMode'));\n      console.log(' [SPEECH-MANAGER] Sending headers:', headers);\n      \n      // In demo mode, add keys from window object if available\n      if (deploymentMode === 'demo') {\n        // Add OpenAI key for TTS/STT\n        if ((window as any).__demoOpenAIKey) {\n          headers['X-OpenAI-API-Key'] = (window as any).__demoOpenAIKey;\n        }\n        // Add CustomGPT API key for chat completions\n        if ((window as any).__demoCustomGPTKey) {\n          headers['X-CustomGPT-API-Key'] = (window as any).__demoCustomGPTKey;\n        }\n      }\n      \n      const response = await fetch(\"/api/proxy/voice/streaming\", {\n        method: \"POST\",\n        body: formData,\n        headers\n      });\n\n      this.debug(\" Streaming response received\", {\n        status: response.status,\n        ok: response.ok,\n        contentType: response.headers.get('content-type')\n      });\n\n      if (!response.ok) {\n        const errorText = await response.text();\n        let errorData;\n        try {\n          errorData = JSON.parse(errorText);\n        } catch {\n          errorData = { error: errorText };\n        }\n        \n        // Check if it's specifically an OpenAI API key error\n        if (response.status === 503 && errorData.userMessage) {\n          throw new Error(errorData.userMessage);\n        }\n        \n        throw new Error(`Streaming API Error (${response.status}): ${errorData.error || errorText}`);\n      }\n\n      // Process streaming response\n      await this.processStreamingResponse(response);\n    } catch (error) {\n      this.error(\" Failed to process streaming voice\", error);\n      this.handleError(error);\n    }\n  };\n\n  private processStreamingResponse = async (response: Response) => {\n    if (!response.body) {\n      throw new Error(\"No response body for streaming\");\n    }\n\n    const reader = response.body.getReader();\n    const decoder = new TextDecoder();\n    \n    let fullResponse = '';\n    let transcript = '';\n    let currentStreamingActive = false;\n\n    this.debug(\" Processing streaming response chunks\");\n\n    try {\n      while (true) {\n        const { done, value } = await reader.read();\n        if (done) {\n          this.debug(\" Streaming response complete\");\n          break;\n        }\n\n        const chunk = decoder.decode(value);\n        const lines = chunk.split('\\n');\n\n        for (const line of lines) {\n          if (line.startsWith('data: ')) {\n            const data = line.slice(6);\n            if (data.trim() === '') continue;\n\n            try {\n              const parsed = JSON.parse(data);\n              \n              if (parsed.type === 'text') {\n                // Stream text chunk\n                fullResponse += parsed.text;\n                \n                // Trigger UI update for text streaming\n                this.callbacks.onStreamingTextChunk?.(parsed.text);\n                \n                this.debug(` Text chunk received: \"${parsed.text}\"`);\n                \n              } else if (parsed.type === 'audio' || parsed.type === 'audio_ref') {\n                // Audio chunk ready - queue it for playback\n                if (parsed.audioUrl || parsed.audioId) {\n                  if (!currentStreamingActive) {\n                    this.callbacks.onAiSpeaking?.();\n                    currentStreamingActive = true;\n                  }\n                  \n                  // Handle both legacy data URL and new audio reference\n                  if (parsed.audioUrl) {\n                    // Legacy: Convert data URL to audio and queue it\n                    await this.queueAudioChunk(parsed.audioUrl, parsed.chunkId);\n                  } else if (parsed.audioId) {\n                    // New: Fetch audio chunk by ID\n                    await this.queueAudioChunkById(parsed.audioId, parsed.chunkId);\n                  }\n                  \n                  this.debug(` Audio chunk queued: ${parsed.chunkId} (${parsed.text?.slice(0, 50)}...)`);\n                }\n                \n              } else if (parsed.type === 'complete') {\n                // Stream complete\n                fullResponse = parsed.fullResponse || fullResponse;\n                transcript = parsed.transcript || transcript;\n                \n                this.debug(\" Stream complete\", { \n                  responseLength: fullResponse.length,\n                  transcript \n                });\n                \n                console.log(` [SPEECH-MANAGER] Complete fullResponse (${fullResponse.length} chars):`, fullResponse);\n                console.log(` [SPEECH-MANAGER] Includes \"individuals\":`, fullResponse.includes('individuals'));\n                console.log(` [SPEECH-MANAGER] Includes \"like\":`, fullResponse.includes('like'));\n                console.log(` [SPEECH-MANAGER] Includes \"CustomGPT\":`, fullResponse.includes('CustomGPT'));\n                \n                // Trigger callbacks for UI updates\n                // Don't update conversationThusFar here - let the message store be the single source of truth\n                if (transcript) {\n                  this.callbacks.onTranscriptReceived?.(transcript);\n                }\n                \n                if (fullResponse) {\n                  this.callbacks.onResponseReceived?.(fullResponse);\n                }\n                \n                this.callbacks.onStreamingComplete?.(fullResponse, transcript);\n                \n              } else if (parsed.type === 'error') {\n                // Stream error\n                this.error(` Stream error: ${parsed.error}`);\n                this.callbacks.onReset?.();\n              }\n            } catch (parseError) {\n              this.debug(` Failed to parse chunk: ${data}`, parseError);\n            }\n          }\n        }\n      }\n    } catch (error) {\n      this.error(\" Error processing streaming response\", error);\n      this.callbacks.onReset?.();\n    } finally {\n      reader.releaseLock();\n    }\n  };\n\n  private queueAudioChunk = async (audioDataUrl: string, chunkId: string) => {\n    if (!this.streamingTTS) {\n      this.error(\" StreamingTTS not initialized\");\n      return;\n    }\n\n    try {\n      // Extract numeric chunk ID from the string (e.g., \"chunk_0\" -> 0)\n      const numericChunkId = parseInt(chunkId.replace('chunk_', ''));\n      \n      // Convert data URL to blob\n      const response = await fetch(audioDataUrl);\n      const audioBlob = await response.blob();\n      \n      // Convert blob to ArrayBuffer for Web Audio API\n      const arrayBuffer = await audioBlob.arrayBuffer();\n      \n      // Create audio context and decode\n      const audioContext = new (window.AudioContext || (window as any).webkitAudioContext)();\n      const audioBuffer = await audioContext.decodeAudioData(arrayBuffer);\n      \n      // Queue the decoded audio buffer with ID for ordered playback\n      await this.streamingTTS.addAudioBufferWithId(audioBuffer, numericChunkId);\n      \n      this.debug(` Audio chunk queued with ID ${numericChunkId}: ${chunkId}`);\n    } catch (error) {\n      this.error(` Failed to queue audio chunk ${chunkId}`, error);\n    }\n  };\n\n  // Legacy sendLegacyData method removed - streaming is always used\n  \n  private queueAudioChunkById = async (audioId: string, chunkId: string) => {\n    if (!this.streamingTTS) {\n      this.error(\" StreamingTTS not initialized\");\n      return;\n    }\n\n    try {\n      // Extract numeric chunk ID from the string (e.g., \"chunk_0\" -> 0)\n      const numericChunkId = parseInt(chunkId.replace('chunk_', ''));\n      \n      // Fetch audio chunk by ID from the streaming endpoint\n      const response = await fetch(`/api/proxy/voice/streaming?id=${audioId}`);\n      if (!response.ok) {\n        if (response.status === 404) {\n          // Audio chunk not found - this can happen after server restart\n          this.debug(` Audio chunk not found (server may have restarted): ${chunkId}`);\n          return; // Skip this chunk gracefully\n        }\n        throw new Error(`Failed to fetch audio chunk: ${response.status}`);\n      }\n      \n      const audioBlob = await response.blob();\n      \n      // Convert blob to ArrayBuffer for Web Audio API\n      const arrayBuffer = await audioBlob.arrayBuffer();\n      \n      // Create audio context and decode\n      const audioContext = new (window.AudioContext || (window as any).webkitAudioContext)();\n      const audioBuffer = await audioContext.decodeAudioData(arrayBuffer);\n      \n      // Queue the decoded audio buffer with ID for ordered playback\n      await this.streamingTTS.addAudioBufferWithId(audioBuffer, numericChunkId);\n      \n      this.debug(` Audio chunk fetched and queued with ID ${numericChunkId}: ${chunkId}`);\n    } catch (error) {\n      this.error(` Failed to fetch/queue audio chunk ${chunkId}`, error);\n    }\n  };\n\n  // Legacy sendLegacyData method removed - streaming is always used\n\n  private base64Encode(str: string): string {\n    const encoder = new TextEncoder();\n    const data = encoder.encode(str);\n    return window.btoa(String.fromCharCode(...new Uint8Array(data)));\n  }\n\n  private base64Decode(base64: string): string {\n    const binaryStr = window.atob(base64);\n    const bytes = new Uint8Array([...binaryStr].map((char) => char.charCodeAt(0)));\n    return new TextDecoder().decode(bytes);\n  }\n\n  private handleSuccess = async (blob: Blob) => {\n    this.debug(\"Playing AI response audio\");\n    \n    try {\n      const audioContext = new (window.AudioContext || (window as any).webkitAudioContext)();\n      this.stopSourceIfNeeded();\n\n      const arrayBuffer = await blob.arrayBuffer();\n      const audioBuffer = await audioContext.decodeAudioData(arrayBuffer);\n      \n      this.debug(\"Audio decoded\", {\n        duration: `${audioBuffer.duration.toFixed(2)}s`,\n        sampleRate: audioBuffer.sampleRate,\n        numberOfChannels: audioBuffer.numberOfChannels\n      });\n\n      this.source = audioContext.createBufferSource();\n      this.source.buffer = audioBuffer;\n      this.source.connect(audioContext.destination);\n      this.source.start(0);\n      this.sourceIsStarted = true;\n      \n      this.source.onended = () => {\n        this.debug(\"Audio playback ended\");\n        this.callbacks.onReset?.();\n      };\n\n      this.callbacks.onAiSpeaking?.();\n    } catch (error) {\n      this.error(\"Failed to play audio\", error);\n      this.callbacks.onReset?.();\n    }\n  };\n\n  private handleError = (error: any) => {\n    this.error(`Error encountered: ${error.message}`, error);\n    this.callbacks.onReset?.();\n  };\n\n  private validate = async (data: Blob) => {\n    this.debug(\"Validating audio duration\");\n    \n    try {\n      // Clone the blob to avoid consuming the arrayBuffer\n      const clonedBlob = new Blob([data], { type: data.type });\n      const arrayBuffer = await clonedBlob.arrayBuffer();\n      const audioContext = new AudioContext();\n      const decodedData = await audioContext.decodeAudioData(arrayBuffer);\n      const duration = decodedData.duration;\n      const minDuration = 0.4;\n\n      this.debug(\"Audio validation\", {\n        duration: `${duration.toFixed(2)}s`,\n        minDuration: `${minDuration}s`,\n        valid: duration >= minDuration\n      });\n\n      if (duration < minDuration) {\n        throw new Error(`Duration is ${duration}s, which is less than minimum of ${minDuration}s`);\n      }\n    } catch (error) {\n      this.error(\"Audio validation failed\", error);\n      throw error;\n    }\n  };\n\n  clearConversation() {\n    this.conversationThusFar = [];\n  }\n\n  getConversationThusFar() {\n    return this.conversationThusFar;\n  }\n\n  getSessionId() {\n    return this.sessionId;\n  }\n\n  // Set the conversation history from existing messages\n  setConversationHistory(messages: any[]) {\n    // Clean and deduplicate messages before setting\n    const cleanedMessages = messages\n      .filter((msg, index, self) => \n        // Remove duplicates based on content and role\n        index === self.findIndex(m => m.content === msg.content && m.role === msg.role)\n      )\n      .filter(msg => \n        // Filter out placeholder messages that shouldn't be sent to the API\n        !msg.content.includes(' Processing voice input') && \n        !msg.content.includes('Processing voice input...')\n      )\n      .map(msg => ({\n        role: msg.role,\n        content: msg.content\n      }));\n    \n    this.conversationThusFar = cleanedMessages;\n    this.debug(\"Conversation history loaded\", {\n      messageCount: this.conversationThusFar.length,\n      originalCount: messages.length,\n      filtered: messages.length - cleanedMessages.length\n    });\n  }\n\n\n  // Public method to clean up streaming resources\n  public destroy() {\n    this.stopAudio();\n    if (this.streamingTTS) {\n      this.streamingTTS.destroy();\n      this.streamingTTS = null;\n    }\n    this.debug(\" SpeechManager destroyed\");\n  }\n}\n\nexport const speechManager = new SpeechManager();","/**\n * Utility functions for voice mode\n */\n\n/**\n * Simple markdown parser for voice responses\n * Removes markdown formatting for cleaner display in voice UI\n */\nexport function parseMarkdownForVoice(text: string): string {\n  return text\n    // Remove bold markers\n    .replace(/\\*\\*(.*?)\\*\\*/g, '$1')\n    // Remove italic markers\n    .replace(/\\*(.*?)\\*/g, '$1')\n    // Remove code blocks\n    .replace(/```[\\s\\S]*?```/g, '')\n    // Remove inline code\n    .replace(/`([^`]+)`/g, '$1')\n    // Remove headers\n    .replace(/#{1,6}\\s+/g, '')\n    // Remove links but keep text\n    .replace(/\\[([^\\]]+)\\]\\([^)]+\\)/g, '$1')\n    // Remove images\n    .replace(/!\\[([^\\]]*)\\]\\([^)]+\\)/g, '')\n    // Remove horizontal rules\n    .replace(/^-{3,}$/gm, '')\n    // Remove bullet points\n    .replace(/^\\s*[-*+]\\s+/gm, '')\n    // Remove numbered lists\n    .replace(/^\\s*\\d+\\.\\s+/gm, '')\n    // Clean up extra whitespace\n    .replace(/\\n{3,}/g, '\\n\\n')\n    .trim();\n}\n\n/**\n * Split response into chunks for streaming display\n */\nexport function* streamTextChunks(text: string, chunkSize: number = 50): Generator<string> {\n  const words = text.split(' ');\n  let currentChunk = '';\n  \n  for (const word of words) {\n    if (currentChunk.length + word.length + 1 > chunkSize && currentChunk.length > 0) {\n      yield currentChunk.trim();\n      currentChunk = word;\n    } else {\n      currentChunk += (currentChunk ? ' ' : '') + word;\n    }\n  }\n  \n  if (currentChunk) {\n    yield currentChunk.trim();\n  }\n}","/**\n * Simple encryption utilities for demo mode API key storage\n * \n * This provides basic obfuscation to prevent casual observation\n * of API keys in browser storage. This is NOT cryptographically\n * secure and should only be used for demo/playground purposes.\n */\n\n/**\n * Generate a random key for encryption\n */\nexport function generateKey(): string {\n  const array = new Uint8Array(32);\n  crypto.getRandomValues(array);\n  return Array.from(array, byte => byte.toString(16).padStart(2, '0')).join('');\n}\n\n/**\n * Simple XOR encryption (obfuscation)\n * This is NOT secure encryption - it's just to prevent\n * API keys from being stored in plain text\n */\nexport function encrypt(text: string, key: string): string {\n  let result = '';\n  for (let i = 0; i < text.length; i++) {\n    result += String.fromCharCode(\n      text.charCodeAt(i) ^ key.charCodeAt(i % key.length)\n    );\n  }\n  return btoa(result); // Base64 encode\n}\n\n/**\n * Decrypt XOR encrypted text\n */\nexport function decrypt(encrypted: string, key: string): string {\n  try {\n    const text = atob(encrypted); // Base64 decode\n    let result = '';\n    for (let i = 0; i < text.length; i++) {\n      result += String.fromCharCode(\n        text.charCodeAt(i) ^ key.charCodeAt(i % key.length)\n      );\n    }\n    return result;\n  } catch {\n    return '';\n  }\n}\n\n/**\n * Validate API key format\n */\nexport function isValidApiKey(key: string): boolean {\n  // CustomGPT.ai API key format: projectId|apiKey\n  // Example: 7840|8TPfOoyBywFfUfvwuY7ZZ2s1WAFtxU7WCxunMbej\n  const trimmedKey = key.trim();\n  \n  // Check if it contains a pipe character\n  if (!trimmedKey.includes('|')) {\n    return false;\n  }\n  \n  // Split and validate both parts\n  const [projectId, apiKey] = trimmedKey.split('|');\n  \n  // Project ID should be numeric\n  if (!projectId || !/^\\d+$/.test(projectId)) {\n    return false;\n  }\n  \n  // API key should be alphanumeric (with possible special chars)\n  if (!apiKey || apiKey.length < 20) {\n    return false;\n  }\n  \n  return true;\n}","/**\n * Demo Mode Store\n * \n * Manages API key storage and authentication for demo/playground mode.\n * Uses encrypted sessionStorage for temporary key storage that survives\n * page refreshes but is cleared when the browser tab is closed.\n */\n\nimport { create } from 'zustand';\nimport { encrypt, decrypt, generateKey, isValidApiKey } from '@/lib/crypto';\n\ninterface DemoStore {\n  // Demo mode configuration\n  isDemoMode: boolean;\n  \n  // API key management\n  apiKey: string | null;\n  openAIApiKey: string | null;\n  encryptionKey: string | null;\n  \n  // UI state\n  isAuthenticated: boolean;\n  error: string | null;\n  \n  // Session management\n  sessionStartTime: number | null;\n  sessionTimeout: number; // 2 hours in milliseconds\n  \n  // Actions\n  setApiKey: (key: string) => void;\n  setOpenAIApiKey: (key: string) => void;\n  clearApiKey: () => void;\n  validateSession: () => boolean;\n  setError: (error: string | null) => void;\n  initializeFromStorage: () => void;\n  restoreSession: () => boolean;\n}\n\nconst STORAGE_KEY = 'customgpt-demo-key';\nconst OPENAI_STORAGE_KEY = 'customgpt-demo-openai-key';\nconst ENCRYPTION_KEY = 'customgpt-demo-enc';\nconst SESSION_KEY = 'customgpt-demo-session';\nconst SESSION_TIMEOUT = 2 * 60 * 60 * 1000; // 2 hours\n\nexport const useDemoStore = create<DemoStore>((set, get) => ({\n  // Check if demo mode is enabled from localStorage deployment mode\n  isDemoMode: typeof window !== 'undefined' ? localStorage.getItem('customgpt.deploymentMode') === 'demo' : false,\n  \n  apiKey: null,\n  openAIApiKey: null,\n  encryptionKey: null,\n  isAuthenticated: false,\n  error: null,\n  sessionStartTime: null,\n  sessionTimeout: SESSION_TIMEOUT,\n  \n  setApiKey: (key: string) => {\n    const trimmedKey = key.trim();\n    \n    // Validate API key format\n    if (!isValidApiKey(trimmedKey)) {\n      set({ error: 'Invalid API key format' });\n      return;\n    }\n    \n    try {\n      // Generate encryption key\n      const encKey = generateKey();\n      \n      // Encrypt and store in sessionStorage\n      const encrypted = encrypt(trimmedKey, encKey);\n      sessionStorage.setItem(STORAGE_KEY, encrypted);\n      sessionStorage.setItem(ENCRYPTION_KEY, encKey);\n      \n      // Store session info\n      const sessionInfo = {\n        startTime: Date.now(),\n        encKey: encKey\n      };\n      sessionStorage.setItem(SESSION_KEY, JSON.stringify(sessionInfo));\n      \n      // Update store state\n      set({\n        apiKey: trimmedKey,\n        encryptionKey: encKey,\n        isAuthenticated: true,\n        error: null,\n        sessionStartTime: Date.now()\n      });\n    } catch (error) {\n      set({ error: 'Failed to store API key' });\n    }\n  },\n  \n  setOpenAIApiKey: (key: string) => {\n    const trimmedKey = key.trim();\n    const state = get();\n    \n    // Only allow if already authenticated with CustomGPT key\n    if (!state.isAuthenticated) {\n      set({ error: 'Please enter CustomGPT.ai API key first' });\n      return;\n    }\n    \n    // OpenAI keys typically start with 'sk-'\n    if (trimmedKey && !trimmedKey.startsWith('sk-')) {\n      set({ error: 'Invalid OpenAI API key format' });\n      return;\n    }\n    \n    try {\n      // Use same encryption key as CustomGPT key\n      const encKey = state.encryptionKey;\n      if (!encKey) {\n        set({ error: 'Encryption key not found' });\n        return;\n      }\n      \n      if (trimmedKey) {\n        // Encrypt and store\n        const encrypted = encrypt(trimmedKey, encKey);\n        sessionStorage.setItem(OPENAI_STORAGE_KEY, encrypted);\n        set({ openAIApiKey: trimmedKey, error: null });\n      } else {\n        // Clear OpenAI key\n        sessionStorage.removeItem(OPENAI_STORAGE_KEY);\n        set({ openAIApiKey: null, error: null });\n      }\n    } catch (error) {\n      set({ error: 'Failed to store OpenAI API key' });\n    }\n  },\n  \n  clearApiKey: () => {\n    // Clear from storage\n    sessionStorage.removeItem(STORAGE_KEY);\n    sessionStorage.removeItem(OPENAI_STORAGE_KEY);\n    sessionStorage.removeItem(ENCRYPTION_KEY);\n    sessionStorage.removeItem(SESSION_KEY);\n    \n    // Clear from memory\n    set({\n      apiKey: null,\n      openAIApiKey: null,\n      encryptionKey: null,\n      isAuthenticated: false,\n      error: null,\n      sessionStartTime: null\n    });\n  },\n  \n  validateSession: () => {\n    const state = get();\n    \n    // Check if session has expired\n    if (state.sessionStartTime) {\n      const elapsed = Date.now() - state.sessionStartTime;\n      if (elapsed > state.sessionTimeout) {\n        state.clearApiKey();\n        state.setError('Session expired. Please enter your API key again.');\n        return false;\n      }\n    }\n    \n    return state.isAuthenticated;\n  },\n  \n  setError: (error: string | null) => {\n    set({ error });\n  },\n  \n  initializeFromStorage: () => {\n    const state = get();\n    \n    // Only initialize if demo mode is enabled\n    if (!state.isDemoMode) return;\n    \n    // Try to restore the session\n    state.restoreSession();\n  },\n  \n  restoreSession: () => {\n    const state = get();\n    \n    try {\n      // Check for session info\n      const sessionData = sessionStorage.getItem(SESSION_KEY);\n      if (!sessionData) return false;\n      \n      const sessionInfo = JSON.parse(sessionData);\n      const { startTime, encKey } = sessionInfo;\n      \n      // Check if session expired\n      const elapsed = Date.now() - startTime;\n      if (elapsed > SESSION_TIMEOUT) {\n        state.clearApiKey();\n        state.setError('Session expired. Please enter your API key again.');\n        return false;\n      }\n      \n      // Try to restore encrypted keys\n      const encrypted = sessionStorage.getItem(STORAGE_KEY);\n      const encryptedOpenAI = sessionStorage.getItem(OPENAI_STORAGE_KEY);\n      \n      if (!encrypted || !encKey) return false;\n      \n      // Decrypt API keys\n      const apiKey = decrypt(encrypted, encKey);\n      if (!apiKey || !isValidApiKey(apiKey)) {\n        state.clearApiKey();\n        return false;\n      }\n      \n      // Restore OpenAI key if present\n      let openAIKey = null;\n      if (encryptedOpenAI) {\n        openAIKey = decrypt(encryptedOpenAI, encKey);\n      }\n      \n      // Restore state\n      set({\n        apiKey: apiKey,\n        openAIApiKey: openAIKey,\n        encryptionKey: encKey,\n        isAuthenticated: true,\n        sessionStartTime: startTime,\n        error: null\n      });\n      \n      return true;\n    } catch {\n      // Session restore failed, clear everything\n      state.clearApiKey();\n      return false;\n    }\n  }\n}));\n\n// Auto-clear on tab visibility change (optional security feature)\nif (typeof window !== 'undefined') {\n  document.addEventListener('visibilitychange', () => {\n    if (document.hidden) {\n      // Optional: Clear API key when tab is hidden\n      // Uncomment for extra security\n      // const { clearApiKey } = useDemoStore.getState();\n      // clearApiKey();\n    }\n  });\n  \n  // Check session validity periodically\n  setInterval(() => {\n    const { validateSession } = useDemoStore.getState();\n    validateSession();\n  }, 60000); // Check every minute\n}","'use client';\n\nimport React, { useEffect, useState, useRef, useCallback } from 'react';\nimport { useMicVAD, utils } from '@ricky0123/vad-react';\nimport RotateLoader from 'react-spinners/RotateLoader';\nimport { X, StopCircle, Mic, MicOff, Settings } from 'lucide-react';\nimport Canvas from './Canvas';\nimport { VoiceSettings } from './VoiceSettings';\nimport { speechManager } from '@/lib/voice/speech-manager';\nimport { useMessageStore, useConversationStore } from '@/hooks/useWidgetStore';\nimport { useAgentStore } from '@/store/agents';\nimport { generateId, generateConversationName } from '@/lib/utils';\nimport { useVoiceSettingsStore } from '@/store/voice-settings';\nimport { parseMarkdownForVoice } from '@/lib/voice/utils';\nimport { useDemoStore } from '@/store/demo';\nimport { AlertTriangle } from 'lucide-react';\n\ninterface VoiceModalProps {\n  isOpen: boolean;\n  onClose: () => void;\n  projectId: string;\n  projectName?: string;\n}\n\n// Voice states for UI animations\ntype VoiceState = 'idle' | 'listening' | 'recording' | 'processing' | 'speaking';\n\n// Separate component that handles VAD initialization\nfunction VoiceModalContent({ isOpen, onClose, projectId, projectName }: VoiceModalProps) {\n  const [loading, setLoading] = useState(true);\n  const [transcript, setTranscript] = useState('');\n  const [agentResponse, setAgentResponse] = useState('');\n  const [isManualRecording, setIsManualRecording] = useState(false);\n  const [mediaRecorder, setMediaRecorder] = useState<MediaRecorder | null>(null);\n  const [apiKeyError, setApiKeyError] = useState(false);\n  const [isAgentSpeaking, setIsAgentSpeaking] = useState(false);\n  const [isSettingsOpen, setIsSettingsOpen] = useState(false);\n  const [voiceState, setVoiceState] = useState<VoiceState>('idle');\n  const canvasRef = useRef<HTMLCanvasElement>(null);\n  \n  // Streaming state\n  const [isStreamingText, setIsStreamingText] = useState(false);\n  const [streamingResponse, setStreamingResponse] = useState('');\n  \n  // Message store integration\n  const { addMessage, messages, loadMessages } = useMessageStore();\n  const { currentConversation, ensureConversation, updateConversation } = useConversationStore();\n  const [currentUserMessageId, setCurrentUserMessageId] = useState<string | null>(null);\n  const [voiceConversation, setVoiceConversation] = useState<any>(null);\n  \n  // Guard to prevent multiple conversation creation attempts\n  const conversationSetupRef = useRef<boolean>(false);\n  \n  // Voice settings integration\n  const { selectedVoice, selectedPersona, setVoiceModalOpen } = useVoiceSettingsStore();\n  \n  // Demo mode check\n  const { isDemoMode, openAIApiKey } = useDemoStore();\n  \n  // Check if OpenAI API key is available\n  const checkOpenAIKeyAvailability = useCallback(() => {\n    const deploymentMode = localStorage.getItem('customgpt.deploymentMode') || 'production';\n    if (deploymentMode === 'demo' && !openAIApiKey) {\n      return false;\n    }\n    // In production mode, we can't check server-side env from client\n    // We'll let the API handle validation\n    return true;\n  }, [openAIApiKey]);\n\n  // Initialize VAD with error handling\n  const vad = useMicVAD({\n    preSpeechPadFrames: 10,\n    positiveSpeechThreshold: 0.8,   // Lower threshold for easier detection\n    negativeSpeechThreshold: 0.6,   // Lower threshold\n    minSpeechFrames: 3,              // Reduce minimum frames\n    startOnLoad: false,              // Start manually\n    workletURL: '/vad.worklet.bundle.min.js',\n    modelURL: '/silero_vad.onnx',\n    // VAD configuration\n    onSpeechStart: () => {\n      console.log(' [VAD] Speech started detected');\n      speechManager.onSpeechStart();\n    },\n    onSpeechEnd: (audio) => {\n      console.log(' [VAD] Speech ended, audio length:', audio.length);\n      speechManager.onSpeechEnd(audio);\n    },\n    onVADMisfire: () => {\n      console.log(' [VAD] Misfire detected');\n      speechManager.onMisfire();\n    }\n  });\n\n  // Control global voice modal state for hiding mobile navigation\n  useEffect(() => {\n    setVoiceModalOpen(isOpen);\n    \n    // Extra cleanup when closing to ensure mobile navigation reappears\n    if (!isOpen) {\n      // Reset conversation setup guard when modal closes\n      conversationSetupRef.current = false;\n      // Clear voice conversation reference when modal closes\n      setVoiceConversation(null);\n      \n      // Small delay to ensure the state change is processed\n      setTimeout(() => {\n        setVoiceModalOpen(false);\n      }, 100);\n    }\n  }, [isOpen, setVoiceModalOpen]);\n\n  // Set up speech manager when modal opens\n  useEffect(() => {\n    if (isOpen && projectId) {\n      console.log(' [VOICE-MODAL] Setting up speech manager with projectId:', projectId);\n      speechManager.setProjectId(projectId);\n      \n      // Apply voice settings to speech manager\n      speechManager.setVoiceSettings(selectedVoice, selectedPersona);\n      \n      // Pass demo keys to window object for speech manager (only in demo mode)\n      if (isDemoMode) {\n        if (openAIApiKey) {\n          (window as any).__demoOpenAIKey = openAIApiKey;\n        }\n        // Also pass CustomGPT API key from demo store\n        const demoApiKey = useDemoStore.getState().apiKey;\n        if (demoApiKey) {\n          (window as any).__demoCustomGPTKey = demoApiKey;\n        }\n      }\n      \n      // Theme is now handled directly by Canvas component through themeId prop\n      \n      // Check if agent is active\n      const currentAgentStore = useAgentStore.getState();\n      const agent = currentAgentStore.agents.find(a => a.id === parseInt(projectId));\n      \n      if (agent && !agent.is_chat_active) {\n        console.warn(' [VOICE-MODAL] Agent is inactive - may fall back to OpenAI');\n      }\n      \n      // Set the model based on agent settings or use fast default for voice\n      if (agent?.settings?.chatbot_model) {\n        speechManager.setChatbotModel(agent.settings.chatbot_model);\n      } else {\n        // Default to fast model for voice if agent doesn't have a model configured\n        speechManager.setChatbotModel('gpt-3.5-turbo');\n      }\n      \n      // Ensure we have a conversation before starting voice\n      const setupConversation = async () => {\n        // Prevent multiple setup attempts\n        if (conversationSetupRef.current) {\n          console.log(' [VOICE-MODAL] Conversation setup already in progress, skipping');\n          return;\n        }\n        \n        try {\n          conversationSetupRef.current = true;\n          let conversation = currentConversation;\n          \n          // If no current conversation and no voice conversation stored, create one for voice\n          if (!conversation && !voiceConversation) {\n            console.log(' [VOICE-MODAL] No current conversation, creating one for voice');\n            // Create conversation with voice title\n            conversation = await ensureConversation(parseInt(projectId), 'Voice Conversation');\n            console.log(' [VOICE-MODAL] Created conversation:', conversation.id, 'session:', conversation.session_id);\n            \n            // Immediately update the title to ensure it's set correctly\n            try {\n              await updateConversation(conversation.project_id, conversation.session_id, { name: 'Voice Conversation' });\n              console.log(' [VOICE-MODAL] Set initial voice conversation title');\n            } catch (error) {\n              console.error(' [VOICE-MODAL] Failed to set initial title:', error);\n            }\n            \n            // Store the conversation reference for reuse\n            setVoiceConversation(conversation);\n          } else if (conversation) {\n            // Store existing conversation reference\n            setVoiceConversation(conversation);\n          } else if (voiceConversation) {\n            // Use the existing voice conversation\n            conversation = voiceConversation;\n          }\n          \n          // Ensure we have a valid conversation before proceeding\n          if (!conversation) {\n            console.error(' [VOICE-MODAL] No conversation available after setup');\n            return;\n          }\n          \n          // Load conversation history and session ID\n          const conversationMessages = messages.get(conversation.id.toString()) || [];\n          console.log(' [VOICE-MODAL] Loading conversation history:', conversationMessages.length, 'messages');\n          console.log(' [VOICE-MODAL] Agent status:', agent?.is_chat_active ? 'Active' : 'Inactive');\n          \n          // Filter out any duplicate messages and ensure proper ordering\n          const cleanedMessages = conversationMessages.filter((msg, index, self) => \n            // Keep only the first occurrence of each message ID\n            index === self.findIndex(m => m.id === msg.id)\n          ).sort((a, b) => \n            // Sort by timestamp to ensure proper ordering\n            new Date(a.timestamp).getTime() - new Date(b.timestamp).getTime()\n          );\n          \n          speechManager.setConversationHistory(cleanedMessages);\n          speechManager.setSessionId(conversation.session_id);\n        } catch (error) {\n          console.error(' [VOICE-MODAL] Failed to setup conversation:', error);\n        } finally {\n          // Reset the guard after setup is complete (success or failure)\n          conversationSetupRef.current = false;\n        }\n      };\n      \n      setupConversation();\n      \n      speechManager.setCallbacks({\n        onUserSpeaking: () => {\n          (Canvas as any).onUserSpeaking?.();\n          setTranscript('');\n          setStreamingResponse(''); // Clear streaming response\n          setIsStreamingText(false);\n          setVoiceState('recording');\n        },\n        onProcessing: async () => {\n          (Canvas as any).onProcessing?.();\n          setVoiceState('processing');\n          \n          // Use existing conversation - don't create a new one\n          // The conversation should already be set up in setupConversation()\n          \n          const placeholderUserMessage = {\n            id: generateId(),\n            role: 'user' as const,\n            content: ' Processing voice input...',\n            timestamp: new Date().toISOString(),\n            status: 'sending' as const,\n          };\n          \n          setCurrentUserMessageId(placeholderUserMessage.id);\n          const targetConversation = voiceConversation || currentConversation;\n          if (targetConversation) {\n            addMessage(targetConversation.id.toString(), placeholderUserMessage);\n            console.log(' [VOICE-MODAL] Added placeholder user message');\n          }\n        },\n        onAiSpeaking: () => {\n          (Canvas as any).onAiSpeaking?.();\n          setIsAgentSpeaking(true);\n          setVoiceState('speaking');\n        },\n        onReset: () => {\n          (Canvas as any).reset?.();\n          setIsAgentSpeaking(false);\n          setIsStreamingText(false);\n          setVoiceState('idle');\n        },\n        onDebug: (message: string, data?: any) => {\n          // Debug logging removed for production\n        },\n        onError: (error: string) => {\n          console.error(' [VOICE-MODAL] Error from speech manager:', error);\n          // Check if it's an API key error\n          if (error.includes('OpenAI API key') || error.includes('API key')) {\n            setApiKeyError(true);\n            // Also show a toast error\n            const deploymentMode = typeof window !== 'undefined' ? localStorage.getItem('customgpt.deploymentMode') : null;\n            const isDemoMode = deploymentMode === 'demo';\n            const errorMsg = isDemoMode \n              ? 'Voice feature requires an OpenAI API key. Please enable voice capability in demo settings and provide your OpenAI API key.'\n              : 'Voice feature requires OpenAI API key configuration. Please add OPENAI_API_KEY to your .env.local file.';\n            \n            // Import toast at the top of the file\n            import('sonner').then(({ toast }) => {\n              toast.error(errorMsg);\n            });\n          }\n          setIsStreamingText(false);\n          setVoiceState('idle');\n        },\n        onTranscriptReceived: async (transcript: string) => {\n          console.log(' [VOICE-MODAL] Transcript received:', transcript);\n          setTranscript(transcript);\n          \n          // Update conversation title for voice conversations\n          const targetConversation = voiceConversation || currentConversation;\n          if (targetConversation) {\n            const conversationMessages = messages.get(targetConversation.id.toString()) || [];\n            // If this is the first message and conversation doesn't have a proper title yet, set voice title\n            if (conversationMessages.length <= 1) {\n              const currentTitle = targetConversation.name || '';\n              const needsVoiceTitle = !currentTitle || \n                                      currentTitle === 'New voice conversation' || \n                                      currentTitle === 'New Conversation' ||\n                                      currentTitle === 'Processing...' ||\n                                      currentTitle.startsWith('Chat ') ||\n                                      currentTitle.startsWith('OpenAI-') ||\n                                      currentTitle.includes('OpenAI-');\n              \n              if (needsVoiceTitle) {\n                // Generate a more descriptive title based on the transcript\n                let voiceTitle = 'Voice Conversation';\n                if (transcript && transcript.length > 0) {\n                  // Use the first few words of the transcript as the title, but clean it first\n                  const cleanTranscript = transcript\n                    .replace(/^(OpenAI-|System-|API-|Assistant:|User:)\\s*/i, '')\n                    .trim();\n                  if (cleanTranscript.length > 0) {\n                    const words = cleanTranscript.split(/\\s+/).slice(0, 6).join(' ');\n                    voiceTitle = `Voice: ${words.length > 40 ? words.substring(0, 40).trim() + '...' : words}`;\n                  }\n                }\n                \n                console.log(' [VOICE-MODAL] Setting voice conversation title:', voiceTitle);\n                try {\n                  await updateConversation(targetConversation.project_id, targetConversation.session_id, { name: voiceTitle });\n                } catch (error) {\n                  console.error(' [VOICE-MODAL] Failed to update conversation title:', error);\n                }\n              }\n            }\n          }\n          \n          // Update the placeholder message with actual transcript\n          \n          if (targetConversation && currentUserMessageId) {\n            // Update the existing placeholder message\n            const updatedUserMessage = {\n              id: currentUserMessageId,\n              role: 'user' as const,\n              content: transcript,\n              timestamp: new Date().toISOString(),\n              status: 'sent' as const,\n            };\n            \n            addMessage(targetConversation.id.toString(), updatedUserMessage);\n            console.log(' [VOICE-MODAL] Updated user message with transcript');\n          } else {\n            // Fallback: create new message if no placeholder exists\n            // Use the existing conversation from voiceConversation or currentConversation\n            const conversation = voiceConversation || currentConversation;\n            if (!conversation) {\n              console.error(' [VOICE-MODAL] No conversation available for user message');\n              return;\n            }\n            \n            const userMessage = {\n              id: generateId(),\n              role: 'user' as const,\n              content: transcript,\n              timestamp: new Date().toISOString(),\n              status: 'sent' as const,\n            };\n            \n            setCurrentUserMessageId(userMessage.id);\n            addMessage(conversation.id.toString(), userMessage);\n          }\n        },\n        onResponseReceived: async (response: string) => {\n          console.log(' [VOICE-MODAL] Response received:', response);\n          console.log(' [VOICE-MODAL] Response includes \"individuals\":', response.includes('individuals'));\n          console.log(' [VOICE-MODAL] Response includes \"like\":', response.includes('like'));\n          console.log(' [VOICE-MODAL] Response includes \"CustomGPT\":', response.includes('CustomGPT'));\n          \n          // For streaming responses, this will be called with the final response\n          // Don't update the display here as it's already being updated via streaming chunks\n          // This is mainly for adding the message to the conversation history\n          \n          // Use voiceConversation to ensure we're adding to the same conversation as the user message\n          // This prevents race condition where messages could be added out of order\n          const targetConversation = voiceConversation || currentConversation;\n          \n          if (targetConversation) {\n            // Create and add assistant message to chat\n            const assistantMessage = {\n              id: generateId(),\n              role: 'assistant' as const,\n              content: response,\n              timestamp: new Date().toISOString(),\n              status: 'sent' as const,\n              citations: [], // Voice responses typically don't have citations\n            };\n            \n            addMessage(targetConversation.id.toString(), assistantMessage);\n            \n            // Force refresh conversation to ensure proper syncing\n            const currentMessages = messages.get(targetConversation.id.toString()) || [];\n            console.log(' [VOICE-MODAL] Current conversation messages:', currentMessages.length, 'messages');\n            \n          } else {\n            console.warn(' [VOICE-MODAL] No conversation available for adding assistant message');\n          }\n        },\n        // New streaming callbacks\n        onStreamingTextChunk: (textChunk: string) => {\n          console.log(' [VOICE-MODAL] Streaming text chunk:', textChunk);\n          setIsStreamingText(true);\n          setStreamingResponse(prev => {\n            const newText = prev + textChunk;\n            console.log(' [VOICE-MODAL] Accumulated streaming text length:', newText.length);\n            // Update the displayed response immediately for streaming\n            const cleanResponse = parseMarkdownForVoice(newText);\n            setAgentResponse(cleanResponse);\n            return newText;\n          });\n        },\n        onStreamingAudioReady: (audioUrl: string, chunkId: string) => {\n          console.log(' [VOICE-MODAL] Audio chunk ready:', chunkId, 'URL length:', audioUrl.length);\n          \n          // Ensure we're in speaking state when audio arrives\n          if (voiceState !== 'speaking') {\n            setVoiceState('speaking');\n            setIsAgentSpeaking(true);\n          }\n        },\n        onStreamingComplete: (fullResponse: string, transcript: string) => {\n          console.log(' [VOICE-MODAL] Streaming complete:', { fullResponse: fullResponse.length, transcript });\n          console.log(' [VOICE-MODAL] Full response includes \"individuals\":', fullResponse.includes('individuals'));\n          console.log(' [VOICE-MODAL] Full response includes \"like\":', fullResponse.includes('like'));\n          console.log(' [VOICE-MODAL] Full response includes \"CustomGPT\":', fullResponse.includes('CustomGPT'));\n          \n          // Final cleanup - ensure we have the complete response\n          const cleanResponse = parseMarkdownForVoice(fullResponse);\n          console.log(' [VOICE-MODAL] Final clean response:', cleanResponse);\n          setAgentResponse(cleanResponse);\n          setStreamingResponse(fullResponse);\n          setIsStreamingText(false);\n          \n          // Don't add messages here - they've already been added via onTranscriptReceived and onResponseReceived\n          // This prevents duplicate messages in the conversation\n        }\n      });\n    }\n    \n    // Clean up when modal closes\n    if (!isOpen) {\n      // Don't clear conversation history to maintain context\n      setTranscript('');\n      setAgentResponse('');\n      setStreamingResponse('');\n      setIsStreamingText(false);\n      setIsAgentSpeaking(false);\n      setVoiceConversation(null); // Clear voice conversation reference\n      setVoiceState('idle'); // Reset voice state to idle\n      setCurrentUserMessageId(null); // Clear current user message ID\n      \n      // Clean up demo keys from window object (only in demo mode)\n      if ((window as any).__demoOpenAIKey) {\n        delete (window as any).__demoOpenAIKey;\n      }\n      if ((window as any).__demoCustomGPTKey) {\n        delete (window as any).__demoCustomGPTKey;\n      }\n      \n      // Ensure VAD is stopped if it was running\n      if (vad.listening) {\n        vad.pause();\n      }\n      \n      // Clean up speech manager streaming resources\n      speechManager.destroy();\n      \n      // Ensure global state is properly reset\n      setVoiceModalOpen(false);\n      \n      // Reload messages to ensure sync with API format\n      if (currentConversation) {\n        // Use the loadMessages function directly from the hook\n        loadMessages(currentConversation.id.toString());\n      }\n    }\n  }, [isOpen, projectId, currentConversation, messages, selectedVoice, selectedPersona, isDemoMode, openAIApiKey, loadMessages]);\n  \n  // Update settings when they change\n  useEffect(() => {\n    if (isOpen && projectId) {\n      // Update speech manager with new voice settings\n      speechManager.setVoiceSettings(selectedVoice, selectedPersona);\n      \n      // Get agent's configured model\n      const currentAgentStore = useAgentStore.getState();\n      const agent = currentAgentStore.agents.find(a => a.id === parseInt(projectId));\n      if (agent?.settings?.chatbot_model) {\n        speechManager.setChatbotModel(agent.settings.chatbot_model);\n      }\n      \n      // Theme is now handled directly by Canvas component through themeId prop\n      // The Canvas component automatically switches themes when themeId changes\n    }\n  }, [selectedVoice, selectedPersona, isOpen, projectId]);\n  \n  // Monitor VAD state changes\n  useEffect(() => {\n    if (vad.errored) {\n    } else if (!vad.loading && !vad.errored) {\n    }\n  }, [vad.loading, vad.errored]);\n\n  // Define handleToggleListening before useEffect that uses it\n  const handleToggleListening = useCallback(async () => {\n    console.log(' [VOICE-MODAL] Toggle listening clicked', { \n      vadLoading: vad.loading,\n      vadListening: vad.listening,\n      vadErrored: vad.errored\n    });\n    \n    // Check OpenAI key availability first\n    if (!checkOpenAIKeyAvailability()) {\n      console.error(' [VOICE-MODAL] OpenAI API key not available');\n      setApiKeyError(true);\n      const deploymentMode = localStorage.getItem('customgpt.deploymentMode') || 'production';\n      const errorMsg = deploymentMode === 'demo' \n        ? 'Voice feature requires an OpenAI API key. Please enable voice capability in demo settings and provide your OpenAI API key.'\n        : 'Voice feature requires OpenAI API key. Please add OPENAI_API_KEY to your .env.local file.';\n      \n      import('sonner').then(({ toast }) => {\n        toast.error(errorMsg);\n      });\n      return;\n    }\n    \n    // Enhanced error handling for VAD\n    if (vad.errored) {\n      console.error(' [VOICE-MODAL] VAD is in error state, attempting recovery...');\n      \n      // Try to restart VAD after error\n      try {\n        console.log(' [VOICE-MODAL] Attempting VAD recovery...');\n        // Wait a moment then try to start\n        setTimeout(() => {\n          if (!vad.listening && !vad.loading) {\n            console.log(' [VOICE-MODAL] Retry VAD start after error');\n            vad.start();\n          }\n        }, 1000);\n        return;\n      } catch (recoveryError) {\n        console.error(' [VOICE-MODAL] VAD recovery failed:', recoveryError);\n        return;\n      }\n    }\n    \n    try {\n      if (vad.listening) {\n        console.log(' [VOICE-MODAL] Pausing VAD');\n        vad.pause();\n        setVoiceState('idle');\n      } else {\n        console.log(' [VOICE-MODAL] Starting VAD');\n        setVoiceState('listening');\n        \n        // Simplified microphone permission check\n        try {\n          console.log(' [VOICE-MODAL] Checking microphone permissions...');\n          const stream = await navigator.mediaDevices.getUserMedia({ \n            audio: true\n          });\n          \n          // Clean up immediately - we just needed to check permission\n          stream.getTracks().forEach(track => track.stop());\n          \n          console.log(' [VOICE-MODAL] Microphone permission granted');\n        } catch (permissionError) {\n          console.error(' [VOICE-MODAL] Microphone permission failed:', permissionError);\n          const errorMessage = permissionError instanceof Error ? permissionError.message : 'Permission denied';\n          \n          // Still try to start VAD - it might handle permissions internally\n        }\n        \n        // Start VAD with additional error handling\n        try {\n          vad.start();\n        } catch (vadError) {\n          console.error(' [VOICE-MODAL] VAD start failed:', vadError);\n          const errorMessage = vadError instanceof Error ? vadError.message : 'Unknown error';\n        }\n      }\n    } catch (error) {\n      console.error(' [VOICE-MODAL] Error in toggle listening:', error);\n    }\n  }, [vad, checkOpenAIKeyAvailability]);\n\n  // Manual recording fallback when VAD fails\n  const handleManualRecording = useCallback(async () => {\n    console.log(' [MANUAL] Starting manual recording fallback');\n    \n    // Check OpenAI key availability first\n    if (!checkOpenAIKeyAvailability()) {\n      console.error(' [MANUAL] OpenAI API key not available');\n      setApiKeyError(true);\n      const deploymentMode = localStorage.getItem('customgpt.deploymentMode') || 'production';\n      const errorMsg = deploymentMode === 'demo' \n        ? 'Voice feature requires an OpenAI API key. Please enable voice capability in demo settings and provide your OpenAI API key.'\n        : 'Voice feature requires OpenAI API key. Please add OPENAI_API_KEY to your .env.local file.';\n      \n      import('sonner').then(({ toast }) => {\n        toast.error(errorMsg);\n      });\n      return;\n    }\n    \n    try {\n      if (!isManualRecording) {\n        // Start manual recording with better audio quality\n        setVoiceState('recording');\n        const stream = await navigator.mediaDevices.getUserMedia({ \n          audio: {\n            echoCancellation: true,\n            noiseSuppression: true,\n            autoGainControl: true,\n            sampleRate: 48000\n          } \n        });\n        \n        // Choose the best available audio format\n        const mimeType = MediaRecorder.isTypeSupported('audio/webm;codecs=opus') \n          ? 'audio/webm;codecs=opus' \n          : 'audio/webm';\n          \n        const recorder = new MediaRecorder(stream, { mimeType });\n        const chunks: Blob[] = [];\n        \n        recorder.ondataavailable = (event) => {\n          if (event.data.size > 0) {\n            chunks.push(event.data);\n          }\n        };\n        \n        recorder.onstop = async () => {\n          console.log(' [MANUAL] Recording stopped, processing audio...');\n          // MediaRecorder doesn't produce WAV, it produces webm/opus or similar\n          const audioBlob = new Blob(chunks, { type: recorder.mimeType || 'audio/webm' });\n          \n          try {\n            // Create audio context for decoding compressed audio\n            const audioContext = new AudioContext();\n            \n            // Convert blob to ArrayBuffer\n            const audioBuffer = await audioBlob.arrayBuffer();\n            \n            // Decode the compressed audio to get raw PCM data\n            const decodedAudio = await audioContext.decodeAudioData(audioBuffer);\n            console.log(' [MANUAL] Audio decoded:', {\n              sampleRate: decodedAudio.sampleRate,\n              channels: decodedAudio.numberOfChannels,\n              duration: decodedAudio.duration,\n              length: decodedAudio.length\n            });\n            \n            // Convert to mono Float32Array (match VAD format)\n            const channelData = decodedAudio.getChannelData(0); // Get first channel\n            \n            // CRITICAL: Resample from 48kHz to 16kHz for VAD/Whisper compatibility\n            let audioArray: Float32Array;\n            if (decodedAudio.sampleRate !== 16000) {\n              console.log(' [MANUAL] Resampling from', decodedAudio.sampleRate, 'to 16kHz');\n              const resampleRatio = 16000 / decodedAudio.sampleRate;\n              const newLength = Math.floor(channelData.length * resampleRatio);\n              audioArray = new Float32Array(newLength);\n              \n              // Simple linear interpolation resampling\n              for (let i = 0; i < newLength; i++) {\n                const srcIndex = i / resampleRatio;\n                const srcIndexFloor = Math.floor(srcIndex);\n                const srcIndexCeil = Math.min(srcIndexFloor + 1, channelData.length - 1);\n                const fraction = srcIndex - srcIndexFloor;\n                \n                audioArray[i] = channelData[srcIndexFloor] * (1 - fraction) + \n                               channelData[srcIndexCeil] * fraction;\n              }\n            } else {\n              audioArray = new Float32Array(channelData);\n            }\n            \n            console.log(' [MANUAL] Audio ready:', audioArray.length, 'samples at 16kHz');\n            \n            // Process through speech manager\n            speechManager.onSpeechStart();\n            await speechManager.onSpeechEnd(audioArray);\n            \n            // Clean up audio context\n            await audioContext.close();\n            \n          } catch (error) {\n            console.error(' [MANUAL] Audio decoding failed:', error);\n          }\n          \n          // Clean up recording resources\n          stream.getTracks().forEach(track => track.stop());\n          setIsManualRecording(false);\n          setMediaRecorder(null);\n        };\n        \n        setMediaRecorder(recorder);\n        setIsManualRecording(true);\n        recorder.start();\n        \n        \n      } else {\n        // Stop manual recording\n        if (mediaRecorder) {\n          mediaRecorder.stop();\n        }\n      }\n    } catch (error) {\n      console.error(' [MANUAL] Manual recording failed:', error);\n    }\n  }, [isManualRecording, mediaRecorder, checkOpenAIKeyAvailability]);\n\n  // Track if we've already auto-started to prevent loops\n  const [hasAutoStarted, setHasAutoStarted] = useState(false);\n\n  // Handle stopping the agent's speech\n  const handleStopSpeech = useCallback(() => {\n    console.log(' [VOICE-MODAL] Stopping agent speech');\n    speechManager.stopAudio();\n    setIsAgentSpeaking(false);\n  }, []);\n\n  // Handle VAD state updates with comprehensive error checking\n  useEffect(() => {\n    console.log(' [VOICE-MODAL] VAD state changed', { \n      isOpen,\n      vadLoading: vad.loading, \n      vadListening: vad.listening,\n      vadUserSpeaking: vad.userSpeaking,\n      vadErrored: vad.errored,\n      hasAutoStarted\n    });\n    \n    // Check for VAD errors\n    if (vad.errored) {\n      console.error(' [VOICE-MODAL] VAD encountered an error');\n      return;\n    }\n    \n    // Don't auto-start VAD - wait for user interaction\n    // This prevents microphone permission request on modal open\n    if (isOpen && !vad.loading && !vad.listening && !vad.errored) {\n      console.log(' [VOICE-MODAL] VAD loaded successfully, ready for manual start');\n    }\n    \n    // If VAD is in error state but we haven't tried recovery, attempt recovery\n    if (isOpen && !vad.loading && vad.errored && hasAutoStarted) {\n      console.log(' [VOICE-MODAL] VAD in error state, scheduling recovery attempt...');\n      \n      // Don't continuously retry, just once more after a delay\n      setTimeout(() => {\n        if (vad.errored && !vad.listening) {\n          console.log(' [VOICE-MODAL] Executing VAD recovery attempt');\n          handleToggleListening();\n        }\n      }, 1500);\n    }\n    \n    // Pause when modal closes\n    if (!isOpen && vad.listening) {\n      console.log(' [VOICE-MODAL] Pausing VAD (modal closed)');\n      vad.pause();\n    }\n  }, [isOpen, vad.loading, vad.listening, vad.errored, hasAutoStarted]);\n\n  // Reset auto-start flag and error state when modal opens\n  useEffect(() => {\n    if (isOpen) {\n      setHasAutoStarted(false);\n      setApiKeyError(false);\n      setTranscript('');\n      setAgentResponse('');\n      setStreamingResponse('');\n      setIsStreamingText(false);\n      setIsAgentSpeaking(false);\n      setVoiceConversation(null); // Reset voice conversation for new session\n    }\n  }, [isOpen]);\n\n  useEffect(() => {\n    setLoading(vad.loading);\n  }, [vad.loading]);\n\n  return (\n    <>\n      {isOpen && (\n        <>\n          <style jsx global>{`\n            /* Custom scrollbar styles for voice modal */\n            .voice-response-scroll::-webkit-scrollbar {\n              width: 6px;\n            }\n            \n            .voice-response-scroll::-webkit-scrollbar-track {\n              background: rgba(255, 255, 255, 0.1);\n              border-radius: 3px;\n            }\n            \n            .voice-response-scroll::-webkit-scrollbar-thumb {\n              background: rgba(255, 255, 255, 0.3);\n              border-radius: 3px;\n            }\n            \n            .voice-response-scroll::-webkit-scrollbar-thumb:hover {\n              background: rgba(255, 255, 255, 0.5);\n            }\n            \n            /* Firefox scrollbar */\n            .voice-response-scroll {\n              scrollbar-width: thin;\n              scrollbar-color: rgba(255, 255, 255, 0.3) rgba(255, 255, 255, 0.1);\n            }\n            \n            /* Mobile touch scrolling optimization */\n            .voice-response-scroll {\n              -webkit-overflow-scrolling: touch;\n              scroll-behavior: smooth;\n            }\n          `}</style>\n          {/* Settings and Close buttons - moved outside main container to avoid click issues */}\n          <div \n            className=\"fixed top-4 sm:top-6 md:top-8 right-4 sm:right-6 md:right-8 flex items-center gap-2 sm:gap-3 z-[10000]\"\n            style={{ pointerEvents: 'auto' }}\n          >\n            {/* Settings button */}\n            <button\n              onClick={(e) => {\n                e.preventDefault();\n                e.stopPropagation();\n                console.log(' Settings button clicked, current state:', isSettingsOpen);\n                setIsSettingsOpen(true);\n                console.log(' Settings state should now be true');\n              }}\n              className=\"w-10 h-10 sm:w-12 sm:h-12 rounded-full bg-white/10 hover:bg-white/20 active:bg-white/30 backdrop-blur-sm flex items-center justify-center transition-all transform active:scale-95\"\n              aria-label=\"Voice settings\"\n            >\n              <Settings className=\"w-5 h-5 sm:w-6 sm:h-6 text-white\" />\n            </button>\n            \n            {/* Close button */}\n            <button\n              onClick={(e) => {\n                e.preventDefault();\n                e.stopPropagation();\n                console.log(' Close button clicked');\n                onClose();\n              }}\n              className=\"w-10 h-10 sm:w-12 sm:h-12 rounded-full bg-white/10 hover:bg-white/20 active:bg-white/30 backdrop-blur-sm flex items-center justify-center transition-all transform active:scale-95\"\n              aria-label=\"Close voice mode\"\n            >\n              <X className=\"w-5 h-5 sm:w-6 sm:h-6 text-white\" />\n            </button>\n          </div>\n          \n          <div \n            className=\"fixed inset-0 z-[9999] overflow-hidden\"\n          >\n          {/* Dynamic gradient background based on voice state */}\n          <div className={`absolute inset-0 transition-all duration-1000 pointer-events-none ${\n            voiceState === 'idle' ? 'voice-gradient-idle' :\n            voiceState === 'listening' ? 'voice-gradient-listening' :\n            voiceState === 'recording' ? 'voice-gradient-recording' :\n            voiceState === 'processing' ? 'voice-gradient-processing' :\n            'voice-gradient-speaking'\n          }`} />\n          \n          {/* Wave overlay effect for processing and speaking states */}\n          {(voiceState === 'processing' || voiceState === 'speaking') && (\n            <div className=\"absolute inset-0 voice-overlay-wave pointer-events-none\" />\n          )}\n          \n          {/* Pulse overlay for recording state */}\n          {voiceState === 'recording' && (\n            <div className=\"absolute inset-0 bg-red-500/10 voice-overlay-pulse pointer-events-none\" />\n          )}\n          {loading ? (\n            <div className=\"flex items-center justify-center h-full relative z-10\">\n              <RotateLoader\n                loading={loading}\n                color=\"#ffffff\"\n                aria-label=\"Loading Voice\"\n                data-testid=\"loader\"\n              />\n            </div>\n          ) : (\n            <>\n              {/* Canvas for particle animation */}\n              <div className=\"absolute inset-0 pointer-events-none z-0\">\n                <Canvas />\n              </div>\n              \n              {/* Top-left settings display */}\n              <div className=\"absolute top-4 sm:top-6 md:top-8 left-4 sm:left-6 md:left-8 z-20 space-y-2\">\n                {/* Demo mode indicator */}\n                {isDemoMode && (\n                  <div className=\"bg-amber-500/20 backdrop-blur-sm rounded-lg px-3 py-2 text-amber-300 text-xs flex items-center gap-2 border border-amber-500/30\">\n                    <AlertTriangle className=\"w-3 h-3\" />\n                    <span className=\"font-medium\">Demo Mode</span>\n                  </div>\n                )}\n                \n                {/* Voice settings */}\n                <div className=\"bg-white/5 backdrop-blur-sm rounded-lg px-3 py-2 text-white/70 text-xs space-y-1\">\n                  <div>Voice: {selectedVoice}</div>\n                  <div>Persona: {selectedPersona}</div>\n                  <div>Model: {(() => {\n                    const currentAgentStore = useAgentStore.getState();\n                    const currentAgent = currentAgentStore.agents.find(a => a.id === parseInt(projectId));\n                    return currentAgent?.settings?.chatbot_model || 'gpt-3.5-turbo';\n                  })()}</div>\n                </div>\n              </div>\n\n              \n              \n\n              {/* Status display - mobile optimized with better text handling */}\n              <div className=\"absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-white text-center px-4 z-10 pointer-events-auto max-w-full\" style={{ maxHeight: '80vh', display: 'flex', flexDirection: 'column' }}>\n                <div className=\"relative\">\n                  {/* Main status text with state-based colors - no blinking */}\n                  <p className={`text-2xl sm:text-3xl md:text-4xl font-light mb-4 leading-tight transition-all duration-300 ${\n                    voiceState === 'recording' ? 'text-red-400' :\n                    voiceState === 'processing' ? 'text-purple-400' :\n                    voiceState === 'speaking' ? 'text-green-400' :\n                    voiceState === 'listening' ? 'text-blue-400' :\n                    'text-white/90'\n                  }`}>\n                    {isManualRecording \n                      ? 'Analyzing...' \n                      : voiceState === 'listening'\n                      ? 'Listening...'\n                      : voiceState === 'processing'\n                      ? 'Thinking...'\n                      : voiceState === 'speaking'\n                      ? 'Speaking...'\n                      : vad.loading\n                      ? 'Initializing...'\n                      : 'Ready to chat'}\n                  </p>\n                  \n                  {/* Animated dots for processing state */}\n                  {voiceState === 'processing' && (\n                    <div className=\"flex justify-center gap-1 mt-2\">\n                      <div className=\"w-2 h-2 bg-purple-400 rounded-full animate-bounce\" style={{ animationDelay: '0ms' }} />\n                      <div className=\"w-2 h-2 bg-purple-400 rounded-full animate-bounce\" style={{ animationDelay: '150ms' }} />\n                      <div className=\"w-2 h-2 bg-purple-400 rounded-full animate-bounce\" style={{ animationDelay: '300ms' }} />\n                    </div>\n                  )}\n                </div>\n                \n                {/* Show user's transcript - responsive */}\n                {transcript && (\n                  <div className=\"mb-4 sm:mb-6\">\n                    <p className=\"text-xs sm:text-sm text-white/70 mb-1\">You said:</p>\n                    <p className=\"text-sm sm:text-lg text-white/90 max-w-xs sm:max-w-md mx-auto px-2\">&ldquo;{transcript}&rdquo;</p>\n                  </div>\n                )}\n                \n                {/* Show agent's response - mobile optimized with scrollable area */}\n                {agentResponse && (\n                  <div className=\"animate-fade-in pointer-events-auto\">\n                    <div className=\"flex items-center gap-2 mb-1\">\n                      <p className=\"text-xs text-white/70\">Agent:</p>\n                      {isStreamingText && (\n                        <div className=\"flex items-center gap-1\">\n                          <div className=\"w-1.5 h-1.5 bg-blue-400 rounded-full animate-pulse\"></div>\n                          <span className=\"text-xs text-blue-400/70\">streaming...</span>\n                        </div>\n                      )}\n                    </div>\n                    <div className=\"voice-response-scroll max-h-[40vh] sm:max-h-[50vh] overflow-y-auto overflow-x-hidden px-4 py-2 -mx-2 rounded-lg bg-white/5 relative\">\n                      <p className=\"text-sm sm:text-base text-white max-w-xs sm:max-w-md mx-auto leading-relaxed break-words whitespace-pre-wrap\">\n                        {agentResponse}\n                        {isStreamingText && (\n                          <span className=\"inline-block w-2 h-4 bg-white/60 ml-1 animate-pulse\"></span>\n                        )}\n                      </p>\n                    </div>\n                    \n                    {/* Audio wave visualization for speaking state */}\n                    {voiceState === 'speaking' && (\n                      <div className=\"flex justify-center items-center gap-1 mt-4\">\n                        {[...Array(5)].map((_, i) => (\n                          <div\n                            key={i}\n                            className=\"w-1 bg-green-400 rounded-full audio-wave-bar\"\n                            style={{\n                              height: '20px',\n                              animationDelay: `${i * 0.1}s`\n                            }}\n                          />\n                        ))}\n                      </div>\n                    )}\n                  </div>\n                )}\n                \n                \n              </div>\n\n              {/* Bottom control buttons - Mobile optimized */}\n              <div \n                className=\"absolute bottom-6 sm:bottom-8 md:bottom-12 left-1/2 transform -translate-x-1/2 flex flex-col items-center gap-4 px-4\"\n                style={{ pointerEvents: 'auto', zIndex: 10000 }}\n              >\n                {/* API Key error warning */}\n                {(() => {\n                  const deploymentMode = localStorage.getItem('customgpt.deploymentMode') || 'production';\n                  const showWarning = deploymentMode === 'demo' ? !openAIApiKey : false;\n                  if (!showWarning) return null;\n                  \n                  return (\n                    <div className=\"bg-red-500/20 backdrop-blur-sm rounded-lg px-4 py-3 text-red-300 text-sm flex items-center gap-2 border border-red-500/30 max-w-xs\">\n                      <AlertTriangle className=\"w-4 h-4 flex-shrink-0\" />\n                      <span>Voice requires OpenAI API key. Add it in demo settings.</span>\n                    </div>\n                  );\n                })()}\n                \n                {/* Main voice control button */}\n                <div className=\"flex items-center justify-center\">\n                  {/* Recording/Listening State */}\n                  {(isManualRecording || voiceState === 'listening') && (\n                    <button\n                      onClick={isManualRecording ? handleManualRecording : handleToggleListening}\n                      className=\"relative w-20 h-20 sm:w-24 sm:h-24 rounded-full bg-red-500/20 hover:bg-red-500/30 active:bg-red-500/40 backdrop-blur-sm transition-all transform active:scale-95 pointer-events-auto shadow-lg border-2 border-red-500/50\"\n                      style={{ pointerEvents: 'auto' }}\n                      aria-label={isManualRecording ? \"Stop recording\" : \"Stop listening\"}\n                    >\n                      {/* Pulsing animation ring */}\n                      <div className=\"absolute inset-0 rounded-full bg-red-500/30 animate-ping\"></div>\n                      \n                      {/* Inner button content */}\n                      <div className=\"relative z-10 w-full h-full flex items-center justify-center\">\n                        <div className=\"w-6 h-6 sm:w-8 sm:h-8 bg-red-500 rounded-sm\"></div>\n                      </div>\n                    </button>\n                  )}\n\n                  {/* Processing State */}\n                  {voiceState === 'processing' && (\n                    <button\n                      disabled\n                      className=\"relative w-20 h-20 sm:w-24 sm:h-24 rounded-full bg-purple-500/20 backdrop-blur-sm shadow-lg border-2 border-purple-500/50\"\n                      aria-label=\"Processing\"\n                    >\n                      {/* Processing animation */}\n                      <div className=\"absolute inset-3 border-4 border-purple-500/30 border-t-purple-500 rounded-full animate-spin\"></div>\n                      <div className=\"absolute inset-6 border-2 border-purple-500/20 border-t-purple-500/60 rounded-full animate-spin\" style={{ animationDirection: 'reverse', animationDuration: '1.5s' }}></div>\n                    </button>\n                  )}\n\n                  {/* Speaking State - Stop button */}\n                  {voiceState === 'speaking' && (\n                    <button\n                      onClick={handleStopSpeech}\n                      className=\"relative w-20 h-20 sm:w-24 sm:h-24 rounded-full bg-orange-500/20 hover:bg-orange-500/30 active:bg-orange-500/40 backdrop-blur-sm transition-all transform active:scale-95 pointer-events-auto shadow-lg border-2 border-orange-500/50\"\n                      style={{ pointerEvents: 'auto' }}\n                      aria-label=\"Stop response\"\n                    >\n                      {/* Sound wave animation */}\n                      <div className=\"absolute inset-0 rounded-full\">\n                        {[...Array(3)].map((_, i) => (\n                          <div\n                            key={i}\n                            className=\"absolute inset-0 rounded-full border border-orange-500/30 animate-ping\"\n                            style={{\n                              animationDelay: `${i * 0.2}s`,\n                              animationDuration: '1.5s'\n                            }}\n                          />\n                        ))}\n                      </div>\n                      \n                      <div className=\"relative z-10 w-full h-full flex items-center justify-center\">\n                        <StopCircle className=\"w-8 h-8 sm:w-10 sm:h-10 text-orange-500\" />\n                      </div>\n                    </button>\n                  )}\n\n                  {/* Idle State - Start button */}\n                  {!vad.loading && !isManualRecording && voiceState !== 'speaking' && voiceState !== 'listening' && voiceState !== 'processing' && (\n                    <button\n                      onClick={vad.errored ? handleManualRecording : handleToggleListening}\n                      disabled={(() => {\n                        const deploymentMode = localStorage.getItem('customgpt.deploymentMode') || 'production';\n                        return deploymentMode === 'demo' && !openAIApiKey;\n                      })()}\n                      className={`relative w-20 h-20 sm:w-24 sm:h-24 rounded-full backdrop-blur-sm transition-all transform shadow-lg border-2 ${\n                        (() => {\n                          const deploymentMode = localStorage.getItem('customgpt.deploymentMode') || 'production';\n                          return deploymentMode === 'demo' && !openAIApiKey;\n                        })() \n                          ? 'bg-gray-500/20 border-gray-500/50 cursor-not-allowed opacity-50' \n                          : 'bg-blue-500/20 hover:bg-blue-500/30 active:bg-blue-500/40 hover:scale-105 active:scale-95 pointer-events-auto border-blue-500/50'\n                      }`}\n                      style={{ pointerEvents: 'auto' }}\n                      aria-label={(() => {\n                        const deploymentMode = localStorage.getItem('customgpt.deploymentMode') || 'production';\n                        return deploymentMode === 'demo' && !openAIApiKey ? \"Voice disabled - API key required\" : \"Start voice chat\";\n                      })()}\n                    >\n                      {/* Subtle glow effect */}\n                      <div className=\"absolute inset-0 rounded-full bg-blue-500/10 blur-sm\"></div>\n                      \n                      <div className=\"relative z-10 w-full h-full flex items-center justify-center\">\n                        <Mic className={`w-8 h-8 sm:w-10 sm:h-10 ${\n                          (() => {\n                            const deploymentMode = localStorage.getItem('customgpt.deploymentMode') || 'production';\n                            return deploymentMode === 'demo' && !openAIApiKey ? 'text-gray-500' : 'text-blue-500';\n                          })()\n                        }`} />\n                      </div>\n                    </button>\n                  )}\n\n                  {/* Loading State */}\n                  {vad.loading && (\n                    <button\n                      disabled\n                      className=\"relative w-20 h-20 sm:w-24 sm:h-24 rounded-full bg-gray-500/20 backdrop-blur-sm shadow-lg border-2 border-gray-500/50\"\n                      aria-label=\"Loading\"\n                    >\n                      <div className=\"absolute inset-4 border-3 border-gray-500/30 border-t-gray-500 rounded-full animate-spin\"></div>\n                    </button>\n                  )}\n                </div>\n\n                {/* State indicator text (subtle) */}\n                <div className=\"text-xs text-white/60 text-center\">\n                  {(() => {\n                    const deploymentMode = localStorage.getItem('customgpt.deploymentMode') || 'production';\n                    return deploymentMode === 'demo' && !openAIApiKey ? 'API key required' : '';\n                  })() ||\n                   vad.loading ? 'Initializing...' :\n                   isManualRecording ? 'Tap to stop' :\n                   voiceState === 'listening' ? 'Listening...' :\n                   voiceState === 'processing' ? 'Processing...' :\n                   voiceState === 'speaking' ? 'Tap to stop' :\n                   'Tap to speak'}\n                </div>\n              </div>\n\n            </>\n          )}\n          </div>\n        </>\n      )}\n      \n      {/* Voice Settings Modal */}\n      <VoiceSettings \n        isOpen={isSettingsOpen} \n        onClose={() => setIsSettingsOpen(false)}\n        projectId={projectId}\n      />\n    </>\n  );\n}\n\n// Main component that conditionally renders the VAD component\nexport function VoiceModal(props: VoiceModalProps) {\n  const { setVoiceModalOpen } = useVoiceSettingsStore();\n  \n  // Ensure global state is synchronized with props\n  React.useEffect(() => {\n    setVoiceModalOpen(props.isOpen);\n  }, [props.isOpen, setVoiceModalOpen]);\n  \n  // Only render the content (and initialize VAD) when modal is open\n  if (!props.isOpen) {\n    return null;\n  }\n  \n  return <VoiceModalContent {...props} />;\n}","/**\n * Input Component\n * \n * Reusable input field component with consistent styling.\n * Supports all standard HTML input attributes and types.\n * \n * Features:\n * - Consistent height and padding\n * - Focus ring for accessibility\n * - Disabled state styling\n * - Placeholder text styling\n * - File input support\n * - Full width by default\n * - Brand color focus ring\n * \n * Styling:\n * - Gray border in default state\n * - Brand color focus ring\n * - Smooth transitions\n * - Disabled opacity\n * - Custom file input styling\n * \n * Usage:\n * <Input type=\"text\" placeholder=\"Enter text...\" />\n * <Input type=\"email\" required />\n * <Input type=\"file\" accept=\"image/*\" />\n * <Input disabled value=\"Disabled input\" />\n * \n * Features:\n * - Professional error state handling with validation styling\n * - Input group functionality for complex form layouts\n * - Multiple size variants for different interface needs\n * - Icon integration with flexible left/right positioning\n * - Advanced features including floating labels and input masking\n */\n\nimport * as React from \"react\"\n\nimport { cn } from \"@/lib/utils\"\n\n/**\n * Input component props\n * Extends all standard HTML input attributes\n */\nexport interface InputProps\n  extends React.InputHTMLAttributes<HTMLInputElement> {\n  error?: boolean;\n  icon?: React.ReactNode;\n  iconPosition?: 'left' | 'right';\n  loading?: boolean;\n}\n\n/**\n * Input Component\n * \n * Forward ref component for proper ref handling.\n * Applies consistent styling to all input types.\n */\nconst Input = React.forwardRef<HTMLInputElement, InputProps>(\n  ({ \n    className, \n    type,\n    error = false,\n    icon,\n    iconPosition = 'left',\n    loading = false,\n    ...props \n  }, ref) => {\n    // Enhanced input with wrapper for icon support\n    const inputElement = (\n      <input\n        type={type}\n        className={cn(\n          // Enhanced base styles\n          \"flex h-11 w-full rounded-lg bg-background text-sm text-foreground\",\n          \"transition-all duration-200 ease-out\",\n          \n          // Border and background\n          \"border border-input\",\n          \"hover:border-primary/30\",\n          \n          // Padding adjustments for icons\n          icon && iconPosition === 'left' ? 'pl-10 pr-3' : 'px-3.5',\n          icon && iconPosition === 'right' ? 'pr-10 pl-3' : 'px-3.5',\n          \n          // Enhanced focus styles\n          \"focus:outline-none focus:ring-2 focus:ring-primary/20 focus:border-primary\",\n          \"focus:bg-primary/5\",\n          \n          // Error state\n          error && [\n            \"border-destructive/50 text-destructive\",\n            \"focus:ring-destructive/20 focus:border-destructive\",\n            \"placeholder:text-destructive/50\",\n          ],\n          \n          // File input styles\n          \"file:border-0 file:bg-transparent file:text-sm file:font-medium file:text-foreground\",\n          \"file:mr-3 file:py-1 file:px-3 file:rounded-md\",\n          \"file:hover:bg-accent file:cursor-pointer\",\n          \n          // Placeholder styles\n          \"placeholder:text-muted-foreground placeholder:transition-opacity\",\n          \"focus:placeholder:opacity-60\",\n          \n          // Disabled styles\n          \"disabled:cursor-not-allowed disabled:opacity-50 disabled:bg-muted/50\",\n          \n          // Loading state\n          loading && \"cursor-wait\",\n          \n          // Custom classes\n          className\n        )}\n        ref={ref}\n        disabled={loading || props.disabled}\n        {...props}\n      />\n    );\n    \n    // Return input with icon wrapper if icon provided\n    if (icon || loading) {\n      return (\n        <div className=\"relative\">\n          {inputElement}\n          \n          {/* Icon */}\n          {icon && !loading && (\n            <span className={cn(\n              \"absolute top-1/2 -translate-y-1/2 text-muted-foreground pointer-events-none\",\n              \"transition-colors duration-200\",\n              iconPosition === 'left' ? 'left-3' : 'right-3',\n              error && \"text-destructive\"\n            )}>\n              {icon}\n            </span>\n          )}\n          \n          {/* Loading spinner */}\n          {loading && (\n            <span className=\"absolute right-3 top-1/2 -translate-y-1/2\">\n              <svg\n                className=\"animate-spin h-4 w-4 text-muted-foreground\"\n                xmlns=\"http://www.w3.org/2000/svg\"\n                fill=\"none\"\n                viewBox=\"0 0 24 24\"\n              >\n                <circle\n                  className=\"opacity-25\"\n                  cx=\"12\"\n                  cy=\"12\"\n                  r=\"10\"\n                  stroke=\"currentColor\"\n                  strokeWidth=\"4\"\n                />\n                <path\n                  className=\"opacity-75\"\n                  fill=\"currentColor\"\n                  d=\"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z\"\n                />\n              </svg>\n            </span>\n          )}\n        </div>\n      );\n    }\n    \n    return inputElement;\n  }\n)\nInput.displayName = \"Input\"\n\nexport { Input }","/**\n * Card Component Set\n * \n * Flexible card components for content containers.\n * Provides consistent styling for grouped content.\n * \n * Components:\n * - Card: Main container with border and shadow\n * - CardHeader: Header section with padding\n * - CardTitle: Title text with typography\n * - CardContent: Body content with padding\n * \n * Features:\n * - Rounded corners\n * - Subtle shadow\n * - Gray border\n * - White background\n * - Consistent padding\n * - Composable structure\n * \n * Usage:\n * <Card>\n *   <CardHeader>\n *     <CardTitle>Card Title</CardTitle>\n *   </CardHeader>\n *   <CardContent>\n *     Card content goes here\n *   </CardContent>\n * </Card>\n * \n * Features:\n * - Complete card component system with footer and description support\n * - Multiple card variants including outlined, elevated, and flat styles\n * - Interactive hover effects and clickable card functionality\n * - Loading states and skeleton components for better UX\n * - Card grid layouts and group organization\n */\n\nimport React from 'react';\nimport { cn } from '@/lib/utils';\n\n/**\n * Card component props\n * Extends standard div attributes\n */\ninterface CardProps extends React.HTMLAttributes<HTMLDivElement> {\n  children: React.ReactNode;\n  variant?: 'default' | 'elevated' | 'bordered' | 'glass';\n  interactive?: boolean;\n}\n\n/**\n * Card Component\n * \n * Main container component with border and shadow.\n * Use as wrapper for card content sections.\n */\nexport const Card: React.FC<CardProps> = ({ \n  className, \n  children,\n  variant = 'default',\n  interactive = false,\n  ...props \n}) => {\n  const variantStyles = {\n    default: 'border border-border bg-card shadow-sm',\n    elevated: 'bg-card shadow-md hover:shadow-lg transition-shadow duration-300',\n    bordered: 'border-2 border-border bg-card hover:border-primary/20 transition-colors duration-200',\n    glass: 'backdrop-blur-md bg-card/50 border border-white/10 shadow-lg',\n  };\n  \n  return (\n    <div\n      className={cn(\n        'rounded-xl text-card-foreground transition-all duration-200',\n        variantStyles[variant],\n        interactive && [\n          'cursor-pointer',\n          'hover:scale-[1.01]',\n          'hover:shadow-lg',\n          'active:scale-[0.99]',\n        ],\n        className\n      )}\n      {...props}\n    >\n      {children}\n    </div>\n  );\n};\n\n/**\n * Card Header Component\n * \n * Header section with consistent padding.\n * Typically contains CardTitle and description.\n */\nexport const CardHeader: React.FC<CardProps> = ({\n  className,\n  children,\n  ...props\n}) => {\n  return (\n    <div\n      className={cn(\n        'flex flex-col space-y-2 p-6 pb-4',\n        'border-b border-border/50',\n        className\n      )}\n      {...props}\n    >\n      {children}\n    </div>\n  );\n};\n\n/**\n * Card Title Component\n * \n * Title text with proper typography.\n * Renders as h3 element for semantic HTML.\n */\nexport const CardTitle: React.FC<CardProps> = ({\n  className,\n  children,\n  ...props\n}) => {\n  return (\n    <h3\n      className={cn(\n        'text-xl font-semibold leading-tight tracking-tight',\n        'text-foreground',\n        className\n      )}\n      {...props}\n    >\n      {children}\n    </h3>\n  );\n};\n\n/**\n * Card Content Component\n * \n * Body content section with padding.\n * Negative top padding assumes usage after CardHeader.\n */\nexport const CardContent: React.FC<CardProps> = ({\n  className,\n  children,\n  ...props\n}) => {\n  return (\n    <div \n      className={cn(\n        'p-6 pt-5',\n        'text-muted-foreground',\n        className\n      )} \n      {...props}\n    >\n      {children}\n    </div>\n  );\n};\n\n/**\n * Card Description Component\n * \n * Description text for card headers.\n * Typically used within CardHeader after CardTitle.\n */\nexport const CardDescription: React.FC<CardProps> = ({\n  className,\n  children,\n  ...props\n}) => {\n  return (\n    <p\n      className={cn(\n        'text-sm text-muted-foreground',\n        className\n      )}\n      {...props}\n    >\n      {children}\n    </p>\n  );\n};\n\n/**\n * Card Footer Component\n * \n * Footer section for action buttons or metadata.\n * Includes top border and consistent padding.\n */\nexport const CardFooter: React.FC<CardProps> = ({\n  className,\n  children,\n  ...props\n}) => {\n  return (\n    <div\n      className={cn(\n        'flex items-center justify-between p-6 pt-4',\n        'border-t border-border/50',\n        className\n      )}\n      {...props}\n    >\n      {children}\n    </div>\n  );\n};","/**\n * Free Trial Limit Modal Component\n * \n * Modal shown when users hit free trial limitations.\n * Encourages them to add their own API key to continue using the app.\n * Displayed after a toast notification with a 3-second delay.\n */\n\n'use client';\n\nimport React, { useState } from 'react';\nimport { \n  AlertTriangle, \n  Key, \n  ExternalLink,\n  Eye,\n  EyeOff,\n  X,\n  Clock,\n  MessageSquare,\n  Zap\n} from 'lucide-react';\nimport { Button } from '@/components/ui/button';\nimport { Input } from '@/components/ui/input';\nimport { Card } from '@/components/ui/card';\nimport { cn } from '@/lib/utils';\nimport { useDemoStore } from '@/store/demo';\nimport { useBreakpoint } from '@/hooks/useMediaQuery';\nimport { FREE_TRIAL_LIMITS, DEMO_STORAGE_KEYS } from '@/lib/constants/demo-limits';\nimport { usageTracker } from '@/lib/analytics/usage-tracker';\n\ninterface FreeTrialLimitModalProps {\n  onClose?: () => void;\n}\n\nexport function FreeTrialLimitModal({ onClose }: FreeTrialLimitModalProps) {\n  const { setApiKey } = useDemoStore();\n  const [apiKeyInput, setApiKeyInput] = useState('');\n  const [showApiKey, setShowApiKey] = useState(false);\n  const [error, setError] = useState<string | null>(null);\n  const [isValidating, setIsValidating] = useState(false);\n  const { isMobile } = useBreakpoint();\n  \n  const handleSubmit = async (e: React.FormEvent) => {\n    e.preventDefault();\n    \n    // Check if API key is empty\n    if (!apiKeyInput.trim()) {\n      setError('Please provide your API Key');\n      return;\n    }\n    \n    setIsValidating(true);\n    setError(null);\n    \n    // First, validate the API key by making a test request\n    try {\n      // Test the API key by fetching projects\n      const response = await fetch('/api/proxy/projects', {\n        headers: {\n          'X-CustomGPT-API-Key': apiKeyInput.trim(),\n          'X-Deployment-Mode': 'demo'\n        }\n      });\n      \n      if (!response.ok) {\n        if (response.status === 401 || response.status === 403) {\n          setError('Invalid API key. Please check your key and try again.');\n        } else {\n          setError('Failed to validate API key. Please try again.');\n        }\n        \n        setIsValidating(false);\n        return;\n      }\n      \n      // API key is valid, proceed with setup\n      // Track user API key demo start\n      usageTracker.track({\n        eventType: 'session_start',\n        eventName: 'api_key_added_from_limit_modal',\n        metadata: {\n          source: 'free_trial_limit_modal'\n        }\n      });\n      \n      // Clear free trial mode flag when switching to API key mode\n      localStorage.removeItem(DEMO_STORAGE_KEYS.FREE_TRIAL_MODE);\n      sessionStorage.removeItem(DEMO_STORAGE_KEYS.FREE_TRIAL_SESSION);\n      sessionStorage.removeItem('customgpt.captchaVerified');\n      \n      // Set up demo mode with API key\n      localStorage.setItem(DEMO_STORAGE_KEYS.DEPLOYMENT_MODE, 'demo');\n      \n      // Create demo session for 120 minutes\n      const demoSessionData = {\n        startTime: Date.now(),\n        sessionId: `demo_${Date.now()}_${Math.random().toString(36).substring(7)}`\n      };\n      sessionStorage.setItem(DEMO_STORAGE_KEYS.DEMO_SESSION, JSON.stringify(demoSessionData));\n      \n      setApiKey(apiKeyInput);\n      \n      setTimeout(() => {\n        window.location.href = window.location.href;\n      }, 100);\n    } catch (error) {\n      console.error('[FreeTrialLimitModal] Error validating API key:', error);\n      setError('Failed to validate API key. Please check your connection and try again.');\n      setIsValidating(false);\n    }\n  };\n  \n  return (\n    <div>\n      {/* Background Overlay - prevents clicks on background UI */}\n      <div \n        className=\"fixed inset-0 bg-black/50 backdrop-blur-sm z-40\" \n        onClick={onClose}\n      />\n      \n      {/* Modal */}\n      <div className=\"fixed inset-0 flex items-center justify-center p-4 z-50\">\n        <div className={cn(\n          \"bg-white dark:bg-gray-900 rounded-lg shadow-xl\",\n          isMobile ? \"w-full max-w-md\" : \"w-full max-w-lg\"\n        )}>\n          {/* Modal Header */}\n          <div className=\"sticky top-0 bg-white dark:bg-gray-900 border-b border-gray-200 dark:border-gray-800 px-6 py-4\">\n            <div className=\"flex items-center justify-between\">\n              <div className=\"flex items-start gap-3\">\n                <div className=\"p-2 bg-amber-100 dark:bg-amber-900/50 rounded-lg\">\n                  <AlertTriangle className=\"h-5 w-5 text-amber-600 dark:text-amber-400\" />\n                </div>\n                <div>\n                  <h2 className=\"text-xl font-bold text-gray-900 dark:text-gray-100\">\n                    Free Trial Limit Reached\n                  </h2>\n                  <p className=\"text-sm text-gray-600 dark:text-gray-400 mt-1\">\n                    You&apos;ve reached the limits of the free trial\n                  </p>\n                </div>\n              </div>\n              {onClose && (\n                <Button\n                  variant=\"ghost\"\n                  size=\"icon\"\n                  onClick={onClose}\n                  className=\"text-gray-400 hover:text-gray-600\"\n                >\n                  <X className=\"h-5 w-5\" />\n                </Button>\n              )}\n            </div>\n          </div>\n          \n          {/* Modal Content */}\n          <div className=\"p-6\">\n            {/* Free Trial Limits Info */}\n            <div className=\"mb-6 p-4 bg-amber-50 dark:bg-amber-950/20 border border-amber-200 dark:border-amber-800 rounded-lg\">\n              <h3 className=\"font-medium text-amber-900 dark:text-amber-100 mb-2\">\n                Free Trial Limitations:\n              </h3>\n              <div className=\"space-y-1 text-sm text-amber-800 dark:text-amber-200\">\n                <div className=\"flex items-center gap-2\">\n                  <MessageSquare className=\"h-4 w-4\" />\n                  <span>{FREE_TRIAL_LIMITS.MAX_MESSAGES_PER_CONVERSATION} messages per conversation</span>\n                </div>\n                <div className=\"flex items-center gap-2\">\n                  <Clock className=\"h-4 w-4\" />\n                  <span>{FREE_TRIAL_LIMITS.SESSION_DURATION / 60000} minute sessions</span>\n                </div>\n              </div>\n            </div>\n            \n            {/* API Key Form */}\n            <Card className=\"p-6\">\n              <form onSubmit={handleSubmit} className=\"space-y-4\">\n                <div className=\"flex items-start gap-3 mb-4\">\n                  <div className=\"p-2 bg-green-100 dark:bg-green-900/50 rounded-lg\">\n                    <Key className=\"h-5 w-5 text-green-600 dark:text-green-400\" />\n                  </div>\n                  <div className=\"flex-1\">\n                    <h3 className=\"font-semibold text-gray-900 dark:text-gray-100\">\n                      Continue with Your API Key\n                    </h3>\n                    <p className=\"text-sm text-gray-600 dark:text-gray-400 mt-1\">\n                      Add your CustomGPT API key to remove all limitations\n                    </p>\n                  </div>\n                </div>\n                \n                {/* API Key Input */}\n                <div className=\"space-y-3\">\n                  <label htmlFor=\"apiKey\" className=\"block text-sm font-medium text-gray-700 dark:text-gray-300\">\n                    CustomGPT API Key\n                  </label>\n                  <div className=\"relative\">\n                    <Input\n                      id=\"apiKey\"\n                      type={showApiKey ? 'text' : 'password'}\n                      value={apiKeyInput}\n                      onChange={(e) => {\n                        setApiKeyInput(e.target.value);\n                        setError(null);\n                      }}\n                      placeholder=\"Enter your API key...\"\n                      className={cn(\n                        \"pr-10\",\n                        error && \"border-red-500 focus:ring-red-500\"\n                      )}\n                    />\n                    <button\n                      type=\"button\"\n                      onClick={() => setShowApiKey(!showApiKey)}\n                      className=\"absolute right-2 top-1/2 -translate-y-1/2 p-2 text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200\"\n                    >\n                      {showApiKey ? <EyeOff className=\"h-4 w-4\" /> : <Eye className=\"h-4 w-4\" />}\n                    </button>\n                  </div>\n                  {error && (\n                    <p className=\"text-sm text-red-600 dark:text-red-400\">{error}</p>\n                  )}\n                  <p className=\"text-xs text-gray-500 dark:text-gray-400\">\n                    Don&apos;t have an API key?{' '}\n                    <a \n                      href=\"https://app.customgpt.ai/\" \n                      target=\"_blank\" \n                      rel=\"noopener noreferrer\"\n                      className=\"text-blue-600 dark:text-blue-400 hover:underline inline-flex items-center gap-1\"\n                    >\n                      Get one from CustomGPT.ai\n                      <ExternalLink className=\"h-3 w-3\" />\n                    </a>\n                  </p>\n                </div>\n                \n                <Button \n                  type=\"submit\" \n                  className=\"w-full\"\n                  size=\"lg\"\n                  disabled={isValidating}\n                >\n                  <Zap className=\"h-4 w-4 mr-2\" />\n                  {isValidating ? 'Validating...' : 'Continue with Full Access'}\n                </Button>\n              </form>\n            </Card>\n            \n            {/* Benefits of adding API key */}\n            <div className=\"mt-4 text-center text-sm text-gray-600 dark:text-gray-400\">\n              <p className=\"font-medium mb-1\">With your API key you get:</p>\n              <ul className=\"space-y-1\">\n                <li> Unlimited messages</li>\n                <li> All your CustomGPT projects</li>\n                <li> No session time limits</li>\n                <li> Full feature access</li>\n              </ul>\n            </div>\n          </div>\n        </div>\n      </div>\n    </div>\n  );\n}","/**\n * ChatContainer Component\n * \n * Main chat interface component that manages the entire chat experience.\n * This is the primary component for integrating CustomGPT chat functionality.\n * \n * Features:\n * - Message display with streaming support\n * - Agent selection and switching\n * - Citation handling with modal details\n * - Multiple deployment modes (standalone, widget, floating)\n * - Welcome screen with example prompts\n * - Error handling and authorization checks\n * \n * For customization:\n * - Example questions are now fetched from agent settings API\n * - Modify DEFAULT_EXAMPLE_PROMPTS for fallback starter questions\n * - Customize WelcomeMessage for branding\n * - Adjust ChatHeader for different layouts\n * - Style using Tailwind classes throughout\n */\n\n'use client';\n\nimport React, { useEffect, useRef, useState } from 'react';\nimport { motion } from 'framer-motion';\nimport { Sparkles, Bot } from 'lucide-react';\nimport Link from 'next/link';\nimport { toast } from 'sonner';\n\nimport type { ChatMessage, Citation, Agent } from '@/types';\nimport { cn } from '@/lib/utils';\nimport { Message } from './Message';\nimport { ChatInput } from './ChatInput';\nimport { TypingIndicator } from './TypingIndicator';\nimport { AgentSelector } from './AgentSelector';\nimport { CitationDetailsModal } from './CitationDetailsModal';\nimport { CitationFilePreview } from './CitationFilePreview';\nimport { ConversationManager } from './ConversationManager';\nimport { MessageErrorDisplay } from './MessageErrorDisplay';\nimport { logger } from '@/lib/logger';\nimport { useWidgetSafe } from '@/widget/WidgetContext';\nimport { useMessageStore, useConversationStore, useAgentStore } from '@/hooks/useWidgetStore';\nimport { MessageSkeleton, LoadingOverlay } from '@/components/ui/loading';\nimport { getClient } from '@/lib/api/client';\nimport { VoiceModal } from '@/components/voice/VoiceModal';\nimport { useBreakpoint } from '@/hooks/useMediaQuery';\nimport { useDemoStore } from '@/store/demo';\nimport { FreeTrialLimitModal } from '@/components/demo/FreeTrialLimitModal';\n\n/**\n * Default example prompts shown to users when starting a new conversation\n * These are used as fallback when API-sourced example questions are not available\n */\nconst DEFAULT_EXAMPLE_PROMPTS = [\n  \"What can you help me with?\",\n  \"Explain this document\", \n  \"Summarize key points\",\n  \"Answer my questions\",\n];\n\ninterface ExamplePromptCardProps {\n  /** The prompt text to display */\n  prompt: string;\n  /** Handler called when the prompt is clicked */\n  onClick: (prompt: string) => void;\n}\n\n/**\n * ExamplePromptCard Component\n * \n * Clickable card showing an example prompt that users can select\n * to quickly start a conversation\n */\nconst ExamplePromptCard: React.FC<ExamplePromptCardProps> = ({ prompt, onClick }) => {\n  return (\n    <button\n      onClick={() => onClick(prompt)}\n      className={cn(\n        \"text-left bg-card border border-border rounded-lg\",\n        \"hover:border-accent hover:shadow-sm transition-all\",\n        \"text-card-foreground\",\n        \"p-2.5\",\n        \"text-xs\",\n        \"min-h-[50px] flex items-center\",\n        \"w-full\" // Ensures button takes full width of grid cell\n      )}\n    >\n      {prompt}\n    </button>\n  );\n};\n\ninterface WelcomeMessageProps {\n  /** Handler called when an example prompt is clicked */\n  onPromptClick: (prompt: string) => void;\n}\n\n/**\n * WelcomeMessage Component\n * \n * Displays a welcome screen when no messages exist in the conversation.\n * Shows the agent name, welcome text, and example prompts.\n * Fetches agent-specific example questions from API with fallback to defaults.\n * Uses Framer Motion for smooth animations.\n */\nconst WelcomeMessage: React.FC<WelcomeMessageProps> = ({ onPromptClick }) => {\n  const { currentAgent } = useAgentStore();\n  const [exampleQuestions, setExampleQuestions] = useState<string[]>(DEFAULT_EXAMPLE_PROMPTS);\n  const [loading, setLoading] = useState(false);\n  \n  /**\n   * Fetch agent settings to get custom example questions\n   */\n  useEffect(() => {\n    const fetchExampleQuestions = async () => {\n      if (!currentAgent) {\n        return;\n      }\n\n      // If we already have example questions from settings, use them\n      if (currentAgent.settings?.example_questions && currentAgent.settings.example_questions.length > 0) {\n        setExampleQuestions(currentAgent.settings.example_questions);\n        return;\n      }\n\n      setLoading(true);\n      try {\n        const client = getClient();\n        const response = await client.getAgentSettings(currentAgent.id);\n        const settings = response.data || response;\n        \n        // Use API example questions if available, otherwise keep defaults\n        if (settings.example_questions && settings.example_questions.length > 0) {\n          setExampleQuestions(settings.example_questions);\n          \n          logger.info('UI', 'Loaded custom example questions from API', {\n            agentId: currentAgent.id,\n            questionCount: settings.example_questions.length\n          });\n        } else {\n          logger.info('UI', 'No custom example questions found, using defaults', {\n            agentId: currentAgent.id\n          });\n        }\n      } catch (error) {\n        logger.warn('UI', 'Failed to load agent settings for example questions', {\n          agentId: currentAgent.id,\n          error: error instanceof Error ? error.message : String(error)\n        });\n        // Keep default questions on error\n      } finally {\n        setLoading(false);\n      }\n    };\n\n    fetchExampleQuestions();\n  }, [currentAgent]);\n  \n  return (\n    <div className={cn(\n      \"flex flex-col items-center justify-center h-full py-8\",\n      \"px-4 md:px-8\"\n    )}>\n      <motion.div\n        initial={{ opacity: 0, y: 20 }}\n        animate={{ opacity: 1, y: 0 }}\n        transition={{ duration: 0.5 }}\n        className={cn(\n          \"text-center w-full\",\n          \"max-w-sm sm:max-w-md md:max-w-lg\"\n        )}\n      >\n        {/* Agent Avatar */}\n        <div className=\"w-16 h-16 rounded-full flex items-center justify-center mb-6 mx-auto overflow-hidden bg-accent\">\n          {currentAgent?.settings?.chatbot_avatar ? (\n            <img \n              src={currentAgent.settings.chatbot_avatar} \n              alt={`${currentAgent.project_name} avatar`} \n              className=\"w-16 h-16 rounded-full object-cover\"\n            />\n          ) : (\n            <Bot className=\"w-8 h-8 text-muted-foreground\" />\n          )}\n        </div>\n        \n        {/* Welcome Text */}\n        <h3 className={cn(\n          \"font-semibold text-foreground mb-2\",\n          \"text-lg sm:text-xl md:text-2xl\"\n        )}>\n          Welcome to {currentAgent?.project_name || 'CustomGPT'}!\n        </h3>\n        <p className={cn(\n          \"text-muted-foreground mb-6 sm:mb-8\",\n          \"text-sm sm:text-base\"\n        )}>\n          I&apos;m here to help answer your questions and assist with your tasks. How can I help you today?\n        </p>\n        \n        {/* Example Prompts */}\n        <div className={cn(\n          \"grid gap-2 sm:gap-3 w-full\",\n          \"grid-cols-2\",\n          \"max-w-full sm:max-w-md md:max-w-lg\",\n          \"auto-cols-fr\" // Ensures equal column widths\n        )}>\n          {exampleQuestions.map((prompt, idx) => (\n            <motion.div\n              key={`${currentAgent?.id}-${idx}`} // Include agent ID to force re-render on agent change\n              initial={{ opacity: 0, y: 20 }}\n              animate={{ opacity: 1, y: 0 }}\n              transition={{ duration: 0.3, delay: 0.1 + (idx * 0.1) }}\n            >\n              <ExamplePromptCard\n                prompt={prompt}\n                onClick={onPromptClick}\n              />\n            </motion.div>\n          ))}\n        </div>\n        \n        {/* Loading indicator for example questions */}\n        {loading && (\n          <motion.div\n            initial={{ opacity: 0 }}\n            animate={{ opacity: 1 }}\n            className=\"mt-4\"\n          >\n            <p className=\"text-xs text-muted-foreground\">Loading custom questions...</p>\n          </motion.div>\n        )}\n      </motion.div>\n    </div>\n  );\n};\n\ninterface MessageAreaProps {\n  /** Additional CSS classes for styling */\n  className?: string;\n  /** Deployment mode - affects behavior */\n  mode?: 'standalone' | 'widget' | 'floating';\n  /** Function to show free trial limit modal */\n  onShowFreeTrialLimitModal?: () => void;\n  /** Whether to show citations */\n  enableCitations?: boolean;\n}\n\n/**\n * MessageArea Component\n * \n * Scrollable area that displays all messages in the current conversation.\n * Handles:\n * - Message rendering with streaming support\n * - Auto-scrolling to latest messages\n * - Citation click handling\n * - Error display\n * - Welcome message when empty\n * - Loading states with typing indicator\n */\nconst MessageArea: React.FC<MessageAreaProps> = ({ className, mode = 'standalone', onShowFreeTrialLimitModal, enableCitations }) => {\n  const { \n    messages, \n    streamingMessage, \n    isStreaming,\n    error,\n    sendMessage,\n    updateMessageFeedback,\n    loading,\n    clearError,\n    setMessagesForConversation\n  } = useMessageStore();\n  const { currentConversation } = useConversationStore();\n  const { currentAgent } = useAgentStore();\n  const scrollRef = useRef<HTMLDivElement>(null);\n  const [isLoadingMessages, setIsLoadingMessages] = React.useState(false);\n  const [prevConversationId, setPrevConversationId] = React.useState<string | null>(null);\n  \n  // Citation modal state - tracks which citation is being viewed\n  const [selectedCitationId, setSelectedCitationId] = React.useState<number | string | null>(null);\n  const [citationModalOpen, setCitationModalOpen] = React.useState(false);\n  \n  // Citation preview state\n  const [previewCitationId, setPreviewCitationId] = React.useState<string | null>(null);\n  const [previewModalOpen, setPreviewModalOpen] = React.useState(false);\n  \n  // Check if we're in free trial mode by looking at localStorage\n  const [isFreeTrialMode, setIsFreeTrialMode] = React.useState(false);\n  \n  React.useEffect(() => {\n    if (typeof window !== 'undefined') {\n      const freeTrialFlag = localStorage.getItem('customgpt.freeTrialMode');\n      setIsFreeTrialMode(freeTrialFlag === 'true');\n    }\n  }, []);\n  \n  const conversationMessages = currentConversation \n    ? messages.get(currentConversation.id.toString()) || []\n    : [];\n    \n  // Debug logging for widget mode\n  useEffect(() => {\n    if (mode === 'widget' || mode === 'floating') {\n      console.log('[ChatContainer] Widget conversation state:', {\n        currentConversation: currentConversation,\n        conversationId: currentConversation?.id,\n        messageCount: conversationMessages.length,\n        messagesMapSize: messages.size,\n        messagesMapKeys: Array.from(messages.keys()),\n        isLoadingMessages,\n        loading\n      });\n    }\n  }, [currentConversation, conversationMessages, mode, messages, isLoadingMessages, loading]);\n  \n  // Detect conversation change\n  useEffect(() => {\n    if (currentConversation && currentConversation.id.toString() !== prevConversationId) {\n      setIsLoadingMessages(true);\n      setPrevConversationId(currentConversation.id.toString());\n      \n      // Set a timeout to hide loading after a reasonable time\n      const timeout = setTimeout(() => {\n        setIsLoadingMessages(false);\n      }, 1000);\n      \n      return () => clearTimeout(timeout);\n    }\n  }, [currentConversation, prevConversationId]);\n  \n  // Hide loading when messages arrive OR when message loading completes\n  useEffect(() => {\n    if (isLoadingMessages && (conversationMessages.length > 0 || !loading)) {\n      setIsLoadingMessages(false);\n    }\n  }, [conversationMessages, isLoadingMessages, loading]);\n  \n  /**\n   * Auto-scroll effect\n   * Automatically scrolls to the bottom when new messages arrive\n   * or when streaming messages are updated\n   * \n   * Uses instant scroll for conversation switches to avoid annoying\n   * scroll animations when clicking on past chats with many messages.\n   * Uses smooth scroll for new messages and streaming updates.\n   */\n  useEffect(() => {\n    if (scrollRef.current) {\n      // Use instant scroll when loading messages (conversation switch)\n      // Use smooth scroll for real-time message additions and streaming\n      const scrollBehavior = isLoadingMessages ? 'auto' : 'smooth';\n      \n      scrollRef.current.scrollTo({\n        top: scrollRef.current.scrollHeight,\n        behavior: scrollBehavior,\n      });\n    }\n  }, [conversationMessages, streamingMessage, isLoadingMessages]);\n  \n  const handleExamplePrompt = (prompt: string) => {\n    // Check if in free trial mode\n    if (isFreeTrialMode) {\n      toast.error('Free Trial Limitation', {\n        description: 'Sending messages is not available in free trial mode. Please use your own API key to send messages.',\n        duration: 5000,\n      });\n      // Show modal after 3 seconds\n      setTimeout(() => {\n        onShowFreeTrialLimitModal?.();\n      }, 3000);\n      return;\n    }\n    \n    logger.info('UI', 'Example prompt clicked', { prompt });\n    sendMessage(prompt);\n  };\n  \n  const handleCitationClick = (citation: Citation) => {\n    logger.info('UI', 'Citation clicked', {\n      citationId: citation.id,\n      citationIndex: citation.index,\n      citationTitle: citation.title\n    });\n    \n    // Open citation details modal with the citation ID\n    if (citation.id) {\n      setSelectedCitationId(citation.id);\n      setCitationModalOpen(true);\n    }\n  };\n  \n  const handlePreviewClick = (citation: Citation) => {\n    logger.info('UI', 'Citation preview requested', {\n      citationId: citation.id,\n      citationTitle: citation.title\n    });\n    \n    // Open preview modal with the citation ID\n    if (citation.id) {\n      setPreviewCitationId(citation.id);\n      setPreviewModalOpen(true);\n    }\n  };\n  \n  const handleMessageFeedback = async (messageId: string, feedback: 'like' | 'dislike') => {\n    logger.info('UI', 'Message feedback provided', {\n      messageId,\n      feedback\n    });\n    \n    // Call the message store to update feedback\n    await updateMessageFeedback(messageId, feedback);\n  };\n  \n  return (\n    <div\n      ref={scrollRef}\n      className={cn(\n        'flex-1 overflow-y-auto scroll-smooth',\n        'bg-gradient-to-b from-muted/50 to-background',\n        className\n      )}\n    >\n      {/* Error Message */}\n      {error && (\n        <div className=\"p-4 m-4\">\n          <MessageErrorDisplay \n            error={error}\n            onRetry={() => {\n              // Clear error first\n              clearError();\n              \n              // Then retry sending last message if applicable\n              if (currentConversation) {\n                const conversationMessages = messages.get(currentConversation.id.toString()) || [];\n                const lastUserMessage = conversationMessages\n                  .filter(m => m.role === 'user')\n                  .pop();\n                \n                if (lastUserMessage) {\n                  // Remove the error message before retrying\n                  const filteredMessages = conversationMessages.filter(m => m.id !== lastUserMessage.id);\n                  setMessagesForConversation(\n                    currentConversation.id.toString(), \n                    filteredMessages\n                  );\n                  \n                  // Retry sending the message\n                  sendMessage(lastUserMessage.content);\n                }\n              }\n            }}\n          />\n        </div>\n      )}\n\n      {/* Loading state when switching conversations */}\n      {isLoadingMessages && (\n        <LoadingOverlay \n          visible={true} \n          message={conversationMessages.length > 0 ? \"Loading conversation...\" : \"Switching to conversation...\"}\n          blur={true}\n        />\n      )}\n      \n      {/* Message skeleton fallback for empty conversations */}\n      {isLoadingMessages && conversationMessages.length === 0 && !isStreaming && (\n        <div className=\"space-y-0 opacity-30\">\n          <MessageSkeleton isAssistant={false} lines={2} />\n          <MessageSkeleton isAssistant={true} lines={3} />\n          <MessageSkeleton isAssistant={false} lines={1} />\n          <MessageSkeleton isAssistant={true} lines={4} />\n        </div>\n      )}\n\n      {/* Welcome Message */}\n      {conversationMessages.length === 0 && !streamingMessage && !error && !isLoadingMessages && (\n        <WelcomeMessage onPromptClick={handleExamplePrompt} />\n      )}\n      \n      {/* Messages */}\n      {conversationMessages.length > 0 && (\n        <div className=\"space-y-0\">\n          {conversationMessages.map((message, index) => (\n            <Message\n              key={message.id}\n              message={message}\n              agent={currentAgent}\n              isLast={index === conversationMessages.length - 1}\n              onCitationClick={handleCitationClick}\n              onPreviewClick={handlePreviewClick}\n              onFeedback={(feedback) => handleMessageFeedback(message.id, feedback)}\n              mode={mode}\n              enableCitations={enableCitations}\n            />\n          ))}\n        </div>\n      )}\n      \n      {/* Streaming Message */}\n      {streamingMessage && !conversationMessages.some(m => m.id === streamingMessage.id) && (\n        <Message\n          message={streamingMessage}\n          agent={currentAgent}\n          isStreaming={true}\n          isLast={true}\n          onCitationClick={handleCitationClick}\n          onPreviewClick={handlePreviewClick}\n          mode={mode}\n          enableCitations={enableCitations}\n        />\n      )}\n      \n      {/* Typing Indicator */}\n      {isStreaming && !streamingMessage && (\n        <TypingIndicator />\n      )}\n      \n      {/* Citation Details Modal */}\n      {selectedCitationId && (\n        <CitationDetailsModal\n          isOpen={citationModalOpen}\n          onClose={() => {\n            setCitationModalOpen(false);\n            setSelectedCitationId(null);\n          }}\n          citationId={selectedCitationId}\n          projectId={currentAgent?.id || 0}\n        />\n      )}\n      \n      {/* Citation File Preview Modal */}\n      {previewCitationId && (\n        <CitationFilePreview\n          isOpen={previewModalOpen}\n          onClose={() => {\n            setPreviewModalOpen(false);\n            setPreviewCitationId(null);\n          }}\n          citationId={previewCitationId}\n          fileName={`Citation_${previewCitationId}.txt`}\n        />\n      )}\n    </div>\n  );\n};\n\ninterface ChatHeaderProps {\n  /** Deployment mode affects header layout */\n  mode?: 'standalone' | 'widget' | 'floating';\n  /** Handler for close button (widget/floating modes) */\n  onClose?: () => void;\n  /** Handler for agent settings button */\n  onAgentSettings?: (agent: Agent) => void;\n  /** Enable conversation management UI */\n  enableConversationManagement?: boolean;\n  /** Maximum conversations per session */\n  maxConversations?: number;\n  /** Session ID for conversation isolation */\n  sessionId?: string;\n  /** Current conversation ID */\n  currentConversationId?: string;\n  /** Callback when conversation changes */\n  onConversationChange?: (conversation: any) => void;\n  /** Callback to create new conversation */\n  onCreateConversation?: () => void;\n  /** Key to trigger ConversationManager refresh */\n  conversationRefreshKey?: number;\n}\n\n/**\n * ChatHeader Component\n * \n * Header bar for the chat interface. Layout changes based on deployment mode:\n * - Standalone: Full header with agent selector\n * - Widget/Floating: Compact header with close button\n * \n * Shows agent status (online/offline) and provides agent switching\n */\nconst ChatHeader: React.FC<ChatHeaderProps> = ({ \n  mode = 'standalone', \n  onClose,\n  onAgentSettings,\n  enableConversationManagement = false,\n  maxConversations,\n  sessionId,\n  currentConversationId,\n  onConversationChange,\n  onCreateConversation,\n  conversationRefreshKey\n}) => {\n  const { currentAgent } = useAgentStore();\n  const { isMobile } = useBreakpoint();\n  \n  if (mode === 'widget' || mode === 'floating') {\n    return (\n      <header className=\"border-b border-border bg-background\">\n        {/* Header Content */}\n        <div className=\"flex items-center justify-between px-4 py-3\">\n          <div className=\"flex items-center gap-3 flex-1 min-w-0\">\n            <div className=\"w-8 h-8 rounded-lg flex items-center justify-center flex-shrink-0 overflow-hidden bg-accent\">\n              {currentAgent?.settings?.chatbot_avatar ? (\n                <img \n                  src={currentAgent.settings.chatbot_avatar} \n                  alt={`${currentAgent.project_name} avatar`} \n                  className=\"w-8 h-8 rounded-lg object-cover\"\n                />\n              ) : (\n                <Bot className=\"w-5 h-5 text-accent-foreground\" />\n              )}\n            </div>\n            <div className=\"min-w-0 flex-1\">\n              <h2 className=\"font-semibold text-foreground truncate\">\n                {currentAgent?.project_name || 'CustomGPT Assistant'}\n              </h2>\n              <p className=\"text-xs text-muted-foreground\">\n                {currentAgent?.is_chat_active ? 'Online' : 'Offline'}\n              </p>\n            </div>\n          </div>\n          \n          {onClose && (\n            <button\n              onClick={onClose}\n              className=\"p-1.5 rounded-lg hover:bg-accent hover:text-accent-foreground transition-colors flex-shrink-0\"\n            >\n              <span className=\"sr-only\">Close</span>\n              \n            </button>\n          )}\n        </div>\n      </header>\n    );\n  }\n  \n  // For standalone mode, show agent selector header (but not on mobile)\n  if (mode === 'standalone' && !isMobile) {\n    return (\n      <header className=\"flex items-center justify-between px-4 py-3 border-b border-border bg-background\">\n        <div className=\"flex items-center gap-3\">\n          <div className=\"w-8 h-8 rounded-lg bg-brand-500 flex items-center justify-center\">\n            <Bot className=\"w-5 h-5 text-white\" />\n          </div>\n          <h1 className=\"text-lg font-semibold text-foreground\">\n            Agent Chat\n          </h1>\n        </div>\n        \n        <div className=\"flex-1 max-w-xs ml-4\">\n          <AgentSelector\n            onSettingsClick={onAgentSettings}\n            className=\"w-full\"\n          />\n        </div>\n      </header>\n    );\n  }\n  \n  return null;\n};\n\ninterface ChatContainerProps {\n  /** Deployment mode - affects layout and styling */\n  mode?: 'standalone' | 'widget' | 'floating';\n  /** Additional CSS classes */\n  className?: string;\n  /** Handler for close button (widget/floating modes) */\n  onClose?: () => void;\n  /** Handler when agent settings are requested */\n  onAgentSettings?: (agent: Agent) => void;\n  /** Enable conversation management UI */\n  enableConversationManagement?: boolean;\n  /** Maximum conversations per session */\n  maxConversations?: number;\n  /** Session ID for conversation isolation */\n  sessionId?: string;\n  /** Specific conversation thread to load */\n  threadId?: string;\n  /** Callback when conversation changes */\n  onConversationChange?: (conversation: any) => void;\n  /** Callback when message is sent/received */\n  onMessage?: (message: any) => void;\n  /** Key to trigger ConversationManager refresh */\n  conversationRefreshKey?: number;\n  /** Mobile optimization mode */\n  isMobile?: boolean;\n  /** Whether to show citations */\n  enableCitations?: boolean;\n}\n\n/**\n * ChatContainer Component - Main Export\n * \n * The primary chat interface component. Can be deployed in three modes:\n * \n * 1. Standalone: Full-page chat interface\n *    - Use when chat is the main feature\n *    - No fixed dimensions, fills container\n * \n * 2. Widget: Embedded chat widget\n *    - Use for embedding in existing pages\n *    - Fixed dimensions with shadow\n * \n * 3. Floating: Floating chat bubble\n *    - Use for overlay chat interfaces\n *    - Fixed dimensions with stronger shadow\n * \n * @example\n * // Standalone mode\n * <ChatContainer mode=\"standalone\" />\n * \n * @example\n * // Widget mode with close handler\n * <ChatContainer \n *   mode=\"widget\" \n *   onClose={() => setShowChat(false)}\n * />\n */\nexport const ChatContainer: React.FC<ChatContainerProps> = ({\n  mode = 'standalone',\n  className,\n  onClose,\n  onAgentSettings,\n  enableConversationManagement = false,\n  maxConversations,\n  sessionId,\n  threadId,\n  onConversationChange,\n  onMessage,\n  conversationRefreshKey,\n  isMobile = false,\n  enableCitations\n}) => {\n  const { sendMessage, isStreaming, cancelStreaming } = useMessageStore();\n  const { fetchAgents, agents, currentAgent } = useAgentStore();\n  const { currentConversation } = useConversationStore();\n  \n  // Get widget instance from context\n  const widget = useWidgetSafe();\n  \n  // Track current conversation for the widget\n  const [currentConversationId, setCurrentConversationId] = React.useState<string | null>(null);\n  \n  // Voice modal state\n  const [isVoiceModalOpen, setIsVoiceModalOpen] = React.useState(false);\n  const [voiceError, setVoiceError] = React.useState<string | null>(null);\n  \n  // Get demo store state\n  const { isDemoMode, openAIApiKey } = useDemoStore();\n  \n  // Check if we're in free trial mode by looking at localStorage\n  const [isFreeTrialMode, setIsFreeTrialMode] = React.useState(false);\n  \n  // State to control FreeTrialLimitModal visibility\n  const [showFreeTrialLimitModal, setShowFreeTrialLimitModal] = React.useState(false);\n  \n  React.useEffect(() => {\n    if (mode === 'standalone' && typeof window !== 'undefined') {\n      const freeTrialFlag = localStorage.getItem('customgpt.freeTrialMode');\n      setIsFreeTrialMode(freeTrialFlag === 'true');\n    }\n  }, [mode]);\n  \n  // Check if OpenAI key is available\n  const checkVoiceAvailability = () => {\n    // In demo mode, check if user has provided OpenAI key\n    if (isDemoMode) {\n      if (!openAIApiKey) {\n        return {\n          available: false,\n          error: 'Voice feature requires an OpenAI API key. Please enable voice capability in demo settings and provide your OpenAI API key.'\n        };\n      }\n      return { available: true };\n    }\n    \n    // In normal mode, check if OpenAI key is in environment\n    // We can't check server-side env vars from client, so we'll let the API handle it\n    return { available: true };\n  };\n  \n  // Handle voice button click\n  const handleVoiceClick = () => {\n    const { available, error } = checkVoiceAvailability();\n    \n    if (!available) {\n      toast.error(error || 'Voice feature is not available');\n      return;\n    }\n    \n    setIsVoiceModalOpen(true);\n  };\n  \n  // Handle conversation management\n  const handleConversationChange = (conversation: any) => {\n    setCurrentConversationId(conversation.id);\n    onConversationChange?.(conversation);\n    // The widget will handle the actual conversation switch\n    if (widget) {\n      widget.switchConversation(conversation.id);\n    }\n  };\n  \n  const handleCreateConversation = async () => {\n    if (widget) {\n      try {\n        const newConv = await widget.createConversation();\n        if (newConv) {\n          setCurrentConversationId(newConv.id);\n        } else {\n          // Show user-friendly message when conversation limit is reached\n          const maxConversations = widget.configuration?.maxConversations || 5;\n          toast.error(`You've reached the maximum limit of ${maxConversations} conversations. Please delete an existing conversation to create a new one.`);\n        }\n      } catch (error) {\n        console.error('Failed to create conversation:', error);\n        toast.error('Failed to create conversation. Please try again.');\n      }\n    }\n  };\n\n  /**\n   * Agent initialization effect\n   * Fetches available agents when the component first mounts\n   * Only runs if agents haven't been loaded yet\n   */\n  useEffect(() => {\n    const initializeAgents = async () => {\n      // Only fetch if we don't have agents and no current agent\n      if (agents.length === 0 && !currentAgent) {\n        logger.info('UI', 'Initializing agents on ChatContainer mount');\n        try {\n          await fetchAgents();\n          logger.info('UI', 'Agents initialized successfully', {\n            agentCount: agents.length\n          });\n        } catch (error) {\n          logger.error('UI', 'Failed to initialize agents', error, {\n            errorMessage: error instanceof Error ? error.message : String(error)\n          });\n          console.error('Failed to initialize agents:', error);\n        }\n      } else {\n        logger.info('UI', 'Agents already initialized', {\n          agentCount: agents.length,\n          hasCurrentAgent: !!currentAgent,\n          currentAgentName: currentAgent?.project_name\n        });\n      }\n    };\n\n    initializeAgents();\n  }, [agents.length, currentAgent, fetchAgents]); // Add dependencies for exhaustive deps\n  \n  const handleSendMessage = async (content: string, files?: File[]) => {\n    // Check if in free trial mode\n    if (isFreeTrialMode) {\n      toast.error('Free Trial Limitation', {\n        description: 'Sending messages is not available in free trial mode. Please use your own API key to send messages.',\n        duration: 5000,\n      });\n      // Show modal after 3 seconds\n      setTimeout(() => {\n        setShowFreeTrialLimitModal(true);\n      }, 3000);\n      return;\n    }\n    \n    logger.info('UI', 'Sending message from ChatContainer', {\n      contentLength: content.length,\n      hasFiles: files && files.length > 0,\n      fileCount: files?.length || 0,\n      currentAgent: currentAgent?.project_name,\n      agentId: currentAgent?.id\n    });\n    \n    try {\n      await sendMessage(content, files);\n      logger.info('UI', 'Message sent successfully');\n    } catch (error) {\n      logger.error('UI', 'Failed to send message from ChatContainer', error, {\n        errorMessage: error instanceof Error ? error.message : String(error),\n        isAuthError: error instanceof Error && (error.message.includes('403') || error.message.includes('unauthorized'))\n      });\n      console.error('Failed to send message:', error);\n\n      // Show clearer toast for rate limit exceeded\n      try {\n        const anyErr: any = error as any;\n        const status = anyErr?.status;\n        const data = anyErr?.data;\n        if (status === 429) {\n          const retryAfter = data?.details?.retryAfter ?? data?.retryAfter;\n          const window = data?.details?.window ?? 'minute';\n          const limit = data?.details?.limit;\n          toast.error('Rate limit exceeded', {\n            description: retryAfter\n              ? `Too many queries for this agent. Try again in ${retryAfter} seconds.`\n              : `You have hit the ${window} limit${limit ? ` (${limit})` : ''}. Please wait before retrying.`,\n            duration: 5000,\n          });\n          return;\n        }\n      } catch {}\n\n      toast.error('Failed to send', {\n        description: error instanceof Error ? error.message : 'Please try again',\n        duration: 4000,\n      });\n    }\n  };\n  \n  const handleStopGeneration = () => {\n    logger.info('UI', 'User cancelled streaming generation');\n    cancelStreaming();\n  };\n  \n  const handleAgentSettings = (agent: Agent) => {\n    logger.info('UI', 'Agent settings requested', {\n      agentId: agent.id,\n      agentName: agent.project_name\n    });\n    onAgentSettings?.(agent);\n  };\n  \n  return (\n    <div\n      className={cn(\n        'flex flex-col bg-background',\n        mode === 'standalone' && 'h-full',\n        mode === 'widget' && !isMobile && 'h-[600px] w-[400px] rounded-lg shadow-xl border border-border',\n        mode === 'floating' && !isMobile && 'h-[600px] w-[400px] rounded-lg shadow-2xl border border-border',\n        isMobile && 'h-full w-full',\n        className\n      )}\n    >\n      <ChatHeader \n        mode={mode} \n        onClose={onClose}\n        onAgentSettings={handleAgentSettings}\n        enableConversationManagement={enableConversationManagement}\n        maxConversations={maxConversations}\n        sessionId={sessionId}\n        currentConversationId={currentConversationId || currentConversation?.id.toString()}\n        onConversationChange={handleConversationChange}\n        onCreateConversation={handleCreateConversation}\n        conversationRefreshKey={conversationRefreshKey}\n      />\n      <MessageArea\n        className=\"flex-1 overflow-y-auto\"\n        mode={mode}\n        onShowFreeTrialLimitModal={() => setShowFreeTrialLimitModal(true)}\n        enableCitations={enableCitations}\n      />\n      <div className={cn(\n        \"mt-auto\",\n        isMobile && mode === 'standalone' ? \"pb-[30px]\" : \"\"\n      )}>\n        <ChatInput\n          onSend={handleSendMessage}\n          disabled={isStreaming || isFreeTrialMode}\n          placeholder={\n            isFreeTrialMode \n              ? \"Free trial mode - Use your API key to send messages\" \n              : isStreaming \n                ? \"AI is thinking...\" \n                : \"Send a message...\"\n          }\n          onVoiceClick={handleVoiceClick}\n          isMobile={isMobile}\n          mode={mode}\n        />\n      </div>\n      \n      {/* Branding Footer */}\n      <div className={cn(\n        \"px-4 py-2 border-t border-border bg-muted\",\n        mode === 'standalone' && \"flex items-center justify-center\"\n      )}>\n        <a\n          href=\"https://customgpt.ai\"\n          target=\"_blank\"\n          rel=\"noopener noreferrer\"\n          className={cn(\n            \"text-xs text-muted-foreground hover:text-foreground transition-colors\",\n            mode === 'standalone' ? \"inline-flex items-center\" : \"block text-center\"\n          )}\n        >\n          Powered by CustomGPT.ai\n        </a>\n      </div>\n      \n      {/* Voice Modal */}\n      {currentAgent && currentAgent.id && (\n        <VoiceModal\n          isOpen={isVoiceModalOpen}\n          onClose={() => setIsVoiceModalOpen(false)}\n          projectId={currentAgent.id.toString()}\n          projectName={currentAgent.project_name}\n        />\n      )}\n      \n      {/* Free Trial Limit Modal - shown 3 seconds after toast notification */}\n      {showFreeTrialLimitModal && (\n        <FreeTrialLimitModal\n          onClose={() => setShowFreeTrialLimitModal(false)}\n        />\n      )}\n    </div>\n  );\n};","\"use client\"\n\nimport * as React from \"react\"\nimport * as SelectPrimitive from \"@radix-ui/react-select\"\nimport { Check, ChevronDown, ChevronUp } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Select = SelectPrimitive.Root\n\nconst SelectGroup = SelectPrimitive.Group\n\nconst SelectValue = SelectPrimitive.Value\n\nconst SelectTrigger = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Trigger>\n>(({ className, children, ...props }, ref) => (\n  <SelectPrimitive.Trigger\n    ref={ref}\n    className={cn(\n      \"flex h-11 w-full items-center justify-between rounded-lg border border-input bg-background px-3.5 py-2 text-sm\",\n      \"transition-all duration-200 ease-out\",\n      \"hover:border-primary/30\",\n      \"focus:outline-none focus:ring-2 focus:ring-primary/20 focus:border-primary\",\n      \"focus:bg-primary/5\",\n      \"disabled:cursor-not-allowed disabled:opacity-50 disabled:bg-muted/50\",\n      \"text-foreground placeholder:text-muted-foreground\",\n      \"[&>span]:line-clamp-1\",\n      \"group\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <SelectPrimitive.Icon asChild>\n      <ChevronDown className=\"h-4 w-4 opacity-50 transition-transform duration-200 group-data-[state=open]:rotate-180\" />\n    </SelectPrimitive.Icon>\n  </SelectPrimitive.Trigger>\n))\nSelectTrigger.displayName = SelectPrimitive.Trigger.displayName\n\nconst SelectScrollUpButton = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.ScrollUpButton>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.ScrollUpButton>\n>(({ className, ...props }, ref) => (\n  <SelectPrimitive.ScrollUpButton\n    ref={ref}\n    className={cn(\n      \"flex cursor-default items-center justify-center py-1\",\n      \"border-b border-gray-200/30 dark:border-gray-800/20 bg-background/50\",\n      \"hover:bg-accent/50 transition-colors\",\n      className\n    )}\n    {...props}\n  >\n    <ChevronUp className=\"h-4 w-4 opacity-50\" />\n  </SelectPrimitive.ScrollUpButton>\n))\nSelectScrollUpButton.displayName = SelectPrimitive.ScrollUpButton.displayName\n\nconst SelectScrollDownButton = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.ScrollDownButton>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.ScrollDownButton>\n>(({ className, ...props }, ref) => (\n  <SelectPrimitive.ScrollDownButton\n    ref={ref}\n    className={cn(\n      \"flex cursor-default items-center justify-center py-1\",\n      \"border-t border-gray-200/30 dark:border-gray-800/20 bg-background/50\",\n      \"hover:bg-accent/50 transition-colors\",\n      className\n    )}\n    {...props}\n  >\n    <ChevronDown className=\"h-4 w-4 opacity-50\" />\n  </SelectPrimitive.ScrollDownButton>\n))\nSelectScrollDownButton.displayName =\n  SelectPrimitive.ScrollDownButton.displayName\n\nconst SelectContent = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Content>\n>(({ className, children, position = \"popper\", ...props }, ref) => (\n  <SelectPrimitive.Portal>\n    <SelectPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"relative z-50 max-h-96 min-w-[8rem] overflow-hidden\",\n        \"rounded-lg border border-gray-200/50 dark:border-gray-800/30\",\n        \"bg-background/95 backdrop-blur-md\",\n        \"text-foreground shadow-lg\",\n        \"data-[state=open]:animate-in data-[state=closed]:animate-out\",\n        \"data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0\",\n        \"data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95\",\n        \"data-[side=bottom]:slide-in-from-top-2\",\n        \"data-[side=left]:slide-in-from-right-2\",\n        \"data-[side=right]:slide-in-from-left-2\",\n        \"data-[side=top]:slide-in-from-bottom-2\",\n        position === \"popper\" && [\n          \"data-[side=bottom]:translate-y-1\",\n          \"data-[side=left]:-translate-x-1\",\n          \"data-[side=right]:translate-x-1\",\n          \"data-[side=top]:-translate-y-1\",\n        ],\n        className\n      )}\n      position={position}\n      {...props}\n    >\n      <SelectScrollUpButton />\n      <SelectPrimitive.Viewport\n        className={cn(\n          \"p-1.5\",\n          position === \"popper\" &&\n            \"h-[var(--radix-select-trigger-height)] w-full min-w-[var(--radix-select-trigger-width)]\"\n        )}\n      >\n        {children}\n      </SelectPrimitive.Viewport>\n      <SelectScrollDownButton />\n    </SelectPrimitive.Content>\n  </SelectPrimitive.Portal>\n))\nSelectContent.displayName = SelectPrimitive.Content.displayName\n\nconst SelectLabel = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Label>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Label>\n>(({ className, ...props }, ref) => (\n  <SelectPrimitive.Label\n    ref={ref}\n    className={cn(\"py-1.5 pl-8 pr-2 text-sm font-semibold\", className)}\n    {...props}\n  />\n))\nSelectLabel.displayName = SelectPrimitive.Label.displayName\n\nconst SelectItem = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Item>\n>(({ className, children, ...props }, ref) => (\n  <SelectPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex w-full cursor-pointer select-none items-center\",\n      \"rounded-md py-2 pl-8 pr-2 text-sm outline-none\",\n      \"transition-all duration-150\",\n      \"hover:bg-accent hover:text-accent-foreground\",\n      \"focus:bg-accent focus:text-accent-foreground\",\n      \"data-[state=checked]:bg-primary/10 data-[state=checked]:text-primary\",\n      \"data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-4 w-4 items-center justify-center\">\n      <SelectPrimitive.ItemIndicator>\n        <Check className=\"h-3.5 w-3.5 animate-in fade-in-0 zoom-in-0\" />\n      </SelectPrimitive.ItemIndicator>\n    </span>\n\n    <SelectPrimitive.ItemText>{children}</SelectPrimitive.ItemText>\n  </SelectPrimitive.Item>\n))\nSelectItem.displayName = SelectPrimitive.Item.displayName\n\nconst SelectSeparator = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <SelectPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 my-1 h-px bg-border\", className)}\n    {...props}\n  />\n))\nSelectSeparator.displayName = SelectPrimitive.Separator.displayName\n\nexport {\n  Select,\n  SelectGroup,\n  SelectValue,\n  SelectTrigger,\n  SelectContent,\n  SelectLabel,\n  SelectItem,\n  SelectSeparator,\n  SelectScrollUpButton,\n  SelectScrollDownButton,\n}","\"use client\"\n\nimport * as React from \"react\"\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n  SelectGroup,\n  SelectLabel,\n  SelectSeparator,\n} from \"@/components/ui/select\"\nimport { cn } from \"@/lib/utils\"\n\nexport interface SelectOption {\n  value: string;\n  label: string;\n  disabled?: boolean;\n}\n\ninterface SimpleSelectProps {\n  value: string;\n  onValueChange: (value: string) => void;\n  options: SelectOption[];\n  placeholder?: string;\n  className?: string;\n  disabled?: boolean;\n  name?: string;\n  id?: string;\n}\n\n/**\n * Simple Select Component\n * \n * A wrapper around the Radix UI Select component that provides a simpler API\n * similar to native HTML select elements, making migration easier.\n * \n * @example\n * ```tsx\n * <SimpleSelect\n *   value={dateRange}\n *   onValueChange={setDateRange}\n *   options={[\n *     { value: '7d', label: 'Last 7 days' },\n *     { value: '30d', label: 'Last 30 days' },\n *     { value: '90d', label: 'Last 90 days' },\n *     { value: '1y', label: 'Last year' }\n *   ]}\n *   placeholder=\"Select date range\"\n * />\n * ```\n */\nexport function SimpleSelect({\n  value,\n  onValueChange,\n  options,\n  placeholder = \"Select an option\",\n  className,\n  disabled = false,\n  name,\n  id,\n}: SimpleSelectProps) {\n  return (\n    <Select\n      value={value}\n      onValueChange={onValueChange}\n      disabled={disabled}\n      name={name}\n    >\n      <SelectTrigger className={cn(\"w-full\", className)} id={id}>\n        <SelectValue placeholder={placeholder} />\n      </SelectTrigger>\n      <SelectContent>\n        {options.map((option) => (\n          <SelectItem\n            key={option.value}\n            value={option.value}\n            disabled={option.disabled}\n          >\n            {option.label}\n          </SelectItem>\n        ))}\n      </SelectContent>\n    </Select>\n  );\n}\n\n/**\n * Grouped Select Component\n * \n * For selects with grouped options (like languages grouped by region)\n */\nexport interface SelectGroup {\n  label: string;\n  options: SelectOption[];\n}\n\ninterface GroupedSelectProps extends Omit<SimpleSelectProps, 'options'> {\n  groups: SelectGroup[];\n}\n\nexport function GroupedSelect({\n  value,\n  onValueChange,\n  groups,\n  placeholder = \"Select an option\",\n  className,\n  disabled = false,\n  name,\n  id,\n}: GroupedSelectProps) {\n  return (\n    <Select\n      value={value}\n      onValueChange={onValueChange}\n      disabled={disabled}\n      name={name}\n    >\n      <SelectTrigger className={cn(\"w-full\", className)} id={id}>\n        <SelectValue placeholder={placeholder} />\n      </SelectTrigger>\n      <SelectContent>\n        {groups.map((group, index) => (\n          <React.Fragment key={index}>\n            {index > 0 && <SelectSeparator />}\n            <SelectGroup>\n              <SelectLabel>{group.label}</SelectLabel>\n              {group.options.map((option) => (\n                <SelectItem\n                  key={option.value}\n                  value={option.value}\n                  disabled={option.disabled}\n                >\n                  {option.label}\n                </SelectItem>\n              ))}\n            </SelectGroup>\n          </React.Fragment>\n        ))}\n      </SelectContent>\n    </Select>\n  );\n}\n\n","import React from 'react';\nimport { X, Calendar, User, Hash, Clock, AlertCircle, Copy } from 'lucide-react';\nimport { motion, AnimatePresence } from 'framer-motion';\nimport { toast } from 'sonner';\nimport type { Conversation } from '@/types';\nimport { Button } from '@/components/ui/button';\nimport { formatTimestamp, cn } from '@/lib/utils';\nimport { useBreakpoint } from '@/hooks/useMediaQuery';\n\ninterface ConversationDetailsModalProps {\n  conversation: Conversation | null;\n  isOpen: boolean;\n  onClose: () => void;\n}\n\nexport const ConversationDetailsModal: React.FC<ConversationDetailsModalProps> = ({\n  conversation,\n  isOpen,\n  onClose,\n}) => {\n  const { isMobile } = useBreakpoint();\n  \n  if (!isOpen || !conversation) return null;\n\n  const copyToClipboard = (text: string, label: string) => {\n    navigator.clipboard.writeText(text);\n    toast.success(`${label} copied to clipboard`);\n  };\n\n  const formatFullTimestamp = (timestamp: string) => {\n    const date = new Date(timestamp);\n    return date.toLocaleString('en-US', {\n      weekday: 'long',\n      year: 'numeric',\n      month: 'long',\n      day: 'numeric',\n      hour: '2-digit',\n      minute: '2-digit',\n      second: '2-digit',\n      timeZoneName: 'short'\n    });\n  };\n\n  return (\n    <AnimatePresence>\n      {isOpen && (\n        <>\n          {/* Backdrop */}\n          <motion.div\n            initial={{ opacity: 0 }}\n            animate={{ opacity: 1 }}\n            exit={{ opacity: 0 }}\n            className=\"fixed inset-0 bg-black bg-opacity-50 z-50\"\n            onClick={onClose}\n          />\n\n          {/* Modal */}\n          <motion.div\n            initial={{ opacity: 0, scale: 0.95, y: isMobile ? '100%' : 0 }}\n            animate={{ opacity: 1, scale: 1, y: 0 }}\n            exit={{ opacity: 0, scale: 0.95, y: isMobile ? '100%' : 0 }}\n            className={cn(\n              \"fixed bg-background shadow-xl z-50\",\n              isMobile \n                ? \"inset-x-0 bottom-0 top-20 rounded-t-xl flex flex-col\" \n                : \"inset-x-0 top-[10%] mx-auto max-w-2xl rounded-lg max-h-[80vh] overflow-hidden\"\n            )}\n            onClick={(e) => e.stopPropagation()}\n          >\n            {/* Header */}\n            <div className={cn(\n              \"flex items-center justify-between border-b border-border bg-background/95 backdrop-blur-sm flex-shrink-0\",\n              isMobile ? \"px-4 py-4\" : \"p-6\"\n            )}>\n              <h2 className={cn(\n                \"font-semibold text-foreground\",\n                isMobile ? \"text-base\" : \"text-xl\"\n              )}>Conversation Details</h2>\n              <Button\n                size=\"icon\"\n                variant=\"ghost\"\n                onClick={onClose}\n                className={cn(\n                  isMobile ? \"h-9 w-9 touch-target\" : \"h-8 w-8\"\n                )}\n              >\n                <X className={cn(\n                  isMobile ? \"h-5 w-5\" : \"h-4 w-4\"\n                )} />\n              </Button>\n            </div>\n\n            {/* Content */}\n            <div className={cn(\n              \"overflow-y-auto\",\n              isMobile \n                ? \"flex-1 px-4 py-4 pb-6 safe-area-pb space-y-6\" \n                : \"p-6 space-y-6 max-h-[calc(80vh-200px)]\"\n            )}>\n              {/* Basic Information */}\n              <div>\n                <h3 className={cn(\n                  \"font-medium text-muted-foreground uppercase tracking-wider mb-4\",\n                  isMobile ? \"text-xs\" : \"text-sm\"\n                )}>\n                  Basic Information\n                </h3>\n                <div className={cn(\n                  \"bg-muted rounded-lg space-y-4\",\n                  isMobile ? \"p-4\" : \"p-4 space-y-3\"\n                )}>\n                  {/* Conversation Name */}\n                  <div className={cn(\n                    isMobile ? \"space-y-2\" : \"flex items-start justify-between\"\n                  )}>\n                    <div className=\"flex items-center gap-2\">\n                      <Hash className={cn(\n                        \"text-muted-foreground\",\n                        isMobile ? \"h-4 w-4\" : \"h-4 w-4\"\n                      )} />\n                      <span className={cn(\n                        \"font-medium text-foreground\",\n                        isMobile ? \"text-sm\" : \"text-sm\"\n                      )}>Conversation Name</span>\n                    </div>\n                    <span className={cn(\n                      \"text-foreground font-medium break-words\",\n                      isMobile ? \"text-sm ml-6 block\" : \"text-sm\"\n                    )}>{conversation.name}</span>\n                  </div>\n\n                  {/* Conversation ID */}\n                  <div className={cn(\n                    isMobile ? \"space-y-2\" : \"flex items-start justify-between\"\n                  )}>\n                    <div className=\"flex items-center gap-2\">\n                      <Hash className={cn(\n                        \"text-muted-foreground\",\n                        isMobile ? \"h-4 w-4\" : \"h-4 w-4\"\n                      )} />\n                      <span className={cn(\n                        \"font-medium text-foreground\",\n                        isMobile ? \"text-sm\" : \"text-sm\"\n                      )}>Conversation ID</span>\n                    </div>\n                    <div className={cn(\n                      \"flex items-center gap-2\",\n                      isMobile ? \"ml-6\" : \"\"\n                    )}>\n                      <span className={cn(\n                        \"text-foreground font-mono\",\n                        isMobile ? \"text-xs\" : \"text-sm\"\n                      )}>{conversation.id}</span>\n                      <Button\n                        size=\"icon\"\n                        variant=\"ghost\"\n                        className={cn(\n                          isMobile ? \"h-8 w-8 touch-target\" : \"h-6 w-6\"\n                        )}\n                        onClick={() => copyToClipboard(conversation.id.toString(), 'Conversation ID')}\n                      >\n                        <Copy className={cn(\n                          isMobile ? \"h-4 w-4\" : \"h-3 w-3\"\n                        )} />\n                      </Button>\n                    </div>\n                  </div>\n\n                  {/* Session ID */}\n                  <div className={cn(\n                    isMobile ? \"space-y-2\" : \"flex items-start justify-between\"\n                  )}>\n                    <div className=\"flex items-center gap-2\">\n                      <Hash className={cn(\n                        \"text-muted-foreground\",\n                        isMobile ? \"h-4 w-4\" : \"h-4 w-4\"\n                      )} />\n                      <span className={cn(\n                        \"font-medium text-foreground\",\n                        isMobile ? \"text-sm\" : \"text-sm\"\n                      )}>Session ID</span>\n                    </div>\n                    <div className={cn(\n                      \"flex items-center gap-2\",\n                      isMobile ? \"ml-6\" : \"\"\n                    )}>\n                      <span \n                        className={cn(\n                          \"text-foreground font-mono break-all\",\n                          isMobile ? \"text-sm\" : \"text-sm truncate max-w-[300px]\"\n                        )} \n                        title={conversation.session_id}\n                      >\n                        {conversation.session_id}\n                      </span>\n                      <Button\n                        size=\"icon\"\n                        variant=\"ghost\"\n                        className={cn(\n                          isMobile ? \"h-8 w-8 touch-target flex-shrink-0\" : \"h-6 w-6\"\n                        )}\n                        onClick={() => copyToClipboard(conversation.session_id, 'Session ID')}\n                      >\n                        <Copy className={cn(\n                          isMobile ? \"h-4 w-4\" : \"h-3 w-3\"\n                        )} />\n                      </Button>\n                    </div>\n                  </div>\n\n                  {/* Project ID */}\n                  <div className={cn(\n                    isMobile ? \"space-y-2\" : \"flex items-start justify-between\"\n                  )}>\n                    <div className=\"flex items-center gap-2\">\n                      <Hash className={cn(\n                        \"text-muted-foreground\",\n                        isMobile ? \"h-4 w-4\" : \"h-4 w-4\"\n                      )} />\n                      <span className={cn(\n                        \"font-medium text-foreground\",\n                        isMobile ? \"text-sm\" : \"text-sm\"\n                      )}>Project ID</span>\n                    </div>\n                    <span className={cn(\n                      \"text-foreground\",\n                      isMobile ? \"text-sm ml-6 block\" : \"text-sm\"\n                    )}>{conversation.project_id}</span>\n                  </div>\n\n                  {/* Message Count */}\n                  {conversation.message_count !== undefined && (\n                    <div className={cn(\n                      isMobile ? \"space-y-2\" : \"flex items-start justify-between\"\n                    )}>\n                      <div className=\"flex items-center gap-2\">\n                        <Hash className={cn(\n                          \"text-muted-foreground\",\n                          isMobile ? \"h-4 w-4\" : \"h-4 w-4\"\n                        )} />\n                        <span className={cn(\n                          \"font-medium text-foreground\",\n                          isMobile ? \"text-sm\" : \"text-sm\"\n                        )}>Message Count</span>\n                      </div>\n                      <span className={cn(\n                        \"text-foreground\",\n                        isMobile ? \"text-sm ml-6 block\" : \"text-sm\"\n                      )}>{conversation.message_count} messages</span>\n                    </div>\n                  )}\n                </div>\n              </div>\n\n              {/* Timeline */}\n              <div>\n                <h3 className={cn(\n                  \"font-medium text-muted-foreground uppercase tracking-wider mb-4\",\n                  isMobile ? \"text-xs\" : \"text-sm\"\n                )}>\n                  Timeline\n                </h3>\n                <div className={cn(\n                  \"bg-muted rounded-lg space-y-4\",\n                  isMobile ? \"p-4\" : \"p-4 space-y-3\"\n                )}>\n                  {/* Created At */}\n                  <div className={cn(\n                    isMobile ? \"space-y-2\" : \"flex items-start justify-between\"\n                  )}>\n                    <div className=\"flex items-center gap-2\">\n                      <Calendar className={cn(\n                        \"text-muted-foreground\",\n                        isMobile ? \"h-4 w-4\" : \"h-4 w-4\"\n                      )} />\n                      <span className={cn(\n                        \"font-medium text-foreground\",\n                        isMobile ? \"text-sm\" : \"text-sm\"\n                      )}>Created At</span>\n                    </div>\n                    <div className={cn(\n                      isMobile ? \"ml-6 space-y-1\" : \"text-right\"\n                    )}>\n                      <span className={cn(\n                        \"text-foreground block\",\n                        isMobile ? \"text-sm\" : \"text-sm\"\n                      )}>{formatFullTimestamp(conversation.created_at)}</span>\n                      <span className={cn(\n                        \"text-muted-foreground\",\n                        isMobile ? \"text-xs\" : \"text-xs\"\n                      )}>({formatTimestamp(conversation.created_at)})</span>\n                    </div>\n                  </div>\n\n                  {/* Last Updated */}\n                  <div className={cn(\n                    isMobile ? \"space-y-2\" : \"flex items-start justify-between\"\n                  )}>\n                    <div className=\"flex items-center gap-2\">\n                      <Clock className={cn(\n                        \"text-muted-foreground\",\n                        isMobile ? \"h-4 w-4\" : \"h-4 w-4\"\n                      )} />\n                      <span className={cn(\n                        \"font-medium text-foreground\",\n                        isMobile ? \"text-sm\" : \"text-sm\"\n                      )}>Last Updated</span>\n                    </div>\n                    <div className={cn(\n                      isMobile ? \"ml-6 space-y-1\" : \"text-right\"\n                    )}>\n                      <span className={cn(\n                        \"text-foreground block\",\n                        isMobile ? \"text-sm\" : \"text-sm\"\n                      )}>{formatFullTimestamp(conversation.updated_at)}</span>\n                      <span className={cn(\n                        \"text-muted-foreground\",\n                        isMobile ? \"text-xs\" : \"text-xs\"\n                      )}>({formatTimestamp(conversation.updated_at)})</span>\n                    </div>\n                  </div>\n\n                  {/* Deleted At */}\n                  {conversation.deleted_at && (\n                    <div className={cn(\n                      isMobile ? \"space-y-2\" : \"flex items-start justify-between\"\n                    )}>\n                      <div className=\"flex items-center gap-2\">\n                        <AlertCircle className={cn(\n                          \"text-red-400\",\n                          isMobile ? \"h-4 w-4\" : \"h-4 w-4\"\n                        )} />\n                        <span className={cn(\n                          \"font-medium text-red-700\",\n                          isMobile ? \"text-sm\" : \"text-sm\"\n                        )}>Deleted At</span>\n                      </div>\n                      <div className={cn(\n                        isMobile ? \"ml-6 space-y-1\" : \"text-right\"\n                      )}>\n                        <span className={cn(\n                          \"text-red-900 block\",\n                          isMobile ? \"text-sm\" : \"text-sm\"\n                        )}>{formatFullTimestamp(conversation.deleted_at)}</span>\n                        <span className={cn(\n                          \"text-red-500\",\n                          isMobile ? \"text-xs\" : \"text-xs\"\n                        )}>({formatTimestamp(conversation.deleted_at)})</span>\n                      </div>\n                    </div>\n                  )}\n                </div>\n              </div>\n\n              {/* User Information */}\n              {conversation.created_by && (\n                <div>\n                  <h3 className={cn(\n                    \"font-medium text-muted-foreground uppercase tracking-wider mb-4\",\n                    isMobile ? \"text-xs\" : \"text-sm\"\n                  )}>\n                    User Information\n                  </h3>\n                  <div className={cn(\n                    \"bg-accent rounded-lg\",\n                    isMobile ? \"p-4\" : \"p-4\"\n                  )}>\n                    <div className={cn(\n                      isMobile ? \"space-y-2\" : \"flex items-start justify-between\"\n                    )}>\n                      <div className=\"flex items-center gap-2\">\n                        <User className={cn(\n                          \"text-muted-foreground\",\n                          isMobile ? \"h-4 w-4\" : \"h-4 w-4\"\n                        )} />\n                        <span className={cn(\n                          \"font-medium text-foreground\",\n                          isMobile ? \"text-sm\" : \"text-sm\"\n                        )}>Created By</span>\n                      </div>\n                      <span className={cn(\n                        \"text-foreground\",\n                        isMobile ? \"text-sm ml-6 block\" : \"text-sm\"\n                      )}>User ID: {conversation.created_by}</span>\n                    </div>\n                  </div>\n                </div>\n              )}\n\n            </div>\n\n            {/* Footer */}\n            {!isMobile && (\n              <div className=\"p-6 border-t border-border bg-accent\">\n                <div className=\"flex justify-end\">\n                  <Button onClick={onClose}>\n                    Close\n                  </Button>\n                </div>\n              </div>\n            )}\n          </motion.div>\n        </>\n      )}\n    </AnimatePresence>\n  );\n};","import React, { useState } from 'react';\nimport { AlertTriangle, Trash2, X } from 'lucide-react';\nimport { motion, AnimatePresence } from 'framer-motion';\nimport { Button } from '@/components/ui/button';\nimport { cn } from '@/lib/utils';\nimport { useBreakpoint } from '@/hooks/useMediaQuery';\n\ninterface DeleteConversationDialogProps {\n  isOpen: boolean;\n  conversationName: string;\n  messageCount?: number;\n  onConfirm: () => Promise<void>;\n  onCancel: () => void;\n}\n\nexport const DeleteConversationDialog: React.FC<DeleteConversationDialogProps> = ({\n  isOpen,\n  conversationName,\n  messageCount,\n  onConfirm,\n  onCancel,\n}) => {\n  const [isDeleting, setIsDeleting] = useState(false);\n  const [error, setError] = useState<string | null>(null);\n  const { isMobile } = useBreakpoint();\n\n  const handleConfirm = async () => {\n    setIsDeleting(true);\n    setError(null);\n    \n    try {\n      await onConfirm();\n    } catch (err: any) {\n      console.error('Delete failed:', err);\n      \n      // Parse error message based on status code\n      let errorMessage = 'Failed to delete conversation';\n      \n      if (err.status === 400) {\n        errorMessage = 'Invalid request. Please try again.';\n      } else if (err.status === 401) {\n        errorMessage = 'Authentication failed. Please refresh the page and try again.';\n      } else if (err.status === 404) {\n        errorMessage = 'Conversation not found. It may have already been deleted.';\n      } else if (err.status === 500) {\n        errorMessage = 'Server error. Please try again later.';\n      } else if (err.message) {\n        errorMessage = err.message;\n      }\n      \n      setError(errorMessage);\n      setIsDeleting(false);\n    }\n  };\n\n  if (!isOpen) return null;\n\n  return (\n    <AnimatePresence>\n      {isOpen && (\n        <div className=\"fixed inset-0 z-50 flex items-center justify-center p-4\">\n          {/* Backdrop */}\n          <motion.div\n            initial={{ opacity: 0 }}\n            animate={{ opacity: 1 }}\n            exit={{ opacity: 0 }}\n            className=\"absolute inset-0 bg-black bg-opacity-50\"\n            onClick={!isDeleting ? onCancel : undefined}\n          />\n\n          {/* Dialog */}\n          <motion.div\n            initial={{ opacity: 0, scale: isMobile ? 1 : 0.95, y: isMobile ? '100%' : 0 }}\n            animate={{ opacity: 1, scale: 1, y: 0 }}\n            exit={{ opacity: 0, scale: isMobile ? 1 : 0.95, y: isMobile ? '100%' : 0 }}\n            className={cn(\n              \"relative bg-background shadow-xl\",\n              isMobile \n                ? \"fixed inset-x-0 bottom-0 rounded-t-xl safe-area-pb\" \n                : \"w-full max-w-md rounded-lg\"\n            )}\n            onClick={(e) => e.stopPropagation()}\n          >\n            <div className={cn(\n              isMobile ? \"p-4 pb-6\" : \"p-6\"\n            )}>\n              {/* Header */}\n              <div className={cn(\n                \"flex items-start\",\n                isMobile ? \"gap-3\" : \"gap-4\"\n              )}>\n                <div className={cn(\n                  \"bg-red-100 rounded-full flex-shrink-0\",\n                  isMobile ? \"p-2.5\" : \"p-3\"\n                )}>\n                  <AlertTriangle className={cn(\n                    \"text-red-600\",\n                    isMobile ? \"w-5 h-5\" : \"w-6 h-6\"\n                  )} />\n                </div>\n                <div className=\"flex-1\">\n                  <h3 className={cn(\n                    \"font-semibold text-foreground\",\n                    isMobile ? \"text-base\" : \"text-lg\"\n                  )}>\n                    Delete Conversation\n                  </h3>\n                  <p className={cn(\n                    \"mt-2 text-muted-foreground\",\n                    isMobile ? \"text-sm\" : \"text-sm\"\n                  )}>\n                    Are you sure you want to delete <strong>&ldquo;{conversationName}&rdquo;</strong>?\n                  </p>\n                  \n                  {messageCount !== undefined && messageCount > 0 && (\n                    <p className={cn(\n                      \"mt-2 text-muted-foreground\",\n                      isMobile ? \"text-sm\" : \"text-sm\"\n                    )}>\n                      This conversation contains {messageCount} message{messageCount !== 1 ? 's' : ''}.\n                    </p>\n                  )}\n                  \n                  <div className={cn(\n                    \"mt-3 bg-red-50 rounded-lg\",\n                    isMobile ? \"p-3\" : \"p-3\"\n                  )}>\n                    <p className={cn(\n                      \"text-red-800 font-medium\",\n                      isMobile ? \"text-sm\" : \"text-sm\"\n                    )}>\n                       This action cannot be undone\n                    </p>\n                    <p className={cn(\n                      \"text-red-700 mt-1\",\n                      isMobile ? \"text-xs\" : \"text-xs\"\n                    )}>\n                      All messages and data associated with this conversation will be permanently deleted.\n                    </p>\n                  </div>\n\n                  {/* Error Display */}\n                  {error && (\n                    <div className={cn(\n                      \"mt-3 bg-red-100 border border-red-200 rounded-lg\",\n                      isMobile ? \"p-3\" : \"p-3\"\n                    )}>\n                      <p className={cn(\n                        \"text-red-900 font-medium\",\n                        isMobile ? \"text-sm\" : \"text-sm\"\n                      )}>\n                        Error: {error}\n                      </p>\n                    </div>\n                  )}\n                </div>\n              </div>\n\n              {/* Actions */}\n              <div className={cn(\n                \"flex items-center gap-3\",\n                isMobile ? \"mt-6 flex-col-reverse\" : \"mt-6 justify-end\"\n              )}>\n                <Button\n                  variant=\"outline\"\n                  onClick={onCancel}\n                  disabled={isDeleting}\n                  className={cn(\n                    isMobile && \"w-full h-11 touch-target\"\n                  )}\n                >\n                  Cancel\n                </Button>\n                <Button\n                  variant=\"destructive\"\n                  onClick={handleConfirm}\n                  disabled={isDeleting}\n                  className={cn(\n                    \"min-w-[100px]\",\n                    isMobile && \"w-full h-11 touch-target\"\n                  )}\n                >\n                  {isDeleting ? (\n                    <>\n                      <div className=\"animate-spin rounded-full h-4 w-4 border-b-2 border-white mr-2\" />\n                      Deleting...\n                    </>\n                  ) : (\n                    <>\n                      <Trash2 className={cn(\n                        \"mr-2\",\n                        isMobile ? \"w-4 h-4\" : \"w-4 h-4\"\n                      )} />\n                      Delete\n                    </>\n                  )}\n                </Button>\n              </div>\n            </div>\n          </motion.div>\n        </div>\n      )}\n    </AnimatePresence>\n  );\n};","/**\n * Conversation Sidebar Component\n * \n * Manages the conversation list and provides quick navigation\n * between different chat sessions. Includes conversation management\n * features like create, rename, and delete.\n * \n * Features:\n * - Conversation list with search/filter\n * - Create new conversation\n * - Rename conversations inline\n * - Delete conversations with confirmation\n * - Agent management access\n * - Data source management\n * - Analytics dashboard access\n * - Collapsible sidebar\n * \n * State Management:\n * - Conversations from conversationStore\n * - Current conversation selection\n * - Search/filter state (local)\n * - Collapse state (passed from parent)\n * \n * UI/UX Features:\n * - Hover states and animations\n * - Keyboard shortcuts (future enhancement)\n * - Context menu for conversation actions\n * - Auto-scroll to selected conversation\n * - Responsive design for mobile\n * \n * Features:\n * - Advanced conversation organization with categories and search\n * - Bulk conversation management with export/import capabilities\n * - Customizable sidebar design with responsive layout\n * - Professional conversation management with templates and pinning\n * - Comprehensive conversation history and analytics\n */\n\n'use client';\n\nimport React, { useState, useRef, useEffect, useCallback } from 'react';\nimport Link from 'next/link';\nimport { motion, AnimatePresence } from 'framer-motion';\nimport { \n  MessageSquare, \n  Plus, \n  MoreHorizontal, \n  Trash2, \n  Edit3, \n  Calendar,\n  Search,\n  X,\n  Bot,\n  Filter,\n  ChevronDown,\n  ChevronUp,\n  Info,\n  Download,\n  Share2,\n  Clock,\n  User\n} from 'lucide-react';\nimport { toast } from 'sonner';\n\nimport type { Conversation } from '@/types';\nimport { useConversationStore, useAgentStore, useMessageStore } from '@/hooks/useWidgetStore';\nimport { cn, formatTimestamp, generateConversationName } from '@/lib/utils';\nimport { Button } from '@/components/ui/button';\nimport { SimpleSelect } from '@/components/ui/simple-select';\nimport { logger } from '@/lib/logger';\nimport { ConversationDetailsModal } from './ConversationDetailsModal';\nimport { DeleteConversationDialog } from './DeleteConversationDialog';\nimport { ConversationSkeleton, Spinner } from '@/components/ui/loading';\nimport { useDemoModeContext } from '@/contexts/DemoModeContext';\n\n/**\n * Props for individual conversation item\n * \n * @property conversation - Conversation data object\n * @property isSelected - Whether this conversation is currently active\n * @property onSelect - Callback when conversation is clicked\n * @property onDelete - Callback for deleting conversation\n * @property onRename - Callback for renaming conversation\n */\ninterface ConversationItemProps {\n  conversation: Conversation;\n  isSelected: boolean;\n  onSelect: (conversation: Conversation) => void;\n  onDelete: (conversationId: string) => void;\n  onRename: (conversationId: string, newName: string) => void;\n}\n\n/**\n * Individual Conversation Item Component\n * \n * Renders a single conversation in the sidebar with actions.\n * Features inline editing and context menu for management.\n */\nconst ConversationItem: React.FC<ConversationItemProps> = ({\n  conversation,\n  isSelected,\n  onSelect,\n  onDelete,\n  onRename\n}) => {\n  const [isEditing, setIsEditing] = useState(false);\n  const [editName, setEditName] = useState(conversation.name);\n  const [showMenu, setShowMenu] = useState(false);\n  const [showDetails, setShowDetails] = useState(false);\n  const [showDetailsModal, setShowDetailsModal] = useState(false);\n  const [showDeleteDialog, setShowDeleteDialog] = useState(false);\n  const [isLoading, setIsLoading] = useState(false);\n  const inputRef = useRef<HTMLInputElement>(null);\n  const menuRef = useRef<HTMLDivElement>(null);\n\n  // Close menu when clicking outside\n  useEffect(() => {\n    const handleClickOutside = (event: MouseEvent) => {\n      if (menuRef.current && !menuRef.current.contains(event.target as Node)) {\n        setShowMenu(false);\n      }\n    };\n\n    if (showMenu) {\n      document.addEventListener('mousedown', handleClickOutside);\n      return () => document.removeEventListener('mousedown', handleClickOutside);\n    }\n  }, [showMenu]);\n\n  // Focus input when editing starts\n  useEffect(() => {\n    if (isEditing && inputRef.current) {\n      inputRef.current.focus();\n      inputRef.current.select();\n    }\n  }, [isEditing]);\n\n  const handleEdit = () => {\n    setIsEditing(true);\n    setShowMenu(false);\n  };\n\n  const handleSaveEdit = () => {\n    if (editName.trim() && editName.trim() !== conversation.name) {\n      onRename(conversation.id.toString(), editName.trim());\n    }\n    setIsEditing(false);\n    setEditName(conversation.name);\n  };\n\n  const handleCancelEdit = () => {\n    setIsEditing(false);\n    setEditName(conversation.name);\n  };\n\n  const handleKeyDown = (e: React.KeyboardEvent) => {\n    if (e.key === 'Enter') {\n      handleSaveEdit();\n    } else if (e.key === 'Escape') {\n      handleCancelEdit();\n    }\n  };\n\n  const handleDelete = () => {\n    setShowDeleteDialog(true);\n    setShowMenu(false);\n  };\n\n  const handleConfirmDelete = async () => {\n    await onDelete(conversation.id.toString());\n    setShowDeleteDialog(false);\n  };\n\n  return (\n    <div\n      className={cn(\n        'group relative p-3 rounded-lg cursor-pointer transition-colors',\n        'hover:bg-accent',\n        isSelected && 'bg-accent/50 hover:bg-accent/70'\n      )}\n      onClick={async () => {\n        if (isEditing || isLoading) return;\n        setIsLoading(true);\n        try {\n          await onSelect(conversation);\n        } finally {\n          setIsLoading(false);\n        }\n      }}\n    >\n      {/* Loading overlay for individual conversation */}\n      {isLoading && (\n        <div className=\"absolute inset-0 bg-background/70 backdrop-blur-sm rounded-lg flex items-center justify-center z-10\">\n          <Spinner size=\"sm\" />\n        </div>\n      )}\n      \n      <div className=\"flex items-start justify-between gap-2\">\n        <div className=\"flex-1 min-w-0\">\n          {isEditing ? (\n            <input\n              ref={inputRef}\n              type=\"text\"\n              value={editName}\n              onChange={(e) => setEditName(e.target.value)}\n              onBlur={handleSaveEdit}\n              onKeyDown={handleKeyDown}\n              className=\"w-full px-2 py-1 text-sm font-medium text-foreground bg-background border border-input rounded focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent\"\n              maxLength={100}\n            />\n          ) : (\n            <h3 className=\"font-medium text-foreground text-sm truncate\">\n              {conversation.name}\n            </h3>\n          )}\n          \n          <div className=\"flex items-center gap-2 mt-1 text-xs text-muted-foreground\">\n            <Clock className=\"w-3 h-3\" />\n            <span title={new Date(conversation.updated_at).toLocaleString()}>\n              {formatTimestamp(conversation.updated_at)}\n            </span>\n            {conversation.message_count !== undefined && (\n              <>\n                <span></span>\n                <MessageSquare className=\"w-3 h-3\" />\n                <span>{conversation.message_count}</span>\n              </>\n            )}\n          </div>\n          \n          {/* More Details Button */}\n          <button\n            onClick={(e) => {\n              e.stopPropagation();\n              setShowDetails(!showDetails);\n            }}\n            className=\"flex items-center gap-1 mt-2 text-xs text-muted-foreground hover:text-foreground transition-colors\"\n          >\n            {showDetails ? (\n              <>\n                <ChevronUp className=\"w-3 h-3\" />\n                Hide Details\n              </>\n            ) : (\n              <>\n                <ChevronDown className=\"w-3 h-3\" />\n                More Details\n              </>\n            )}\n          </button>\n          \n          {/* Expandable Details Section */}\n          <AnimatePresence>\n            {showDetails && (\n              <motion.div\n                initial={{ opacity: 0, height: 0 }}\n                animate={{ opacity: 1, height: 'auto' }}\n                exit={{ opacity: 0, height: 0 }}\n                transition={{ duration: 0.2 }}\n                className=\"mt-2 pt-2 border-t border-border\"\n              >\n                <div className=\"space-y-1 text-xs text-muted-foreground\">\n                  <div className=\"flex items-center justify-between\">\n                    <span>Session ID:</span>\n                    <span className=\"font-mono text-foreground truncate max-w-[150px]\" title={conversation.session_id}>\n                      {conversation.session_id}\n                    </span>\n                  </div>\n                  <div className=\"flex items-center justify-between\">\n                    <span>Created:</span>\n                    <span className=\"text-foreground\">{formatTimestamp(conversation.created_at)}</span>\n                  </div>\n                  {conversation.deleted_at && (\n                    <div className=\"flex items-center justify-between\">\n                      <span className=\"text-destructive\">Deleted:</span>\n                      <span className=\"text-destructive\">{formatTimestamp(conversation.deleted_at)}</span>\n                    </div>\n                  )}\n                </div>\n              </motion.div>\n            )}\n          </AnimatePresence>\n        </div>\n\n        {/* Menu Button */}\n        {!isEditing && (\n          <div className=\"relative\" ref={menuRef}>\n            <Button\n              size=\"icon\"\n              variant=\"ghost\"\n              onClick={(e) => {\n                e.stopPropagation();\n                setShowMenu(!showMenu);\n              }}\n              className=\"opacity-0 group-hover:opacity-100 transition-opacity h-6 w-6 text-muted-foreground hover:text-foreground\"\n            >\n              <MoreHorizontal className=\"h-3 w-3\" />\n            </Button>\n\n            {/* Dropdown Menu */}\n            <AnimatePresence>\n              {showMenu && (\n                <motion.div\n                  initial={{ opacity: 0, scale: 0.95, y: -5 }}\n                  animate={{ opacity: 1, scale: 1, y: 0 }}\n                  exit={{ opacity: 0, scale: 0.95, y: -5 }}\n                  transition={{ duration: 0.1 }}\n                  className=\"absolute right-0 top-6 mt-1 w-40 bg-background border border-border rounded-lg shadow-lg z-50\"\n                >\n                  <div className=\"py-1\">\n                    <button\n                      onClick={(e) => {\n                        e.stopPropagation();\n                        setShowDetailsModal(true);\n                        setShowMenu(false);\n                      }}\n                      className=\"flex items-center gap-2 w-full px-3 py-2 text-sm text-foreground hover:bg-accent\"\n                    >\n                      <Info className=\"w-3 h-3\" />\n                      View Details\n                    </button>\n                    <button\n                      onClick={(e) => {\n                        e.stopPropagation();\n                        handleEdit();\n                      }}\n                      className=\"flex items-center gap-2 w-full px-3 py-2 text-sm text-foreground hover:bg-accent\"\n                    >\n                      <Edit3 className=\"w-3 h-3\" />\n                      Rename\n                    </button>\n                    <div className=\"border-t border-border my-1\" />\n                    <button\n                      onClick={(e) => {\n                        e.stopPropagation();\n                        handleDelete();\n                      }}\n                      className=\"flex items-center gap-2 w-full px-3 py-2 text-sm text-destructive hover:bg-destructive/10\"\n                    >\n                      <Trash2 className=\"w-3 h-3\" />\n                      Delete\n                    </button>\n                  </div>\n                </motion.div>\n              )}\n            </AnimatePresence>\n          </div>\n        )}\n      </div>\n\n      {/* Conversation Details Modal */}\n      <ConversationDetailsModal\n        conversation={conversation}\n        isOpen={showDetailsModal}\n        onClose={() => setShowDetailsModal(false)}\n      />\n\n      {/* Delete Conversation Dialog */}\n      <DeleteConversationDialog\n        isOpen={showDeleteDialog}\n        conversationName={conversation.name}\n        messageCount={conversation.message_count}\n        onConfirm={handleConfirmDelete}\n        onCancel={() => setShowDeleteDialog(false)}\n      />\n    </div>\n  );\n};\n\ninterface ConversationSidebarProps {\n  className?: string;\n  isCollapsed?: boolean;\n  onToggle?: () => void;\n  isMobile?: boolean;\n  onConversationSelect?: () => void;\n}\n\nexport const ConversationSidebar: React.FC<ConversationSidebarProps> = ({\n  className,\n  isCollapsed = false,\n  onToggle,\n  isMobile = false,\n  onConversationSelect\n}) => {\n  const [isCreating, setIsCreating] = useState(false);\n  const [showSortFilter, setShowSortFilter] = useState(false);\n  const [isSearching, setIsSearching] = useState(false);\n  \n  const { isFreeTrialMode } = useDemoModeContext();\n  \n  const { \n    conversations, \n    currentConversation, \n    loading, \n    error,\n    fetchConversations,\n    createConversation,\n    selectConversation,\n    deleteConversation,\n    updateConversation,\n    // Pagination state\n    currentPage,\n    totalPages,\n    totalConversations,\n    perPage,\n    // Sorting and filtering state\n    sortOrder,\n    sortBy,\n    userFilter,\n    // Client-side filtering state and methods\n    searchQuery: storeSearchQuery,\n    searchMode: storeSearchMode,\n    dateFilter: storeDateFilter,\n    setSearchQuery,\n    setSearchMode,\n    setDateFilter,\n    applyFilters\n  } = useConversationStore();\n  \n  const { currentAgent } = useAgentStore();\n  const { clearMessages, loadMessages } = useMessageStore();\n\n  // Fetch conversations when agent changes\n  useEffect(() => {\n    // Skip API calls in demo mode\n    const isDemoMode = typeof window !== 'undefined' && (window as any).__customgpt_demo_mode;\n    \n    if (currentAgent && !isDemoMode) {\n      logger.info('UI', 'Agent changed in sidebar, fetching conversations', {\n        agentId: currentAgent.id,\n        agentName: currentAgent.project_name,\n        isActive: currentAgent.is_chat_active\n      });\n      fetchConversations(currentAgent.id);\n    } else if (!currentAgent) {\n      logger.warn('UI', 'No current agent selected in sidebar');\n    } else if (isDemoMode) {\n      logger.info('UI', 'Skipping conversation fetch in demo mode');\n    }\n  }, [currentAgent, fetchConversations]);\n\n  // Local search query for input handling\n  const [localSearchQuery, setLocalSearchQuery] = useState(storeSearchQuery);\n\n  // Update local state when store state changes\n  useEffect(() => {\n    setLocalSearchQuery(storeSearchQuery);\n  }, [storeSearchQuery]);\n\n  // Debounced search function\n  const debouncedSearch = useCallback(\n    (query: string) => {\n      setIsSearching(true);\n      try {\n        setSearchQuery(query.trim());\n      } catch (error) {\n        logger.error('UI', 'Failed to search conversations', error);\n      } finally {\n        setIsSearching(false);\n      }\n    },\n    [setSearchQuery]\n  );\n\n  // Debounce search calls\n  useEffect(() => {\n    const timeoutId = setTimeout(() => {\n      if (localSearchQuery !== storeSearchQuery) {\n        debouncedSearch(localSearchQuery);\n      }\n    }, 300); // 300ms debounce\n\n    return () => clearTimeout(timeoutId);\n  }, [localSearchQuery, storeSearchQuery, debouncedSearch]);\n\n  // Handle search input change\n  const handleSearch = (query: string) => {\n    setLocalSearchQuery(query);\n  };\n\n  // Handle date filter change\n  const handleDateFilterChange = (filter: 'all' | 'today' | 'week' | 'month') => {\n    setDateFilter(filter);\n  };\n\n  // Handle search mode change  \n  const handleSearchModeChange = (mode: 'name' | 'id' | 'session') => {\n    setSearchMode(mode);\n  };\n  \n  // Use conversations directly since filtering is now done server-side\n  const filteredConversations = Array.isArray(conversations) ? conversations : [];\n\n  const handleNewConversation = async () => {\n    if (!currentAgent || isCreating) return;\n    \n    if (isFreeTrialMode) {\n      toast.error('Creating new conversations is not available in free trial mode');\n      return;\n    }\n    \n    logger.info('UI', 'Creating new conversation', {\n      agentId: currentAgent.id,\n      agentName: currentAgent.project_name\n    });\n    \n    setIsCreating(true);\n    try {\n      const name = `New Chat ${new Date().toLocaleDateString()}`;\n      await createConversation(currentAgent.id, name);\n      clearMessages(); // Clear current messages when starting new conversation\n      logger.info('UI', 'New conversation created successfully', { name });\n      toast.success('New conversation created');\n      \n      // Call the onConversationSelect callback to close the mobile drawer\n      if (onConversationSelect) {\n        onConversationSelect();\n      }\n    } catch (error) {\n      logger.error('UI', 'Failed to create conversation', error, {\n        agentId: currentAgent.id,\n        errorMessage: error instanceof Error ? error.message : String(error)\n      });\n      toast.error('Failed to create new conversation');\n    } finally {\n      setIsCreating(false);\n    }\n  };\n\n  const handleSelectConversation = async (conversation: Conversation) => {\n    // Prevent multiple clicks while switching\n    if (loading) return;\n    \n    logger.info('UI', 'Selecting conversation', {\n      conversationId: conversation.id,\n      conversationName: conversation.name,\n      projectId: conversation.project_id,\n      messageCount: conversation.message_count\n    });\n    \n    selectConversation(conversation);\n    \n    // Load messages for the selected conversation\n    try {\n      logger.info('UI', 'Loading messages for selected conversation', {\n        conversationId: conversation.id,\n        agentId: currentAgent?.id,\n        agentName: currentAgent?.project_name\n      });\n      \n      await loadMessages(conversation.id.toString());\n      \n      logger.info('UI', 'Messages loaded successfully for conversation', {\n        conversationId: conversation.id\n      });\n      \n      // Call the onConversationSelect callback to close the mobile drawer\n      if (onConversationSelect) {\n        onConversationSelect();\n      }\n    } catch (error) {\n      logger.error('UI', 'Failed to load messages for conversation', error, {\n        conversationId: conversation.id,\n        errorMessage: error instanceof Error ? error.message : String(error),\n        errorType: error instanceof Error ? error.constructor.name : typeof error\n      });\n      toast.error('Failed to load conversation messages');\n    }\n  };\n\n  const handleDeleteConversation = async (conversationId: string) => {\n    if (isFreeTrialMode) {\n      toast.error('Deleting conversations is not available in free trial mode');\n      return;\n    }\n    \n    try {\n      await deleteConversation(conversationId);\n      toast.success('Conversation deleted');\n    } catch (error) {\n      toast.error('Failed to delete conversation');\n    }\n  };\n\n  const handleRenameConversation = async (conversationId: string, newName: string) => {\n    if (isFreeTrialMode) {\n      toast.error('Renaming conversations is not available in free trial mode');\n      return;\n    }\n    \n    const conversation = conversations.find(c => c.id.toString() === conversationId);\n    if (!conversation) return;\n    \n    try {\n      await updateConversation(conversation.project_id, conversation.session_id, { name: newName });\n      toast.success('Conversation renamed');\n    } catch (error) {\n      toast.error('Failed to rename conversation');\n    }\n  };\n\n  // Use prop or fallback to viewport check if needed\n  // const isMobile = typeof window !== 'undefined' && window.innerWidth < 768;\n  \n  if (isCollapsed && !isMobile) {\n    return (\n      <div className={cn('w-12 bg-muted border-r border-border flex flex-col', className)}>\n        <div className=\"p-2\">\n          <Button\n            size=\"icon\"\n            variant=\"ghost\"\n            onClick={onToggle}\n            className=\"w-8 h-8\"\n            title=\"Expand sidebar\"\n          >\n            <MessageSquare className=\"h-4 w-4\" />\n          </Button>\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className={cn(\n      'bg-muted flex flex-col',\n      isMobile ? 'w-full h-full' : 'w-80 border-r border-border',\n      className\n    )}>\n      {/* Header */}\n      <div className=\"p-4 border-b border-border bg-background\">\n        <div className=\"flex items-center justify-between mb-3\">\n          <h2 className=\"font-semibold text-foreground\">Conversations</h2>\n          {!isMobile && (\n            <Button\n              size=\"icon\"\n              variant=\"ghost\"\n              onClick={onToggle}\n              className=\"h-8 w-8\"\n              title=\"Collapse sidebar\"\n            >\n              <X className=\"h-4 w-4\" />\n            </Button>\n          )}\n        </div>\n        \n        {/* Search */}\n        <div className=\"space-y-2\">\n          <div className=\"relative\">\n            <Search className=\"absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-muted-foreground\" />\n            <input\n              type=\"text\"\n              placeholder={isMobile ? \"Search conversations...\" : `Search by ${storeSearchMode}...`}\n              value={localSearchQuery}\n              onChange={(e) => handleSearch(e.target.value)}\n              className={cn(\n                \"w-full pl-9 pr-12 py-2 text-sm border border-input bg-background text-foreground rounded-lg focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent placeholder:text-muted-foreground\",\n                isMobile && \"py-3\"\n              )}\n            />\n            {isSearching && (\n              <div className=\"absolute right-3 top-1/2 transform -translate-y-1/2\">\n                <div className=\"animate-spin rounded-full h-4 w-4 border-b-2 border-brand-600\"></div>\n              </div>\n            )}\n          </div>\n          \n          {/* Search Mode Selector - Hidden on mobile */}\n          {!isMobile && (\n            <div className=\"flex gap-1\">\n              <button\n                onClick={() => handleSearchModeChange('name')}\n                className={cn(\n                  \"flex-1 px-2 py-1 text-xs rounded transition-colors\",\n                  storeSearchMode === 'name' \n                    ? \"bg-brand-500 text-white\" \n                    : \"bg-muted text-muted-foreground hover:bg-accent\"\n                )}\n              >\n                Name\n              </button>\n              <button\n                onClick={() => handleSearchModeChange('id')}\n                className={cn(\n                  \"flex-1 px-2 py-1 text-xs rounded transition-colors\",\n                  storeSearchMode === 'id' \n                    ? \"bg-brand-500 text-white\" \n                    : \"bg-muted text-muted-foreground hover:bg-accent\"\n                )}\n              >\n                ID\n              </button>\n              <button\n                onClick={() => handleSearchModeChange('session')}\n                className={cn(\n                  \"flex-1 px-2 py-1 text-xs rounded transition-colors\",\n                  storeSearchMode === 'session' \n                    ? \"bg-brand-500 text-white\" \n                    : \"bg-muted text-muted-foreground hover:bg-accent\"\n                )}\n              >\n                Session\n              </button>\n            </div>\n          )}\n        </div>\n        \n        {/* Sort and Filter Toggle - Hidden on mobile */}\n        {!isMobile && (\n          <Button\n            size=\"sm\"\n            variant=\"outline\"\n            onClick={() => setShowSortFilter(!showSortFilter)}\n            className=\"w-full mt-2 justify-center gap-2\"\n          >\n            <Filter className=\"h-3 w-3\" />\n            Sort & Filter\n            {showSortFilter ? <ChevronUp className=\"h-3 w-3\" /> : <ChevronDown className=\"h-3 w-3\" />}\n          </Button>\n        )}\n        \n        {/* Sort and Filter Options - Hidden on mobile */}\n        {!isMobile && showSortFilter && (\n          <AnimatePresence>\n            <motion.div\n              initial={{ opacity: 0, height: 0 }}\n              animate={{ opacity: 1, height: 'auto' }}\n              exit={{ opacity: 0, height: 0 }}\n              transition={{ duration: 0.2 }}\n              className=\"space-y-3 mt-3 overflow-hidden\"\n            >\n              {/* Sort Options */}\n              <div>\n                <label className=\"text-xs font-medium text-foreground mb-1 block\">Sort By</label>\n                <div className=\"grid grid-cols-2 gap-2\">\n                  <SimpleSelect\n                    value={sortBy}\n                    onValueChange={(value) => {\n                      if (currentAgent) {\n                        // Update the sort state and apply filters client-side\n                        fetchConversations(currentAgent.id, { \n                          orderBy: value \n                        });\n                      }\n                    }}\n                    options={[\n                      { value: 'id', label: 'Date Created' },\n                      { value: 'updated_at', label: 'Last Updated' },\n                      { value: 'name', label: 'Name' }\n                    ]}\n                    className=\"text-xs\"\n                  />\n                  \n                  <SimpleSelect\n                    value={sortOrder}\n                    onValueChange={(value) => {\n                      if (currentAgent) {\n                        // Update the sort state and apply filters client-side\n                        fetchConversations(currentAgent.id, { \n                          order: value as 'asc' | 'desc' \n                        });\n                      }\n                    }}\n                    options={[\n                      { value: 'desc', label: 'Newest First' },\n                      { value: 'asc', label: 'Oldest First' }\n                    ]}\n                    className=\"text-xs\"\n                  />\n                </div>\n              </div>\n              \n              {/* Date Filter */}\n              <div>\n                <label className=\"text-xs font-medium text-foreground mb-1 block\">Filter By Date</label>\n                <SimpleSelect\n                  value={storeDateFilter}\n                  onValueChange={(value) => handleDateFilterChange(value as 'all' | 'today' | 'week' | 'month')}\n                  options={[\n                    { value: 'all', label: 'All Time' },\n                    { value: 'today', label: 'Today' },\n                    { value: 'week', label: 'Last 7 Days' },\n                    { value: 'month', label: 'Last 30 Days' }\n                  ]}\n                  className=\"w-full text-xs\"\n                />\n              </div>\n              \n              {/* User Filter */}\n              <div>\n                <label className=\"text-xs font-medium text-foreground mb-1 block\">Filter By User</label>\n                <SimpleSelect\n                  value={userFilter}\n                  onValueChange={(value) => {\n                    if (currentAgent) {\n                      // Update the user filter state and apply filters client-side\n                      fetchConversations(currentAgent.id, { \n                        userFilter: value \n                      });\n                    }\n                  }}\n                  options={[\n                    { value: 'all', label: 'All Users' },\n                    { value: 'me', label: 'My Conversations' }\n                    // Additional user options could be dynamically loaded\n                  ]}\n                  className=\"w-full text-xs\"\n                />\n              </div>\n            </motion.div>\n          </AnimatePresence>\n        )}\n      </div>\n\n      {/* Action Buttons */}\n      <div className=\"p-4 space-y-2\">\n        <Link href=\"/dashboard/projects/create\">\n          <Button\n            className=\"w-full justify-start gap-2\"\n            variant=\"default\"\n            disabled={isFreeTrialMode}\n            title={isFreeTrialMode ? 'Creating new agents is not available in free trial mode' : ''}\n          >\n            <Bot className=\"w-4 h-4\" />\n            Create New Agent\n          </Button>\n        </Link>\n        \n        <Button\n          onClick={handleNewConversation}\n          disabled={!currentAgent || isCreating || isFreeTrialMode}\n          className=\"w-full justify-start gap-2\"\n          variant=\"outline\"\n          title={isFreeTrialMode ? 'Creating new conversations is not available in free trial mode' : ''}\n        >\n          {isCreating ? (\n            <>\n              <Spinner size=\"sm\" />\n              <span>Creating...</span>\n            </>\n          ) : (\n            <>\n              <Plus className=\"w-4 h-4\" />\n              <span>New Chat</span>\n            </>\n          )}\n        </Button>\n      </div>\n\n      {/* Conversations List */}\n      <div className=\"flex-1 overflow-y-auto\">\n        {loading && (!Array.isArray(conversations) || conversations.length === 0) ? (\n          <ConversationSkeleton count={5} />\n        ) : error && (!Array.isArray(conversations) || conversations.length === 0) ? (\n          <div className=\"p-4 text-center\">\n            <p className=\"text-sm text-destructive mb-2\">Failed to load conversations</p>\n            <Button\n              size=\"sm\"\n              variant=\"ghost\"\n              onClick={() => currentAgent && fetchConversations(currentAgent.id)}\n            >\n              Try Again\n            </Button>\n          </div>\n        ) : filteredConversations.length === 0 ? (\n          <div className=\"p-4 text-center\">\n            <MessageSquare className=\"w-8 h-8 text-muted-foreground mx-auto mb-2\" />\n            <p className=\"text-sm text-muted-foreground\">\n              {storeSearchQuery ? 'No conversations found' : 'No conversations yet'}\n            </p>\n            {!storeSearchQuery && (\n              <p className=\"text-xs text-muted-foreground mt-1\">\n                Start a new conversation to get going\n              </p>\n            )}\n            {currentAgent && (\n              <div className=\"text-xs text-muted-foreground mt-2 space-y-1\">\n                <p>Agent: {currentAgent.project_name} (ID: {currentAgent.id})</p>\n                {error && (\n                  <p className=\"text-destructive\">Error: {error}</p>\n                )}\n                <p>Conversations loaded: {conversations.length}</p>\n              </div>\n            )}\n          </div>\n        ) : (\n          <div className=\"p-2 space-y-1\">\n            {filteredConversations.map((conversation) => (\n              <ConversationItem\n                key={conversation.id}\n                conversation={conversation}\n                isSelected={currentConversation?.id === conversation.id}\n                onSelect={handleSelectConversation}\n                onDelete={(id) => handleDeleteConversation(id)}\n                onRename={handleRenameConversation}\n              />\n            ))}\n          </div>\n        )}\n      </div>\n\n      {/* Footer with Pagination */}\n      <div className=\"p-4 border-t border-border bg-background space-y-3\">\n        <div className=\"text-xs text-muted-foreground text-center\">\n          {storeSearchQuery ? (\n            <>\n              {filteredConversations.length} result{filteredConversations.length !== 1 ? 's' : ''}\n            </>\n          ) : (\n            <>\n              Showing {conversations.length} of {totalConversations} conversation{totalConversations !== 1 ? 's' : ''}\n            </>\n          )}\n          {currentAgent && (\n            <span className=\"block mt-1\">\n              Agent: {currentAgent.project_name}\n            </span>\n          )}\n        </div>\n        \n        {/* Pagination Controls */}\n        {totalPages > 1 && !storeSearchQuery && (\n          <div className=\"flex items-center justify-between gap-2\">\n            <Button\n              size=\"sm\"\n              variant=\"outline\"\n              onClick={() => {\n                if (currentAgent && currentPage > 1) {\n                  fetchConversations(currentAgent.id, { page: currentPage - 1 });\n                }\n              }}\n              disabled={currentPage === 1 || loading}\n            >\n              <ChevronDown className=\"h-3 w-3 rotate-90\" />\n            </Button>\n            \n            <span className=\"text-xs text-muted-foreground\">\n              Page {currentPage} of {totalPages}\n            </span>\n            \n            <Button\n              size=\"sm\"\n              variant=\"outline\"\n              onClick={() => {\n                if (currentAgent && currentPage < totalPages) {\n                  fetchConversations(currentAgent.id, { page: currentPage + 1 });\n                }\n              }}\n              disabled={currentPage === totalPages || loading}\n            >\n              <ChevronDown className=\"h-3 w-3 -rotate-90\" />\n            </Button>\n          </div>\n        )}\n      </div>\n    </div>\n  );\n};","/**\n * Chat Layout Component\n * \n * Top-level layout component that orchestrates the chat interface.\n * Handles different deployment modes and manages the conversation sidebar.\n * \n * Deployment Modes:\n * - standalone: Full chat with sidebar (default for main app)\n * - widget: Embeddable chat without sidebar\n * - floating: Popup-style chat without sidebar\n * \n * Features:\n * - Responsive sidebar with collapse/expand\n * - Automatic message loading on conversation change\n * - Mode-specific rendering logic\n * - Clean separation of concerns\n * \n * Architecture:\n * - ChatLayout (this) - Layout orchestration\n *   - ConversationSidebar - Conversation list and management\n *   - ChatContainer - Main chat interface\n *     - Message - Individual messages\n *     - ChatInput - Message input area\n * \n * State Management:\n * - currentConversation from conversationStore\n * - loadMessages from messageStore\n * - Local state for sidebar collapse\n * \n * Features:\n * - Multiple deployment modes with flexible configuration\n * - Professional sidebar with persistent state and responsive design\n * - Full keyboard navigation and accessibility support\n * - Mobile-optimized interface with adaptive layout\n * - Customizable sidebar positioning and behavior options\n */\n\n'use client';\n\nimport React, { useState, useEffect } from 'react';\nimport type { Agent } from '@/types';\nimport { ChatContainer } from './ChatContainer';\nimport { ConversationSidebar } from './ConversationSidebar';\nimport { useConversationStore, useMessageStore } from '@/hooks/useWidgetStore';\nimport { useBreakpoint } from '@/hooks/useMediaQuery';\n\n/**\n * Props for ChatLayout component\n * \n * @property mode - Deployment mode: standalone (with sidebar), widget, or floating\n * @property className - Additional CSS classes for styling\n * @property onClose - Callback for closing chat (widget/floating modes)\n * @property onAgentSettings - Callback for opening agent settings\n * @property showSidebar - Whether to show sidebar (only applies to standalone mode)\n * @property enableConversationManagement - Enable conversation switching UI\n * @property maxConversations - Maximum conversations per session\n * @property sessionId - Session ID for conversation isolation\n * @property threadId - Specific conversation thread to load\n * @property onConversationChange - Callback when conversation changes\n * @property onMessage - Callback when message is sent/received\n */\ninterface ChatLayoutProps {\n  mode?: 'standalone' | 'widget' | 'floating';\n  className?: string;\n  onClose?: () => void;\n  onAgentSettings?: (agent: Agent) => void;\n  showSidebar?: boolean;\n  enableConversationManagement?: boolean;\n  maxConversations?: number;\n  sessionId?: string;\n  threadId?: string;\n  onConversationChange?: (conversation: any) => void;\n  onMessage?: (message: any) => void;\n  widgetInstance?: any; // Widget instance for isolated conversation management\n  conversations?: any[]; // Current conversations for isolated mode\n  currentConversation?: any; // Current conversation for isolated mode\n  conversationRefreshKey?: number; // Key to trigger ConversationManager refresh\n  enableCitations?: boolean; // Whether to show citations\n}\n\n/**\n * Chat Layout Component\n * \n * Orchestrates the overall chat interface layout based on deployment mode.\n * In standalone mode, includes a collapsible conversation sidebar.\n * In widget/floating modes, renders only the chat container.\n */\nexport const ChatLayout: React.FC<ChatLayoutProps> = ({\n  mode = 'standalone',\n  className,\n  onClose,\n  onAgentSettings,\n  showSidebar = true,\n  enableConversationManagement = false,\n  maxConversations,\n  sessionId,\n  threadId,\n  onConversationChange,\n  onMessage,\n  widgetInstance,\n  conversations,\n  currentConversation,\n  conversationRefreshKey,\n  enableCitations\n}) => {\n  const [sidebarCollapsed, setSidebarCollapsed] = useState(false);\n  const [mobileSidebarOpen, setMobileSidebarOpen] = useState(false);\n  const { currentConversation: storeCurrentConversation } = useConversationStore();\n  const { loadMessages } = useMessageStore();\n\n  /**\n   * Load messages when conversation changes\n   * \n   * Automatically fetches messages from the store when user\n   * switches between conversations. This ensures the chat\n   * always shows the correct message history.\n   */\n  useEffect(() => {\n    // Skip API calls in demo mode to prevent errors\n    const isDemoMode = typeof window !== 'undefined' && (window as any).__customgpt_demo_mode;\n    \n    // In widget mode with isolated conversations, use the prop instead of store\n    const conversationToLoad = (mode === 'widget' || mode === 'floating') && currentConversation \n      ? currentConversation \n      : storeCurrentConversation;\n    \n    if (conversationToLoad && !isDemoMode) {\n      console.log('[ChatLayout] Loading messages for conversation:', {\n        conversationId: conversationToLoad.id,\n        mode,\n        isFromProp: !!(currentConversation && (mode === 'widget' || mode === 'floating'))\n      });\n      loadMessages(conversationToLoad.id.toString());\n    }\n  }, [storeCurrentConversation, currentConversation, loadMessages, mode]);\n\n  const { isMobile } = useBreakpoint();\n\n  // Hide sidebar for widget and floating modes\n  // Only standalone mode shows the conversation sidebar\n  const shouldShowSidebar = showSidebar && mode === 'standalone';\n\n  /**\n   * Toggle sidebar collapsed state\n   * \n   * Toggles sidebar visibility with potential for session persistence\n   * to enhance user experience across application sessions\n   */\n  const handleToggleSidebar = () => {\n    setSidebarCollapsed(!sidebarCollapsed);\n  };\n\n  if (!shouldShowSidebar) {\n    // For widget/floating modes, just show the chat container\n    return (\n      <ChatContainer\n        mode={mode}\n        className={className}\n        onClose={onClose}\n        onAgentSettings={onAgentSettings}\n        enableConversationManagement={enableConversationManagement}\n        maxConversations={maxConversations}\n        sessionId={sessionId}\n        threadId={threadId}\n        onConversationChange={onConversationChange}\n        onMessage={onMessage}\n        conversationRefreshKey={conversationRefreshKey}\n        isMobile={isMobile}\n        enableCitations={enableCitations}\n      />\n    );\n  }\n\n  // On mobile, hide the sidebar and use drawer navigation instead\n  if (isMobile) {\n    return (\n      <div className=\"flex flex-col h-full bg-background\">\n        <ChatContainer\n          mode={mode}\n          className=\"flex-1\"\n          onClose={onClose}\n          onAgentSettings={onAgentSettings}\n          enableConversationManagement={enableConversationManagement}\n          maxConversations={maxConversations}\n          sessionId={sessionId}\n          threadId={threadId}\n          onConversationChange={onConversationChange}\n          onMessage={onMessage}\n          conversationRefreshKey={conversationRefreshKey}\n          isMobile={true}\n          enableCitations={enableCitations}\n        />\n      </div>\n    );\n  }\n\n  // Desktop layout with sidebar\n  return (\n    <div className=\"flex h-full bg-background\">\n      {/* Sidebar */}\n      <ConversationSidebar\n        isCollapsed={sidebarCollapsed}\n        onToggle={handleToggleSidebar}\n        isMobile={false}\n      />\n      \n      {/* Main Chat Area */}\n      <div className=\"flex-1 flex flex-col min-w-0\">\n        <ChatContainer\n          mode={mode}\n          className=\"h-full\"\n          onClose={onClose}\n          onAgentSettings={onAgentSettings}\n          enableConversationManagement={enableConversationManagement}\n          maxConversations={maxConversations}\n          sessionId={sessionId}\n          threadId={threadId}\n          onConversationChange={onConversationChange}\n          onMessage={onMessage}\n          conversationRefreshKey={conversationRefreshKey}\n          isMobile={false}\n          enableCitations={enableCitations}\n        />\n      </div>\n    </div>\n  );\n};","import React, { useState } from 'react';\nimport { motion, AnimatePresence } from 'framer-motion';\nimport { MessageCircle, X, Minus } from 'lucide-react';\n\nimport { cn } from '../lib/utils';\n\ninterface FloatingButtonProps {\n  isOpen: boolean;\n  onToggle: () => void;\n  onMinimize?: () => void;\n  position?: 'bottom-right' | 'bottom-left' | 'top-right' | 'top-left';\n  primaryColor?: string;\n  size?: 'sm' | 'md' | 'lg';\n  showLabel?: boolean;\n  label?: string;\n  className?: string;\n  avatarUrl?: string;\n}\n\nexport const FloatingButton: React.FC<FloatingButtonProps> = ({\n  isOpen,\n  onToggle,\n  onMinimize,\n  position = 'bottom-right',\n  primaryColor = '#007acc',\n  size = 'md',\n  showLabel = true,\n  label = 'Chat with us',\n  className,\n  avatarUrl\n}) => {\n  const [isHovered, setIsHovered] = useState(false);\n\n  const sizeClasses = {\n    sm: 'w-12 h-12',\n    md: 'w-14 h-14',\n    lg: 'w-16 h-16',\n  };\n\n  const iconSizes = {\n    sm: 'w-5 h-5',\n    md: 'w-6 h-6',\n    lg: 'w-7 h-7',\n  };\n\n  const positionClasses = {\n    'bottom-right': 'bottom-6 right-6',\n    'bottom-left': 'bottom-6 left-6',\n    'top-right': 'top-6 right-6',\n    'top-left': 'top-6 left-6',\n  };\n\n  const labelPosition = {\n    'bottom-right': 'right-16 bottom-0',\n    'bottom-left': 'left-16 bottom-0',\n    'top-right': 'right-16 top-0',\n    'top-left': 'left-16 top-0',\n  };\n\n  if (isOpen) {\n    return null; // Hide button when widget is open\n  }\n\n  return (\n    <div\n      className={cn(\n        'fixed z-[9999] flex items-center',\n        positionClasses[position],\n        className\n      )}\n    >\n      {/* Chat Label - Hidden on mobile, visible on desktop */}\n      <AnimatePresence>\n        {showLabel && !isOpen && (\n          <motion.div\n            initial={{ opacity: 0, scale: 0.8, x: position.includes('right') ? 10 : -10 }}\n            animate={{ opacity: 1, scale: 1, x: 0 }}\n            exit={{ opacity: 0, scale: 0.8, x: position.includes('right') ? 10 : -10 }}\n            transition={{ duration: 0.2 }}\n            className={cn(\n              'absolute whitespace-nowrap px-3 py-2 bg-white text-gray-800 text-sm font-medium rounded-lg shadow-lg border border-gray-200',\n              'hidden sm:block', // Hide on mobile, show on desktop\n              labelPosition[position]\n            )}\n          >\n            {label}\n            {/* Arrow */}\n            <div\n              className={cn(\n                'absolute w-2 h-2 bg-white border transform rotate-45',\n                position.includes('right') \n                  ? 'left-[-4px] border-l-0 border-b-0 top-1/2 -translate-y-1/2' \n                  : 'right-[-4px] border-r-0 border-t-0 top-1/2 -translate-y-1/2'\n              )}\n            />\n          </motion.div>\n        )}\n      </AnimatePresence>\n\n      {/* Main Button */}\n      <motion.button\n        whileHover={{ scale: 1.05 }}\n        whileTap={{ scale: 0.95 }}\n        onClick={onToggle}\n        onMouseEnter={() => setIsHovered(true)}\n        onMouseLeave={() => setIsHovered(false)}\n        className={cn(\n          'relative flex items-center justify-center rounded-full shadow-lg transition-all duration-200 focus:outline-none focus:ring-4 focus:ring-opacity-50',\n          sizeClasses[size]\n        )}\n        style={{\n          backgroundColor: primaryColor,\n        }}\n        title={label}\n      >\n        {/* Pulse animation */}\n        <motion.div\n          animate={{\n            scale: [1, 1.2, 1],\n            opacity: [0.7, 0, 0.7],\n          }}\n          transition={{\n            duration: 2,\n            repeat: Infinity,\n            ease: \"easeInOut\",\n          }}\n          className=\"absolute inset-0 rounded-full\"\n          style={{ backgroundColor: primaryColor }}\n        />\n        \n        {/* Icon or Avatar */}\n        {avatarUrl ? (\n          <img\n            src={avatarUrl}\n            alt=\"Chat Avatar\"\n            className={cn(\n              iconSizes[size],\n              'relative z-10 rounded-full object-cover'\n            )}\n          />\n        ) : (\n          <MessageCircle \n            className={cn(iconSizes[size], 'text-white relative z-10')} \n          />\n        )}\n\n      </motion.button>\n    </div>\n  );\n};","import React from 'react';\nimport { createRoot } from 'react-dom/client';\nimport { Toaster } from 'sonner';\n\nimport '../app/globals.css';\nimport './widget-styles.css';\nimport { WidgetConfig, Conversation } from '../types';\nimport type { ConversationStore } from '../store/widget-stores/conversations';\nimport { useConfigStore, useAgentStore } from '../store';\nimport { ChatLayout } from '../components/chat/ChatLayout';\nimport { getClient } from '../lib/api/client';\nimport { WidgetProvider } from './WidgetContext';\nimport { WidgetStoreProvider } from './WidgetStoreContext';\nimport { WidgetToaster } from './isolated-toast';\nimport { widgetDebugger } from './debug-utils';\nimport { FloatingButton } from './FloatingButton';\n\n/**\n * Widget Configuration Interface\n * \n * Defines all configuration options for CustomGPT widget initialization.\n * This interface is used by both embedded widgets and floating buttons.\n * \n * @property agentId - Required: Agent/Project ID from CustomGPT dashboard\n * @property apiKey - Optional: API key for direct mode (bypasses proxy server)\n * @property apiUrl - Optional: Base URL for API (proxy URL or CustomGPT API URL)\n * @property useProxy - Optional: Force proxy mode even with API key (default: false)\n * @property agentName - Optional: Custom name to display instead of \"Agent - {ID}\"\n * @property containerId - DOM element ID for embedded mode (ignored in floating mode)\n * @property mode - Widget deployment mode: 'embedded' | 'floating' | 'widget'\n * @property theme - Color theme: 'light' | 'dark'\n * @property position - Position for floating mode: 'bottom-right' | 'bottom-left' | 'top-right' | 'top-left'\n * @property width - Widget width (default: '400px')\n * @property height - Widget height (default: '600px')\n * @property enableCitations - Show citation sources in messages\n * @property enableFeedback - Show thumbs up/down feedback buttons\n * \n * Conversation Management Options:\n * @property enableConversationManagement - Enable conversation switching UI\n * @property maxConversations - Maximum conversations per session (default: 5)\n * @property sessionId - Custom session ID (auto-generated if not provided)\n * @property threadId - Specific conversation thread to load\n * @property isolateConversations - Whether to isolate conversations from other widgets (default: true)\n * \n * Event Callbacks:\n * @property onOpen - Called when widget opens\n * @property onClose - Called when widget closes\n * @property onMessage - Called when new message is sent/received\n * @property onConversationChange - Called when conversation switches\n */\nexport interface CustomGPTWidgetConfig {\n  // Required properties\n  agentId: number | string;\n  \n  // API Configuration\n  apiKey?: string; // API key for direct mode (bypasses proxy)\n  apiUrl?: string; // Base URL for the API server (defaults to CustomGPT API or proxy)\n  useProxy?: boolean; // Whether to use proxy mode (default: true if no apiKey)\n  \n  // Display properties\n  agentName?: string;\n  containerId?: string;\n  mode?: 'embedded' | 'floating' | 'widget';\n  theme?: 'light' | 'dark';\n  position?: 'bottom-right' | 'bottom-left' | 'top-right' | 'top-left';\n  width?: string;\n  height?: string;\n  \n  // Floating button properties\n  primaryColor?: string;\n  buttonSize?: 'sm' | 'md' | 'lg';\n  showLabel?: boolean;\n  label?: string;\n  \n  // Feature flags\n  enableCitations?: boolean;\n  enableFeedback?: boolean;\n  enableConversationManagement?: boolean;\n  \n  // Conversation management\n  maxConversations?: number;\n  sessionId?: string;\n  threadId?: string;\n  isolateConversations?: boolean; // New flag to isolate conversations\n  \n  // Event callbacks\n  onOpen?: () => void;\n  onClose?: () => void;\n  onMessage?: (message: any) => void;\n  onConversationChange?: (conversation: any) => void;\n}\n\n/**\n * CustomGPT Widget Class\n * \n * Main widget class that manages the lifecycle of CustomGPT chat instances.\n * Supports both embedded and floating deployment modes with full conversation management.\n * Can operate in two modes:\n * - Proxy mode (default): Communicates through a Next.js server proxy\n * - Direct mode: Communicates directly with CustomGPT API using provided API key\n * \n * @example\n * // Basic embedded widget (proxy mode)\n * const widget = CustomGPTWidget.init({\n *   agentId: '123',\n *   containerId: 'chat-container',\n *   apiUrl: 'https://your-nextjs-app.com'\n * });\n * \n * @example\n * // Direct mode with API key (no proxy needed)\n * const widget = CustomGPTWidget.init({\n *   agentId: '123',\n *   apiKey: 'your-api-key',\n *   mode: 'floating',\n *   enableConversationManagement: true\n * });\n * \n * @example\n * // Floating widget with conversation management\n * const widget = CustomGPTWidget.init({\n *   agentId: '123',\n *   mode: 'floating',\n *   enableConversationManagement: true,\n *   maxConversations: 10\n * });\n */\nclass CustomGPTWidget {\n  private container: HTMLElement | null = null;\n  private root: any = null;\n  private config: CustomGPTWidgetConfig;\n  private isOpen: boolean = false;\n  public sessionId: string;\n  private currentConversationId: string | null = null;\n  private instanceKey?: string;\n  private conversationRefreshKey: number = 0;\n  private floatingButtonContainer: HTMLElement | null = null;\n  private floatingButtonRoot: any = null;\n  private agentAvatar: string | null = null;\n\n  constructor(config: CustomGPTWidgetConfig) {\n    // Validate required fields\n    \n    if (!config.agentId) {\n      throw new Error('CustomGPT Widget: Agent ID is required');\n    }\n\n    // Merge with defaults\n    this.config = {\n      mode: 'embedded',\n      theme: 'light',\n      position: 'bottom-right',\n      width: '400px',\n      height: '600px',\n      enableCitations: true,\n      enableFeedback: true,\n      enableConversationManagement: false, // Always false for widget mode\n      ...config,\n    };\n\n    // Initialize session ID\n    // For widget mode, use a persistent session ID based on agentId to maintain conversations across refreshes\n    if ((this.config.mode === 'widget' || this.config.mode === 'floating') && this.config.isolateConversations !== false) {\n      // Create a stable session ID for widgets that persists across refreshes\n      this.sessionId = `widget_session_${this.config.agentId}`;\n      \n      // Also store this as the persistent session for this agent\n      localStorage.setItem(`customgpt_widget_session_${this.config.agentId}`, this.sessionId);\n    } else if (this.config.isolateConversations !== false) {\n      // For other modes with isolated conversations, create unique session\n      const modePrefix = this.config.mode || 'widget';\n      const containerId = this.config.containerId || 'default';\n      // Create a unique session ID that includes mode, container info, and a random component\n      // Use performance.now() for higher precision to avoid collisions\n      const timestamp = typeof performance !== 'undefined' ? performance.now() : Date.now();\n      const random = Math.random().toString(36).substr(2, 9);\n      const uniqueId = `${timestamp}_${random}_${Math.random().toString(36).substr(2, 5)}`;\n      this.sessionId = `session_${modePrefix}_${containerId}_${uniqueId}`;\n    } else if (this.config.sessionId) {\n      // Use provided session ID for sharing conversations\n      this.sessionId = this.config.sessionId;\n    } else {\n      // Generate a regular session ID\n      this.sessionId = this.generateSessionId();\n    }\n    \n    // Store widget instance reference for conversation management\n    // Use unique instance key to prevent conflicts between multiple widgets\n    if (typeof window !== 'undefined') {\n      const instanceKey = `__customgpt_widget_${this.sessionId}`;\n      (window as any)[instanceKey] = this;\n      \n      // Also store in instances object for easier access\n      if (!(window as any).__customgpt_widget_instances) {\n        (window as any).__customgpt_widget_instances = {};\n      }\n      (window as any).__customgpt_widget_instances[this.sessionId] = this;\n      \n      // DEPRECATED: Global reference kept for backward compatibility\n      // Don't overwrite if already exists to preserve first widget\n      if (!(window as any).__customgpt_widget_instance) {\n        (window as any).__customgpt_widget_instance = this;\n      }\n      \n      // Store instance key for later reference\n      this.instanceKey = instanceKey;\n    }\n\n    this.init();\n  }\n\n  /**\n   * Generates a unique session ID for conversation isolation\n   * @returns Unique session identifier\n   */\n  private generateSessionId(): string {\n    return `session_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;\n  }\n\n  private async init() {\n    // Initialize API client based on configuration\n    const { initializeClient } = require('../lib/api/client');\n    \n    // Determine if using direct mode or proxy mode\n    const useDirectMode = this.config.apiKey && (this.config.useProxy !== true);\n    \n    if (useDirectMode) {\n      // Direct mode - API key provided, communicate directly with CustomGPT\n      initializeClient({\n        mode: 'direct',\n        apiKey: this.config.apiKey,\n        apiUrl: this.config.apiUrl || 'https://app.customgpt.ai/api/v1'\n      });\n    } else {\n      // Proxy mode - use Next.js server proxy\n      const proxyUrl = this.config.apiUrl || '';\n      initializeClient({\n        mode: 'proxy',\n        apiUrl: proxyUrl\n      });\n      \n      // Store globally for the API client to pick up\n      if (proxyUrl) {\n        (window as any).__customgpt_api_url = proxyUrl;\n      }\n    }\n    \n    // Configure session for conversation isolation\n    if (this.config.enableConversationManagement) {\n      // Store session configuration for conversation management\n      // If isolateConversations is true, use instance-specific session storage\n      if (this.config.isolateConversations) {\n        // Create instance-specific session object\n        if (!(window as any).__customgpt_sessions) {\n          (window as any).__customgpt_sessions = {};\n        }\n        (window as any).__customgpt_sessions[this.sessionId] = {\n          sessionId: this.sessionId,\n          maxConversations: this.config.maxConversations,\n          enableConversationManagement: true\n        };\n      } else {\n        // Use shared session (old behavior)\n        (window as any).__customgpt_session = {\n          sessionId: this.sessionId,\n          maxConversations: this.config.maxConversations,\n          enableConversationManagement: true\n        };\n      }\n    }\n    \n    // Check if using demo/test API key\n    const isDemoMode = false; // Demo mode removed as API key is server-side\n    \n    // Store demo mode flag for preventing unnecessary API calls\n    if (isDemoMode) {\n      (window as any).__customgpt_demo_mode = true;\n    } else {\n      // Ensure demo mode is disabled for valid API keys\n      (window as any).__customgpt_demo_mode = false;\n    }\n    \n    // Agent initialization is now handled by the widget-specific store\n    // The WidgetStoreProvider will create and initialize the agent store\n    // which includes proper error handling and fallback mechanisms\n\n    // Create container based on mode\n    this.createContainer();\n    \n    // For floating mode, create the floating button first\n    if (this.config.mode === 'floating') {\n      this.createFloatingButton();\n    }\n    \n    // Render the widget first\n    this.render();\n    \n    // For widget mode, always ensure a single conversation exists and is persisted\n    const persistedConversationId = localStorage.getItem(`customgpt_widget_conversation_${this.config.agentId}`);\n    \n    // Load existing conversations for this session\n    const existingConversations = this.getConversations();\n    \n    if (persistedConversationId && existingConversations.length > 0) {\n      // Find the persisted conversation in our saved conversations\n      const persistedConversation = existingConversations.find(c => c.id === persistedConversationId);\n      \n      if (persistedConversation) {\n        // Load the persisted conversation\n        this.currentConversationId = persistedConversationId;\n        \n        // Update the widget conversation store after a delay to ensure components are mounted\n        setTimeout(async () => {\n          if (typeof window !== 'undefined') {\n            const widgetStores = (window as any).__customgpt_widget_stores;\n            if (widgetStores && widgetStores[this.sessionId]) {\n              const conversationStore = widgetStores[this.sessionId].conversationStore;\n              const messageStore = widgetStores[this.sessionId].messageStore;\n              \n              if (conversationStore) {\n                // First, ensure the conversation is in the store\n                const existingConvs = conversationStore.getState().conversations;\n                const convExists = existingConvs.some((c: Conversation) => c.id === persistedConversation.id);\n                \n                if (!convExists) {\n                  // Add the conversation to the store's list\n                  conversationStore.getState().setSearchQuery(''); // Clear any filters\n                  conversationStore.setState((state: ConversationStore) => ({\n                    allConversations: [...state.allConversations, persistedConversation],\n                    conversations: [...state.conversations, persistedConversation]\n                  }));\n                }\n                \n                const fullConversation = {\n                  ...persistedConversation,\n                  id: parseInt(persistedConversation.id) || persistedConversation.id,\n                  project_id: parseInt(this.config.agentId as string) || 0,\n                  session_id: this.sessionId,\n                  name: persistedConversation.title || persistedConversation.name || 'Chat'\n                };\n                \n                console.log('[Widget] Restoring persisted conversation:', fullConversation);\n                conversationStore.getState().selectConversation(fullConversation as any);\n                \n                // Load messages for the persisted conversation\n                if (messageStore) {\n                  // Wait a bit to ensure the conversation is selected\n                  setTimeout(() => {\n                    console.log('[Widget] Loading messages for conversation:', persistedConversationId);\n                    messageStore.getState().loadMessages(persistedConversationId);\n                  }, 100);\n                }\n              }\n            }\n          }\n        }, 300);\n      } else {\n        // Persisted ID exists but conversation not found, create new\n        setTimeout(async () => {\n          const newConversation = await this.createConversation('Chat');\n          if (newConversation) {\n            localStorage.setItem(`customgpt_widget_conversation_${this.config.agentId}`, newConversation.id.toString());\n          }\n        }, 100);\n      }\n    } else {\n      // No persisted conversation or no conversations exist, create a new one\n      setTimeout(async () => {\n        const newConversation = await this.createConversation('Chat');\n        if (newConversation) {\n          // Persist the conversation ID\n          localStorage.setItem(`customgpt_widget_conversation_${this.config.agentId}`, newConversation.id.toString());\n        }\n      }, 100);\n    }\n    \n    // For isolated widgets, we need to prevent the global store from being used\n    if (this.config.isolateConversations !== false && typeof window !== 'undefined') {\n      // Store the widget instance globally so components can access it\n      (window as any).__customgpt_widget_instances = (window as any).__customgpt_widget_instances || {};\n      (window as any).__customgpt_widget_instances[this.sessionId] = this;\n      \n      // Set the current active widget session\n      (window as any).__customgpt_active_widget_session = this.sessionId;\n    }\n  }\n\n  private createContainer() {\n    const { mode, containerId } = this.config;\n\n    if (mode === 'embedded' && containerId) {\n      // Use provided container\n      this.container = document.getElementById(containerId);\n      if (!this.container) {\n        throw new Error(`Container with id \"${containerId}\" not found`);\n      }\n    } else if (mode === 'floating') {\n      // Create floating container\n      this.container = document.createElement('div');\n      this.container.id = 'customgpt-floating-widget';\n      this.setupFloatingStyles();\n      document.body.appendChild(this.container);\n    } else {\n      // Create default container\n      this.container = document.createElement('div');\n      this.container.id = 'customgpt-widget';\n      document.body.appendChild(this.container);\n    }\n  }\n\n  private setupFloatingStyles() {\n    if (!this.container || this.config.mode !== 'floating') return;\n\n    const { position, width, height } = this.config;\n    \n    // Base floating styles\n    Object.assign(this.container.style, {\n      position: 'fixed',\n      zIndex: '9999',\n      width: width || '400px',\n      height: height || '600px',\n      boxShadow: '0 10px 25px rgba(0, 0, 0, 0.2)',\n      borderRadius: '12px',\n      overflow: 'hidden',\n      transition: 'all 0.3s ease',\n      backgroundColor: 'white', // Ensure background is set\n    });\n    \n    // Add class for styling\n    this.container.classList.add('floating-mode');\n    this.container.classList.add('customgpt-floating-container');\n\n    // Position-specific styles\n    switch (position) {\n      case 'bottom-right':\n        Object.assign(this.container.style, {\n          bottom: '20px',\n          right: '20px',\n        });\n        break;\n      case 'bottom-left':\n        Object.assign(this.container.style, {\n          bottom: '20px',\n          left: '20px',\n        });\n        break;\n      case 'top-right':\n        Object.assign(this.container.style, {\n          top: '20px',\n          right: '20px',\n        });\n        break;\n      case 'top-left':\n        Object.assign(this.container.style, {\n          top: '20px',\n          left: '20px',\n        });\n        break;\n    }\n\n    // Initially hidden for floating mode with proper initial state\n    this.container.style.display = 'none';\n    this.container.style.opacity = '0';\n    this.container.style.transform = 'translateY(20px)';\n  }\n\n  private async fetchAgentAvatar() {\n    try {\n      const client = getClient();\n      // Convert agentId to number as required by the API\n      const agentId = typeof this.config.agentId === 'string' \n        ? parseInt(this.config.agentId, 10) \n        : this.config.agentId;\n      \n      const response = await client.getAgentSettings(agentId);\n      const settings = response.data || response;\n      \n      if (settings.chatbot_avatar) {\n        this.agentAvatar = settings.chatbot_avatar;\n        // Update floating button if it exists\n        if (this.floatingButtonRoot) {\n          this.createFloatingButton();\n        }\n      }\n    } catch (error) {\n      console.warn('Failed to fetch agent avatar:', error);\n    }\n  }\n\n  private createFloatingButton() {\n    if (this.config.mode !== 'floating') return;\n\n    // Create button container if it doesn't exist\n    if (!this.floatingButtonContainer) {\n      this.floatingButtonContainer = document.createElement('div');\n      this.floatingButtonContainer.id = 'customgpt-floating-button-container';\n      document.body.appendChild(this.floatingButtonContainer);\n    }\n\n    // Create or update the button root\n    if (!this.floatingButtonRoot) {\n      this.floatingButtonRoot = createRoot(this.floatingButtonContainer);\n    }\n\n    const FloatingButtonApp = () => {\n      return (\n        <FloatingButton\n          isOpen={this.isOpen}\n          onToggle={() => this.toggle()}\n          position={this.config.position}\n          primaryColor={this.config.primaryColor || '#007acc'}\n          size={this.config.buttonSize || 'md'}\n          showLabel={this.config.showLabel !== false}\n          label={this.config.label || 'Chat with us'}\n          avatarUrl={this.agentAvatar || undefined}\n        />\n      );\n    };\n\n    this.floatingButtonRoot.render(<FloatingButtonApp />);\n    \n    // Also fetch avatar if we don't have it yet\n    if (!this.agentAvatar) {\n      this.fetchAgentAvatar();\n    }\n  }\n\n  private render() {\n    if (!this.container) return;\n\n    // Apply proper styling based on mode\n    if (this.config.mode === 'embedded') {\n      this.container.classList.add('customgpt-embedded-widget');\n      // Apply width and height styles directly to container\n      Object.assign(this.container.style, {\n        width: this.config.width || '400px',\n        height: this.config.height || '600px',\n        margin: '0 auto', // Center by default\n        display: 'block',\n      });\n    }\n\n    // Only create root once\n    if (!this.root) {\n      this.root = createRoot(this.container);\n    }\n    \n    const WidgetApp = () => {\n      // DEPRECATED: This global reference is kept for backward compatibility\n      // New code should use WidgetContext instead\n      // Only set if not already set to avoid overwriting first widget\n      if (typeof window !== 'undefined' && !(window as any).__customgpt_widget_instance) {\n        (window as any).__customgpt_widget_instance = this;\n      }\n      \n      const handleClose = () => {\n        this.close();\n        this.config.onClose?.();\n      };\n\n      // Get current conversation ID or use thread ID\n      const currentConvId = this.currentConversationId || this.config.threadId;\n      \n      // For isolated mode, pass the widget instance to manage conversations locally\n      const widgetRef = this;\n      \n      // Create a unique key for this widget's conversations\n      const widgetKey = `widget_${this.sessionId}`;\n\n      return (\n        <WidgetStoreProvider sessionId={this.sessionId}>\n          <WidgetProvider widgetInstance={widgetRef}>\n            <div className={`customgpt-widget-wrapper widget-mode ${this.config.mode}-mode`}>\n              <ChatLayout\n                mode={this.config.mode === 'embedded' ? 'widget' : 'floating'}\n                onClose={this.config.mode === 'floating' ? handleClose : undefined}\n                showSidebar={false} // Disable sidebar for widget mode\n                className=\"w-full h-full\"\n                // Pass conversation management configuration\n                enableConversationManagement={this.config.enableConversationManagement}\n                maxConversations={this.config.maxConversations}\n                sessionId={this.sessionId}\n                threadId={currentConvId} // Pass current conversation ID\n                onConversationChange={this.config.onConversationChange}\n                onMessage={this.config.onMessage}\n                // Pass widget instance for isolated conversation management\n                widgetInstance={this.config.isolateConversations !== false ? widgetRef : undefined}\n                // Pass current conversations for isolated mode\n                conversations={this.config.isolateConversations !== false ? this.getConversations() : undefined}\n                currentConversation={this.config.isolateConversations !== false && this.currentConversationId ?\n                  this.getConversations().find(c => c.id === this.currentConversationId) : undefined}\n                // Pass refresh key to trigger ConversationManager updates\n                conversationRefreshKey={this.conversationRefreshKey}\n                // Pass citation configuration\n                enableCitations={this.config.enableCitations}\n              />\n              <WidgetToaster sessionId={this.sessionId} />\n            </div>\n          </WidgetProvider>\n        </WidgetStoreProvider>\n      );\n    };\n\n    this.root.render(<WidgetApp />);\n\n    // Auto-open for embedded mode\n    if (this.config.mode === 'embedded') {\n      this.open();\n    }\n  }\n\n  /**\n   * Get all conversations for current session\n   * @returns Array of conversations\n   */\n  public getConversations(): any[] {\n    const stored = localStorage.getItem(`customgpt_conversations_${this.sessionId}`);\n    if (stored) {\n      try {\n        return JSON.parse(stored);\n      } catch (e) {\n        console.error('Failed to parse conversations:', e);\n      }\n    }\n    return [];\n  }\n\n  /**\n   * Switch to a different conversation\n   * @param conversationId - ID of conversation to switch to\n   */\n  public switchConversation(conversationId: string): void {\n    widgetDebugger.log('WIDGET', 'switchConversation called', {\n      conversationId,\n      conversationIdType: typeof conversationId,\n      sessionId: this.sessionId,\n      isolateConversations: this.config.isolateConversations,\n      currentConversations: this.getConversations().map(c => ({\n        id: c.id,\n        idType: typeof c.id,\n        title: c.title\n      }))\n    });\n    \n    const conversations = this.getConversations();\n    const conversation = conversations.find(c => c.id === conversationId || c.id === parseInt(conversationId));\n    \n    widgetDebugger.log('WIDGET', 'Found conversation', {\n      found: !!conversation,\n      conversationId,\n      searchedId: conversationId,\n      conversationDetails: conversation ? {\n        id: conversation.id,\n        idType: typeof conversation.id,\n        title: conversation.title,\n        session_id: conversation.session_id\n      } : null\n    });\n    \n    if (conversation) {\n      this.currentConversationId = conversationId;\n      \n      // Increment refresh key to trigger ConversationManager update\n      this.conversationRefreshKey++;\n      \n      // Load messages for the new conversation from widget store\n      if (this.config.isolateConversations !== false && typeof window !== 'undefined') {\n        // Get the widget's message store and load messages\n        const widgetStores = (window as any).__customgpt_widget_stores;\n        \n        widgetDebugger.log('WIDGET', 'Accessing widget stores', {\n          hasWidgetStores: !!widgetStores,\n          sessionId: this.sessionId,\n          hasSessionStore: widgetStores && !!widgetStores[this.sessionId],\n          availableSessions: widgetStores ? Object.keys(widgetStores) : []\n        });\n        \n        if (widgetStores && widgetStores[this.sessionId]) {\n          const messageStore = widgetStores[this.sessionId].messageStore;\n          const conversationStore = widgetStores[this.sessionId].conversationStore;\n          \n          if (messageStore) {\n            // Load messages for this conversation\n            widgetDebugger.log('WIDGET', 'Loading messages via store', {\n              conversationId,\n              storeHasLoadMessages: typeof messageStore.getState().loadMessages === 'function'\n            });\n            \n            widgetDebugger.traceMessageFlow('SWITCH_CONVERSATION', {\n              conversationId,\n              sessionId: this.sessionId,\n              action: 'Loading messages'\n            });\n            \n            // Ensure conversationId is a string for consistency\n            const convIdStr = String(conversationId);\n            widgetDebugger.log('WIDGET', 'Calling loadMessages with string ID', {\n              originalId: conversationId,\n              stringId: convIdStr,\n              typeOfOriginal: typeof conversationId\n            });\n            messageStore.getState().loadMessages(convIdStr);\n          }\n          \n          if (conversationStore) {\n            // Update the conversation store's currentConversation\n            widgetDebugger.log('WIDGET', 'Updating conversation store', {\n              conversationId: conversation.id,\n              conversationIdType: typeof conversation.id\n            });\n            \n            const fullConversation = {\n              ...conversation,\n              id: parseInt(conversation.id) || conversation.id, // Ensure proper ID type\n              project_id: parseInt(this.config.agentId as string) || 0,\n              session_id: this.sessionId,\n              name: conversation.title\n            };\n            conversationStore.getState().selectConversation(fullConversation as any);\n          }\n        } else {\n          widgetDebugger.log('WIDGET', 'Widget stores not found', {\n            sessionId: this.sessionId,\n            availableStores: Object.keys(widgetStores || {})\n          }, 'error');\n        }\n      }\n      \n      // Don't update the global store if we're in isolated mode\n      // The render() method will handle passing the correct conversation\n      if (!this.config.isolateConversations) {\n        // Only update global store if sharing conversations\n        if (typeof window !== 'undefined') {\n          const { useConversationStore } = require('../store');\n          \n          // Get all widget conversations\n          const allWidgetConversations = this.getConversations();\n          \n          // Convert all widget conversations to store format\n          const storeConversations = allWidgetConversations.map(conv => ({\n            ...conv,\n            project_id: parseInt(this.config.agentId as string) || 0,\n            session_id: this.sessionId,\n            name: conv.title\n          }));\n          \n          // Find the selected conversation with proper format\n          const fullConversation = storeConversations.find(c => c.id === conversationId);\n          \n          // Update store with all widget conversations\n          useConversationStore.setState({\n            conversations: storeConversations as any,\n            currentConversation: fullConversation as any\n          });\n        }\n      }\n      \n      // Trigger re-render with new conversation\n      this.render();\n      this.config.onConversationChange?.(conversation);\n    }\n  }\n\n  /**\n   * Create a new conversation\n   * @param title - Optional title for the conversation\n   * @returns The new conversation object\n   */\n  public async createConversation(title?: string): Promise<any> {\n    const conversations = this.getConversations();\n    \n    // Check max conversations limit (only if specified by user)\n    if (this.config.maxConversations && conversations.length >= this.config.maxConversations) {\n      console.warn(`Maximum conversation limit (${this.config.maxConversations}) reached`);\n      return null; // Return null instead of throwing error\n    }\n    \n    // Use the conversation store to create a proper API conversation\n    if (this.config.isolateConversations !== false && typeof window !== 'undefined') {\n      const widgetStores = (window as any).__customgpt_widget_stores;\n      if (widgetStores && widgetStores[this.sessionId]) {\n        const conversationStore = widgetStores[this.sessionId].conversationStore;\n        const messageStore = widgetStores[this.sessionId].messageStore;\n        \n        if (conversationStore) {\n          try {\n            // Create conversation via the store (which uses API)\n            await conversationStore.getState().createConversation(\n              parseInt(this.config.agentId as string) || 0,\n              title || `Conversation ${conversations.length + 1}`\n            );\n            \n            // Get the newly created conversation\n            const newConversation = conversationStore.getState().currentConversation;\n            \n            if (newConversation) {\n              // Add to widget's local conversation list\n              const widgetConversation = {\n                id: newConversation.id.toString(), // Ensure string ID for consistency\n                title: newConversation.name || title || `Conversation ${conversations.length + 1}`,\n                createdAt: newConversation.created_at || new Date().toISOString(),\n                messages: [],\n                project_id: newConversation.project_id,\n                session_id: newConversation.session_id,\n                name: newConversation.name\n              };\n              \n              conversations.unshift(widgetConversation);\n              this.saveConversations(conversations);\n              this.currentConversationId = widgetConversation.id;\n              \n              // Persist the conversation ID for widget mode\n              localStorage.setItem(`customgpt_widget_conversation_${this.config.agentId}`, widgetConversation.id.toString());\n              \n              // Don't clear messages - they should persist\n              \n              // Increment refresh key to trigger ConversationManager update\n              this.conversationRefreshKey++;\n              \n              // Trigger re-render with new conversation\n              this.render();\n              \n              return widgetConversation;\n            }\n          } catch (error) {\n            console.error('Failed to create conversation via API:', error);\n            // Fall back to local creation if API fails\n          }\n        }\n      }\n    }\n    \n    // Fallback: Create conversation locally if API creation fails\n    const newConversation = {\n      id: `conv_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,\n      title: title || `Conversation ${conversations.length + 1}`,\n      createdAt: new Date().toISOString(),\n      messages: [],\n      project_id: parseInt(this.config.agentId as string) || 0,\n      session_id: this.sessionId,\n      name: title || `Conversation ${conversations.length + 1}`\n    };\n    \n    conversations.unshift(newConversation);\n    this.saveConversations(conversations);\n    this.currentConversationId = newConversation.id;\n    \n    // Persist the conversation ID for widget mode\n    localStorage.setItem(`customgpt_widget_conversation_${this.config.agentId}`, newConversation.id.toString());\n    \n    // Increment refresh key to trigger ConversationManager update\n    this.conversationRefreshKey++;\n    \n    // Trigger re-render with new conversation\n    this.render();\n    \n    return newConversation;\n  }\n\n  /**\n   * Update conversation title\n   * @param conversationId - ID of conversation to update\n   * @param newTitle - New title for the conversation\n   */\n  public updateConversationTitle(conversationId: string, newTitle: string): void {\n    const conversations = this.getConversations();\n    const conversation = conversations.find(c => c.id === conversationId);\n    \n    if (conversation) {\n      conversation.title = newTitle;\n      this.saveConversations(conversations);\n      // Increment refresh key to trigger ConversationManager update\n      this.conversationRefreshKey++;\n      this.render();\n    }\n  }\n\n  /**\n   * Delete a conversation\n   * @param conversationId - ID of conversation to delete\n   */\n  public deleteConversation(conversationId: string): void {\n    const conversations = this.getConversations();\n    const filtered = conversations.filter(c => c.id !== conversationId);\n    \n    this.saveConversations(filtered);\n    \n    // Increment refresh key to trigger ConversationManager update\n    this.conversationRefreshKey++;\n    \n    // If deleting current conversation, switch to another or create new\n    if (this.currentConversationId === conversationId) {\n      if (filtered.length > 0) {\n        this.switchConversation(filtered[0].id);\n      } else {\n        this.createConversation().catch(err => \n          console.error('Failed to create conversation after deletion:', err)\n        );\n      }\n    } else {\n      // Still need to re-render to update the conversation list\n      this.render();\n    }\n  }\n\n  /**\n   * Save conversations to localStorage\n   * @param conversations - Array of conversations to save\n   */\n  private saveConversations(conversations: any[]): void {\n    try {\n      localStorage.setItem(\n        `customgpt_conversations_${this.sessionId}`,\n        JSON.stringify(conversations)\n      );\n    } catch (e) {\n      console.error('Failed to save conversations:', e);\n      // Handle quota exceeded error\n      if (e instanceof DOMException && e.name === 'QuotaExceededError') {\n        // Try to clean up old conversations\n        this.cleanupOldConversations();\n      }\n    }\n  }\n\n  /**\n   * Clean up old conversations to free up localStorage space\n   */\n  private cleanupOldConversations(): void {\n    const conversations = this.getConversations();\n    // Keep only the 3 most recent conversations\n    const recent = conversations.slice(0, 3);\n    this.saveConversations(recent);\n  }\n\n  // Public methods\n  public open() {\n    if (!this.container) return;\n\n    this.isOpen = true;\n    \n    if (this.config.mode === 'floating') {\n      this.container.style.display = 'block';\n      // Trigger animation\n      setTimeout(() => {\n        if (this.container) {\n          this.container.style.transform = 'translateY(0)';\n          this.container.style.opacity = '1';\n        }\n      }, 10);\n      \n      // Update floating button\n      if (this.floatingButtonRoot) {\n        this.createFloatingButton();\n      }\n    }\n\n    this.config.onOpen?.();\n  }\n\n  public close() {\n    if (!this.container) return;\n\n    this.isOpen = false;\n\n    if (this.config.mode === 'floating') {\n      this.container.style.transform = 'translateY(20px)';\n      this.container.style.opacity = '0';\n      \n      setTimeout(() => {\n        if (this.container) {\n          this.container.style.display = 'none';\n        }\n      }, 300);\n      \n      // Update floating button\n      if (this.floatingButtonRoot) {\n        this.createFloatingButton();\n      }\n    }\n  }\n\n  public toggle() {\n    if (this.isOpen) {\n      this.close();\n    } else {\n      this.open();\n    }\n  }\n\n  public destroy() {\n    if (this.root) {\n      this.root.unmount();\n    }\n    \n    if (this.container && this.container.parentNode) {\n      this.container.parentNode.removeChild(this.container);\n    }\n    \n    // Clean up floating button\n    if (this.floatingButtonRoot) {\n      this.floatingButtonRoot.unmount();\n    }\n    \n    if (this.floatingButtonContainer && this.floatingButtonContainer.parentNode) {\n      this.floatingButtonContainer.parentNode.removeChild(this.floatingButtonContainer);\n    }\n    \n    // Clean up widget stores\n    if (typeof window !== 'undefined') {\n      const widgetStores = (window as any).__customgpt_widget_stores;\n      if (widgetStores && widgetStores[this.sessionId]) {\n        delete widgetStores[this.sessionId];\n      }\n      \n      // Clean up widget instance references\n      const instances = (window as any).__customgpt_widget_instances;\n      if (instances && instances[this.sessionId]) {\n        delete instances[this.sessionId];\n      }\n      \n      if (this.instanceKey) {\n        delete (window as any)[this.instanceKey];\n      }\n    }\n    \n    this.container = null;\n    this.root = null;\n    this.floatingButtonContainer = null;\n    this.floatingButtonRoot = null;\n  }\n\n  public updateConfig(newConfig: Partial<CustomGPTWidgetConfig>) {\n    this.config = { ...this.config, ...newConfig };\n    \n    // Re-render with new config\n    this.render();\n  }\n  \n  /**\n   * Force a re-render of the widget\n   * Useful for updating the UI after state changes\n   */\n  public refresh() {\n    this.render();\n  }\n\n  // Getters\n  public get isOpened() {\n    return this.isOpen;\n  }\n\n  public get configuration() {\n    return { ...this.config };\n  }\n}\n\n// Global API for the widget\ndeclare global {\n  interface Window {\n    CustomGPTWidget: {\n      init: (config: CustomGPTWidgetConfig) => CustomGPTWidget;\n      create: (config: CustomGPTWidgetConfig) => CustomGPTWidget;\n    };\n  }\n}\n\n// Export for UMD build\nconst CustomGPTWidgetAPI = {\n  init: (config: CustomGPTWidgetConfig): CustomGPTWidget => {\n    return new CustomGPTWidget(config);\n  },\n  \n  create: (config: CustomGPTWidgetConfig): CustomGPTWidget => {\n    return new CustomGPTWidget(config);\n  },\n};\n\n// Global assignment for browser usage\nif (typeof window !== 'undefined') {\n  window.CustomGPTWidget = CustomGPTWidgetAPI;\n}\n\n// For module usage\nexport { CustomGPTWidget, CustomGPTWidgetAPI };\nexport default CustomGPTWidgetAPI;","function webpackEmptyContext(req) {\n\tvar e = new Error(\"Cannot find module '\" + req + \"'\");\n\te.code = 'MODULE_NOT_FOUND';\n\tthrow e;\n}\nwebpackEmptyContext.keys = () => ([]);\nwebpackEmptyContext.resolve = webpackEmptyContext;\nwebpackEmptyContext.id = 24687;\nmodule.exports = webpackEmptyContext;","import { create } from 'zustand';\nimport { persist } from 'zustand/middleware';\nimport type { AgentSettings } from '@/types';\n\ninterface ChatSettingsState {\n  // Current chat settings per agent\n  settings: Record<number, Partial<AgentSettings>>;\n  \n  // Get settings for a specific agent\n  getSettings: (agentId: number) => Partial<AgentSettings>;\n  \n  // Update settings for a specific agent\n  updateSettings: (agentId: number, updates: Partial<AgentSettings>) => void;\n  \n  // Clear settings for an agent\n  clearSettings: (agentId: number) => void;\n}\n\nexport const useChatSettingsStore = create<ChatSettingsState>()(\n  persist(\n    (set, get) => ({\n      settings: {},\n\n      getSettings: (agentId: number) => {\n        const settings = get().settings[agentId] || {};\n        return {\n          response_source: settings.response_source || 'own_content',\n          chatbot_model: settings.chatbot_model || 'gpt-4-o',\n          custom_persona: settings.custom_persona || 'professional',\n          agent_capability: settings.agent_capability || 'optimal-choice',\n          ...settings,\n        };\n      },\n\n      updateSettings: (agentId: number, updates: Partial<AgentSettings>) => {\n        set((state) => ({\n          settings: {\n            ...state.settings,\n            [agentId]: {\n              ...state.settings[agentId],\n              ...updates,\n            },\n          },\n        }));\n      },\n\n      clearSettings: (agentId: number) => {\n        set((state) => {\n          const newSettings = { ...state.settings };\n          delete newSettings[agentId];\n          return { settings: newSettings };\n        });\n      },\n    }),\n    {\n      name: 'customgpt-chat-settings',\n    }\n  )\n);","/**\n * Error Messages for Demo Mode\n */\n\nexport const DEMO_ERROR_MESSAGES = {\n  RATE_LIMIT: {\n    title: 'Rate Limit Reached',\n    message: 'The free trial is experiencing high demand. Please wait a moment and try again.',\n    retryAfter: 60, // seconds\n  },\n  SESSION_EXPIRED: {\n    title: 'Session Expired',\n    message: 'Your free trial session has expired. Please refresh the page to start a new session.',\n  },\n  LIMIT_REACHED: {\n    title: 'Limit Reached',\n    message: 'You have reached the maximum allowed for this free trial session.',\n  },\n  API_ERROR: {\n    title: 'Service Error',\n    message: 'Unable to process your request. Please try again later.',\n  },\n};\n\nexport function getErrorMessage(status: number, isFreeTrialMode: boolean): { title: string; message: string } {\n  if (status === 429 && isFreeTrialMode) {\n    return DEMO_ERROR_MESSAGES.RATE_LIMIT;\n  }\n  \n  if (status === 403 && isFreeTrialMode) {\n    return DEMO_ERROR_MESSAGES.LIMIT_REACHED;\n  }\n  \n  if (status >= 500) {\n    return DEMO_ERROR_MESSAGES.API_ERROR;\n  }\n  \n  return {\n    title: 'Error',\n    message: 'An unexpected error occurred. Please try again.',\n  };\n}","/**\n * Proxy API Client\n * \n * This client communicates with our Next.js API routes which proxy\n * requests to CustomGPT. The API key is stored securely on the server.\n */\n\nimport type {\n  Agent,\n  AgentStats,\n  AgentSettings,\n  Conversation,\n  ChatMessage,\n  Citation,\n  APIResponse,\n  AgentsResponse,\n  ConversationsResponse,\n  MessagesResponse,\n  MessageResponse,\n  CitationResponse,\n  StreamChunk,\n  LimitsResponse,\n  UserProfile,\n  CustomerIntelligenceResponse,\n} from '@/types';\nimport type { APIMessageResponse } from '@/types/message.types';\nimport type { \n  PagesListResponse, \n  DeletePageResponse, \n  ReindexPageResponse, \n  PagesQueryParams,\n  PageMetadata,\n  PageMetadataResponse\n} from '@/types/pages.types';\nimport type { \n  TrafficReportResponse, \n  QueriesReportResponse, \n  ConversationsReportResponse, \n  AnalysisReportResponse,\n  AnalysisInterval\n} from '@/types/reports.types';\nimport type { \n  SourcesListResponse, \n  SourceResponse, \n  DeleteSourceResponse,\n  UpdateSourceSettingsRequest,\n  CreateSitemapSourceRequest\n} from '@/types/sources.types';\nimport { parseStreamChunk, retryWithBackoff } from '@/lib/utils';\nimport { logger } from '@/lib/logger';\nimport { usageTracker } from '@/lib/analytics/usage-tracker';\nimport { getErrorMessage } from '@/lib/constants/error-messages';\n\ninterface UserProfileResponse {\n  status: 'success' | 'error';\n  data: UserProfile;\n}\n\n/**\n * ProxyCustomGPTClient\n * \n * Client that communicates with our server-side proxy endpoints.\n * No API key is needed client-side as it's stored on the server.\n */\nexport class ProxyCustomGPTClient {\n  private baseURL: string = '/api/proxy';\n  private timeout: number = 30000;\n  private abortControllers: Map<string, AbortController> = new Map();\n  private isDemoMode: boolean = false;\n  private demoApiKey: string | null = null;\n\n  constructor() {\n    // Demo mode is determined at runtime from localStorage\n    if (typeof window !== 'undefined') {\n      const deploymentMode = localStorage.getItem('customgpt.deploymentMode');\n      this.isDemoMode = deploymentMode === 'demo';\n      \n      // Check if there's a global API URL configuration for widgets\n      const globalApiUrl = (window as any).__customgpt_api_url;\n      if (globalApiUrl) {\n        this.baseURL = `${globalApiUrl}/api/proxy`;\n      }\n    }\n    \n    logger.info('PROXY_CLIENT', 'Proxy API Client initialized', {\n      baseURL: this.baseURL,\n      timeout: this.timeout,\n      isDemoMode: this.isDemoMode,\n    });\n  }\n  \n  /**\n   * Set the base API URL (for widget usage)\n   */\n  public setApiUrl(apiUrl: string) {\n    this.baseURL = `${apiUrl}/api/proxy`;\n    logger.info('PROXY_CLIENT', 'API URL updated', { baseURL: this.baseURL });\n  }\n  \n  /**\n   * Set demo mode API key\n   */\n  public setDemoApiKey(apiKey: string | null) {\n    this.demoApiKey = apiKey;\n  }\n\n  /**\n   * Make a request to the proxy API\n   */\n  private async request<T>(\n    endpoint: string,\n    options: RequestInit = {}\n  ): Promise<T> {\n    const url = `${this.baseURL}${endpoint}`;\n    const requestId = `${options.method || 'GET'}-${endpoint}-${Date.now()}`;\n    \n    logger.apiRequest(endpoint, options.method || 'GET', options.body);\n\n    try {\n      const controller = new AbortController();\n      this.abortControllers.set(requestId, controller);\n\n      const timeoutId = setTimeout(() => {\n        controller.abort();\n      }, this.timeout);\n\n      // Don't set Content-Type for FormData - let browser set it with boundary\n      const isFormData = options.body instanceof FormData;\n      const baseHeaders: Record<string, string> = {\n        ...(options.headers as Record<string, string> || {})\n      };\n      \n      // Add deployment mode header\n      const deploymentMode = typeof window !== 'undefined' \n        ? localStorage.getItem('customgpt.deploymentMode') || 'production'\n        : 'production';\n      baseHeaders['X-Deployment-Mode'] = deploymentMode;\n      \n      // Check if free trial mode\n      const isFreeTrialMode = typeof window !== 'undefined' \n        ? localStorage.getItem('customgpt.freeTrialMode') === 'true'\n        : false;\n      \n      if (isFreeTrialMode) {\n        baseHeaders['X-Free-Trial-Mode'] = 'true';\n        \n        // Add session ID from session storage\n        const sessionData = sessionStorage.getItem('customgpt.freeTrialSession');\n        if (sessionData) {\n          try {\n            const session = JSON.parse(sessionData);\n            if (session.sessionId) {\n              baseHeaders['X-Demo-Session-ID'] = session.sessionId;\n            }\n          } catch (e) {\n            console.error('[ProxyClient] Failed to parse session data:', e);\n          }\n        }\n        \n        console.log('[ProxyClient] Free trial mode - using server-side demo key');\n      } else if (deploymentMode === 'demo' && this.demoApiKey) {\n        // Add demo mode API key if available\n        baseHeaders['X-CustomGPT-API-Key'] = this.demoApiKey;\n        console.log('[ProxyClient] Added demo API key to request headers');\n      } else if (deploymentMode === 'demo' && !this.demoApiKey) {\n        console.warn('[ProxyClient] Demo mode but no API key available for request');\n      }\n      \n      // Add Turnstile token if available for anonymous users\n      if (typeof window !== 'undefined') {\n        try {\n          // Check for Turnstile token in localStorage or sessionStorage\n          const turnstileToken = sessionStorage.getItem('customgpt.turnstileToken') || \n                               localStorage.getItem('customgpt.turnstileToken');\n          if (turnstileToken) {\n            const tokenData = JSON.parse(turnstileToken);\n            // Check if token is still valid (not expired)\n            if (tokenData.expiresAt && Date.now() < tokenData.expiresAt) {\n              baseHeaders['X-Turnstile-Token'] = tokenData.token;\n              baseHeaders['X-Turnstile-Action'] = 'api-request';\n            }\n          }\n        } catch (e) {\n          // Ignore token parsing errors\n          console.warn('[ProxyClient] Failed to parse Turnstile token:', e);\n        }\n      }\n      \n      const headers: HeadersInit = isFormData \n        ? baseHeaders\n        : { \n            'Content-Type': 'application/json',\n            ...baseHeaders\n          };\n      \n      const response = await fetch(url, {\n        ...options,\n        headers,\n        signal: controller.signal,\n      });\n\n      clearTimeout(timeoutId);\n      this.abortControllers.delete(requestId);\n\n      // Check if response has content before trying to parse JSON\n      let responseData;\n      const contentLength = response.headers.get('content-length');\n      const contentType = response.headers.get('content-type');\n      \n      if (contentLength === '0' || (!contentType?.includes('application/json') && response.status === 200)) {\n        // Empty response or non-JSON success response\n        responseData = { status: 'success', data: { updated: true } };\n      } else {\n        try {\n          const text = await response.text();\n          if (text.trim() === '') {\n            // Empty response body\n            responseData = { status: 'success', data: { updated: true } };\n          } else {\n            responseData = JSON.parse(text);\n          }\n        } catch (jsonError) {\n          // Failed to parse JSON, but response was successful\n          if (response.ok) {\n            responseData = { status: 'success', data: { updated: true } };\n          } else {\n            throw new Error(`Failed to parse response: ${jsonError}`);\n          }\n        }\n      }\n\n      // Track API call\n      usageTracker.trackApiCall(endpoint, options.method || 'GET', response.status);\n\n      if (!response.ok) {\n        // Track error\n        usageTracker.trackError(`API Error: ${response.status}`, {\n          endpoint,\n          method: options.method || 'GET',\n          error: responseData.error\n        });\n        \n        // Get user-friendly error message for demo mode\n        const isFreeTrialMode = baseHeaders['X-Free-Trial-Mode'] === 'true';\n        const errorInfo = getErrorMessage(response.status, isFreeTrialMode);\n        \n        throw {\n          message: responseData.error || errorInfo.message,\n          status: response.status,\n          data: responseData,\n          title: errorInfo.title,\n          isFreeTrialError: isFreeTrialMode && response.status === 429,\n        };\n      }\n\n      logger.apiResponse(endpoint, response.status, responseData);\n      return responseData;\n    } catch (error: any) {\n      this.abortControllers.delete(requestId);\n      \n      if (error.name === 'AbortError') {\n        logger.apiError(endpoint, { message: 'Request timeout', code: 'TIMEOUT' });\n        throw new Error('Request timeout');\n      }\n\n      logger.apiError(endpoint, error);\n      throw error;\n    }\n  }\n\n  /**\n   * Make a streaming request to the proxy API\n   */\n  private async streamRequest(\n    endpoint: string,\n    options: RequestInit = {}\n  ): Promise<ReadableStream<Uint8Array>> {\n    const url = `${this.baseURL}${endpoint}`;\n    \n    logger.apiRequest(endpoint, 'POST-STREAM', options.body);\n\n    // Build headers with demo mode support\n    const baseHeaders: Record<string, string> = {\n      'Content-Type': 'application/json',\n      'Accept': 'text/event-stream',\n      ...(options.headers as Record<string, string> || {})\n    };\n    \n    // Add deployment mode header\n    const deploymentMode = typeof window !== 'undefined' \n      ? localStorage.getItem('customgpt.deploymentMode') || 'production'\n      : 'production';\n    baseHeaders['X-Deployment-Mode'] = deploymentMode;\n    \n    // Check if free trial mode\n    const isFreeTrialMode = typeof window !== 'undefined' \n      ? localStorage.getItem('customgpt.freeTrialMode') === 'true'\n      : false;\n    \n    if (isFreeTrialMode) {\n      baseHeaders['X-Free-Trial-Mode'] = 'true';\n      \n      // Add session ID from session storage\n      const sessionData = sessionStorage.getItem('customgpt.freeTrialSession');\n      if (sessionData) {\n        try {\n          const session = JSON.parse(sessionData);\n          if (session.sessionId) {\n            baseHeaders['X-Demo-Session-ID'] = session.sessionId;\n          }\n        } catch (e) {\n          console.error('[ProxyClient] Failed to parse session data:', e);\n        }\n      }\n      \n      console.log('[ProxyClient] Free trial mode - using server-side demo key for streaming');\n    } else if (deploymentMode === 'demo' && this.demoApiKey) {\n      // Add demo mode API key if available\n      baseHeaders['X-CustomGPT-API-Key'] = this.demoApiKey;\n      console.log('[ProxyClient] Added demo API key to streaming request headers');\n    } else if (deploymentMode === 'demo' && !this.demoApiKey) {\n      console.warn('[ProxyClient] Demo mode but no API key available for streaming request');\n    }\n\n    const response = await fetch(url, {\n      ...options,\n      headers: baseHeaders,\n    });\n\n    if (!response.ok) {\n      let errorMessage = `Stream request failed: ${response.status}`;\n      try {\n        const errorText = await response.text();\n        const errorData = JSON.parse(errorText);\n        errorMessage = errorData.error || errorData.message || errorMessage;\n      } catch {\n        // If not JSON, use the status message\n      }\n      logger.apiError(endpoint, { message: errorMessage, status: response.status });\n      throw new Error(errorMessage);\n    }\n\n    logger.apiResponse(endpoint, response.status, 'Stream started');\n\n    return response.body!;\n  }\n\n  /**\n   * Cancel a specific request\n   */\n  cancelRequest(endpoint: string, method: string = 'GET'): void {\n    const controllers = Array.from(this.abortControllers.entries());\n    controllers.forEach(([key, controller]) => {\n      if (key.includes(`${method}-${endpoint}`)) {\n        controller.abort();\n        this.abortControllers.delete(key);\n      }\n    });\n  }\n\n  /**\n   * Cancel all pending requests\n   */\n  cancelAllRequests(): void {\n    this.abortControllers.forEach(controller => controller.abort());\n    this.abortControllers.clear();\n  }\n\n  // Agent Management\n  async getAgents(params?: {\n    page?: number;\n    per_page?: number;\n  }): Promise<AgentsResponse> {\n    const queryParams = new URLSearchParams();\n    if (params?.page) queryParams.append('page', params.page.toString());\n    if (params?.per_page) queryParams.append('per_page', params.per_page.toString());\n    \n    const queryString = queryParams.toString();\n    return this.request(`/projects${queryString ? `?${queryString}` : ''}`);\n  }\n\n  async createAgent(data: {\n    project_name: string;\n    sitemap_path?: string;\n    file_upload?: boolean;\n    webpage_url?: string;\n  }): Promise<APIResponse<Agent>> {\n    return this.request('/projects', {\n      method: 'POST',\n      body: JSON.stringify(data),\n    });\n  }\n\n  async getAgent(id: number): Promise<APIResponse<Agent>> {\n    return this.request(`/projects/${id}`);\n  }\n\n  async updateAgent(id: number, data: { project_name?: string; are_licenses_allowed?: boolean; is_shared?: boolean; sitemap_path?: string }): Promise<APIResponse<Agent>> {\n    console.log('[ProxyClient] updateAgent called with:', { id, data });\n    \n    // Use FormData for multipart/form-data as specified in OpenAPI\n    const formData = new FormData();\n    Object.entries(data).forEach(([key, value]) => {\n      if (value !== undefined) {\n        formData.append(key, String(value));\n        console.log('[ProxyClient] FormData append:', key, value);\n      }\n    });\n\n    const response = await this.request<APIResponse<Agent>>(`/projects/${id}`, {\n      method: 'POST', // Changed from PUT to POST as per OpenAPI spec\n      body: formData,\n    });\n    \n    console.log('[ProxyClient] updateAgent response:', response);\n    return response;\n  }\n\n  async deleteAgent(id: number): Promise<APIResponse<{ deleted: boolean }>> {\n    return this.request(`/projects/${id}`, {\n      method: 'DELETE',\n    });\n  }\n\n  async replicateAgent(id: number): Promise<APIResponse<Agent>> {\n    return this.request(`/projects/${id}/replicate`, {\n      method: 'POST',\n    });\n  }\n\n  async getAgentStats(id: number): Promise<APIResponse<AgentStats>> {\n    return this.request(`/projects/${id}/stats`);\n  }\n\n  async getAgentSettings(id: number): Promise<APIResponse<AgentSettings>> {\n    return this.request(`/projects/${id}/settings`);\n  }\n\n  async updateAgentSettings(id: number, settings: Partial<AgentSettings> | FormData): Promise<APIResponse<AgentSettings>> {\n    const isFormData = settings instanceof FormData;\n    return this.request(`/projects/${id}/settings`, {\n      method: 'POST',\n      body: isFormData ? settings : JSON.stringify(settings),\n      headers: isFormData ? {} : { 'Content-Type': 'application/json' },\n    });\n  }\n\n  // Plugin Management\n  async getProjectPlugins(projectId: number): Promise<APIResponse<any[]>> {\n    return this.request(`/projects/${projectId}/plugins`);\n  }\n\n  async updateProjectPlugin(\n    projectId: number,\n    pluginId: string,\n    data: { enabled: boolean }\n  ): Promise<APIResponse<{ updated: boolean }>> {\n    return this.request(`/projects/${projectId}/plugins/${pluginId}`, {\n      method: 'PUT',\n      body: JSON.stringify(data),\n    });\n  }\n\n  // Conversation Management\n  async getConversations(projectId: number, params?: {\n    page?: number;\n    per_page?: number;\n    order?: 'asc' | 'desc';\n    orderBy?: string;\n    userFilter?: 'all' | 'me' | string;\n  }): Promise<ConversationsResponse> {\n    const queryParams = new URLSearchParams();\n    if (params?.page) queryParams.append('page', params.page.toString());\n    if (params?.per_page) queryParams.append('per_page', params.per_page.toString());\n    if (params?.order) queryParams.append('order', params.order);\n    if (params?.orderBy) queryParams.append('orderBy', params.orderBy);\n    if (params?.userFilter) queryParams.append('userFilter', params.userFilter);\n    \n    const queryString = queryParams.toString();\n    return this.request(`/projects/${projectId}/conversations${queryString ? `?${queryString}` : ''}`);\n  }\n\n  async createConversation(projectId: number, data?: { name?: string }): Promise<APIResponse<Conversation>> {\n    return this.request(`/projects/${projectId}/conversations`, {\n      method: 'POST',\n      body: JSON.stringify(data || {}),\n    });\n  }\n\n  async updateConversation(\n    projectId: number,\n    sessionId: string,\n    data: { name?: string }\n  ): Promise<APIResponse<Conversation>> {\n    return this.request(`/projects/${projectId}/conversations/${sessionId}`, {\n      method: 'PUT',\n      body: JSON.stringify(data),\n    });\n  }\n\n  async deleteConversation(projectId: number, sessionId: string): Promise<APIResponse<{ deleted: boolean }>> {\n    return this.request(`/projects/${projectId}/conversations/${sessionId}`, {\n      method: 'DELETE',\n    });\n  }\n\n  // Message Management\n  async getMessages(\n    projectId: number,\n    sessionId: string,\n    params?: {\n      page?: number;\n      per_page?: number;\n    }\n  ): Promise<MessagesResponse> {\n    const queryParams = new URLSearchParams();\n    if (params?.page) queryParams.append('page', params.page.toString());\n    if (params?.per_page) queryParams.append('per_page', params.per_page.toString());\n    \n    const queryString = queryParams.toString();\n    return this.request(`/projects/${projectId}/conversations/${sessionId}/messages${queryString ? `?${queryString}` : ''}`);\n  }\n\n  async sendMessage(\n    projectId: number,\n    sessionId: string,\n    data: {\n      prompt: string;\n      stream?: boolean;\n      source_ids?: string[];\n      response_source?: string;\n      chatbot_model?: string;\n      custom_persona?: string;\n      agent_capability?: string;\n    }\n  ): Promise<MessageResponse> {\n    return this.request(`/projects/${projectId}/conversations/${sessionId}/messages`, {\n      method: 'POST',\n      body: JSON.stringify(data),\n    });\n  }\n\n\n  async sendMessageStream(\n    projectId: number,\n    sessionId: string,\n    data: {\n      prompt: string;\n      source_ids?: string[];\n      response_source?: string;\n      chatbot_model?: string;\n      custom_persona?: string;\n      agent_capability?: string;\n    },\n    onChunk: (chunk: StreamChunk) => void,\n    onError?: (error: Error) => void,\n    onComplete?: () => void\n  ): Promise<void> {\n    try {\n      // Try the standard messages endpoint with stream=true parameter\n      const stream = await this.streamRequest(\n        `/projects/${projectId}/conversations/${sessionId}/messages`,\n        {\n          method: 'POST',\n          body: JSON.stringify({ ...data, stream: true }),\n        }\n      );\n\n      const reader = stream.getReader();\n      const decoder = new TextDecoder();\n      let buffer = '';\n\n      while (true) {\n        const { done, value } = await reader.read();\n        if (done) {\n          onComplete?.();\n          break;\n        }\n\n        buffer += decoder.decode(value, { stream: true });\n        const lines = buffer.split('\\n');\n        buffer = lines.pop() || '';\n\n        for (const line of lines) {\n          if (line.startsWith('data: ')) {\n            try {\n              const data = line.slice(6);\n              if (data === '[DONE]') {\n                onComplete?.();\n                return;\n              }\n              // parseStreamChunk expects the full line with \"data: \" prefix\n              const chunk = parseStreamChunk(line);\n              if (chunk) {\n                onChunk(chunk);\n              }\n            } catch (e) {\n              console.error('Failed to parse chunk:', e);\n            }\n          }\n        }\n      }\n    } catch (error: any) {\n      onError?.(error);\n      throw error;\n    }\n  }\n\n  async getMessageById(\n    projectId: number,\n    sessionId: string,\n    messageId: number\n  ): Promise<APIMessageResponse> {\n    return this.request(`/projects/${projectId}/conversations/${sessionId}/messages/${messageId}`);\n  }\n\n  async updateMessageFeedback(\n    projectId: number,\n    sessionId: string,\n    messageId: number,\n    feedback: { feedback: 'thumbs_up' | 'thumbs_down' }\n  ): Promise<MessageResponse> {\n    return this.request(`/projects/${projectId}/conversations/${sessionId}/messages/${messageId}/feedback`, {\n      method: 'PUT',\n      body: JSON.stringify(feedback),\n    });\n  }\n\n  // Citations\n  async getCitation(projectId: number, citationId: number): Promise<CitationResponse> {\n    return this.request(`/projects/${projectId}/citations/${citationId}`);\n  }\n\n  async previewCitationFile(id: string): Promise<any> {\n    return this.request(`/preview/${id}`);\n  }\n\n  // File Upload\n  async uploadFile(projectId: number, file: File, options?: {\n    onProgress?: (progress: number) => void;\n  }): Promise<SourceResponse> {\n    const formData = new FormData();\n    formData.append('file', file);\n    \n    // Use the correct /sources endpoint for file uploads\n    return this.request(`/projects/${projectId}/sources`, {\n      method: 'POST',\n      body: formData,\n      headers: {}, // Let browser set content-type with boundary\n    });\n  }\n\n  // Reports\n  async getTrafficReport(projectId: number): Promise<TrafficReportResponse> {\n    return this.request(`/projects/${projectId}/reports/traffic`);\n  }\n\n  async getQueriesReport(projectId: number): Promise<QueriesReportResponse> {\n    return this.request(`/projects/${projectId}/reports/queries`);\n  }\n\n  async getConversationsReport(projectId: number): Promise<ConversationsReportResponse> {\n    return this.request(`/projects/${projectId}/reports/conversations`);\n  }\n\n  async getAnalysisReport(projectId: number, interval?: AnalysisInterval): Promise<AnalysisReportResponse> {\n    const queryParams = new URLSearchParams();\n    if (interval) queryParams.append('interval', interval);\n    \n    const queryString = queryParams.toString();\n    return this.request(`/projects/${projectId}/reports/analysis${queryString ? `?${queryString}` : ''}`);\n  }\n\n  // Pages\n  async getPages(\n    projectId: number,\n    params?: PagesQueryParams\n  ): Promise<PagesListResponse> {\n    const queryParams = new URLSearchParams();\n    if (params?.page) queryParams.append('page', params.page.toString());\n    if (params?.limit) queryParams.append('limit', params.limit.toString());\n    if (params?.order) queryParams.append('order', params.order);\n    if (params?.crawl_status) queryParams.append('crawl_status', params.crawl_status);\n    if (params?.index_status) queryParams.append('index_status', params.index_status);\n    \n    const queryString = queryParams.toString();\n    return this.request(`/projects/${projectId}/pages${queryString ? `?${queryString}` : ''}`);\n  }\n\n  async deletePage(projectId: number, pageId: number): Promise<DeletePageResponse> {\n    return this.request(`/projects/${projectId}/pages/${pageId}`, {\n      method: 'DELETE',\n    });\n  }\n\n  async reindexPage(projectId: number, pageId: number): Promise<ReindexPageResponse> {\n    return this.request(`/projects/${projectId}/pages/${pageId}/reindex`, {\n      method: 'POST',\n    });\n  }\n\n  async getPageMetadata(projectId: number, pageId: number): Promise<PageMetadataResponse> {\n    return this.request(`/projects/${projectId}/pages/${pageId}/metadata`);\n  }\n\n  async updatePageMetadata(\n    projectId: number,\n    pageId: number,\n    metadata: Partial<PageMetadata>\n  ): Promise<PageMetadataResponse> {\n    return this.request(`/projects/${projectId}/pages/${pageId}/metadata`, {\n      method: 'PUT',\n      body: JSON.stringify(metadata),\n    });\n  }\n\n  // NOTE: This endpoint is not documented in the API\n  // Commenting out until we confirm it exists\n  // async previewFile(pageId: number): Promise<any> {\n  //   return this.request(`/page_file/${pageId}`);\n  // }\n\n  // Licenses\n  async getLicenses(projectId: number): Promise<APIResponse<any[]>> {\n    return this.request(`/projects/${projectId}/license_keys`);\n  }\n\n  async createLicense(projectId: number, data: { name: string }): Promise<APIResponse<any>> {\n    return this.request(`/projects/${projectId}/license_keys`, {\n      method: 'POST',\n      body: JSON.stringify(data),\n    });\n  }\n\n  async getLicense(projectId: number, licenseId: string): Promise<APIResponse<any>> {\n    return this.request(`/projects/${projectId}/license_keys/${licenseId}`);\n  }\n\n  async updateLicense(\n    projectId: number,\n    licenseId: string,\n    data: { name?: string; is_active?: boolean }\n  ): Promise<APIResponse<any>> {\n    return this.request(`/projects/${projectId}/license_keys/${licenseId}`, {\n      method: 'PUT',\n      body: JSON.stringify(data),\n    });\n  }\n\n  async deleteLicense(projectId: number, licenseId: string): Promise<APIResponse<any>> {\n    return this.request(`/projects/${projectId}/license_keys/${licenseId}`, {\n      method: 'DELETE',\n    });\n  }\n\n  // Sources\n  async getSources(projectId: number): Promise<SourcesListResponse> {\n    return this.request(`/projects/${projectId}/sources`);\n  }\n\n  async createSitemapSource(\n    projectId: number,\n    data: CreateSitemapSourceRequest\n  ): Promise<SourceResponse> {\n    // Convert JSON data to FormData as the API expects multipart/form-data\n    const formData = new FormData();\n    formData.append('sitemap_path', data.sitemap_path);\n    if (data.executive_js !== undefined) {\n      formData.append('executive_js', String(data.executive_js));\n    }\n    if (data.data_refresh_frequency !== undefined) {\n      formData.append('data_refresh_frequency', data.data_refresh_frequency);\n    }\n    if (data.create_new_pages !== undefined) {\n      formData.append('create_new_pages', String(data.create_new_pages));\n    }\n    if (data.remove_unexist_pages !== undefined) {\n      formData.append('remove_unexist_pages', String(data.remove_unexist_pages));\n    }\n    if (data.refresh_existing_pages !== undefined) {\n      formData.append('refresh_existing_pages', data.refresh_existing_pages);\n    }\n\n    return this.request(`/projects/${projectId}/sources`, {\n      method: 'POST',\n      body: formData,\n      headers: {}, // Let browser set content-type with boundary\n    });\n  }\n\n  async uploadFileSource(projectId: number, formData: FormData): Promise<SourceResponse> {\n    return this.request(`/projects/${projectId}/sources`, {\n      method: 'POST',\n      body: formData,\n      headers: {}, // Let browser set content-type with boundary\n    });\n  }\n\n  /**\n   * Update source settings\n   * Updates the settings for an existing source.\n   * API endpoint: PUT /projects/{projectId}/sources/{sourceId}\n   */\n  async updateSourceSettings(\n    projectId: number,\n    sourceId: number,\n    settings: UpdateSourceSettingsRequest\n  ): Promise<SourceResponse> {\n    return this.request(`/projects/${projectId}/sources/${sourceId}`, {\n      method: 'PUT',\n      body: JSON.stringify(settings),\n    });\n  }\n\n  async deleteSource(projectId: number, sourceId: number): Promise<DeleteSourceResponse> {\n    return this.request(`/projects/${projectId}/sources/${sourceId}`, {\n      method: 'DELETE',\n    });\n  }\n\n  async instantSyncSource(projectId: number, sourceId: number): Promise<SourceResponse> {\n    return this.request(`/projects/${projectId}/sources/${sourceId}/instant-sync`, {\n      method: 'PUT',\n    });\n  }\n\n  // Customer Intelligence\n  async getCustomerIntelligence(\n    projectId: number,\n    page: number = 1,\n    limit: number = 100,\n    startDate?: string,\n    endDate?: string\n  ): Promise<CustomerIntelligenceResponse> {\n    const params = new URLSearchParams({\n      page: page.toString(),\n      limit: limit.toString()\n    });\n    \n    if (startDate) {\n      params.append('start_date', startDate);\n    }\n    \n    if (endDate) {\n      params.append('end_date', endDate);\n    }\n    \n    return this.request(`/projects/${projectId}/reports/intelligence?${params.toString()}`);\n  }\n\n  // User\n  async getUserLimits(): Promise<LimitsResponse> {\n    return this.request('/user/limits');\n  }\n\n  async getUserProfile(): Promise<UserProfileResponse> {\n    return this.request('/user');\n  }\n\n  async updateUserProfile(formData: FormData): Promise<UserProfileResponse> {\n    return this.request('/user', {\n      method: 'POST',\n      body: formData,\n      headers: {}, // Let browser set content-type with boundary\n    });\n  }\n\n  // Demo Mode\n  async getDemoUsageStats(): Promise<{\n    status: string;\n    data: {\n      usage: {\n        projects: { used: number; limit: number; remaining: number };\n        conversations: { used: number; limit: number; remaining: number };\n        messages: { total: number; limitPerConversation: number; byConversation: Record<string, number> };\n      };\n      session: {\n        sessionId: string;\n        startTime: number;\n        expiresAt: number;\n        remainingTime: number;\n      };\n    };\n  }> {\n    // Add session start time header\n    const sessionData = sessionStorage.getItem('customgpt.freeTrialSession');\n    let startTime = Date.now();\n    \n    if (sessionData) {\n      try {\n        const session = JSON.parse(sessionData);\n        startTime = session.startTime || Date.now();\n      } catch (e) {\n        console.error('[ProxyClient] Failed to parse session data:', e);\n      }\n    }\n    \n    return this.request('/demo/usage', {\n      headers: {\n        'X-Session-Start-Time': startTime.toString()\n      }\n    });\n  }\n  \n  async cleanupDemoSession(): Promise<{\n    status: string;\n    data: {\n      sessionId: string;\n      totalResources: number;\n      successCount: number;\n      failureCount: number;\n      results: Array<{\n        success: boolean;\n        resourceId: string;\n        resourceType: string;\n        error?: string;\n      }>;\n    };\n  }> {\n    return this.request('/demo/cleanup', {\n      method: 'POST'\n    });\n  }\n}\n\n// Export singleton instance\nexport const proxyClient = new ProxyCustomGPTClient();","/**\n * Direct API Client for CustomGPT\n * \n * This client communicates directly with the CustomGPT API using an API key.\n * Used for standalone widget deployments where a proxy server is not available.\n * \n * SECURITY WARNING: This exposes your API key in the browser. Only use this\n * for trusted environments or with restricted API keys.\n */\n\nimport type {\n  Agent,\n  AgentStats,\n  AgentSettings,\n  Conversation,\n  ChatMessage,\n  Citation,\n  APIResponse,\n  AgentsResponse,\n  ConversationsResponse,\n  MessagesResponse,\n  MessageResponse,\n  APIMessageResponse,\n  CitationResponse,\n  StreamChunk,\n  LimitsResponse,\n} from '@/types';\nimport type { \n  PagesListResponse, \n  DeletePageResponse, \n  ReindexPageResponse, \n  PagesQueryParams,\n  PageMetadata,\n  PageMetadataResponse\n} from '@/types/pages.types';\nimport type { \n  TrafficReportResponse, \n  QueriesReportResponse, \n  ConversationsReportResponse, \n  AnalysisReportResponse,\n  AnalysisInterval\n} from '@/types/reports.types';\nimport type { \n  SourcesListResponse, \n  SourceResponse, \n  DeleteSourceResponse,\n  UpdateSourceSettingsRequest,\n  CreateSitemapSourceRequest\n} from '@/types/sources.types';\nimport { parseStreamChunk } from '@/lib/utils';\nimport { logger } from '@/lib/logger';\nimport type { UserProfile } from '@/types';\n\n/**\n * DirectCustomGPTClient\n * \n * Client that communicates directly with CustomGPT API using an API key.\n * This is used for standalone widget deployments without a proxy server.\n */\nexport class DirectCustomGPTClient {\n  private baseURL: string = 'https://app.customgpt.ai/api/v1';\n  private apiKey: string;\n  private timeout: number = 30000;\n  private abortControllers: Map<string, AbortController> = new Map();\n  private demoApiKey: string | null = null;\n\n  constructor(apiKey: string, baseURL?: string) {\n    if (!apiKey) {\n      throw new Error('API key is required for direct client');\n    }\n    \n    this.apiKey = apiKey;\n    if (baseURL) {\n      this.baseURL = baseURL;\n    }\n    \n    logger.info('DIRECT_CLIENT', 'Direct API Client initialized', {\n      baseURL: this.baseURL,\n      hasApiKey: !!apiKey,\n    });\n  }\n\n  /**\n   * Make a request to the CustomGPT API\n   */\n  private async request<T>(\n    endpoint: string,\n    options: RequestInit = {}\n  ): Promise<T> {\n    const url = `${this.baseURL}${endpoint}`;\n    const requestId = `${options.method || 'GET'}-${endpoint}-${Date.now()}`;\n    \n    logger.apiRequest(endpoint, options.method || 'GET', options.body);\n\n    try {\n      const controller = new AbortController();\n      this.abortControllers.set(requestId, controller);\n\n      const timeoutId = setTimeout(() => {\n        controller.abort();\n      }, this.timeout);\n\n      // Don't set Content-Type for FormData - let browser set it with boundary\n      const isFormData = options.body instanceof FormData;\n      const headers: HeadersInit = {\n        'accept': 'application/json',\n        'Authorization': `Bearer ${this.apiKey}`,\n        ...(options.headers as Record<string, string> || {}),\n      };\n      \n      if (!isFormData) {\n        headers['Content-Type'] = 'application/json';\n      }\n      \n      const response = await fetch(url, {\n        ...options,\n        headers,\n        signal: controller.signal,\n      });\n\n      clearTimeout(timeoutId);\n      this.abortControllers.delete(requestId);\n\n      let responseData;\n      const contentType = response.headers.get('content-type');\n      \n      if (contentType?.includes('application/json')) {\n        responseData = await response.json();\n      } else {\n        // Non-JSON response, wrap it\n        const text = await response.text();\n        responseData = { \n          status: response.ok ? 'success' : 'error', \n          data: text,\n          message: text \n        };\n      }\n\n      if (!response.ok) {\n        throw {\n          message: responseData.error || responseData.message || `Request failed: ${response.status}`,\n          status: response.status,\n          data: responseData,\n        };\n      }\n\n      logger.apiResponse(endpoint, response.status, responseData);\n      return responseData;\n    } catch (error: any) {\n      this.abortControllers.delete(requestId);\n      \n      if (error.name === 'AbortError') {\n        logger.apiError(endpoint, { message: 'Request timeout', code: 'TIMEOUT' });\n        throw new Error('Request timeout');\n      }\n\n      logger.apiError(endpoint, error);\n      throw error;\n    }\n  }\n\n  /**\n   * Make a streaming request to the API\n   */\n  private async streamRequest(\n    endpoint: string,\n    options: RequestInit = {}\n  ): Promise<ReadableStream<Uint8Array>> {\n    const url = `${this.baseURL}${endpoint}`;\n    \n    logger.apiRequest(endpoint, 'POST-STREAM', options.body);\n\n    const headers: HeadersInit = {\n      'Content-Type': 'application/json',\n      'Accept': 'text/event-stream',\n      'Authorization': `Bearer ${this.apiKey}`,\n      ...(options.headers as Record<string, string> || {})\n    };\n\n    const response = await fetch(url, {\n      ...options,\n      headers,\n    });\n\n    if (!response.ok) {\n      let errorMessage = `Stream request failed: ${response.status}`;\n      try {\n        const errorText = await response.text();\n        const errorData = JSON.parse(errorText);\n        errorMessage = errorData.error || errorData.message || errorMessage;\n      } catch {\n        // If not JSON, use the status message\n      }\n      logger.apiError(endpoint, { message: errorMessage, status: response.status });\n      throw new Error(errorMessage);\n    }\n\n    logger.apiResponse(endpoint, response.status, 'Stream started');\n\n    return response.body!;\n  }\n\n  /**\n   * Cancel a specific request\n   */\n  cancelRequest(endpoint: string, method: string = 'GET'): void {\n    const controllers = Array.from(this.abortControllers.entries());\n    controllers.forEach(([key, controller]) => {\n      if (key.includes(`${method}-${endpoint}`)) {\n        controller.abort();\n        this.abortControllers.delete(key);\n      }\n    });\n  }\n\n  /**\n   * Cancel all pending requests\n   */\n  cancelAllRequests(): void {\n    this.abortControllers.forEach(controller => controller.abort());\n    this.abortControllers.clear();\n  }\n\n  /**\n   * Set demo mode API key\n   */\n  public setDemoApiKey(apiKey: string | null) {\n    this.demoApiKey = apiKey;\n  }\n\n  // Agent Management\n  async getAgents(params?: {\n    page?: number;\n    per_page?: number;\n  }): Promise<AgentsResponse> {\n    const queryParams = new URLSearchParams();\n    if (params?.page) queryParams.append('page', params.page.toString());\n    if (params?.per_page) queryParams.append('per_page', params.per_page.toString());\n    \n    const queryString = queryParams.toString();\n    return this.request(`/projects${queryString ? `?${queryString}` : ''}`);\n  }\n\n  async getAgent(id: number): Promise<APIResponse<Agent>> {\n    return this.request(`/projects/${id}`);\n  }\n\n  async createAgent(data: {\n    project_name: string;\n    sitemap_path?: string;\n    file_upload?: boolean;\n    webpage_url?: string;\n  }): Promise<APIResponse<Agent>> {\n    return this.request('/projects', {\n      method: 'POST',\n      body: JSON.stringify(data),\n    });\n  }\n\n  async getAgentSettings(id: number): Promise<APIResponse<AgentSettings>> {\n    return this.request(`/projects/${id}/settings`);\n  }\n\n  async updateAgentSettings(id: number, settings: Partial<AgentSettings> | FormData): Promise<APIResponse<AgentSettings>> {\n    const isFormData = settings instanceof FormData;\n    return this.request(`/projects/${id}/settings`, {\n      method: 'POST',\n      body: isFormData ? settings : JSON.stringify(settings),\n      headers: isFormData ? {} : { 'Content-Type': 'application/json' },\n    });\n  }\n\n  // Conversation Management\n  async getConversations(projectId: number, params?: {\n    page?: number;\n    per_page?: number;\n  }): Promise<ConversationsResponse> {\n    const queryParams = new URLSearchParams();\n    if (params?.page) queryParams.append('page', params.page.toString());\n    if (params?.per_page) queryParams.append('per_page', params.per_page.toString());\n    \n    const queryString = queryParams.toString();\n    return this.request(`/projects/${projectId}/conversations${queryString ? `?${queryString}` : ''}`);\n  }\n\n  async createConversation(projectId: number, data?: { name?: string }): Promise<APIResponse<Conversation>> {\n    return this.request(`/projects/${projectId}/conversations`, {\n      method: 'POST',\n      body: JSON.stringify(data || {}),\n    });\n  }\n\n  async updateConversation(\n    projectId: number,\n    sessionId: string,\n    data: { name?: string }\n  ): Promise<APIResponse<Conversation>> {\n    return this.request(`/projects/${projectId}/conversations/${sessionId}`, {\n      method: 'PUT',\n      body: JSON.stringify(data),\n    });\n  }\n\n  async deleteConversation(projectId: number, sessionId: string): Promise<APIResponse<{ deleted: boolean }>> {\n    return this.request(`/projects/${projectId}/conversations/${sessionId}`, {\n      method: 'DELETE',\n    });\n  }\n\n  // Message Management\n  async getMessages(\n    projectId: number,\n    sessionId: string,\n    params?: {\n      page?: number;\n      per_page?: number;\n    }\n  ): Promise<MessagesResponse> {\n    const queryParams = new URLSearchParams();\n    if (params?.page) queryParams.append('page', params.page.toString());\n    if (params?.per_page) queryParams.append('per_page', params.per_page.toString());\n    \n    const queryString = queryParams.toString();\n    return this.request(`/projects/${projectId}/conversations/${sessionId}/messages${queryString ? `?${queryString}` : ''}`);\n  }\n\n  async getMessageById(\n    projectId: number,\n    sessionId: string,\n    messageId: number\n  ): Promise<APIMessageResponse> {\n    return this.request(`/projects/${projectId}/conversations/${sessionId}/messages/${messageId}`);\n  }\n\n  async sendMessage(\n    projectId: number,\n    sessionId: string,\n    data: {\n      prompt: string;\n      stream?: boolean;\n      source_ids?: string[];\n      response_source?: string;\n      chatbot_model?: string;\n      custom_persona?: string;\n      agent_capability?: string;\n    }\n  ): Promise<MessageResponse> {\n    return this.request(`/projects/${projectId}/conversations/${sessionId}/messages`, {\n      method: 'POST',\n      body: JSON.stringify(data),\n    });\n  }\n\n  async sendMessageStream(\n    projectId: number,\n    sessionId: string,\n    data: {\n      prompt: string;\n      source_ids?: string[];\n      response_source?: string;\n      chatbot_model?: string;\n      custom_persona?: string;\n      agent_capability?: string;\n    },\n    onChunk: (chunk: StreamChunk) => void,\n    onError?: (error: Error) => void,\n    onComplete?: () => void\n  ): Promise<void> {\n    try {\n      const stream = await this.streamRequest(\n        `/projects/${projectId}/conversations/${sessionId}/messages`,\n        {\n          method: 'POST',\n          body: JSON.stringify({ ...data, stream: true }),\n        }\n      );\n\n      const reader = stream.getReader();\n      const decoder = new TextDecoder();\n      let buffer = '';\n\n      while (true) {\n        const { done, value } = await reader.read();\n        if (done) {\n          onComplete?.();\n          break;\n        }\n\n        buffer += decoder.decode(value, { stream: true });\n        const lines = buffer.split('\\n');\n        buffer = lines.pop() || '';\n\n        for (const line of lines) {\n          if (line.startsWith('data: ')) {\n            try {\n              const data = line.slice(6);\n              if (data === '[DONE]') {\n                onComplete?.();\n                return;\n              }\n              const chunk = parseStreamChunk(data);\n              if (chunk) {\n                onChunk(chunk);\n              }\n            } catch (e) {\n              console.error('Failed to parse chunk:', e);\n            }\n          }\n        }\n      }\n    } catch (error: any) {\n      onError?.(error);\n      throw error;\n    }\n  }\n\n  async updateMessageFeedback(\n    projectId: number,\n    sessionId: string,\n    messageId: number,\n    feedback: { feedback: 'thumbs_up' | 'thumbs_down' }\n  ): Promise<MessageResponse> {\n    return this.request(`/projects/${projectId}/conversations/${sessionId}/messages/${messageId}/feedback`, {\n      method: 'PUT',\n      body: JSON.stringify(feedback),\n    });\n  }\n\n  // Citations\n  async getCitation(projectId: number, citationId: number): Promise<CitationResponse> {\n    return this.request(`/projects/${projectId}/citations/${citationId}`);\n  }\n\n  async previewCitationFile(id: string): Promise<any> {\n    // Note: This endpoint might need authentication adjustments\n    return this.request(`/preview/${id}`);\n  }\n\n  // Reports\n  async getTrafficReport(projectId: number): Promise<TrafficReportResponse> {\n    return this.request(`/projects/${projectId}/reports/traffic`);\n  }\n\n  async getQueriesReport(projectId: number): Promise<QueriesReportResponse> {\n    return this.request(`/projects/${projectId}/reports/queries`);\n  }\n\n  async getConversationsReport(projectId: number): Promise<ConversationsReportResponse> {\n    return this.request(`/projects/${projectId}/reports/conversations`);\n  }\n\n  async getAnalysisReport(projectId: number, interval?: AnalysisInterval): Promise<AnalysisReportResponse> {\n    const queryParams = new URLSearchParams();\n    if (interval) queryParams.append('interval', interval);\n    \n    const queryString = queryParams.toString();\n    return this.request(`/projects/${projectId}/reports/analysis${queryString ? `?${queryString}` : ''}`);\n  }\n\n  // Pages\n  async getPages(\n    projectId: number,\n    params?: PagesQueryParams\n  ): Promise<PagesListResponse> {\n    const queryParams = new URLSearchParams();\n    if (params?.page) queryParams.append('page', params.page.toString());\n    if (params?.limit) queryParams.append('limit', params.limit.toString());\n    if (params?.order) queryParams.append('order', params.order);\n    if (params?.crawl_status) queryParams.append('crawl_status', params.crawl_status);\n    if (params?.index_status) queryParams.append('index_status', params.index_status);\n    \n    const queryString = queryParams.toString();\n    return this.request(`/projects/${projectId}/pages${queryString ? `?${queryString}` : ''}`);\n  }\n\n  async deletePage(projectId: number, pageId: number): Promise<DeletePageResponse> {\n    return this.request(`/projects/${projectId}/pages/${pageId}`, {\n      method: 'DELETE',\n    });\n  }\n\n  async reindexPage(projectId: number, pageId: number): Promise<ReindexPageResponse> {\n    return this.request(`/projects/${projectId}/pages/${pageId}/reindex`, {\n      method: 'POST',\n    });\n  }\n\n  async getPageMetadata(projectId: number, pageId: number): Promise<PageMetadataResponse> {\n    return this.request(`/projects/${projectId}/pages/${pageId}/metadata`);\n  }\n\n  async updatePageMetadata(\n    projectId: number,\n    pageId: number,\n    metadata: Partial<PageMetadata>\n  ): Promise<PageMetadataResponse> {\n    return this.request(`/projects/${projectId}/pages/${pageId}/metadata`, {\n      method: 'PUT',\n      body: JSON.stringify(metadata),\n    });\n  }\n\n  // Sources\n  async getSources(projectId: number): Promise<SourcesListResponse> {\n    return this.request(`/projects/${projectId}/sources`);\n  }\n\n  async createSitemapSource(\n    projectId: number,\n    data: CreateSitemapSourceRequest\n  ): Promise<SourceResponse> {\n    const formData = new FormData();\n    formData.append('sitemap_path', data.sitemap_path);\n    if (data.executive_js !== undefined) {\n      formData.append('executive_js', String(data.executive_js));\n    }\n    if (data.data_refresh_frequency !== undefined) {\n      formData.append('data_refresh_frequency', data.data_refresh_frequency);\n    }\n    if (data.create_new_pages !== undefined) {\n      formData.append('create_new_pages', String(data.create_new_pages));\n    }\n    if (data.remove_unexist_pages !== undefined) {\n      formData.append('remove_unexist_pages', String(data.remove_unexist_pages));\n    }\n    if (data.refresh_existing_pages !== undefined) {\n      formData.append('refresh_existing_pages', data.refresh_existing_pages);\n    }\n\n    return this.request(`/projects/${projectId}/sources`, {\n      method: 'POST',\n      body: formData,\n      headers: {},\n    });\n  }\n\n  async uploadFileSource(projectId: number, formData: FormData): Promise<SourceResponse> {\n    return this.request(`/projects/${projectId}/sources`, {\n      method: 'POST',\n      body: formData,\n      headers: {},\n    });\n  }\n\n  async updateSourceSettings(\n    projectId: number,\n    sourceId: number,\n    settings: UpdateSourceSettingsRequest\n  ): Promise<SourceResponse> {\n    return this.request(`/projects/${projectId}/sources/${sourceId}`, {\n      method: 'PUT',\n      body: JSON.stringify(settings),\n    });\n  }\n\n  async deleteSource(projectId: number, sourceId: number): Promise<DeleteSourceResponse> {\n    return this.request(`/projects/${projectId}/sources/${sourceId}`, {\n      method: 'DELETE',\n    });\n  }\n\n  async instantSyncSource(projectId: number, sourceId: number): Promise<SourceResponse> {\n    return this.request(`/projects/${projectId}/sources/${sourceId}/instant-sync`, {\n      method: 'PUT',\n    });\n  }\n\n  // File Upload\n  async uploadFile(projectId: number, file: File): Promise<any> {\n    const formData = new FormData();\n    formData.append('file', file);\n    \n    return this.request(`/projects/${projectId}/sources`, {\n      method: 'POST',\n      body: formData,\n    });\n  }\n\n  // User\n  async getUserLimits(): Promise<LimitsResponse> {\n    return this.request('/user/limits');\n  }\n\n  async getUserProfile(): Promise<{ status: 'success' | 'error'; data: UserProfile }> {\n    return this.request('/user');\n  }\n\n  async updateUserProfile(formData: FormData): Promise<{ status: 'success' | 'error'; data: UserProfile }> {\n    return this.request('/user', {\n      method: 'POST',\n      body: formData,\n      headers: {}, // Let browser set content-type with boundary\n    });\n  }\n\n  // Additional methods for full compatibility\n  async updateAgent(id: number, data: { project_name?: string; are_licenses_allowed?: boolean; is_shared?: boolean; sitemap_path?: string }): Promise<APIResponse<Agent>> {\n    const formData = new FormData();\n    Object.entries(data).forEach(([key, value]) => {\n      if (value !== undefined) {\n        formData.append(key, String(value));\n      }\n    });\n\n    return this.request(`/projects/${id}`, {\n      method: 'POST',\n      body: formData,\n    });\n  }\n\n  async deleteAgent(id: number): Promise<APIResponse<{ deleted: boolean }>> {\n    return this.request(`/projects/${id}`, {\n      method: 'DELETE',\n    });\n  }\n\n  async getAgentStats(id: number): Promise<APIResponse<AgentStats>> {\n    return this.request(`/projects/${id}/stats`);\n  }\n\n  async replicateAgent(id: number): Promise<APIResponse<Agent>> {\n    return this.request(`/projects/${id}/replicate`, {\n      method: 'POST',\n    });\n  }\n\n  // Licenses\n  async getLicenses(projectId: number): Promise<APIResponse<any[]>> {\n    return this.request(`/projects/${projectId}/license_keys`);\n  }\n\n  async createLicense(projectId: number, data: { name: string }): Promise<APIResponse<any>> {\n    return this.request(`/projects/${projectId}/license_keys`, {\n      method: 'POST',\n      body: JSON.stringify(data),\n    });\n  }\n\n  async getLicense(projectId: number, licenseId: string): Promise<APIResponse<any>> {\n    return this.request(`/projects/${projectId}/license_keys/${licenseId}`);\n  }\n\n  async updateLicense(\n    projectId: number,\n    licenseId: string,\n    data: { name?: string; is_active?: boolean }\n  ): Promise<APIResponse<any>> {\n    return this.request(`/projects/${projectId}/license_keys/${licenseId}`, {\n      method: 'PUT',\n      body: JSON.stringify(data),\n    });\n  }\n\n  async deleteLicense(projectId: number, licenseId: string): Promise<APIResponse<any>> {\n    return this.request(`/projects/${projectId}/license_keys/${licenseId}`, {\n      method: 'DELETE',\n    });\n  }\n\n  // Plugin Management\n  async getProjectPlugins(projectId: number): Promise<APIResponse<any[]>> {\n    return this.request(`/projects/${projectId}/plugins`);\n  }\n\n  async updateProjectPlugin(\n    projectId: number,\n    pluginId: string,\n    data: { enabled: boolean }\n  ): Promise<APIResponse<{ updated: boolean }>> {\n    return this.request(`/projects/${projectId}/plugins/${pluginId}`, {\n      method: 'PUT',\n      body: JSON.stringify(data),\n    });\n  }\n}\n\n// Export singleton factory\nexport const createDirectClient = (apiKey: string, baseURL?: string) => {\n  return new DirectCustomGPTClient(apiKey, baseURL);\n};","/**\n * API Client Abstraction\n * \n * This module provides the appropriate API client based on the configuration.\n * It can switch between:\n * - Proxy mode: For Next.js app (API key stored server-side)\n * - Direct mode: For widget deployments (API key provided client-side)\n */\n\nimport { ProxyCustomGPTClient, proxyClient } from './proxy-client';\nimport { DirectCustomGPTClient } from './direct-client';\n\n// Type that represents either client\nexport type CustomGPTClient = ProxyCustomGPTClient | DirectCustomGPTClient;\n\n// Configuration interface\ninterface ClientConfig {\n  mode?: 'proxy' | 'direct';\n  apiKey?: string;\n  apiUrl?: string;\n}\n\n// Singleton instance\nlet clientInstance: CustomGPTClient | null = null;\nlet initialized = false;\n\n/**\n * Initialize the API client\n * @param config Configuration object with mode, apiKey, and optional apiUrl\n */\nexport function initializeClient(config?: ClientConfig): void {\n  if (config) {\n    if (config.mode === 'direct' && config.apiKey) {\n      // Direct mode for widget deployments\n      clientInstance = new DirectCustomGPTClient(config.apiKey, config.apiUrl);\n      initialized = true;\n    } else {\n      // Proxy mode (default)\n      clientInstance = proxyClient;\n      if (config.apiUrl) {\n        proxyClient.setApiUrl(config.apiUrl);\n      }\n      initialized = true;\n    }\n  } else {\n    // Default to proxy client\n    clientInstance = proxyClient;\n    initialized = true;\n  }\n}\n\n/**\n * Get the API client instance\n */\nexport function getClient(): CustomGPTClient {\n  if (!clientInstance) {\n    // Default to proxy client if not initialized\n    clientInstance = proxyClient;\n  }\n  return clientInstance;\n}\n\n/**\n * Get or create the API client instance\n * @deprecated Use getClient() instead\n */\nexport function getApiClient(config?: ClientConfig): CustomGPTClient {\n  if (config) {\n    initializeClient(config);\n  }\n  return getClient();\n}\n\n/**\n * Check if client is initialized\n */\nexport function isClientInitialized(): boolean {\n  return initialized || clientInstance !== null;\n}\n\n/**\n * Reset the client instance\n */\nexport function resetApiClient(): void {\n  clientInstance = null;\n  initialized = false;\n}\n\n// Export default client getter for backward compatibility\nexport const apiClient = getClient();","/**\n * Utility Functions Library\n * \n * Common utility functions used throughout the application.\n * These utilities handle:\n * - CSS class merging for Tailwind\n * - ID generation\n * - File operations\n * - Date/time formatting\n * - Clipboard operations\n * - HTML sanitization\n * - API helpers\n * \n * Features:\n * - Pure, reusable utility functions with full TypeScript support\n * - Comprehensive JSDoc documentation with usage examples\n * - Robust edge case handling and error recovery\n * - Optimized performance with configurable options\n * - Production-ready implementations for common operations\n */\n\nimport { type ClassValue, clsx } from 'clsx';\nimport { twMerge } from 'tailwind-merge';\nimport DOMPurify from 'dompurify';\n\n/**\n * Utility function for combining Tailwind CSS classes\n * \n * This function combines clsx and tailwind-merge to:\n * 1. Support conditional classes (clsx)\n * 2. Properly merge Tailwind classes (tailwind-merge)\n * \n * @example\n * cn('px-2 py-1', 'px-4') // Returns: 'py-1 px-4'\n * cn('text-red-500', condition && 'text-blue-500')\n * cn(['text-sm', 'font-bold'], { 'opacity-50': isDisabled })\n * \n * @param inputs - Class strings, conditionals, arrays, or objects\n * @returns Merged class string\n */\nexport function cn(...inputs: ClassValue[]) {\n  return twMerge(clsx(inputs));\n}\n\n/**\n * Generate a unique ID\n * \n * Creates a unique identifier using random string and timestamp.\n * Not cryptographically secure - use for UI elements only.\n * \n * @example\n * generateId() // Returns: 'a1b2c3d41234567890'\n * \n * @returns Unique string ID\n */\nexport function generateId(): string {\n  return Math.random().toString(36).substring(2) + Date.now().toString(36);\n}\n\n/**\n * Format file size in bytes to human readable format\n * \n * Converts byte values to appropriate units (KB, MB, GB).\n * Always shows 2 decimal places except for bytes.\n * \n * @example\n * formatFileSize(0) // Returns: '0 Bytes'\n * formatFileSize(1024) // Returns: '1 KB'\n * formatFileSize(1536) // Returns: '1.5 KB'\n * formatFileSize(1048576) // Returns: '1 MB'\n * \n * @param bytes - File size in bytes\n * @returns Formatted string with appropriate unit\n */\nexport function formatFileSize(bytes: number): string {\n  if (bytes === 0) return '0 Bytes';\n  \n  const k = 1024;\n  const sizes = ['Bytes', 'KB', 'MB', 'GB'];\n  const i = Math.floor(Math.log(bytes) / Math.log(k));\n  \n  return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];\n}\n\n/**\n * Get file icon based on file type\n * \n * Returns an emoji icon based on the MIME type or file extension.\n * Used in file upload UI components.\n * \n * @example\n * getFileIcon('application/pdf') // Returns: ''\n * getFileIcon('image/png') // Returns: ''\n * getFileIcon('text/plain') // Returns: ''\n * getFileIcon('unknown/type') // Returns: '' (default)\n * \n * @param fileType - MIME type or file extension\n * @returns Emoji icon representing the file type\n */\nexport function getFileIcon(fileType: string): string {\n  const type = fileType.toLowerCase();\n  \n  // Document types\n  if (type.includes('pdf')) return '';\n  if (type.includes('word') || type.includes('doc')) return '';\n  if (type.includes('text') || type.includes('txt')) return '';\n  \n  // Media types\n  if (type.includes('image')) return '';\n  if (type.includes('video')) return '';\n  if (type.includes('audio')) return '';\n  \n  // Data types\n  if (type.includes('excel') || type.includes('sheet')) return '';\n  if (type.includes('powerpoint') || type.includes('presentation')) return '';\n  if (type.includes('json')) return '';\n  if (type.includes('csv')) return '';\n  \n  // Archive types\n  if (type.includes('zip') || type.includes('rar')) return '';\n  \n  // Default icon\n  return '';\n}\n\n/**\n * Validate file type against allowed types\n * \n * Checks if a file type is in the allowed list.\n * Case-insensitive partial matching.\n * \n * @example\n * const allowed = ['image/', 'application/pdf'];\n * isFileTypeAllowed('image/png', allowed) // Returns: true\n * isFileTypeAllowed('IMAGE/JPEG', allowed) // Returns: true (case-insensitive)\n * isFileTypeAllowed('text/plain', allowed) // Returns: false\n * \n * @param fileType - MIME type to check\n * @param allowedTypes - List of allowed MIME types or patterns\n * @returns Whether the file type is allowed\n */\nexport function isFileTypeAllowed(fileType: string, allowedTypes: readonly string[]): boolean {\n  return allowedTypes.some(type => fileType.toLowerCase().includes(type.toLowerCase()));\n}\n\n/**\n * Format timestamp to human readable format\n * \n * Converts ISO timestamps to relative time strings.\n * Shows relative time for recent dates, absolute date for older.\n * \n * @example\n * // Assuming current time is 2024-01-01 12:00:00\n * formatTimestamp('2024-01-01T11:59:30Z') // Returns: 'Just now'\n * formatTimestamp('2024-01-01T11:30:00Z') // Returns: '30m ago'\n * formatTimestamp('2024-01-01T08:00:00Z') // Returns: '4h ago'\n * formatTimestamp('2023-12-25T12:00:00Z') // Returns: '7d ago'\n * formatTimestamp('2023-11-01T12:00:00Z') // Returns: '11/1/2023'\n * \n * @param timestamp - ISO date string\n * @returns Human-readable time difference or date\n */\nexport function formatTimestamp(timestamp: string): string {\n  const date = new Date(timestamp);\n  const now = new Date();\n  const diffInMs = now.getTime() - date.getTime();\n  const diffInMinutes = Math.floor(diffInMs / (1000 * 60));\n  const diffInHours = Math.floor(diffInMs / (1000 * 60 * 60));\n  const diffInDays = Math.floor(diffInMs / (1000 * 60 * 60 * 24));\n  \n  // Recent times shown as relative\n  if (diffInMinutes < 1) return 'Just now';\n  if (diffInMinutes < 60) return `${diffInMinutes}m ago`;\n  if (diffInHours < 24) return `${diffInHours}h ago`;\n  if (diffInDays < 7) return `${diffInDays}d ago`;\n  \n  // Older times shown as absolute date\n  return date.toLocaleDateString();\n}\n\n/**\n * Copy text to clipboard\n * \n * Uses the modern Clipboard API with fallback error handling.\n * Returns success/failure for UI feedback.\n * \n * @example\n * const success = await copyToClipboard('Hello, world!');\n * if (success) {\n *   toast.success('Copied to clipboard');\n * } else {\n *   toast.error('Failed to copy');\n * }\n * \n * @param text - Text to copy to clipboard\n * @returns Promise resolving to success boolean\n */\nexport async function copyToClipboard(text: string): Promise<boolean> {\n  try {\n    await navigator.clipboard.writeText(text);\n    return true;\n  } catch (error) {\n    // Copy failed, return false status\n    console.error('Failed to copy to clipboard:', error);\n    return false;\n  }\n}\n\n/**\n * Sanitize HTML content\n * \n * Removes dangerous HTML/JS to prevent XSS attacks.\n * Safe for rendering user-generated content.\n * Skips sanitization on server-side (SSR).\n * \n * @example\n * const dirty = '<script>alert(\"XSS\")</script><p>Hello</p>';\n * sanitizeHtml(dirty) // Returns: '<p>Hello</p>'\n * \n * const safe = '<p>Hello <strong>world</strong></p>';\n * sanitizeHtml(safe) // Returns: '<p>Hello <strong>world</strong></p>'\n * \n * @param html - Raw HTML string\n * @returns Sanitized HTML safe for rendering\n */\nexport function sanitizeHtml(html: string): string {\n  if (typeof window === 'undefined') {\n    return html; // Skip sanitization on server side (no DOM)\n  }\n  \n  return DOMPurify.sanitize(html, {\n    ALLOWED_TAGS: ['p', 'br', 'strong', 'em', 'code', 'pre', 'a', 'ul', 'ol', 'li', 'h1', 'h2', 'h3', 'h4', 'h5', 'h6'],\n    ALLOWED_ATTR: ['href', 'target', 'rel', 'class'],\n  });\n}\n\n/**\n * Debounce function\n * \n * Delays function execution until after wait milliseconds have\n * elapsed since the last time it was invoked. Useful for search\n * inputs, window resize handlers, etc.\n * \n * @example\n * const debouncedSearch = debounce((query: string) => {\n *   console.log('Searching for:', query);\n * }, 300);\n * \n * // Rapid calls...\n * debouncedSearch('a');    // Won't execute\n * debouncedSearch('ab');   // Won't execute\n * debouncedSearch('abc');  // Will execute after 300ms\n * \n * @param func - Function to debounce\n * @param wait - Milliseconds to delay\n * @returns Debounced function\n */\nexport function debounce<T extends (...args: any[]) => any>(\n  func: T,\n  wait: number\n): (...args: Parameters<T>) => void {\n  let timeout: NodeJS.Timeout;\n  \n  return (...args: Parameters<T>) => {\n    clearTimeout(timeout);\n    timeout = setTimeout(() => func.apply(null, args), wait);\n  };\n}\n\n/**\n * Throttle function\n * \n * Ensures function is called at most once per specified time period.\n * First call executes immediately, subsequent calls are ignored until\n * the time period expires.\n * \n * @example\n * const throttledScroll = throttle(() => {\n *   console.log('Scroll position:', window.scrollY);\n * }, 100);\n * \n * // During rapid scrolling:\n * // t=0ms: executes immediately\n * // t=50ms: ignored (still in throttle period)\n * // t=100ms: executes (throttle period expired)\n * \n * @param func - Function to throttle\n * @param limit - Minimum milliseconds between calls\n * @returns Throttled function\n */\nexport function throttle<T extends (...args: any[]) => any>(\n  func: T,\n  limit: number\n): (...args: Parameters<T>) => void {\n  let inThrottle: boolean;\n  \n  return (...args: Parameters<T>) => {\n    if (!inThrottle) {\n      func.apply(null, args);\n      inThrottle = true;\n      setTimeout(() => (inThrottle = false), limit);\n    }\n  };\n}\n\n/**\n * Truncate text to specified length\n * \n * Cuts text at the specified length and adds ellipsis.\n * Trims whitespace from the cut point.\n * \n * @example\n * truncateText('Hello, world!', 5) // Returns: 'Hello...'\n * truncateText('Short', 10) // Returns: 'Short'\n * truncateText('Hello   ', 5) // Returns: 'Hello...' (trimmed)\n * \n * @param text - Text to truncate\n * @param maxLength - Maximum length before truncation\n * @returns Truncated text with ellipsis if needed\n */\nexport function truncateText(text: string, maxLength: number): string {\n  if (text.length <= maxLength) return text;\n  return text.substring(0, maxLength).trim() + '...';\n}\n\n/**\n * Validate CustomGPT API key format\n * \n * Checks if the provided string matches the CustomGPT API key format.\n * Format: {digits}|{alphanumeric_string}\n * - At least 3 digits before the pipe\n * - At least 20 alphanumeric characters after the pipe\n * \n * @example\n * isValidApiKey('123|abcdefghijklmnopqrst') // Returns: true\n * isValidApiKey('7727|QxxxpM5Dxxxxz9CI3lGwyOBNoRav7oMdgFMxxxxefded9d9x') // Returns: true\n * isValidApiKey('12|short') // Returns: false (too few digits/chars)\n * isValidApiKey('no-pipe') // Returns: false (wrong format)\n * isValidApiKey('') // Returns: false (empty)\n * \n * @param apiKey - API key string to validate\n * @returns Whether the API key is valid\n */\nexport function isValidApiKey(apiKey: string): boolean {\n  if (!apiKey || typeof apiKey !== 'string') {\n    return false;\n  }\n  \n  // Trim whitespace\n  apiKey = apiKey.trim();\n  \n  // CustomGPT API key format: starts with digits followed by | then alphanumeric string\n  // Example: 7727|QxxxpM5Dxxxxz9CI3lGwyOBNoRav7oMdgFMxxxxefded9d9x\n  // Must have at least 3 digits, pipe, and at least 20 characters after pipe\n  return /^\\d{3,}\\|[a-zA-Z0-9]{20,}$/.test(apiKey);\n}\n\n/**\n * Parse streaming response chunk\n * \n * Handles various SSE (Server-Sent Events) formats from the CustomGPT API.\n * Supports both standard SSE format and raw JSON lines.\n * \n * Formats handled:\n * - SSE events: \"event: progress\", \"event: finish\"\n * - SSE data: \"data: {json}\", \"data: [DONE]\"\n * - Raw JSON: {\"content\": \"...\", \"citations\": [...]}\n * - Plain text: \"data: plain text content\"\n * \n * @example\n * parseStreamChunk('data: {\"content\": \"Hello\"}') \n * // Returns: { type: 'content', content: 'Hello' }\n * \n * parseStreamChunk('data: [DONE]')\n * // Returns: { type: 'done' }\n * \n * parseStreamChunk('event: finish')\n * // Returns: { type: 'done' }\n * \n * @param chunk - Raw chunk from SSE stream\n * @returns Parsed chunk object or null if should be skipped\n */\nexport function parseStreamChunk(chunk: string): any | null {\n  try {\n    \n    // Skip event lines - CustomGPT sends \"event: progress\" etc.\n    if (chunk.startsWith('event: ')) {\n      const eventType = chunk.slice(7).trim();\n      \n      // Handle specific events if needed\n      if (eventType === 'finish') {\n        return { type: 'done' };\n      }\n      \n      // Skip other event types\n      return null;\n    }\n    \n    // Handle SSE format\n    if (chunk.startsWith('data: ')) {\n      const data = chunk.slice(6).trim();\n      \n      if (data === '[DONE]' || data === 'DONE') return { type: 'done' };\n      \n      // CustomGPT might send plain text data instead of JSON\n      // Try to parse as JSON first\n      try {\n        const parsed = JSON.parse(data);\n        \n        // Handle different response formats\n        if (typeof parsed === 'object') {\n          // If it already has a type, return as is\n          if (parsed.type) {\n            return parsed;\n          }\n          \n          // Handle CustomGPT format where content might be a direct property\n          if (parsed.content !== undefined) {\n            return { type: 'content', content: parsed.content, citations: parsed.citations };\n          }\n          \n          // Handle citation-only responses\n          if (parsed.citations && !parsed.content) {\n            return { type: 'citation', citations: parsed.citations };\n          }\n          \n          // Handle message field (some APIs use 'message' instead of 'content')\n          if (parsed.message !== undefined) {\n            return { type: 'content', content: parsed.message, citations: parsed.citations };\n          }\n          \n          // Handle delta format (some streaming APIs use delta.content)\n          if (parsed.delta && parsed.delta.content !== undefined) {\n            return { type: 'content', content: parsed.delta.content, citations: parsed.citations };\n          }\n          \n          // Handle choices format (OpenAI-style streaming)\n          if (parsed.choices && parsed.choices[0] && parsed.choices[0].delta) {\n            const delta = parsed.choices[0].delta;\n            if (delta.content !== undefined) {\n              return { type: 'content', content: delta.content, citations: parsed.citations };\n            }\n          }\n        }\n        \n        // Return the parsed data as is if we can't determine the format\n        return parsed;\n      } catch (jsonError) {\n        // If JSON parsing fails, treat it as plain text content\n        return { type: 'content', content: data };\n      }\n    }\n    \n    // Handle raw JSON lines (no \"data: \" prefix)\n    if (chunk.trim().startsWith('{')) {\n      try {\n        const parsed = JSON.parse(chunk.trim());\n        \n        if (parsed.content !== undefined || parsed.citations !== undefined) {\n          return { \n            type: parsed.content ? 'content' : 'citation', \n            content: parsed.content,\n            citations: parsed.citations \n          };\n        }\n        \n        // Handle message field\n        if (parsed.message !== undefined) {\n          return { type: 'content', content: parsed.message, citations: parsed.citations };\n        }\n        \n        return parsed;\n      } catch (parseError) {\n        console.warn('Failed to parse raw JSON chunk:', parseError);\n      }\n    }\n    \n    // Handle plain text responses (fallback)\n    if (chunk.trim() && !chunk.includes('data:') && !chunk.startsWith('{')) {\n      return { type: 'content', content: chunk.trim() };\n    }\n    \n    return null;\n  } catch (error) {\n    console.error('Failed to parse stream chunk:', chunk, error);\n    return null;\n  }\n}\n\n/**\n * Extract inline citations from text\n * \n * Finds all citation references in format [1], [2], etc.\n * Returns the original text and array of citation numbers.\n * \n * @example\n * extractInlineCitations('Hello [1] world [2]!')\n * // Returns: { text: 'Hello [1] world [2]!', citations: [1, 2] }\n * \n * extractInlineCitations('No citations here')\n * // Returns: { text: 'No citations here', citations: [] }\n * \n * @param text - Text potentially containing citations\n * @returns Object with text and citation numbers\n */\nexport function extractInlineCitations(text: string): { text: string; citations: number[] } {\n  const citationRegex = /\\[(\\d+)\\]/g;\n  const citations: number[] = [];\n  let match;\n  \n  while ((match = citationRegex.exec(text)) !== null) {\n    citations.push(parseInt(match[1]));\n  }\n  \n  return { text, citations };\n}\n\n/**\n * Create a delay promise\n * \n * Utility for adding delays in async functions.\n * Useful for retries, animations, or testing.\n * \n * @example\n * async function slowOperation() {\n *   console.log('Starting...');\n *   await delay(1000); // Wait 1 second\n *   console.log('Done!');\n * }\n * \n * @param ms - Milliseconds to delay\n * @returns Promise that resolves after delay\n */\nexport function delay(ms: number): Promise<void> {\n  return new Promise(resolve => setTimeout(resolve, ms));\n}\n\n/**\n * Retry a function with exponential backoff\n * \n * Retries a failing async function with increasing delays.\n * Delays: 1s, 2s, 4s, 8s, etc. (exponential)\n * \n * @example\n * // Retry API call up to 3 times\n * const data = await retryWithBackoff(\n *   () => fetch('/api/data').then(r => r.json()),\n *   3,    // max attempts\n *   1000  // base delay (1s)\n * );\n * \n * // Delays: attempt 1 = immediate, attempt 2 = 1s, attempt 3 = 2s\n * \n * @param fn - Async function to retry\n * @param maxAttempts - Maximum retry attempts (default: 3)\n * @param baseDelay - Base delay in ms (default: 1000)\n * @returns Result from successful function call\n * @throws Last error if all attempts fail\n */\nexport async function retryWithBackoff<T>(\n  fn: () => Promise<T>,\n  maxAttempts: number = 3,\n  baseDelay: number = 1000\n): Promise<T> {\n  let lastError: Error;\n  \n  for (let attempt = 1; attempt <= maxAttempts; attempt++) {\n    try {\n      return await fn();\n    } catch (error) {\n      lastError = error as Error;\n      \n      if (attempt === maxAttempts) {\n        throw lastError;\n      }\n      \n      // Exponential backoff: 1s, 2s, 4s, etc.\n      const delayTime = baseDelay * Math.pow(2, attempt - 1);\n      await delay(delayTime);\n    }\n  }\n  \n  throw lastError!;\n}\n\n/**\n * Check if device is mobile\n * \n * Based on viewport width (<768px).\n * Returns false during SSR.\n * \n * @returns Whether viewport is mobile-sized\n */\nexport function isMobile(): boolean {\n  if (typeof window === 'undefined') return false;\n  return window.innerWidth < 768;\n}\n\n/**\n * Check if device is tablet\n * \n * Based on viewport width (768px-1023px).\n * Returns false during SSR.\n * \n * @returns Whether viewport is tablet-sized\n */\nexport function isTablet(): boolean {\n  if (typeof window === 'undefined') return false;\n  return window.innerWidth >= 768 && window.innerWidth < 1024;\n}\n\n/**\n * Check if device is desktop\n * \n * Based on viewport width (1024px).\n * Returns false during SSR.\n * \n * @returns Whether viewport is desktop-sized\n */\nexport function isDesktop(): boolean {\n  if (typeof window === 'undefined') return false;\n  return window.innerWidth >= 1024;\n}\n\n/**\n * Get responsive container class\n * \n * Returns Tailwind classes for responsive container sizing.\n * - Mobile: Full width/height\n * - Tablet: Max 2xl width, centered\n * - Desktop: Max 4xl width, centered\n * \n * @returns Tailwind class string for container\n */\nexport function getResponsiveContainer(): string {\n  if (isMobile()) return 'w-full h-full';\n  if (isTablet()) return 'w-full max-w-2xl mx-auto';\n  return 'w-full max-w-4xl mx-auto';\n}\n\n/**\n * Format conversation name from first message\n * \n * Creates a conversation title from the first message.\n * Takes first 6 words, max 50 characters.\n * \n * @example\n * generateConversationName('Hello, can you help me with JavaScript?')\n * // Returns: 'Hello, can you help me with'\n * \n * generateConversationName('Short')\n * // Returns: 'Short'\n * \n * @param firstMessage - The first message in conversation\n * @returns Formatted conversation name\n */\nexport function generateConversationName(firstMessage: string): string {\n  // Remove common API/system prefixes\n  let cleanedMessage = firstMessage.trim();\n  \n  // Remove OpenAI- prefix or similar system prefixes\n  cleanedMessage = cleanedMessage.replace(/^(OpenAI-|System-|API-|Assistant:|User:)\\s*/i, '');\n  \n  const words = cleanedMessage.split(/\\s+/);\n  const title = words.slice(0, 6).join(' ');\n  return title.length > 50 ? title.substring(0, 50).trim() + '...' : title;\n}\n\n/**\n * Validate URL format\n * \n * Checks if string is a valid URL using URL constructor.\n * \n * @example\n * isValidUrl('https://example.com') // Returns: true\n * isValidUrl('http://localhost:3000/path') // Returns: true\n * isValidUrl('not a url') // Returns: false\n * isValidUrl('') // Returns: false\n * \n * @param url - String to validate\n * @returns Whether string is a valid URL\n */\nexport function isValidUrl(url: string): boolean {\n  try {\n    new URL(url);\n    return true;\n  } catch {\n    return false;\n  }\n}\n\n/**\n * Get file extension from filename\n * \n * Extracts the file extension in lowercase.\n * \n * @example\n * getFileExtension('document.pdf') // Returns: 'pdf'\n * getFileExtension('image.PNG') // Returns: 'png'\n * getFileExtension('no-extension') // Returns: ''\n * getFileExtension('multi.part.name.txt') // Returns: 'txt'\n * \n * @param filename - Filename to extract extension from\n * @returns Lowercase extension or empty string\n */\nexport function getFileExtension(filename: string): string {\n  return filename.split('.').pop()?.toLowerCase() || '';\n}\n\n/**\n * Check if file is an image\n * \n * Checks MIME type for image/ prefix.\n * \n * @example\n * isImageFile('image/png') // Returns: true\n * isImageFile('image/jpeg') // Returns: true\n * isImageFile('application/pdf') // Returns: false\n * \n * @param fileType - MIME type to check\n * @returns Whether file is an image\n */\nexport function isImageFile(fileType: string): boolean {\n  return fileType.startsWith('image/');\n}\n\n/**\n * Check if file is a document\n * \n * Checks against common document MIME types including:\n * - PDF files\n * - Microsoft Word documents\n * - Plain text files\n * - CSV spreadsheets\n * - JSON/XML data files\n * \n * @example\n * isDocumentFile('application/pdf') // Returns: true\n * isDocumentFile('text/plain') // Returns: true\n * isDocumentFile('image/png') // Returns: false\n * \n * @param fileType - MIME type to check\n * @returns Whether file is a supported document type\n */\nexport function isDocumentFile(fileType: string): boolean {\n  const documentTypes = [\n    'application/pdf',\n    'application/msword',\n    'application/vnd.openxmlformats-officedocument.wordprocessingml.document',\n    'text/plain',\n    'text/csv',\n    'application/json',\n    'application/xml',\n  ];\n  return documentTypes.includes(fileType);\n}\n\n/**\n * Create download link for file\n * \n * Programmatically downloads content as a file.\n * Creates a blob URL and triggers download.\n * \n * @example\n * // Download text file\n * downloadFile('Hello, world!', 'greeting.txt');\n * \n * // Download JSON file\n * const data = { name: 'John', age: 30 };\n * downloadFile(\n *   JSON.stringify(data, null, 2),\n *   'data.json',\n *   'application/json'\n * );\n * \n * @param content - File content as string\n * @param filename - Name for downloaded file\n * @param mimeType - MIME type (default: 'text/plain')\n */\nexport function downloadFile(content: string, filename: string, mimeType: string = 'text/plain'): void {\n  const blob = new Blob([content], { type: mimeType });\n  const url = URL.createObjectURL(blob);\n  const link = document.createElement('a');\n  link.href = url;\n  link.download = filename;\n  document.body.appendChild(link);\n  link.click();\n  document.body.removeChild(link);\n  URL.revokeObjectURL(url);\n}\n\n/**\n * Escape HTML entities\n * \n * Prevents XSS by escaping HTML special characters.\n * Use when displaying user input as HTML.\n * \n * @example\n * escapeHtml('<script>alert(\"XSS\")</script>')\n * // Returns: '&lt;script&gt;alert(&quot;XSS&quot;)&lt;/script&gt;'\n * \n * escapeHtml('Hello & \"world\"')\n * // Returns: 'Hello &amp; &quot;world&quot;'\n * \n * @param unsafe - Raw string that may contain HTML\n * @returns HTML-escaped string\n */\nexport function escapeHtml(unsafe: string): string {\n  return unsafe\n    .replace(/&/g, '&amp;')\n    .replace(/</g, '&lt;')\n    .replace(/>/g, '&gt;')\n    .replace(/\"/g, '&quot;')\n    .replace(/'/g, '&#039;');\n}\n\n/**\n * Handle API errors and extract error message\n * \n * Normalizes various error formats into consistent structure.\n * Handles:\n * - API response errors (4xx, 5xx)\n * - Network/connection errors\n * - Client-side errors\n * \n * @example\n * try {\n *   await apiCall();\n * } catch (error) {\n *   const { message, code } = handleApiError(error);\n *   toast.error(message);\n *   if (code === 401) {\n *     // Handle unauthorized\n *   }\n * }\n * \n * @param error - Error object from API call\n * @returns Normalized error with message and optional code\n */\nexport function handleApiError(error: any): { message: string; code?: number } {\n  console.error('API Error:', error);\n  \n  if (error.response) {\n    // API responded with an error\n    const data = error.response.data;\n    // Handle nested error formats\n    if (data && data.data && data.data.message) {\n      return {\n        message: data.data.message,\n        code: data.data.code || error.response.status\n      };\n    }\n    // Handle direct message format\n    if (data && data.message) {\n      return {\n        message: data.message,\n        code: error.response.status\n      };\n    }\n    // Fallback to status code\n    return {\n      message: `API Error: ${error.response.status}`,\n      code: error.response.status\n    };\n  } else if (error.request) {\n    // Request was made but no response received\n    return {\n      message: 'No response from server. Please check your connection.',\n      code: 0\n    };\n  } else {\n    // Something else happened (e.g., request setup error)\n    return {\n      message: error.message || 'An unexpected error occurred',\n      code: 0\n    };\n  }\n}\n\n/**\n * Constants for file uploads and API\n * \n * Central configuration for limits and constraints.\n * Modify these values to customize behavior:\n * \n * - MAX_FILE_SIZE: Maximum upload size per file\n * - ACCEPTED_FILE_TYPES: MIME types allowed for upload\n * - MAX_MESSAGE_LENGTH: Character limit for messages\n * - API_TIMEOUT: Request timeout for regular API calls\n * - STREAM_TIMEOUT: Timeout for streaming responses\n * - RETRY_ATTEMPTS: Number of retries on failure\n * - RETRY_DELAY: Base delay between retries\n * \n * @example\n * // Check file size\n * if (file.size > CONSTANTS.MAX_FILE_SIZE) {\n *   throw new Error('File too large');\n * }\n * \n * // Configure retry\n * await retryWithBackoff(\n *   apiCall,\n *   CONSTANTS.RETRY_ATTEMPTS,\n *   CONSTANTS.RETRY_DELAY\n * );\n */\nexport const CONSTANTS = {\n  /** Maximum file size in bytes (10MB) */\n  MAX_FILE_SIZE: 10 * 1024 * 1024,\n  \n  /** Accepted MIME types for file uploads */\n  ACCEPTED_FILE_TYPES: [\n    // Documents\n    'application/pdf',\n    'application/msword',\n    'application/vnd.openxmlformats-officedocument.wordprocessingml.document',\n    'text/plain',\n    'text/csv',\n    'application/json',\n    'application/xml',\n    // Images\n    'image/jpeg',\n    'image/png',\n    'image/gif',\n    'image/webp',\n  ],\n  \n  /** Maximum characters per message */\n  MAX_MESSAGE_LENGTH: 4000,\n  \n  /** API request timeout in milliseconds (30s) */\n  API_TIMEOUT: 30000,\n  \n  /** Streaming request timeout in milliseconds (60s) */\n  STREAM_TIMEOUT: 60000,\n  \n  /** Number of retry attempts for failed requests */\n  RETRY_ATTEMPTS: 3,\n  \n  /** Base delay between retries in milliseconds (1s) */\n  RETRY_DELAY: 1000,\n} as const;","/**\n * Demo Mode Usage Limits Constants\n * \n * Central configuration for all demo mode restrictions and limits.\n * Modify these values to adjust demo mode behavior.\n */\n\n// Free Trial Mode Limits (No API Key)\nexport const FREE_TRIAL_LIMITS = {\n  // Resource Limits\n  MAX_PROJECTS: 1,\n  MAX_CONVERSATIONS: 2,\n  MAX_MESSAGES_PER_CONVERSATION: 2,\n  \n  // Time Limits (in milliseconds)\n  SESSION_DURATION: 10 * 60 * 1000, // 10 minutes\n  SESSION_WARNING_TIME: 5 * 60 * 1000, // Show warning 5 minutes before expiry\n  \n  // Rate Limits\n  MAX_REQUESTS_PER_MINUTE: 10,\n  COOLDOWN_BETWEEN_MESSAGES: 2000, // 2 seconds between messages\n  \n  // Feature Restrictions\n  ALLOW_FILE_UPLOAD: false,\n  ALLOW_SITEMAP_UPLOAD: false,\n  ALLOW_DELETE_OPERATIONS: false,\n  ALLOW_PROJECT_SETTINGS: false,\n  ALLOW_VOICE_MODE: false,\n  \n  // UI Messages\n  SESSION_EXPIRY_WARNING: \"Your free trial session will expire in 5 minutes\",\n  SESSION_EXPIRED_MESSAGE: \"Your free trial session has expired. Please refresh to start a new session.\",\n  LIMIT_REACHED_MESSAGE: {\n    projects: \"Free trial limit reached: Maximum 1 project allowed\",\n    conversations: \"Free trial limit reached: Maximum 2 conversations allowed\",\n    messages: \"Free trial limit reached: Maximum 2 messages per conversation\"\n  }\n} as const;\n\n// User API Key Demo Mode Limits\nexport const USER_DEMO_LIMITS = {\n  // Time Limits (in milliseconds)\n  SESSION_DURATION: 120 * 60 * 1000, // 120 minutes (2 hours)\n  SESSION_WARNING_TIME: 10 * 60 * 1000, // Show warning 10 minutes before expiry\n  \n  // No resource limits for user API key mode\n  MAX_PROJECTS: Infinity,\n  MAX_CONVERSATIONS: Infinity,\n  MAX_MESSAGES_PER_CONVERSATION: Infinity,\n  \n  // Features all enabled\n  ALLOW_FILE_UPLOAD: true,\n  ALLOW_SITEMAP_UPLOAD: true,\n  ALLOW_DELETE_OPERATIONS: true,\n  ALLOW_PROJECT_SETTINGS: true,\n  ALLOW_VOICE_MODE: true,\n  \n  // UI Messages\n  SESSION_EXPIRY_WARNING: \"Your demo session will expire in 10 minutes\",\n  SESSION_EXPIRED_MESSAGE: \"Your demo session has expired. Please refresh to start a new session.\"\n} as const;\n\n// Session Storage Keys\nexport const DEMO_STORAGE_KEYS = {\n  DEPLOYMENT_MODE: 'customgpt.deploymentMode',\n  FREE_TRIAL_MODE: 'customgpt.freeTrialMode',\n  FREE_TRIAL_SESSION: 'customgpt.freeTrialSession',\n  DEMO_SESSION: 'customgpt.demoSession',\n  API_KEY: 'customgpt.apiKey',\n  OPENAI_KEY: 'customgpt.openAIApiKey',\n  SESSION_START: 'customgpt.sessionStart',\n  AUTO_DETECTED: 'customgpt.autoDetected'\n} as const;\n\n// API Headers\nexport const DEMO_API_HEADERS = {\n  DEPLOYMENT_MODE: 'X-Deployment-Mode',\n  API_KEY: 'X-CustomGPT-API-Key',\n  SESSION_ID: 'X-Demo-Session-ID',\n  FREE_TRIAL: 'X-Free-Trial-Mode'\n} as const;\n\n// Type definitions for session data\nexport interface FreeTrialSession {\n  sessionId: string;\n  startTime: number;\n  projectCount: number;\n  conversationCount: number;\n  messageCount: number;\n  lastActivity: number;\n}\n\nexport interface DemoSession {\n  sessionId: string;\n  startTime: number;\n  lastActivity: number;\n}\n\n// Helper functions\nexport function isSessionExpired(startTime: number, duration: number): boolean {\n  return Date.now() - startTime > duration;\n}\n\nexport function getTimeRemaining(startTime: number, duration: number): number {\n  const elapsed = Date.now() - startTime;\n  const remaining = duration - elapsed;\n  return Math.max(0, remaining);\n}\n\nexport function shouldShowWarning(startTime: number, duration: number, warningTime: number): boolean {\n  const remaining = getTimeRemaining(startTime, duration);\n  return remaining > 0 && remaining <= warningTime;\n}","/**\n * Agent Store - Chatbot Management\n * \n * This store manages all agent (chatbot) related state and operations.\n * Agents are the core entities in CustomGPT - each agent is a trained\n * chatbot with its own knowledge base and settings.\n * \n * Features:\n * - CRUD operations for agents\n * - Persistent state using localStorage\n * - Auto-selection of first agent\n * - Agent statistics fetching\n * - License management support\n * \n * State Persistence:\n * - Uses Zustand persist middleware\n * - Stores: agents list and current selection\n * - Survives page refreshes\n * \n * Features:\n * - Multi-format API response handling with backward compatibility\n * - Automatic agent state synchronization across operations\n * - Optimistic UI updates for seamless user experience\n * - Comprehensive error handling with graceful recovery\n */\n\nimport { create } from 'zustand';\nimport { persist } from 'zustand/middleware';\nimport type { AgentStore, Agent, AgentSettings } from '@/types';\nimport { getClient } from '@/lib/api/client';\nimport { useConversationStore } from './conversations';\nimport { useMessageStore } from './messages';\n\n/**\n * Agent Store Implementation\n * \n * Persisted to localStorage with key 'customgpt-agent-store'\n * Automatically hydrates on app load\n */\nexport const useAgentStore = create<AgentStore>()(\n  persist(\n    (set, get) => ({\n      // Initial state\n      agents: [],\n      currentAgent: null,\n      loading: false,\n      error: null,\n      paginationMeta: undefined,\n\n      /**\n       * Fetch agents from the API with enterprise-scale pagination\n       * \n       * Strategy for 1000+ projects:\n       * - Load first batch (100 items) immediately for UI responsiveness\n       * - Load additional batches as needed via loadMoreAgents()\n       * - Auto-selects first agent if none selected\n       * - Maintains total count for pagination UI\n       */\n      fetchAgents: async () => {\n        set({ loading: true, error: null });\n        \n        try {\n          const client = getClient();\n          \n          // Load first batch with larger page size for better UX\n          const response = await client.getAgents({ page: 1, per_page: 100 });\n          \n          let agents: Agent[] = [];\n          let total = 0;\n          let hasMore = false;\n          \n          // Handle different response formats from the API\n          if (response && typeof response === 'object') {\n            // Check for nested pagination format: { data: { data: [...], total: ..., current_page: ... } }\n            if ('data' in response && (response as any).data && typeof (response as any).data === 'object' && 'data' in (response as any).data) {\n              const nestedData = (response as any).data;\n              agents = Array.isArray(nestedData.data) ? nestedData.data : [];\n              total = nestedData.total || agents.length;\n              const currentPage = nestedData.current_page || 1;\n              const perPage = nestedData.per_page || 100;\n              hasMore = nestedData.last_page ? currentPage < nestedData.last_page : false;\n            } else if ('data' in response && 'total' in response) {\n              // Flat paginated response format\n              const paginatedResponse = response as { data: Agent[]; total: number; page: number; per_page: number };\n              agents = paginatedResponse.data;\n              total = paginatedResponse.total;\n              hasMore = total > paginatedResponse.per_page;\n            } else if (Array.isArray((response as any).data)) {\n              // Legacy format: { data: [...] }\n              agents = (response as any).data;\n              total = agents.length;\n              hasMore = false;\n            } else if (Array.isArray(response)) {\n              // Legacy format: [...]\n              agents = response as Agent[];\n              total = agents.length;\n              hasMore = false;\n            }\n          }\n          \n          set({ \n            agents, \n            loading: false,\n            // Always update pagination metadata with fresh data\n            paginationMeta: { \n              currentPage: 1, \n              totalCount: total, \n              hasMore,\n              perPage: 100\n            },\n            // Auto-select first agent if none selected\n            currentAgent: get().currentAgent || (agents.length > 0 ? agents[0] : null)\n          });\n          \n          // Fetch settings for all agents to get avatars\n          const fetchSettingsForAgents = async () => {\n            const client = getClient();\n            const agentsWithoutSettings = agents.filter(agent => !agent.settings);\n            \n            if (agentsWithoutSettings.length === 0) return;\n            \n            // Process in batches of 5 to avoid overwhelming the API\n            const batchSize = 5;\n            for (let i = 0; i < agentsWithoutSettings.length; i += batchSize) {\n              const batch = agentsWithoutSettings.slice(i, i + batchSize);\n              \n              // Fetch settings in parallel for this batch\n              const settingsPromises = batch.map(async (agent) => {\n                try {\n                  const settingsResponse = await client.getAgentSettings(agent.id);\n                  if (settingsResponse && settingsResponse.data) {\n                    return { agent, settings: settingsResponse.data };\n                  }\n                } catch (error) {\n                  console.error(`Failed to fetch settings for agent ${agent.id}:`, error);\n                }\n                return null;\n              });\n              \n              const settingsResults = await Promise.all(settingsPromises);\n              const validResults = settingsResults.filter(result => result !== null);\n              \n              if (validResults.length > 0) {\n                // Update agents with their settings\n                set(state => ({\n                  agents: state.agents.map(a => {\n                    const result = validResults.find(r => r!.agent.id === a.id);\n                    return result ? { ...a, settings: result.settings } : a;\n                  }),\n                  // Also update current agent if it matches\n                  currentAgent: state.currentAgent \n                    ? (() => {\n                        const result = validResults.find(r => r!.agent.id === state.currentAgent!.id);\n                        return result ? { ...state.currentAgent, settings: result.settings } : state.currentAgent;\n                      })()\n                    : state.currentAgent\n                }));\n              }\n              \n              // Small delay between batches to be kind to the API\n              if (i + batchSize < agentsWithoutSettings.length) {\n                await new Promise(resolve => setTimeout(resolve, 100));\n              }\n            }\n          };\n          \n          // Fetch settings in the background without blocking the UI\n          fetchSettingsForAgents().catch(error => {\n            console.error('Failed to fetch agent settings:', error);\n          });\n        } catch (error) {\n          console.error('Failed to fetch agents:', error);\n          set({ \n            agents: [], \n            error: error instanceof Error ? error.message : 'Failed to fetch agents',\n            loading: false \n          });\n        }\n      },\n\n      /**\n       * Load more agents for large datasets (enterprise accounts)\n       * Appends to existing agents list\n       */\n      loadMoreAgents: async () => {\n        const state = get();\n        const paginationMeta = (state as any).paginationMeta;\n        \n        if (!paginationMeta?.hasMore || state.loading) return;\n        \n        set({ loading: true, error: null });\n        \n        try {\n          const client = getClient();\n          const nextPage = paginationMeta.currentPage + 1;\n          \n          const response = await client.getAgents({ \n            page: nextPage, \n            per_page: paginationMeta.perPage \n          });\n          \n          if (response && 'data' in response) {\n            let newAgents: Agent[] = [];\n            let responseTotal = 0;\n            let responsePage = nextPage;\n            \n            // Handle nested format: { data: { data: [...] } }\n            if (response.data && typeof response.data === 'object' && 'data' in response.data) {\n              const nestedData = (response as any).data;\n              newAgents = Array.isArray(nestedData.data) ? nestedData.data : [];\n              responseTotal = nestedData.total || 0;\n              responsePage = nestedData.current_page || nextPage;\n            } else if (Array.isArray((response as any).data)) {\n              // Legacy format: { data: [...] }\n              newAgents = (response as any).data;\n              responseTotal = paginationMeta.totalCount;\n            }\n            \n            set(state => ({ \n              agents: [...state.agents, ...newAgents],\n              loading: false,\n              paginationMeta: {\n                ...paginationMeta,\n                currentPage: responsePage,\n                hasMore: (responsePage * paginationMeta.perPage + newAgents.length) < responseTotal\n              }\n            }));\n          }\n        } catch (error) {\n          console.error('Failed to load more agents:', error);\n          set({ \n            error: error instanceof Error ? error.message : 'Failed to load more agents',\n            loading: false \n          });\n        }\n      },\n\n      /**\n       * Search for a specific agent by ID or name\n       * Useful for enterprise accounts with many projects\n       */\n      findAgent: async (query: string | number) => {\n        try {\n          const client = getClient();\n          \n          // If query is numeric, assume it's an ID and try to fetch directly\n          if (typeof query === 'number' || /^\\d+$/.test(query.toString())) {\n            const id = typeof query === 'number' ? query : parseInt(query.toString());\n            try {\n              const response = await client.getAgent(id);\n              const agent = response.data;\n              \n              // Add to agents list if not already present\n              const state = get();\n              if (!state.agents.find(a => a.id === agent.id)) {\n                set(state => ({ \n                  agents: [agent, ...state.agents] \n                }));\n              }\n              \n              return agent;\n            } catch {\n              // ID not found or no access, fall through to search\n            }\n          }\n          \n          // For text search, we'd need a search endpoint (not implemented in current API)\n          // For now, search within loaded agents\n          const state = get();\n          const found = state.agents.find(agent => \n            agent.project_name.toLowerCase().includes(query.toString().toLowerCase()) ||\n            agent.id.toString() === query.toString()\n          );\n          \n          return found || null;\n        } catch (error) {\n          console.error('Failed to find agent:', error);\n          return null;\n        }\n      },\n\n      /**\n       * Create a new agent\n       * \n       * @param data - Agent creation data\n       * @param data.project_name - Display name for the agent\n       * @param data.sitemap_path - URL for sitemap-based training\n       * @param data.files - Files for file-based training\n       * @param data.is_shared - Whether agent is publicly accessible\n       * \n       * Behavior:\n       * - Adds new agent to beginning of list\n       * - Auto-selects the new agent\n       * - Returns the created agent\n       * - Throws error on failure\n       */\n      createAgent: async (data: {\n        project_name: string;\n        sitemap_path?: string;\n        files?: File[];\n        is_shared?: boolean;\n      }) => {\n        set({ loading: true, error: null });\n        \n        try {\n          const client = getClient();\n          const response = await client.createAgent(data);\n          const newAgent = response.data;\n          \n          // Optimistic update - add to list and select immediately\n          set(state => ({ \n            agents: [newAgent, ...state.agents],\n            currentAgent: newAgent,\n            loading: false,\n          }));\n          \n          return newAgent;\n        } catch (error) {\n          console.error('Failed to create agent:', error);\n          set({ \n            error: error instanceof Error ? error.message : 'Failed to create agent',\n            loading: false \n          });\n          throw error; // Re-throw for component error handling\n        }\n      },\n\n      /**\n       * Select an agent as the current active agent\n       * This agent will be used for all chat operations\n       * \n       * @param agent - The agent to select\n       */\n      selectAgent: async (agent: Agent) => {\n        // Clear conversation state when switching agents\n        const conversationStore = useConversationStore.getState();\n        const messageStore = useMessageStore.getState();\n        \n        // Set the new agent first\n        set({ currentAgent: agent });\n        \n        // Clear current conversation to show welcome screen\n        conversationStore.selectConversation(null);\n        \n        // Clear all messages from the previous agent\n        messageStore.clearMessages();\n        \n        // Clear any error state from the previous agent\n        messageStore.clearError();\n        \n        // Fetch agent settings to get avatar and other details\n        try {\n          const client = getClient();\n          const settingsResponse = await client.getAgentSettings(agent.id);\n          if (settingsResponse && settingsResponse.data) {\n            // Update the agent with settings\n            const agentWithSettings = { ...agent, settings: settingsResponse.data };\n            set({ currentAgent: agentWithSettings });\n            \n            // Also update in the agents list\n            set(state => ({\n              agents: state.agents.map(a => \n                a.id === agent.id ? agentWithSettings : a\n              )\n            }));\n          }\n        } catch (error) {\n          console.error('Failed to fetch agent settings:', error);\n          // Continue without settings\n        }\n        \n        // Fetch conversations for the new agent\n        try {\n          await conversationStore.fetchConversations(agent.id);\n        } catch (error) {\n          console.error('Failed to fetch conversations for new agent:', error);\n          // Even if fetch fails, we've already cleared the old state\n        }\n      },\n\n      /**\n       * Manually set the agents list\n       * Used for optimistic updates or manual state management\n       * \n       * Features:\n       * - Validates current agent still exists\n       * - Auto-selects first agent if current is removed\n       * - Maintains agent selection when possible\n       * \n       * @param agents - New list of agents\n       */\n      setAgents: (agents: Agent[]) => {\n        set({ \n          agents,\n          // Update current agent if it's no longer in the list\n          currentAgent: (() => {\n            const current = get().currentAgent;\n            if (!current) return agents.length > 0 ? agents[0] : null;\n            \n            // Check if current agent still exists in new list\n            const stillExists = agents.find(a => a.id === current.id);\n            return stillExists || (agents.length > 0 ? agents[0] : null);\n          })()\n        });\n      },\n      \n      updateAgent: async (id: number, data: { project_name?: string; are_licenses_allowed?: boolean; is_shared?: boolean; sitemap_path?: string }) => {\n        set({ loading: true, error: null });\n        \n        try {\n          const client = getClient();\n          const response = await client.updateAgent(id, data);\n          console.log('[AgentStore] updateAgent response:', response);\n          const updatedAgent = response.data;\n          console.log('[AgentStore] updatedAgent data:', updatedAgent);\n          \n          set(state => ({\n            agents: state.agents.map(a => a.id === id ? updatedAgent : a),\n            currentAgent: state.currentAgent?.id === id ? updatedAgent : state.currentAgent,\n            loading: false,\n          }));\n          \n          return updatedAgent;\n        } catch (error) {\n          console.error('Failed to update agent:', error);\n          set({ \n            error: error instanceof Error ? error.message : 'Failed to update agent',\n            loading: false \n          });\n          throw error;\n        }\n      },\n\n      /**\n       * Update agent settings\n       * Updates configuration like chatbot model, appearance, behavior, etc.\n       */\n      updateSettings: async (id: number, settings: Partial<AgentSettings>) => {\n        set({ loading: true, error: null });\n        \n        try {\n          const client = getClient();\n          \n          // Create FormData for the update\n          const formData = new FormData();\n          \n          // Only append the fields we want to update\n          Object.entries(settings).forEach(([key, value]) => {\n            if (value !== undefined && value !== null) {\n              formData.append(key, String(value));\n            }\n          });\n          \n          const response = await client.updateAgentSettings(id, formData);\n          console.log('[AgentStore] updateSettings response:', response);\n          const updatedSettings = response.data;\n          \n          // Update the agent with new settings\n          set(state => {\n            const updatedAgents = state.agents.map(agent => {\n              if (agent.id === id) {\n                return { ...agent, settings: { ...agent.settings, ...updatedSettings } };\n              }\n              return agent;\n            });\n            \n            const updatedCurrentAgent = state.currentAgent?.id === id \n              ? { ...state.currentAgent, settings: { ...state.currentAgent.settings, ...updatedSettings } }\n              : state.currentAgent;\n            \n            return {\n              agents: updatedAgents,\n              currentAgent: updatedCurrentAgent,\n              loading: false,\n            };\n          });\n          \n          return updatedSettings;\n        } catch (error) {\n          console.error('Failed to update agent settings:', error);\n          set({ \n            error: error instanceof Error ? error.message : 'Failed to update agent settings',\n            loading: false \n          });\n          throw error;\n        }\n      },\n      \n      deleteAgent: async (id: number) => {\n        set({ loading: true, error: null });\n        \n        try {\n          const client = getClient();\n          await client.deleteAgent(id);\n          \n          set(state => {\n            const filteredAgents = state.agents.filter(a => a.id !== id);\n            return {\n              agents: filteredAgents,\n              currentAgent: state.currentAgent?.id === id \n                ? (filteredAgents.length > 0 ? filteredAgents[0] : null)\n                : state.currentAgent,\n              loading: false,\n            };\n          });\n        } catch (error) {\n          console.error('Failed to delete agent:', error);\n          set({ \n            error: error instanceof Error ? error.message : 'Failed to delete agent',\n            loading: false \n          });\n          throw error;\n        }\n      },\n      \n      replicateAgent: async (id: number) => {\n        set({ loading: true, error: null });\n        \n        try {\n          const client = getClient();\n          const response = await client.replicateAgent(id);\n          const newAgent = response.data;\n          \n          set(state => ({ \n            agents: [newAgent, ...state.agents],\n            currentAgent: newAgent,\n            loading: false,\n          }));\n          \n          return newAgent;\n        } catch (error) {\n          console.error('Failed to replicate agent:', error);\n          set({ \n            error: error instanceof Error ? error.message : 'Failed to replicate agent',\n            loading: false \n          });\n          throw error;\n        }\n      },\n      \n      getAgentStats: async (id: number) => {\n        try {\n          const client = getClient();\n          const response = await client.getAgentStats(id);\n          return response.data;\n        } catch (error) {\n          console.error('Failed to get agent stats:', error);\n          throw error;\n        }\n      },\n    }),\n    {\n      name: 'customgpt-agents',\n      partialize: (state) => ({\n        currentAgent: state.currentAgent,\n      }),\n    }\n  )\n);","/**\n * Mathematical utilities for voice themes\n * \n * Common mathematical functions and helpers used across different voice themes\n */\n\n/**\n * Linear interpolation between two values\n */\nexport const lerp = (start: number, end: number, factor: number): number => {\n  return start + (end - start) * factor;\n};\n\n/**\n * Smooth step interpolation (ease in/out)\n */\nexport const smoothStep = (edge0: number, edge1: number, x: number): number => {\n  const t = Math.max(0, Math.min(1, (x - edge0) / (edge1 - edge0)));\n  return t * t * (3 - 2 * t);\n};\n\n/**\n * Clamp a value between min and max\n */\nexport const clamp = (value: number, min: number, max: number): number => {\n  return Math.max(min, Math.min(max, value));\n};\n\n/**\n * Map a value from one range to another\n */\nexport const map = (value: number, inMin: number, inMax: number, outMin: number, outMax: number): number => {\n  return ((value - inMin) / (inMax - inMin)) * (outMax - outMin) + outMin;\n};\n\n/**\n * Generate random number between min and max\n */\nexport const random = (min: number, max: number): number => {\n  return Math.random() * (max - min) + min;\n};\n\n/**\n * Generate random integer between min and max (inclusive)\n */\nexport const randomInt = (min: number, max: number): number => {\n  return Math.floor(Math.random() * (max - min + 1)) + min;\n};\n\n/**\n * Distance between two 2D points\n */\nexport const distance2D = (x1: number, y1: number, x2: number, y2: number): number => {\n  const dx = x2 - x1;\n  const dy = y2 - y1;\n  return Math.sqrt(dx * dx + dy * dy);\n};\n\n/**\n * Distance between two 3D points\n */\nexport const distance3D = (x1: number, y1: number, z1: number, x2: number, y2: number, z2: number): number => {\n  const dx = x2 - x1;\n  const dy = y2 - y1;\n  const dz = z2 - z1;\n  return Math.sqrt(dx * dx + dy * dy + dz * dz);\n};\n\n/**\n * Normalize angle to 0-2 range\n */\nexport const normalizeAngle = (angle: number): number => {\n  while (angle < 0) angle += 2 * Math.PI;\n  while (angle >= 2 * Math.PI) angle -= 2 * Math.PI;\n  return angle;\n};\n\n/**\n * Convert degrees to radians\n */\nexport const degToRad = (degrees: number): number => {\n  return degrees * (Math.PI / 180);\n};\n\n/**\n * Convert radians to degrees\n */\nexport const radToDeg = (radians: number): number => {\n  return radians * (180 / Math.PI);\n};\n\n/**\n * Sine wave with customizable amplitude, frequency, and phase\n */\nexport const sineWave = (time: number, amplitude: number = 1, frequency: number = 1, phase: number = 0): number => {\n  return amplitude * Math.sin(frequency * time + phase);\n};\n\n/**\n * Cosine wave with customizable amplitude, frequency, and phase\n */\nexport const cosineWave = (time: number, amplitude: number = 1, frequency: number = 1, phase: number = 0): number => {\n  return amplitude * Math.cos(frequency * time + phase);\n};\n\n/**\n * 3D rotation around X axis\n */\nexport const rotateX = (x: number, y: number, z: number, angle: number): [number, number, number] => {\n  const cos = Math.cos(angle);\n  const sin = Math.sin(angle);\n  return [\n    x,\n    y * cos - z * sin,\n    y * sin + z * cos\n  ];\n};\n\n/**\n * 3D rotation around Y axis\n */\nexport const rotateY = (x: number, y: number, z: number, angle: number): [number, number, number] => {\n  const cos = Math.cos(angle);\n  const sin = Math.sin(angle);\n  return [\n    x * cos + z * sin,\n    y,\n    -x * sin + z * cos\n  ];\n};\n\n/**\n * 3D rotation around Z axis\n */\nexport const rotateZ = (x: number, y: number, z: number, angle: number): [number, number, number] => {\n  const cos = Math.cos(angle);\n  const sin = Math.sin(angle);\n  return [\n    x * cos - y * sin,\n    x * sin + y * cos,\n    z\n  ];\n};\n\n/**\n * 3D to 2D projection\n */\nexport const project3D = (x: number, y: number, z: number, focalLength: number, centerX: number, centerY: number): [number, number] => {\n  const scale = focalLength / (focalLength - z);\n  return [\n    x * scale + centerX,\n    y * scale + centerY\n  ];\n};\n\n/**\n * Cubic bezier curve interpolation\n */\nexport const cubicBezier = (t: number, p0: number, p1: number, p2: number, p3: number): number => {\n  const oneMinusT = 1 - t;\n  return oneMinusT * oneMinusT * oneMinusT * p0 +\n         3 * oneMinusT * oneMinusT * t * p1 +\n         3 * oneMinusT * t * t * p2 +\n         t * t * t * p3;\n};\n\n/**\n * Noise function (simplified Perlin-like noise)\n */\nexport const noise = (x: number, y: number = 0): number => {\n  const n = Math.sin(x * 12.9898 + y * 78.233) * 43758.5453;\n  return (n - Math.floor(n)) * 2 - 1;\n};\n\n/**\n * HSL to RGB conversion\n */\nexport const hslToRgb = (h: number, s: number, l: number): [number, number, number] => {\n  h = h / 360;\n  s = s / 100;\n  l = l / 100;\n\n  const hue2rgb = (p: number, q: number, t: number): number => {\n    if (t < 0) t += 1;\n    if (t > 1) t -= 1;\n    if (t < 1/6) return p + (q - p) * 6 * t;\n    if (t < 1/2) return q;\n    if (t < 2/3) return p + (q - p) * (2/3 - t) * 6;\n    return p;\n  };\n\n  if (s === 0) {\n    return [l * 255, l * 255, l * 255];\n  } else {\n    const q = l < 0.5 ? l * (1 + s) : l + s - l * s;\n    const p = 2 * l - q;\n    return [\n      Math.round(hue2rgb(p, q, h + 1/3) * 255),\n      Math.round(hue2rgb(p, q, h) * 255),\n      Math.round(hue2rgb(p, q, h - 1/3) * 255)\n    ];\n  }\n};\n\n/**\n * Easing functions - these are aliases for common easing patterns\n */\nexport const easeInOutQuart = (t: number): number => {\n  return t < 0.5 ? 8 * t * t * t * t : 1 - 8 * (--t) * t * t * t;\n};\n\nexport const easeInOutCubic = (t: number): number => {\n  return t < 0.5 ? 4 * t * t * t : (t - 1) * (2 * t - 2) * (2 * t - 2) + 1;\n};\n\nexport const easeOutBounce = (t: number): number => {\n  if (t < 1 / 2.75) {\n    return 7.5625 * t * t;\n  } else if (t < 2 / 2.75) {\n    return 7.5625 * (t -= 1.5 / 2.75) * t + 0.75;\n  } else if (t < 2.5 / 2.75) {\n    return 7.5625 * (t -= 2.25 / 2.75) * t + 0.9375;\n  } else {\n    return 7.5625 * (t -= 2.625 / 2.75) * t + 0.984375;\n  }\n};\n\nexport const easeInOutSine = (t: number): number => {\n  return -(Math.cos(Math.PI * t) - 1) / 2;\n};\n\nexport const easeInOutExpo = (t: number): number => {\n  if (t === 0) return 0;\n  if (t === 1) return 1;\n  return t < 0.5\n    ? Math.pow(2, 20 * t - 10) / 2\n    : (2 - Math.pow(2, -20 * t + 10)) / 2;\n};\n\n/**\n * 2D Perlin-like noise function\n */\nexport const noise2D = (x: number, y: number): number => {\n  const n = Math.sin(x * 12.9898 + y * 78.233) * 43758.5453;\n  return (n - Math.floor(n)) * 2 - 1;\n};\n\n/**\n * Alias for smoothStep to maintain compatibility\n */\nexport const smoothstep = smoothStep;","/**\n * Default Theme - Classic Particle Sphere\n * \n * The original particle sphere theme, refactored to use the new theme system.\n * Features a 3D rotating sphere of particles with smooth color transitions.\n */\n\nimport { BaseTheme } from './BaseTheme';\nimport { VoiceState } from './IVoiceTheme';\nimport { lerp } from '../utils/math';\nimport { ObjectPool } from '../utils/performance';\n\ninterface Particle {\n  x: number;\n  y: number;\n  z: number;\n  velX: number;\n  velY: number;\n  velZ: number;\n  age: number;\n  dead: boolean;\n  right: boolean;\n  projX: number;\n  projY: number;\n  alpha: number;\n  attack: number;\n  hold: number;\n  decay: number;\n  initValue: number;\n  holdValue: number;\n  lastValue: number;\n  stuckTime: number;\n  accelX: number;\n  accelY: number;\n  accelZ: number;\n  next?: Particle;\n  prev?: Particle;\n}\n\ninterface ColorPalette {\n  r: number;\n  g: number;\n  b: number;\n  gradient: number[];\n}\n\ninterface ColorScheme {\n  idle: ColorPalette;\n  userSpeaking: ColorPalette;\n  processing: ColorPalette;\n  aiSpeaking: ColorPalette;\n  hover: ColorPalette;\n}\n\nexport class DefaultTheme extends BaseTheme {\n  readonly id = 'default';\n  readonly name = 'Classic Sphere';\n  readonly description = 'The original 3D particle sphere with smooth color transitions';\n  readonly category = 'particle' as const;\n  readonly performanceProfile = 'medium' as const;\n\n  // Sphere configuration\n  private sphereRadius = 280;\n  private radiusScale = 1;\n  private framesPerRotation = 5000;\n  private focalLength = 320;\n  private zeroAlphaDepth = -750;\n  private sphereCenterY = 0;\n  private sphereCenterZ = -3 - this.sphereRadius;\n\n  // Particle system\n  private particlePool: ObjectPool<Particle>;\n  private particleList: { first?: Particle } = {};\n  private recycleBin: { first?: Particle } = {};\n  private currentParticleCount = 0;\n  private maxParticles = 200;\n\n  // Color system\n  private currentR = 52;\n  private currentG = 235;\n  private currentB = 222;\n  private targetR = 52;\n  private targetG = 235;\n  private targetB = 222;\n  private colorTransitionSpeed = 0.05;\n  private currentColorScheme = 'gemini';\n\n  // Animation parameters\n  private turnAngle = 1;\n  private wait = 2;\n  private count = 0;\n  private numToAddEachFrame = 3;\n  private particleAlpha = 1;\n  private particleRad = 2.5;\n  private gravity = 0;\n  private randAccelX = 0.1;\n  private randAccelY = 0.1;\n  private randAccelZ = 0.1;\n\n  // Color schemes\n  private colorSchemes: Record<string, ColorScheme> = {\n    gemini: {\n      idle: { r: 66, g: 133, b: 244, gradient: [66, 133, 244, 52, 168, 83] },\n      userSpeaking: { r: 234, g: 67, b: 53, gradient: [234, 67, 53, 251, 188, 5] },\n      processing: { r: 155, g: 64, b: 224, gradient: [155, 64, 224, 66, 133, 244] },\n      aiSpeaking: { r: 52, g: 168, b: 83, gradient: [52, 168, 83, 66, 133, 244] },\n      hover: { r: 251, g: 188, b: 5, gradient: [251, 188, 5, 234, 67, 53] }\n    },\n    instagram: {\n      idle: { r: 228, g: 64, b: 95, gradient: [228, 64, 95, 247, 119, 55] },\n      userSpeaking: { r: 247, g: 119, b: 55, gradient: [247, 119, 55, 252, 175, 69] },\n      processing: { r: 193, g: 53, b: 132, gradient: [193, 53, 132, 228, 64, 95] },\n      aiSpeaking: { r: 252, g: 175, b: 69, gradient: [252, 175, 69, 247, 119, 55] },\n      hover: { r: 131, g: 58, b: 180, gradient: [131, 58, 180, 193, 53, 132] }\n    },\n    ocean: {\n      idle: { r: 0, g: 119, b: 190, gradient: [0, 119, 190, 0, 168, 232] },\n      userSpeaking: { r: 0, g: 168, b: 232, gradient: [0, 168, 232, 0, 201, 255] },\n      processing: { r: 0, g: 201, b: 255, gradient: [0, 201, 255, 100, 255, 218] },\n      aiSpeaking: { r: 100, g: 255, b: 218, gradient: [100, 255, 218, 0, 168, 232] },\n      hover: { r: 0, g: 150, b: 199, gradient: [0, 150, 199, 0, 201, 255] }\n    },\n    sunset: {\n      idle: { r: 255, g: 107, b: 107, gradient: [255, 107, 107, 255, 193, 7] },\n      userSpeaking: { r: 255, g: 193, b: 7, gradient: [255, 193, 7, 255, 142, 83] },\n      processing: { r: 255, g: 142, b: 83, gradient: [255, 142, 83, 255, 107, 107] },\n      aiSpeaking: { r: 255, g: 230, b: 109, gradient: [255, 230, 109, 255, 193, 7] },\n      hover: { r: 255, g: 171, b: 64, gradient: [255, 171, 64, 255, 107, 107] }\n    },\n    aurora: {\n      idle: { r: 0, g: 201, b: 255, gradient: [0, 201, 255, 146, 254, 157] },\n      userSpeaking: { r: 146, g: 254, b: 157, gradient: [146, 254, 157, 0, 255, 193] },\n      processing: { r: 0, g: 255, b: 193, gradient: [0, 255, 193, 186, 85, 255] },\n      aiSpeaking: { r: 186, g: 85, b: 255, gradient: [186, 85, 255, 0, 201, 255] },\n      hover: { r: 120, g: 255, b: 214, gradient: [120, 255, 214, 186, 85, 255] }\n    }\n  };\n\n  constructor() {\n    super();\n    \n    // Initialize particle pool\n    this.particlePool = new ObjectPool<Particle>(\n      () => ({\n        x: 0, y: 0, z: 0, velX: 0, velY: 0, velZ: 0,\n        age: 0, dead: false, right: false, projX: 0, projY: 0, alpha: 0,\n        attack: 0, hold: 0, decay: 0, initValue: 0, holdValue: 0, lastValue: 0,\n        stuckTime: 0, accelX: 0, accelY: 0, accelZ: 0\n      }),\n      (particle) => {\n        particle.age = 0;\n        particle.dead = false;\n        particle.alpha = 0;\n        particle.next = undefined;\n        particle.prev = undefined;\n      },\n      50,\n      this.maxParticles\n    );\n\n    this.setColor(this.getColorPalette().idle);\n  }\n\n  protected onInit(): void {\n    this.maxParticles = this.getMaxParticles();\n  }\n\n  protected onDraw(\n    context: CanvasRenderingContext2D,\n    width: number,\n    height: number,\n    centerX: number,\n    centerY: number,\n    deltaTime: number\n  ): void {\n    this.updateColors();\n    this.updateParticles(context, width, height, centerX, centerY);\n    this.renderParticles(context, width, height, centerX, centerY);\n  }\n\n  protected onStateChange(newState: VoiceState): void {\n    const palette = this.getColorPalette();\n    \n    switch (newState) {\n      case VoiceState.USER_SPEAKING:\n        this.framesPerRotation = 2000;\n        this.colorTransitionSpeed = 0.15;\n        this.setColor(palette.userSpeaking);\n        this.numToAddEachFrame = 5;\n        this.particleAlpha = 1.2;\n        this.particleRad = 3.5;\n        this.gravity = 0.1;\n        break;\n        \n      case VoiceState.PROCESSING:\n        this.framesPerRotation = 500;\n        this.colorTransitionSpeed = 0.2;\n        this.setColor(palette.processing);\n        this.numToAddEachFrame = 8;\n        this.particleAlpha = 1.5;\n        this.particleRad = 4;\n        this.gravity = 0;\n        break;\n        \n      case VoiceState.AI_SPEAKING:\n        this.framesPerRotation = 2500;\n        this.colorTransitionSpeed = 0.1;\n        this.setColor(palette.aiSpeaking);\n        this.numToAddEachFrame = 4;\n        this.particleAlpha = 1.3;\n        this.particleRad = 3;\n        this.gravity = -0.05;\n        break;\n        \n      case VoiceState.IDLE:\n      default:\n        this.framesPerRotation = 5000;\n        this.colorTransitionSpeed = 0.05;\n        this.setColor(palette.idle);\n        this.numToAddEachFrame = 3;\n        this.particleAlpha = 1;\n        this.particleRad = 2.5;\n        this.gravity = 0;\n        break;\n    }\n  }\n\n  protected getThemeSpecificMetrics() {\n    return {\n      particleCount: this.currentParticleCount,\n      maxParticles: this.maxParticles,\n      colorScheme: this.currentColorScheme\n    };\n  }\n\n  /**\n   * Set color scheme (public method for external use)\n   */\n  setColorScheme(scheme: string): void {\n    if (this.colorSchemes[scheme]) {\n      this.currentColorScheme = scheme;\n      // Update current color based on current state\n      const palette = this.getColorPalette();\n      this.setColor(palette.idle); // Will be overridden by current state\n    }\n  }\n\n  // Private methods - core particle system logic\n\n  private getColorPalette(): ColorScheme {\n    return this.colorSchemes[this.currentColorScheme] || this.colorSchemes.gemini;\n  }\n\n  private setColor(palette: ColorPalette): void {\n    this.targetR = palette.r;\n    this.targetG = palette.g;\n    this.targetB = palette.b;\n  }\n\n  private updateColors(): void {\n    this.currentR = lerp(this.currentR, this.targetR, this.colorTransitionSpeed);\n    this.currentG = lerp(this.currentG, this.targetG, this.colorTransitionSpeed);\n    this.currentB = lerp(this.currentB, this.targetB, this.colorTransitionSpeed);\n  }\n\n  private updateParticles(\n    context: CanvasRenderingContext2D,\n    width: number,\n    height: number,\n    centerX: number,\n    centerY: number\n  ): void {\n    // Create new particles\n    this.count++;\n    if (this.count >= this.wait && this.currentParticleCount < this.maxParticles) {\n      this.count = 0;\n      const dynamicNumParticles = Math.floor(this.numToAddEachFrame * (1 + this.mouseInfluence * 0.5));\n      const particlesToCreate = Math.min(dynamicNumParticles, this.maxParticles - this.currentParticleCount);\n      \n      for (let i = 0; i < particlesToCreate; i++) {\n        this.createParticle();\n      }\n    }\n\n    // Update rotation\n    const turnSpeed = 2 * Math.PI / this.framesPerRotation;\n    const dynamicTurnSpeed = turnSpeed * (1 + this.mouseInfluence * 0.3);\n    this.turnAngle = (this.turnAngle + dynamicTurnSpeed) % (2 * Math.PI);\n  }\n\n  private createParticle(): void {\n    const theta = Math.random() * 2 * Math.PI;\n    const phi = Math.acos(Math.random() * 2 - 1);\n    \n    // Add mouse influence to particle positioning\n    const mouseDistortion = this.mouseInfluence * 0.3;\n    const mouseBias = {\n      x: this.normalizedMouseX * mouseDistortion * this.sphereRadius * 0.5,\n      y: this.normalizedMouseY * mouseDistortion * this.sphereRadius * 0.5,\n      z: 0\n    };\n    \n    const x0 = this.sphereRadius * Math.sin(phi) * Math.cos(theta) + mouseBias.x;\n    const y0 = this.sphereRadius * Math.sin(phi) * Math.sin(theta) + mouseBias.y;\n    const z0 = this.sphereRadius * Math.cos(phi) + mouseBias.z;\n\n    const velocityMultiplier = 0.002 * (1 + this.mouseInfluence * 0.5);\n    const particle = this.addParticle(\n      x0,\n      this.sphereCenterY + y0,\n      this.sphereCenterZ + z0,\n      velocityMultiplier * x0,\n      velocityMultiplier * y0,\n      velocityMultiplier * z0\n    );\n\n    // Set particle envelope parameters\n    const alphaMultiplier = 1 + this.mouseInfluence * 0.3;\n    particle.attack = Math.floor(30 / (1 + this.mouseInfluence * 0.5));\n    particle.hold = Math.floor(30 * (1 + this.mouseInfluence * 0.5));\n    particle.decay = 60;\n    particle.initValue = 0;\n    particle.holdValue = this.particleAlpha * alphaMultiplier;\n    particle.lastValue = 0;\n    particle.stuckTime = Math.floor((45 + Math.random() * 15) / (1 + this.mouseInfluence * 0.3));\n\n    // Enhanced acceleration with mouse influence\n    particle.accelX = this.normalizedMouseX * this.mouseInfluence * 0.001;\n    particle.accelY = this.gravity + (this.normalizedMouseY * this.mouseInfluence * 0.001);\n    particle.accelZ = 0;\n  }\n\n  private addParticle(x0: number, y0: number, z0: number, vx0: number, vy0: number, vz0: number): Particle {\n    const newParticle = this.particlePool.acquire();\n    this.currentParticleCount++;\n\n    // Add to beginning of particle list\n    if (this.particleList.first) {\n      newParticle.next = this.particleList.first;\n      this.particleList.first.prev = newParticle;\n    }\n    this.particleList.first = newParticle;\n    newParticle.prev = undefined;\n\n    // Initialize particle\n    newParticle.x = x0;\n    newParticle.y = y0;\n    newParticle.z = z0;\n    newParticle.velX = vx0;\n    newParticle.velY = vy0;\n    newParticle.velZ = vz0;\n    newParticle.age = 0;\n    newParticle.dead = false;\n    newParticle.right = Math.random() < 0.5;\n\n    return newParticle;\n  }\n\n  private renderParticles(\n    context: CanvasRenderingContext2D,\n    width: number,\n    height: number,\n    centerX: number,\n    centerY: number\n  ): void {\n    const sinAngle = Math.sin(this.turnAngle);\n    const cosAngle = Math.cos(this.turnAngle);\n    const zMax = this.focalLength - 2;\n\n    let particle = this.particleList.first;\n    \n    while (particle) {\n      const nextParticle = particle.next;\n\n      // Update particle age\n      particle.age++;\n\n      // Move particle if not stuck\n      if (particle.age > particle.stuckTime) {\n        particle.velX += particle.accelX + this.randAccelX * (Math.random() * 2 - 1);\n        particle.velY += particle.accelY + this.randAccelY * (Math.random() * 2 - 1);\n        particle.velZ += particle.accelZ + this.randAccelZ * (Math.random() * 2 - 1);\n\n        particle.x += particle.velX;\n        particle.y += particle.velY;\n        particle.z += particle.velZ;\n      }\n\n      // Calculate 3D rotation and projection\n      const rotX = cosAngle * particle.x + sinAngle * (particle.z - this.sphereCenterZ);\n      const rotZ = -sinAngle * particle.x + cosAngle * (particle.z - this.sphereCenterZ) + this.sphereCenterZ;\n      const m = this.radiusScale * this.focalLength / (this.focalLength - rotZ);\n      \n      particle.projX = rotX * m + centerX;\n      particle.projY = particle.y * m + centerY;\n\n      // Update alpha based on envelope\n      this.updateParticleAlpha(particle);\n\n      // Check if particle should be rendered or recycled\n      const outsideTest = (\n        particle.projX > width || particle.projX < 0 ||\n        particle.projY < 0 || particle.projY > height ||\n        rotZ > zMax\n      );\n\n      if (outsideTest || particle.dead) {\n        this.recycleParticle(particle);\n      } else {\n        this.renderParticle(context, particle, rotZ, m);\n      }\n\n      particle = nextParticle;\n    }\n  }\n\n  private updateParticleAlpha(particle: Particle): void {\n    if (particle.age < particle.attack + particle.hold + particle.decay) {\n      if (particle.age < particle.attack) {\n        particle.alpha = (particle.holdValue - particle.initValue) / particle.attack * particle.age + particle.initValue;\n      } else if (particle.age < particle.attack + particle.hold) {\n        particle.alpha = particle.holdValue;\n      } else {\n        particle.alpha = (particle.lastValue - particle.holdValue) / particle.decay * (particle.age - particle.attack - particle.hold) + particle.holdValue;\n      }\n    } else {\n      particle.dead = true;\n    }\n  }\n\n  private renderParticle(context: CanvasRenderingContext2D, particle: Particle, rotZ: number, scale: number): void {\n    // Depth-dependent alpha\n    const depthAlphaFactor = Math.max(0, Math.min(1, 1 - rotZ / this.zeroAlphaDepth));\n    const finalAlpha = depthAlphaFactor * particle.alpha;\n    const particleSize = scale * this.particleRad * (1 + this.mouseInfluence * 0.2);\n\n    // Draw main particle\n    context.fillStyle = `rgba(${Math.floor(this.currentR)}, ${Math.floor(this.currentG)}, ${Math.floor(this.currentB)}, ${finalAlpha})`;\n    context.beginPath();\n    context.arc(particle.projX, particle.projY, particleSize, 0, 2 * Math.PI);\n    context.fill();\n\n    // Draw glow effect if enabled and appropriate\n    if (this.shouldEnableGlow() && this.mouseInfluence > 0.5 && finalAlpha > 0.3) {\n      context.fillStyle = `rgba(${Math.floor(this.currentR)}, ${Math.floor(this.currentG)}, ${Math.floor(this.currentB)}, ${finalAlpha * 0.3})`;\n      context.beginPath();\n      context.arc(particle.projX, particle.projY, particleSize * 1.5, 0, 2 * Math.PI);\n      context.fill();\n    }\n  }\n\n  private recycleParticle(particle: Particle): void {\n    this.currentParticleCount = Math.max(0, this.currentParticleCount - 1);\n\n    // Remove from particle list\n    if (this.particleList.first === particle) {\n      this.particleList.first = particle.next;\n      if (particle.next) {\n        particle.next.prev = undefined;\n      }\n    } else {\n      if (particle.prev) {\n        particle.prev.next = particle.next;\n      }\n      if (particle.next) {\n        particle.next.prev = particle.prev;\n      }\n    }\n\n    // Return to pool\n    this.particlePool.release(particle);\n  }\n\n  protected onDispose(): void {\n    // Clean up all particles\n    this.particleList.first = undefined;\n    this.currentParticleCount = 0;\n    this.particlePool.clear();\n  }\n}","/**\n * Performance monitoring utilities for voice themes\n * \n * Provides performance tracking, FPS monitoring, and device capability detection\n */\n\nexport interface PerformanceMetrics {\n  fps: number;\n  frameTime: number;\n  memoryUsage?: number;\n  particleCount?: number;\n  objectCount?: number;\n  drawCalls?: number;\n}\n\nexport interface DeviceCapabilities {\n  isMobile: boolean;\n  isLowPowerDevice: boolean;\n  supportsWebGL: boolean;\n  hardwareConcurrency: number;\n  memoryGB?: number;\n  performanceLevel: 'low' | 'medium' | 'high';\n}\n\n/**\n * Performance monitor for tracking FPS and frame timing\n */\nexport class PerformanceMonitor {\n  private frameCount = 0;\n  private lastTime = 0;\n  private currentFPS = 60;\n  private frameTime = 16.67;\n  private fpsHistory: number[] = [];\n  private frameTimeHistory: number[] = [];\n  private maxHistorySize = 60; // Keep 1 second of history at 60fps\n  private warningThreshold = 0.8;\n  private criticalThreshold = 0.6;\n\n  private callbacks: {\n    onFPSUpdate?: (fps: number) => void;\n    onPerformanceWarning?: (metrics: PerformanceMetrics) => void;\n    onPerformanceCritical?: (metrics: PerformanceMetrics) => void;\n  } = {};\n\n  constructor(targetFPS = 60) {\n    this.lastTime = performance.now();\n  }\n\n  /**\n   * Call this every frame to update performance metrics\n   */\n  update(): PerformanceMetrics {\n    const currentTime = performance.now();\n    const deltaTime = currentTime - this.lastTime;\n    this.frameTime = deltaTime;\n    \n    // Update FPS calculation\n    this.frameCount++;\n    const fps = 1000 / deltaTime;\n    this.fpsHistory.push(fps);\n    this.frameTimeHistory.push(deltaTime);\n\n    // Keep history size manageable\n    if (this.fpsHistory.length > this.maxHistorySize) {\n      this.fpsHistory.shift();\n      this.frameTimeHistory.shift();\n    }\n\n    // Calculate average FPS over recent history\n    const avgFPS = this.fpsHistory.reduce((sum, fps) => sum + fps, 0) / this.fpsHistory.length;\n    this.currentFPS = avgFPS;\n\n    // Check for performance issues\n    const targetFPS = 30; // Conservative target for voice themes\n    const performanceRatio = avgFPS / targetFPS;\n\n    if (performanceRatio < this.criticalThreshold) {\n      this.callbacks.onPerformanceCritical?.({\n        fps: avgFPS,\n        frameTime: deltaTime\n      });\n    } else if (performanceRatio < this.warningThreshold) {\n      this.callbacks.onPerformanceWarning?.({\n        fps: avgFPS,\n        frameTime: deltaTime\n      });\n    }\n\n    // Update callbacks\n    if (this.frameCount % 30 === 0) { // Update every 30 frames (~0.5 seconds)\n      this.callbacks.onFPSUpdate?.(avgFPS);\n    }\n\n    this.lastTime = currentTime;\n\n    return {\n      fps: avgFPS,\n      frameTime: deltaTime\n    };\n  }\n\n  /**\n   * Set performance monitoring callbacks\n   */\n  setCallbacks(callbacks: typeof this.callbacks) {\n    this.callbacks = { ...this.callbacks, ...callbacks };\n  }\n\n  /**\n   * Get current performance metrics\n   */\n  getCurrentMetrics(): PerformanceMetrics {\n    return {\n      fps: this.currentFPS,\n      frameTime: this.frameTime\n    };\n  }\n\n  /**\n   * Reset performance tracking\n   */\n  reset() {\n    this.frameCount = 0;\n    this.fpsHistory = [];\n    this.frameTimeHistory = [];\n    this.lastTime = performance.now();\n  }\n}\n\n/**\n * Detect device capabilities for performance optimization\n */\nexport class DeviceCapabilityDetector {\n  private static instance: DeviceCapabilityDetector;\n  private capabilities: DeviceCapabilities | null = null;\n\n  static getInstance(): DeviceCapabilityDetector {\n    if (!DeviceCapabilityDetector.instance) {\n      DeviceCapabilityDetector.instance = new DeviceCapabilityDetector();\n    }\n    return DeviceCapabilityDetector.instance;\n  }\n\n  /**\n   * Detect and cache device capabilities\n   */\n  async detectCapabilities(): Promise<DeviceCapabilities> {\n    if (this.capabilities) {\n      return this.capabilities;\n    }\n\n    const isMobile = this.detectMobile();\n    const supportsWebGL = this.detectWebGL();\n    const hardwareConcurrency = navigator.hardwareConcurrency || 4;\n    \n    let memoryGB: number | undefined;\n    if ('memory' in (navigator as any)) {\n      memoryGB = (navigator as any).memory.jsHeapSizeLimit / (1024 ** 3);\n    }\n\n    // Performance benchmarking\n    const performanceLevel = await this.benchmarkPerformance();\n    const isLowPowerDevice = this.detectLowPowerDevice(hardwareConcurrency, memoryGB, performanceLevel);\n\n    this.capabilities = {\n      isMobile,\n      isLowPowerDevice,\n      supportsWebGL,\n      hardwareConcurrency,\n      memoryGB,\n      performanceLevel\n    };\n\n    return this.capabilities;\n  }\n\n  private detectMobile(): boolean {\n    return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);\n  }\n\n  private detectWebGL(): boolean {\n    try {\n      const canvas = document.createElement('canvas');\n      return !!(canvas.getContext('webgl') || canvas.getContext('experimental-webgl'));\n    } catch {\n      return false;\n    }\n  }\n\n  private detectLowPowerDevice(cores: number, memoryGB?: number, performanceLevel?: string): boolean {\n    // Heuristics for low-power device detection\n    if (cores <= 2) return true;\n    if (memoryGB && memoryGB < 2) return true;\n    if (performanceLevel === 'low') return true;\n    return false;\n  }\n\n  private async benchmarkPerformance(): Promise<'low' | 'medium' | 'high'> {\n    return new Promise((resolve) => {\n      const startTime = performance.now();\n      let operations = 0;\n      const maxTime = 50; // 50ms benchmark window\n\n      const benchmark = () => {\n        const currentTime = performance.now();\n        if (currentTime - startTime >= maxTime) {\n          // Classify performance based on operations completed\n          if (operations < 100000) {\n            resolve('low');\n          } else if (operations < 500000) {\n            resolve('medium');\n          } else {\n            resolve('high');\n          }\n          return;\n        }\n\n        // Simple mathematical operations\n        for (let i = 0; i < 1000; i++) {\n          Math.sin(Math.random() * Math.PI * 2);\n          operations++;\n        }\n\n        requestAnimationFrame(benchmark);\n      };\n\n      requestAnimationFrame(benchmark);\n    });\n  }\n\n  /**\n   * Get cached capabilities or detect if not available\n   */\n  getCapabilities(): DeviceCapabilities | null {\n    return this.capabilities;\n  }\n}\n\n/**\n * Memory pool for efficient particle/object management\n */\nexport class ObjectPool<T> {\n  private available: T[] = [];\n  private inUse = new Set<T>();\n  private createFn: () => T;\n  private resetFn?: (obj: T) => void;\n  private maxSize: number;\n\n  constructor(createFn: () => T, resetFn?: (obj: T) => void, initialSize = 10, maxSize = 1000) {\n    this.createFn = createFn;\n    this.resetFn = resetFn;\n    this.maxSize = maxSize;\n\n    // Pre-populate pool\n    for (let i = 0; i < initialSize; i++) {\n      this.available.push(this.createFn());\n    }\n  }\n\n  /**\n   * Get an object from the pool\n   */\n  acquire(): T {\n    let obj: T;\n\n    if (this.available.length > 0) {\n      obj = this.available.pop()!;\n    } else if (this.inUse.size < this.maxSize) {\n      obj = this.createFn();\n    } else {\n      // Pool is full, reuse oldest object\n      const oldest = this.inUse.values().next().value;\n      if (oldest) {\n        this.release(oldest);\n        obj = oldest;\n      } else {\n        // Fallback: create new object if somehow there's nothing to reuse\n        obj = this.createFn();\n      }\n    }\n\n    this.inUse.add(obj);\n    return obj;\n  }\n\n  /**\n   * Return an object to the pool\n   */\n  release(obj: T): void {\n    if (this.inUse.has(obj)) {\n      this.inUse.delete(obj);\n      if (this.resetFn) {\n        this.resetFn(obj);\n      }\n      this.available.push(obj);\n    }\n  }\n\n  /**\n   * Get pool statistics\n   */\n  getStats() {\n    return {\n      available: this.available.length,\n      inUse: this.inUse.size,\n      total: this.available.length + this.inUse.size\n    };\n  }\n\n  /**\n   * Clear the entire pool\n   */\n  clear(): void {\n    this.available = [];\n    this.inUse.clear();\n  }\n}\n\n/**\n * Utility to get optimal performance settings based on device capabilities\n */\nexport const getOptimalSettings = async (): Promise<{\n  targetFPS: number;\n  maxParticles: number;\n  enableEffects: boolean;\n  enableGlow: boolean;\n  qualityLevel: 'low' | 'medium' | 'high';\n}> => {\n  const detector = DeviceCapabilityDetector.getInstance();\n  const capabilities = await detector.detectCapabilities();\n\n  if (capabilities.performanceLevel === 'low' || capabilities.isLowPowerDevice) {\n    return {\n      targetFPS: 24,\n      maxParticles: 50,\n      enableEffects: false,\n      enableGlow: false,\n      qualityLevel: 'low'\n    };\n  } else if (capabilities.performanceLevel === 'medium') {\n    return {\n      targetFPS: 30,\n      maxParticles: 150,\n      enableEffects: true,\n      enableGlow: false,\n      qualityLevel: 'medium'\n    };\n  } else {\n    return {\n      targetFPS: 60,\n      maxParticles: 300,\n      enableEffects: true,\n      enableGlow: true,\n      qualityLevel: 'high'\n    };\n  }\n};","/**\n * Theme utilities for persistent theme management\n * \n * Uses cookies for theme persistence to ensure the theme\n * is available during server-side rendering and prevents\n * flash of incorrect theme on page load.\n */\n\nexport type Theme = 'light' | 'dark';\n\nconst THEME_COOKIE_NAME = 'customgpt-theme';\nconst THEME_COOKIE_MAX_AGE = 365 * 24 * 60 * 60; // 1 year in seconds\n\n/**\n * Get theme from cookie\n */\nexport function getThemeFromCookie(): Theme {\n  if (typeof window === 'undefined') return 'light';\n  \n  const cookies = document.cookie.split(';');\n  const themeCookie = cookies.find(cookie => \n    cookie.trim().startsWith(`${THEME_COOKIE_NAME}=`)\n  );\n  \n  if (themeCookie) {\n    const value = themeCookie.split('=')[1].trim();\n    return value === 'dark' ? 'dark' : 'light';\n  }\n  \n  return 'light';\n}\n\n/**\n * Set theme in cookie\n */\nexport function setThemeCookie(theme: Theme) {\n  if (typeof window === 'undefined') return;\n  \n  // Set cookie with max age and path\n  document.cookie = `${THEME_COOKIE_NAME}=${theme}; max-age=${THEME_COOKIE_MAX_AGE}; path=/; SameSite=Lax`;\n}\n\n/**\n * Apply theme to document\n */\nexport function applyThemeToDocument(theme: Theme) {\n  if (typeof window === 'undefined') return;\n  \n  if (theme === 'dark') {\n    document.documentElement.classList.add('dark');\n  } else {\n    document.documentElement.classList.remove('dark');\n  }\n}\n\n/**\n * Initialize theme from cookie and apply to document\n */\nexport function initializeTheme(): Theme {\n  const theme = getThemeFromCookie();\n  applyThemeToDocument(theme);\n  return theme;\n}\n\n/**\n * Set theme and persist to cookie\n */\nexport function setTheme(theme: Theme) {\n  setThemeCookie(theme);\n  applyThemeToDocument(theme);\n}","import { create } from 'zustand';\nimport { persist } from 'zustand/middleware';\nimport type { ConfigStore } from '@/types';\nimport { setTheme as setThemeUtil, getThemeFromCookie, initializeTheme } from '@/lib/theme';\n\n/**\n * Configuration Store\n * \n * Updated to remove API key storage for security.\n * API key is now stored securely on the server.\n * Theme is persisted using cookies for better SSR support.\n */\nexport const useConfigStore = create<ConfigStore>()(\n  persist(\n    (set, get) => ({\n      apiKey: null, // Deprecated - kept for interface compatibility\n      baseURL: 'https://app.customgpt.ai/api/v1', // Not used anymore, server handles this\n      theme: (typeof window !== 'undefined' ? getThemeFromCookie() : 'light') as 'light' | 'dark',\n\n      setApiKey: (key: string) => {\n        // No-op - API key is not stored client-side anymore\n        // This method is kept for backward compatibility\n        console.warn('API key storage has been disabled for security. Configure API key in server environment variables.');\n      },\n\n      setBaseURL: (url: string) => {\n        // No-op - base URL is configured on server\n        console.warn('Base URL configuration has been moved to server. Update CUSTOMGPT_API_BASE_URL in environment variables.');\n      },\n\n      setTheme: (theme: 'light' | 'dark') => {\n        set({ theme });\n        \n        // Update cookie and document class for theme\n        if (typeof window !== 'undefined') {\n          setThemeUtil(theme);\n        }\n      },\n    }),\n    {\n      name: 'customgpt-config',\n      // Only persist non-sensitive data\n      partialize: (state) => ({\n        theme: state.theme,\n      }),\n      onRehydrateStorage: () => (state) => {\n        // Initialize theme from cookie on rehydration\n        if (typeof window !== 'undefined') {\n          const theme = initializeTheme();\n          if (state && state.theme !== theme) {\n            state.theme = theme;\n          }\n        }\n      },\n    }\n  )\n);","import { create } from 'zustand';\nimport { persist } from 'zustand/middleware';\nimport type { UIStore } from '@/types';\n\nexport const useUIStore = create<UIStore>()(\n  persist(\n    (set) => ({\n      sidebarOpen: true,\n      settingsOpen: false,\n      theme: 'light',\n      fontSize: 'md',\n\n      setSidebarOpen: (open: boolean) => {\n        set({ sidebarOpen: open });\n      },\n\n      setSettingsOpen: (open: boolean) => {\n        set({ settingsOpen: open });\n      },\n\n      setTheme: (theme: 'light' | 'dark') => {\n        set({ theme });\n        \n        // Apply theme to document\n        if (typeof window !== 'undefined') {\n          document.documentElement.className = theme;\n        }\n      },\n\n      setFontSize: (size: 'sm' | 'md' | 'lg') => {\n        set({ fontSize: size });\n        \n        // Apply font size to document\n        if (typeof window !== 'undefined') {\n          const root = document.documentElement;\n          root.classList.remove('text-sm', 'text-base', 'text-lg');\n          \n          switch (size) {\n            case 'sm':\n              root.classList.add('text-sm');\n              break;\n            case 'lg':\n              root.classList.add('text-lg');\n              break;\n            default:\n              root.classList.add('text-base');\n          }\n        }\n      },\n    }),\n    {\n      name: 'customgpt-ui',\n      partialize: (state) => ({\n        sidebarOpen: state.sidebarOpen,\n        theme: state.theme,\n        fontSize: state.fontSize,\n      }),\n      onRehydrateStorage: () => (state) => {\n        // Apply theme and font size on rehydration\n        if (typeof window !== 'undefined' && state) {\n          document.documentElement.className = state.theme;\n          \n          const root = document.documentElement;\n          root.classList.remove('text-sm', 'text-base', 'text-lg');\n          \n          switch (state.fontSize) {\n            case 'sm':\n              root.classList.add('text-sm');\n              break;\n            case 'lg':\n              root.classList.add('text-lg');\n              break;\n            default:\n              root.classList.add('text-base');\n          }\n        }\n      },\n    }\n  )\n);","import { create } from 'zustand';\nimport { getClient } from '@/lib/api/client';\nimport { toast } from 'sonner';\n\nexport interface AnalyticsData {\n  conversations: {\n    total: number;\n    active: number;\n    trend: number;\n    data: Array<{\n      date: string;\n      count: number;\n    }>;\n  };\n  queries: {\n    total: number;\n    successful: number;\n    failed: number;\n    avgResponseTime: number;\n    topQueries: Array<{\n      query: string;\n      count: number;\n    }>;\n    data: Array<{\n      date: string;\n      count: number;\n    }>;\n  };\n  traffic: {\n    uniqueUsers: number;\n    pageViews: number;\n    avgSessionDuration: number;\n    bounceRate: number;\n    data: Array<{\n      date: string;\n      users: number;\n      pageViews: number;\n    }>;\n  };\n  statistics: {\n    totalMessages: number;\n    totalConversations: number;\n    avgMessagesPerConversation: number;\n    satisfactionRate: number;\n    responseAccuracy: number;\n  };\n}\n\ninterface AnalyticsState {\n  analytics: AnalyticsData | null;\n  loading: boolean;\n  error: string | null;\n  dateRange: {\n    startDate: string;\n    endDate: string;\n  };\n  \n  // Actions\n  fetchAnalytics: (projectId: number) => Promise<void>;\n  setDateRange: (startDate: string, endDate: string) => void;\n  exportAnalytics: (format: 'csv' | 'json' | 'pdf') => Promise<void>;\n  reset: () => void;\n}\n\n// Helper function to format dates for API\nconst formatDate = (date: Date): string => {\n  return date.toISOString().split('T')[0];\n};\n\n// Get default date range (last 30 days)\nconst getDefaultDateRange = () => {\n  const endDate = new Date();\n  const startDate = new Date();\n  startDate.setDate(startDate.getDate() - 30);\n  \n  return {\n    startDate: formatDate(startDate),\n    endDate: formatDate(endDate),\n  };\n};\n\nexport const useAnalyticsStore = create<AnalyticsState>((set, get) => ({\n  analytics: null,\n  loading: false,\n  error: null,\n  dateRange: getDefaultDateRange(),\n\n  fetchAnalytics: async (projectId: number) => {\n    set({ loading: true, error: null });\n    \n    try {\n      const client = getClient();\n      \n      // Fetch all reports data in parallel using documented endpoints\n      const [trafficReport, queriesReport, conversationsReport, analysisReport] = await Promise.all([\n        client.getTrafficReport(projectId),\n        client.getQueriesReport(projectId),\n        client.getConversationsReport(projectId),\n        client.getAnalysisReport(projectId, 'daily'),\n      ]);\n\n      // Transform the data to match our interface using actual API response structure\n      // Handle cases where API returns empty arrays instead of numbers\n      const conversationsTotal = Array.isArray(conversationsReport.data?.total) ? 0 : (conversationsReport.data?.total || 0);\n      const queriesTotal = Array.isArray(queriesReport.data?.total) ? 0 : (queriesReport.data?.total || 0);\n      const avgQueriesPerConv = Array.isArray(conversationsReport.data?.average_queries_per_conversation) \n        ? 0 \n        : (Number(conversationsReport.data?.average_queries_per_conversation) || 0);\n\n      const analyticsData: AnalyticsData = {\n        conversations: {\n          total: conversationsTotal,\n          active: Math.floor(conversationsTotal * 0.7), // Estimate active conversations\n          trend: 0, // Calculate trend from data if needed\n          data: Array.isArray(analysisReport.data?.conversations) \n            ? analysisReport.data.conversations.map((item: any) => ({\n                date: item.created_at_interval,\n                count: Number(item.queries_number) || 0,\n              }))\n            : [],\n        },\n        queries: {\n          total: queriesTotal,\n          successful: Array.isArray(queriesReport.data?.query_status) \n            ? (queriesReport.data.query_status.find((s: any) => s.status === 'success')?.count || 0)\n            : 0,\n          failed: Array.isArray(queriesReport.data?.query_status)\n            ? (queriesReport.data.query_status.find((s: any) => s.status === 'failed')?.count || 0)\n            : 0,\n          avgResponseTime: 0, // Not provided by API\n          topQueries: [], // Not provided by these endpoints\n          data: Array.isArray(analysisReport.data?.queries)\n            ? analysisReport.data.queries.map((item: any) => ({\n                date: item.created_at_interval,\n                count: Number(item.queries_number) || 0,\n              }))\n            : [],\n        },\n        traffic: {\n          uniqueUsers: Array.isArray(trafficReport.data?.sources)\n            ? trafficReport.data.sources.reduce((acc: number, source: any) => acc + (source.request_source_number || 0), 0)\n            : 0,\n          pageViews: Array.isArray(trafficReport.data?.sources)\n            ? trafficReport.data.sources.reduce((acc: number, source: any) => acc + (source.request_source_number || 0), 0)\n            : 0,\n          avgSessionDuration: 0, // Not provided by API\n          bounceRate: 0, // Not provided by API\n          data: Array.isArray(trafficReport.data?.sources)\n            ? trafficReport.data.sources.map((source: any) => ({\n                date: new Date().toISOString().split('T')[0], // Current date as traffic report doesn't have dates\n                users: source.request_source_number || 0,\n                pageViews: source.request_source_number || 0,\n              }))\n            : [],\n        },\n        statistics: {\n          totalMessages: queriesTotal,\n          totalConversations: conversationsTotal,\n          avgMessagesPerConversation: avgQueriesPerConv,\n          satisfactionRate: 0, // Not provided by API\n          responseAccuracy: 0, // Not provided by API\n        },\n      };\n\n      set({ analytics: analyticsData, loading: false });\n    } catch (error: any) {\n      console.error('Failed to fetch analytics:', error);\n      \n      let errorMessage = 'Failed to fetch analytics';\n      if (error.status === 401) {\n        const deploymentMode = typeof window !== 'undefined' ? localStorage.getItem('customgpt.deploymentMode') : 'production';\n        const isDemoMode = deploymentMode === 'demo';\n        if (isDemoMode) {\n          errorMessage = 'API key authentication failed. Please check your API key.';\n          toast.error('Authentication failed. Please check your API key in demo settings.');\n        } else {\n          errorMessage = 'Authentication required. Please check your API key configuration.';\n          toast.error('Authentication failed. Please check your API key configuration.');\n        }\n      } else if (error.status === 404) {\n        errorMessage = 'Analytics data not found for this project.';\n        toast.error('No analytics data available yet.');\n      } else if (error.status === 500) {\n        errorMessage = 'Server error occurred. Please try again later.';\n        toast.error('Server error. Please try again later.');\n      } else {\n        toast.error('Failed to fetch analytics data');\n      }\n      \n      set({ \n        analytics: null,\n        error: errorMessage,\n        loading: false,\n      });\n    }\n  },\n\n  setDateRange: (startDate: string, endDate: string) => {\n    set({ dateRange: { startDate, endDate } });\n  },\n\n  exportAnalytics: async (format: 'csv' | 'json' | 'pdf') => {\n    const analytics = get().analytics;\n    if (!analytics) {\n      toast.error('No analytics data to export');\n      return;\n    }\n\n    try {\n      // Implementation would depend on the format\n      switch (format) {\n        case 'json':\n          const jsonData = JSON.stringify(analytics, null, 2);\n          const blob = new Blob([jsonData], { type: 'application/json' });\n          const url = URL.createObjectURL(blob);\n          const a = document.createElement('a');\n          a.href = url;\n          a.download = `analytics-${new Date().toISOString()}.json`;\n          document.body.appendChild(a);\n          a.click();\n          document.body.removeChild(a);\n          URL.revokeObjectURL(url);\n          toast.success('Analytics exported successfully');\n          break;\n          \n        case 'csv':\n          // Would need a CSV conversion library or custom implementation\n          toast.info('CSV export not yet implemented');\n          break;\n          \n        case 'pdf':\n          // Would need a PDF generation library\n          toast.info('PDF export not yet implemented');\n          break;\n      }\n    } catch (error) {\n      console.error('Failed to export analytics:', error);\n      toast.error('Failed to export analytics');\n    }\n  },\n\n  reset: () => {\n    set({\n      analytics: null,\n      loading: false,\n      error: null,\n      dateRange: getDefaultDateRange(),\n    });\n  },\n}));","import { create } from 'zustand';\nimport { getClient, isClientInitialized } from '@/lib/api/client';\nimport { toast } from 'sonner';\nimport type { Page, PagesQueryParams } from '@/types/pages.types';\n\ninterface PagesState {\n  pages: Page[];\n  loading: boolean;\n  error: string | null;\n  paginationInfo: {\n    current_page: number;\n    total: number;\n    per_page: number;\n    last_page: number;\n  };\n  queryParams: PagesQueryParams;\n  \n  // Actions\n  fetchPages: (projectId: number) => Promise<void>;\n  deletePage: (projectId: number, pageId: number) => Promise<void>;\n  reindexPage: (projectId: number, pageId: number) => Promise<void>;\n  \n  // UI State\n  setQueryParams: (params: Partial<PagesQueryParams>) => void;\n  reset: () => void;\n}\n\nexport const usePageStore = create<PagesState>((set, get) => ({\n  pages: [],\n  loading: false,\n  error: null,\n  paginationInfo: {\n    current_page: 1,\n    total: 0,\n    per_page: 20,\n    last_page: 1\n  },\n  queryParams: {\n    page: 1,\n    limit: 20,\n    order: 'desc',\n    crawl_status: 'all',\n    index_status: 'all'\n  },\n\n  fetchPages: async (projectId: number) => {\n    if (!isClientInitialized()) {\n      set({ error: 'API client not initialized' });\n      return;\n    }\n\n    set({ loading: true, error: null });\n    \n    try {\n      const client = getClient();\n      const { queryParams } = get();\n      const response = await client.getPages(projectId, queryParams);\n      \n      set({ \n        pages: response.data.pages.data,\n        paginationInfo: {\n          current_page: response.data.pages.current_page,\n          total: response.data.pages.total,\n          per_page: response.data.pages.per_page,\n          last_page: response.data.pages.last_page\n        },\n        loading: false \n      });\n    } catch (error: any) {\n      console.error('Failed to fetch pages:', error);\n      \n      let errorMessage = 'Failed to fetch pages';\n      if (error.status === 400) {\n        errorMessage = 'Invalid request. Please check the project ID.';\n      } else if (error.status === 401) {\n        errorMessage = 'Authentication failed. Please log in again.';\n      } else if (error.status === 404) {\n        errorMessage = 'Project not found.';\n      } else if (error.status === 500) {\n        errorMessage = 'Server error. Please try again later.';\n      }\n      \n      set({ \n        error: errorMessage,\n        loading: false,\n      });\n      toast.error(errorMessage);\n    }\n  },\n\n  deletePage: async (projectId: number, pageId: number) => {\n    if (!isClientInitialized()) {\n      toast.error('API client not initialized');\n      return;\n    }\n\n    set({ loading: true, error: null });\n    \n    try {\n      const client = getClient();\n      await client.deletePage(projectId, pageId);\n      \n      set(state => ({\n        pages: state.pages.filter(page => page.id !== pageId),\n        loading: false,\n      }));\n      \n      toast.success('Page deleted successfully');\n    } catch (error: any) {\n      console.error('Failed to delete page:', error);\n      \n      let errorMessage = 'Failed to delete page';\n      if (error.status === 401) {\n        errorMessage = 'Authentication failed. Please log in again.';\n      } else if (error.status === 404) {\n        errorMessage = 'Page not found.';\n      }\n      \n      set({ \n        error: errorMessage,\n        loading: false,\n      });\n      toast.error(errorMessage);\n    }\n  },\n\n  reindexPage: async (projectId: number, pageId: number) => {\n    if (!isClientInitialized()) {\n      toast.error('API client not initialized');\n      return;\n    }\n\n    set({ loading: true, error: null });\n    \n    try {\n      const client = getClient();\n      await client.reindexPage(projectId, pageId);\n      \n      // Update local state to show queued status\n      set(state => ({\n        pages: state.pages.map(page => \n          page.id === pageId \n            ? { ...page, crawl_status: 'queued', index_status: 'queued' }\n            : page\n        ),\n        loading: false,\n      }));\n      \n      toast.success('Page reindexing started');\n    } catch (error: any) {\n      console.error('Failed to reindex page:', error);\n      \n      let errorMessage = 'Failed to reindex page';\n      if (error.status === 401) {\n        errorMessage = 'Authentication failed. Please log in again.';\n      } else if (error.status === 403) {\n        errorMessage = 'The page could not be reindexed.';\n      }\n      \n      set({ \n        error: errorMessage,\n        loading: false,\n      });\n      toast.error(errorMessage);\n    }\n  },\n\n  setQueryParams: (params: Partial<PagesQueryParams>) => {\n    set(state => ({\n      queryParams: { ...state.queryParams, ...params },\n    }));\n  },\n\n  reset: () => {\n    set({\n      pages: [],\n      loading: false,\n      error: null,\n      paginationInfo: {\n        current_page: 1,\n        total: 0,\n        per_page: 20,\n        last_page: 1\n      },\n      queryParams: {\n        page: 1,\n        limit: 20,\n        order: 'desc',\n        crawl_status: 'all',\n        index_status: 'all'\n      },\n    });\n  },\n}));","// Sources store - provides state management for source data\n// Currently uses direct API calls in components\n\nimport { create } from 'zustand';\nimport { getClient } from '@/lib/api/client';\nimport { toast } from 'sonner';\n\nexport interface Source {\n  id: string;\n  project_id: number;\n  name: string;\n  type: 'file' | 'url' | 'text' | 'api';\n  status: 'active' | 'inactive' | 'processing' | 'error';\n  size?: number;\n  file_type?: string;\n  url?: string;\n  content?: string;\n  metadata?: {\n    description?: string;\n    tags?: string[];\n    author?: string;\n    lastIndexed?: string;\n    [key: string]: any;\n  };\n  created_at: string;\n  updated_at: string;\n  indexed_at?: string;\n  error_message?: string;\n}\n\ninterface SourcesState {\n  sources: Source[];\n  currentSource: Source | null;\n  loading: boolean;\n  error: string | null;\n  searchQuery: string;\n  filter: {\n    status?: 'active' | 'inactive' | 'processing' | 'error' | 'all';\n    type?: 'file' | 'url' | 'text' | 'api' | 'all';\n    sortBy?: 'name' | 'created_at' | 'updated_at' | 'size';\n    sortOrder?: 'asc' | 'desc';\n  };\n  syncStatus: {\n    syncing: boolean;\n    lastSync?: string;\n    progress?: number;\n  };\n  \n  // Actions\n  fetchSources: (projectId: number) => Promise<void>;\n  fetchSource: (projectId: number, sourceId: string) => Promise<void>;\n  uploadSources: (projectId: number, files: File[]) => Promise<void>;\n  updateSource: (projectId: number, sourceId: string, updates: Partial<Source>) => Promise<void>;\n  deleteSource: (projectId: number, sourceId: string) => Promise<void>;\n  bulkDelete: (projectId: number, sourceIds: string[]) => Promise<void>;\n  syncSources: (projectId: number) => Promise<void>;\n  \n  // UI State\n  setSearchQuery: (query: string) => void;\n  setFilter: (filter: Partial<SourcesState['filter']>) => void;\n  selectSource: (source: Source | null) => void;\n  reset: () => void;\n}\n\n// Store implementation for source management\nexport const useSourceStore = create<SourcesState>((set, get) => ({\n  sources: [],\n  currentSource: null,\n  loading: false,\n  error: null,\n  searchQuery: '',\n  filter: {\n    status: 'all',\n    type: 'all',\n    sortBy: 'updated_at',\n    sortOrder: 'desc',\n  },\n  syncStatus: {\n    syncing: false,\n  },\n\n  fetchSources: async (projectId: number) => {\n    set({ loading: true, error: null });\n    \n    try {\n      const client = getClient();\n      const response = await client.getSources(projectId);\n      \n      // Extract all sources from sitemaps and uploads\n      const allSources: Source[] = [];\n      \n      if (response.data.sitemaps) {\n        // Map API source structure to store's Source interface\n        response.data.sitemaps.forEach((apiSource: any) => {\n          allSources.push({\n            id: apiSource.id.toString(),\n            project_id: projectId,\n            name: apiSource.settings.sitemap_path || `Source ${apiSource.id}`,\n            type: 'url', // Map 'sitemap' to 'url'\n            status: 'active',\n            metadata: {\n              ...apiSource.settings,\n              pages: apiSource.pages,\n            },\n            created_at: apiSource.created_at,\n            updated_at: apiSource.updated_at,\n          });\n        });\n      }\n      \n      if (response.data.uploads) {\n        const uploads = Array.isArray(response.data.uploads) \n          ? response.data.uploads \n          : [response.data.uploads];\n          \n        uploads.forEach((apiSource: any) => {\n          allSources.push({\n            id: apiSource.id.toString(),\n            project_id: projectId,\n            name: `Upload ${apiSource.id}`,\n            type: 'file',\n            status: 'active',\n            metadata: {\n              ...apiSource.settings,\n              pages: apiSource.pages,\n            },\n            created_at: apiSource.created_at,\n            updated_at: apiSource.updated_at,\n          });\n        });\n      }\n      \n      set({ sources: allSources, loading: false });\n    } catch (error) {\n      set({ \n        error: error instanceof Error ? error.message : 'Failed to fetch sources',\n        loading: false,\n      });\n      toast.error('Failed to load sources');\n    }\n  },\n\n  fetchSource: async (projectId: number, sourceId: string) => {\n    set({ loading: true, error: null });\n    \n    try {\n      // const client = getClient();\n      // const response = await client.getSource(projectId, sourceId);\n      \n      // const source = response.data;\n      // set({ currentSource: source, loading: false });\n      throw new Error('getSource API method not available');\n      \n      // Update in the list as well\n      // set(state => ({\n      //   sources: state.sources.map(s => s.id === sourceId ? source : s),\n      // }));\n    } catch (error) {\n      set({ \n        error: error instanceof Error ? error.message : 'Failed to fetch source',\n        loading: false,\n      });\n      toast.error('Failed to load source details');\n    }\n  },\n\n  uploadSources: async (projectId: number, files: File[]) => {\n    set({ loading: true, error: null });\n    \n    try {\n      const client = getClient();\n      \n      // Upload files one by one for better progress tracking\n      const uploadPromises = files.map(file => \n        Promise.reject(new Error('uploadFile API method not available'))\n      );\n      \n      const responses = await Promise.all(uploadPromises);\n      \n      // Refresh sources list\n      await get().fetchSources(projectId);\n      \n      toast.success(`Successfully uploaded ${files.length} file(s)`);\n      set({ loading: false });\n    } catch (error) {\n      set({ \n        error: error instanceof Error ? error.message : 'Failed to upload sources',\n        loading: false,\n      });\n      toast.error('Failed to upload files');\n      throw error;\n    }\n  },\n\n  updateSource: async (projectId: number, sourceId: string, updates: Partial<Source>) => {\n    set({ loading: true, error: null });\n    \n    try {\n      const client = getClient();\n      // await client.updateSource(projectId, sourceId, {\n      throw new Error('updateSource API method not available');\n      /*\n        name: updates.name,\n        metadata: updates.metadata,\n        status: updates.status,\n      }); */\n      \n      set(state => ({\n        sources: state.sources.map(source => \n          source.id === sourceId \n            ? { ...source, ...updates, updated_at: new Date().toISOString() } \n            : source\n        ),\n        currentSource: state.currentSource?.id === sourceId \n          ? { ...state.currentSource, ...updates, updated_at: new Date().toISOString() }\n          : state.currentSource,\n        loading: false,\n      }));\n      \n      toast.success('Source updated successfully');\n    } catch (error) {\n      set({ \n        error: error instanceof Error ? error.message : 'Failed to update source',\n        loading: false,\n      });\n      toast.error('Failed to update source');\n      throw error;\n    }\n  },\n\n  deleteSource: async (projectId: number, sourceId: string) => {\n    set({ loading: true, error: null });\n    \n    try {\n      const client = getClient();\n      await client.deleteSource(projectId, parseInt(sourceId));\n      \n      set(state => ({\n        sources: state.sources.filter(source => source.id !== sourceId),\n        currentSource: state.currentSource?.id === sourceId ? null : state.currentSource,\n        loading: false,\n      }));\n      \n      toast.success('Source deleted successfully');\n    } catch (error) {\n      set({ \n        error: error instanceof Error ? error.message : 'Failed to delete source',\n        loading: false,\n      });\n      toast.error('Failed to delete source');\n      throw error;\n    }\n  },\n\n  bulkDelete: async (projectId: number, sourceIds: string[]) => {\n    set({ loading: true, error: null });\n    \n    try {\n      const client = getClient();\n      \n      // Delete sources in parallel\n      await Promise.all(\n        sourceIds.map(sourceId => client.deleteSource(projectId, parseInt(sourceId)))\n      );\n      \n      set(state => ({\n        sources: state.sources.filter(source => !sourceIds.includes(source.id)),\n        currentSource: sourceIds.includes(state.currentSource?.id || '') \n          ? null \n          : state.currentSource,\n        loading: false,\n      }));\n      \n      toast.success(`Successfully deleted ${sourceIds.length} source(s)`);\n    } catch (error) {\n      set({ \n        error: error instanceof Error ? error.message : 'Failed to delete sources',\n        loading: false,\n      });\n      toast.error('Failed to delete sources');\n      throw error;\n    }\n  },\n\n  syncSources: async (projectId: number) => {\n    set(state => ({\n      syncStatus: { ...state.syncStatus, syncing: true, progress: 0 }\n    }));\n    \n    try {\n      const client = getClient();\n      // await client.syncSources(projectId);\n      throw new Error('syncSources API method not available');\n      \n      // Refresh sources after sync\n      await get().fetchSources(projectId);\n      \n      set(state => ({\n        syncStatus: {\n          syncing: false,\n          lastSync: new Date().toISOString(),\n          progress: 100,\n        }\n      }));\n      \n      toast.success('Sources synchronized successfully');\n    } catch (error) {\n      set(state => ({\n        syncStatus: { ...state.syncStatus, syncing: false },\n        error: error instanceof Error ? error.message : 'Failed to sync sources',\n      }));\n      toast.error('Failed to sync sources');\n      throw error;\n    }\n  },\n\n  setSearchQuery: (query: string) => {\n    set({ searchQuery: query });\n  },\n\n  setFilter: (filter: Partial<SourcesState['filter']>) => {\n    set(state => ({\n      filter: { ...state.filter, ...filter },\n    }));\n  },\n\n  selectSource: (source: Source | null) => {\n    set({ currentSource: source });\n  },\n\n  reset: () => {\n    set({\n      sources: [],\n      currentSource: null,\n      loading: false,\n      error: null,\n      searchQuery: '',\n      filter: {\n        status: 'all',\n        type: 'all',\n        sortBy: 'updated_at',\n        sortOrder: 'desc',\n      },\n      syncStatus: {\n        syncing: false,\n      },\n    });\n  },\n}));","import { create } from 'zustand';\nimport { persist } from 'zustand/middleware';\nimport { getClient } from '@/lib/api/client';\nimport { toast } from 'sonner';\nimport type { UserProfileStore, UserProfile } from '@/types';\n\n// CustomGPT.ai API Response format\ninterface CustomGPTResponse<T> {\n  status: 'success' | 'error';\n  data: T;\n}\n\nexport const useProfileStore = create<UserProfileStore>()(\n  persist(\n    (set, get) => ({\n      // Initial State\n      profile: null,\n      loading: false,\n      error: null,\n\n      // Profile Management - GET /api/v1/user\n      fetchProfile: async () => {\n        set({ loading: true, error: null });\n        \n        try {\n          const client = getClient();\n          const response = await client.getUserProfile();\n          \n          if (response.status === 'success') {\n            set({ \n              profile: response.data,\n              loading: false \n            });\n          } else {\n            throw new Error('Failed to fetch profile');\n          }\n        } catch (error: any) {\n          console.error('Failed to fetch profile:', error);\n          \n          let errorMessage = 'Failed to fetch profile';\n          \n          if (error.status === 401) {\n            const deploymentMode = typeof window !== 'undefined' ? localStorage.getItem('customgpt.deploymentMode') : null;\n            const isDemoMode = deploymentMode === 'demo';\n            if (isDemoMode) {\n              errorMessage = 'API key authentication failed. Please check your API key.';\n              toast.error('Authentication failed. Please check your API key in demo settings.');\n            } else {\n              errorMessage = 'Authentication required. Please check your API key configuration.';\n              toast.error('Authentication failed. Please check your API key configuration.');\n            }\n          } else if (error.status === 500) {\n            errorMessage = 'Server error occurred. Please try again later.';\n            toast.error('Server error. Please try again later.');\n          } else {\n            toast.error('Failed to load profile');\n          }\n          \n          set({ \n            error: errorMessage,\n            loading: false \n          });\n        }\n      },\n\n      // Profile Update - POST /api/v1/user (multipart/form-data)\n      updateProfile: async (name: string, profilePhoto?: File) => {\n        set({ loading: true, error: null });\n        \n        try {\n          const client = getClient();\n          \n          // Create FormData for multipart request\n          const formData = new FormData();\n          formData.append('name', name);\n          \n          if (profilePhoto) {\n            formData.append('profile_photo', profilePhoto);\n          }\n          \n          const response = await client.updateUserProfile(formData);\n          \n          if (response.status === 'success') {\n            set({ \n              profile: response.data,\n              loading: false \n            });\n            toast.success('Profile updated successfully');\n          } else {\n            throw new Error('Failed to update profile');\n          }\n        } catch (error: any) {\n          console.error('Failed to update profile:', error);\n          \n          let errorMessage = 'Failed to update profile';\n          \n          if (error.status === 401) {\n            const deploymentMode = typeof window !== 'undefined' ? localStorage.getItem('customgpt.deploymentMode') : null;\n            const isDemoMode = deploymentMode === 'demo';\n            if (isDemoMode) {\n              errorMessage = 'API key authentication failed. Please check your API key.';\n              toast.error('Authentication failed. Please check your API key in demo settings.');\n            } else {\n              errorMessage = 'Authentication required. Please check your API key configuration.';\n              toast.error('Authentication failed. Please check your API key configuration.');\n            }\n          } else if (error.status === 422 || error.status === 400) {\n            // Handle validation errors\n            if (error.data?.data?.errors) {\n              const errors = error.data.data.errors;\n              if (errors.profile_photo && Array.isArray(errors.profile_photo)) {\n                errorMessage = errors.profile_photo[0];\n                toast.error(errorMessage);\n              } else {\n                // Handle other validation errors\n                const firstError = Object.values(errors).flat()[0] as string;\n                errorMessage = firstError || 'Validation error occurred';\n                toast.error(errorMessage);\n              }\n            } else {\n              errorMessage = error.message || 'Validation error occurred';\n              toast.error(errorMessage);\n            }\n          } else if (error.status === 500) {\n            errorMessage = 'Server error occurred. Please try again later.';\n            toast.error('Server error. Please try again later.');\n          } else {\n            errorMessage = error.message || 'Failed to update profile';\n            toast.error(errorMessage);\n          }\n          \n          set({ \n            error: errorMessage,\n            loading: false \n          });\n        }\n      },\n\n      // Utility\n      reset: () => {\n        set({\n          profile: null,\n          loading: false,\n          error: null,\n        });\n      },\n    }),\n    {\n      name: 'profile-store',\n      partialize: (state) => ({\n        profile: state.profile,\n      }),\n    }\n  )\n);","import { create } from 'zustand';\nimport { toast } from 'sonner';\nimport { getClient } from '@/lib/api/client';\nimport type { APIResponse, AgentStats } from '@/types';\n\nexport interface ProjectSettings {\n  // Appearance\n  chatbot_avatar?: string;\n  chatbot_background_type?: 'image' | 'color';\n  chatbot_background?: string;\n  chatbot_background_color?: string;\n  chatbot_color?: string;\n  chatbot_toolbar_color?: string;\n  chatbot_title?: string;\n  chatbot_title_color?: string;\n  user_avatar?: string;\n  user_avatar_enabled?: boolean;\n  spotlight_avatar_enabled?: boolean;\n  spotlight_avatar?: string;\n  spotlight_avatar_shape?: 'rectangle' | 'circle';\n  spotlight_avatar_type?: 'default' | 'image';\n  user_avatar_orientation?: 'agent-left-user-right' | 'agent-right-user-left' | 'both-left' | 'both-right';\n  \n  // Messages & Behavior\n  default_prompt?: string;\n  example_questions?: string[];\n  persona_instructions?: string;\n  response_source?: 'default' | 'own_content' | 'openai_content';\n  chatbot_model?: string;\n  custom_persona?: string;\n  agent_capability?: 'fastest-responses' | 'optimal-choice' | 'advanced-reasoning' | 'complex-tasks';\n  chatbot_msg_lang?: string;\n  input_field_addendum?: string;\n  \n  // Messages\n  hang_in_there_msg?: string;\n  chatbot_siesta_msg?: string;\n  no_answer_message?: string;\n  ending_message?: string;\n  try_asking_questions_msg?: string;\n  view_more_msg?: string;\n  view_less_msg?: string;\n  \n  // Citations\n  enable_citations?: number;\n  citations_view_type?: 'user' | 'show' | 'hide';\n  citations_answer_source_label_msg?: string;\n  citations_sources_label_msg?: string;\n  image_citation_display?: 'default' | 'first_only';\n  enable_inline_citations_api?: boolean;\n  hide_sources_from_responses?: boolean;\n  \n  // Features\n  enable_feedbacks?: boolean;\n  is_loading_indicator_enabled?: boolean;\n  remove_branding?: boolean;\n  private_deployment?: boolean;\n  use_context_aware_starter_question?: boolean;\n  enable_recaptcha_for_public_chatbots?: boolean;\n  is_selling_enabled?: boolean;\n  license_slug?: boolean;\n  selling_url?: string;\n  can_share_conversation?: boolean;\n  can_export_conversation?: boolean;\n  conversation_time_window?: boolean;\n  conversation_retention_period?: 'day' | 'week' | 'month' | 'quarter' | 'year' | 'custom' | 'never';\n  conversation_retention_days?: number;\n  enable_agent_knowledge_base_awareness?: boolean;\n  markdown_enabled?: boolean;\n}\n\nexport interface ProjectPlugin {\n  id: string;\n  name: string;\n  enabled: boolean;\n  description?: string;\n  category?: string;\n  settings?: Record<string, any>;\n}\n\n// Using AgentStats from the API instead of custom ProjectStats\nexport type ProjectStats = AgentStats;\n\nexport interface ProjectSettingsStore {\n  // Settings\n  settings: ProjectSettings | null;\n  settingsLoading: boolean;\n  settingsError: string | null;\n\n  // Plugins\n  plugins: ProjectPlugin[];\n  pluginsLoading: boolean;\n  pluginsError: string | null;\n\n  // Stats\n  stats: ProjectStats | null;\n  statsLoading: boolean;\n  statsError: string | null;\n\n  // Actions\n  fetchSettings: (projectId: number) => Promise<void>;\n  updateSettings: (projectId: number, settings: Partial<ProjectSettings>) => Promise<void>;\n  fetchPlugins: (projectId: number) => Promise<void>;\n  updatePlugin: (projectId: number, pluginId: string, enabled: boolean) => Promise<void>;\n  fetchStats: (projectId: number) => Promise<void>;\n  reset: () => void;\n}\n\n// Track active requests to prevent duplicates\nconst activeRequests = new Map<string, boolean>();\n\nexport const useProjectSettingsStore = create<ProjectSettingsStore>((set, get) => ({\n  // Initial state\n  settings: null,\n  settingsLoading: false,\n  settingsError: null,\n  plugins: [],\n  pluginsLoading: false,\n  pluginsError: null,\n  stats: null,\n  statsLoading: false,\n  statsError: null,\n\n  // Fetch project settings\n  fetchSettings: async (projectId: number) => {\n    const requestKey = `settings-${projectId}`;\n    \n    // Prevent duplicate requests\n    if (activeRequests.get(requestKey)) {\n      return;\n    }\n    \n    activeRequests.set(requestKey, true);\n    \n    // Clear previous errors and set loading state\n    set({ settingsLoading: true, settingsError: null });\n\n    try {\n      const response = await getClient().getAgentSettings(projectId);\n\n      // The API client returns the data directly, not wrapped with status\n      if (response && response.data) {\n        set({ \n          settings: response.data, \n          settingsLoading: false,\n          settingsError: null // Explicitly clear error on success\n        });\n      } else if (response) {\n        // If response exists but doesn't have data property, it might be the direct data\n        set({ \n          settings: response as any, \n          settingsLoading: false,\n          settingsError: null\n        });\n      } else {\n        throw new Error('Failed to fetch project settings');\n      }\n    } catch (error) {\n      const errorMessage = error instanceof Error ? error.message : 'Failed to fetch project settings';\n      set({ \n        settingsError: errorMessage, \n        settingsLoading: false \n      });\n      // Only show toast for actual errors, not for expected scenarios\n      if (error instanceof Error && !error.message.includes('404')) {\n        toast.error(errorMessage);\n      }\n    } finally {\n      activeRequests.delete(requestKey);\n    }\n  },\n\n  // Update project settings\n  updateSettings: async (projectId: number, settingsUpdate: Partial<ProjectSettings>) => {\n    set({ settingsLoading: true, settingsError: null });\n\n    try {\n      // Create FormData for multipart/form-data\n      const formData = new FormData();\n      \n      // Default values for fields that API requires to have a value\n      const defaultValues: Record<string, string> = {\n        ending_message: 'Please email us for further support',\n        no_answer_message: 'Sorry, I don\\'t have an answer for that.',\n        try_asking_questions_msg: 'Try asking these questions...',\n        view_more_msg: 'View more',\n        view_less_msg: 'View less',\n        citations_answer_source_label_msg: 'Where did this answer come from?',\n        citations_sources_label_msg: 'Sources',\n        hang_in_there_msg: 'Hang in there! I\\'m thinking..',\n        chatbot_siesta_msg: 'Oops! The agent is taking a siesta. We are aware of this and will get it back soon! Please try again later.'\n      };\n\n      Object.entries(settingsUpdate).forEach(([key, value]) => {\n        if (value !== undefined && value !== null) {\n          if (key === 'example_questions' && Array.isArray(value)) {\n            // Handle array fields - use bracket notation without index\n            value.forEach((question) => {\n              formData.append(`example_questions[]`, question);\n            });\n          } else if (value instanceof File) {\n            // Handle file uploads\n            formData.append(key, value);\n          } else {\n            // Handle regular fields\n            // If the value is empty and there's a default, use the default\n            const stringValue = String(value);\n            if (stringValue === '' && defaultValues[key]) {\n              formData.append(key, defaultValues[key]);\n            } else {\n              formData.append(key, stringValue);\n            }\n          }\n        }\n      });\n\n      const response = await getClient().updateAgentSettings(projectId, formData);\n\n      // The API client returns the data directly\n      if (response) {\n        // Instead of merging, re-fetch the settings to ensure we have the latest data\n        set({ settingsLoading: false });\n        \n        // Re-fetch settings to get the updated data from server\n        await get().fetchSettings(projectId);\n        \n        toast.success('Project settings updated successfully');\n      } else {\n        throw new Error('Failed to update project settings');\n      }\n    } catch (error) {\n      const errorMessage = error instanceof Error ? error.message : 'Failed to update project settings';\n      set({ \n        settingsError: errorMessage, \n        settingsLoading: false \n      });\n      toast.error(errorMessage);\n    }\n  },\n\n  // Fetch project plugins\n  fetchPlugins: async (projectId: number) => {\n    set({ pluginsLoading: true, pluginsError: null });\n\n    try {\n      const response = await getClient().getProjectPlugins(projectId);\n\n      // The API client returns the data directly\n      if (response) {\n        const pluginsData = response.data || response;\n        set({ \n          plugins: Array.isArray(pluginsData) ? pluginsData : [], \n          pluginsLoading: false \n        });\n      } else {\n        throw new Error('Failed to fetch project plugins');\n      }\n    } catch (error) {\n      const errorMessage = error instanceof Error ? error.message : 'Failed to fetch project plugins';\n      set({ \n        pluginsError: errorMessage, \n        pluginsLoading: false,\n        plugins: [] // Fallback to empty array\n      });\n      console.warn('Plugins not available:', errorMessage);\n    }\n  },\n\n  // Update project plugin\n  updatePlugin: async (projectId: number, pluginId: string, enabled: boolean) => {\n    try {\n      // This endpoint might not exist yet, so we'll implement it as a placeholder\n      const response = await getClient().updateProjectPlugin(projectId, pluginId, { enabled });\n\n      // The API client returns the data directly\n      if (response) {\n        // Update plugin in store\n        const plugins = get().plugins.map(plugin =>\n          plugin.id === pluginId ? { ...plugin, enabled } : plugin\n        );\n        \n        set({ plugins });\n        toast.success(`Plugin ${enabled ? 'enabled' : 'disabled'} successfully`);\n      } else {\n        throw new Error('Failed to update plugin');\n      }\n    } catch (error) {\n      const errorMessage = error instanceof Error ? error.message : 'Failed to update plugin';\n      toast.error(errorMessage);\n    }\n  },\n\n  // Fetch project stats\n  fetchStats: async (projectId: number) => {\n    set({ statsLoading: true, statsError: null });\n\n    try {\n      const response = await getClient().getAgentStats(projectId);\n\n      // The API client returns the data directly\n      if (response) {\n        const statsData = response.data || response;\n        set({ \n          stats: statsData, \n          statsLoading: false \n        });\n      } else {\n        throw new Error('Failed to fetch project stats');\n      }\n    } catch (error) {\n      const errorMessage = error instanceof Error ? error.message : 'Failed to fetch project stats';\n      set({ \n        statsError: errorMessage, \n        statsLoading: false \n      });\n      toast.error(errorMessage);\n    }\n  },\n\n  // Reset store\n  reset: () => {\n    set({\n      settings: null,\n      settingsLoading: false,\n      settingsError: null,\n      plugins: [],\n      pluginsLoading: false,\n      pluginsError: null,\n      stats: null,\n      statsLoading: false,\n      statsError: null,\n    });\n  },\n}));","import { create } from 'zustand';\nimport { getClient } from '@/lib/api/client';\nimport { logger } from '@/lib/logger';\nimport type { AgentLicense } from '@/types';\n\ninterface LicenseStore {\n  licenses: AgentLicense[];\n  loading: boolean;\n  error: string | null;\n  \n  fetchLicenses: (projectId: number) => Promise<void>;\n  createLicense: (projectId: number, name: string) => Promise<AgentLicense>;\n  updateLicense: (projectId: number, licenseId: string, name: string) => Promise<void>;\n  deleteLicense: (projectId: number, licenseId: string) => Promise<void>;\n  clearError: () => void;\n}\n\nexport const useLicenseStore = create<LicenseStore>((set, get) => ({\n  licenses: [],\n  loading: false,\n  error: null,\n\n  fetchLicenses: async (projectId: number) => {\n    set({ loading: true, error: null });\n    \n    try {\n      const client = getClient();\n      const response = await client.getLicenses(projectId);\n      \n      logger.info('LICENSES', 'API Response', {\n        projectId,\n        status: 'success',\n        responseType: typeof response,\n        hasData: !!response?.data,\n        dataType: Array.isArray(response?.data) ? 'array' : typeof response?.data,\n        dataLength: Array.isArray(response?.data) ? response.data.length : 0\n      });\n      \n      // Handle response format based on API documentation\n      const licenses = Array.isArray(response.data) ? response.data : [];\n      \n      logger.info('LICENSES', 'Processed licenses', {\n        count: licenses.length,\n        licenses: licenses.map((l: any) => ({ \n          name: l.name, \n          key: l.key?.substring(0, 8) + '...', \n          project_id: l.project_id \n        }))\n      });\n      \n      set({ \n        licenses,\n        loading: false \n      });\n    } catch (error: any) {\n      logger.error('LICENSES', 'Failed to fetch licenses', {\n        projectId,\n        errorType: error?.constructor?.name,\n        errorMessage: error?.message,\n        errorStatus: error?.status,\n        errorCode: error?.code,\n        responseText: error?.responseText || 'No response text'\n      });\n      \n      // Handle JSON parsing errors specifically\n      let errorMessage = 'Failed to fetch licenses';\n      if (error?.status === 403 || error?.data?.message?.includes('not allowed')) {\n        // This is expected for some projects - don't show an error\n        errorMessage = '';\n        set({ \n          error: null,\n          loading: false,\n          licenses: []\n        });\n        throw error; // Still throw to handle in component\n      } else if (error?.message?.includes('Unexpected token')) {\n        errorMessage = 'API returned invalid response format. This may be a server configuration issue.';\n      } else if (error instanceof Error) {\n        errorMessage = error.message;\n      }\n      \n      if (errorMessage) {\n        set({ \n          error: errorMessage,\n          loading: false,\n          licenses: []\n        });\n      }\n    }\n  },\n\n  createLicense: async (projectId: number, name: string) => {\n    set({ loading: true, error: null });\n    \n    logger.info('LICENSES', 'Creating license', {\n      projectId,\n      name\n    });\n    \n    try {\n      const client = getClient();\n      const response = await client.createLicense(projectId, { name });\n      \n      logger.info('LICENSES', 'Create license API response', {\n        projectId,\n        name,\n        status: 'success',\n        responseType: typeof response,\n        hasData: !!response?.data,\n        dataStructure: response?.data ? Object.keys(response.data) : [],\n        licenseKey: response.data?.licenseKey?.substring(0, 8) + '...'\n      });\n      \n      // Handle response format based on API documentation\n      // Response contains { license: {...}, licenseKey: \"...\" }\n      const newLicense = response.data?.license || response.data;\n      \n      if (newLicense) {\n        logger.info('LICENSES', 'New license created', {\n          licenseName: newLicense.name,\n          licenseKey: newLicense.key?.substring(0, 8) + '...',\n          project_id: newLicense.project_id\n        });\n        \n        set(state => ({\n          licenses: [...state.licenses, newLicense],\n          loading: false\n        }));\n      }\n      \n      return newLicense;\n    } catch (error: any) {\n      logger.error('LICENSES', 'Failed to create license', {\n        projectId,\n        name,\n        errorType: error?.constructor?.name,\n        errorMessage: error?.message,\n        errorStatus: error?.status,\n        errorCode: error?.code,\n        responseText: error?.responseText || 'No response text'\n      });\n      \n      // Handle JSON parsing errors specifically\n      let errorMessage = 'Failed to create license';\n      if (error?.message?.includes('Unexpected token')) {\n        errorMessage = 'API returned invalid response format. This may be a server configuration issue.';\n      } else if (error instanceof Error) {\n        errorMessage = error.message;\n      }\n      \n      set({ \n        error: errorMessage,\n        loading: false \n      });\n      \n      throw error;\n    }\n  },\n\n  updateLicense: async (projectId: number, licenseId: string, name: string) => {\n    set({ loading: true, error: null });\n    \n    try {\n      const client = getClient();\n      const response = await client.updateLicense(projectId, licenseId, { name });\n      \n      logger.info('LICENSES', 'Updated license', {\n        projectId,\n        licenseId,\n        name\n      });\n      \n      // Handle response format based on API documentation\n      const updatedLicense = (response as any).license || response.data;\n      \n      if (updatedLicense) {\n        set(state => ({\n          licenses: state.licenses.map(license => \n            license.key === licenseId ? { ...license, name, updated_at: new Date().toISOString() } : license\n          ),\n          loading: false\n        }));\n      }\n    } catch (error) {\n      logger.error('LICENSES', 'Failed to update license', error);\n      \n      const errorMessage = error instanceof Error ? error.message : 'Failed to update license';\n      set({ \n        error: errorMessage,\n        loading: false \n      });\n      \n      throw error;\n    }\n  },\n\n  deleteLicense: async (projectId: number, licenseId: string) => {\n    set({ loading: true, error: null });\n    \n    try {\n      const client = getClient();\n      await client.deleteLicense(projectId, licenseId);\n      \n      logger.info('LICENSES', 'Deleted license', {\n        projectId,\n        licenseId\n      });\n      \n      set(state => ({\n        licenses: state.licenses.filter(license => license.key !== licenseId),\n        loading: false\n      }));\n    } catch (error) {\n      logger.error('LICENSES', 'Failed to delete license', error);\n      \n      const errorMessage = error instanceof Error ? error.message : 'Failed to delete license';\n      set({ \n        error: errorMessage,\n        loading: false \n      });\n      \n      throw error;\n    }\n  },\n\n  clearError: () => {\n    set({ error: null });\n  }\n}));","/**\n * Store Index - Central State Management\n * \n * This file exports all Zustand stores used in the application.\n * Each store manages a specific domain of the application state.\n * \n * Architecture:\n * - Uses Zustand for lightweight state management\n * - Each store is independent but can interact via imports\n * - Stores handle both state and async operations (API calls)\n * - All stores use TypeScript for type safety\n * \n * Store Overview:\n * - config: API keys, base URLs, theme settings\n * - agents: Agent/chatbot management and CRUD operations\n * - conversations: Chat session management\n * - messages: Message handling, streaming, and history\n * - ui: UI preferences and layout state\n * - analytics: Usage tracking and metrics\n * - pages: Agent knowledge base pages\n * - sources: Citation sources and references\n * - profile: User profile and limits\n * - project-settings: Agent-specific settings\n * - licenses: License key management\n * \n * Features:\n * - Centralized state management with TypeScript support\n * - Domain-specific stores for organized architecture\n * - Automated error handling and recovery\n * - Cross-store communication and data consistency\n */\n\n// Export all stores from a single entry point\nexport { useConfigStore } from './config';\nexport { useAgentStore } from './agents';\nexport { useConversationStore } from './conversations';\nexport { useMessageStore } from './messages';\nexport { useUIStore } from './ui';\nexport { useAnalyticsStore } from './analytics';\nexport { usePageStore } from './pages';\nexport { useSourceStore } from './sources';\nexport { useProfileStore } from './profile';\nexport { useProjectSettingsStore } from './project-settings';\nexport { useLicenseStore } from './licenses';\n\n/**\n * Store initialization helper\n * \n * Currently, Zustand stores auto-initialize on first access.\n * This function is provided for future use cases where\n * manual initialization might be needed (e.g., SSR, testing).\n * \n * @example\n * // In your app initialization\n * initializeStores();\n */\nexport function initializeStores() {\n  // Stores will auto-initialize when first accessed\n  // This function can be used for any additional setup if needed\n}\n\n/**\n * Store cleanup helper\n * \n * Zustand automatically handles cleanup when components unmount.\n * This function is provided for manual cleanup scenarios\n * (e.g., user logout, testing teardown).\n * \n * To implement cleanup:\n * 1. Add a reset() method to each store\n * 2. Call each store's reset() method here\n * \n * @example\n * // On user logout\n * cleanupStores();\n */\nexport function cleanupStores() {\n  // Add any cleanup logic if needed\n  // Currently, Zustand handles cleanup automatically\n}","/**\n * Message Store - Core Chat Functionality\n * \n * This store manages all message-related state and operations.\n * It's the heart of the chat system, handling:\n * - Message sending and receiving\n * - Real-time streaming responses\n * - Message history management\n * - Local storage fallback\n * - Error handling and retries\n * \n * Architecture:\n * - Uses Map for efficient conversation-based message storage\n * - Integrates with agent and conversation stores\n * - Handles both streaming and non-streaming API responses\n * - Provides local storage backup for offline access\n * \n * Key Features:\n * - Automatic conversation creation if needed\n * - Streaming with fallback to non-streaming\n * - Optimistic UI updates\n * - Message feedback tracking\n * - File upload support\n * \n * Features:\n * - Real-time streaming with local storage persistence\n * - Robust error handling with graceful fallbacks\n * - Comprehensive logging and debugging support\n * - Optimistic UI updates with consistent message ordering\n */\n\nimport { create } from 'zustand';\nimport type { MessageStore, ChatMessage, Citation, FeedbackType, MessageDetails, MessageMetadata } from '@/types';\nimport { getClient } from '@/lib/api/client';\nimport { useAgentStore } from './agents';\nimport { useConversationStore } from './conversations';\nimport { useChatSettingsStore } from './chat-settings';\nimport { generateId } from '@/lib/utils';\nimport { globalStreamManager } from '@/lib/streaming/handler';\nimport { logger } from '@/lib/logger';\nimport { toast } from 'sonner';\n\n/**\n * Remove citation references from content\n * Removes patterns like :cit[xxx/xxx] from the message text\n */\nfunction removeCitationReferences(content: string): string {\n  // Remove citation references and any extra spaces they might leave\n  return content.replace(/\\s*:cit\\[\\d+\\/\\d+\\]\\s*/g, ' ').trim();\n}\n\n/**\n * Local storage configuration\n * Provides offline access and caching for better UX\n */\nconst MESSAGES_STORAGE_KEY = 'customgpt-messages-cache';\n\n/**\n * Save messages to local storage\n * Provides a fallback when API is unavailable\n * @param conversationId - The conversation to save messages for\n * @param messages - Array of messages to save\n */\nfunction saveMessagesToStorage(conversationId: string, messages: ChatMessage[]) {\n  try {\n    const stored = localStorage.getItem(MESSAGES_STORAGE_KEY);\n    const cache = stored ? JSON.parse(stored) : {};\n    cache[conversationId] = messages;\n    localStorage.setItem(MESSAGES_STORAGE_KEY, JSON.stringify(cache));\n  } catch (error) {\n    // Silent fail - storage is optional\n  }\n}\n\n/**\n * Load messages from local storage\n * Used as fallback when API is unavailable\n * @param conversationId - The conversation to load messages for\n * @returns Array of messages or null if not found\n */\nfunction loadMessagesFromStorage(conversationId: string): ChatMessage[] | null {\n  try {\n    const stored = localStorage.getItem(MESSAGES_STORAGE_KEY);\n    if (!stored) return null;\n    const cache = JSON.parse(stored);\n    return cache[conversationId] || null;\n  } catch (error) {\n    // Silent fail - storage is optional\n    return null;\n  }\n}\n\n/**\n * Fetch citation details by IDs\n * \n * Converts citation IDs to full citation objects with title, source, content\n * \n * @param citationIds - Array of citation IDs\n * @param projectId - The project/agent ID\n * @returns Array of citation objects with details\n */\n/**\n * Validate and filter citation IDs\n * \n * @param citationIds - Raw citation IDs from API\n * @returns Filtered array of valid citation IDs\n */\nfunction validateCitationIds(citationIds: any[]): number[] {\n  if (!Array.isArray(citationIds)) {\n    logger.warn('MESSAGES', 'Citation IDs is not an array', { citationIds });\n    return [];\n  }\n  \n  const validIds = citationIds\n    .filter(id => typeof id === 'number' && !isNaN(id) && id > 0)\n    .filter((id, index, arr) => arr.indexOf(id) === index); // Remove duplicates\n  \n  if (validIds.length !== citationIds.length) {\n    logger.warn('MESSAGES', 'Filtered out invalid citation IDs', {\n      original: citationIds,\n      valid: validIds,\n      filtered: citationIds.length - validIds.length\n    });\n  }\n  \n  return validIds;\n}\n\nasync function fetchCitationDetails(citationIds: number[], projectId: number): Promise<Citation[]> {\n  // Validate input citation IDs\n  const validCitationIds = validateCitationIds(citationIds);\n  \n  if (validCitationIds.length === 0) {\n    logger.warn('MESSAGES', 'No valid citation IDs to fetch', { citationIds });\n    return [];\n  }\n  \n  logger.info('MESSAGES', 'Fetching citation details', {\n    projectId,\n    citationIds: validCitationIds,\n    count: validCitationIds.length\n  });\n  \n  const client = getClient();\n  const citations: Citation[] = [];\n  \n  for (let i = 0; i < validCitationIds.length; i++) {\n    const citationId = validCitationIds[i];\n    \n    try {\n      const response = await client.getCitation(projectId, citationId);\n      \n      if (response.data) {\n        const citation = {\n          id: citationId.toString(), // Convert to string as per Citation interface\n          index: i + 1, // 1-based index for display\n          title: response.data.title || `Citation ${i + 1}`,\n          source: response.data.url,\n          url: response.data.url,\n          content: response.data.description || '',\n        };\n        citations.push(citation);\n        \n        logger.info('MESSAGES', 'Citation fetched successfully', {\n          citationId,\n          title: citation.title,\n          hasContent: !!citation.content,\n          hasUrl: !!citation.url\n        });\n      } else {\n        logger.warn('MESSAGES', 'Citation API returned empty data', {\n          citationId,\n          response\n        });\n      }\n    } catch (error) {\n      logger.warn('MESSAGES', 'Failed to fetch citation details', {\n        citationId,\n        projectId,\n        error: error instanceof Error ? error.message : String(error),\n        errorType: error instanceof Error ? error.constructor.name : typeof error\n      });\n      // Only create fallback citations for actual errors, not empty responses\n      // This reduces wrong citations from appearing\n      if (error instanceof Error && error.message.includes('404')) {\n        logger.info('MESSAGES', 'Citation not found, skipping fallback', { citationId });\n        // Skip creating fallback for 404 errors - citation simply doesn't exist\n        continue;\n      } else {\n        // Create fallback only for network/server errors\n        citations.push({\n          id: citationId.toString(), // Convert to string\n          index: i + 1,\n          title: `Citation ${i + 1}`,\n          source: '',\n          url: '',\n          content: 'Citation details unavailable',\n        });\n      }\n    }\n  }\n  \n  logger.info('MESSAGES', 'Citation fetching completed', {\n    requested: validCitationIds.length,\n    fetched: citations.length,\n    success: citations.filter(c => c.content !== 'Citation details unavailable').length\n  });\n  \n  return citations;\n}\n\n/**\n * Message Store Implementation\n * \n * State Structure:\n * - messages: Map<conversationId, ChatMessage[]> - All messages grouped by conversation\n * - streamingMessage: Current message being streamed (null when not streaming)\n * - isStreaming: Whether a message is currently being streamed\n * - loading: General loading state for message operations\n * - error: Current error message if any\n */\nexport const useMessageStore = create<MessageStore>((set, get) => ({\n  // Initialize with empty state\n  messages: new Map(),\n  streamingMessage: null,\n  isStreaming: false,\n  loading: false,\n  error: null,\n\n  /**\n   * Send a message to the current agent\n   * \n   * Flow:\n   * 1. Validate agent selection\n   * 2. Ensure conversation exists (create if needed)\n   * 3. Create and add user message (optimistic update)\n   * 4. Upload files if present\n   * 5. Start streaming response\n   * 6. Fall back to non-streaming if streaming fails\n   * 7. Handle errors gracefully\n   * \n   * \n   * @param content - Message text\n   * @param files - Optional file attachments\n   */\n  sendMessage: async (content: string, files?: File[]) => {\n    // Skip API calls in demo mode\n    const isDemoMode = typeof window !== 'undefined' && (window as any).__customgpt_demo_mode;\n    \n    const agentStore = useAgentStore.getState();\n    const conversationStore = useConversationStore.getState();\n    \n    const { currentAgent } = agentStore;\n    if (!currentAgent) {\n      logger.error('MESSAGES', 'No agent selected when trying to send message');\n      \n      // Check if this is due to missing API keys\n      const response = await fetch('/api/proxy/user/limits').catch(() => null);\n      if (!response || response.status === 401 || response.status === 500) {\n        throw new Error('API key not configured. Please add CUSTOMGPT_API_KEY to your .env.local file and restart the server.');\n      }\n      \n      throw new Error('No agent selected. Please select or create an agent first.');\n    }\n\n    logger.info('MESSAGES', 'Sending message', {\n      agentId: currentAgent.id,\n      agentName: currentAgent.project_name,\n      messageLength: content.length,\n      hasFiles: files && files.length > 0\n    });\n\n    // Ensure we have a conversation\n    const conversation = await conversationStore.ensureConversation(\n      currentAgent.id,\n      content\n    );\n\n    logger.info('MESSAGES', 'Conversation ensured', {\n      conversationId: conversation.id,\n      sessionId: conversation.session_id,\n      hasSessionId: !!conversation.session_id,\n      isNew: !conversation.message_count || conversation.message_count === 0\n    });\n\n    if (!conversation.session_id) {\n      logger.error('MESSAGES', 'Conversation missing session_id', { conversation });\n      throw new Error('Conversation missing session_id');\n    }\n\n    set({ loading: true, error: null });\n\n    // Create user message\n    const userMessage: ChatMessage = {\n      id: generateId(),\n      role: 'user',\n      content,\n      timestamp: new Date().toISOString(),\n      status: 'sending',\n    };\n\n    // Add user message to store\n    get().addMessage(conversation.id.toString(), userMessage);\n\n    // Create assistant message placeholder\n    const assistantMessage: ChatMessage = {\n      id: generateId(),\n      role: 'assistant',\n      content: '',\n      timestamp: new Date().toISOString(),\n      citations: [],\n    };\n\n    set({ \n      streamingMessage: assistantMessage,\n      isStreaming: true,\n      loading: false,\n    });\n\n    try {\n      // Handle file uploads if present\n      let sourceIds: string[] = [];\n      if (files && files.length > 0) {\n        const client = getClient();\n        const uploadResponses = await Promise.all(\n          files.map(file => client.uploadFile(currentAgent.id, file))\n        );\n        \n        // Extract source IDs from upload responses\n        sourceIds = uploadResponses\n          .filter(response => response?.data?.id)\n          .map(response => response.data.id.toString());\n          \n        logger.info('MESSAGES', 'Files uploaded successfully', {\n          fileCount: files.length,\n          sourceIds: sourceIds\n        });\n      }\n\n      // Update user message status\n      userMessage.status = 'sent';\n      get().addMessage(conversation.id.toString(), userMessage);\n\n      // Start streaming with correct parameters\n      const client = getClient();\n      \n      logger.info('MESSAGES', 'Starting message stream', {\n        agentId: currentAgent.id,\n        sessionId: conversation.session_id,\n        messageContent: content.substring(0, 50),\n        hasSourceIds: sourceIds.length > 0,\n        sourceIds: sourceIds\n      });\n      \n      try {\n        // Get chat settings for current agent\n        const chatSettings = useChatSettingsStore.getState().getSettings(currentAgent.id);\n        \n        // Prepare the request data - only send fields that the API accepts\n        const requestData: { \n          prompt: string; \n          source_ids?: string[];\n          response_source?: string;\n        } = { \n          prompt: content || '', // Ensure we always have a prompt, even if empty\n          response_source: chatSettings.response_source || 'default',\n        };\n        \n        // Add source_ids if we have uploaded files\n        if (sourceIds.length > 0) {\n          requestData.source_ids = sourceIds;\n          \n          // If no text prompt was provided, add a default prompt for file analysis\n          if (!content.trim()) {\n            requestData.prompt = 'Please analyze the uploaded file(s).';\n          }\n        }\n        \n        await client.sendMessageStream(\n          currentAgent.id,\n          conversation.session_id,  // Use session_id instead of id\n          requestData,\n          (chunk) => {\n              logger.info('MESSAGES', 'Received stream chunk', { \n                type: chunk.type, \n                hasContent: !!chunk.content,\n                contentLength: chunk.content?.length,\n                contentPreview: chunk.content?.substring(0, 50)\n              });\n              \n              if (chunk.type === 'content' && chunk.content) {\n                get().updateStreamingMessage(chunk.content, chunk.citations);\n              } else if (chunk.type === 'citation' && chunk.citations) {\n                // Handle citation-only chunks\n                const current = get().streamingMessage;\n                if (current && chunk.citations && Array.isArray(chunk.citations)) {\n                  // Check if citations are IDs or objects\n                  if (chunk.citations.length > 0 && typeof chunk.citations[0] === 'number') {\n                    // Fetch citation details asynchronously\n                    fetchCitationDetails(chunk.citations as any as number[], currentAgent.id).then(citationDetails => {\n                      const updatedCurrent = get().streamingMessage;\n                      if (updatedCurrent) {\n                        set({\n                          streamingMessage: {\n                            ...updatedCurrent,\n                            citations: citationDetails\n                          }\n                        });\n                      }\n                    });\n                  } else {\n                    // Citations might already be objects\n                    set({\n                      streamingMessage: {\n                        ...current,\n                        citations: chunk.citations\n                      }\n                    });\n                  }\n                }\n              }\n            },\n            async (streamError) => {\n              logger.error('MESSAGES', 'Streaming failed, attempting fallback to non-streaming', streamError, {\n                errorMessage: streamError.message,\n                agentId: currentAgent.id,\n                sessionId: conversation.session_id\n              });\n              \n              // Try fallback to non-streaming API\n              try {\n                logger.info('MESSAGES', 'Using non-streaming fallback');\n                \n                const response = await client.sendMessage(\n                  currentAgent.id,\n                  conversation.session_id,\n                  { \n                    prompt: requestData.prompt,\n                    stream: false,\n                    source_ids: requestData.source_ids\n                  }\n                );\n                \n                // Update streaming message with the complete response\n                const finalMessage = get().streamingMessage;\n                if (finalMessage && response) {\n                  // Handle different response formats from API\n                  let messageData: any;\n                  if (response.data) {\n                    messageData = response.data;\n                  } else {\n                    // Direct response format - cast to any to handle the actual API structure\n                    messageData = response as any;\n                  }\n                  \n                  // Clean citation references from the response content\n                  const rawContent = messageData?.openai_response || messageData?.content || 'No response received';\n                  finalMessage.content = removeCitationReferences(rawContent);\n                  \n                  // Fetch citation details if needed\n                  if (messageData?.citations && Array.isArray(messageData.citations) && messageData.citations.length > 0) {\n                    if (typeof messageData.citations[0] === 'number') {\n                      // Citations are IDs, fetch details\n                      finalMessage.citations = await fetchCitationDetails(messageData.citations, currentAgent.id);\n                    } else {\n                      // Citations might already be objects\n                      finalMessage.citations = messageData.citations;\n                    }\n                  } else {\n                    finalMessage.citations = [];\n                  }\n                  \n                  finalMessage.status = 'sent';\n                  \n                  // Update the message ID to include the prompt ID if available\n                  if (messageData?.id) {\n                    finalMessage.id = `${messageData.id}-assistant`;\n                    // Also update the user message ID\n                    const conversationMessages = get().messages.get(conversation.id.toString()) || [];\n                    const lastUserMessage = conversationMessages.filter(m => m.role === 'user').pop();\n                    if (lastUserMessage && lastUserMessage.id === userMessage.id) {\n                      lastUserMessage.id = `${messageData.id}-user`;\n                      get().addMessage(conversation.id.toString(), lastUserMessage);\n                    }\n                  }\n                  \n                  // Add details from the API response\n                  finalMessage.details = {\n                    user_id: messageData?.user_id,\n                    conversation_id: messageData?.conversation_id,\n                    updated_at: messageData?.updated_at,\n                    prompt_id: messageData?.id,\n                    metadata: messageData?.metadata ? {\n                      user_ip: messageData.metadata.user_ip,\n                      user_agent: messageData.metadata.user_agent,\n                      external_id: messageData.metadata.external_id,\n                      request_source: messageData.metadata.request_source,\n                    } : undefined,\n                  };\n                  get().addMessage(conversation.id.toString(), finalMessage);\n                }\n                \n                set({ \n                  streamingMessage: null,\n                  isStreaming: false,\n                });\n                \n                logger.info('MESSAGES', 'Fallback to non-streaming successful');\n                \n              } catch (fallbackError: any) {\n                logger.error('MESSAGES', 'Both streaming and non-streaming failed', fallbackError);\n                \n                // Update assistant message with error\n                const errorMessage = get().streamingMessage;\n                if (errorMessage) {\n                  errorMessage.content = 'Sorry, I encountered an error while processing your message. Please try again.';\n                  errorMessage.status = 'error';\n                  get().addMessage(conversation.id.toString(), errorMessage);\n                }\n                \n                // Extract error details including status code\n                let errorText = 'Communication error';\n                if (fallbackError.status) {\n                  switch (fallbackError.status) {\n                    case 429:\n                      errorText = 'You have exhausted your current query credits. Please contact customer service for assistance.';\n                      break;\n                    case 401:\n                      errorText = 'API Token is either missing or invalid';\n                      break;\n                    case 404:\n                      errorText = 'Agent or conversation not found';\n                      break;\n                    case 400:\n                      errorText = 'Invalid request format';\n                      break;\n                    default:\n                      errorText = fallbackError.message || `Error ${fallbackError.status}`;\n                  }\n                } else if (fallbackError.message) {\n                  errorText = fallbackError.message;\n                }\n                \n                set({ \n                  streamingMessage: null,\n                  isStreaming: false,\n                  error: errorText,\n                });\n              }\n            },\n            async () => {\n              // onComplete callback - enrich streaming message with API data\n              const finalMessage = get().streamingMessage;\n              if (finalMessage) {\n                finalMessage.status = 'sent';\n                \n                // Clean citation references from the final message content\n                finalMessage.content = removeCitationReferences(finalMessage.content);\n                \n                // Clear streaming state FIRST to prevent duplication\n                set({ \n                  streamingMessage: null,\n                  isStreaming: false,\n                });\n                \n                // Then add message to ensure it's visible\n                get().addMessage(conversation.id.toString(), finalMessage);\n                \n                // Fetch latest messages to enrich the streaming message with API metadata\n                try {\n                  logger.info('MESSAGES', 'Enriching streaming message with API data');\n                  const client = getClient();\n                  const response = await client.getMessages(currentAgent.id, conversation.session_id);\n                  \n                  // Process API response to find messages\n                  let apiMessages = [];\n                  if (response && typeof response === 'object') {\n                    if ((response as any).data && (response as any).data.messages && Array.isArray((response as any).data.messages.data)) {\n                      apiMessages = (response as any).data.messages.data;\n                    } else if (Array.isArray((response as any).data)) {\n                      apiMessages = (response as any).data;\n                    } else if (Array.isArray(response)) {\n                      apiMessages = response;\n                    } else if ((response as any).data && Array.isArray((response as any).data.data)) {\n                      apiMessages = (response as any).data.data;\n                    }\n                  }\n                  \n                  if (apiMessages.length > 0) {\n                    // Find the most recent assistant message (should be our streaming message)\n                    const latestApiMessage = apiMessages[apiMessages.length - 1];\n                    \n                    if (latestApiMessage && latestApiMessage.openai_response) {\n                      // Enrich the streaming message with API data\n                      finalMessage.id = `${latestApiMessage.id}-assistant`;\n                      finalMessage.timestamp = latestApiMessage.created_at || latestApiMessage.timestamp || finalMessage.timestamp;\n                      \n                      // Add full message details\n                      finalMessage.details = {\n                        user_id: latestApiMessage.user_id,\n                        conversation_id: latestApiMessage.conversation_id,\n                        updated_at: latestApiMessage.updated_at,\n                        prompt_id: latestApiMessage.id,\n                        metadata: latestApiMessage.metadata ? {\n                          user_ip: latestApiMessage.metadata.user_ip,\n                          user_agent: latestApiMessage.metadata.user_agent,\n                          external_id: latestApiMessage.metadata.external_id,\n                          request_source: latestApiMessage.metadata.request_source,\n                        } : undefined,\n                      };\n                      \n                      // Also enrich the user message with proper ID and details\n                      const conversationMessages = get().messages.get(conversation.id.toString()) || [];\n                      const lastUserMessage = conversationMessages.filter(m => m.role === 'user').pop();\n                      if (lastUserMessage && lastUserMessage.id === userMessage.id && latestApiMessage.user_query) {\n                        lastUserMessage.id = `${latestApiMessage.id}-user`;\n                        lastUserMessage.timestamp = latestApiMessage.created_at || latestApiMessage.timestamp || lastUserMessage.timestamp;\n                        lastUserMessage.details = {\n                          user_id: latestApiMessage.user_id,\n                          conversation_id: latestApiMessage.conversation_id,\n                          updated_at: latestApiMessage.updated_at,\n                          prompt_id: latestApiMessage.id,\n                          metadata: latestApiMessage.metadata ? {\n                            user_ip: latestApiMessage.metadata.user_ip,\n                            user_agent: latestApiMessage.metadata.user_agent,\n                            external_id: latestApiMessage.metadata.external_id,\n                            request_source: latestApiMessage.metadata.request_source,\n                          } : undefined,\n                        };\n                        get().addMessage(conversation.id.toString(), lastUserMessage);\n                      }\n                      \n                      // Enrich citations if they exist\n                      // Preserve existing citations from streaming if API doesn't provide them\n                      const existingCitations = finalMessage.citations || [];\n                      \n                      if (latestApiMessage.citations && Array.isArray(latestApiMessage.citations) && latestApiMessage.citations.length > 0) {\n                        if (typeof latestApiMessage.citations[0] === 'number') {\n                          // Citations are IDs, fetch details\n                          const citationDetails = await fetchCitationDetails(latestApiMessage.citations, currentAgent.id);\n                          finalMessage.citations = citationDetails;\n                        } else {\n                          // Citations might already be objects\n                          finalMessage.citations = latestApiMessage.citations;\n                        }\n                      } else {\n                        // Keep existing citations from streaming if API doesn't provide any\n                        finalMessage.citations = existingCitations;\n                      }\n                      \n                      // Update feedback if present\n                      if (latestApiMessage.response_feedback?.reaction) {\n                        finalMessage.feedback = latestApiMessage.response_feedback.reaction === 'liked' ? 'like' : \n                                               latestApiMessage.response_feedback.reaction === 'disliked' ? 'dislike' : \n                                               undefined;\n                      }\n                      \n                      // Update the enriched message in the store (it's already added, so this updates it)\n                      get().addMessage(conversation.id.toString(), finalMessage);\n                      \n                      logger.info('MESSAGES', 'Successfully enriched streaming message with API data', {\n                        messageId: finalMessage.id,\n                        hasDetails: !!finalMessage.details,\n                        citationCount: finalMessage.citations?.length || 0\n                      });\n                    } else {\n                      // API message exists but doesn't have expected format\n                      logger.info('MESSAGES', 'API message format mismatch, keeping original message');\n                    }\n                  } else {\n                    // No API messages found\n                    logger.info('MESSAGES', 'No API messages found for enrichment');\n                  }\n                } catch (enrichmentError) {\n                  logger.warn('MESSAGES', 'Failed to enrich streaming message, keeping basic version', enrichmentError);\n                  // Message is already added, enrichment failed but user can still see the response\n                }\n              }\n            }\n        );\n      } catch (setupError) {\n        logger.error('MESSAGES', 'Failed to setup streaming', setupError);\n        throw setupError;\n      }\n    } catch (error: any) {\n      logger.error('MESSAGES', 'Failed to send message', error, {\n        errorType: error instanceof Error ? error.constructor.name : typeof error,\n        errorMessage: error instanceof Error ? error.message : String(error),\n        stack: error instanceof Error ? error.stack : undefined,\n        status: error.status,\n        agentId: currentAgent.id,\n        conversationId: conversation.id,\n        sessionId: conversation.session_id\n      });\n      \n      // Update user message status\n      userMessage.status = 'error';\n      get().addMessage(conversation.id.toString(), userMessage);\n      \n      // Extract error details including status code\n      let errorText = 'Failed to send message';\n      if (error.status) {\n        switch (error.status) {\n          case 429:\n            errorText = 'You have exhausted your current query credits. Please contact customer service for assistance.';\n            break;\n          case 401:\n            errorText = 'API Token is either missing or invalid';\n            break;\n          case 403:\n            // Check if agent is inactive by looking at current agent status\n            const agentStore = useAgentStore.getState();\n            const { currentAgent: currentAgentFor403 } = agentStore;\n            if (currentAgentFor403 && !currentAgentFor403.is_chat_active) {\n              errorText = 'Agent is inactive - no documents uploaded. Please add documents to activate the agent.';\n            } else {\n              errorText = 'Access denied. You don\\'t have permission to access this resource.';\n            }\n            break;\n          case 404:\n            errorText = 'Agent or conversation not found';\n            break;\n          case 400:\n            errorText = 'Invalid request format';\n            break;\n          case 500:\n            errorText = 'Internal server error. Please try again later.';\n            break;\n          default:\n            errorText = error.message || `Error ${error.status}`;\n        }\n      } else if (error.message) {\n        errorText = error.message;\n      }\n      \n      set({ \n        streamingMessage: null,\n        isStreaming: false,\n        error: errorText,\n        loading: false,\n      });\n      \n      throw error;\n    }\n  },\n\n  /**\n   * Add or update a message in the store\n   * \n   * Features:\n   * - Handles both new messages and updates\n   * - Maintains message order\n   * - Automatically saves to local storage\n   * - Efficient update using message ID lookup\n   * \n   * @param conversationId - The conversation to add the message to\n   * @param message - The message to add or update\n   */\n  addMessage: (conversationId: string, message: ChatMessage) => {\n    set(state => {\n      const newMessages = new Map(state.messages);\n      const conversationMessages = newMessages.get(conversationId) || [];\n      \n      // Check if message already exists and update it\n      const existingIndex = conversationMessages.findIndex(m => m.id === message.id);\n      if (existingIndex >= 0) {\n        // Update existing message\n        conversationMessages[existingIndex] = message;\n      } else {\n        // Add new message\n        conversationMessages.push(message);\n      }\n      \n      newMessages.set(conversationId, conversationMessages);\n      \n      // Save to local storage as fallback\n      saveMessagesToStorage(conversationId, conversationMessages);\n      \n      return { messages: newMessages };\n    });\n  },\n\n  /**\n   * Update the currently streaming message\n   * \n   * Used during streaming to append content chunks\n   * and update citations as they arrive\n   * \n   * @param content - Content chunk to append\n   * @param citations - Updated citations (optional)\n   */\n  updateStreamingMessage: (content: string, citations?: Citation[]) => {\n    set(state => {\n      if (!state.streamingMessage) return state;\n      \n      return {\n        streamingMessage: {\n          ...state.streamingMessage,\n          content: state.streamingMessage.content + content, // Append content as-is during streaming\n          citations: citations || state.streamingMessage.citations, // Update citations if provided\n        },\n      };\n    });\n  },\n\n  clearMessages: (conversationId?: string) => {\n    set(state => {\n      if (conversationId) {\n        const newMessages = new Map(state.messages);\n        newMessages.delete(conversationId);\n        return { messages: newMessages };\n      } else {\n        // Clear all messages\n        return { messages: new Map() };\n      }\n    });\n  },\n\n  updateMessageFeedback: async (messageId: string, feedback: FeedbackType) => {\n    const agentStore = useAgentStore.getState();\n    const conversationStore = useConversationStore.getState();\n    \n    const { currentAgent } = agentStore;\n    const { currentConversation } = conversationStore;\n    \n    if (!currentAgent || !currentConversation) {\n      logger.warn('MESSAGES', 'Cannot update feedback - missing agent or conversation');\n      return;\n    }\n\n    // Find the message\n    const conversationMessages = get().messages.get(currentConversation.id.toString()) || [];\n    const message = conversationMessages.find(m => m.id === messageId);\n    \n    if (!message) {\n      logger.warn('MESSAGES', 'Message not found for feedback update', { messageId });\n      return;\n    }\n\n    // Get the prompt ID from message details or try to extract from message ID\n    let promptId: number | undefined;\n    \n    if (message.details?.prompt_id) {\n      promptId = message.details.prompt_id;\n    } else {\n      // Try to extract from message ID format \"{promptId}-assistant\" or \"{promptId}-user\"\n      const promptIdMatch = message.id.match(/^(\\d+)-/);\n      if (promptIdMatch) {\n        promptId = parseInt(promptIdMatch[1]);\n      }\n    }\n    \n    if (!promptId) {\n      logger.error('MESSAGES', 'Could not determine prompt ID for message', { messageId, details: message.details });\n      toast.error('Unable to update feedback. Message ID not found.');\n      return;\n    }\n    const sessionId = currentConversation.session_id;\n    \n    if (!sessionId) {\n      logger.error('MESSAGES', 'Conversation missing session_id', { conversationId: currentConversation.id });\n      return;\n    }\n\n    try {\n      // Update local state immediately (optimistic update)\n      const updatedMessage = { ...message, feedback };\n      get().addMessage(currentConversation.id.toString(), updatedMessage);\n\n      // Send to API\n      const client = getClient();\n      \n      // Map feedback directly to API format (no neutral option)\n      const feedbackValue = feedback === 'like' ? 'thumbs_up' : 'thumbs_down';\n      \n      logger.info('MESSAGES', 'Updating message feedback', {\n        projectId: currentAgent.id,\n        sessionId,\n        promptId,\n        feedback: feedbackValue\n      });\n      \n      const response = await client.updateMessageFeedback(\n        currentAgent.id,\n        sessionId,\n        promptId,\n        { feedback: feedbackValue }\n      );\n      \n      // The feedback was already updated optimistically above\n      // The response doesn't include the updated message data in the expected format\n      logger.info('MESSAGES', 'Message feedback updated successfully');\n      \n      // Show success toast\n      toast.success('Thanks for your feedback!');\n      \n    } catch (error) {\n      logger.error('MESSAGES', 'Failed to update message feedback', error);\n      \n      // Revert local state on error\n      get().addMessage(currentConversation.id.toString(), message);\n      \n      // Show error toast\n      if ((error as any)?.status === 401) {\n        toast.error('Authentication failed. Please log in again.');\n      } else if ((error as any)?.status === 404) {\n        toast.error('Message not found.');\n      } else {\n        toast.error('Failed to update feedback. Please try again.');\n      }\n    }\n  },\n\n  // Utility methods\n  getMessagesForConversation: (conversationId: string): ChatMessage[] => {\n    return get().messages.get(conversationId) || [];\n  },\n\n  cancelStreaming: () => {\n    globalStreamManager.cancelAllStreams();\n    set({ \n      streamingMessage: null,\n      isStreaming: false,\n    });\n  },\n\n  /**\n   * Load message history for a conversation\n   * \n   * API Response Handling:\n   * - Supports multiple response formats from the API\n   * - Converts API format to internal ChatMessage format\n   * - Falls back to local storage if API fails\n   * - Handles both user_query and openai_response fields\n   * - Fetches citation details for citation IDs\n   * \n   * @param conversationId - The conversation to load messages for\n   */\n  loadMessages: async (conversationId: string) => {\n    // Skip API calls in demo mode\n    const isDemoMode = typeof window !== 'undefined' && (window as any).__customgpt_demo_mode;\n    if (isDemoMode) {\n      logger.info('MESSAGES', 'Skipping message load in demo mode', { conversationId });\n      // Just ensure the conversation has an entry in the messages map\n      set(state => {\n        const newMessages = new Map(state.messages);\n        if (!newMessages.has(conversationId)) {\n          newMessages.set(conversationId, []);\n        }\n        return { messages: newMessages, loading: false };\n      });\n      return;\n    }\n    \n    // Skip API calls for locally created conversations (they don't exist on server)\n    if (conversationId.startsWith('conv_')) {\n      logger.info('MESSAGES', 'Skipping API load for local conversation', { conversationId });\n      set(state => {\n        const newMessages = new Map(state.messages);\n        if (!newMessages.has(conversationId)) {\n          newMessages.set(conversationId, []);\n        }\n        return { messages: newMessages, loading: false };\n      });\n      return;\n    }\n    \n    const agentStore = useAgentStore.getState();\n    const conversationStore = useConversationStore.getState();\n    const { currentAgent } = agentStore;\n    const { conversations } = conversationStore;\n    \n    if (!currentAgent) {\n      logger.warn('MESSAGES', 'No current agent when loading messages', { conversationId });\n      return;\n    }\n\n    // Find the conversation to get its session_id\n    const conversation = conversations.find(c => c.id.toString() === conversationId);\n    if (!conversation) {\n      logger.error('MESSAGES', 'Conversation not found in store', { \n        conversationId,\n        availableConversations: conversations.map(c => c.id)\n      });\n      // Don't set error, just ensure empty message array exists\n      set(state => {\n        const newMessages = new Map(state.messages);\n        if (!newMessages.has(conversationId)) {\n          newMessages.set(conversationId, []);\n        }\n        return { messages: newMessages, loading: false };\n      });\n      return;\n    }\n\n    logger.info('MESSAGES', 'Loading messages for conversation', {\n      conversationId,\n      sessionId: conversation.session_id,\n      agentId: currentAgent.id,\n      agentName: currentAgent.project_name\n    });\n\n    set({ loading: true, error: null });\n\n    try {\n      const client = getClient();\n      const response = await client.getMessages(currentAgent.id, conversation.session_id);\n      logger.info('MESSAGES', 'Messages API response received', {\n        conversationId,\n        responseType: typeof response,\n        hasData: !!(response as any)?.data,\n        dataLength: Array.isArray((response as any)?.data) ? (response as any).data.length : 0\n      });\n      \n      // Handle different response formats from the API\n      let messages = [];\n      if (response && typeof response === 'object') {\n        // API documentation shows response format: { status: \"success\", data: { conversation: {...}, messages: { data: [...] } } }\n        if ((response as any).data && (response as any).data.messages && Array.isArray((response as any).data.messages.data)) {\n          messages = (response as any).data.messages.data;\n        } else if (Array.isArray((response as any).data)) {\n          messages = (response as any).data;\n        } else if (Array.isArray(response)) {\n          messages = response;\n        } else if ((response as any).data && Array.isArray((response as any).data.data)) {\n          messages = (response as any).data.data;\n        }\n      }\n      \n      logger.info('MESSAGES', 'Processing messages', {\n        conversationId,\n        messagesCount: messages.length,\n        messageTypes: messages.map((m: any) => m.role || 'unknown')\n      });\n      \n      // Convert API messages to our format\n      // Each API message contains both user_query and openai_response, so we need to create two ChatMessage objects\n      const formattedMessages: ChatMessage[] = [];\n      \n      if (Array.isArray(messages)) {\n        // Process messages and fetch citation details\n        for (const msg of messages) {\n          const baseTimestamp = msg.created_at || msg.timestamp || new Date().toISOString();\n          \n          // Add user message\n          if (msg.user_query) {\n            formattedMessages.push({\n              id: `${msg.id}-user` || `user-${Math.random()}`,\n              role: 'user',\n              content: msg.user_query,\n              timestamp: baseTimestamp,\n              status: 'sent' as const,\n              details: {\n                user_id: msg.user_id,\n                conversation_id: msg.conversation_id,\n                updated_at: msg.updated_at,\n                prompt_id: msg.id,\n                metadata: msg.metadata ? {\n                  user_ip: msg.metadata.user_ip,\n                  user_agent: msg.metadata.user_agent,\n                  external_id: msg.metadata.external_id,\n                  request_source: msg.metadata.request_source,\n                } : undefined,\n              },\n            });\n          }\n          \n          // Add assistant message\n          if (msg.openai_response) {\n            // Fetch citation details if citations exist\n            let citationDetails: Citation[] = [];\n            if (msg.citations && Array.isArray(msg.citations) && msg.citations.length > 0) {\n              // Check if citations are already objects (future-proofing) or just IDs\n              if (typeof msg.citations[0] === 'number') {\n                // Citations are IDs, fetch details\n                citationDetails = await fetchCitationDetails(msg.citations, currentAgent.id);\n              } else {\n                // Citations might already be objects, use as is\n                citationDetails = msg.citations;\n              }\n            }\n            \n            formattedMessages.push({\n              id: `${msg.id}-assistant` || `assistant-${Math.random()}`,\n              role: 'assistant',\n              content: msg.openai_response,\n              citations: citationDetails,\n              timestamp: baseTimestamp,\n              status: 'sent' as const,\n              feedback: msg.response_feedback?.reaction === 'liked' ? 'like' : \n                       msg.response_feedback?.reaction === 'disliked' ? 'dislike' : \n                       undefined,\n              details: {\n                user_id: msg.user_id,\n                conversation_id: msg.conversation_id,\n                updated_at: msg.updated_at,\n                prompt_id: msg.id,\n                metadata: msg.metadata ? {\n                  user_ip: msg.metadata.user_ip,\n                  user_agent: msg.metadata.user_agent,\n                  external_id: msg.metadata.external_id,\n                  request_source: msg.metadata.request_source,\n                } : undefined,\n              },\n            });\n          }\n        }\n      }\n\n      logger.info('MESSAGES', 'Messages formatted successfully', {\n        conversationId,\n        formattedCount: formattedMessages.length\n      });\n\n      // Sort messages by timestamp to ensure chronological order\n      formattedMessages.sort((a, b) => {\n        const dateA = new Date(a.timestamp).getTime();\n        const dateB = new Date(b.timestamp).getTime();\n        return dateA - dateB; // Ascending order (oldest first)\n      });\n\n      logger.info('MESSAGES', 'Messages sorted by timestamp', {\n        conversationId,\n        firstMessageTime: formattedMessages[0]?.timestamp,\n        lastMessageTime: formattedMessages[formattedMessages.length - 1]?.timestamp\n      });\n\n      set(state => {\n        const newMessages = new Map(state.messages);\n        \n        // Preserve any local messages that might be in sending state\n        const existingMessages = state.messages.get(conversationId) || [];\n        const localSendingMessages = existingMessages.filter(msg => \n          msg.status === 'sending' || \n          (msg.role === 'user' && \n           new Date(msg.timestamp).getTime() > Date.now() - 5000) // Messages sent in last 5 seconds\n        );\n        \n        // Merge local sending messages with API messages\n        const mergedMessages = [...formattedMessages];\n        for (const localMsg of localSendingMessages) {\n          if (!mergedMessages.find(m => m.id === localMsg.id)) {\n            // Insert local message at the appropriate position based on timestamp\n            const insertIndex = mergedMessages.findIndex(m => \n              new Date(m.timestamp).getTime() > new Date(localMsg.timestamp).getTime()\n            );\n            if (insertIndex === -1) {\n              mergedMessages.push(localMsg);\n            } else {\n              mergedMessages.splice(insertIndex, 0, localMsg);\n            }\n          }\n        }\n        \n        newMessages.set(conversationId, mergedMessages);\n        \n        // Save to local storage as fallback\n        saveMessagesToStorage(conversationId, mergedMessages);\n        \n        return { \n          messages: newMessages,\n          loading: false,\n        };\n      });\n    } catch (error) {\n      logger.error('MESSAGES', 'Failed to load messages', error, {\n        conversationId,\n        agentId: currentAgent.id,\n        errorType: error instanceof Error ? error.constructor.name : typeof error,\n        status: (error as any)?.status,\n        message: (error as any)?.message\n      });\n      \n      // Try to load from local storage as fallback\n      const cachedMessages = loadMessagesFromStorage(conversationId);\n      if (cachedMessages && cachedMessages.length > 0) {\n        logger.info('MESSAGES', 'Using cached messages as fallback', {\n          conversationId,\n          messageCount: cachedMessages.length\n        });\n        \n        // Sort cached messages by timestamp to ensure chronological order\n        cachedMessages.sort((a, b) => {\n          const dateA = new Date(a.timestamp).getTime();\n          const dateB = new Date(b.timestamp).getTime();\n          return dateA - dateB; // Ascending order (oldest first)\n        });\n        \n        set(state => {\n          const newMessages = new Map(state.messages);\n          newMessages.set(conversationId, cachedMessages);\n          return { \n            messages: newMessages,\n            loading: false,\n            error: 'Using cached messages (API unavailable)'\n          };\n        });\n      } else {\n        set({ \n          error: error instanceof Error ? error.message : 'Failed to load messages',\n          loading: false,\n        });\n      }\n    }\n  },\n  \n  /**\n   * Clear the error state\n   */\n  clearError: () => {\n    set({ error: null });\n  },\n  \n  /**\n   * Set messages for a specific conversation\n   * Used for updating conversation messages directly\n   */\n  setMessagesForConversation: (conversationId: string, messages: ChatMessage[]) => {\n    set(state => {\n      const newMessages = new Map(state.messages);\n      newMessages.set(conversationId, messages);\n      return { messages: newMessages };\n    });\n  },\n\n  /**\n   * Regenerate the last assistant response\n   * \n   * Flow:\n   * 1. Find the last user message in the conversation\n   * 2. Remove the last assistant message\n   * 3. Resend the user message to get a new response\n   */\n  regenerateLastResponse: async () => {\n    const agentStore = useAgentStore.getState();\n    const conversationStore = useConversationStore.getState();\n    \n    const { currentAgent } = agentStore;\n    const { currentConversation } = conversationStore;\n    \n    if (!currentAgent || !currentConversation) {\n      logger.error('MESSAGES', 'Cannot regenerate - missing agent or conversation');\n      toast.error('Cannot regenerate response. Please select a conversation.');\n      return;\n    }\n\n    const conversationId = currentConversation.id.toString();\n    const messages = get().getMessagesForConversation(conversationId);\n    \n    if (messages.length < 2) {\n      logger.warn('MESSAGES', 'Not enough messages to regenerate');\n      toast.error('No response to regenerate.');\n      return;\n    }\n\n    // Find the last user message and last assistant message\n    let lastUserMessage: ChatMessage | null = null;\n    let lastAssistantMessage: ChatMessage | null = null;\n    let lastAssistantIndex = -1;\n\n    // Iterate backwards to find the last assistant and user messages\n    for (let i = messages.length - 1; i >= 0; i--) {\n      const msg = messages[i];\n      if (!lastAssistantMessage && msg.role === 'assistant' && msg.status !== 'error') {\n        lastAssistantMessage = msg;\n        lastAssistantIndex = i;\n      }\n      if (!lastUserMessage && msg.role === 'user' && lastAssistantMessage) {\n        lastUserMessage = msg;\n        break;\n      }\n    }\n\n    if (!lastUserMessage || !lastAssistantMessage) {\n      logger.warn('MESSAGES', 'Could not find valid user/assistant message pair to regenerate');\n      toast.error('No valid response to regenerate.');\n      return;\n    }\n\n    logger.info('MESSAGES', 'Regenerating response', {\n      conversationId,\n      userMessageId: lastUserMessage.id,\n      assistantMessageId: lastAssistantMessage.id,\n      userContent: lastUserMessage.content.substring(0, 50)\n    });\n\n    // Remove the last assistant message\n    const updatedMessages = [...messages];\n    updatedMessages.splice(lastAssistantIndex, 1);\n    get().setMessagesForConversation(conversationId, updatedMessages);\n\n    // Save to local storage\n    saveMessagesToStorage(conversationId, updatedMessages);\n\n    try {\n      // Resend the last user message\n      await get().sendMessage(lastUserMessage.content);\n      \n      logger.info('MESSAGES', 'Response regenerated successfully');\n    } catch (error) {\n      logger.error('MESSAGES', 'Failed to regenerate response', error);\n      \n      // Restore the original assistant message on error\n      get().setMessagesForConversation(conversationId, messages);\n      saveMessagesToStorage(conversationId, messages);\n      \n      toast.error('Failed to regenerate response. Please try again.');\n    }\n  },\n}));","import { create } from 'zustand';\nimport { persist } from 'zustand/middleware';\nimport type { ConversationStore, Conversation } from '@/types';\nimport { getClient } from '@/lib/api/client';\nimport { generateConversationName } from '@/lib/utils';\nimport { logger } from '@/lib/logger';\n\n// Session-based conversation isolation\nconst getSessionId = (): string => {\n  // Check if we're running on the server\n  if (typeof window === 'undefined') {\n    return 'server-session';\n  }\n  \n  // Use the current widget session if available\n  if ((window as any).__customgpt_current_session) {\n    return (window as any).__customgpt_current_session;\n  }\n  \n  // Check if we're in widget mode with session configuration\n  if ((window as any).__customgpt_session) {\n    return (window as any).__customgpt_session.sessionId;\n  }\n  \n  // Check for instance-specific sessions (for isolated widgets)\n  if ((window as any).__customgpt_sessions) {\n    // For isolated widgets, we need to determine which session to use\n    // This is tricky since stores are global - we'll use the most recent session\n    const sessions = (window as any).__customgpt_sessions;\n    const sessionIds = Object.keys(sessions);\n    if (sessionIds.length > 0) {\n      // Return the most recently created session\n      return sessionIds[sessionIds.length - 1];\n    }\n  }\n  \n  // Fallback to browser-based session ID\n  try {\n    let sessionId = sessionStorage.getItem('customgpt_session_id');\n    if (!sessionId) {\n      sessionId = `session_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;\n      sessionStorage.setItem('customgpt_session_id', sessionId);\n    }\n    return sessionId;\n  } catch (e) {\n    // Fallback if sessionStorage is not available\n    return `session_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;\n  }\n};\n\nexport const useConversationStore = create<ConversationStore>()(\n  persist(\n    (set, get) => ({\n      conversations: [],\n      currentConversation: null,\n      loading: false,\n      error: null,\n      // Pagination state\n      currentPage: 1,\n      totalPages: 1,\n      totalConversations: 0,\n      perPage: 20,\n      // Sorting and filtering state\n      sortOrder: 'desc' as const,\n      sortBy: 'id',\n      userFilter: 'all' as const,\n      // Client-side filtering state\n      allConversations: [], // Raw conversations from API\n      searchQuery: '',\n      searchMode: 'name' as const,\n      dateFilter: 'all' as const,\n\n      // Client-side filtering helper function\n      applyFilters: () => {\n        const state = get();\n        let filtered = [...state.allConversations];\n        \n        // Apply search filter\n        if (state.searchQuery.trim()) {\n          const query = state.searchQuery.toLowerCase().trim();\n          filtered = filtered.filter(conv => {\n            switch (state.searchMode) {\n              case 'name':\n                return conv.name.toLowerCase().includes(query);\n              case 'id':\n                return conv.id.toString().includes(query);\n              case 'session':\n                return conv.session_id.toLowerCase().includes(query);\n              default:\n                return conv.name.toLowerCase().includes(query);\n            }\n          });\n        }\n        \n        // Apply date filter\n        if (state.dateFilter !== 'all') {\n          const now = new Date();\n          const filterDate = new Date();\n          \n          switch (state.dateFilter) {\n            case 'today':\n              filterDate.setHours(0, 0, 0, 0);\n              break;\n            case 'week':\n              filterDate.setDate(now.getDate() - 7);\n              break;\n            case 'month':\n              filterDate.setDate(now.getDate() - 30);\n              break;\n          }\n          \n          filtered = filtered.filter(conv => {\n            const convDate = new Date(conv.updated_at);\n            return convDate >= filterDate;\n          });\n        }\n        \n        // Note: User filter and sorting are handled server-side by the API\n        // We don't apply them client-side to avoid conflicts\n        \n        set({ conversations: filtered });\n      },\n\n      // Update search filters\n      setSearchQuery: (query: string) => {\n        set({ searchQuery: query });\n        get().applyFilters();\n      },\n\n      setSearchMode: (mode: 'name' | 'id' | 'session') => {\n        set({ searchMode: mode });\n        get().applyFilters();\n      },\n\n      setDateFilter: (filter: 'all' | 'today' | 'week' | 'month') => {\n        set({ dateFilter: filter });\n        get().applyFilters();\n      },\n\n      fetchConversations: async (projectId: number, params?: {\n        page?: number;\n        per_page?: number;\n        order?: 'asc' | 'desc';\n        orderBy?: string;\n        userFilter?: 'all' | 'me' | string;\n        searchQuery?: string;\n        searchMode?: 'name' | 'id' | 'session';\n        dateFilter?: 'today' | 'week' | 'month';\n      }) => {\n        logger.info('CONVERSATIONS', 'Fetching conversations', { projectId, params });\n        set({ loading: true, error: null });\n        \n        // Update client-side filter state if provided\n        if (params?.searchQuery !== undefined) {\n          set({ searchQuery: params.searchQuery });\n        }\n        if (params?.searchMode !== undefined) {\n          set({ searchMode: params.searchMode });\n        }\n        if (params?.dateFilter !== undefined) {\n          set({ dateFilter: params.dateFilter });\n        }\n        \n        try {\n          const client = getClient();\n          // Only send API-supported parameters\n          const apiParams = {\n            page: params?.page ?? get().currentPage,\n            per_page: params?.per_page ?? get().perPage,\n            order: params?.order ?? get().sortOrder,\n            orderBy: params?.orderBy ?? get().sortBy,\n            userFilter: params?.userFilter ?? get().userFilter,\n          };\n          \n          const response = await client.getConversations(projectId, apiParams);\n          logger.info('CONVERSATIONS', 'API response received', { \n            projectId,\n            responseType: typeof response,\n            hasData: !!(response as any)?.data,\n            dataLength: Array.isArray((response as any)?.data) ? (response as any).data.length : 0\n          });\n          \n          // Handle different response formats\n          let conversations = [];\n          let paginationData = null;\n          \n          if (response && typeof response === 'object') {\n            // Standard paginated response format\n            if ((response as any).data && (response as any).data.data) {\n              conversations = (response as any).data.data;\n              paginationData = (response as any).data;\n            } else if (Array.isArray((response as any).data)) {\n              conversations = (response as any).data;\n            } else if (Array.isArray(response)) {\n              conversations = response;\n            }\n          }\n          \n          logger.info('CONVERSATIONS', 'Processed conversations', {\n            count: conversations.length,\n            paginationData,\n            conversations: conversations.map((c: any) => ({ \n              id: c.id, \n              name: c.name,\n              messagesCount: c.messages?.length || 0 \n            }))\n          });\n          \n          // Update state with conversations and pagination data\n          set({ \n            allConversations: conversations, // Store raw conversations from API\n            loading: false,\n            // Update pagination state if available\n            currentPage: paginationData?.current_page ?? 1,\n            totalPages: paginationData?.last_page ?? 1,\n            totalConversations: paginationData?.total ?? conversations.length,\n            // Update sorting/filtering if params were provided\n            ...(params?.order && { sortOrder: params.order }),\n            ...(params?.orderBy && { sortBy: params.orderBy }),\n            ...(params?.userFilter && { userFilter: params.userFilter }),\n          });\n          \n          // Apply client-side filters\n          get().applyFilters();\n        } catch (error) {\n          logger.error('CONVERSATIONS', 'Failed to fetch conversations', error, {\n            projectId,\n            errorType: error instanceof Error ? error.constructor.name : typeof error,\n            status: (error as any)?.status,\n            message: (error as any)?.message\n          });\n          // Don't clear existing conversations on error - preserve local state\n          set({ \n            error: error instanceof Error ? error.message : 'Failed to fetch conversations',\n            loading: false,\n            // Keep existing conversations instead of clearing them\n          });\n        }\n      },\n\n      createConversation: async (projectId: number, name?: string) => {\n        set({ loading: true, error: null });\n        \n        try {\n          const client = getClient();\n          const response = await client.createConversation(projectId, name ? { name } : undefined);\n          const newConversation = response.data;\n          \n          set(state => ({ \n            allConversations: [newConversation, ...state.allConversations],\n            currentConversation: newConversation,\n            loading: false,\n          }));\n          \n          // Apply client-side filters\n          get().applyFilters();\n        } catch (error) {\n          console.error('Failed to create conversation:', error);\n          set({ \n            error: error instanceof Error ? error.message : 'Failed to create conversation',\n            loading: false \n          });\n          throw error;\n        }\n      },\n\n      selectConversation: (conversation: Conversation | null) => {\n        set({ currentConversation: conversation });\n      },\n\n      deleteConversation: async (conversationId: string | number) => {\n        const { conversations, currentConversation } = get();\n        const conversation = conversations.find(c => c.id.toString() === conversationId.toString());\n        \n        if (!conversation) return;\n\n        set({ loading: true, error: null });\n        \n        try {\n          const client = getClient();\n          await client.deleteConversation(conversation.project_id, conversation.session_id);\n          \n          const updatedAllConversations = get().allConversations.filter(c => c.id.toString() !== conversationId.toString());\n          \n          set({ \n            allConversations: updatedAllConversations,\n            currentConversation: currentConversation?.id.toString() === conversationId.toString() \n              ? (updatedAllConversations.length > 0 ? updatedAllConversations[0] : null)\n              : currentConversation,\n            loading: false,\n          });\n          \n          // Apply client-side filters\n          get().applyFilters();\n        } catch (error) {\n          console.error('Failed to delete conversation:', error);\n          set({ \n            error: error instanceof Error ? error.message : 'Failed to delete conversation',\n            loading: false \n          });\n          throw error;\n        }\n      },\n\n      updateConversation: async (projectId: number, sessionId: string, data: { name: string }) => {\n        set({ loading: true, error: null });\n        \n        try {\n          const client = getClient();\n          const response = await client.updateConversation(projectId, sessionId, data);\n          const updatedConversation = response.data;\n          \n          set(state => ({ \n            allConversations: state.allConversations.map(c => \n              c.session_id === sessionId ? updatedConversation : c\n            ),\n            currentConversation: state.currentConversation?.session_id === sessionId \n              ? updatedConversation \n              : state.currentConversation,\n            loading: false,\n          }));\n          \n          // Apply client-side filters\n          get().applyFilters();\n        } catch (error) {\n          console.error('Failed to update conversation:', error);\n          set({ \n            error: error instanceof Error ? error.message : 'Failed to update conversation',\n            loading: false \n          });\n          throw error;\n        }\n      },\n\n      // Auto-create conversation if none exists\n      ensureConversation: async (projectId: number, firstMessage?: string) => {\n        const { currentConversation } = get();\n        \n        // If we have a current conversation for this project, use it\n        if (currentConversation && currentConversation.project_id === projectId) {\n          return currentConversation;\n        }\n        \n        // If no current conversation, always create a new one\n        // This ensures that seeing the welcome screen (currentConversation = null) \n        // always results in starting a fresh conversation\n        const name = firstMessage \n          ? generateConversationName(firstMessage)\n          : `Chat ${new Date().toLocaleDateString()}`;\n          \n        await get().createConversation(projectId, name);\n        return get().currentConversation!;\n      },\n    }),\n    {\n      name: `customgpt-conversations-${getSessionId()}`,\n      partialize: (state) => ({\n        conversations: state.conversations,\n        allConversations: state.allConversations,\n        searchQuery: state.searchQuery,\n        searchMode: state.searchMode,\n        dateFilter: state.dateFilter,\n        // Don't persist currentConversation to always start fresh\n      }),\n      onRehydrateStorage: () => (state) => {\n        if (state) {\n          // Ensure conversations is an array\n          if (!Array.isArray(state.conversations)) {\n            state.conversations = [];\n          }\n          \n          // Ensure allConversations is an array\n          if (!Array.isArray(state.allConversations)) {\n            state.allConversations = [];\n          }\n          \n          // Ensure filter state is initialized\n          if (!state.searchQuery) state.searchQuery = '';\n          if (!state.searchMode) state.searchMode = 'name';\n          if (!state.dateFilter) state.dateFilter = 'all';\n          \n          // Clear current conversation on fresh app load to start with welcome screen\n          state.currentConversation = null;\n        }\n      },\n    }\n  )\n);","// The module cache\nvar __webpack_module_cache__ = {};\n\n// The require function\nfunction __webpack_require__(moduleId) {\n\t// Check if module is in cache\n\tvar cachedModule = __webpack_module_cache__[moduleId];\n\tif (cachedModule !== undefined) {\n\t\treturn cachedModule.exports;\n\t}\n\t// Create a new module (and put it into the cache)\n\tvar module = __webpack_module_cache__[moduleId] = {\n\t\t// no module.id needed\n\t\t// no module.loaded needed\n\t\texports: {}\n\t};\n\n\t// Execute the module function\n\t__webpack_modules__[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n\t// Return the exports of the module\n\treturn module.exports;\n}\n\n// expose the modules object (__webpack_modules__)\n__webpack_require__.m = __webpack_modules__;\n\n","// getDefaultExport function for compatibility with non-harmony modules\n__webpack_require__.n = (module) => {\n\tvar getter = module && module.__esModule ?\n\t\t() => (module['default']) :\n\t\t() => (module);\n\t__webpack_require__.d(getter, { a: getter });\n\treturn getter;\n};","// define getter functions for harmony exports\n__webpack_require__.d = (exports, definition) => {\n\tfor(var key in definition) {\n\t\tif(__webpack_require__.o(definition, key) && !__webpack_require__.o(exports, key)) {\n\t\t\tObject.defineProperty(exports, key, { enumerable: true, get: definition[key] });\n\t\t}\n\t}\n};","__webpack_require__.f = {};\n// This file contains only the entry chunk.\n// The chunk loading function for additional chunks\n__webpack_require__.e = (chunkId) => {\n\treturn Promise.all(Object.keys(__webpack_require__.f).reduce((promises, key) => {\n\t\t__webpack_require__.f[key](chunkId, promises);\n\t\treturn promises;\n\t}, []));\n};","// This function allow to reference async chunks\n__webpack_require__.u = (chunkId) => {\n\t// return url for filenames based on template\n\treturn \"\" + chunkId + \".\" + {\"19\":\"e073d37fc24e76f4429e\",\"49\":\"73423efb335278165a67\",\"281\":\"2aa8c32db11e5fa7c1f7\",\"295\":\"26f3c7bf1d9a0d112f2f\",\"494\":\"5aadff6713133f98651f\",\"578\":\"77e38e76d4c0ae9aaac0\",\"708\":\"a276dfc58d88f5dc86ee\",\"770\":\"1db7f0b0771ccfd49f52\",\"816\":\"4b2ae8a9e603f4bcab4e\",\"958\":\"7c690eb084f0e27fbe7e\",\"984\":\"04ce413466c164f48cc0\"}[chunkId] + \".chunk.js\";\n};","// This function allow to reference async chunks\n__webpack_require__.miniCssF = (chunkId) => {\n\t// return url for filenames based on template\n\treturn undefined;\n};","__webpack_require__.g = (function() {\n\tif (typeof globalThis === 'object') return globalThis;\n\ttry {\n\t\treturn this || new Function('return this')();\n\t} catch (e) {\n\t\tif (typeof window === 'object') return window;\n\t}\n})();","__webpack_require__.o = (obj, prop) => (Object.prototype.hasOwnProperty.call(obj, prop))","// define __esModule on exports\n__webpack_require__.r = (exports) => {\n\tif(typeof Symbol !== 'undefined' && Symbol.toStringTag) {\n\t\tObject.defineProperty(exports, Symbol.toStringTag, { value: 'Module' });\n\t}\n\tObject.defineProperty(exports, '__esModule', { value: true });\n};","__webpack_require__.p = \"/\";","// no baseURI\n\n// object to store loaded and loading chunks\n// undefined = chunk not loaded, null = chunk preloaded/prefetched\n// [resolve, reject, Promise] = chunk loading, 0 = chunk loaded\nvar installedChunks = {\n\t30: 0\n};\n\n__webpack_require__.f.j = (chunkId, promises) => {\n\t\t// JSONP chunk loading for javascript\n\t\tvar installedChunkData = __webpack_require__.o(installedChunks, chunkId) ? installedChunks[chunkId] : undefined;\n\t\tif(installedChunkData !== 0) { // 0 means \"already installed\".\n\n\t\t\t// a Promise means \"currently loading\".\n\t\t\tif(installedChunkData) {\n\t\t\t\tpromises.push(installedChunkData[2]);\n\t\t\t} else {\n\t\t\t\tif(true) { // all chunks have JS\n\t\t\t\t\t// setup Promise in chunk cache\n\t\t\t\t\tvar promise = new Promise((resolve, reject) => (installedChunkData = installedChunks[chunkId] = [resolve, reject]));\n\t\t\t\t\tpromises.push(installedChunkData[2] = promise);\n\n\t\t\t\t\t// start chunk loading\n\t\t\t\t\tvar url = __webpack_require__.p + __webpack_require__.u(chunkId);\n\t\t\t\t\t// create error before stack unwound to get useful stacktrace later\n\t\t\t\t\tvar error = new Error();\n\t\t\t\t\tvar loadingEnded = (event) => {\n\t\t\t\t\t\tif(__webpack_require__.o(installedChunks, chunkId)) {\n\t\t\t\t\t\t\tinstalledChunkData = installedChunks[chunkId];\n\t\t\t\t\t\t\tif(installedChunkData !== 0) installedChunks[chunkId] = undefined;\n\t\t\t\t\t\t\tif(installedChunkData) {\n\t\t\t\t\t\t\t\tvar errorType = event && (event.type === 'load' ? 'missing' : event.type);\n\t\t\t\t\t\t\t\tvar realSrc = event && event.target && event.target.src;\n\t\t\t\t\t\t\t\terror.message = 'Loading chunk ' + chunkId + ' failed.\\n(' + errorType + ': ' + realSrc + ')';\n\t\t\t\t\t\t\t\terror.name = 'ChunkLoadError';\n\t\t\t\t\t\t\t\terror.type = errorType;\n\t\t\t\t\t\t\t\terror.request = realSrc;\n\t\t\t\t\t\t\t\tinstalledChunkData[1](error);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t};\n\t\t\t\t\t__webpack_require__.l(url, loadingEnded, \"chunk-\" + chunkId, chunkId);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n};\n\n// no prefetching\n\n// no preloaded\n\n// no HMR\n\n// no HMR manifest\n\n__webpack_require__.O.j = (chunkId) => (installedChunks[chunkId] === 0);\n\n// install a JSONP callback for chunk loading\nvar webpackJsonpCallback = (parentChunkLoadingFunction, data) => {\n\tvar [chunkIds, moreModules, runtime] = data;\n\t// add \"moreModules\" to the modules object,\n\t// then flag all \"chunkIds\" as loaded and fire callback\n\tvar moduleId, chunkId, i = 0;\n\tif(chunkIds.some((id) => (installedChunks[id] !== 0))) {\n\t\tfor(moduleId in moreModules) {\n\t\t\tif(__webpack_require__.o(moreModules, moduleId)) {\n\t\t\t\t__webpack_require__.m[moduleId] = moreModules[moduleId];\n\t\t\t}\n\t\t}\n\t\tif(runtime) var result = runtime(__webpack_require__);\n\t}\n\tif(parentChunkLoadingFunction) parentChunkLoadingFunction(data);\n\tfor(;i < chunkIds.length; i++) {\n\t\tchunkId = chunkIds[i];\n\t\tif(__webpack_require__.o(installedChunks, chunkId) && installedChunks[chunkId]) {\n\t\t\tinstalledChunks[chunkId][0]();\n\t\t}\n\t\tinstalledChunks[chunkId] = 0;\n\t}\n\treturn __webpack_require__.O(result);\n}\n\nvar chunkLoadingGlobal = Object(typeof self !== 'undefined' ? self : this)[\"webpackChunkCustomGPTWidget\"] = Object(typeof self !== 'undefined' ? self : this)[\"webpackChunkCustomGPTWidget\"] || [];\nchunkLoadingGlobal.forEach(webpackJsonpCallback.bind(null, 0));\nchunkLoadingGlobal.push = webpackJsonpCallback.bind(null, chunkLoadingGlobal.push.bind(chunkLoadingGlobal));","__webpack_require__.nc = undefined;","// startup\n// Load entry module and return exports\n// This entry module depends on other loaded chunks and execution need to be delayed\nvar __webpack_exports__ = __webpack_require__.O(undefined, [96], () => (__webpack_require__(24111)))\n__webpack_exports__ = __webpack_require__.O(__webpack_exports__);\n"],"names":["root","factory","exports","module","define","amd","self","this","deferred","leafPrototypes","getProto","inProgress","dataWebpackPrefix","Logger","constructor","_defineProperty","isClient","window","getInstance","instance","formatMessage","entry","timestamp","level","category","message","data","error","stack","formatted","toUpperCase","JSON","stringify","writeToFile","log","Date","toISOString","code","status","undefined","logs","push","length","slice","split","info","warn","getLogs","clearLogs","apiRequest","endpoint","method","apiResponse","apiError","authCheck","authError","navigation","route","params","storeAction","store","action","logger","StreamHandler","config","timeout","retryAttempts","retryDelay","processStream","stream","callbacks","abortController","AbortController","currentMessage","id","generateId","content","citations","isComplete","reader","getReader","decoder","TextDecoder","buffer","timeoutId","setTimeout","cancel","onError","Error","done","value","read","onComplete","decode","lines","pop","line","trim","processLine","name","clearTimeout","releaseLock","chunk","parseStreamChunk","type","onChunk","forEach","citation","onCitation","abort","getCurrentMessage","isStreaming","Math","random","toString","substring","now","globalStreamManager","maxConcurrentStreams","Map","startStream","streamId","streams","size","has","cancelStream","handler","set","delete","get","cancelAllStreams","clear","getActiveStreams","Array","from","keys","getStreamStatus","exists","getActiveStreamCount","UsageTracker","process","NEXT_PUBLIC_ANALYTICS_ENDPOINT","startFlushTimer","track","event","fullEvent","eventType","eventName","deploymentMode","getDeploymentMode","demoType","getDemoType","sessionId","getSessionId","clientVersion","NEXT_PUBLIC_APP_VERSION","userAgent","navigator","referrer","document","eventQueue","batchSize","flush","trackApiCall","statusCode","trackSessionStart","metadata","mode","trackSessionEnd","reason","trackLimitReached","limitType","trackError","context","localStorage","getItem","DEMO_STORAGE_KEYS","DEPLOYMENT_MODE","FREE_TRIAL_MODE","sessionData","sessionStorage","FREE_TRIAL_SESSION","parse","e","demoSession","DEMO_SESSION","flushTimer","clearInterval","setInterval","flushInterval","events","fetch","analyticsEndpoint","headers","body","unshift","forceFlush","usageTracker","addEventListener","hidden","LODManager","initialLOD","particleReduction","effectsDisabled","glowDisabled","simplifiedRendering","skipFrames","currentLOD","lodProfiles","updateLOD","metrics","frameCount","lastPerformanceCheck","performanceHistory","fps","shift","avgFPS","reduce","sum","adjustLODBasedOnFPS","targetFPS","min","max","getCurrentLOD","shouldSkipFrame","FrustumCuller","width","height","margin","updateBounds","bounds","left","right","top","bottom","near","far","isVisible","x","y","z","cullParticles","particles","filter","particle","getCullingStats","visible","culled","total","cullingRatio","BatchRenderer","addToBatch","color","alpha","glowEnabled","effectsEnabled","batchKey","batches","batch","maxBatchSize","renderBatches","lodSettings","entries","save","fillStyle","shouldRenderEffects","shouldRenderGlow","renderSimplifiedBatch","renderFullBatch","restore","beginPath","globalAlpha","moveTo","arc","PI","fill","renderEffects","renderGlow","glowGradient","createRadialGradient","addColorStop","clearBatches","values","getBatchStats","batchCount","totalParticles","largestBatch","avgBatchSize","MemoryOptimizer","checkMemoryPressure","currentTime","performance","pressure","shouldCleanup","memInfo","memory","usedJSHeapSize","jsHeapSizeLimit","memoryPressureThreshold","lastGCTime","gcInterval","getOptimizationSuggestions","reduceParticles","clearCaches","disableEffects","simplifyRendering","AnimationController","setTargetFPS","setupVisibilityHandling","actualInterval","shouldRenderFrame","lastFrameTime","getFrameTiming","interval","shouldThrottle","ThemePerformanceManager","canvasWidth","canvasHeight","lodManager","culler","batchRenderer","memoryOptimizer","animationController","update","shouldRender","memoryPressure","optimizationActive","getManagers","lod","animation","getPerformanceReport","culling","batching","BaseTheme","VoiceState","IDLE","performanceMonitor","PerformanceMonitor","performanceSettings","maxParticles","enableEffects","enableGlow","qualityLevel","initializePerformanceCallbacks","init","updateDimensions","initializePerformanceManager","setupPerformanceSettings","onInit","centerX","centerY","performanceManager","draw","displayWidth","displayHeight","projCenterX","projCenterY","deltaTime","perfUpdate","currentLODSettings","updateTiming","updateStateTransition","updateMouseInfluence","clearCanvas","onDraw","shouldShowPerformanceOverlay","drawPerformanceOverlay","onUserSpeaking","setTargetState","USER_SPEAKING","onStateChange","onProcessing","PROCESSING","onAiSpeaking","AI_SPEAKING","reset","onReset","setMousePosition","mouseX","mouseY","normalizedMouseX","normalizedMouseY","targetMouseInfluence","isHovering","onMouseMove","setHovering","hovering","onHoverChange","dispose","onDispose","getPerformanceMetrics","getCurrentMetrics","getThemeSpecificMetrics","newState","normalizedX","normalizedY","clearRect","detector","DeviceCapabilityDetector","capabilities","detectCapabilities","performanceLevel","isLowPowerDevice","getOptimalParticleCount","quality","light","low","medium","high","heavy","performanceProfile","setCallbacks","onPerformanceWarning","adjustPerformanceSettings","onPerformanceCritical","factor","floor","state","targetState","stateTransition","currentState","stateTransitionSpeed","mouseInfluence","lerp","deltaTimeAccumulator","animationTime","fillRect","font","fillText","round","frameTime","getStateColor","idleColor","activeColor","getMouseInfluencedValue","baseValue","influencedValue","shouldEnableEffects","shouldEnableGlow","getMaxParticles","baseMax","getCurrentLODLevel","shouldUseSimplifiedRendering","getPerformanceManagers","isParticleVisible","managers","buttonVariants","cva","variants","variant","default","join","destructive","outline","secondary","ghost","link","premium","sm","lg","xl","icon","defaultVariants","Button","React","className","asChild","loading","loadingText","children","disabled","onClick","props","ref","ripples","setRipples","handleClick","rect","currentTarget","getBoundingClientRect","rippleX","clientX","rippleY","clientY","rippleId","prev","ripple","_jsxs","cn","map","_jsx","style","transform","xmlns","viewBox","cx","cy","r","stroke","strokeWidth","d","displayName","sizeVariants","xs","container","md","shapeVariants","circle","rounded","square","Avatar","agent","src","alt","shape","fallback","isSelected","imageError","setImageError","avatarUrl","settings","chatbot_avatar","altText","project_name","sizeClasses","shapeClass","backgroundClass","handleImageError","renderFallbackIcon","iconClass","User","Bot","AgentAvatar","UserAvatar","CitationCard","index","isExpanded","onToggle","onPreviewClick","title","source","url","ChevronDown","AnimatePresence","motion","div","initial","opacity","animate","exit","transition","duration","href","target","rel","ExternalLink","FileText","CitationList","onCitationClick","maxVisible","expanded","setExpanded","useState","Set","showAll","setShowAll","visibleCitations","hasMore","BookOpen","idx","delay","citationId","newExpanded","add","toggleExpanded","MessageDetails","details","setIsExpanded","handleCopyValue","async","copyToClipboard","toast","success","Info","ChevronUp","detailsText","Copy","user_id","DetailRow","label","String","onCopy","conversation_id","updated_at","toLocaleString","user_ip","user_agent","truncate","external_id","request_source","SyntaxHighlighter","SyntaxHighlighterComponent","CodeBlock","language","copied","setCopied","oneDark","customStyle","borderRadius","fontSize","StreamingCursor","MessageContent","cleanedContent","replace","ReactMarkdown","remarkPlugins","remarkGfm","components","match","exec","a","MessageActions","onFeedback","isLastAssistant","feedback","setFeedback","handleFeedback","regenerateLastResponse","useMessageStore","ThumbsUp","ThumbsDown","RotateCw","Message","isLast","enableCitations","isUser","role","shouldShowCitations","messages","currentConversation","useConversationStore","getState","getMessagesForConversation","formatTimestamp","DemoModeContext","createContext","isRuntimeDemoMode","isInitialized","isFreeTrialMode","useDemoModeContext","useContext","Spinner","Loader2","Skeleton","LoadingOverlay","blur","MessageSkeleton","isAssistant","_","i","ConversationSkeleton","count","TooltipProvider","TooltipPrimitive","Tooltip","TooltipTrigger","TooltipContent","sideOffset","SpeechToTextButton","onTranscription","onTranscriptionStart","onTranscriptionEnd","isMobile","isRecording","setIsRecording","isProcessing","setIsProcessing","recordingDuration","setRecordingDuration","mediaRecorderRef","useRef","audioChunksRef","recordingTimeoutRef","durationIntervalRef","stopRecording","useCallback","current","stop","startRecording","mediaDevices","getUserMedia","audio","mimeType","MediaRecorder","isTypeSupported","mediaRecorder","ondataavailable","onstop","audioBlob","Blob","getTracks","processAudio","start","startTime","elapsed","FileReader","readAsDataURL","onloadend","base64Data","result","__demoOpenAIKey","response","ok","errorData","json","catch","includes","text","onerror","isActive","formatDuration","seconds","padStart","MicOff","Mic","AnimatedVoiceIcon","barHeights","bars","gap","animationDelay","background","DropdownMenu","DropdownMenuPrimitive","DropdownMenuTrigger","inset","ChevronRight","DropdownMenuContent","DropdownMenuItem","checked","Check","Circle","DropdownMenuLabel","DropdownMenuSeparator","FileChip","file","onRemove","fileIcon","getFileIcon","scale","formatFileSize","_Fragment","progress","AlertCircle","X","FileUploadButton","onUpload","fileInputRef","multiple","accept","CONSTANTS","ACCEPTED_FILE_TYPES","onChange","files","click","Paperclip","RESPONSE_SOURCES","description","MessageSquare","Brain","Settings","CHATBOT_MODELS","Sparkles","Zap","COMMON_PERSONAS","AGENT_CAPABILITIES","enterprise","ChatInput","onSend","placeholder","maxLength","MAX_MESSAGE_LENGTH","onVoiceClick","input","setInput","setFiles","isTranscribing","setIsTranscribing","isLoadingSettings","setIsLoadingSettings","showSettings","setShowSettings","textareaRef","currentAgent","useAgentStore","getSettings","updateSettings","updateLocalSettings","useChatSettingsStore","response_source","chatbot_model","custom_persona","agent_capability","loadAgentSettings","client","getClient","getAgentSettings","loadedSettings","useEffect","updateSetting","key","updates","validModels","m","some","find","c","updateAgentSettings","adjustTextareaHeight","textarea","scrollHeight","maxHeight","handleSubmit","preventDefault","fileObjects","f","focus","handleFileUpload","newFiles","uploadFiles","MAX_FILE_SIZE","isFileTypeAllowed","uploadFile","simulateUpload","getRootProps","getInputProps","isDragActive","useDropzone","onDrop","noClick","noKeyboard","acc","maxSize","canSend","handleTranscription","prevInput","newInput","handleTranscriptionStart","handleTranscriptionEnd","Upload","removeFile","fileId","onSubmit","onKeyDown","shiftKey","rows","overflowY","Send","SlidersHorizontal","align","Icon","model","persona","capability","TypingIndicator","iconSizeClasses","display","parent","parentElement","createElement","innerHTML","appendChild","AgentItem","onSelect","onSettingsClick","is_chat_active","stopPropagation","AgentSelector","isOpen","setIsOpen","isSelectingAgent","setIsSelectingAgent","loadingSettings","setLoadingSettings","dropdownRef","agents","fetchAgents","loadMoreAgents","selectAgent","setAgents","paginationMeta","fetchAgentSettings","agentsNeedingSettings","agentsToLoad","newSet","settingsPromises","agentId","results","Promise","all","updatedAgents","handleClickOutside","contains","removeEventListener","handleRefresh","handleSelectAgent","RefreshCw","willOpen","location","BarChart3","isArray","totalCount","useMediaQuery","query","matches","setMatches","media","matchMedia","listener","useBreakpoint","isTablet","isDesktop","isLargeScreen","isTouchDevice","isMobileOrTablet","isTabletOrDesktop","widgetToastQueues","WidgetToaster","Toaster","position","closeButton","toastOptions","zIndex","marginTop","richColors","theme","getWidgetToast","options","globalToast","widgetSessionId","warning","dismiss","WidgetContext","WidgetProvider","widgetInstance","useMemo","widget","Provider","useWidgetSafe","WidgetDebugger","debugEnabled","logEntry","logHistory","inspectLocalStorage","allKeys","Object","widgetKeys","messageKeys","conversationKeys","contents","allKeysCount","widgetKeysCount","getDebugInfo","conversations","getConversations","currentConversationId","widgetStores","__customgpt_widget_stores","messageStore","conversationCount","messagesMapSize","messagesMapKeys","hasMessageStore","hasConversationStore","conversationStore","hasAgentStore","agentStore","debugConversation","conversationId","traceMessageFlow","exportLogs","setDebugEnabled","enabled","__customgpt_debug","instances","__customgpt_widget_instances","instanceKeys","widgetDebugger","__customgpt_debug_trace","__customgpt_debug_storage","__customgpt_debug_clear","confirm","removeItem","removeCitationReferences","createMessageStore","MESSAGES_STORAGE_KEY","saveMessagesToStorage","storageKey","setItem","stored","cache","messageCount","cacheKey","actualKeys","messageIds","storageKeys","create","streamingMessage","sendMessage","isDemoMode","__customgpt_demo_mode","agentName","messageLength","hasFiles","conversation","ensureConversation","parseInt","session_id","hasSessionId","isNew","message_count","userMessage","conversationIdType","messageId","currentMapKeys","addMessage","assistantMessage","messageContent","resolve","demoResponse","updateStreamingMessage","finalMessage","sendMessageStream","prompt","hasContent","contentLength","contentPreview","streamError","messageData","rawContent","openai_response","fallbackError","updateConversation","loadMessages","currentMapSize","cachedMessages","sessionStorageKey","sessionStored","hasSessionStored","sessionStoredLength","fromKey","hasCache","cacheSize","foundMessages","cacheKeys","cacheKeyTypes","k","checkedKeys","allLocalStorageKeys","loadMessagesFromStorage","hasMessages","firstMessage","newMap","newMapSize","newMapKeys","mapNowHasConversation","messageRole","newMessages","existingMessageCount","mapHasConversation","existingIndex","findIndex","newMessageCount","clearMessages","cancelStreaming","updateMessageFeedback","convId","messageIndex","updatedMessages","clearError","setMessagesForConversation","createConversationStore","CONVERSATIONS_STORAGE_KEY","ACTIVITY_STORAGE_KEY","saveConversationsToStorage","loadConversationsFromStorage","loadActivityFromStorage","allConversations","lastConversationActivity","currentPage","totalPages","totalConversations","perPage","sortOrder","sortBy","userFilter","searchQuery","searchMode","dateFilter","fetchConversations","projectId","loadConversations","widgetConvKey","widgetConvIds","queryParams","page","per_page","order","orderBy","paginationData","widgetConversations","conv","totalFromAPI","widgetSpecific","current_page","last_page","applyFilters","cached","cachedConversations","sessionConversations","totalCached","sessionSpecific","createConversation","sessionIdForConv","newConversation","project_id","created_at","deleted_at","existingConvIds","deleteConversation","selectConversation","activity","saveActivityToStorage","existingConversation","filtered","toLowerCase","filterDate","setHours","setDate","getDate","setSearchQuery","setSearchMode","setDateFilter","createAgentStore","AGENTS_STORAGE_KEY","SELECTED_AGENT_KEY","saveAgentsToStorage","saveSelectedAgentToStorage","loadAgents","__customgpt_widget_instance","hasWidget","configuredAgentId","fallbackAgent","is_shared","team_id","getAgent","settingsResponse","hasAvatar","settingsError","hasSettings","demoAgent","getAgents","selectedAgentId","loadSelectedAgentFromStorage","selectedAgent","demoAgents","widgetKey","updateAgent","updatedAgent","deleteAgent","createAgent","replicateAgent","getAgentStats","messages_sent","users_interacted","last_message_at","WidgetStoreContext","WidgetStoreProvider","storesRef","stores","CitationDetailsModal","onClose","setLoading","setError","citationData","setCitationData","globalStore","widgetStoreContext","effectiveProjectId","fetchCitationDetails","getCitation","hasImage","image","err","errorMessage","Loader","Globe","ImageIcon","CitationFilePreview","fileName","fileContent","setFileContent","contentType","setContentType","fetchFilePreview","previewCitationFile","content_type","clipboard","writeText","handleDownload","blob","URL","createObjectURL","download","removeChild","revokeObjectURL","Download","MessageErrorDisplay","propStatusCode","onRetry","parsedStatusCode","statusMatch","parseError","finalStatusCode","errorDetails","getErrorDetails","iconClassName","textClassName","UserX","showSupport","Search","CreditCard","supportUrl","ServerCrash","showRetry","XCircle","useIsInWidgetContext","useWidgetStores","isInWidget","useGlobalMessageStore","widgetStore","useStore","useGlobalConversationStore","useGlobalAgentStore","ThemeManager","easing","crossfade","registerBuiltInThemes","initialize","canvas","currentTheme","registerTheme","registration","registeredThemes","unregisterTheme","themeId","getAvailableThemes","reg","getThemeMetadata","switchTheme","transitionOptions","isTransitioning","onThemeError","newTheme","performThemeTransition","getCurrentTheme","getCurrentThemeId","drawTransition","transitionTheme","then","DefaultTheme","previewColors","previewDescription","StarfieldTheme","JarvisTheme","LegoTheme","StarWarsTheme","OceanWaveTheme","NFTTheme","NothingPhoneTheme","MinecraftTheme","FuturisticTheme","VintageModernTheme","AuroraTheme","oldTheme","oldThemeId","transitionProgress","onTransitionStart","applyEasing","completeTransition","requestAnimationFrame","onThemeChange","onTransitionComplete","tempCanvas1","tempCanvas2","tempCtx1","getContext","tempCtx2","drawImage","t","Canvas","forwardRef","internalRef","canvasRef","themeManagerRef","isInitializedRef","themeManager","resizeCanvas","innerWidth","innerHeight","debouncedResize","func","args","debounce","handleMouseMove","lastCall","timeSinceLastCall","throttle","handleMouseEnter","handleMouseLeave","animationFrameId","lastTime","frameInterval","fpsTime","currentFPS","render","currentWidth","currentHeight","currentProjCenterX","currentProjCenterY","cancelAnimationFrame","getThemeManager","useVoiceSettingsStore","persist","selectedVoice","selectedPersona","isVoiceModalOpen","setVoice","voice","setPersona","setVoiceModalOpen","partialize","VoiceSettings","useRouter","previewVoice","setPreviewVoice","previewPersona","setPreviewPersona","previewModel","setPreviewModel","desc","StreamingTTSManager","initAudioContext","audioContext","AudioContext","webkitAudioContext","resume","addTextChunk","audioBuffer","textToSpeech","audioQueue","isPlaying","playNextChunk","addAudioBuffer","addAudioBufferWithId","chunkId","pendingChunks","nextExpectedChunkId","response_format","arrayBuffer","decodeAudioData","onPlaybackComplete","currentSource","createBufferSource","connect","destination","onended","stopPlayback","resetChunkCounter","isCurrentlyPlaying","getQueueLength","onPlaybackCompleted","callback","onStreamingError","destroy","close","speechManager","debug","stopSourceIfNeeded","audioLength","audioDuration","sourceIsStarted","streamingTTS","toFixed","validate","sendData","createAudioBlob","wavBuffer","utils","encodeWAV","samples","sendStreamingData","formData","FormData","append","voiceSettings","conversationLength","conversationThusFar","audioSize","lastMessages","preview","base64Encode","__demoCustomGPTKey","errorText","processStreamingResponse","handleError","fullResponse","transcript","currentStreamingActive","startsWith","parsed","onStreamingTextChunk","audioUrl","audioId","queueAudioChunk","queueAudioChunkById","responseLength","onTranscriptReceived","onResponseReceived","onStreamingComplete","audioDataUrl","numericChunkId","sampleRate","numberOfChannels","clonedBlob","minDuration","valid","hasCallbacks","setProjectId","setSessionId","setVoiceSettings","setChatbotModel","chatbotModel","onDebug","str","TextEncoder","encode","btoa","fromCharCode","Uint8Array","base64Decode","base64","binaryStr","atob","bytes","char","charCodeAt","clearConversation","getConversationThusFar","setConversationHistory","cleanedMessages","msg","originalCount","stopAudio","parseMarkdownForVoice","encrypt","decrypt","encrypted","isValidApiKey","trimmedKey","apiKey","test","STORAGE_KEY","OPENAI_STORAGE_KEY","ENCRYPTION_KEY","SESSION_KEY","SESSION_TIMEOUT","useDemoStore","openAIApiKey","encryptionKey","isAuthenticated","sessionStartTime","sessionTimeout","setApiKey","encKey","array","crypto","getRandomValues","byte","generateKey","sessionInfo","setOpenAIApiKey","clearApiKey","validateSession","initializeFromStorage","restoreSession","encryptedOpenAI","openAIKey","VoiceModalContent","projectName","setTranscript","agentResponse","setAgentResponse","isManualRecording","setIsManualRecording","setMediaRecorder","apiKeyError","setApiKeyError","isAgentSpeaking","setIsAgentSpeaking","isSettingsOpen","setIsSettingsOpen","voiceState","setVoiceState","isStreamingText","setIsStreamingText","streamingResponse","setStreamingResponse","currentUserMessageId","setCurrentUserMessageId","voiceConversation","setVoiceConversation","conversationSetupRef","checkOpenAIKeyAvailability","vad","useMicVAD","preSpeechPadFrames","positiveSpeechThreshold","negativeSpeechThreshold","minSpeechFrames","startOnLoad","workletURL","modelURL","onSpeechStart","onSpeechEnd","onVADMisfire","onMisfire","demoApiKey","sort","b","getTime","setupConversation","placeholderUserMessage","targetConversation","errorMsg","currentTitle","voiceTitle","cleanTranscript","words","updatedUserMessage","textChunk","newText","cleanResponse","onStreamingAudioReady","listening","pause","errored","handleToggleListening","recoveryError","permissionError","vadError","handleManualRecording","echoCancellation","noiseSuppression","autoGainControl","recorder","chunks","decodedAudio","channelData","getChannelData","audioArray","resampleRatio","newLength","Float32Array","srcIndex","srcIndexFloor","srcIndexCeil","fraction","hasAutoStarted","setHasAutoStarted","handleStopSpeech","jsx","global","pointerEvents","RotateLoader","AlertTriangle","flexDirection","animationDirection","animationDuration","StopCircle","VoiceModal","Input","iconPosition","inputElement","Card","interactive","elevated","bordered","glass","FreeTrialLimitModal","apiKeyInput","setApiKeyInput","showApiKey","setShowApiKey","isValidating","setIsValidating","FREE_TRIAL_LIMITS","MAX_MESSAGES_PER_CONVERSATION","Clock","SESSION_DURATION","demoSessionData","Key","htmlFor","EyeOff","Eye","DEFAULT_EXAMPLE_PROMPTS","ExamplePromptCard","WelcomeMessage","onPromptClick","exampleQuestions","setExampleQuestions","example_questions","questionCount","fetchExampleQuestions","MessageArea","onShowFreeTrialLimitModal","scrollRef","isLoadingMessages","setIsLoadingMessages","prevConversationId","setPrevConversationId","selectedCitationId","setSelectedCitationId","citationModalOpen","setCitationModalOpen","previewCitationId","setPreviewCitationId","previewModalOpen","setPreviewModalOpen","setIsFreeTrialMode","freeTrialFlag","conversationMessages","scrollBehavior","scrollTo","behavior","handleCitationClick","citationIndex","citationTitle","handlePreviewClick","lastUserMessage","filteredMessages","handleMessageFeedback","ChatHeader","onAgentSettings","enableConversationManagement","maxConversations","onConversationChange","onCreateConversation","conversationRefreshKey","ChatContainer","threadId","onMessage","setCurrentConversationId","setIsVoiceModalOpen","voiceError","setVoiceError","showFreeTrialLimitModal","setShowFreeTrialLimitModal","agentCount","hasCurrentAgent","currentAgentName","initializeAgents","switchConversation","newConv","configuration","fileCount","isAuthError","anyErr","retryAfter","limit","handleVoiceClick","available","Select","SelectPrimitive","SelectValue","SelectTrigger","SelectScrollUpButton","SelectScrollDownButton","SelectContent","SelectItem","SimpleSelect","onValueChange","option","ConversationDetailsModal","formatFullTimestamp","weekday","year","month","day","hour","minute","second","timeZoneName","Hash","Calendar","created_by","DeleteConversationDialog","conversationName","onConfirm","onCancel","isDeleting","setIsDeleting","Trash2","ConversationItem","onDelete","onRename","isEditing","setIsEditing","editName","setEditName","showMenu","setShowMenu","showDetails","setShowDetails","showDetailsModal","setShowDetailsModal","showDeleteDialog","setShowDeleteDialog","isLoading","setIsLoading","inputRef","menuRef","select","handleSaveEdit","onBlur","MoreHorizontal","Edit3","ConversationSidebar","isCollapsed","onConversationSelect","isCreating","setIsCreating","showSortFilter","setShowSortFilter","isSearching","setIsSearching","storeSearchQuery","storeSearchMode","storeDateFilter","localSearchQuery","setLocalSearchQuery","debouncedSearch","handleSearchModeChange","filteredConversations","handleSelectConversation","errorType","handleRenameConversation","newName","handleSearch","Filter","handleDateFilterChange","Link","toLocaleDateString","Plus","handleDeleteConversation","ChatLayout","showSidebar","sidebarCollapsed","setSidebarCollapsed","mobileSidebarOpen","setMobileSidebarOpen","storeCurrentConversation","conversationToLoad","handleToggleSidebar","FloatingButton","onMinimize","primaryColor","showLabel","isHovered","setIsHovered","iconSizes","button","whileHover","whileTap","onMouseEnter","onMouseLeave","backgroundColor","repeat","Infinity","ease","MessageCircle","CustomGPTWidget","enableFeedback","isolateConversations","modePrefix","containerId","uniqueId","substr","generateSessionId","instanceKey","initializeClient","require","useProxy","apiUrl","proxyUrl","__customgpt_api_url","__customgpt_sessions","__customgpt_session","createContainer","createFloatingButton","persistedConversationId","existingConversations","persistedConversation","setState","fullConversation","__customgpt_active_widget_session","getElementById","setupFloatingStyles","assign","boxShadow","overflow","classList","fetchAgentAvatar","agentAvatar","floatingButtonRoot","floatingButtonContainer","createRoot","FloatingButtonApp","toggle","buttonSize","WidgetApp","currentConvId","handleClose","open","currentConversations","idType","found","searchedId","conversationDetails","hasWidgetStores","hasSessionStore","availableSessions","storeHasLoadMessages","convIdStr","originalId","stringId","typeOfOriginal","availableStores","storeConversations","widgetConversation","createdAt","saveConversations","updateConversationTitle","newTitle","DOMException","cleanupOldConversations","recent","onOpen","unmount","parentNode","updateConfig","newConfig","refresh","isOpened","CustomGPTWidgetAPI","webpackEmptyContext","req","clearSettings","newSettings","DEMO_ERROR_MESSAGES","proxyClient","globalApiUrl","baseURL","setApiUrl","setDemoApiKey","request","requestId","controller","abortControllers","isFormData","baseHeaders","session","turnstileToken","tokenData","expiresAt","token","signal","responseData","updated","jsonError","errorInfo","getErrorMessage","isFreeTrialError","streamRequest","cancelRequest","cancelAllRequests","URLSearchParams","queryString","getProjectPlugins","updateProjectPlugin","pluginId","getMessages","getMessageById","getTrafficReport","getQueriesReport","getConversationsReport","getAnalysisReport","getPages","crawl_status","index_status","deletePage","pageId","reindexPage","getPageMetadata","updatePageMetadata","getLicenses","createLicense","getLicense","licenseId","updateLicense","deleteLicense","getSources","createSitemapSource","sitemap_path","executive_js","data_refresh_frequency","create_new_pages","remove_unexist_pages","refresh_existing_pages","uploadFileSource","updateSourceSettings","sourceId","deleteSource","instantSyncSource","getCustomerIntelligence","startDate","endDate","getUserLimits","getUserProfile","updateUserProfile","getDemoUsageStats","cleanupDemoSession","DirectCustomGPTClient","hasApiKey","clientInstance","initialized","getApiClient","isClientInitialized","resetApiClient","apiClient","inputs","twMerge","clsx","parseFloat","pow","fileType","allowedTypes","date","diffInMs","diffInMinutes","diffInHours","diffInDays","delta","choices","generateConversationName","cleanedMessage","API_TIMEOUT","STREAM_TIMEOUT","RETRY_ATTEMPTS","RETRY_DELAY","MAX_PROJECTS","MAX_CONVERSATIONS","SESSION_WARNING_TIME","MAX_REQUESTS_PER_MINUTE","COOLDOWN_BETWEEN_MESSAGES","ALLOW_FILE_UPLOAD","ALLOW_SITEMAP_UPLOAD","ALLOW_DELETE_OPERATIONS","ALLOW_PROJECT_SETTINGS","ALLOW_VOICE_MODE","SESSION_EXPIRY_WARNING","SESSION_EXPIRED_MESSAGE","LIMIT_REACHED_MESSAGE","projects","API_KEY","OPENAI_KEY","SESSION_START","AUTO_DETECTED","nestedData","paginatedResponse","fetchSettingsForAgents","agentsWithoutSettings","validResults","nextPage","newAgents","responseTotal","responsePage","findAgent","newAgent","agentWithSettings","updatedSettings","filteredAgents","end","clamp","distance2D","x1","y1","x2","y2","dx","dy","sqrt","hslToRgb","h","s","l","hue2rgb","p","q","super","sphereRadius","gemini","idle","g","gradient","userSpeaking","processing","aiSpeaking","hover","instagram","ocean","sunset","aurora","particlePool","ObjectPool","velX","velY","velZ","age","dead","projX","projY","attack","hold","decay","initValue","holdValue","lastValue","stuckTime","accelX","accelY","accelZ","next","setColor","getColorPalette","updateColors","updateParticles","renderParticles","palette","framesPerRotation","colorTransitionSpeed","numToAddEachFrame","particleAlpha","particleRad","gravity","particleCount","currentParticleCount","colorScheme","currentColorScheme","setColorScheme","scheme","colorSchemes","targetR","targetG","targetB","currentR","currentG","currentB","wait","dynamicNumParticles","particlesToCreate","createParticle","dynamicTurnSpeed","turnAngle","theta","phi","acos","mouseDistortion","mouseBias","x0","sin","cos","y0","z0","velocityMultiplier","addParticle","sphereCenterY","sphereCenterZ","alphaMultiplier","vx0","vy0","vz0","newParticle","acquire","particleList","first","sinAngle","cosAngle","zMax","focalLength","nextParticle","randAccelX","randAccelY","randAccelZ","rotX","rotZ","radiusScale","updateParticleAlpha","recycleParticle","renderParticle","finalAlpha","zeroAlphaDepth","particleSize","release","fpsHistory","frameTimeHistory","maxHistorySize","performanceRatio","criticalThreshold","warningThreshold","onFPSUpdate","detectMobile","supportsWebGL","detectWebGL","hardwareConcurrency","memoryGB","benchmarkPerformance","detectLowPowerDevice","cores","operations","benchmark","getCapabilities","createFn","resetFn","initialSize","obj","inUse","oldest","getStats","THEME_COOKIE_NAME","getThemeFromCookie","themeCookie","cookie","applyThemeToDocument","documentElement","remove","setTheme","setThemeCookie","useConfigStore","setBaseURL","setThemeUtil","onRehydrateStorage","initializeTheme","useUIStore","sidebarOpen","settingsOpen","setSidebarOpen","setSettingsOpen","setFontSize","formatDate","getDefaultDateRange","useAnalyticsStore","analytics","dateRange","fetchAnalytics","trafficReport","queriesReport","conversationsReport","analysisReport","conversationsTotal","queriesTotal","avgQueriesPerConv","average_queries_per_conversation","Number","analyticsData","active","trend","item","created_at_interval","queries_number","queries","successful","query_status","failed","avgResponseTime","topQueries","traffic","uniqueUsers","sources","request_source_number","pageViews","avgSessionDuration","bounceRate","users","statistics","totalMessages","avgMessagesPerConversation","satisfactionRate","responseAccuracy","setDateRange","exportAnalytics","format","jsonData","usePageStore","pages","paginationInfo","fetchPages","setQueryParams","useSourceStore","syncStatus","syncing","fetchSources","allSources","sitemaps","apiSource","uploads","fetchSource","uploadSources","uploadPromises","reject","updateSource","bulkDelete","sourceIds","syncSources","setFilter","selectSource","useProfileStore","profile","fetchProfile","updateProfile","profilePhoto","errors","profile_photo","flat","activeRequests","useProjectSettingsStore","settingsLoading","plugins","pluginsLoading","pluginsError","stats","statsLoading","statsError","fetchSettings","requestKey","settingsUpdate","defaultValues","ending_message","no_answer_message","try_asking_questions_msg","view_more_msg","view_less_msg","citations_answer_source_label_msg","citations_sources_label_msg","hang_in_there_msg","chatbot_siesta_msg","question","File","stringValue","fetchPlugins","pluginsData","updatePlugin","plugin","fetchStats","statsData","useLicenseStore","licenses","fetchLicenses","responseType","hasData","dataType","dataLength","errorStatus","errorCode","responseText","dataStructure","licenseKey","newLicense","license","licenseName","initializeStores","cleanupStores","citationIds","validCitationIds","validIds","isNaN","arr","indexOf","original","validateCitationIds","hasUrl","requested","fetched","hasSourceIds","requestData","source_ids","citationDetails","updatedCurrent","prompt_id","apiMessages","latestApiMessage","user_query","existingCitations","response_feedback","reaction","hasDetails","citationCount","enrichmentError","setupError","currentAgentFor403","promptId","promptIdMatch","updatedMessage","feedbackValue","availableConversations","messagesCount","messageTypes","formattedMessages","baseTimestamp","formattedCount","firstMessageTime","lastMessageTime","localSendingMessages","mergedMessages","localMsg","insertIndex","splice","lastAssistantMessage","lastAssistantIndex","userMessageId","assistantMessageId","userContent","apiParams","updatedAllConversations","updatedConversation","__customgpt_current_session","sessions","sessionIds","__webpack_module_cache__","__webpack_require__","moduleId","cachedModule","__webpack_modules__","call","O","chunkIds","fn","priority","notFulfilled","fulfilled","j","every","n","getter","__esModule","getPrototypeOf","ns","def","getOwnPropertyNames","definition","o","defineProperty","enumerable","promises","u","miniCssF","globalThis","Function","prop","prototype","hasOwnProperty","script","needAttach","scripts","getElementsByTagName","getAttribute","charset","nc","setAttribute","onScriptComplete","onload","doneFns","bind","head","Symbol","toStringTag","installedChunks","installedChunkData","promise","realSrc","webpackJsonpCallback","parentChunkLoadingFunction","moreModules","runtime","chunkLoadingGlobal","__webpack_exports__"],"sourceRoot":""}